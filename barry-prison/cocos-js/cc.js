System.register([],(function(t,e){"use strict";return{execute:function(){function i(t,e,i,s){i&&Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(s):void 0})}function s(t,e,i,s,r){var n={};return Object.keys(s).forEach((function(t){n[t]=s[t]})),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=i.slice().reverse().reduce((function(i,s){return s(t,e,i)||i}),n),r&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(r):void 0,n.initializer=void 0),void 0===n.initializer&&(Object.defineProperty(t,e,n),n=null),n}function r(t,e){const i="undefined"==typeof window?global:window;return void 0===i[t]?i[t]=e:i[t]}t({BitMask:Kt,CCClass:ri,Enum:te,Eventify:Dn,WorldNode3DToLocalNodeUI:tu,WorldNode3DToWorldNodeUI:eu,__checkObsoleteInNamespace__:function(t){return Zc||(Zc="undefined"==typeof Proxy?{}:new Proxy(t,{get:(t,e,i)=>(Kc(e),Reflect.get(t,e,i))})),Zc},__checkObsolete__:function(t){for(let e of t)Kc(e)},_resetDebugSetting:L,absMax:Ri,absMaxComponent:Bi,applyMixins:function(t,e){e.forEach((e=>{Object.getOwnPropertyNames(e.prototype).forEach((i=>{"constructor"!==i&&Object.defineProperty(t.prototype,i,Object.getOwnPropertyDescriptor(e.prototype,i))}))}))},approx:gi,assert:R,assertID:q,assertIsNonNullable:function(){},assertIsTrue:function(){},assertsArrayIndex:Zt,bezier:Ol,bezierByTime:Hl,binarySearch:function(t,e){return Go(t,e,0)},binarySearchBy:function(t,e,i){let s=0,r=t.length-1,n=r>>>1;for(;s<=r;n=s+r>>>1){const o=t[n];if(i(o,e)<0)r=n-1;else{if(!(i(o,e)>0))return n;s=n+1}}return~s},binarySearchEpsilon:Go,ccenum:se,clamp:fi,clamp01:mi,color:gr,computeRatioByType:Y0,debug:O,debugID:V,deprecateModuleExportedName:function(t){for(let e in t){const i=t[e];Qc[e]=i}},deserialize:Tf,enumerableProps:Oi,equals:_i,error:B,errorID:j,find:cM,flattenCodeArray:yu,floatToHalf:zi,formerlySerializedAs:ba,fragmentText:ZB,getBaselineOffset:BB,getEnglishWordPartAtFirst:QB,getEnglishWordPartAtLast:KB,getError:Y,getPathFromRoot:function(t,e){let i=t,s="";for(;null!==i&&i!==e;)s=`${i.name}/${s}`,i=i.parent;return s.slice(0,-1)},getSerializationMetadata:function(t){return t[ya]},getSymbolAt:jB,getSymbolCodeAt:$B,getSymbolLength:WB,getWorldTransformUntilRoot:I$,halfToFloat:ki,instantiate:rZ,inverseLerp:Pi,isCCClassOrFastDefined:ni,isCCObject:vn,isDisplayStats:Q,isEnglishWordPartAtFirst:function(t){return UB.test(t)},isEnglishWordPartAtLast:function(t){return NB.test(t)},isUnicodeCJK:VB,isUnicodeSpace:HB,isValid:bn,lerp:yi,loadWasmModuleBullet:function(){return Promise.resolve()},log:M,logID:N,mat4:Fs,murmurhash2_32_gc:du,nextPow2:Di,pingPong:Mi,pseudoRandom:Ci,pseudoRandomRange:Ii,pseudoRandomRangeInt:Ei,quat:Ts,random:wi,randomRange:xi,randomRangeInt:Ti,rect:Ir,repeat:Ai,safeMeasureText:GB,sampleAnimationCurve:X0,setDefaultLogTimes:function(t){t>0&&(qc=t)},setDisplayStats:K,setPropertyEnumType:We,setPropertyEnumTypeOnAttrs:je,setRandGenerator:Si,shift:_u,size:wr,toDegree:bi,toRadian:vi,tween:aEt,tweenUtil:hEt,v2:Ks,v3:Zi,v4:ur,warn:P,warnID:G}),r("CC_WECHAT",!1),r("CC_BAIDU",!1),r("CC_XIAOMI",!1),r("CC_ALIPAY",!1),r("CC_BYTEDANCE",!1),r("CC_OPPO",!1),r("CC_VIVO",!1),r("CC_HUAWEI",!1),r("CC_COCOSPLAY",!1),r("CC_QTT",!1),r("CC_LINKSURE",!1),r("CC_MIGU",!1);const n=!1;r("CC_EDITOR",!1);const o=!1;r("CC_PREVIEW",!1),r("CC_BUILD",!0),r("CC_TEST",!1),r("CC_DEBUG",!1),r("CC_DEV",!1),r("CC_MINIGAME",!1),r("CC_RUNTIME_BASED",!1),r("CC_SUPPORT_JIT",!0),r("CC_JSB",!1);const a="undefined"==typeof window?global:window,h=t("cclegacy",{_global:a}),l=h;h.internal={};const c=t("VERSION","3.8.5");a.CocosEngine=l.ENGINE_VERSION=c,a.cc=l;const u=void 0!==globalThis.jsb&&void 0!==jsb.window?jsb.window:globalThis;a.ccwindow=u;const d=2147483647;function p(t){return(t>0)-(t<0)}function _(t,e){return t^(t^e)&-(t<e)}function g(t){let e,i;return e=(t>65535)<<4,i=((t>>>=e)>255)<<3,e|=i,i=((t>>>=i)>15)<<2,e|=i,i=((t>>>=i)>3)<<1,e|=i,e|(t>>>=i)>>1}function f(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24}function m(t){let e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function y(t){return--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}const v=new Array(256);(t=>{for(let e=0;e<256;++e){let i=e,s=e,r=7;for(i>>>=1;i;i>>>=1)s<<=1,s|=1&i,--r;t[e]=s<<r&255}})(v);var b=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:d,INT_MIN:-1<<31,abs:function(t){const e=t>>31;return(t^e)-e},countTrailingZeros:m,deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},interleave3:function(t,e,i){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},isPow2:function(t){return!(t&t-1||!t)},log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},log2:g,max:_,min:function(t,e){return e^(t^e)&-(t<e)},nextCombination:function(t){const e=t|t-1;return e+1|(~e&-~e)-1>>>m(t)+1},nextPow2:y,parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},popCount:f,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},reverse:function(t){return v[255&t]<<24|v[t>>>8&255]<<16|v[t>>>16&255]<<8|v[t>>>24&255]},sign:p});t("bits",b);const w=u.document,S=`https://github.com/cocos/cocos-engine/blob/${c}/EngineErrorMap.md`;let x=null,T=console.log.bind(console),C=T,I=T,E=function(t,e){if(!t){for(var i=arguments.length,s=new Array(i>2?i-2:0),r=2;r<i;r++)s[r-2]=arguments[r];console.log(`ASSERT: ${A(e,...s)}`)}},D=T;function A(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return l.js.formatStr.apply(null,e)}function M(){return T(...arguments)}function P(){return C(...arguments)}function B(){return I(...arguments)}function R(t,e){for(var i=arguments.length,s=new Array(i>2?i-2:0),r=2;r<i;r++)s[r-2]=arguments[r];return E(t,e,...s)}function O(){return D(...arguments)}function L(t){if(T=C=I=E=D=()=>{},0!==t){if(t>4){const e=t=>{if(l.game.canvas){if(!x){const t=w.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200");const e=l.game.canvas.height;t.setAttribute("height",`${e}`);const i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",x=w.createElement("textarea"),x.setAttribute("rows","20"),x.setAttribute("cols","30"),x.setAttribute("disabled","true");const s=x.style;s.backgroundColor="transparent",s.borderBottom="1px solid #cccccc",s.borderTopWidth=s.borderLeftWidth=s.borderRightWidth="0px",s.borderTopStyle=s.borderLeftStyle=s.borderRightStyle="none",s.padding="0px",s.margin="0px",t.appendChild(x),l.game.canvas.parentNode.appendChild(t)}x.value=`${x.value+t}\r\n`,x.scrollTop=x.scrollHeight}};I=function(){e(`ERROR :  ${A(...arguments)}`)},E=function(t,i){if(!t){for(var s=arguments.length,r=new Array(s>2?s-2:0),n=2;n<s;n++)r[n-2]=arguments[n];e(`ASSERT: ${A(i,...r)}`)}},7!==t&&(C=function(){e(`WARN :  ${A(...arguments)}`)}),5===t&&(T=function(){e(A(...arguments))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),I=console.error.bind?console.error.bind(console):function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return console.error.apply(console,e)},E=function(t,e){if(!t){for(var i=arguments.length,s=new Array(i>2?i-2:0),r=2;r<i;r++)s[r-2]=arguments[r];const t=A(e,...s);throw new Error(t)}});if(4!==t&&(C=console.warn.bind?console.warn.bind(console):function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return console.warn.apply(console,e)}),t<=2&&(T=console.log.bind?console.log.bind(console):function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return console.log.apply(console,e)}),t<=1&&"function"==typeof console.debug){const t=console.debug.bind(console);D=function(){return t(...arguments)}}}}function F(t){return void B(t.stack||t)}function z(t){return function(e){const i=`${t} ${e}, please go to ${S}#${e} to see details.`;for(var s=arguments.length,r=new Array(s>1?s-1:0),n=1;n<s;n++)r[n-1]=arguments[n];return 0===r.length?i:`${i} Arguments: ${r.join(", ")}`}}const k=z("Log");function N(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];M(k(t,...i))}const U=z("Debug");function V(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];O(U(t,...i))}const H=z("Warning");function G(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];P(H(t,...i))}const W=z("Error");function j(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];B(W(t,...i))}const $=z("Assert");function q(t,e){if(!t){for(var i=arguments.length,s=new Array(i>2?i-2:0),r=2;r<i;r++)s[r-2]=arguments[r];R(!1,$(e,...s))}}const X=t("DebugMode",{NONE:0,VERBOSE:1,INFO:2,WARN:3,ERROR:4,INFO_FOR_WEB_PAGE:5,WARN_FOR_WEB_PAGE:6,ERROR_FOR_WEB_PAGE:7});function Y(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];return W(t,...i)}function Q(){return!!l.profiler&&l.profiler.isShowingStats()}function K(t){l.profiler&&(t?l.profiler.showStats():l.profiler.hideStats())}var Z,J=Object.freeze({__proto__:null,DebugMode:X,_resetDebugSetting:L,_throw:F,assert:R,assertID:q,debug:O,debugID:V,error:B,errorID:j,getError:Y,isDisplayStats:Q,log:M,logID:N,setDisplayStats:K,warn:P,warnID:G});class tt{constructor(t){this.id=0|998*Math.random(),this.prefix=t?t+".":""}getNewId(){return this.prefix+(++this.id).toString()}}Z=tt,tt.global=new Z("global");const et=new tt("TmpCId."),it="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),st="__classname__",rt="__cid__";function nt(t){return"number"==typeof t||t instanceof Number}function ot(t){return"string"==typeof t||t instanceof String}function at(t){for(const e in t)return!1;return!0}const ht=(()=>{const t={value:void 0,enumerable:!1,writable:!1,configurable:!0};return(e,i,s,r,n)=>{t.value=s,t.writable=r,t.enumerable=n,Object.defineProperty(e,i,t),t.value=void 0}})(),lt=(()=>{const t={get:void 0,set:void 0,enumerable:!1};return function(e,i,s,r,n,o){void 0===n&&(n=!1),void 0===o&&(o=!1),"boolean"==typeof r&&(console.log("Set `setter` to boolean is deprecated. Please don not use like this again."),n=r,r=void 0),t.get=s,t.set=r,t.enumerable=n,t.configurable=o,Object.defineProperty(e,i,t),t.get=void 0,t.set=void 0}})(),ct=(()=>{const t={get:void 0,enumerable:!1,configurable:!1};return(e,i,s,r,n)=>{t.get=s,t.enumerable=r,t.configurable=n,Object.defineProperty(e,i,t),t.get=void 0}})(),ut=(()=>{const t={set:void 0,enumerable:!1,configurable:!1};return(e,i,s,r,n)=>{t.set=s,t.enumerable=r,t.configurable=n,Object.defineProperty(e,i,t),t.set=void 0}})();function dt(t){const e=Object.create(null);if(t){const t=".",i="/";e[t]=1,e[i]=1,delete e[t],delete e[i]}return e}function pt(t){if("function"==typeof t){const e=t.prototype;if(e&&e.hasOwnProperty(st)&&e[st])return e[st];let i="";if(t.name)i=t.name;else if(t.toString){let e;const s=t.toString();e="["===s.charAt(0)?/\[\w+\s*(\w+)\]/.exec(s):/^function\s*(\w+)/.exec(s),e&&2===e.length&&(i=e[1])}return"Object"!==i?i:""}return t&&t.constructor?pt(t.constructor):""}function _t(t,e,i,s){const r=/([^.]+)$/,n=r.exec(e)[0],o=r.exec(i)[0];function a(){return this[o]}s?lt(t,n,a,(function(t){this[o]=t})):ct(t,n,a)}function gt(t,e,i,s){for(const r in i)_t(t,`${e}.${r}`,i[r],s)}const ft=/(%d)|(%s)/,mt=/%s/;function yt(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];if(0===arguments.length)return"";if(0===i.length)return`${t}`;if("string"==typeof t&&ft.test(t))for(const e of i){const i="number"==typeof e?ft:mt;if(i.test(t)){const s=`${e}`;t=t.replace(i,s)}else t+=` ${e}`}else for(const e of i)t+=` ${e}`;return t}function vt(){const t=arguments.length-1,e=new Array(t);for(let i=0;i<t;++i)e[i]=arguments[i+1];return e}function bt(t,e){for(;t;){const i=Object.getOwnPropertyDescriptor(t,e);if(i)return i;t=Object.getPrototypeOf(t)}return null}function wt(t,e,i){const s=bt(e,t);s&&Object.defineProperty(i,t,s)}function St(t){t=t||{};for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];for(const e of i)if(e){if("object"!=typeof e){j(5402,e);continue}for(const i in e)i in t||wt(i,e,t)}return t}function xt(t){t=t||{};for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];for(const e of i)if(e){if("object"!=typeof e){j(5403,e);continue}for(const i in e)wt(i,e,t)}return t}function Tt(t,e){for(const i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function Ct(t){const e=t.prototype,i=e&&Object.getPrototypeOf(e);return i&&i.constructor}function It(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=Ct(t)))return!1;if(t===e)return!0}}return!1}function Et(t){for(const e of Object.keys(t))delete t[e]}const Dt=dt(!0),At=dt(!0);function Mt(t,e,i){return function(s,r){if(r.prototype.hasOwnProperty(t)&&delete e[r.prototype[t]],ht(r.prototype,t,s),s){const n=e[s];!i&&n&&n!==r?j(16334,t,s,""):e[s]=r}}}const Pt=Mt("__cid__",Dt,!1),Bt=Mt("__classname__",At,!0);function Rt(t,e){if(Bt(t,e),!e.prototype.hasOwnProperty(rt)){const i=t||et.getNewId();i&&Pt(i,e)}}function Ot(t,e){const i=At[e],s=Dt[e];let r=!0;if(i&&i!==t&&(j(16335,e),r=!1),s&&s!==t&&(j(16336,e),r=!1),r){let i=t[it];i||(i=[],t[it]=i),i.push(e),At[e]=t,Dt[e]=t}}function Lt(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];for(const t of e){const e=t.prototype,i=e[rt];i&&delete Dt[i];const s=e[st];s&&delete At[s];const r=e[it];if(r)for(let t=0;t<r.length;++t){const e=r[t];delete At[e],delete Dt[e]}}}function Ft(t){return zt(t)}function zt(t){return Dt[t]}function kt(t){return At[t]}function Nt(t,e){return Ut(t,e)}function Ut(t,e){let i;if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(rt))return i=t.prototype[rt],i;if(t&&t.constructor){const e=t.constructor.prototype;if(e&&e.hasOwnProperty(rt))return i=t[rt],i}return""}let Vt=class{get(){return this._get()}constructor(t,e){this.count=0;const i=void 0===e?t:e,s=void 0===e?null:t;this._pool=new Array(i),this._cleanup=s}_get(){if(this.count>0){--this.count;const t=this._pool[this.count];return this._pool[this.count]=null,t}return null}put(t){const e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}}resize(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))}};class Ht{constructor(t){this.i=0,this.array=t}get length(){return this.array.length}set length(t){this.array.length=t,this.i>=t&&(this.i=t-1)}remove(t){const e=this.array.indexOf(t);e>=0&&this.removeAt(e)}removeAt(t){this.array.splice(t,1),t<=this.i&&--this.i}fastRemove(t){const e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)}fastRemoveAt(t){const e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i}push(t){this.array.push(t)}}function Gt(t,e){t.splice(e,1)}function Wt(t,e){const i=t.length;e<0||e>=i||(t[e]=t[i-1],t.length=i-1)}function jt(t,e){const i=t.indexOf(e);return i>=0&&(Gt(t,i),!0)}function $t(t,e){const i=t.indexOf(e);i>=0&&(t[i]=t[t.length-1],--t.length)}function qt(t,e){const i=t.findIndex(e);if(i>=0){const e=t[i];return Gt(t,i),e}}function Xt(t,e){return t.indexOf(e)>=0}var Yt=Object.freeze({__proto__:null,MutableForwardIterator:Ht,appendObjectsAt:function(t,e,i){return t.splice.apply(t,[i,0,...e]),t},contains:Xt,copy:function(t){const e=t.length,i=new Array(e);for(let s=0;s<e;s+=1)i[s]=t[s];return i},fastRemove:$t,fastRemoveAt:Wt,remove:jt,removeArray:function(t,e){for(let i=0,s=e.length;i<s;i++)jt(t,e[i])},removeAt:Gt,removeIf:qt,verifyType:function(t,e){if(t&&t.length>0)for(const i of t)if(!(i instanceof e))return N(1300),!1;return!0}});const Qt={IDGenerator:tt,Pool:Vt,array:Yt,isNumber:nt,isString:ot,isEmptyObject:at,getPropertyDescriptor:bt,addon:St,mixin:xt,extend:Tt,getSuper:Ct,isChildClassOf:It,clear:Et,value:ht,getset:lt,get:ct,set:ut,unregisterClass:Lt,getClassName:pt,setClassName:Rt,setClassAlias:Ot,getClassByName:kt,getClassById:zt,get _registeredClassNames(){return{...At}},set _registeredClassNames(t){Et(At),Object.assign(At,t)},get _registeredClassIds(){return{...Dt}},set _registeredClassIds(t){Et(Dt),Object.assign(Dt,t)},_getClassId:Nt,getClassId:Ut,_setClassId:Pt,_getClassById:Ft,obsolete:_t,obsoletes:gt,formatStr:yt,shiftArguments:vt,createMap:dt};function Kt(t){if("__bitmask__"in t)return t;ht(t,"__bitmask__",null,!0);let e=-1;const i=Object.keys(t);for(let s=0;s<i.length;s++){const r=i[s];let n=t[r];if(-1===n)n=++e,t[r]=n;else if("number"==typeof n)e=n;else if("string"==typeof n&&Number.isInteger(parseFloat(r)))continue;const o=`${n}`;r!==o&&ht(t,o,r)}return t}function Zt(t,e){e>=0&&t.length,t.length}l.js=Qt,t("js",Object.freeze({__proto__:null,IDGenerator:tt,Pool:Vt,_getClassById:Ft,_getClassId:Nt,_idToClass:Dt,_nameToClass:At,_setClassId:Pt,addon:St,array:Yt,clear:Et,copyAllProperties:function(t,e,i){const s=Object.getOwnPropertyNames(t);for(let r=0,n=s.length;r<n;++r){const n=s[r];-1===i.indexOf(n)&&wt(n,t,e)}},createMap:dt,extend:Tt,formatStr:yt,get:ct,getClassById:zt,getClassByName:kt,getClassId:Ut,getClassName:pt,getPropertyDescriptor:bt,getSuper:Ct,getset:lt,isChildClassOf:It,isEmptyObject:at,isNumber:nt,isString:ot,js:Qt,mixin:xt,obsolete:_t,obsoletes:gt,set:ut,setClassAlias:Ot,setClassName:Rt,shiftArguments:vt,unregisterClass:Lt,value:ht})),Kt.isBitMask=t=>t&&Object.prototype.hasOwnProperty.call(t,"__bitmask__"),Kt.getList=t=>t.__bitmask__?t.__bitmask__:Kt.update(t),Kt.update=t=>{Array.isArray(t.__bitmask__)||(t.__bitmask__=[]);const e=t.__bitmask__;e.length=0;for(const i in t){const s=t[i];Number.isInteger(s)&&e.push({name:i,value:s})}return e.sort(((t,e)=>t.value-e.value)),e},l.BitMask=Kt;const Jt=Object.prototype.hasOwnProperty;function te(t){return"__enums__"in t?t:(ht(t,"__enums__",null,!0),te.update(t))}function ee(t){Jt.call(t,"__enums__")}function ie(t){ee(t);const e=t.__enums__||[];e.length=0;let i=!0;for(const s in t){const r=t[s],n=Number.isInteger(r);n||(i=!1),(n||"string"==typeof r&&t[r]!==Number.parseInt(s))&&e.push({name:s,value:r})}return i&&e.sort(((t,e)=>t.value-e.value)),t.__enums__=e,e}function se(t){"__enums__"in t||ht(t,"__enums__",null,!0)}te.update=t=>{let e=-1;const i=Object.keys(t);for(let s=0;s<i.length;s++){const r=i[s];let n=t[r];if(-1===n)n=++e,t[r]=n;else if("number"==typeof n)e=n;else if("string"==typeof n&&Number.isInteger(parseFloat(r)))continue;const o=`${n}`;r!==o&&ht(t,o,r)}return Array.isArray(t.__enums__)&&ie(t),t},te||t("Enum",te={}),te.isEnum=t=>t&&Jt.call(t,"__enums__"),te.getList=t=>(ee(t),t.__enums__?t.__enums__:ie(t)),te.sortList=(t,e)=>{ee(t),Array.isArray(t.__enums__)&&t.__enums__.sort(e)},l.Enum=te;class re{clone(){return j(100,`${pt(this)}.clone`),this}equals(t){return!1}set(t){j(100,`${pt(this)}.set`)}toString(){return""}}t("ValueType",re),Rt("cc.ValueType",re),l.ValueType=re;const ne=t("SettingsCategory",{PATH:"path",ENGINE:"engine",ASSETS:"assets",SCRIPTING:"scripting",PHYSICS:"physics",RENDERING:"rendering",LAUNCH:"launch",SCREEN:"screen",SPLASH_SCREEN:"splashScreen",ANIMATION:"animation",PROFILING:"profiling",PLUGINS:"plugins",XR:"xr"});class oe{constructor(){this._settings={},this._override={}}init(t,e){void 0===t&&(t=""),void 0===e&&(e={});for(const t in e){const i=e[t];if(i)for(const e in i)this.overrideSettings(t,e,i[e])}return t?new Promise(((e,i)=>{{const s=new XMLHttpRequest;s.open("GET",t),s.responseType="text",s.onload=()=>{this._settings=JSON.parse(s.response),e()},s.onerror=()=>{i(new Error("request settings failed!"))},s.send(null)}})):Promise.resolve()}overrideSettings(t,e,i){t in this._override||(this._override[t]={}),this._override[t][e]=i}querySettings(t,e){if(t in this._override){const i=this._override[t];if(i&&e in i)return i[e]}if(t in this._settings){const i=this._settings[t];if(i&&e in i)return i[e]}return null}}t("Settings",oe),oe.Category=ne;const ae=t("settings",new oe);let he;l.settings=ae,function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE",t[t.AUTO=13]="AUTO"}(he||(he={}));const le=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:he.PORTRAIT,ORIENTATION_PORTRAIT_UPSIDE_DOWN:he.PORTRAIT_UPSIDE_DOWN,ORIENTATION_LANDSCAPE:he.LANDSCAPE,ORIENTATION_LANDSCAPE_LEFT:he.LANDSCAPE_LEFT,ORIENTATION_LANDSCAPE_RIGHT:he.LANDSCAPE_RIGHT,ORIENTATION_AUTO:he.AUTO,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_FLOAT_OUTPUT:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144,CUSTOM_PIPELINE_NAME:"Builtin",init(){const t=ae.querySettings("engine","macros");if(t)for(const e in t)le[e]=t[e]}});function ce(t,e){for(var i,s=arguments.length,r=new Array(s>2?s-2:0),n=2;n<s;n++)r[n-2]=arguments[n];const o=performance.now(),a=requestAnimationFrame||window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;if(void 0===a||null!==(i=globalThis.__globalXR)&&void 0!==i&&i.isWebXR)return setTimeout(t,e,...r);const h=()=>{performance.now()-o<e?a(h):t(...r)};return a(h)}l.macro=le;const ue=/^(?:cc|dragonBones|sp|ccsg)\..+/,de=new Array(123);for(let t=0;t<123;++t)de[t]=64;for(let t=0;t<64;++t)de["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(t)]=t;const pe=de;function _e(t,e,i){function s(t,e,i,s){const r=Object.getOwnPropertyDescriptor(t,e);if(r)r.get&&i&&(t[i]=r.get),r.set&&s&&(t[s]=r.set);else{const r=t[i];lt(t,e,r,t[s])}}let r;const n=t.prototype;for(let t=0,i=e.length;t<i;++t){r=e[t];const i=r[0].toUpperCase()+r.slice(1);s(n,r,`get${i}`,`set${i}`)}for(r in i){const t=i[r];s(n,r,t[0],t[1])}}function ge(t,e,i,s){const r=t[e];r?Array.isArray(r)?s?(r.push(r[0]),r[0]=i):r.push(i):t[e]=s?[i,r]:[r,i]:t[e]=i}function fe(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));{let i=e.parentNode;if(i)do{if(i===t)return!0;i=i.parentNode}while(null!==i);return!1}}function me(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:!!t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function ye(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];t&&ce((()=>{t(...i)}),0)}function ve(t){return!(!t||t.constructor!==Object)&&at(t)}function be(t,e,i){if(e>i){const t=e;e=i,i=t}return t<e?e:t<i?t:i}function we(t){return t*le.RAD}function Se(t){return t*le.DEG}l.misc={BUILTIN_CLASSID_RE:ue,BASE64_VALUES:pe,propertyDefine:_e,pushToMap:ge,contains:fe,isDomNode:me,callInNextTick:ye,isPlainEmptyObj_DEV:ve,clampf:be,degreesToRadians:we,radiansToDegrees:Se},t("misc",Object.freeze({__proto__:null,BASE64_VALUES:pe,BUILTIN_CLASSID_RE:ue,callInNextTick:ye,clampf:be,contains:fe,degreesToRadians:we,isDomNode:me,isPlainEmptyObj_DEV:ve,propertyDefine:_e,pushToMap:ge,radiansToDegrees:Se,tryCatchFunctor_EDITOR:function(t){return Function("target",`try {\n  target.${t}();\n}\ncatch (e) {\n  cc._throw(e);\n}`)}}));const xe="$_$";function Te(t,e){const i=e?Object.create(e):{};return ht(t,"__attrs__",i),i}function Ce(t){if("function"!=typeof t)return Te(t,Ee(t.constructor));let e;const i=l.Class.getInheritanceChain(t);for(let t=i.length-1;t>=0;t--){const s=i[t];s.hasOwnProperty("__attrs__")&&s.__attrs__||(e=i[t+1],Te(s,e&&e.__attrs__))}return e=i[0],Te(t,e&&e.__attrs__),t.__attrs__}function Ie(t,e){const i=Ee(t),s=e+xe,r={};for(const t in i)t.startsWith(s)&&(r[t.slice(s.length)]=i[t]);return r}function Ee(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||Ce(t)}function De(t,e,i,s){Ee(t)[e+xe+i]=s}let Ae=class{constructor(t,e){this.name=t,this.default=e}toString(){return this.name}};const Me=t("CCInteger",new Ae("Integer",0));l.Integer=Me,l.CCInteger=Me;const Pe=t("CCFloat",new Ae("Float",0));l.Float=Pe,l.CCFloat=Pe;const Be=t("CCBoolean",new Ae("Boolean",!1));l.Boolean=Be,l.CCBoolean=Be;const Re=t("CCString",new Ae("String",""));function Oe(t,e){return function(i,s){const r=`"${pt(i)}.${s}"`,n=Ie(i,s);let o=n.type;if(o===Me||o===Pe?o="Number":o!==Re&&o!==Be||(o=`${o}`),o!==t)return void G(3604,r);if(!n.hasOwnProperty("default"))return;const a=n.default;if(void 0===a)return;if(Array.isArray(a)||ve(a))return;const h=typeof a,l=t.toLowerCase();if(h===l)if("object"===l){if(!a||a instanceof n.ctor)return;G(3605,r,pt(n.ctor))}else"Number"!==t&&G(3606,e,r,t);else{if("function"===h)return;t===Re.default&&null==a?G(3607,r):G(3611,e,r,h)}delete n.type}}l.String=Re,l.CCString=Re;var Le=Object.freeze({__proto__:null,CCBoolean:Be,CCFloat:Pe,CCInteger:Me,CCString:Re,DELIMETER:xe,PrimitiveType:Ae,attr:Ie,createAttrs:Ce,createAttrsSingle:Te,getClassAttrs:Ee,getObjTypeChecker_ET:function(t){return function(e,i){Oe("Object","type")(e,i);const s=Ee(e)[`${i+xe}default`],r=l.Class.getDefault(s);if(!Array.isArray(r)&&It(t,l.ValueType)){const r=pt(t),n=yt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',pt(e),i,r);s?M(n):G(3612,n,r,pt(e),i,r)}}},getTypeChecker_ET:Oe,setClassAttr:De});const Fe={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function ze(t,e,i,s){if(!t.get&&!t.set&&t.hasOwnProperty("default")){const r=`_N$${e}`;t.get=function(){return this[r]},t.set=function(t){const e=this[r];this[r]=t,i.call(this,e)};const n={};s[r]=n;for(const e in Fe){const i=Fe[e];t.hasOwnProperty(e)&&(n[e]=t[e],i.canUsedInGet||delete t[e])}}}function ke(t,e,i,s){if(Array.isArray(e)){if(!(e.length>0))return j(5508,i,s);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=l.String:e===Boolean?t.type=l.Boolean:e===Number&&(t.type=l.Float))}function Ne(t,e,i){const s=t||void 0===e?{_short:!0}:{_short:!0,default:e};return i&&(s.type=i),s}function Ue(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Ne(e,[],t);if("function"==typeof t){const i=t;return Ne(e,It(i,l.ValueType)?new i:null,i)}return t instanceof Ae?Ne(e,void 0,t):Ne(e,t)}return null}function Ve(t,e){for(const i in t){let s=t[i];const r=Ue(s,!1);if(r&&(s=t[i]=r),s){const r=s.notify;r&&ze(s,i,r,t),"type"in s&&ke(s,s.type,e,i)}}}let He=[];function Ge(){return He[He.length-1]}function We(t,e,i){je(Ee(t),e,i)}function je(t,e,i){t[`${e}${xe}type`]="Enum",t[`${e}${xe}enumList`]=te.getList(i)}l._RF={push:function(t,e,i,s){void 0===i&&(i=e,e=""),He.push({uuid:e,script:i,module:t,exports:t.exports,beh:null,importMeta:s})},pop:function(){const t=He.pop(),e=t.module;let i=e.exports;if(i===t.exports){for(const t in i)return;e.exports=i=t.cls}},peek:Ge};const $e=xe,qe="__ctors__",Xe=t("ENUM_TAG","Enum"),Ye=t("BITMASK_TAG","BitMask");function Qe(t,e){t.indexOf(e)<0&&t.push(e)}function Ke(t,e){Qe(t.__props__,e)}function Ze(t,e,i,s){Ke(t,i),ai(t,s,e,i)}function Je(t,e,i,s){const r=s.get;s.set,r&&(ai(t,s,e,i),De(t,i,"serializable",!1))}function ti(t){return"function"==typeof t?t():t}function ei(t,e,i){const s=i.ctor;return ht(s,qe,!0,!0),s.prototype,e&&(s.$super=e),Rt(t,s),s}function ii(t,e,i){const s=l.Component,r=Ge();if(r&&It(e,s)){if(It(r.cls,s))return j(3615),null;t=t||r.script}const n=ei(t,e,i);if(r)if(It(e,s)){const t=r.uuid;t&&Pt(t,n),r.cls=n}else It(r.cls,s)||(r.cls=n);return n}function si(t,e,i,s){if(t.__props__=[],s&&s.__props__&&(t.__props__=s.__props__.slice()),i){Ve(i,e);for(const s in i){const r=i[s];r.get||r.set?Je(t,e,s,r):Ze(t,e,s,r)}}const r=Ee(t);t.__values__=t.__props__.filter((t=>!1!==r[`${t}${$e}serializable`]))}function ri(t){let e=t.name;const i=t.extends,s=ii(e,i,t);e||(e=l.js.getClassName(s)),s._sealed=!0,i&&(i._sealed=!1),si(s,e,t.properties,i);const r=t.editor;return r&&It(i,l.Component)&&l.Component._registerEditorProps(s,r),s}function ni(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__values__")}ri._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,qe)},ri.fastDefine=function(t,e,i){Rt(t,e);const s=e.__props__=e.__values__=Object.keys(i),r=Ee(e);for(let t=0;t<s.length;t++){const e=s[t];r[`${e+$e}visible`]=!1,r[`${e+$e}default`]=i[e]}},ri.Attr=Le,ri.attr=Ie,ri.isCCClassOrFastDefined=ni,ri.getInheritanceChain=function(t){const e=[];for(;t=Ct(t);)t!==Object&&e.push(t);return e};const oi={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function ai(t,e,i,s){let r=null,n="";function o(){return n=s+$e,r=Ee(t)}"type"in e&&void 0===e.type&&G(3660,s,i);const a=e.type;a&&(oi[a]?(r||o())[`${n}type`]=a:"Object"===a||("object"==typeof a?te.isEnum(a)?je(r||o(),s,a):Kt.isBitMask(a)&&((r||o())[`${n}type`]=Ye,r[`${n}bitmaskList`]=Kt.getList(a)):"function"==typeof a&&((r||o())[`${n}type`]="Object",r[`${n}ctor`]=a))),"default"in e&&((r||o())[`${n}default`]=e.default);const h=(t,i)=>{if(t in e){const s=e[t];typeof s===i&&((r||o())[n+t]=s)}};let l;e.editorOnly&&((r||o())[`${n}editorOnly`]=!0),1&e.__internalFlags?l=!0===e.serializable||!!(4&e.__internalFlags):!1===e.serializable&&(l=!1),void 0!==l&&((r||o())[`${n}serializable`]=l),h("formerlySerializedAs","string");const c=e.range;c&&Array.isArray(c)&&c.length>=2&&((r||o())[`${n}min`]=c[0],r[`${n}max`]=c[1],c.length>2&&(r[`${n}step`]=c[2])),h("step","number"),h("userData","object")}ri.isArray=function(t){return t=ti(t),Array.isArray(t)},ri.getDefault=ti,ri.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},ri.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,ri.getNewValueTypeCode=function(t){const e=pt(t),i=t.constructor;let s=`new ${e}(`;for(let e=0;e<i.__props__.length;e++)s+=t[i.__props__[e]],e<i.__props__.length-1&&(s+=",");return`${s})`},l.Class=ri;const hi=Math.PI/180,li=180/Math.PI;let ci=Math.random;const ui=t("HALF_PI",.5*Math.PI),di=t("TWO_PI",2*Math.PI),pi=t("EPSILON",1e-6);function _i(t,e){return Math.abs(t-e)<=pi*Math.max(1,Math.abs(t),Math.abs(e))}function gi(t,e,i){return i=i||pi,Math.abs(t-e)<=i}function fi(t,e,i){if(e>i){const t=e;e=i,i=t}return t<e?e:t>i?i:t}function mi(t){return t<0?0:t>1?1:t}function yi(t,e,i){return t+(e-t)*i}function vi(t){return t*hi}function bi(t){return t*li}function wi(){return ci()}function Si(t){ci=t}function xi(t,e){return wi()*(e-t)+t}function Ti(t,e){return Math.floor(xi(t,e))}function Ci(t){return(t=(9301*t+49297)%233280)/233280}function Ii(t,e,i){return Ci(t)*(i-e)+e}function Ei(t,e,i){return Math.floor(Ii(t,e,i))}function Di(t){return y(t)}function Ai(t,e){return t-Math.floor(t/e)*e}function Mi(t,e){return t=Ai(t,2*e),e-Math.abs(t-e)}function Pi(t,e,i){return(i-t)/(e-t)}function Bi(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function Ri(t,e){return Math.abs(t)>Math.abs(e)?t:e}function Oi(t,e){e.forEach((e=>{Object.defineProperty(t,e,{enumerable:!0})}))}const Li=function(){const t=new Float32Array(1),e=new Int32Array(t.buffer);return function(i){t[0]=i;const s=e[0],r=s>>16&32768,n=2147483647&s;let o=n-(112<<23)+4096>>13;return o=n<113<<23?0:o,o=n>=143<<23?31744:o,o=n>255<<23?32256:o,e[0]=r|o,e[0]}}(),Fi=function(){const t=new Float32Array(1),e=new Int32Array(t.buffer);return function(i){const s=32767&i;let r=s<<13,n=0;return 31744!==r?(r+=112<<23,0===s?r=(1048575&r)>>1:32767===s&&(r=2147483647)):r=2139095040,n=(i>>15&1)<<31|r,e[0]=n,t[0]}}();function zi(t){return Li(t)}function ki(t){return Fi(t)}var Ni;const Ui=Math.abs,Vi=Math.max,Hi=Math.min,Gi=Math.PI,Wi=Math.acos,ji=Math.sin,$i=Math.cos,qi=Math.sqrt,Xi=Math.ceil,Yi=Math.floor,Qi=Math.round;class Ki extends re{static zero(t){return t.x=0,t.y=0,t.z=0,t}static clone(t){return new Ki(t.x,t.y,t.z)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t}static set(t,e,i,s){return t.x=e,t.y=i,t.z=s,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t}static ceil(t,e){return t.x=Xi(e.x),t.y=Xi(e.y),t.z=Xi(e.z),t}static floor(t,e){return t.x=Yi(e.x),t.y=Yi(e.y),t.z=Yi(e.z),t}static min(t,e,i){return t.x=Hi(e.x,i.x),t.y=Hi(e.y,i.y),t.z=Hi(e.z,i.z),t}static max(t,e,i){return t.x=Vi(e.x,i.x),t.y=Vi(e.y,i.y),t.z=Vi(e.z,i.z),t}static round(t,e){return t.x=Qi(e.x),t.y=Qi(e.y),t.z=Qi(e.z),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t}static scaleAndAdd(t,e,i,s){return t.x=e.x+i.x*s,t.y=e.y+i.y*s,t.z=e.z+i.z*s,t}static distance(t,e){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z;return qi(i*i+s*s+r*r)}static squaredDistance(t,e){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z;return i*i+s*s+r*r}static len(t){const e=t.x,i=t.y,s=t.z;return qi(e*e+i*i+s*s)}static lengthSqr(t){const e=t.x,i=t.y,s=t.z;return e*e+i*i+s*s}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t}static invert(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t}static invertSafe(t,e){const i=e.x,s=e.y,r=e.z;return Ui(i)<pi?t.x=0:t.x=1/i,Ui(s)<pi?t.y=0:t.y=1/s,Ui(r)<pi?t.z=0:t.z=1/r,t}static normalize(t,e){const i=e.x,s=e.y,r=e.z;let n=i*i+s*s+r*r;return n>0?(n=1/qi(n),t.x=i*n,t.y=s*n,t.z=r*n):(t.x=0,t.y=0,t.z=0),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e,i){const{x:s,y:r,z:n}=e,{x:o,y:a,z:h}=i;return t.x=r*h-n*a,t.y=n*o-s*h,t.z=s*a-r*o,t}static lerp(t,e,i,s){return t.x=e.x+s*(i.x-e.x),t.y=e.y+s*(i.y-e.y),t.z=e.z+s*(i.z-e.z),t}static random(t,e){e=e||1;const i=2*wi()*Gi,s=2*wi()-1,r=qi(1-s*s);return t.x=r*$i(i)*e,t.y=r*ji(i)*e,t.z=s*e,t}static transformMat4(t,e,i){const s=e.x,r=e.y,n=e.z;let o=i.m03*s+i.m07*r+i.m11*n+i.m15;return o=o?1/o:1,t.x=(i.m00*s+i.m04*r+i.m08*n+i.m12)*o,t.y=(i.m01*s+i.m05*r+i.m09*n+i.m13)*o,t.z=(i.m02*s+i.m06*r+i.m10*n+i.m14)*o,t}static transformMat4Normal(t,e,i){const s=e.x,r=e.y,n=e.z;let o=i.m03*s+i.m07*r+i.m11*n;return o=o?1/o:1,t.x=(i.m00*s+i.m04*r+i.m08*n)*o,t.y=(i.m01*s+i.m05*r+i.m09*n)*o,t.z=(i.m02*s+i.m06*r+i.m10*n)*o,t}static transformMat3(t,e,i){const s=e.x,r=e.y,n=e.z;return t.x=s*i.m00+r*i.m03+n*i.m06,t.y=s*i.m01+r*i.m04+n*i.m07,t.z=s*i.m02+r*i.m05+n*i.m08,t}static transformAffine(t,e,i){const s=e.x,r=e.y,n=e.z;return t.x=i.m00*s+i.m04*r+i.m08*n+i.m12,t.y=i.m01*s+i.m05*r+i.m09*n+i.m13,t.z=i.m02*s+i.m06*r+i.m10*n+i.m14,t}static transformQuat(t,e,i){const s=i.w*e.x+i.y*e.z-i.z*e.y,r=i.w*e.y+i.z*e.x-i.x*e.z,n=i.w*e.z+i.x*e.y-i.y*e.x,o=-i.x*e.x-i.y*e.y-i.z*e.z;return t.x=s*i.w+o*-i.x+r*-i.z-n*-i.y,t.y=r*i.w+o*-i.y+n*-i.x-s*-i.z,t.z=n*i.w+o*-i.z+s*-i.y-r*-i.x,t}static transformRTS(t,e,i,s,r){const n=e.x*r.x,o=e.y*r.y,a=e.z*r.z,h=i.w*n+i.y*a-i.z*o,l=i.w*o+i.z*n-i.x*a,c=i.w*a+i.x*o-i.y*n,u=-i.x*n-i.y*o-i.z*a;return t.x=h*i.w+u*-i.x+l*-i.z-c*-i.y+s.x,t.y=l*i.w+u*-i.y+c*-i.x-h*-i.z+s.y,t.z=c*i.w+u*-i.z+h*-i.y-l*-i.x+s.z,t}static transformInverseRTS(t,e,i,s,r){const n=e.x-s.x,o=e.y-s.y,a=e.z-s.z,h=i.w*n-i.y*a+i.z*o,l=i.w*o-i.z*n+i.x*a,c=i.w*a-i.x*o+i.y*n,u=i.x*n+i.y*o+i.z*a;return t.x=(h*i.w+u*i.x+l*i.z-c*i.y)/r.x,t.y=(l*i.w+u*i.y+c*i.x-h*i.z)/r.y,t.z=(c*i.w+u*i.z+h*i.y-l*i.x)/r.z,t}static rotateX(t,e,i,s){const r=e.x-i.x,n=e.y-i.y,o=e.z-i.z,a=$i(s),h=ji(s),l=r,c=n*a-o*h,u=n*h+o*a;return t.x=l+i.x,t.y=c+i.y,t.z=u+i.z,t}static rotateY(t,e,i,s){const r=e.x-i.x,n=e.y-i.y,o=e.z-i.z,a=$i(s),h=ji(s),l=o*h+r*a,c=n,u=o*a-r*h;return t.x=l+i.x,t.y=c+i.y,t.z=u+i.z,t}static rotateZ(t,e,i,s){const r=e.x-i.x,n=e.y-i.y,o=e.z-i.z,a=$i(s),h=ji(s),l=r*a-n*h,c=r*h+n*a,u=o;return t.x=l+i.x,t.y=c+i.y,t.z=u+i.z,t}static rotateN(t,e,i,s,r){const n=e.x-i.x,o=e.y-i.y,a=e.z-i.z,h=s.x,l=s.y,c=s.z,u=$i(r),d=ji(r),p=n*(h*h*(1-u)+u)+o*(h*l*(1-u)-c*d)+a*(h*c*(1-u)+l*d),_=n*(h*l*(1-u)+c*d)+o*(l*l*(1-u)+u)+a*(l*c*(1-u)-h*d),g=n*(h*c*(1-u)-l*d)+o*(l*c*(1-u)+h*d)+a*(c*c*(1-u)+u);return t.x=p+i.x,t.y=_+i.y,t.z=g+i.z,t}static toArray(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t}static fromArray(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z}static equals(t,e,i){void 0===i&&(i=pi);const{x:s,y:r,z:n}=t,{x:o,y:a,z:h}=e;return Ui(s-o)<=i*Vi(1,Ui(s),Ui(o))&&Ui(r-a)<=i*Vi(1,Ui(r),Ui(a))&&Ui(n-h)<=i*Vi(1,Ui(n),Ui(h))}static angle(t,e){const i=t.x*t.x+t.y*t.y+t.z*t.z,s=e.x*e.x+e.y*e.y+e.z*e.z;if(0===i||0===s)return 0;let r=(t.x*e.x+t.y*e.y+t.z*e.z)/qi(i*s);return r=fi(r,-1,1),Wi(r)}static projectOnPlane(t,e,i){return Ki.subtract(t,e,Ki.project(t,e,i))}static project(t,e,i){const s=Ki.lengthSqr(i);return s<1e-6?Ki.set(t,0,0,0):Ki.multiplyScalar(t,i,Ki.dot(e,i)/s)}static moveTowards(t,e,i,s){const r=i.x-e.x,n=i.y-e.y,o=i.z-e.z,a=r*r+n*n+o*o;if(0===a||s>=0&&a<s*s)return t.x=i.x,t.y=i.y,t.z=i.z,t;const h=s/qi(a);return t.x=e.x+r*h,t.y=e.y+n*h,t.z=e.z+o*h,t}static generateOrthogonal(t,e){const{x:i,y:s,z:r}=e,n=Ui(i),o=Ui(s),a=Ui(r);return n<o&&n<a?Ki.set(t,0,r,-s):o<a?Ki.set(t,r,0,-i):Ki.set(t,s,-i,0),Ki.normalize(t,t)}constructor(t,e,i){super(),"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=i||0)}clone(){return new Ki(this.x,this.y,this.z)}set(t,e,i){return"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=i||0),this}equals(t,e){return void 0===e&&(e=pi),Ui(this.x-t.x)<=e&&Ui(this.y-t.y)<=e&&Ui(this.z-t.z)<=e}equals3f(t,e,i,s){return void 0===s&&(s=pi),Ui(this.x-t)<=s&&Ui(this.y-e)<=s&&Ui(this.z-i)<=s}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}strictEquals3f(t,e,i){return this.x===t&&this.y===e&&this.z===i}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)})`}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add3f(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subtract3f(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}multiplyScalar(t){return"object"==typeof t&&G(16357),this.x*=t,this.y*=t,this.z*=t,this}multiply(t){return"object"!=typeof t&&G(16358),this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiply3f(t,e,i){return this.x*=t,this.y*=e,this.z*=i,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divide3f(t,e,i){return this.x/=t,this.y/=e,this.z/=i,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}clampf(t,e){return this.x=fi(this.x,t.x,e.x),this.y=fi(this.y,t.y,e.y),this.z=fi(this.z,t.z,e.z),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){const{x:e,y:i,z:s}=this,{x:r,y:n,z:o}=t;return this.x=i*o-s*n,this.y=s*r-e*o,this.z=e*n-i*r,this}length(){const t=this;return qi(t.x*t.x+t.y*t.y+t.z*t.z)}lengthSqr(){const t=this;return t.x*t.x+t.y*t.y+t.z*t.z}normalize(){const t=this,e=t.x,i=t.y,s=t.z;let r=e*e+i*i+s*s;return r>0&&(r=1/qi(r),t.x=e*r,t.y=i*r,t.z=s*r),t}transformMat4(t){const e=this,i=e.x,s=e.y,r=e.z;let n=t.m03*i+t.m07*s+t.m11*r+t.m15;return n=n?1/n:1,e.x=(t.m00*i+t.m04*s+t.m08*r+t.m12)*n,e.y=(t.m01*i+t.m05*s+t.m09*r+t.m13)*n,e.z=(t.m02*i+t.m06*s+t.m10*r+t.m14)*n,e}toVec2(){return new l.Vec2(this.x,this.y)}}function Zi(t,e,i){return new Ki(t,e,i)}t("Vec3",Ki),Ni=Ki,Ki.UNIT_X=Object.freeze(new Ni(1,0,0)),Ki.UNIT_Y=Object.freeze(new Ni(0,1,0)),Ki.UNIT_Z=Object.freeze(new Ni(0,0,1)),Ki.RIGHT=Object.freeze(new Ni(1,0,0)),Ki.UP=Object.freeze(new Ni(0,1,0)),Ki.FORWARD=Object.freeze(new Ni(0,0,-1)),Ki.ZERO=Object.freeze(new Ni(0,0,0)),Ki.ONE=Object.freeze(new Ni(1,1,1)),Ki.NEG_ONE=Object.freeze(new Ni(-1,-1,-1)),Ki.slerp=(()=>{const t=new Ni,e=new Ni,i=new Ni;return(s,r,n,o)=>{const a=1e-5,h=Ni.len(r),l=Ni.len(n);if(h<a||l<a)return Ni.lerp(s,r,n,o);const c=yi(h,l,o),u=Ni.dot(r,n)/(h*l);if(u>.99999)return Ni.lerp(s,r,n,o);if(u<-.99999){const n=Ni.multiplyScalar(t,r,1/h),a=Ni.generateOrthogonal(e,n);return Ji(i,n,a,Gi*o),Ni.multiplyScalar(s,i,c),s}{const a=u,d=Wi(a)*o,p=Ni.multiplyScalar(t,r,1/h),_=Ni.multiplyScalar(e,n,1/l);return Ni.scaleAndAdd(i,_,p,-a),Ni.normalize(i,i),Ni.multiplyScalar(i,i,ji(d)),Ni.scaleAndAdd(i,i,p,$i(d)),Ni.multiplyScalar(s,i,c),s}}})(),Ki.signedAngle=(()=>{const t=new Ni;return(e,i,s)=>{const r=Ni.angle(e,i),n=Ni.cross(t,e,i);return Ni.dot(n,s)<0?-r:r}})(),ri.fastDefine("cc.Vec3",Ki,{x:0,y:0,z:0}),l.Vec3=Ki;const Ji=(()=>{const t={x:0,y:0,z:0,w:0};return(e,i,s,r)=>{const n=.5*r,o=ji(n);return t.x=o*s.x,t.y=o*s.y,t.z=o*s.z,t.w=$i(n),Ki.transformQuat(e,i,t),e}})();var ts;l.v3=Zi;const es=Math.abs,is=Math.max;class ss extends re{static clone(t){return new ss(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static set(t,e,i,s,r,n,o,a,h,l){return t.m00=e,t.m01=i,t.m02=s,t.m03=r,t.m04=n,t.m05=o,t.m06=a,t.m07=h,t.m08=l,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static transpose(t,e){if(t===e){const i=e.m01,s=e.m02,r=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=i,t.m05=e.m07,t.m06=s,t.m07=r}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t}static invert(t,e){const i=e.m00,s=e.m01,r=e.m02,n=e.m03,o=e.m04,a=e.m05,h=e.m06,l=e.m07,c=e.m08,u=c*o-a*l,d=-c*n+a*h,p=l*n-o*h;let _=i*u+s*d+r*p;return 0===_?(ss.set(t,0,0,0,0,0,0,0,0,0),t):(_=1/_,t.m00=u*_,t.m01=(-c*s+r*l)*_,t.m02=(a*s-r*o)*_,t.m03=d*_,t.m04=(c*i-r*h)*_,t.m05=(-a*i+r*n)*_,t.m06=p*_,t.m07=(-l*i+s*h)*_,t.m08=(o*i-s*n)*_,t)}static determinant(t){const e=t.m00,i=t.m01,s=t.m02,r=t.m03,n=t.m04,o=t.m05,a=t.m06,h=t.m07,l=t.m08;return e*(l*n-o*h)+i*(-l*r+o*a)+s*(h*r-n*a)}static multiply(t,e,i){const s=e.m00,r=e.m01,n=e.m02,o=e.m03,a=e.m04,h=e.m05,l=e.m06,c=e.m07,u=e.m08,d=i.m00,p=i.m01,_=i.m02,g=i.m03,f=i.m04,m=i.m05,y=i.m06,v=i.m07,b=i.m08;return t.m00=d*s+p*o+_*l,t.m01=d*r+p*a+_*c,t.m02=d*n+p*h+_*u,t.m03=g*s+f*o+m*l,t.m04=g*r+f*a+m*c,t.m05=g*n+f*h+m*u,t.m06=y*s+v*o+b*l,t.m07=y*r+v*a+b*c,t.m08=y*n+v*h+b*u,t}static multiplyMat4(t,e,i){const s=e.m00,r=e.m01,n=e.m02,o=e.m03,a=e.m04,h=e.m05,l=e.m06,c=e.m07,u=e.m08,d=i.m00,p=i.m01,_=i.m02,g=i.m04,f=i.m05,m=i.m06,y=i.m08,v=i.m09,b=i.m10;return t.m00=d*s+p*o+_*l,t.m01=d*r+p*a+_*c,t.m02=d*n+p*h+_*u,t.m03=g*s+f*o+m*l,t.m04=g*r+f*a+m*c,t.m05=g*n+f*h+m*u,t.m06=y*s+v*o+b*l,t.m07=y*r+v*a+b*c,t.m08=y*n+v*h+b*u,t}static transform(t,e,i){this.translate(t,e,i)}static translate(t,e,i){const s=e.m00,r=e.m01,n=e.m02,o=e.m03,a=e.m04,h=e.m05,l=e.m06,c=e.m07,u=e.m08,d=i.x,p=i.y;return t.m00=s,t.m01=r,t.m02=n,t.m03=o,t.m04=a,t.m05=h,t.m06=d*s+p*o+l,t.m07=d*r+p*a+c,t.m08=d*n+p*h+u,t}static scale(t,e,i){const s=i.x,r=i.y;return t.m00=s*e.m00,t.m01=s*e.m01,t.m02=s*e.m02,t.m03=r*e.m03,t.m04=r*e.m04,t.m05=r*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static rotate(t,e,i){const s=e.m00,r=e.m01,n=e.m02,o=e.m03,a=e.m04,h=e.m05,l=e.m06,c=e.m07,u=e.m08,d=Math.sin(i),p=Math.cos(i);return t.m00=p*s+d*o,t.m01=p*r+d*a,t.m02=p*n+d*h,t.m03=p*o-d*s,t.m04=p*a-d*r,t.m05=p*h-d*n,t.m06=l,t.m07=c,t.m08=u,t}static fromMat4(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t}static fromViewUp(t,e,i){return Ki.lengthSqr(e)<pi*pi?(ss.identity(t),t):(i=i||Ki.UNIT_Y,Ki.normalize(rs,Ki.cross(rs,i,e)),Ki.lengthSqr(rs)<pi*pi?(ss.identity(t),t):(Ki.cross(ns,e,rs),ss.set(t,rs.x,rs.y,rs.z,ns.x,ns.y,ns.z,e.x,e.y,e.z),t))}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromRotation(t,e){const i=Math.sin(e),s=Math.cos(e);return t.m00=s,t.m01=i,t.m02=0,t.m03=-i,t.m04=s,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromQuat(t,e){const i=e.x,s=e.y,r=e.z,n=e.w,o=i+i,a=s+s,h=r+r,l=i*o,c=s*o,u=s*a,d=r*o,p=r*a,_=r*h,g=n*o,f=n*a,m=n*h;return t.m00=1-u-_,t.m03=c-m,t.m06=d+f,t.m01=c+m,t.m04=1-l-_,t.m07=p-g,t.m02=d-f,t.m05=p+g,t.m08=1-l-u,t}static inverseTransposeMat4(t,e){const i=e.m00,s=e.m01,r=e.m02,n=e.m03,o=e.m04,a=e.m05,h=e.m06,l=e.m07,c=e.m08,u=e.m09,d=e.m10,p=e.m11,_=e.m12,g=e.m13,f=e.m14,m=e.m15,y=i*a-s*o,v=i*h-r*o,b=i*l-n*o,w=s*h-r*a,S=s*l-n*a,x=r*l-n*h,T=c*g-u*_,C=c*f-d*_,I=c*m-p*_,E=u*f-d*g,D=u*m-p*g,A=d*m-p*f;let M=y*A-v*D+b*E+w*I-S*C+x*T;return M?(M=1/M,t.m00=(a*A-h*D+l*E)*M,t.m01=(h*I-o*A-l*C)*M,t.m02=(o*D-a*I+l*T)*M,t.m03=(r*D-s*A-n*E)*M,t.m04=(i*A-r*I+n*C)*M,t.m05=(s*I-i*D-n*T)*M,t.m06=(g*x-f*S+m*w)*M,t.m07=(f*b-_*x-m*v)*M,t.m08=(_*S-g*b+m*y)*M,t):null}static toArray(t,e,i){return void 0===i&&(i=0),t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t}static fromArray(t,e,i){return void 0===i&&(i=0),t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t}static add(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t}static subtract(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t}static multiplyScalar(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t}static multiplyScalarAndAdd(t,e,i,s){return t.m00=i.m00*s+e.m00,t.m01=i.m01*s+e.m01,t.m02=i.m02*s+e.m02,t.m03=i.m03*s+e.m03,t.m04=i.m04*s+e.m04,t.m05=i.m05*s+e.m05,t.m06=i.m06*s+e.m06,t.m07=i.m07*s+e.m07,t.m08=i.m08*s+e.m08,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08}static equals(t,e,i){return void 0===i&&(i=pi),es(t.m00-e.m00)<=i*is(1,es(t.m00),es(e.m00))&&es(t.m01-e.m01)<=i*is(1,es(t.m01),es(e.m01))&&es(t.m02-e.m02)<=i*is(1,es(t.m02),es(e.m02))&&es(t.m03-e.m03)<=i*is(1,es(t.m03),es(e.m03))&&es(t.m04-e.m04)<=i*is(1,es(t.m04),es(e.m04))&&es(t.m05-e.m05)<=i*is(1,es(t.m05),es(e.m05))&&es(t.m06-e.m06)<=i*is(1,es(t.m06),es(e.m06))&&es(t.m07-e.m07)<=i*is(1,es(t.m07),es(e.m07))&&es(t.m08-e.m08)<=i*is(1,es(t.m08),es(e.m08))}static toEuler(t,e){const i=t.m00,s=t.m01;t.m02;const r=t.m03,n=t.m04;t.m05;const o=t.m06,a=t.m07,h=t.m08;return a<.999?a>-.999?(e.x=Math.asin(-a),e.y=Math.atan2(o,h),e.z=Math.atan2(s,n),!0):(e.x=ui,e.y=Math.atan2(r,i),e.z=0,!1):(e.x=-ui,e.y=Math.atan2(-r,i),e.z=0,!1)}constructor(t,e,i,s,r,n,o,a,h){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=1),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=1),super();const l=this;"object"==typeof t?(l.m00=t.m00,l.m01=t.m01,l.m02=t.m02,l.m03=t.m03,l.m04=t.m04,l.m05=t.m05,l.m06=t.m06,l.m07=t.m07,l.m08=t.m08):(l.m00=t,l.m01=e,l.m02=i,l.m03=s,l.m04=r,l.m05=n,l.m06=o,l.m07=a,l.m08=h)}clone(){return new ss(this)}set(t,e,i,s,r,n,o,a,h){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=1),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=1);const l=this;return"object"==typeof t?(l.m00=t.m00,l.m01=t.m01,l.m02=t.m02,l.m03=t.m03,l.m04=t.m04,l.m05=t.m05,l.m06=t.m06,l.m07=t.m07,l.m08=t.m08):(l.m00=t,l.m01=e,l.m02=i,l.m03=s,l.m04=r,l.m05=n,l.m06=o,l.m07=a,l.m08=h),l}equals(t,e){return void 0===e&&(e=pi),ss.equals(this,t,e)}strictEquals(t){return ss.strictEquals(this,t)}toString(){const t=this;return`[\n${t.m00}, ${t.m01}, ${t.m02},\n${t.m03},\n${t.m04}, ${t.m05},\n${t.m06}, ${t.m07},\n${t.m08}\n]`}identity(){return ss.identity(this)}transpose(){const t=this,e=t.m01,i=t.m02,s=t.m05;return t.m01=t.m03,t.m02=t.m06,t.m03=e,t.m05=t.m07,t.m06=i,t.m07=s,t}invert(){return ss.invert(this,this)}determinant(){return ss.determinant(this)}add(t){const e=this;return e.m00+=t.m00,e.m01+=t.m01,e.m02+=t.m02,e.m03+=t.m03,e.m04+=t.m04,e.m05+=t.m05,e.m06+=t.m06,e.m07+=t.m07,e.m08+=t.m08,e}subtract(t){const e=this;return e.m00-=t.m00,e.m01-=t.m01,e.m02-=t.m02,e.m03-=t.m03,e.m04-=t.m04,e.m05-=t.m05,e.m06-=t.m06,e.m07-=t.m07,e.m08-=t.m08,e}multiply(t){return ss.multiply(this,this,t)}multiplyScalar(t){const e=this;return e.m00*=t,e.m01*=t,e.m02*=t,e.m03*=t,e.m04*=t,e.m05*=t,e.m06*=t,e.m07*=t,e.m08*=t,e}scale(t){const e=t.x,i=t.y,s=this;return s.m00*=e,s.m01*=e,s.m02*=e,s.m03*=i,s.m04*=i,s.m05*=i,s}rotate(t){const e=this,i=e.m00,s=e.m01,r=e.m02,n=e.m03,o=e.m04,a=e.m05,h=e.m06,l=e.m07,c=e.m08,u=Math.sin(t),d=Math.cos(t);return e.m00=d*i+u*n,e.m01=d*s+u*o,e.m02=d*r+u*a,e.m03=d*n-u*i,e.m04=d*o-u*s,e.m05=d*a-u*r,e.m06=h,e.m07=l,e.m08=c,e}fromQuat(t){const e=t.x,i=t.y,s=t.z,r=t.w,n=e+e,o=i+i,a=s+s,h=e*n,l=i*n,c=i*o,u=s*n,d=s*o,p=s*a,_=r*n,g=r*o,f=r*a,m=this;return m.m00=1-c-p,m.m03=l-f,m.m06=u+g,m.m01=l+f,m.m04=1-h-p,m.m07=d-_,m.m02=u-g,m.m05=d+_,m.m08=1-h-c,m}}t("Mat3",ss),ts=ss,ss.IDENTITY=Object.freeze(new ts);const rs=new Ki,ns=new Ki;var os;ri.fastDefine("cc.Mat3",ss,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),l.Mat3=ss;const as=Math.abs,hs=Math.max,ls=Math.min,cs=Math.PI,us=Math.acos,ds=Math.sin,ps=Math.cos,_s=Math.sqrt,gs=Math.atan2,fs=Math.asin,ms=Math.sign;class ys extends re{static clone(t){return new ys(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,i,s,r){return t.x=e,t.y=i,t.z=s,t.w=r,t}static identity(t){return t.x=0,t.y=0,t.z=0,t.w=1,t}static rotationTo(t,e,i){const s=Ki.dot(e,i);return s<-.999999?(Ki.cross(ws,Ki.UNIT_X,e),ws.length()<1e-6&&Ki.cross(ws,Ki.UNIT_Y,e),Ki.normalize(ws,ws),ys.fromAxisAngle(t,ws,cs),t):s>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(Ki.cross(ws,e,i),t.x=ws.x,t.y=ws.y,t.z=ws.z,t.w=1+s,ys.normalize(t,t))}static getAxisAngle(t,e){const i=2*us(e.w),s=ds(i/2);return 0!==s?(t.x=e.x/s,t.y=e.y/s,t.z=e.z/s):(t.x=1,t.y=0,t.z=0),i}static multiply(t,e,i){const s=e.x*i.w+e.w*i.x+e.y*i.z-e.z*i.y,r=e.y*i.w+e.w*i.y+e.z*i.x-e.x*i.z,n=e.z*i.w+e.w*i.z+e.x*i.y-e.y*i.x,o=e.w*i.w-e.x*i.x-e.y*i.y-e.z*i.z;return t.x=s,t.y=r,t.z=n,t.w=o,t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t}static scaleAndAdd(t,e,i,s){return t.x=e.x+i.x*s,t.y=e.y+i.y*s,t.z=e.z+i.z*s,t.w=e.w+i.w*s,t}static rotateX(t,e,i){const s=ds(i*=.5),r=ps(i),{x:n,y:o,z:a,w:h}=e;return t.x=n*r+h*s,t.y=o*r+a*s,t.z=a*r-o*s,t.w=h*r-n*s,t}static rotateY(t,e,i){const s=ds(i*=.5),r=ps(i),{x:n,y:o,z:a,w:h}=e;return t.x=n*r-a*s,t.y=o*r+h*s,t.z=a*r+n*s,t.w=h*r-o*s,t}static rotateZ(t,e,i){const s=ds(i*=.5),r=ps(i),{x:n,y:o,z:a,w:h}=e;return t.x=n*r+o*s,t.y=o*r-n*s,t.z=a*r+h*s,t.w=h*r-a*s,t}static rotateAround(t,e,i,s){return ys.invert(vs,e),Ki.transformQuat(ws,i,vs),ys.fromAxisAngle(vs,ws,s),ys.multiply(t,e,vs),t}static rotateAroundLocal(t,e,i,s){return ys.fromAxisAngle(vs,i,s),ys.multiply(t,e,vs),t}static calculateW(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=_s(as(1-e.x*e.x-e.y*e.y-e.z*e.z)),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,i,s){return t.x=e.x+s*(i.x-e.x),t.y=e.y+s*(i.y-e.y),t.z=e.z+s*(i.z-e.z),t.w=e.w+s*(i.w-e.w),t}static slerp(t,e,i,s){let r=0,n=0,o=i.x,a=i.y,h=i.z,l=i.w,c=e.x*i.x+e.y*i.y+e.z*i.z+e.w*i.w;if(c<0&&(c=-c,o=-o,a=-a,h=-h,l=-l),1-c>1e-6){const t=us(c),e=ds(t);r=ds((1-s)*t)/e,n=ds(s*t)/e}else r=1-s,n=s;return t.x=r*e.x+n*o,t.y=r*e.y+n*a,t.z=r*e.z+n*h,t.w=r*e.w+n*l,t}static sqlerp(t,e,i,s,r,n){return ys.slerp(vs,e,r,n),ys.slerp(bs,i,s,n),ys.slerp(t,vs,bs,2*n*(1-n)),t}static invert(t,e){const i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,s=i?1/i:0;return t.x=-e.x*s,t.y=-e.y*s,t.z=-e.z*s,t.w=e.w*s,t}static conjugate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t}static len(t){return _s(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)}static lengthSqr(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w}static normalize(t,e){let i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return i>0?(i=1/_s(i),t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i):(t.x=0,t.y=0,t.z=0,t.w=0),t}static fromAxes(t,e,i,s){return ss.set(Ss,e.x,e.y,e.z,i.x,i.y,i.z,s.x,s.y,s.z),ys.normalize(t,ys.fromMat3(t,Ss))}static fromViewUp(t,e,i){return ss.fromViewUp(Ss,e,i),ys.normalize(t,ys.fromMat3(t,Ss))}static fromAxisAngle(t,e,i){const s=ds(i*=.5);return t.x=s*e.x,t.y=s*e.y,t.z=s*e.z,t.w=ps(i),t}static fromMat3(t,e){const{m00:i,m01:s,m02:r,m03:n,m04:o,m05:a,m06:h,m07:l,m08:c}=e,u=i-o-c,d=o-i-c,p=c-i-o;let _=0,g=i+o+c;u>g&&(g=u,_=1),d>g&&(g=d,_=2),p>g&&(g=p,_=3);const f=.5*_s(g+1),m=.25/f;switch(_){case 0:t.w=f,t.x=(a-l)*m,t.y=(h-r)*m,t.z=(s-n)*m;break;case 1:t.w=(a-l)*m,t.x=f,t.y=(s+n)*m,t.z=(h+r)*m;break;case 2:t.w=(h-r)*m,t.x=(s+n)*m,t.y=f,t.z=(a+l)*m;break;case 3:t.w=(s-n)*m,t.x=(h+r)*m,t.y=(a+l)*m,t.z=f;break;default:t.w=1,t.x=0,t.y=0,t.z=0}return t}static fromEuler(t,e,i,s){i*=xs,s*=xs;const r=ds(e*=xs),n=ps(e),o=ds(i),a=ps(i),h=ds(s),l=ps(s);return t.x=r*a*l+n*o*h,t.y=n*o*l+r*a*h,t.z=n*a*h-r*o*l,t.w=n*a*l-r*o*h,t}static fromAngleZ(t,e){return e*=xs,t.x=t.y=0,t.z=ds(e),t.w=ps(e),t}static toAxisX(t,e){const i=2*e.y,s=2*e.z;return t.x=1-i*e.y-s*e.z,t.y=i*e.x+s*e.w,t.z=s*e.x-i*e.w,t}static toAxisY(t,e){const i=2*e.x,s=2*e.y,r=2*e.z;return t.x=s*e.x-r*e.w,t.y=1-i*e.x-r*e.z,t.z=r*e.y+i*e.w,t}static toAxisZ(t,e){const i=2*e.x,s=2*e.y,r=2*e.z;return t.x=r*e.x+s*e.w,t.y=r*e.y-i*e.w,t.z=1-i*e.x-s*e.y,t}static toEuler(t,e,i){const{x:s,y:r,z:n,w:o}=e;let a=0,h=0,l=0;const c=s*r+n*o;if(c>.499999)a=0,h=bi(2*gs(s,o)),l=90;else if(c<-.499999)a=0,h=-bi(2*gs(s,o)),l=-90;else{const t=r*r,e=n*n;a=bi(gs(2*s*o-2*r*n,1-s*s*2-2*e)),h=bi(gs(2*r*o-2*s*n,1-2*t-2*e)),l=bi(fs(2*c)),i&&(a=-180*ms(a+1e-6)+a,h=-180*ms(h+1e-6)+h,l=180*ms(l+1e-6)-l)}return t.x=a,t.y=h,t.z=l,t}static toEulerInYXZOrder(t,e){ss.fromQuat(Ss,e),ss.toEuler(Ss,t),t.x=bi(t.x),t.y=bi(t.y),t.z=bi(t.z)}static toArray(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t}static fromArray(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,i){return void 0===i&&(i=pi),as(t.x-e.x)<=i*hs(1,as(t.x),as(e.x))&&as(t.y-e.y)<=i*hs(1,as(t.y),as(e.y))&&as(t.z-e.z)<=i*hs(1,as(t.z),as(e.z))&&as(t.w-e.w)<=i*hs(1,as(t.w),as(e.w))}static angle(t,e){const i=ls(as(ys.dot(t,e)),1);return 2*us(i)}static rotateTowards(t,e,i,s){const r=ys.angle(e,i);if(0===r)return t.x=i.x,t.y=i.y,t.z=i.z,t.w=i.w,t;const n=ls(s/bi(r),1);return ys.slerp(t,e,i,n)}constructor(t,e,i,s){super(),"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=null!=s?s:1)}clone(){return new ys(this.x,this.y,this.z,this.w)}set(t,e,i,s){return"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=null!=s?s:1),this}equals(t,e){return void 0===e&&(e=pi),ys.equals(this,t,e)}strictEquals(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}getEulerAngles(t){return ys.toEuler(t,this)}lerp(t,e){const i=this;return i.x+=e*(t.x-i.x),i.y+=e*(t.y-i.y),i.z+=e*(t.z-i.z),i.w+=e*(t.w-i.w),i}slerp(t,e){return ys.slerp(this,this,t,e)}length(){const{x:t,y:e,z:i,w:s}=this;return _s(t*t+e*e+i*i+s*s)}lengthSqr(){const{x:t,y:e,z:i,w:s}=this;return t*t+e*e+i*i+s*s}}t("Quat",ys),os=ys,ys.IDENTITY=Object.freeze(new os);const vs=new ys,bs=new ys,ws=new Ki,Ss=new ss,xs=.5*cs/180;function Ts(t,e,i,s){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=1),new ys(t,e,i,s)}var Cs;ri.fastDefine("cc.Quat",ys,{x:0,y:0,z:0,w:1}),l.Quat=ys,l.quat=Ts;const Is=t("preTransforms",Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])])),Es=Math.abs,Ds=Math.max,As=Math.sqrt,Ms=Math.sin,Ps=Math.cos,Bs=Math.tan;class Rs extends re{static clone(t){return new Rs(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static set(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_,g,f){return t.m00=e,t.m01=i,t.m02=s,t.m03=r,t.m04=n,t.m05=o,t.m06=a,t.m07=h,t.m08=l,t.m09=c,t.m10=u,t.m11=d,t.m12=p,t.m13=_,t.m14=g,t.m15=f,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static zero(t){return t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t}static transpose(t,e){if(t===e){const i=e.m01,s=e.m02,r=e.m03,n=e.m06,o=e.m07,a=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=i,t.m06=e.m09,t.m07=e.m13,t.m08=s,t.m09=n,t.m11=e.m14,t.m12=r,t.m13=o,t.m14=a}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t}static invert(t,e){const i=e.m00,s=e.m01,r=e.m02,n=e.m03,o=e.m04,a=e.m05,h=e.m06,l=e.m07,c=e.m08,u=e.m09,d=e.m10,p=e.m11,_=e.m12,g=e.m13,f=e.m14,m=e.m15,y=i*a-s*o,v=i*h-r*o,b=i*l-n*o,w=s*h-r*a,S=s*l-n*a,x=r*l-n*h,T=c*g-u*_,C=c*f-d*_,I=c*m-p*_,E=u*f-d*g,D=u*m-p*g,A=d*m-p*f;let M=y*A-v*D+b*E+w*I-S*C+x*T;return 0===M?Rs.zero(t):(M=1/M,t.m00=(a*A-h*D+l*E)*M,t.m01=(r*D-s*A-n*E)*M,t.m02=(g*x-f*S+m*w)*M,t.m03=(d*S-u*x-p*w)*M,t.m04=(h*I-o*A-l*C)*M,t.m05=(i*A-r*I+n*C)*M,t.m06=(f*b-_*x-m*v)*M,t.m07=(c*x-d*b+p*v)*M,t.m08=(o*D-a*I+l*T)*M,t.m09=(s*I-i*D-n*T)*M,t.m10=(_*S-g*b+m*y)*M,t.m11=(u*b-c*S-p*y)*M,t.m12=(a*C-o*E-h*T)*M,t.m13=(i*E-s*C+r*T)*M,t.m14=(g*v-_*w-f*y)*M,t.m15=(c*w-u*v+d*y)*M,t)}static determinant(t){const e=t.m00,i=t.m01,s=t.m02,r=t.m03,n=t.m04,o=t.m05,a=t.m06,h=t.m07,l=t.m08,c=t.m09,u=t.m10,d=t.m11,p=t.m12,_=t.m13,g=t.m14,f=t.m15;return(e*o-i*n)*(u*f-d*g)-(e*a-s*n)*(c*f-d*_)+(e*h-r*n)*(c*g-u*_)+(i*a-s*o)*(l*f-d*p)-(i*h-r*o)*(l*g-u*p)+(s*h-r*a)*(l*_-c*p)}static multiply(t,e,i){const s=e.m00,r=e.m01,n=e.m02,o=e.m03,a=e.m04,h=e.m05,l=e.m06,c=e.m07,u=e.m08,d=e.m09,p=e.m10,_=e.m11,g=e.m12,f=e.m13,m=e.m14,y=e.m15;let v=i.m00,b=i.m01,w=i.m02,S=i.m03;return t.m00=v*s+b*a+w*u+S*g,t.m01=v*r+b*h+w*d+S*f,t.m02=v*n+b*l+w*p+S*m,t.m03=v*o+b*c+w*_+S*y,v=i.m04,b=i.m05,w=i.m06,S=i.m07,t.m04=v*s+b*a+w*u+S*g,t.m05=v*r+b*h+w*d+S*f,t.m06=v*n+b*l+w*p+S*m,t.m07=v*o+b*c+w*_+S*y,v=i.m08,b=i.m09,w=i.m10,S=i.m11,t.m08=v*s+b*a+w*u+S*g,t.m09=v*r+b*h+w*d+S*f,t.m10=v*n+b*l+w*p+S*m,t.m11=v*o+b*c+w*_+S*y,v=i.m12,b=i.m13,w=i.m14,S=i.m15,t.m12=v*s+b*a+w*u+S*g,t.m13=v*r+b*h+w*d+S*f,t.m14=v*n+b*l+w*p+S*m,t.m15=v*o+b*c+w*_+S*y,t}static transform(t,e,i){const s=i.x,r=i.y,n=i.z;if(e===t)t.m12=e.m00*s+e.m04*r+e.m08*n+e.m12,t.m13=e.m01*s+e.m05*r+e.m09*n+e.m13,t.m14=e.m02*s+e.m06*r+e.m10*n+e.m14,t.m15=e.m03*s+e.m07*r+e.m11*n+e.m15;else{const i=e.m00,o=e.m01,a=e.m02,h=e.m03,l=e.m04,c=e.m05,u=e.m06,d=e.m07,p=e.m08,_=e.m09,g=e.m10,f=e.m11;t.m00=i,t.m01=o,t.m02=a,t.m03=h,t.m04=l,t.m05=c,t.m06=u,t.m07=d,t.m08=p,t.m09=_,t.m10=g,t.m11=f,t.m12=i*s+l*r+p*n+e.m12,t.m13=o*s+c*r+_*n+e.m13,t.m14=a*s+u*r+g*n+e.m14,t.m15=h*s+d*r+f*n+e.m15}return t}static translate(t,e,i){return e===t?(t.m12+=i.x,t.m13+=i.y,t.m14+=i.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12+i.x,t.m13=e.m13+i.y,t.m14=e.m14+i.z,t.m15=e.m15),t}static scale(t,e,i){const s=i.x,r=i.y,n=i.z;return t.m00=e.m00*s,t.m01=e.m01*s,t.m02=e.m02*s,t.m03=e.m03*s,t.m04=e.m04*r,t.m05=e.m05*r,t.m06=e.m06*r,t.m07=e.m07*r,t.m08=e.m08*n,t.m09=e.m09*n,t.m10=e.m10*n,t.m11=e.m11*n,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static rotate(t,e,i,s){let r=s.x,n=s.y,o=s.z,a=As(r*r+n*n+o*o);if(Es(a)<pi)return null;a=1/a,r*=a,n*=a,o*=a;const h=Ms(i),l=Ps(i),c=1-l,u=e.m00,d=e.m01,p=e.m02,_=e.m03,g=e.m04,f=e.m05,m=e.m06,y=e.m07,v=e.m08,b=e.m09,w=e.m10,S=e.m11,x=r*r*c+l,T=n*r*c+o*h,C=o*r*c-n*h,I=r*n*c-o*h,E=n*n*c+l,D=o*n*c+r*h,A=r*o*c+n*h,M=n*o*c-r*h,P=o*o*c+l;return t.m00=u*x+g*T+v*C,t.m01=d*x+f*T+b*C,t.m02=p*x+m*T+w*C,t.m03=_*x+y*T+S*C,t.m04=u*I+g*E+v*D,t.m05=d*I+f*E+b*D,t.m06=p*I+m*E+w*D,t.m07=_*I+y*E+S*D,t.m08=u*A+g*M+v*P,t.m09=d*A+f*M+b*P,t.m10=p*A+m*M+w*P,t.m11=_*A+y*M+S*P,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t}static rotateX(t,e,i){const s=Ms(i),r=Ps(i),n=e.m04,o=e.m05,a=e.m06,h=e.m07,l=e.m08,c=e.m09,u=e.m10,d=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=n*r+l*s,t.m05=o*r+c*s,t.m06=a*r+u*s,t.m07=h*r+d*s,t.m08=l*r-n*s,t.m09=c*r-o*s,t.m10=u*r-a*s,t.m11=d*r-h*s,t}static rotateY(t,e,i){const s=Ms(i),r=Ps(i),n=e.m00,o=e.m01,a=e.m02,h=e.m03,l=e.m08,c=e.m09,u=e.m10,d=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=n*r-l*s,t.m01=o*r-c*s,t.m02=a*r-u*s,t.m03=h*r-d*s,t.m08=n*s+l*r,t.m09=o*s+c*r,t.m10=a*s+u*r,t.m11=h*s+d*r,t}static rotateZ(t,e,i){const s=Ms(i),r=Ps(i),n=e.m00,o=e.m01,a=e.m02,h=e.m03,l=e.m04,c=e.m05,u=e.m06,d=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=n*r+l*s,t.m01=o*r+c*s,t.m02=a*r+u*s,t.m03=h*r+d*s,t.m04=l*r-n*s,t.m05=c*r-o*s,t.m06=u*r-a*s,t.m07=d*r-h*s,t}static fromTranslation(t,e){return Rs.identity(t),t.m12=e.x,t.m13=e.y,t.m14=e.z,t}static fromScaling(t,e){return Rs.identity(t),t.m00=e.x,t.m05=e.y,t.m10=e.z,t}static fromRotation(t,e,i){let s=i.x,r=i.y,n=i.z,o=As(s*s+r*r+n*n);if(Es(o)<pi)return null;o=1/o,s*=o,r*=o,n*=o;const a=Ms(e),h=Ps(e),l=1-h;return t.m00=s*s*l+h,t.m01=r*s*l+n*a,t.m02=n*s*l-r*a,t.m03=0,t.m04=s*r*l-n*a,t.m05=r*r*l+h,t.m06=n*r*l+s*a,t.m07=0,t.m08=s*n*l+r*a,t.m09=r*n*l-s*a,t.m10=n*n*l+h,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromXRotation(t,e){const i=Ms(e),s=Ps(e);return Rs.identity(t),t.m05=s,t.m06=i,t.m09=-i,t.m10=s,t}static fromYRotation(t,e){const i=Ms(e),s=Ps(e);return Rs.identity(t),t.m00=s,t.m02=-i,t.m08=i,t.m10=s,t}static fromZRotation(t,e){const i=Ms(e),s=Ps(e);return Rs.identity(t),t.m00=s,t.m01=i,t.m04=-i,t.m05=s,t}static fromRT(t,e,i){const s=e.x,r=e.y,n=e.z,o=e.w,a=s+s,h=r+r,l=n+n,c=s*a,u=s*h,d=s*l,p=r*h,_=r*l,g=n*l,f=o*a,m=o*h,y=o*l;return t.m00=1-(p+g),t.m01=u+y,t.m02=d-m,t.m03=0,t.m04=u-y,t.m05=1-(c+g),t.m06=_+f,t.m07=0,t.m08=d+m,t.m09=_-f,t.m10=1-(c+p),t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t}static getTranslation(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t}static getScaling(t,e){const i=Ls.m00=e.m00,s=Ls.m01=e.m01,r=Ls.m02=e.m02,n=Ls.m03=e.m04,o=Ls.m04=e.m05,a=Ls.m05=e.m06,h=Ls.m06=e.m08,l=Ls.m07=e.m09,c=Ls.m08=e.m10;return t.x=As(i*i+s*s+r*r),t.y=As(n*n+o*o+a*a),t.z=As(h*h+l*l+c*c),ss.determinant(Ls)<0&&(t.x*=-1),t}static getRotation(t,e){const i=e.m00+e.m05+e.m10;let s=0;return i>0?(s=2*As(i+1),t.w=.25*s,t.x=(e.m06-e.m09)/s,t.y=(e.m08-e.m02)/s,t.z=(e.m01-e.m04)/s):e.m00>e.m05&&e.m00>e.m10?(s=2*As(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/s,t.x=.25*s,t.y=(e.m01+e.m04)/s,t.z=(e.m08+e.m02)/s):e.m05>e.m10?(s=2*As(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/s,t.x=(e.m01+e.m04)/s,t.y=.25*s,t.z=(e.m06+e.m09)/s):(s=2*As(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/s,t.x=(e.m08+e.m02)/s,t.y=(e.m06+e.m09)/s,t.z=.25*s),t}static toRTS(t,e,i,s){Rs.toSRT(t,e,i,s)}static toSRT(t,e,i,s){i&&Ki.set(i,t.m12,t.m13,t.m14);const r=Ki.set(Os,t.m00,t.m01,t.m02).length(),n=Ki.set(Os,t.m04,t.m05,t.m06).length(),o=Ki.set(Os,t.m08,t.m09,t.m10).length();if(s&&(s.x=r,s.y=n,s.z=o),0===r||0===n||0===o)return void(e&&ys.identity(e));Ls.m00=t.m00/r,Ls.m01=t.m01/r,Ls.m02=t.m02/r,Ls.m03=t.m04/n,Ls.m04=t.m05/n,Ls.m05=t.m06/n,Ls.m06=t.m08/o,Ls.m07=t.m09/o,Ls.m08=t.m10/o;const a=ss.determinant(Ls);s&&a<0&&(s.x*=-1),e&&(a<0&&(Ls.m00*=-1,Ls.m01*=-1,Ls.m02*=-1),ys.fromMat3(e,Ls))}static toEuler(t,e){return ss.set(Ls,t.m00,t.m01,t.m02,t.m04,t.m05,t.m06,t.m08,t.m09,t.m10),ss.toEuler(Ls,e)}static fromRTS(t,e,i,s){return Rs.fromSRT(t,e,i,s)}static fromSRT(t,e,i,s){const{x:r,y:n,z:o,w:a}=e,h=r+r,l=n+n,c=o+o,u=r*h,d=r*l,p=r*c,_=n*l,g=n*c,f=o*c,m=a*h,y=a*l,v=a*c,b=s.x,w=s.y,S=s.z;return t.m00=(1-(_+f))*b,t.m01=(d+v)*b,t.m02=(p-y)*b,t.m03=0,t.m04=(d-v)*w,t.m05=(1-(u+f))*w,t.m06=(g+m)*w,t.m07=0,t.m08=(p+y)*S,t.m09=(g-m)*S,t.m10=(1-(u+_))*S,t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t}static fromRTSOrigin(t,e,i,s,r){return Rs.fromSRTOrigin(t,e,i,s,r)}static fromSRTOrigin(t,e,i,s,r){const n=e.x,o=e.y,a=e.z,h=e.w,l=n+n,c=o+o,u=a+a,d=n*l,p=n*c,_=n*u,g=o*c,f=o*u,m=a*u,y=h*l,v=h*c,b=h*u,w=s.x,S=s.y,x=s.z,T=r.x,C=r.y,I=r.z;return t.m00=(1-(g+m))*w,t.m01=(p+b)*w,t.m02=(_-v)*w,t.m03=0,t.m04=(p-b)*S,t.m05=(1-(d+m))*S,t.m06=(f+y)*S,t.m07=0,t.m08=(_+v)*x,t.m09=(f-y)*x,t.m10=(1-(d+g))*x,t.m11=0,t.m12=i.x+T-(t.m00*T+t.m04*C+t.m08*I),t.m13=i.y+C-(t.m01*T+t.m05*C+t.m09*I),t.m14=i.z+I-(t.m02*T+t.m06*C+t.m10*I),t.m15=1,t}static fromQuat(t,e){const i=e.x,s=e.y,r=e.z,n=e.w,o=i+i,a=s+s,h=r+r,l=i*o,c=s*o,u=s*a,d=r*o,p=r*a,_=r*h,g=n*o,f=n*a,m=n*h;return t.m00=1-u-_,t.m01=c+m,t.m02=d-f,t.m03=0,t.m04=c-m,t.m05=1-l-_,t.m06=p+g,t.m07=0,t.m08=d+f,t.m09=p-g,t.m10=1-l-u,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static frustum(t,e,i,s,r,n,o){const a=1/(i-e),h=1/(r-s),l=1/(n-o);return t.m00=2*n*a,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*n*h,t.m06=0,t.m07=0,t.m08=(i+e)*a,t.m09=(r+s)*h,t.m10=(o+n)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=o*n*2*l,t.m15=0,t}static perspective(t,e,i,s,r,n,o,a,h){void 0===n&&(n=!0),void 0===o&&(o=-1),void 0===a&&(a=1),void 0===h&&(h=0);const l=1/Bs(e/2),c=1/(s-r),u=n?l/i:l,d=(n?l:l*i)*a,p=Is[h];return t.m00=u*p[0],t.m01=u*p[1],t.m02=0,t.m03=0,t.m04=d*p[2],t.m05=d*p[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(r-o*s)*c,t.m11=-1,t.m12=0,t.m13=0,t.m14=r*s*c*(1-o),t.m15=0,t}static ortho(t,e,i,s,r,n,o,a,h,l){void 0===a&&(a=-1),void 0===h&&(h=1),void 0===l&&(l=0);const c=1/(e-i),u=1/(s-r)*h,d=1/(n-o),p=-2*c,_=-2*u,g=(e+i)*c,f=(r+s)*u,m=Is[l];return t.m00=p*m[0],t.m01=p*m[1],t.m02=0,t.m03=0,t.m04=_*m[2],t.m05=_*m[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=d*(1-a),t.m11=0,t.m12=g*m[0]+f*m[2],t.m13=g*m[1]+f*m[3],t.m14=(n-a*o)*d,t.m15=1,t}static lookAt(t,e,i,s){const r=e.x,n=e.y,o=e.z,a=s.x,h=s.y,l=s.z;let c=r-i.x,u=n-i.y,d=o-i.z,p=1/As(c*c+u*u+d*d);c*=p,u*=p,d*=p;let _=h*d-l*u,g=l*c-a*d,f=a*u-h*c;p=1/As(_*_+g*g+f*f),_*=p,g*=p,f*=p;const m=u*f-d*g,y=d*_-c*f,v=c*g-u*_;return t.m00=_,t.m01=m,t.m02=c,t.m03=0,t.m04=g,t.m05=y,t.m06=u,t.m07=0,t.m08=f,t.m09=v,t.m10=d,t.m11=0,t.m12=-(_*r+g*n+f*o),t.m13=-(m*r+y*n+v*o),t.m14=-(c*r+u*n+d*o),t.m15=1,t}static inverseTranspose(t,e){const i=e.m00,s=e.m01,r=e.m02,n=e.m03,o=e.m04,a=e.m05,h=e.m06,l=e.m07,c=e.m08,u=e.m09,d=e.m10,p=e.m11,_=e.m12,g=e.m13,f=e.m14,m=e.m15,y=i*a-s*o,v=i*h-r*o,b=i*l-n*o,w=s*h-r*a,S=s*l-n*a,x=r*l-n*h,T=c*g-u*_,C=c*f-d*_,I=c*m-p*_,E=u*f-d*g,D=u*m-p*g,A=d*m-p*f;let M=y*A-v*D+b*E+w*I-S*C+x*T;return M?(M=1/M,t.m00=(a*A-h*D+l*E)*M,t.m01=(h*I-o*A-l*C)*M,t.m02=(o*D-a*I+l*T)*M,t.m03=0,t.m04=(r*D-s*A-n*E)*M,t.m05=(i*A-r*I+n*C)*M,t.m06=(s*I-i*D-n*T)*M,t.m07=0,t.m08=(g*x-f*S+m*w)*M,t.m09=(f*b-_*x-m*v)*M,t.m10=(_*S-g*b+m*y)*M,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null}static toArray(t,e,i){return void 0===i&&(i=0),t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t[i+9]=e.m09,t[i+10]=e.m10,t[i+11]=e.m11,t[i+12]=e.m12,t[i+13]=e.m13,t[i+14]=e.m14,t[i+15]=e.m15,t}static fromArray(t,e,i){return void 0===i&&(i=0),t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t.m09=e[i+9],t.m10=e[i+10],t.m11=e[i+11],t.m12=e[i+12],t.m13=e[i+13],t.m14=e[i+14],t.m15=e[i+15],t}static add(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t.m09=e.m09+i.m09,t.m10=e.m10+i.m10,t.m11=e.m11+i.m11,t.m12=e.m12+i.m12,t.m13=e.m13+i.m13,t.m14=e.m14+i.m14,t.m15=e.m15+i.m15,t}static subtract(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t.m09=e.m09-i.m09,t.m10=e.m10-i.m10,t.m11=e.m11-i.m11,t.m12=e.m12-i.m12,t.m13=e.m13-i.m13,t.m14=e.m14-i.m14,t.m15=e.m15-i.m15,t}static multiplyScalar(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t.m09=e.m09*i,t.m10=e.m10*i,t.m11=e.m11*i,t.m12=e.m12*i,t.m13=e.m13*i,t.m14=e.m14*i,t.m15=e.m15*i,t}static multiplyScalarAndAdd(t,e,i,s){return t.m00=e.m00+i.m00*s,t.m01=e.m01+i.m01*s,t.m02=e.m02+i.m02*s,t.m03=e.m03+i.m03*s,t.m04=e.m04+i.m04*s,t.m05=e.m05+i.m05*s,t.m06=e.m06+i.m06*s,t.m07=e.m07+i.m07*s,t.m08=e.m08+i.m08*s,t.m09=e.m09+i.m09*s,t.m10=e.m10+i.m10*s,t.m11=e.m11+i.m11*s,t.m12=e.m12+i.m12*s,t.m13=e.m13+i.m13*s,t.m14=e.m14+i.m14*s,t.m15=e.m15+i.m15*s,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15}static equals(t,e,i){return void 0===i&&(i=pi),Es(t.m00-e.m00)<=i*Ds(1,Es(t.m00),Es(e.m00))&&Es(t.m01-e.m01)<=i*Ds(1,Es(t.m01),Es(e.m01))&&Es(t.m02-e.m02)<=i*Ds(1,Es(t.m02),Es(e.m02))&&Es(t.m03-e.m03)<=i*Ds(1,Es(t.m03),Es(e.m03))&&Es(t.m04-e.m04)<=i*Ds(1,Es(t.m04),Es(e.m04))&&Es(t.m05-e.m05)<=i*Ds(1,Es(t.m05),Es(e.m05))&&Es(t.m06-e.m06)<=i*Ds(1,Es(t.m06),Es(e.m06))&&Es(t.m07-e.m07)<=i*Ds(1,Es(t.m07),Es(e.m07))&&Es(t.m08-e.m08)<=i*Ds(1,Es(t.m08),Es(e.m08))&&Es(t.m09-e.m09)<=i*Ds(1,Es(t.m09),Es(e.m09))&&Es(t.m10-e.m10)<=i*Ds(1,Es(t.m10),Es(e.m10))&&Es(t.m11-e.m11)<=i*Ds(1,Es(t.m11),Es(e.m11))&&Es(t.m12-e.m12)<=i*Ds(1,Es(t.m12),Es(e.m12))&&Es(t.m13-e.m13)<=i*Ds(1,Es(t.m13),Es(e.m13))&&Es(t.m14-e.m14)<=i*Ds(1,Es(t.m14),Es(e.m14))&&Es(t.m15-e.m15)<=i*Ds(1,Es(t.m15),Es(e.m15))}constructor(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_,g){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=0),void 0===l&&(l=0),void 0===c&&(c=1),void 0===u&&(u=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===_&&(_=0),void 0===g&&(g=1),super();const f=this;"object"==typeof t?(f.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,f.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,f.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,f.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15):(f.m00=t,this.m01=e,this.m02=i,this.m03=s,f.m04=r,this.m05=n,this.m06=o,this.m07=a,f.m08=h,this.m09=l,this.m10=c,this.m11=u,f.m12=d,this.m13=p,this.m14=_,this.m15=g)}clone(){return new Rs(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)}set(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_,g){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=0),void 0===l&&(l=0),void 0===c&&(c=1),void 0===u&&(u=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===_&&(_=0),void 0===g&&(g=1);const f=this;return"object"==typeof t?(f.m01=t.m01,f.m02=t.m02,f.m03=t.m03,f.m04=t.m04,f.m05=t.m05,f.m06=t.m06,f.m07=t.m07,f.m08=t.m08,f.m09=t.m09,f.m10=t.m10,f.m11=t.m11,f.m12=t.m12,f.m13=t.m13,f.m14=t.m14,f.m15=t.m15,f.m00=t.m00):(f.m01=e,f.m02=i,f.m03=s,f.m04=r,f.m05=n,f.m06=o,f.m07=a,f.m08=h,f.m09=l,f.m10=c,f.m11=u,f.m12=d,f.m13=p,f.m14=_,f.m15=g,f.m00=t),f}equals(t,e){void 0===e&&(e=pi);const i=1/0,s=this,r=s.m00,n=s.m01,o=s.m02,a=s.m03,h=s.m04,l=s.m05,c=s.m06,u=s.m07,d=s.m08,p=s.m09,_=s.m10,g=s.m11,f=s.m12,m=s.m13,y=s.m14,v=s.m15;return!(Es(r)===i||Es(n)===i||Es(o)===i||Es(a)===i||Es(h)===i||Es(l)===i||Es(c)===i||Es(u)===i||Es(d)===i||Es(p)===i||Es(_)===i||Es(g)===i||Es(f)===i||Es(m)===i||Es(y)===i||Es(v)===i)&&Es(r-t.m00)<=e*Ds(1,Es(r),Es(t.m00))&&Es(n-t.m01)<=e*Ds(1,Es(n),Es(t.m01))&&Es(o-t.m02)<=e*Ds(1,Es(o),Es(t.m02))&&Es(a-t.m03)<=e*Ds(1,Es(a),Es(t.m03))&&Es(h-t.m04)<=e*Ds(1,Es(h),Es(t.m04))&&Es(l-t.m05)<=e*Ds(1,Es(l),Es(t.m05))&&Es(c-t.m06)<=e*Ds(1,Es(c),Es(t.m06))&&Es(u-t.m07)<=e*Ds(1,Es(u),Es(t.m07))&&Es(d-t.m08)<=e*Ds(1,Es(d),Es(t.m08))&&Es(p-t.m09)<=e*Ds(1,Es(p),Es(t.m09))&&Es(_-t.m10)<=e*Ds(1,Es(_),Es(t.m10))&&Es(g-t.m11)<=e*Ds(1,Es(g),Es(t.m11))&&Es(f-t.m12)<=e*Ds(1,Es(f),Es(t.m12))&&Es(m-t.m13)<=e*Ds(1,Es(m),Es(t.m13))&&Es(y-t.m14)<=e*Ds(1,Es(y),Es(t.m14))&&Es(v-t.m15)<=e*Ds(1,Es(v),Es(t.m15))}strictEquals(t){const e=this;return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}toString(){return`[\n${this.m00}, ${this.m01}, ${this.m02}, ${this.m03},\n${this.m04}, ${this.m05}, ${this.m06}, ${this.m07},\n${this.m08}, ${this.m09}, ${this.m10}, ${this.m11},\n${this.m12}, ${this.m13}, ${this.m14}, ${this.m15}\n]`}identity(){return Rs.identity(this)}zero(){return Rs.zero(this)}transpose(){const t=this,e=t.m01,i=t.m02,s=t.m03,r=t.m06,n=t.m07,o=t.m11;return t.m01=t.m04,t.m02=t.m08,t.m03=t.m12,t.m04=e,t.m06=t.m09,t.m07=t.m13,t.m08=i,t.m09=r,t.m11=t.m14,t.m12=s,t.m13=n,t.m14=o,t}invert(){const t=this,e=t.m00,i=t.m01,s=t.m02,r=t.m03,n=t.m04,o=t.m05,a=t.m06,h=t.m07,l=t.m08,c=t.m09,u=t.m10,d=t.m11,p=t.m12,_=t.m13,g=t.m14,f=t.m15,m=e*o-i*n,y=e*a-s*n,v=e*h-r*n,b=i*a-s*o,w=i*h-r*o,S=s*h-r*a,x=l*_-c*p,T=l*g-u*p,C=l*f-d*p,I=c*g-u*_,E=c*f-d*_,D=u*f-d*g;let A=m*D-y*E+v*I+b*C-w*T+S*x;return 0===A?(t.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),t):(A=1/A,t.m00=(o*D-a*E+h*I)*A,t.m01=(s*E-i*D-r*I)*A,t.m02=(_*S-g*w+f*b)*A,t.m03=(u*w-c*S-d*b)*A,t.m04=(a*C-n*D-h*T)*A,t.m05=(e*D-s*C+r*T)*A,t.m06=(g*v-p*S-f*y)*A,t.m07=(l*S-u*v+d*y)*A,t.m08=(n*E-o*C+h*x)*A,t.m09=(i*C-e*E-r*x)*A,t.m10=(p*w-_*v+f*m)*A,t.m11=(c*v-l*w-d*m)*A,t.m12=(o*T-n*I-a*x)*A,t.m13=(e*I-i*T+s*x)*A,t.m14=(_*y-p*b-g*m)*A,t.m15=(l*b-c*y+u*m)*A,t)}determinant(){const t=this,e=t.m00,i=t.m01,s=t.m02,r=t.m03,n=t.m04,o=t.m05,a=t.m06,h=t.m07,l=t.m08,c=t.m09,u=t.m10,d=t.m11,p=t.m12,_=t.m13,g=t.m14,f=t.m15;return(e*o-i*n)*(u*f-d*g)-(e*a-s*n)*(c*f-d*_)+(e*h-r*n)*(c*g-u*_)+(i*a-s*o)*(l*f-d*p)-(i*h-r*o)*(l*g-u*p)+(s*h-r*a)*(l*_-c*p)}add(t){const e=this;return e.m00+=t.m00,e.m01+=t.m01,e.m02+=t.m02,e.m03+=t.m03,e.m04+=t.m04,e.m05+=t.m05,e.m06+=t.m06,e.m07+=t.m07,e.m08+=t.m08,e.m09+=t.m09,e.m10+=t.m10,e.m11+=t.m11,e.m12+=t.m12,e.m13+=t.m13,e.m14+=t.m14,e.m15+=t.m15,e}subtract(t){const e=this;return e.m00-=t.m00,e.m01-=t.m01,e.m02-=t.m02,e.m03-=t.m03,e.m04-=t.m04,e.m05-=t.m05,e.m06-=t.m06,e.m07-=t.m07,e.m08-=t.m08,e.m09-=t.m09,e.m10-=t.m10,e.m11-=t.m11,e.m12-=t.m12,e.m13-=t.m13,e.m14-=t.m14,e.m15-=t.m15,e}multiply(t){return Rs.multiply(this,this,t)}multiplyScalar(t){const e=this;return e.m00*=t,e.m01*=t,e.m02*=t,e.m03*=t,e.m04*=t,e.m05*=t,e.m06*=t,e.m07*=t,e.m08*=t,e.m09*=t,e.m10*=t,e.m11*=t,e.m12*=t,e.m13*=t,e.m14*=t,e.m15*=t,e}translate(t){return this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this}transform(t){const{x:e,y:i,z:s}=t,r=this,n=r.m00,o=r.m01,a=r.m02,h=r.m03,l=r.m04,c=r.m05,u=r.m06,d=r.m07,p=r.m08,_=r.m09,g=r.m10,f=r.m11;return r.m12=n*e+l*i+p*s+r.m12,r.m13=o*e+c*i+_*s+r.m13,r.m14=a*e+u*i+g*s+r.m14,r.m15=h*e+d*i+f*s+r.m15,r}scale(t){const{x:e,y:i,z:s}=t,r=this;return r.m00*=e,r.m01*=e,r.m02*=e,r.m03*=e,r.m04*=i,r.m05*=i,r.m06*=i,r.m07*=i,r.m08*=s,r.m09*=s,r.m10*=s,r.m11*=s,r}rotate(t,e){let i=e.x,s=e.y,r=e.z,n=As(i*i+s*s+r*r);if(Es(n)<pi)return null;n=1/n,i*=n,s*=n,r*=n;const o=Ms(t),a=Ps(t),h=1-a,l=this,c=l.m00,u=l.m01,d=l.m02,p=l.m03,_=l.m04,g=l.m05,f=l.m06,m=l.m07,y=l.m08,v=l.m09,b=l.m10,w=l.m11,S=i*i*h+a,x=s*i*h+r*o,T=r*i*h-s*o,C=i*s*h-r*o,I=s*s*h+a,E=r*s*h+i*o,D=i*r*h+s*o,A=s*r*h-i*o,M=r*r*h+a;return l.m00=c*S+_*x+y*T,l.m01=u*S+g*x+v*T,l.m02=d*S+f*x+b*T,l.m03=p*S+m*x+w*T,l.m04=c*C+_*I+y*E,l.m05=u*C+g*I+v*E,l.m06=d*C+f*I+b*E,l.m07=p*C+m*I+w*E,l.m08=c*D+_*A+y*M,l.m09=u*D+g*A+v*M,l.m10=d*D+f*A+b*M,l.m11=p*D+m*A+w*M,l}getTranslation(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t}getScale(t){const e=this,i=Ls.m00=e.m00,s=Ls.m01=e.m01,r=Ls.m02=e.m02,n=Ls.m03=e.m04,o=Ls.m04=e.m05,a=Ls.m05=e.m06,h=Ls.m06=e.m08,l=Ls.m07=e.m09,c=Ls.m08=e.m10;return t.x=As(i*i+s*s+r*r),t.y=As(n*n+o*o+a*a),t.z=As(h*h+l*l+c*c),ss.determinant(Ls)<0&&(t.x*=-1),t}getRotation(t){const e=this,i=Ki.set(Os,e.m00,e.m01,e.m02).length(),s=Ki.set(Os,e.m04,e.m05,e.m06).length(),r=Ki.set(Os,e.m08,e.m09,e.m10).length();return Ls.m00=e.m00/i,Ls.m01=e.m01/i,Ls.m02=e.m02/i,Ls.m03=e.m04/s,Ls.m04=e.m05/s,Ls.m05=e.m06/s,Ls.m06=e.m08/r,Ls.m07=e.m09/r,Ls.m08=e.m10/r,ss.determinant(Ls)<0&&(Ls.m00*=-1,Ls.m01*=-1,Ls.m02*=-1),ys.fromMat3(t,Ls)}fromRTS(t,e,i){return Rs.fromSRT(this,t,e,i)}fromSRT(t,e,i){return Rs.fromSRT(this,t,e,i)}fromQuat(t){return Rs.fromQuat(this,t)}}t("Mat4",Rs),Cs=Rs,Rs.IDENTITY=Object.freeze(new Cs);const Os=new Ki,Ls=new ss;function Fs(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_,g){return new Rs(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_,g)}var zs;ri.fastDefine("cc.Mat4",Rs,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),l.Mat4=Rs,l.mat4=Fs;const ks=Math.abs,Ns=Math.max,Us=Math.min,Vs=Math.PI,Hs=Math.acos,Gs=Math.sin,Ws=Math.cos,js=Math.sqrt,$s=Math.atan2,qs=Math.ceil,Xs=Math.floor,Ys=Math.round;class Qs extends re{static clone(t){return new Qs(t.x,t.y)}static copy(t,e){return t.x=e.x,t.y=e.y,t}static set(t,e,i){return t.x=e,t.y=i,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t}static ceil(t,e){return t.x=qs(e.x),t.y=qs(e.y),t}static floor(t,e){return t.x=Xs(e.x),t.y=Xs(e.y),t}static min(t,e,i){return t.x=Us(e.x,i.x),t.y=Us(e.y,i.y),t}static max(t,e,i){return t.x=Ns(e.x,i.x),t.y=Ns(e.y,i.y),t}static round(t,e){return t.x=Ys(e.x),t.y=Ys(e.y),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t}static scaleAndAdd(t,e,i,s){return t.x=e.x+i.x*s,t.y=e.y+i.y*s,t}static distance(t,e){const i=e.x-t.x,s=e.y-t.y;return js(i*i+s*s)}static squaredDistance(t,e){const i=e.x-t.x,s=e.y-t.y;return i*i+s*s}static len(t){const e=t.x,i=t.y;return js(e*e+i*i)}static lengthSqr(t){const e=t.x,i=t.y;return e*e+i*i}static negate(t,e){return t.x=-e.x,t.y=-e.y,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t}static inverseSafe(t,e){const i=e.x,s=e.y;return ks(i)<pi?t.x=0:t.x=1/i,ks(s)<pi?t.y=0:t.y=1/s,t}static normalize(t,e){const i=e.x,s=e.y;let r=i*i+s*s;return r>0?(r=1/js(r),t.x=i*r,t.y=s*r):(t.x=0,t.y=0),t}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e,i){return t instanceof Ki?(t.x=t.y=0,t.z=e.x*i.y-e.y*i.x,t):t.x*e.y-t.y*e.x}static lerp(t,e,i,s){const r=e.x,n=e.y;return t.x=r+s*(i.x-r),t.y=n+s*(i.y-n),t}static random(t,e){e=e||1;const i=2*wi()*Vs;return t.x=Ws(i)*e,t.y=Gs(i)*e,t}static transformMat3(t,e,i){const s=e.x,r=e.y;return t.x=i.m00*s+i.m03*r+i.m06,t.y=i.m01*s+i.m04*r+i.m07,t}static transformMat4(t,e,i){const s=e.x,r=e.y;return t.x=i.m00*s+i.m04*r+i.m12,t.y=i.m01*s+i.m05*r+i.m13,t}static str(t){return`Vec2(${t.x}, ${t.y})`}static toArray(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t}static fromArray(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y}static equals(t,e,i){return void 0===i&&(i=pi),ks(t.x-e.x)<=i*Ns(1,ks(t.x),ks(e.x))&&ks(t.y-e.y)<=i*Ns(1,ks(t.y),ks(e.y))}static angle(t,e){const i=t.x*t.x+t.y*t.y,s=e.x*e.x+e.y*e.y;if(0===i||0===s)return 0;let r=(t.x*e.x+t.y*e.y)/js(i*s);return r=fi(r,-1,1),Hs(r)}constructor(t,e){super(),"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0)}clone(){return new Qs(this.x,this.y)}set(t,e){return"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this}equals(t,e){return void 0===e&&(e=pi),Qs.equals(this,t,e)}equals2f(t,e,i){return void 0===i&&(i=pi),ks(this.x-t)<=i*Ns(1,ks(this.x),ks(t))&&ks(this.y-e)<=i*Ns(1,ks(this.y),ks(e))}strictEquals(t){return t&&this.x===t.x&&this.y===t.y}strictEquals2f(t,e){return this.x===t&&this.y===e}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}lerp(t,e){const i=this.x,s=this.y;return this.x=i+e*(t.x-i),this.y=s+e*(t.y-s),this}clampf(t,e){return this.x=fi(this.x,t.x,e.x),this.y=fi(this.y,t.y,e.y),this}add(t){return this.x+=t.x,this.y+=t.y,this}add2f(t,e){return this.x+=t,this.y+=e,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}subtract2f(t,e){return this.x-=t,this.y-=e,this}multiplyScalar(t){return"object"==typeof t&&G(16359),this.x*=t,this.y*=t,this}multiply(t){return"object"!=typeof t&&G(16360),this.x*=t.x,this.y*=t.y,this}multiply2f(t,e){return this.x*=t,this.y*=e,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divide2f(t,e){return this.x/=t,this.y/=e,this}negative(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}length(){return js(this.x*this.x+this.y*this.y)}lengthSqr(){return this.x*this.x+this.y*this.y}normalize(){const t=this,e=t.x,i=t.y;let s=e*e+i*i;return s>0&&(s=1/js(s),t.x*=s,t.y*=s),t}angle(t){const e=this.lengthSqr(),i=t.lengthSqr();if(0===e||0===i)return 0;let s=this.dot(t)/js(e*i);return s=fi(s,-1,1),Hs(s)}signAngle(t){const e=this.cross(t),i=this.dot(t);return $s(e,i)}rotate(t){const e=this.x,i=this.y,s=Gs(t),r=Ws(t);return this.x=r*e-s*i,this.y=s*e+r*i,this}project(t){const e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this}transformMat4(t){const e=this.x,i=this.y;return this.x=t.m00*e+t.m04*i+t.m12,this.y=t.m01*e+t.m05*i+t.m13,this}toVec3(){return new Ki(this.x,this.y,0)}}function Ks(t,e){return new Qs(t,e)}var Zs;t("Vec2",Qs),zs=Qs,Qs.ZERO=Object.freeze(new zs(0,0)),Qs.ONE=Object.freeze(new zs(1,1)),Qs.NEG_ONE=Object.freeze(new zs(-1,-1)),Qs.UNIT_X=Object.freeze(new zs(1,0)),Qs.UNIT_Y=Object.freeze(new zs(0,1)),ri.fastDefine("cc.Vec2",Qs,{x:0,y:0}),l.Vec2=Qs,l.v2=Ks;const Js=Math.abs,tr=Math.max,er=Math.min,ir=Math.PI,sr=Math.sin,rr=Math.cos,nr=Math.atan2,or=Math.sqrt,ar=Math.ceil,hr=Math.floor,lr=Math.round;class cr extends re{static clone(t){return new cr(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,i,s,r){return t.x=e,t.y=i,t.z=s,t.w=r,t}static fromColor(t,e){return t.x=e.r,t.y=e.g,t.z=e.b,t.w=e.a,t}static angle(t,e){const i=t.y*e.z-t.z*e.y,s=t.z*e.x-t.x*e.z,r=t.x*e.y-t.y*e.x,n=t.x*e.x+t.y*e.y+t.z*e.z;return nr(or(i*i+s*s+r*r),n)}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t.w=e.w+i.w,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t.w=e.w-i.w,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t.w=e.w*i.w,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t.w=e.w/i.w,t}static ceil(t,e){return t.x=ar(e.x),t.y=ar(e.y),t.z=ar(e.z),t.w=ar(e.w),t}static floor(t,e){return t.x=hr(e.x),t.y=hr(e.y),t.z=hr(e.z),t.w=hr(e.w),t}static min(t,e,i){return t.x=er(e.x,i.x),t.y=er(e.y,i.y),t.z=er(e.z,i.z),t.w=er(e.w,i.w),t}static max(t,e,i){return t.x=tr(e.x,i.x),t.y=tr(e.y,i.y),t.z=tr(e.z,i.z),t.w=tr(e.w,i.w),t}static round(t,e){return t.x=lr(e.x),t.y=lr(e.y),t.z=lr(e.z),t.w=lr(e.w),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t}static scaleAndAdd(t,e,i,s){return t.x=e.x+i.x*s,t.y=e.y+i.y*s,t.z=e.z+i.z*s,t.w=e.w+i.w*s,t}static distance(t,e){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z,n=e.w-t.w;return or(i*i+s*s+r*r+n*n)}static squaredDistance(t,e){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z,n=e.w-t.w;return i*i+s*s+r*r+n*n}static len(t){const e=t.x,i=t.y,s=t.z,r=t.w;return or(e*e+i*i+s*s+r*r)}static lengthSqr(t){const e=t.x,i=t.y,s=t.z,r=t.w;return e*e+i*i+s*s+r*r}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t}static inverseSafe(t,e){const i=e.x,s=e.y,r=e.z,n=e.w;return Js(i)<pi?t.x=0:t.x=1/i,Js(s)<pi?t.y=0:t.y=1/s,Js(r)<pi?t.z=0:t.z=1/r,Js(n)<pi?t.w=0:t.w=1/n,t}static normalize(t,e){const i=e.x,s=e.y,r=e.z,n=e.w;let o=i*i+s*s+r*r+n*n;return o>0?(o=1/or(o),t.x=i*o,t.y=s*o,t.z=r*o,t.w=n*o):(t.x=0,t.y=0,t.z=0,t.w=0),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,i,s){return t.x=e.x+s*(i.x-e.x),t.y=e.y+s*(i.y-e.y),t.z=e.z+s*(i.z-e.z),t.w=e.w+s*(i.w-e.w),t}static scale(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t}static random(t,e){e=e||1;const i=2*wi()*ir,s=2*wi()-1,r=or(1-s*s);return t.x=r*rr(i)*e,t.y=r*sr(i)*e,t.z=s*e,t.w=0,t}static transformMat4(t,e,i){const s=e.x,r=e.y,n=e.z,o=e.w;return t.x=i.m00*s+i.m04*r+i.m08*n+i.m12*o,t.y=i.m01*s+i.m05*r+i.m09*n+i.m13*o,t.z=i.m02*s+i.m06*r+i.m10*n+i.m14*o,t.w=i.m03*s+i.m07*r+i.m11*n+i.m15*o,t}static transformAffine(t,e,i){const s=e.x,r=e.y,n=e.z,o=e.w;return t.x=i.m00*s+i.m04*r+i.m08*n+i.m12*o,t.y=i.m01*s+i.m05*r+i.m09*n+i.m13*o,t.z=i.m02*s+i.m06*r+i.m10*n+i.m14*o,t.w=e.w,t}static transformQuat(t,e,i){const{x:s,y:r,z:n}=e,o=i.x,a=i.y,h=i.z,l=i.w,c=l*s+a*n-h*r,u=l*r+h*s-o*n,d=l*n+o*r-a*s,p=-o*s-a*r-h*n;return t.x=c*l+p*-o+u*-h-d*-a,t.y=u*l+p*-a+d*-o-c*-h,t.z=d*l+p*-h+c*-a-u*-o,t.w=e.w,t}static toArray(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t}static fromArray(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,i){void 0===i&&(i=pi);const s=1/0;return!(Js(t.x)===s||Js(t.y)===s||Js(t.z)===s||Js(t.w)===s||Js(e.x)===s||Js(e.y)===s||Js(e.z)===s||Js(e.w)===s)&&Js(t.x-e.x)<=i*tr(1,Js(t.x),Js(e.x))&&Js(t.y-e.y)<=i*tr(1,Js(t.y),Js(e.y))&&Js(t.z-e.z)<=i*tr(1,Js(t.z),Js(e.z))&&Js(t.w-e.w)<=i*tr(1,Js(t.w),Js(e.w))}constructor(t,e,i,s){super(),"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=s||0)}clone(){return new cr(this.x,this.y,this.z,this.w)}set(t,e,i,s){return"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=s||0),this}equals(t,e){void 0===e&&(e=pi);const i=this;return Js(i.x-t.x)<=e*tr(1,Js(i.x),Js(t.x))&&Js(i.y-t.y)<=e*tr(1,Js(i.y),Js(t.y))&&Js(i.z-t.z)<=e*tr(1,Js(i.z),Js(t.z))&&Js(i.w-t.w)<=e*tr(1,Js(i.w),Js(t.w))}equals4f(t,e,i,s,r){void 0===r&&(r=pi);const n=this;return Js(n.x-t)<=r*tr(1,Js(n.x),Js(t))&&Js(n.y-e)<=r*tr(1,Js(n.y),Js(e))&&Js(n.z-i)<=r*tr(1,Js(n.z),Js(i))&&Js(n.w-s)<=r*tr(1,Js(n.w),Js(s))}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}strictEquals4f(t,e,i,s){return this.x===t&&this.y===e&&this.z===i&&this.w===s}lerp(t,e){const i=this,s=i.x,r=i.y,n=i.z,o=i.w;return i.x=s+e*(t.x-s),i.y=r+e*(t.y-r),i.z=n+e*(t.z-n),i.w=o+e*(t.w-o),i}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)}, ${this.w.toFixed(2)})`}clampf(t,e){const i=this;return i.x=fi(i.x,t.x,e.x),i.y=fi(i.y,t.y,e.y),i.z=fi(i.z,t.z,e.z),i.w=fi(i.w,t.w,e.w),i}add(t){const e=this;return e.x+=t.x,e.y+=t.y,e.z+=t.z,e.w+=t.w,e}add4f(t,e,i,s){const r=this;return r.x+=t,r.y+=e,r.z+=i,r.w+=s,r}subtract(t){const e=this;return e.x-=t.x,e.y-=t.y,e.z-=t.z,e.w-=t.w,e}subtract4f(t,e,i,s){const r=this;return r.x-=t,r.y-=e,r.z-=i,r.w-=s,r}multiplyScalar(t){const e=this;return e.x*=t,e.y*=t,e.z*=t,e.w*=t,e}multiply(t){const e=this;return e.x*=t.x,e.y*=t.y,e.z*=t.z,e.w*=t.w,e}multiply4f(t,e,i,s){const r=this;return r.x*=t,r.y*=e,r.z*=i,r.w*=s,r}divide(t){const e=this;return e.x/=t.x,e.y/=t.y,e.z/=t.z,e.w/=t.w,e}divide4f(t,e,i,s){const r=this;return r.x/=t,r.y/=e,r.z/=i,r.w/=s,r}negative(){const t=this;return t.x=-t.x,t.y=-t.y,t.z=-t.z,t.w=-t.w,t}dot(t){const e=this;return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}cross(t){const e=this,{x:i,y:s,z:r}=e,{x:n,y:o,z:a}=t;return e.x=s*a-r*o,e.y=r*n-i*a,e.z=i*o-s*n,e}length(){const t=this,e=t.x,i=t.y,s=t.z,r=t.w;return or(e*e+i*i+s*s+r*r)}lengthSqr(){const t=this,e=t.x,i=t.y,s=t.z,r=t.w;return e*e+i*i+s*s+r*r}normalize(){const t=this,e=t.x,i=t.y,s=t.z,r=t.w;let n=e*e+i*i+s*s+r*r;return n>0&&(n=1/or(n),t.x=e*n,t.y=i*n,t.z=s*n,t.w=r*n),t}scale(t){const e=this;return e.x*=t,e.y*=t,e.z*=t,e.w*=t,e}transformMat4(t){const e=this,i=e.x,s=e.y,r=e.z,n=e.w;return e.x=t.m00*i+t.m04*s+t.m08*r+t.m12*n,e.y=t.m01*i+t.m05*s+t.m09*r+t.m13*n,e.z=t.m02*i+t.m06*s+t.m10*r+t.m14*n,e.w=t.m03*i+t.m07*s+t.m11*r+t.m15*n,e}}function ur(t,e,i,s){return new cr(t,e,i,s)}var dr;t("Vec4",cr),Zs=cr,cr.ZERO=Object.freeze(new Zs(0,0,0,0)),cr.ONE=Object.freeze(new Zs(1,1,1,1)),cr.NEG_ONE=Object.freeze(new Zs(-1,-1,-1,-1)),cr.UNIT_X=Object.freeze(new Zs(1,0,0,0)),cr.UNIT_Y=Object.freeze(new Zs(0,1,0,0)),cr.UNIT_Z=Object.freeze(new Zs(0,0,1,0)),cr.UNIT_W=Object.freeze(new Zs(0,0,0,1)),ri.fastDefine("cc.Vec4",cr,{x:0,y:0,z:0,w:0}),l.Vec4=cr,l.v4=ur;const pr=1/255;let _r=class t extends re{static clone(e){const i=new t;return i.r=e.r,i.g=e.g,i.b=e.b,i.a=e.a,i}static copy(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t}static set(t,e,i,s,r){return t.r=e,t.g=i,t.b=s,t.a=r,t}static toVec4(t,e){return(e=void 0!==e?e:new cr).x=t._data[0]*pr,e.y=t._data[1]*pr,e.z=t._data[2]*pr,e.w=t._data[3]*pr,e}static fromVec4(e,i){return(i=void 0===i?new t:i)._data[0]=e.x/pr,i._data[1]=e.y/pr,i._data[2]=e.z/pr,i._data[3]=e.w/pr,i}static fromHEX(t,e){let i;return"string"==typeof e?(6===(e="#"===e[0]?e.substring(1):e).length?e+="FF":3===e.length?e=`${e[0]+e[0]+e[1]+e[1]+e[2]+e[2]}FF`:4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),i=Number(`0x${e}`)):(e<16777216&&(e=255+(e<<8)),i=e),t.r=i>>>24,t.g=(16711680&i)>>>16,t.b=(65280&i)>>>8,t.a=255&i,t}static add(t,e,i){return t.r=e.r+i.r,t.g=e.g+i.g,t.b=e.b+i.b,t.a=e.a+i.a,t}static subtract(t,e,i){return t.r=e.r-i.r,t.g=e.g-i.g,t.b=e.b-i.b,t.a=e.a-i.a,t}static multiply(t,e,i){return t.r=e.r*i.r,t.g=e.g*i.g,t.b=e.b*i.b,t.a=e.a*i.a,t}static divide(t,e,i){return t.r=e.r/i.r,t.g=e.g/i.g,t.b=e.b/i.b,t.a=e.a/i.a,t}static scale(t,e,i){return t.r=e.r*i,t.g=e.g*i,t.b=e.b*i,t.a=e.a*i,t}static lerp(t,e,i,s){const r=e.r,n=e.g,o=e.b,a=e.a;return t.r=r+(i.r-r)*s,t.g=n+(i.g-n)*s,t.b=o+(i.b-o)*s,t.a=a+(i.a-a)*s,t}static toArray(e,i,s){void 0===s&&(s=0);const r=i instanceof t||i.a>1?1/255:1;return e[s+0]=i.r*r,e[s+1]=i.g*r,e[s+2]=i.b*r,e[s+3]=i.a*r,e}static fromArray(t,e,i){return void 0===i&&(i=0),e.r=255*t[i+0],e.g=255*t[i+1],e.b=255*t[i+2],e.a=255*t[i+3],e}static fromUint32(t,e){return e>>>=0,t.r=255&e,t.g=e>>8&255,t.b=e>>16&255,t.a=e>>24&255,t}static toUint32(t){return(t.a<<24|t.b<<16|t.g<<8|t.r)>>>0}static strictEquals(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a}static equals(t,e,i){return void 0===i&&(i=pi),!(Math.abs(t.r)===1/0||Math.abs(t.g)===1/0||Math.abs(t.b)===1/0||Math.abs(t.a)===1/0)&&Math.abs(t.r-e.r)<=i*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=i*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=i*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=i*Math.max(1,Math.abs(t.a),Math.abs(e.a))}static hex(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0}get r(){return this._data[0]}set r(t){this._data[0]=t}get g(){return this._data[1]}set g(t){this._data[1]=t}get b(){return this._data[2]}set b(t){this._data[2]=t}get a(){return this._data[3]}set a(t){this._data[3]=t}get x(){return this._data[0]*pr}set x(t){this._data[0]=255*t}get y(){return this._data[1]*pr}set y(t){this._data[1]=255*t}get z(){return this._data[2]*pr}set z(t){this._data[2]=255*t}get w(){return this._data[3]*pr}set w(t){this._data[3]=255*t}constructor(t,e,i,s){super(),this._data=new Uint8ClampedArray(4),"string"==typeof t?this.fromHEX(t):void 0!==e?this.set(t,e,i,s):this.set(t)}clone(){const e=new t;return e._data.set(this._data),e}equals(t){const e=t;return t&&this._data[0]===e.r&&this._data[1]===e.g&&this._data[2]===e.b&&this._data[3]===e.a}lerp(e,i){return t.lerp(this,this,e,i),this}toString(){return`rgba(${this.r.toFixed()}, ${this.g.toFixed()}, ${this.b.toFixed()}, ${this.a.toFixed()})`}toCSS(t){return void 0===t&&(t="rgba"),"rgba"===t?`rgba(${this.r},${this.g},${this.b},${(this.a*pr).toFixed(2)})`:"rgb"===t?`rgb(${this.r},${this.g},${this.b})`:`#${this.toHEX(t)}`}fromHEX(t){let e;return"string"==typeof t?(6===(t="#"===t[0]?t.substring(1):t).length?t+="FF":3===t.length?t=`${t[0]+t[0]+t[1]+t[1]+t[2]+t[2]}FF`:4===t.length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]),e=Number(`0x${t}`)):(t<16777216&&(t=255+(t<<8)),e=t),this.r=e>>>24,this.g=(16711680&e)>>>16,this.b=(65280&e)>>>8,this.a=255&e,this}toHEX(t){void 0===t&&(t="#rrggbb");const e="0",i=[(this._data[0]<16?e:"")+this._data[0].toString(16),(this._data[1]<16?e:"")+this._data[1].toString(16),(this._data[2]<16?e:"")+this._data[2].toString(16)];return"#rgb"===t?(i[0]=i[0][0],i[1]=i[1][0],i[2]=i[2][0]):"#rrggbbaa"===t&&i.push((this._data[3]<16?e:"")+this._data[3].toString(16)),i.join("")}toRGBValue(){return this._data[2]<<16|this._data[1]<<8|this._data[0]}fromHSV(t,e,i){let s=0,r=0,n=0;if(0===e)s=r=n=i;else if(0===i)s=r=n=0;else{1===t&&(t=0),t*=6;const o=Math.floor(t),a=t-o,h=i*(1-e),l=i*(1-e*a),c=i*(1-e*(1-a));switch(o){default:case 0:s=i,r=c,n=h;break;case 1:s=l,r=i,n=h;break;case 2:s=h,r=i,n=c;break;case 3:s=h,r=l,n=i;break;case 4:s=c,r=h,n=i;break;case 5:s=i,r=h,n=l}}return this._data[0]=255*s,this._data[1]=255*r,this._data[2]=255*n,this}toHSV(){const t=this._data[0]*pr,e=this._data[1]*pr,i=this._data[2]*pr,s={h:0,s:0,v:0},r=Math.max(t,e,i),n=Math.min(t,e,i);let o=0;return s.v=r,s.s=r?(r-n)/r:0,s.s?(o=r-n,s.h=t===r?(e-i)/o:e===r?2+(i-t)/o:4+(t-e)/o,s.h/=6,s.h<0&&(s.h+=1)):s.h=0,s}set(t,e,i,s){if("object"==typeof t){const e=t;var r,n,o,a;e._data?this._data.set(e._data):(this._data[0]=null!==(r=e.r)&&void 0!==r?r:0,this._data[1]=null!==(n=e.g)&&void 0!==n?n:0,this._data[2]=null!==(o=e.b)&&void 0!==o?o:0,this._data[3]=null!==(a=e.a)&&void 0!==a?a:255)}else this._data[0]=null!=t?t:0,this._data[1]=null!=e?e:0,this._data[2]=null!=i?i:0,this._data[3]=null!=s?s:255;return this}multiply(t){return this._data[0]*=t.r/255,this._data[1]*=t.g/255,this._data[2]*=t.b/255,this._data[3]*=t.a/255,this}getModifiableProperties(){return["r","g","b","a"]}};function gr(t,e,i,s){return new _r(t,e,i,s)}function fr(t,e,i){if(e>i){const t=e;e=i,i=t}return t<e?e:t>i?i:t}function mr(t){const e=t.clone();return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}t("Color",_r),dr=_r,_r.WHITE=Object.freeze(new dr(255,255,255,255)),_r.GRAY=Object.freeze(new dr(127,127,127,255)),_r.BLACK=Object.freeze(new dr(0,0,0,255)),_r.TRANSPARENT=Object.freeze(new dr(0,0,0,0)),_r.RED=Object.freeze(new dr(255,0,0,255)),_r.GREEN=Object.freeze(new dr(0,255,0,255)),_r.BLUE=Object.freeze(new dr(0,0,255,255)),_r.CYAN=Object.freeze(new dr(0,255,255,255)),_r.MAGENTA=Object.freeze(new dr(255,0,255,255)),_r.YELLOW=Object.freeze(new dr(255,255,0,255)),ri.fastDefine("cc.Color",_r,{r:0,g:0,b:0,a:255}),l.Color=_r,l.color=gr;class yr{static identity(){return new yr}static clone(t){return new yr(t.a,t.b,t.c,t.d,t.tx,t.ty)}static concat(t,e,i){const s=e.a,r=e.b,n=e.c,o=e.d,a=e.tx,h=e.ty;t.a=s*i.a+r*i.c,t.b=s*i.b+r*i.d,t.c=n*i.a+o*i.c,t.d=n*i.b+o*i.d,t.tx=a*i.a+h*i.c+i.tx,t.ty=a*i.b+h*i.d+i.ty}static invert(t,e){const i=1/(e.a*e.d-e.b*e.c);t.a=i*e.d,t.b=-i*e.b,t.c=-i*e.c,t.d=i*e.a,t.tx=i*(e.c*e.ty-e.d*e.tx),t.ty=i*(e.b*e.tx-e.a*e.ty)}static fromMat4(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13}static transformVec2(t,e,i,s){let r,n;s?(r=e,n=i):(s=i,r=e.x,n=e.y),t.x=s.a*r+s.c*n+s.tx,t.y=s.b*r+s.d*n+s.ty}static transformSize(t,e,i){t.width=i.a*e.width+i.c*e.height,t.height=i.b*e.width+i.d*e.height}static transformRect(t,e,i){const s=e.x+e.width,r=e.y+e.height,n=i.a*e.x+i.c*e.y+i.tx,o=i.b*e.x+i.d*e.y+i.ty,a=i.a*s+i.c*e.y+i.tx,h=i.b*s+i.d*e.y+i.ty,l=i.a*e.x+i.c*r+i.tx,c=i.b*e.x+i.d*r+i.ty,u=i.a*s+i.c*r+i.tx,d=i.b*s+i.d*r+i.ty,p=Math.min(n,a,l,u),_=Math.max(n,a,l,u),g=Math.min(o,h,c,d),f=Math.max(o,h,c,d);t.x=p,t.y=g,t.width=_-p,t.height=f-g}static transformObb(t,e,i,s,r,n,o){void 0===o&&(o=!0);const a=n.a*r.x+n.c*r.y+n.tx,h=n.b*r.x+n.d*r.y+n.ty,l=n.a*r.width,c=n.b*r.width,u=n.c*r.height,d=n.d*r.height;o?(e.x=a,e.y=h,i.x=l+a,i.y=c+h,t.x=u+a,t.y=d+h,s.x=l+u+a,s.y=c+d+h):(t.x=a,t.y=h,s.x=l+a,s.y=c+h,e.x=u+a,e.y=d+h,i.x=l+u+a,i.y=c+d+h)}constructor(t,e,i,s,r,n){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=1),void 0===r&&(r=0),void 0===n&&(n=0),this.a=t,this.b=e,this.c=i,this.d=s,this.tx=r,this.ty=n}}var vr;t("AffineTransform",yr),l.AffineTransform=yr;let br=class t extends re{static lerp(t,e,i,s){return t.width=e.width+(i.width-e.width)*s,t.height=e.height+(i.height-e.height)*s,t}static equals(t,e){return t.width===e.width&&t.height===e.height}set x(t){this.width=t}get x(){return this.width}set y(t){this.height=t}get y(){return this.height}constructor(t,e){super(),"object"==typeof t?(this.width=t.width,this.height=t.height):(this.width=t||0,this.height=e||0)}clone(){return new t(this.width,this.height)}set(t,e){return"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this}equals(t){return this.width===t.width&&this.height===t.height}lerp(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this}toString(){return`(${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}};function wr(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new br(t,e)}t("Size",br),vr=br,br.ZERO=Object.freeze(new vr(0,0)),br.ONE=Object.freeze(new vr(1,1)),ri.fastDefine("cc.Size",br,{width:0,height:0}),l.size=wr,l.Size=br;const Sr=Math.max,Tr=Math.min;let Cr=class t extends re{static fromMinMax(t,e,i){const s=Tr(e.x,i.x),r=Tr(e.y,i.y),n=Sr(e.x,i.x),o=Sr(e.y,i.y);return t.x=s,t.y=r,t.width=n-s,t.height=o-r,t}static lerp(t,e,i,s){const r=e.x,n=e.y,o=e.width,a=e.height;return t.x=r+(i.x-r)*s,t.y=n+(i.y-n)*s,t.width=o+(i.width-o)*s,t.height=a+(i.height-a)*s,t}static intersection(t,e,i){const s=e.x,r=e.y,n=e.x+e.width,o=e.y+e.height,a=i.x,h=i.y,l=i.x+i.width,c=i.y+i.height;return t.x=Sr(s,a),t.y=Sr(r,h),t.width=Tr(n,l)-t.x,t.height=Tr(o,c)-t.y,t}static union(t,e,i){const s=e.x,r=e.y,n=e.width,o=e.height,a=i.x,h=i.y,l=i.width,c=i.height;return t.x=Tr(s,a),t.y=Tr(r,h),t.width=Sr(s+n,a+l)-t.x,t.height=Sr(r+o,h+c)-t.y,t}static equals(t,e){return t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height}get xMin(){return this.x}set xMin(t){this.width+=this.x-t,this.x=t}get yMin(){return this.y}set yMin(t){this.height+=this.y-t,this.y=t}get xMax(){return this.x+this.width}set xMax(t){this.width=t-this.x}get yMax(){return this.y+this.height}set yMax(t){this.height=t-this.y}get center(){return new Qs(this.x+.5*this.width,this.y+.5*this.height)}set center(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}get origin(){return new Qs(this.x,this.y)}set origin(t){this.x=t.x,this.y=t.y}get size(){return new br(this.width,this.height)}set size(t){this.width=t.width,this.height=t.height}set z(t){this.width=t}get z(){return this.width}set w(t){this.height=t}get w(){return this.height}constructor(t,e,i,s){super(),"object"==typeof t?(this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=s||0)}clone(){return new t(this.x,this.y,this.width,this.height)}set(t,e,i,s){const r=this;return"object"==typeof t?(r.x=t.x,r.y=t.y,r.width=t.width,r.height=t.height):(r.x=t||0,r.y=e||0,r.width=i||0,r.height=s||0),r}equals(t){const e=this;return e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height}lerp(t,e){const i=this,s=i.x,r=i.y,n=i.width,o=i.height;return i.x=s+(t.x-s)*e,i.y=r+(t.y-r)*e,i.width=n+(t.width-n)*e,i.height=o+(t.height-o)*e,i}toString(){const t=this;return`(${t.x.toFixed(2)}, ${t.y.toFixed(2)}, ${t.width.toFixed(2)}, ${t.height.toFixed(2)})`}intersects(t){const e=this,i=e.x+e.width,s=e.y+e.height,r=t.x+t.width,n=t.y+t.height;return!(i<t.x||r<e.x||s<t.y||n<e.y)}contains(t){const e=this;return e.x<=t.x&&e.x+e.width>=t.x&&e.y<=t.y&&e.y+e.height>=t.y}containsRect(t){const e=this;return e.x<=t.x&&e.x+e.width>=t.x+t.width&&e.y<=t.y&&e.y+e.height>=t.y+t.height}transformMat4(t){const e=this,i=e.x,s=e.y,r=i+e.width,n=s+e.height,o=t.m00*i+t.m04*s+t.m12,a=t.m01*i+t.m05*s+t.m13,h=t.m00*r+t.m04*s+t.m12,l=t.m01*r+t.m05*s+t.m13,c=t.m00*i+t.m04*n+t.m12,u=t.m01*i+t.m05*n+t.m13,d=t.m00*r+t.m04*n+t.m12,p=t.m01*r+t.m05*n+t.m13,_=Tr(o,h,c,d),g=Sr(o,h,c,d),f=Tr(a,l,u,p),m=Sr(a,l,u,p);return e.x=_,e.y=f,e.width=g-_,e.height=m-f,e}transformMat4ToPoints(t,e,i,s,r){const n=this,o=n.x,a=n.y,h=o+n.width,l=a+n.height;e.x=t.m00*o+t.m04*a+t.m12,e.y=t.m01*o+t.m05*a+t.m13,r.x=t.m00*h+t.m04*a+t.m12,r.y=t.m01*h+t.m05*a+t.m13,i.x=t.m00*o+t.m04*l+t.m12,i.y=t.m01*o+t.m05*l+t.m13,s.x=t.m00*h+t.m04*l+t.m12,s.y=t.m01*h+t.m05*l+t.m13}};function Ir(t,e,i,s){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),new Cr(t,e,i,s)}t("Rect",Cr),ri.fastDefine("cc.Rect",Cr,{x:0,y:0,width:0,height:0}),l.Rect=Cr,l.rect=Ir;const Er=t("MATH_FLOAT_ARRAY",Float64Array);class Dr extends re{static createFloatArray(t){return new Er(t)}get array(){return this._array}}t("MathBase",Dr);var Ar=Object.freeze({__proto__:null,AffineTransform:yr,Color:_r,EPSILON:pi,HALF_PI:ui,MATH_FLOAT_ARRAY:Er,Mat3:ss,Mat4:Rs,MathBase:Dr,Quat:ys,Rect:Cr,Size:br,TWO_PI:di,Vec2:Qs,Vec3:Ki,Vec4:cr,absMax:Ri,absMaxComponent:Bi,approx:gi,bits:b,clamp:fi,clamp01:mi,color:gr,enumerableProps:Oi,equals:_i,floatToHalf:zi,halfToFloat:ki,inverseLerp:Pi,lerp:yi,mat4:Fs,nextPow2:Di,pingPong:Mi,preTransforms:Is,pseudoRandom:Ci,pseudoRandomRange:Ii,pseudoRandomRangeInt:Ei,quat:Ts,random:wi,randomRange:xi,randomRangeInt:Ti,rect:Ir,repeat:Ai,setRandGenerator:Si,size:wr,toDegree:bi,toRadian:vi,v2:Ks,v3:Zi,v4:ur});t("math",Ar);const Mr=new Ki,Pr=new Ki,Br=new Ki,Rr=new Ki,Or=new Ki,Lr=new Ki,Fr=new Array(3),zr=new Array(3);function kr(t,e){return Ki.dot(e.n,t)-e.d}function Nr(t,e,i){return Ki.copy(t,e),Ki.subtract(Or,i.center,i.halfExtents),Ki.add(Lr,i.center,i.halfExtents),t.x=t.x<Or.x?Or.x:t.x,t.y=t.y<Or.y?Or.y:t.y,t.z=t.z<Or.z?Or.z:t.z,t.x=t.x>Lr.x?Lr.x:t.x,t.y=t.y>Lr.y?Lr.y:t.y,t.z=t.z>Lr.z?Lr.z:t.z,t}function Ur(t,e,i){Ki.set(Mr,i.orientation.m00,i.orientation.m01,i.orientation.m02),Ki.set(Pr,i.orientation.m03,i.orientation.m04,i.orientation.m05),Ki.set(Br,i.orientation.m06,i.orientation.m07,i.orientation.m08),Fr[0]=Mr,Fr[1]=Pr,Fr[2]=Br,zr[0]=i.halfExtents.x,zr[1]=i.halfExtents.y,zr[2]=i.halfExtents.z,Ki.subtract(Rr,e,i.center),Ki.set(t,i.center.x,i.center.y,i.center.z);for(let e=0;e<3;e++){let i=Ki.dot(Rr,Fr[e]);i>zr[e]&&(i=zr[e]),i<-zr[e]&&(i=-zr[e]),t.x+=i*Fr[e].x,t.y+=i*Fr[e].y,t.z+=i*Fr[e].z}return t}var Vr=Object.freeze({__proto__:null,point_plane:kr,pt_point_aabb:Nr,pt_point_line:function(t,e,i,s){Ki.subtract(Mr,i,s);const r=Mr.clone(),n=Ki.lengthSqr(r);if(0===n)Ki.copy(t,i);else{Ki.subtract(Mr,e,i);const o=Ki.dot(Mr,r)/n;o<0?Ki.copy(t,i):o>1?Ki.copy(t,s):Ki.scaleAndAdd(t,i,r,o)}},pt_point_obb:Ur,pt_point_plane:function(t,e,i){const s=kr(e,i);return Ki.subtract(t,e,Ki.multiplyScalar(t,i.n,s))}});const Hr=new Ki(0,0,0),Gr=new Ki(0,0,0),Wr=Fs(),jr=ur();class $r{static create(t,e,i,s){return new $r(t,e,i,s)}static clone(t){return new $r(t.n.x,t.n.y,t.n.z,t.d)}static copy(t,e){return Ki.copy(t.n,e.n),t.d=e.d,t}static fromPoints(t,e,i,s){return Ki.subtract(Hr,i,e),Ki.subtract(Gr,s,e),Ki.normalize(t.n,Ki.cross(t.n,Hr,Gr)),t.d=Ki.dot(t.n,e),t}static set(t,e,i,s,r){return t.n.x=e,t.n.y=i,t.n.z=s,t.d=r,t}static fromNormalAndPoint(t,e,i){return Ki.copy(t.n,e),t.d=Ki.dot(e,i),t}static normalize(t,e){const i=e.n.length();return Ki.normalize(t.n,e.n),i>0&&(t.d=e.d/i),t}get type(){return this._type}set x(t){this.n.x=t}get x(){return this.n.x}set y(t){this.n.y=t}get y(){return this.n.y}set z(t){this.n.z=t}get z(){return this.n.z}set w(t){this.d=t}get w(){return this.d}constructor(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=0),void 0===s&&(s=0),this._type=32,this.n=new Ki(t,e,i),this.d=s}transform(t){Rs.invert(Wr,t),Rs.transpose(Wr,Wr),cr.set(jr,this.n.x,this.n.y,this.n.z,-this.d),cr.transformMat4(jr,jr,Wr),Ki.set(this.n,jr.x,jr.y,jr.z),this.d=-jr.w}}class qr{static create(t,e,i,s,r,n){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=1),new qr(t,e,i,s,r,n)}static clone(t){return new qr(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}static copy(t,e){return Ki.copy(t.o,e.o),Ki.copy(t.d,e.d),t}static fromPoints(t,e,i){return Ki.copy(t.o,e),Ki.normalize(t.d,Ki.subtract(t.d,i,e)),t}static set(t,e,i,s,r,n,o){return t.o.x=e,t.o.y=i,t.o.z=s,t.d.x=r,t.d.y=n,t.d.z=o,t}get type(){return this._type}constructor(t,e,i,s,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=-1),this._type=1,this.o=new Ki(t,e,i),this.d=new Ki(s,r,n)}computeHit(t,e){Ki.normalize(t,this.d),Ki.scaleAndAdd(t,this.o,t,e)}}class Xr{static create(t,e,i,s,r,n,o,a,h){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=1),new Xr(t,e,i,s,r,n,o,a,h)}static clone(t){return new Xr(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}static copy(t,e){return Ki.copy(t.a,e.a),Ki.copy(t.b,e.b),Ki.copy(t.c,e.c),t}static fromPoints(t,e,i,s){return Ki.copy(t.a,e),Ki.copy(t.b,i),Ki.copy(t.c,s),t}static set(t,e,i,s,r,n,o,a,h,l){return t.a.x=e,t.a.y=i,t.a.z=s,t.b.x=r,t.b.y=n,t.b.z=o,t.c.x=a,t.c.y=h,t.c.z=l,t}get type(){return this._type}constructor(t,e,i,s,r,n,o,a,h){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=1),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===h&&(h=0),this._type=64,this.a=new Ki(t,e,i),this.b=new Ki(s,r,n),this.c=new Ki(o,a,h)}}const Yr=new Ki,Qr=new Ki,Kr=new Ki,Zr=new Ki;function Jr(t){return Math.max(Math.max(t.x,t.y),t.z)}class tn{static create(t,e,i,s){return new tn(t,e,i,s)}static clone(t){return new tn(t.center.x,t.center.y,t.center.z,t.radius)}static copy(t,e){return Ki.copy(t.center,e.center),t.radius=e.radius,t}static fromPoints(t,e,i){return Ki.multiplyScalar(t.center,Ki.add(Yr,e,i),.5),t.radius=.5*Ki.subtract(Yr,i,e).length(),t}static set(t,e,i,s,r){return t.center.x=e,t.center.y=i,t.center.z=s,t.radius=r,t}get center(){return this._center}set center(t){this._center=t}get radius(){return this._radius}set radius(t){this._radius=t}get type(){return this._type}constructor(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=1),this._type=4,this._center=new Ki(t,e,i),this._radius=s}destroy(){}clone(){return tn.clone(this)}copy(t){return tn.copy(this,t)}getBoundary(t,e){Ki.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Ki.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}transform(t,e,i,s,r){Ki.transformMat4(r.center,this.center,t),r.radius=this.radius*Jr(s)}translateAndRotate(t,e,i){Ki.transformMat4(i.center,this.center,t)}setScale(t,e){e.radius=this.radius*Jr(t)}mergePoint(t){this.radius<0&&(this.center.set(t),this.radius=0),Ki.subtract(Qr,t,this.center);const e=Qr.length();if(e>this.radius){const t=.5*(e-this.radius);this.radius+=t,Ki.multiplyScalar(Qr,Qr,t/e),Ki.add(this.center,this.center,Qr)}}mergePoints(t){const e=t.length;if(!(e<1)){this.radius=-1;for(let i=0;i<e;i++)this.mergePoint(t[i])}}mergeAABB(t){t.getBoundary(Kr,Zr),this.mergePoint(Kr),this.mergePoint(Zr)}}class en{constructor(){this._poolHandle=-1,sn.addContainer(this)}destroy(){sn.removeContainer(this)}}const sn=new class{constructor(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}addContainer(t){-1===t._poolHandle&&(t._poolHandle=this._pools.length,this._pools.push(t))}removeContainer(t){-1!==t._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=t._poolHandle,Wt(this._pools,t._poolHandle),t._poolHandle=-1)}tryShrink(){for(let t=0;t<this._pools.length;t++)this._pools[t].tryShrink()}update(t){this._lastShrinkPassed+=t,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)}};class rn extends en{constructor(t,e,i,s){super(),this._freePool=[],this._ctor=t,this._dtor=i||null,this._elementsPerBatch=Math.max(e,1),this._shrinkThreshold=s?_(s,1):this._elementsPerBatch,this._nextAvail=this._elementsPerBatch-1;for(let e=0;e<this._elementsPerBatch;++e)this._freePool.push(t())}alloc(){if(this._nextAvail<0){this._freePool.length=this._elementsPerBatch;for(let t=0;t<this._elementsPerBatch;t++)this._freePool[t]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freePool[this._nextAvail--]}free(t){this._freePool[++this._nextAvail]=t}freeArray(t){this._freePool.length=this._nextAvail+1,Array.prototype.push.apply(this._freePool,t),this._nextAvail+=t.length}tryShrink(){const t=this._nextAvail+1;if(t<=this._shrinkThreshold)return;let e=0;if(e=t>>1>=this._shrinkThreshold?t>>1:Math.floor((t-this._shrinkThreshold+1)/2),this._dtor)for(let t=this._nextAvail-e+1;t<=this._nextAvail;++t)this._dtor(this._freePool[t]);this._nextAvail-=e,this._freePool.length=this._nextAvail+1}destroy(){const t=arguments.length>0?arguments[0]:null;t&&G(14100);const e=t||this._dtor;if(e)for(let t=0;t<=this._nextAvail;t++)e(this._freePool[t]);this._freePool.length=0,this._nextAvail=-1,super.destroy()}}t("Pool",rn);class nn extends en{constructor(t,e,i){super(),this._count=0,this._fn=t,this._dtor=i||null,this._data=new Array(e),this._initSize=e;for(let i=0;i<e;++i)this._data[i]=t()}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(t){if(t>this._data.length)for(let e=this._data.length;e<t;++e)this._data[e]=this._fn()}add(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]}destroy(){if(this._dtor)for(let t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,super.destroy()}tryShrink(){if(this._data.length>>2>this._count){const t=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(let e=t;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=t}}removeAt(t){if(t>=this._count)return;const e=this._count-1,i=this._data[t];this._data[t]=this._data[e],this._data[e]=i,this._count-=1}}t("RecyclePool",nn);class on extends en{constructor(t,e){super(),this.length=0,this._initSize=0,this.array=new Array(t),this._initSize=t,this._compareFn=e}push(t){this.array[this.length++]=t}pop(){return this.array[--this.length]}get(t){return this.array[t]}clear(){this.length=0}destroy(){this.length=0,this.array.length=0,super.destroy()}tryShrink(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))}sort(){this.array.length=this.length,this.array.sort(this._compareFn)}concat(t){for(let e=0;e<t.length;++e)this.array[this.length++]=t[e]}fastRemove(t){if(t>=this.length||t<0)return;const e=--this.length;this.array[t]=this.array[e]}indexOf(t){for(let e=0,i=this.length;e<i;++e)if(this.array[e]===t)return e;return-1}}t("CachedArray",on),t("memop",Object.freeze({__proto__:null,CachedArray:on,Pool:rn,RecyclePool:nn}));const an=t("editorExtrasTag","__editorExtras__"),hn=1,ln=4,cn=1<<17,un=1<<18,dn=1<<19,pn=1<<20,_n=1<<21,gn=~(129504|ln|cn|un|dn|pn|_n),fn=[];function mn(t,e){const i=t instanceof l.Node||t instanceof l.Component,s=i?"_id":null;let r;const n={};for(r in t)if(t.hasOwnProperty(r)){if(r===s)continue;switch(typeof t[r]){case"string":n[r]="";break;case"object":case"function":n[r]=null}}if(ri._isCCClass(e)){const t=l.Class.Attr.getClassAttrs(e),s=e.__props__;for(let e=0;e<s.length;e++){r=s[e];const o=`${r}`;if(o in t){if(i&&"_id"===r)continue;switch(typeof t[o]){case"string":n[r]="";break;case"object":case"function":n[r]=null;break;case"undefined":n[r]=void 0}}}}{let t="";for(r in n){let e;e=ri.IDENTIFIER_RE.test(r)?`o.${r}=`:`o[${ri.escapeForJS(r)}]=`;let i=n[r];""===i&&(i='""'),t+=`${e+i};\n`}return Function("o",t)}}class yn{static _deferredDestroy(){const t=fn.length;for(let e=0;e<t;++e){const t=fn[e];t._objFlags&hn||t._destroyImmediate()}t===fn.length?fn.length=0:fn.splice(0,t)}constructor(t){void 0===t&&(t=""),this._objFlags=0,this._name=t}get name(){return this._name}set name(t){this._name=t}set hideFlags(t){const e=t&yn.Flags.AllHideMasks;this._objFlags=this._objFlags&~yn.Flags.AllHideMasks|e}get hideFlags(){return this._objFlags&yn.Flags.AllHideMasks}get isValid(){return!(this._objFlags&hn)}destroy(){return this._objFlags&hn?(G(5e3),!1):!(this._objFlags&ln||(this._objFlags|=ln,fn.push(this),0))}_destruct(){const t=this.constructor;let e;Object.prototype.hasOwnProperty.call(t,"__destruct__")?e=t.__destruct__:(e=mn(this,t),ht(t,"__destruct__",e,!0)),e(this)}_destroyImmediate(){var t;this._objFlags&hn?j(5e3):(null===(t=this._onPreDestroy)||void 0===t||t.call(this),this._destruct(),this._objFlags|=hn)}}function vn(t){return t instanceof yn}function bn(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?hn|ln:hn)):void 0!==t}t("CCObject",yn),yn.prototype._deserialize=null,ri.fastDefine("cc.Object",yn,{_name:"",_objFlags:0}),ht(yn,"Flags",{Destroyed:hn,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:gn,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:_n,IsRotationLocked:cn,IsScaleLocked:un,IsAnchorLocked:dn,IsSizeLocked:pn}),l.isValid=bn,l.Object=yn;const wn=Wt;function Sn(){}class xn{constructor(){this.callback=Sn,this.target=void 0,this.once=!1}set(t,e,i){this.callback=t||Sn,this.target=e,this.once=!!i}reset(){this.target=void 0,this.callback=Sn,this.once=!1}check(){return!(vn(this.target)&&!bn(this.target,!0))}}const Tn=new rn((()=>new xn),32);class Cn{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(t){for(let e=0;e<this.callbackInfos.length;++e){const i=this.callbackInfos[e];i&&i.callback===t&&(i.reset(),Tn.free(i),wn(this.callbackInfos,e),--e)}}removeByTarget(t){for(let e=0;e<this.callbackInfos.length;++e){const i=this.callbackInfos[e];i&&i.target===t&&(i.reset(),Tn.free(i),wn(this.callbackInfos,e),--e)}}cancel(t){const e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:wn(this.callbackInfos,t),Tn.free(e)),this.containCanceled=!0}cancelAll(){for(let t=0;t<this.callbackInfos.length;t++){const e=this.callbackInfos[t];e&&(e.reset(),Tn.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0}purgeCanceled(){for(let t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||wn(this.callbackInfos,t);this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const In=new rn((()=>new Cn),16);class En{constructor(){this._callbackTable=dt(!0),this._offCallback=void 0}on(t,e,i,s){if(!this.hasEventListener(t,e,i)){let r=this._callbackTable[t];r||(r=this._callbackTable[t]=In.alloc());const n=Tn.alloc();n.set(e,i,s),r.callbackInfos.push(n)}return e}hasEventListener(t,e,i){const s=this._callbackTable&&this._callbackTable[t];if(!s)return!1;const r=s.callbackInfos;if(!e){if(s.isInvoking){for(let t=0;t<r.length;++t)if(r[t])return!0;return!1}return r.length>0}for(let t=0;t<r.length;++t){const s=r[t];if(s&&s.check()&&s.callback===e&&s.target===i)return!0}return!1}removeAll(t){const e=typeof t;if("string"===e||"number"===e){const e=this._callbackTable&&this._callbackTable[t];e&&(e.isInvoking?e.cancelAll():(e.clear(),In.free(e),delete this._callbackTable[t]))}else if(t)for(const e in this._callbackTable){const i=this._callbackTable[e];if(i.isInvoking){const e=i.callbackInfos;for(let s=0;s<e.length;++s){const r=e[s];r&&r.target===t&&i.cancel(s)}}else i.removeByTarget(t)}}off(t,e,i){var s;const r=this._callbackTable&&this._callbackTable[t];if(r){const s=r.callbackInfos;if(e)for(let t=0;t<s.length;++t){const n=s[t];if(n&&n.callback===e&&n.target===i){r.cancel(t);break}}else this.removeAll(t)}null===(s=this._offCallback)||void 0===s||s.call(this)}emit(t,e,i,s,r,n){const o=this._callbackTable&&this._callbackTable[t];if(o){const a=!o.isInvoking;o.isInvoking=!0;const h=o.callbackInfos;for(let o=0,a=h.length;o<a;++o){const a=h[o];if(a){const o=a.callback,h=a.target;a.once&&this.off(t,o,h),a.check()?h?o.call(h,e,i,s,r,n):o(e,i,s,r,n):this.off(t,o,h)}}a&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}}clear(){for(const t in this._callbackTable){const e=this._callbackTable[t];e&&(e.clear(),In.free(e),delete this._callbackTable[t])}}_registerOffCallback(t){this._offCallback=t}}function Dn(t){class e extends t{constructor(){super(...arguments),this._callbackTable=dt(!0)}once(t,e,i){return this.on(t,e,i,!0)}targetOff(t){this.removeAll(t)}}const i=En.prototype,s=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i));for(let t=0;t<s.length;++t){const r=s[t];if(!(r in e.prototype)){const t=Object.getOwnPropertyDescriptor(i,r);t&&Object.defineProperty(e.prototype,r,t)}}return e}t("CallbacksInvoker",En);const An=t("EventTarget",Dn(class{}));l.EventTarget=An;class Mn{constructor(){this._delegates=[]}add(t){this._delegates.includes(t)||this._delegates.push(t)}hasListener(t){return this._delegates.includes(t)}remove(t){$t(this._delegates,t)}dispatch(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return Promise.all(this._delegates.map((t=>t(...arguments))).filter(Boolean))}}let Pn,Bn,Rn,On,Ln,Fn;t("AsyncDelegate",Mn),function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(Pn||(Pn={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg",t.HINDI="hi"}(Bn||(Bn={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(Rn||(Rn={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS",t.OPENHARMONY="OpenHarmony"}(On||(On={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.OPENHARMONY="OPENHARMONY",t.WECHAT_GAME="WECHAT_GAME",t.WECHAT_MINI_PROGRAM="WECHAT_MINI_PROGRAM",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.TAOBAO_CREATIVE_APP="TAOBAO_CREATIVE_APP",t.TAOBAO_MINI_GAME="TAOBAO_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME",t.MIGU_MINI_GAME="MIGU_MINI_GAME"}(Ln||(Ln={})),function(t){t.WEBP="WEBP",t.IMAGE_BITMAP="IMAGE_BITMAP",t.WEB_VIEW="WEB_VIEW",t.VIDEO_PLAYER="VIDEO_PLAYER",t.SAFE_AREA="SAFE_AREA",t.HPE="HPE",t.INPUT_TOUCH="INPUT_TOUCH",t.EVENT_KEYBOARD="EVENT_KEYBOARD",t.EVENT_MOUSE="EVENT_MOUSE",t.EVENT_TOUCH="EVENT_TOUCH",t.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER",t.EVENT_GAMEPAD="EVENT_GAMEPAD",t.EVENT_HANDLE="EVENT_HANDLE",t.EVENT_HMD="EVENT_HMD",t.EVENT_HANDHELD="EVENT_HANDHELD",t.WASM="WASM"}(Fn||(Fn={}));const zn=new class extends An{constructor(){var t,e;super(),this._battery=null,this._initPromise=[];const i=window.navigator,s=i.userAgent.toLowerCase();null===(t=(e=i).getBattery)||void 0===t||t.call(e).then((t=>{this._battery=t})),this.networkType=Rn.LAN,this.isNative=!1,this.isBrowser=!0,this.isMobile=/mobile|android|iphone|ipad/.test(s),this.platform=this.isMobile?Ln.MOBILE_BROWSER:Ln.DESKTOP_BROWSER,this.isLittleEndian=(()=>{const t=new ArrayBuffer(2);return new DataView(t).setInt16(0,256,!0),256===new Int16Array(t)[0]})();let r=i.language;this.nativeLanguage=r.toLowerCase(),r=r||i.browserLanguage,r=r?r.split("-")[0]:Bn.ENGLISH,this.language=r;let a=!1,h=!1,l="",c=0,u=/android\s*(\d+(?:\.\d+)*)/i.exec(s)||/android\s*(\d+(?:\.\d+)*)/i.exec(i.platform);u&&(a=!0,l=u[1]||"",c=parseInt(l)||0),u=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(s),u?(h=!0,l=u[2]||"",c=parseInt(l)||0):(/(iPhone|iPad|iPod)/.exec(i.platform)||"MacIntel"===i.platform&&i.maxTouchPoints&&i.maxTouchPoints>1)&&(h=!0,l="",c=0);let d=On.UNKNOWN;-1!==i.appVersion.indexOf("Win")?d=On.WINDOWS:h?d=On.IOS:-1!==i.appVersion.indexOf("Mac")?d=On.OSX:-1!==i.appVersion.indexOf("X11")&&-1===i.appVersion.indexOf("Linux")?d=On.LINUX:a?d=On.ANDROID:-1===i.appVersion.indexOf("Linux")&&-1===s.indexOf("ubuntu")||(d=On.LINUX),this.os=d,this.osVersion=l,this.osMainVersion=c,this.browserType=Pn.UNKNOWN;const p=/wechat|weixin|micromessenger/i.exec(s)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(s)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(s)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(s);let _=p?p[0].toLowerCase():On.UNKNOWN;("safari"===_&&a||"qq"===_&&/android.*applewebkit/i.test(s))&&(_=Pn.ANDROID);const g={micromessenger:Pn.WECHAT,wechat:Pn.WECHAT,weixin:Pn.WECHAT,trident:Pn.IE,edge:Pn.EDGE,"360 aphone":Pn.BROWSER_360,mxbrowser:Pn.MAXTHON,"opr/":Pn.OPERA,ubrowser:Pn.UC,huaweibrowser:Pn.HUAWEI};this.browserType=g[_]||_,this.browserVersion="";let f=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(s);f||(f=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(s)),this.browserVersion=f?f[4]:"",this.isXR=!1;const m=document.createElement("canvas");let y;m.getContext("2d");try{y=m.toDataURL("image/webp").startsWith("data:image/webp")}catch(t){y=!1}if(this.os===On.IOS){var v;const t=null===(v=/ applewebkit\/(\d+)/.exec(s))||void 0===v?void 0:v[1];"string"==typeof t&&Number.parseInt(t)>=604&&(y=!0)}else if(this.browserType===Pn.SAFARI){var b;const t=null===(b=/ version\/(\d+)/.exec(s))||void 0===b?void 0:b[1];"string"==typeof t&&Number.parseInt(t)>=14&&(y=!0)}const w=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart||n,S=void 0!==document.documentElement.onmouseup||n,x=void 0!==navigator.xr,T=(()=>{if((this.os===On.IOS||this.os===On.OSX)&&/(OS 15_4)|(Version\/15.4)/.test(window.navigator.userAgent))return!1;try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0]));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){return!1}return!1})();this._featureMap={[Fn.WEBP]:y,[Fn.IMAGE_BITMAP]:!1,[Fn.WEB_VIEW]:!0,[Fn.VIDEO_PLAYER]:!0,[Fn.SAFE_AREA]:!1,[Fn.HPE]:!1,[Fn.INPUT_TOUCH]:w,[Fn.EVENT_KEYBOARD]:void 0!==document.documentElement.onkeyup||n,[Fn.EVENT_MOUSE]:S,[Fn.EVENT_TOUCH]:w||S,[Fn.EVENT_ACCELEROMETER]:void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,[Fn.EVENT_GAMEPAD]:void 0!==navigator.getGamepads||void 0!==navigator.webkitGetGamepads||x,[Fn.EVENT_HANDLE]:o,[Fn.EVENT_HMD]:x,[Fn.EVENT_HANDHELD]:x,[Fn.WASM]:T},this._initPromise.push(this._supportsImageBitmapPromise()),this._registerEvent()}_supportsImageBitmapPromise(){if("undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob){const t=document.createElement("canvas");t.width=t.height=2;const e=createImageBitmap(t,{});if(e instanceof Promise)return e.then((t=>{this._setFeature(Fn.IMAGE_BITMAP,!0),null==t||t.close()}))}return Promise.resolve()}_registerEvent(){let t;t=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";let e=!1;const i=()=>{e||(e=!0,this.emit("hide"))},s=(t,i,s,r,n)=>{e&&(e=!1,this.emit("show",t,i,s,r,n))};if(t){const e=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"];for(let r=0;r<e.length;r++)document.addEventListener(e[r],(e=>{let r=document[t];r=r||e.hidden,r?i():s()}))}else window.addEventListener("blur",i),window.addEventListener("focus",s);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=s),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",s),document.addEventListener("pagehide",i),document.addEventListener("pageshow",s))}_setFeature(t,e){return this._featureMap[t]=e}init(){return Promise.all(this._initPromise)}hasFeature(t){return this._featureMap[t]}getBatteryLevel(){return this._battery?this._battery.level:1}triggerGC(){}openURL(t){window.open(t)}now(){return Date.now?Date.now():+new Date}restartJSVM(){}exit(){window.close()}close(){this.emit("close")}},kn={auto:he.AUTO,landscape:he.LANDSCAPE,portrait:he.PORTRAIT};var Nn;!function(t){t[t.Unknown=0]="Unknown",t[t.SubFrame=1]="SubFrame",t[t.BrowserWindow=2]="BrowserWindow",t[t.Fullscreen=3]="Fullscreen"}(Nn||(Nn={}));const Un=new class extends An{get supportFullScreen(){return this._supportFullScreen}get isFullScreen(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}get devicePixelRatio(){var t;return Math.min(null!==(t=window.devicePixelRatio)&&void 0!==t?t:1,2)}get windowSize(){const t=this._windowSizeInCssPixels,e=this.devicePixelRatio;return t.width*=e,t.height*=e,t}set windowSize(t){this._windowType===Nn.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(t)):G(9202)}get resolution(){const t=this.windowSize,e=this.resolutionScale;return new br(t.width*e,t.height*e)}get resolutionScale(){return this._resolutionScale}set resolutionScale(t){var e;t!==this._resolutionScale&&(this._resolutionScale=t,null===(e=this._cbToUpdateFrameBuffer)||void 0===e||e.call(this))}get orientation(){return this._orientation}set orientation(t){this._orientation!==t&&(this._orientation=t,this._updateFrame())}_updateFrame(){this._updateFrameState(),this._resizeFrame()}get safeAreaEdge(){const t=this.devicePixelRatio;return{top:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-top")||"0")*t,bottom:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-bottom")||"0")*t,left:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-left")||"0")*t,right:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-right")||"0")*t}}get isProportionalToFrame(){return this._isProportionalToFrame}set isProportionalToFrame(t){this._isProportionalToFrame!==t&&(this._isProportionalToFrame=t,this._updateContainer())}get _windowSizeInCssPixels(){if(this.isProportionalToFrame)return this._gameContainer?new br(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(G(9201),new br(0,0));let t,e,i;switch(this._windowType){case Nn.SubFrame:return this._gameFrame?new br(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(G(9201),new br(0,0));case Nn.Fullscreen:return t=this._getFullscreenTarget(),e=this.isFrameRotated?t.clientHeight:t.clientWidth,i=this.isFrameRotated?t.clientWidth:t.clientHeight,new br(e,i);case Nn.BrowserWindow:return e=this.isFrameRotated?window.innerHeight:window.innerWidth,i=this.isFrameRotated?window.innerWidth:window.innerHeight,new br(e,i);case Nn.Unknown:default:return new br(0,0)}}get _windowType(){return this._isHeadlessMode?Nn.Unknown:this.isFullScreen?Nn.Fullscreen:this._gameFrame?this._exactFitScreen?Nn.BrowserWindow:Nn.SubFrame:(G(9201),Nn.Unknown)}constructor(){var t,e,i,s;let r;super(),this.isFrameRotated=!1,this.handleResizeEvent=!0,this._gameFrame=void 0,this._gameContainer=void 0,this._gameCanvas=void 0,this._isProportionalToFrame=!1,this._cachedFrameStyle={width:"0px",height:"0px"},this._cachedContainerStyle={width:"0px",height:"0px"},this._cbToUpdateFrameBuffer=void 0,this._supportFullScreen=!1,this._touchEventName=void 0,this._onFullscreenChange=void 0,this._onFullscreenError=void 0,this._orientationChangeTimeoutId=-1,this._cachedFrameSize=new br(0,0),this._exactFitScreen=!1,this._isHeadlessMode=!1,this._fn={},this._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],this._resolutionScale=1,this._orientation=he.AUTO,this._orientationDevice=he.AUTO,this._gameFrame=document.getElementById("GameDiv"),this._gameContainer=document.getElementById("Cocos3dGameContainer"),this._gameCanvas=document.getElementById("GameCanvas"),this._gameFrame||(this._gameFrame=document.createElement("div"),this._gameFrame.setAttribute("id","GameDiv"),null===(t=this._gameCanvas)||void 0===t||null===(e=t.parentNode)||void 0===e||e.insertBefore(this._gameFrame,this._gameCanvas),this._gameFrame.appendChild(this._gameCanvas)),this._gameContainer||(this._gameContainer=document.createElement("div"),this._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(i=this._gameCanvas)||void 0===i||null===(s=i.parentNode)||void 0===s||s.insertBefore(this._gameContainer,this._gameCanvas),this._gameContainer.appendChild(this._gameCanvas));const n=this._fnGroup;for(let t=0;t<n.length;t++)if(r=n[t],void 0!==document[r[1]]){for(let t=0;t<r.length;t++)this._fn[n[0][t]]=r[t];break}this._supportFullScreen=void 0!==this._fn.requestFullscreen,this._touchEventName="ontouchstart"in window?"touchend":"mousedown",this._registerEvent()}init(t,e){this._cbToUpdateFrameBuffer=e,this.orientation=kn[t.configOrientation],this._exactFitScreen=t.exactFitScreen,this._isHeadlessMode=t.isHeadlessMode,this._resizeFrame()}requestFullScreen(){return new Promise(((t,e)=>{this.isFullScreen?t():(this._cachedFrameSize=this.windowSize,this._doRequestFullScreen().then((()=>{t()})).catch((()=>{const i=this._getFullscreenTarget();i?i.addEventListener(this._touchEventName,(()=>{this._doRequestFullScreen().then((()=>{t()})).catch(e)}),{once:!0,capture:!0}):e(new Error("Cannot access fullscreen target"))})))}))}exitFullScreen(){return new Promise(((t,e)=>{const i=document[this._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((()=>{this.windowSize=this._cachedFrameSize,t()})).catch(e):(this.windowSize=this._cachedFrameSize,t())}))}_registerEvent(){document.addEventListener(this._fn.fullscreenerror,(()=>{var t;null===(t=this._onFullscreenError)||void 0===t||t.call(this)})),window.addEventListener("resize",(()=>{this._updateFrame()}));const t=t=>{t!==this._orientationDevice&&(this._orientationDevice=t,this._updateFrame(),this.emit("orientation-change",t))},e=()=>{let t=he.PORTRAIT;switch(window.orientation){case 0:t=he.PORTRAIT;break;case 90:t=he.LANDSCAPE_RIGHT;break;case-90:t=he.LANDSCAPE_LEFT;break;case 180:t=he.PORTRAIT_UPSIDE_DOWN;break;default:t=this._orientationDevice}return t};let i;const s=()=>{-1!==this._orientationChangeTimeoutId&&clearTimeout(this._orientationChangeTimeoutId),this._orientationChangeTimeoutId=setTimeout((()=>{i()}),200)};if("function"==typeof window.matchMedia){const e=()=>{const t=window.devicePixelRatio,i=window.matchMedia(`(resolution: ${t}dppx)`);i.addEventListener?i.addEventListener("change",(()=>{this.emit("window-resize",this.windowSize.width,this.windowSize.height),e()}),{once:!0}):i.addListener&&i.addListener((()=>{this.emit("window-resize",this.windowSize.width,this.windowSize.height)}))};e();const r=window.matchMedia("(orientation: portrait)"),n=window.matchMedia("(orientation: landscape)"),o=screen.orientation;i=()=>{let e=this._orientationDevice;r.matches?(e=he.PORTRAIT,o&&(e="portrait-primary"===screen.orientation.type?he.PORTRAIT:he.PORTRAIT_UPSIDE_DOWN)):n.matches&&(e=he.LANDSCAPE,o)&&(e="landscape-primary"===screen.orientation.type?he.LANDSCAPE_LEFT:he.LANDSCAPE_RIGHT),t(e)},r.addEventListener?(r.addEventListener("change",s),n.addEventListener("change",s)):r.addListener&&(r.addListener(s),n.addListener(s))}else i=()=>{const i=e();t(i)},window.addEventListener("orientationchange",s);document.addEventListener(this._fn.fullscreenchange,(()=>{var t;null===(t=this._onFullscreenChange)||void 0===t||t.call(this),this.emit("fullscreen-change",this.windowSize.width,this.windowSize.height)}))}_convertToSizeInCssPixels(t){const e=t.clone(),i=this.devicePixelRatio;return e.width/=i,e.height/=i,e}_resizeFrame(t){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===Nn.SubFrame){if(!t)return void this._updateContainer();this._gameFrame.style.width=`${t.width}px`,this._gameFrame.style.height=`${t.height}px`}else{const t=window.innerWidth;let e=window.innerHeight;const i=document.body.scrollHeight-e;zn.os===On.ANDROID&&e<i&&(e+=i),this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin=`0 0 0 ${t}px`,this._gameFrame.style.width=`${e}px`,this._gameFrame.style.height=`${t}px`):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=`${t}px`,this._gameFrame.style.height=`${e}px`)}this._updateContainer()}}_getFullscreenTarget(){const t=this._windowType;return t===Nn.Fullscreen?document[this._fn.fullscreenElement]:t===Nn.SubFrame?this._gameFrame:document.body}_doRequestFullScreen(){return new Promise(((t,e)=>{if(!this._supportFullScreen)return void e(new Error("fullscreen is not supported"));const i=this._getFullscreenTarget();if(!i)return void e(new Error("Cannot access fullscreen target"));this._onFullscreenChange=void 0,this._onFullscreenError=void 0;const s=i[this._fn.requestFullscreen]();window.Promise&&s instanceof Promise?s.then(t).catch(e):(this._onFullscreenChange=t,this._onFullscreenError=e)}))}_updateFrameState(){const t=this.orientation,e=window.innerWidth>window.innerHeight;this.isFrameRotated=zn.isMobile&&(e&&t===he.PORTRAIT||!e&&t===he.LANDSCAPE)}_updateContainer(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void G(9201);const t=l.view.getDesignResolutionSize(),e=this._gameFrame,i=e.clientWidth,s=e.clientHeight,r=t.width,n=t.height,o=i/r,a=s/n,h=this._gameContainer.style;let c,u;o<a?(c=i,u=n*o):(c=r*a,u=s),h.width=`${c}px`,h.height=`${u}px`}else{const t=this._gameContainer.style;t.width="100%",t.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize",this.windowSize.width,this.windowSize.height),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else G(9201)}},Vn=t("screen",new class{init(){var t,e;const i=null===(t=ae.querySettings("screen","exactFitScreen"))||void 0===t||t,s=null!==(e=ae.querySettings("screen","orientation"))&&void 0!==e?e:"auto",r=3===ae.querySettings("rendering","renderMode");Un.init({exactFitScreen:i,configOrientation:s,isHeadlessMode:r},(()=>{var t;const e=l.director;null!==(t=e.root)&&void 0!==t&&t.pipeline?e.root.pipeline.shadingScale=Un.resolutionScale:G(1220)}))}get devicePixelRatio(){return Un.devicePixelRatio}get windowSize(){return Un.windowSize}set windowSize(t){Un.windowSize=t}get resolution(){return Un.resolution}get supportsFullScreen(){return Un.supportFullScreen}fullScreen(){return Un.isFullScreen}requestFullScreen(t,e,i){return arguments.length>0&&G(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),Un.requestFullScreen().then((()=>{null==e||e.call(document)})).catch((t=>{B(t),null==i||i.call(document)}))}exitFullScreen(){return Un.exitFullScreen()}autoFullScreen(t,e){var i;null===(i=this.requestFullScreen(t,e))||void 0===i||i.catch((t=>{P(t)}))}disableAutoFullScreen(t){}on(t,e,i){Un.on(t,e,i)}once(t,e,i){Un.once(t,e,i)}off(t,e,i){Un.off(t,e,i)}});l.screen=Vn;const Hn=t("sys",{Feature:Fn,hasFeature:t=>zn.hasFeature(t),NetworkType:Rn,Language:Bn,OS:On,Platform:Ln,BrowserType:Pn,isNative:zn.isNative,isBrowser:zn.isBrowser,isMobile:zn.isMobile,isLittleEndian:zn.isLittleEndian,platform:zn.platform,language:zn.language,languageCode:zn.nativeLanguage,os:zn.os,osVersion:zn.osVersion,osMainVersion:zn.osMainVersion,browserType:zn.browserType,browserVersion:zn.browserVersion,isXR:zn.isXR,windowPixelResolution:Vn.windowSize,capabilities:{canvas:!0,opengl:!0,webp:zn.hasFeature(Fn.WEBP),imageBitmap:zn.hasFeature(Fn.IMAGE_BITMAP),touches:zn.hasFeature(Fn.INPUT_TOUCH),mouse:zn.hasFeature(Fn.EVENT_MOUSE),keyboard:zn.hasFeature(Fn.EVENT_KEYBOARD),accelerometer:zn.hasFeature(Fn.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:()=>zn.networkType,getBatteryLevel:()=>zn.getBatteryLevel(),garbageCollect(){zn.triggerGC()},isObjectValid:t=>null!=t,__isWebIOS14OrIPadOS14Env:!1,dump(){let t="";t+=`isMobile : ${this.isMobile}\r\n`,t+=`language : ${this.language}\r\n`,t+=`browserType : ${this.browserType}\r\n`,t+=`browserVersion : ${this.browserVersion}\r\n`,t+=`supports webp: ${Hn.hasFeature(Fn.WEBP)}\r\n`,t+=`supports bitmap: ${Hn.hasFeature(Fn.IMAGE_BITMAP)}\r\n`,t+=`supports touches: ${Hn.hasFeature(Fn.INPUT_TOUCH)}\r\n`,t+=`supports mouse: ${Hn.hasFeature(Fn.EVENT_MOUSE)}\r\n`,t+=`supports keyboard: ${Hn.hasFeature(Fn.EVENT_KEYBOARD)}\r\n`,t+=`supports accelerometer: ${Hn.hasFeature(Fn.EVENT_ACCELEROMETER)}\r\n`,t+=`os : ${this.os}\r\n`,t+=`osVersion : ${this.osVersion}\r\n`,t+=`platform : ${this.platform}\r\n`,t+=`Using ${l.game.renderType===l.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS"} renderer.\r\n`,M(t)},openURL(t){zn.openURL(t)},init(){return Promise.resolve().then((()=>zn.init())).then((()=>{try{let t=Hn.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){const e=function(){G(5200)};this.localStorage={getItem:e,setItem:e,clear:e,removeItem:e,key:e,length:0}}this.__isWebIOS14OrIPadOS14Env=(Hn.os===On.IOS||Hn.os===On.OSX)&&zn.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}))},now:()=>zn.now(),restartVM(){zn.restartJSVM()},getSafeAreaRect(t){void 0===t&&(t=!0);const e=l.view,i=Un.safeAreaEdge;t&&(Un.orientation===le.ORIENTATION_PORTRAIT?i.top<i.bottom?i.top=i.bottom:i.bottom=i.top:i.left<i.right?i.left=i.right:i.right=i.left);const s=Un.windowSize,r=new Qs(i.left,i.bottom),n=new Qs(s.width-i.right,s.height-i.top);e._convertToUISpace(r),e._convertToUISpace(n);const o=r.x,a=r.y,h=n.x-r.x,c=n.y-r.y;return new Cr(o,a,h,c)}});l.sys=Hn;const Gn=t("visibleRect",{topLeft:l.v2(0,0),topRight:l.v2(0,0),top:l.v2(0,0),bottomLeft:l.v2(0,0),bottomRight:l.v2(0,0),bottom:l.v2(0,0),center:l.v2(0,0),left:l.v2(0,0),right:l.v2(0,0),width:0,height:0,init(t){const e=this.width=t.width,i=this.height=t.height,s=t.x,r=t.y,n=r+i,o=s+e;this.topLeft.x=s,this.topLeft.y=n,this.topRight.x=o,this.topRight.y=n,this.top.x=s+e/2,this.top.y=n,this.bottomLeft.x=s,this.bottomLeft.y=r,this.bottomRight.x=o,this.bottomRight.y=r,this.bottom.x=s+e/2,this.bottom.y=r,this.center.x=s+e/2,this.center.y=r+i/2,this.left.x=s,this.left.y=r+i/2,this.right.x=o,this.right.y=r+i/2}});l.visibleRect=Gn;const Wn=new Ki,jn=new Ki,$n=new Ki,qn=new Ki,Xn=new ss,Yn=(t,e,i)=>{Xn.m00=Math.abs(i.m00),Xn.m01=Math.abs(i.m01),Xn.m02=Math.abs(i.m02),Xn.m03=Math.abs(i.m04),Xn.m04=Math.abs(i.m05),Xn.m05=Math.abs(i.m06),Xn.m06=Math.abs(i.m08),Xn.m07=Math.abs(i.m09),Xn.m08=Math.abs(i.m10),Ki.transformMat3(t,e,Xn)};class Qn{static create(t,e,i,s,r,n){return new Qn(t,e,i,s,r,n)}static clone(t){return new Qn(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}static copy(t,e){return Ki.copy(t.center,e.center),Ki.copy(t.halfExtents,e.halfExtents),t}static fromPoints(t,e,i){return Ki.add(Wn,i,e),Ki.subtract(jn,i,e),Ki.multiplyScalar(t.center,Wn,.5),Ki.multiplyScalar(t.halfExtents,jn,.5),t}static set(t,e,i,s,r,n,o){return t.center.set(e,i,s),t.halfExtents.set(r,n,o),t}static merge(t,e,i){return Ki.subtract(Wn,e.center,e.halfExtents),Ki.subtract(jn,i.center,i.halfExtents),Ki.add($n,e.center,e.halfExtents),Ki.add(qn,i.center,i.halfExtents),Ki.max(qn,$n,qn),Ki.min($n,Wn,jn),Qn.fromPoints(t,$n,qn)}static toBoundingSphere(t,e){return t.center.set(e.center),t.radius=e.halfExtents.length(),t}static transform(t,e,i){return Ki.transformMat4(t.center,e.center,i),Yn(t.halfExtents,e.halfExtents,i),t}get type(){return this._type}constructor(t,e,i,s,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=1),void 0===r&&(r=1),void 0===n&&(n=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=8,this.center=new Ki(t,e,i),this.halfExtents=new Ki(s,r,n)}getBoundary(t,e){Ki.subtract(t,this.center,this.halfExtents),Ki.add(e,this.center,this.halfExtents)}transform(t,e,i,s,r){Ki.transformMat4(r.center,this.center,t),Yn(r.halfExtents,this.halfExtents,t)}clone(){const t=this.center,e=this.halfExtents;return new Qn(t.x,t.y,t.z,e.x,e.y,e.z)}copy(t){return Ki.copy(this.center,t.center),Ki.copy(this.halfExtents,t.halfExtents),this}mergePoint(t){this.getBoundary(Wn,jn),t.x<Wn.x&&(Wn.x=t.x),t.y<Wn.y&&(Wn.y=t.y),t.z<Wn.z&&(Wn.z=t.z),t.x>jn.x&&(jn.x=t.x),t.y>jn.y&&(jn.y=t.y),t.z>jn.z&&(jn.z=t.z),Ki.add($n,Wn,jn),this.center.set(Ki.multiplyScalar($n,$n,.5)),this.halfExtents.set(jn.x-$n.x,jn.y-$n.y,jn.z-$n.z)}mergePoints(t){if(!(t.length<1))for(let e=0;e<t.length;e++)this.mergePoint(t[e])}mergeFrustum(t){this.mergePoints(t.vertices)}}const Kn=new Array(8);Kn[0]=Zi(1,1,1),Kn[1]=Zi(-1,1,1),Kn[2]=Zi(-1,-1,1),Kn[3]=Zi(1,-1,1),Kn[4]=Zi(1,1,-1),Kn[5]=Zi(-1,1,-1),Kn[6]=Zi(-1,-1,-1),Kn[7]=Zi(1,-1,-1);const Zn=Zi(),Jn=Zi(),to=Zi();class eo{static createOrthographic(t,e,i,s,r,n){const o=e/2,a=i/2;Ki.set(to,o,a,-s),Ki.transformMat4(t.vertices[0],to,n),Ki.set(to,-o,a,-s),Ki.transformMat4(t.vertices[1],to,n),Ki.set(to,-o,-a,-s),Ki.transformMat4(t.vertices[2],to,n),Ki.set(to,o,-a,-s),Ki.transformMat4(t.vertices[3],to,n),Ki.set(to,o,a,-r),Ki.transformMat4(t.vertices[4],to,n),Ki.set(to,-o,a,-r),Ki.transformMat4(t.vertices[5],to,n),Ki.set(to,-o,-a,-r),Ki.transformMat4(t.vertices[6],to,n),Ki.set(to,o,-a,-r),Ki.transformMat4(t.vertices[7],to,n),t.updatePlanes()}static createOrtho(t,e,i,s,r,n){return eo.createOrthographic(t,e,i,s,r,n)}static createPerspective(t,e,i,s,r,n){const o=Math.tan(.5*i),a=o*e;Zn.set(s*a,s*o,s),Jn.set(r*a,r*o,r);const h=t.vertices;to.set(Zn.x,Zn.y,-Zn.z),Ki.transformMat4(h[0],to,n),to.set(-Zn.x,Zn.y,-Zn.z),Ki.transformMat4(h[1],to,n),to.set(-Zn.x,-Zn.y,-Zn.z),Ki.transformMat4(h[2],to,n),to.set(Zn.x,-Zn.y,-Zn.z),Ki.transformMat4(h[3],to,n),to.set(Jn.x,Jn.y,-Jn.z),Ki.transformMat4(h[4],to,n),to.set(-Jn.x,Jn.y,-Jn.z),Ki.transformMat4(h[5],to,n),to.set(-Jn.x,-Jn.y,-Jn.z),Ki.transformMat4(h[6],to,n),to.set(Jn.x,-Jn.y,-Jn.z),Ki.transformMat4(h[7],to,n),t.updatePlanes()}static createFromAABB(t,e){const i=new Ki,s=new Ki;return Ki.subtract(i,e.center,e.halfExtents),Ki.add(s,e.center,e.halfExtents),t.vertices[0].set(s.x,s.y,-i.z),t.vertices[1].set(i.x,s.y,-i.z),t.vertices[2].set(i.x,i.y,-i.z),t.vertices[3].set(s.x,i.y,-i.z),t.vertices[4].set(s.x,s.y,-s.z),t.vertices[5].set(i.x,s.y,-s.z),t.vertices[6].set(i.x,i.y,-s.z),t.vertices[7].set(s.x,i.y,-s.z),t.updatePlanes(),t}split(t,e,i,s,r){return eo.createPerspective(this,i,s,t,e,r)}static create(){return new eo}static clone(t){return eo.copy(new eo,t)}static copy(t,e){t._type=e.type;for(let i=0;i<6;++i)$r.copy(t.planes[i],e.planes[i]);for(let i=0;i<8;++i)Ki.copy(t.vertices[i],e.vertices[i]);return t}set accurate(t){this._type=t?256:128}get type(){return this._type}constructor(){this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=128,this.planes=new Array(6);for(let t=0;t<6;++t)this.planes[t]=$r.create(0,0,0,0);this.vertices=new Array(8);for(let t=0;t<8;++t)this.vertices[t]=new Ki}update(t,e){Ki.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),Ki.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),Ki.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),Ki.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),Ki.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),Ki.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14);for(let t=0;t<6;t++){const e=this.planes[t],i=1/e.n.length();Ki.multiplyScalar(e.n,e.n,i),e.d*=i}for(let t=0;t<8;t++)Ki.transformMat4(this.vertices[t],Kn[t],e)}transform(t){for(let e=0;e<8;e++)Ki.transformMat4(this.vertices[e],this.vertices[e],t);this.updatePlanes()}zero(){for(let t=0;t<8;t++)this.vertices[t].set(0,0,0);for(let t=0;t<6;t++)$r.set(this.planes[t],0,0,0,0)}updatePlanes(){$r.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),$r.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),$r.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),$r.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),$r.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),$r.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}}const io=function(t,e){const i=Ki.dot(t.d,e.n);if(Math.abs(i)<Number.EPSILON)return 0;const s=-kr(t.o,e)/i;return s<0?0:s},so=function(){const t=new Ki(0,0,0),e=new Ki(0,0,0),i=new Ki(0,0,0),s=new Ki(0,0,0),r=new Ki(0,0,0);return function(n,o,a){Ki.subtract(t,o.b,o.a),Ki.subtract(e,o.c,o.a),Ki.cross(i,n.d,e);const h=Ki.dot(t,i);if(h<Number.EPSILON&&(!a||h>-Number.EPSILON))return 0;const l=1/h;Ki.subtract(s,n.o,o.a);const c=Ki.dot(s,i)*l;if(c<0||c>1)return 0;Ki.cross(r,s,t);const u=Ki.dot(n.d,r)*l;if(u<0||c+u>1)return 0;const d=Ki.dot(e,r)*l;return d<0?0:d}}(),ro=function(){const t=new Ki(0,0,0);return function(e,i){const s=i.radius,r=i.center,n=e.o,o=e.d,a=s*s;Ki.subtract(t,r,n);const h=t.lengthSqr(),l=Ki.dot(t,o),c=a-(h-l*l);if(c<0)return 0;const u=Math.sqrt(c),d=h<a?l+u:l-u;return d<0?0:d}}(),no=function(){const t=new Ki,e=new Ki;return function(i,s){return Ki.subtract(t,s.center,s.halfExtents),Ki.add(e,s.center,s.halfExtents),oo(i,t,e)}}();function oo(t,e,i){const s=t.o,r=t.d,n=1/r.x,o=1/r.y,a=1/r.z,h=(e.x-s.x)*n,l=(i.x-s.x)*n,c=(e.y-s.y)*o,u=(i.y-s.y)*o,d=(e.z-s.z)*a,p=(i.z-s.z)*a,_=Math.max(Math.max(Math.min(h,l),Math.min(c,u)),Math.min(d,p)),g=Math.min(Math.min(Math.max(h,l),Math.max(c,u)),Math.max(d,p));return g<0||_>g?0:_>0?_:g}const ao=function(){let t=new Ki,e=new Ki,i=new Ki;const s=new Ki,r=new Ki,n=new Ki,o=new Ki,a=new Array(3),h=new Array(3),l=new Array(3),c=new Array(6);return function(u,d){a[0]=d.halfExtents.x,a[1]=d.halfExtents.y,a[2]=d.halfExtents.z,t=d.center,e=u.o,i=u.d,Ki.set(s,d.orientation.m00,d.orientation.m01,d.orientation.m02),Ki.set(r,d.orientation.m03,d.orientation.m04,d.orientation.m05),Ki.set(n,d.orientation.m06,d.orientation.m07,d.orientation.m08),Ki.subtract(o,t,e),h[0]=Ki.dot(s,i),h[1]=Ki.dot(r,i),h[2]=Ki.dot(n,i),l[0]=Ki.dot(s,o),l[1]=Ki.dot(r,o),l[2]=Ki.dot(n,o);for(let t=0;t<3;++t){if(0===h[t]){if(-l[t]-a[t]>0||-l[t]+a[t]<0)return 0;h[t]=1e-7}c[2*t+0]=(l[t]+a[t])/h[t],c[2*t+1]=(l[t]-a[t])/h[t]}const p=Math.max(Math.max(Math.min(c[0],c[1]),Math.min(c[2],c[3])),Math.min(c[4],c[5])),_=Math.min(Math.min(Math.max(c[0],c[1]),Math.max(c[2],c[3])),Math.max(c[4],c[5]));return _<0||p>_?0:p>0?p:_}}(),ho=function(){const t=new Ki,e=new Ki,i=new Ki,s=new Ki,r=new Ki,n=new Ki,o=new Ki,a=new tn;return function(h,l){const c=l.ellipseCenter0,u=l.ellipseCenter1,d=Ki.subtract(e,u,c);if(d.length()<pi)return a.radius=l.radius,a.center.set(l.ellipseCenter0),ko.raySphere(h,a);const p=h.o,_=Ki.subtract(i,p,c),g=Ki.normalize(t,h.d),f=Ki.cross(s,g,d),m=f.lengthSqr();if(0===m){a.radius=l.radius;const t=Ki.subtract(r,u,p);return _.lengthSqr()<t.lengthSqr()?a.center.set(c):a.center.set(u),ko.raySphere(h,a)}const y=Ki.cross(r,_,d),v=d.lengthSqr(),b=2*Ki.dot(f,y),w=l.radius*l.radius,S=b*b-4*m*(y.lengthSqr()-w*v);if(S<0)return 0;const x=(-b-Math.sqrt(S))/(2*m);if(x<0){a.radius=l.radius;const t=Ki.subtract(n,u,p);return _.lengthSqr()<t.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),ko.raySphere(h,a)}{const t=Ki.scaleAndAdd(n,h.o,g,x),e=Ki.subtract(o,t,c),i=Ki.dot(e,d)/v;return i>=0&&i<=1?x:i<0?(a.radius=l.radius,a.center.set(l.ellipseCenter0),ko.raySphere(h,a)):i>1?(a.radius=l.radius,a.center.set(l.ellipseCenter1),ko.raySphere(h,a)):0}}}(),lo=function(){const t=new Ki(0,0,0);return function(e,i){Ki.subtract(t,e.e,e.s);const s=-kr(e.s,i)/Ki.dot(t,i.n);return s<0||s>1?0:s}}(),co=function(){const t=new Ki(0,0,0),e=new Ki(0,0,0),i=new Ki(0,0,0),s=new Ki(0,0,0),r=new Ki(0,0,0),n=new Ki(0,0,0);return function(o,a,h){Ki.subtract(t,a.b,a.a),Ki.subtract(e,a.c,a.a),Ki.subtract(i,o.s,o.e),Ki.cross(r,t,e);const l=Ki.dot(i,r);if(l<=0)return 0;Ki.subtract(s,o.s,a.a);const c=Ki.dot(s,r);if(c<0||c>l)return 0;Ki.cross(n,i,s);let u=Ki.dot(e,n);if(u<0||u>l)return 0;let d=-Ki.dot(t,n);if(d<0||u+d>l)return 0;if(h){const t=1/l;u*=t,d*=t;const e=1-u-d;Ki.set(h,a.a.x*e+a.b.x*u+a.c.x*d,a.a.y*e+a.b.y*u+a.c.y*d,a.a.z*e+a.b.z*u+a.c.z*d)}return 1}}(),uo=new qr;function po(t,e){uo.o.set(t.s),Ki.subtract(uo.d,t.e,t.s),uo.d.normalize();const i=no(uo,e);return i<=t.length()?i:0}function _o(t,e){uo.o.set(t.s),Ki.subtract(uo.d,t.e,t.s),uo.d.normalize();const i=ao(uo,e);return i<=t.length()?i:0}function go(t,e){uo.o.set(t.s),Ki.subtract(uo.d,t.e,t.s),uo.d.normalize();const i=ro(uo,e);return i<=t.length()?i:0}const fo=function(){const t=new Ki,e=new Ki,i=new Ki,s=new Ki;return function(r,n){return Ki.subtract(t,r.center,r.halfExtents),Ki.add(e,r.center,r.halfExtents),Ki.subtract(i,n.center,n.halfExtents),Ki.add(s,n.center,n.halfExtents),t.x<=s.x&&e.x>=i.x&&t.y<=s.y&&e.y>=i.y&&t.z<=s.z&&e.z>=i.z}}();function mo(t,e,i){Ki.set(i[0],t.x,e.y,e.z),Ki.set(i[1],t.x,e.y,t.z),Ki.set(i[2],t.x,t.y,e.z),Ki.set(i[3],t.x,t.y,t.z),Ki.set(i[4],e.x,e.y,e.z),Ki.set(i[5],e.x,e.y,t.z),Ki.set(i[6],e.x,t.y,e.z),Ki.set(i[7],e.x,t.y,t.z)}function yo(t,e,i,s,r,n){Ki.set(n[0],t.x+i.x*e.x+s.x*e.y+r.x*e.z,t.y+i.y*e.x+s.y*e.y+r.y*e.z,t.z+i.z*e.x+s.z*e.y+r.z*e.z),Ki.set(n[1],t.x-i.x*e.x+s.x*e.y+r.x*e.z,t.y-i.y*e.x+s.y*e.y+r.y*e.z,t.z-i.z*e.x+s.z*e.y+r.z*e.z),Ki.set(n[2],t.x+i.x*e.x-s.x*e.y+r.x*e.z,t.y+i.y*e.x-s.y*e.y+r.y*e.z,t.z+i.z*e.x-s.z*e.y+r.z*e.z),Ki.set(n[3],t.x+i.x*e.x+s.x*e.y-r.x*e.z,t.y+i.y*e.x+s.y*e.y-r.y*e.z,t.z+i.z*e.x+s.z*e.y-r.z*e.z),Ki.set(n[4],t.x-i.x*e.x-s.x*e.y-r.x*e.z,t.y-i.y*e.x-s.y*e.y-r.y*e.z,t.z-i.z*e.x-s.z*e.y-r.z*e.z),Ki.set(n[5],t.x+i.x*e.x-s.x*e.y-r.x*e.z,t.y+i.y*e.x-s.y*e.y-r.y*e.z,t.z+i.z*e.x-s.z*e.y-r.z*e.z),Ki.set(n[6],t.x-i.x*e.x+s.x*e.y-r.x*e.z,t.y-i.y*e.x+s.y*e.y-r.y*e.z,t.z-i.z*e.x+s.z*e.y-r.z*e.z),Ki.set(n[7],t.x-i.x*e.x-s.x*e.y+r.x*e.z,t.y-i.y*e.x-s.y*e.y+r.y*e.z,t.z-i.z*e.x-s.z*e.y+r.z*e.z)}function vo(t,e){let i=Ki.dot(e,t[0]),s=i;for(let r=1;r<8;++r){const n=Ki.dot(e,t[r]);i=n<i?n:i,s=n>s?n:s}return[i,s]}const bo=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new Ki(0,0,0);const e=new Array(8),i=new Array(8);for(let t=0;t<8;t++)e[t]=new Ki(0,0,0),i[t]=new Ki(0,0,0);const s=new Ki,r=new Ki;return function(n,o){Ki.set(t[0],1,0,0),Ki.set(t[1],0,1,0),Ki.set(t[2],0,0,1),Ki.set(t[3],o.orientation.m00,o.orientation.m01,o.orientation.m02),Ki.set(t[4],o.orientation.m03,o.orientation.m04,o.orientation.m05),Ki.set(t[5],o.orientation.m06,o.orientation.m07,o.orientation.m08);for(let e=0;e<3;++e)Ki.cross(t[6+3*e],t[e],t[3]),Ki.cross(t[7+3*e],t[e],t[4]),Ki.cross(t[7+3*e],t[e],t[5]);Ki.subtract(s,n.center,n.halfExtents),Ki.add(r,n.center,n.halfExtents),mo(s,r,e),yo(o.center,o.halfExtents,t[3],t[4],t[5],i);for(let s=0;s<15;++s){const r=vo(e,t[s]),n=vo(i,t[s]);if(n[0]>r[1]||r[0]>n[1])return 0}return 1}}(),wo=function(t,e){const i=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),s=Ki.dot(e.n,t.center);return s+i<e.d?-1:s-i>e.d?0:1},So=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===wo(t,e.planes[i]))return 0;return 1},xo=function(){const t=new Array(8);let e=0,i=0;for(let e=0;e<t.length;e++)t[e]=new Ki(0,0,0);return function(s,r){let n=0,o=!1;for(let t=0;t<r.planes.length;t++){if(n=wo(s,r.planes[t]),-1===n)return 0;1===n&&(o=!0)}if(!o)return 1;for(let e=0;e<r.vertices.length;e++)Ki.subtract(t[e],r.vertices[e],s.center);e=0,i=0;for(let n=0;n<r.vertices.length;n++)t[n].x>s.halfExtents.x?e++:t[n].x<-s.halfExtents.x&&i++;if(e===r.vertices.length||i===r.vertices.length)return 0;e=0,i=0;for(let n=0;n<r.vertices.length;n++)t[n].y>s.halfExtents.y?e++:t[n].y<-s.halfExtents.y&&i++;if(e===r.vertices.length||i===r.vertices.length)return 0;e=0,i=0;for(let n=0;n<r.vertices.length;n++)t[n].z>s.halfExtents.z?e++:t[n].z<-s.halfExtents.z&&i++;return e===r.vertices.length||i===r.vertices.length?0:1}}(),To=function(){const t=new Ki(0,0,0),e=new ss;return function(i,s){return Ki.subtract(t,s,i.center),Ki.transformMat3(t,t,ss.transpose(e,i.orientation)),r=t,n=i.halfExtents,Math.abs(r.x)<n.x&&Math.abs(r.y)<n.y&&Math.abs(r.z)<n.z;var r,n}}(),Co=function(){const t=function(t,e,i,s){return Math.abs(t.x*e+t.y*i+t.z*s)};return function(e,i){const s=e.halfExtents.x*t(i.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*t(i.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*t(i.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),r=Ki.dot(i.n,e.center);return r+s<i.d?-1:r-s>i.d?0:1}}(),Io=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===Co(t,e.planes[i]))return 0;return 1},Eo=function(){const t=new Array(8);let e=0,i=0,s=0;for(let e=0;e<t.length;e++)t[e]=new Ki(0,0,0);const r=function(t,e,i,s){return t.x*e+t.y*i+t.z*s};return function(n,o){let a=0,h=!1;for(let t=0;t<o.planes.length;t++){if(a=Co(n,o.planes[t]),-1===a)return 0;1===a&&(h=!0)}if(!h)return 1;for(let e=0;e<o.vertices.length;e++)Ki.subtract(t[e],o.vertices[e],n.center);i=0,s=0;for(let a=0;a<o.vertices.length;a++)e=r(t[a],n.orientation.m00,n.orientation.m01,n.orientation.m02),e>n.halfExtents.x?i++:e<-n.halfExtents.x&&s++;if(i===o.vertices.length||s===o.vertices.length)return 0;i=0,s=0;for(let a=0;a<o.vertices.length;a++)e=r(t[a],n.orientation.m03,n.orientation.m04,n.orientation.m05),e>n.halfExtents.y?i++:e<-n.halfExtents.y&&s++;if(i===o.vertices.length||s===o.vertices.length)return 0;i=0,s=0;for(let a=0;a<o.vertices.length;a++)e=r(t[a],n.orientation.m06,n.orientation.m07,n.orientation.m08),e>n.halfExtents.z?i++:e<-n.halfExtents.z&&s++;return i===o.vertices.length||s===o.vertices.length?0:1}}(),Do=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new Ki(0,0,0);const e=new Array(8),i=new Array(8);for(let t=0;t<8;t++)e[t]=new Ki(0,0,0),i[t]=new Ki(0,0,0);return function(s,r){Ki.set(t[0],s.orientation.m00,s.orientation.m01,s.orientation.m02),Ki.set(t[1],s.orientation.m03,s.orientation.m04,s.orientation.m05),Ki.set(t[2],s.orientation.m06,s.orientation.m07,s.orientation.m08),Ki.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Ki.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Ki.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(let e=0;e<3;++e)Ki.cross(t[6+3*e],t[e],t[3]),Ki.cross(t[7+3*e],t[e],t[4]),Ki.cross(t[8+3*e],t[e],t[5]);yo(s.center,s.halfExtents,t[0],t[1],t[2],e),yo(r.center,r.halfExtents,t[3],t[4],t[5],i);for(let s=0;s<15;++s){const r=vo(e,t[s]),n=vo(i,t[s]);if(n[0]>r[1]||r[0]>n[1])return 0}return 1}}(),Ao=function(){const t=new tn,e=new Ki,i=new Ki,s=new Ki,r=new Array(8);for(let t=0;t<8;t++)r[t]=new Ki;const n=new Array(8);for(let t=0;t<8;t++)n[t]=new Ki;return function(o,a){if(0===Ki.squaredDistance(a.ellipseCenter0,a.ellipseCenter1))return t.radius=a.radius,t.center.set(a.ellipseCenter0),ko.sphereOBB(t,o);{e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,i.x=o.orientation.m03,i.y=o.orientation.m04,i.z=o.orientation.m05,s.x=o.orientation.m06,s.y=o.orientation.m07,s.z=o.orientation.m08,yo(o.center,o.halfExtents,e,i,s,r);const t=n,h=Ki.copy(t[0],e),l=Ki.copy(t[1],i),c=Ki.copy(t[2],s);Ki.subtract(t[3],a.center,o.center).normalize();const u=Ki.subtract(t[4],a.ellipseCenter0,a.ellipseCenter1);u.normalize(),Ki.cross(t[5],h,u),Ki.cross(t[6],l,u),Ki.cross(t[7],c,u);for(let e=0;e<8;++e){const i=vo(r,t[e]),s=Ki.dot(t[e],a.ellipseCenter0),n=Ki.dot(t[e],a.ellipseCenter1),o=Math.max(s,n),h=Math.min(s,n)-a.radius,l=o+a.radius;if(h>i[1]||i[0]>l)return 0}return 1}}}(),Mo=function(t,e){const i=Ki.dot(e.n,t.center),s=t.radius*e.n.length();return i+s<e.d?-1:i-s>e.d?0:1},Po=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===Mo(t,e.planes[i]))return 0;return 1},Bo=function(){const t=new Ki(0,0,0),e=[1,-1,1,-1,1,-1];return function(i,s){for(let r=0;r<6;r++){const n=s.planes[r],o=i.radius,a=i.center,h=n.n,l=n.d,c=Ki.dot(h,a);if(c+o<l)return 0;if(!(c-o>l)){Ki.add(t,a,Ki.multiplyScalar(t,h,o));for(let i=0;i<6;i++){if(i===r||i===r+e[r])continue;const n=s.planes[i];if(Ki.dot(n.n,t)<n.d)return 0}}}return 1}}(),Ro=function(t,e){const i=t.radius+e.radius;return Ki.squaredDistance(t.center,e.center)<i*i},Oo=function(){const t=new Ki;return function(e,i){return Nr(t,e.center,i),Ki.squaredDistance(e.center,t)<e.radius*e.radius}}(),Lo=function(){const t=new Ki;return function(e,i){return Ur(t,e.center,i),Ki.squaredDistance(e.center,t)<e.radius*e.radius}}(),Fo=function(){const t=new Ki,e=new Ki;return function(i,s){const r=i.radius+s.radius,n=r*r,o=Ki.squaredDistance(s.ellipseCenter0,s.ellipseCenter1);if(0===o)return Ki.squaredDistance(i.center,s.center)<n;{Ki.subtract(t,i.center,s.ellipseCenter0),Ki.subtract(e,s.ellipseCenter1,s.ellipseCenter0);const r=Ki.dot(t,e)/o;return r<0?Ki.squaredDistance(i.center,s.ellipseCenter0)<n:r>1?Ki.squaredDistance(i.center,s.ellipseCenter1)<n:(Ki.scaleAndAdd(t,s.ellipseCenter0,e,r),Ki.squaredDistance(i.center,t)<n)}}}(),zo=function(){const t=new Ki,e=new Ki,i=new Ki,s=new Ki,r=new Ki,n=new Ki;return function(o,a){const h=Ki.subtract(t,o.ellipseCenter1,o.ellipseCenter0),l=Ki.subtract(e,a.ellipseCenter1,a.ellipseCenter0),c=Ki.subtract(i,o.ellipseCenter0,a.ellipseCenter0),u=Ki.dot(h,h),d=Ki.dot(h,l),p=Ki.dot(l,l),_=Ki.dot(h,c),g=Ki.dot(l,c),f=u*p-d*d;let m,y,v=f,b=f;f<pi?(m=0,v=1,y=g,b=p):(m=d*g-p*_,y=u*g-d*_,m<0?(m=0,y=g,b=p):m>v&&(m=v,y=g+d,b=p)),y<0?(y=0,-_<0?m=0:-_>u?m=v:(m=-_,v=u)):y>b&&(y=b,-_+d<0?m=0:-_+d>u?m=v:(m=-_+d,v=u));const w=Math.abs(m)<pi?0:m/v,S=Math.abs(y)<pi?0:y/b,x=s;x.set(c),x.add(Ki.multiplyScalar(r,h,w)),x.subtract(Ki.multiplyScalar(n,l,S));const T=o.radius+a.radius;return x.lengthSqr()<T*T}}(),ko={raySphere:ro,rayAABB:no,rayOBB:ao,rayPlane:io,rayTriangle:so,rayCapsule:ho,raySubMesh:null,rayMesh:null,rayModel:null,lineSphere:go,lineAABB:po,lineOBB:_o,linePlane:lo,lineTriangle:co,sphereWithSphere:Ro,sphereAABB:Oo,sphereOBB:Lo,spherePlane:Mo,sphereFrustum:Po,sphereFrustumAccurate:Bo,sphereCapsule:Fo,aabbWithAABB:fo,aabbWithOBB:bo,aabbPlane:wo,aabbFrustum:So,aabbFrustumAccurate:xo,obbWithOBB:Do,obbPlane:Co,obbFrustum:Io,obbFrustumAccurate:Eo,obbPoint:To,obbCapsule:Ao,aabbFrustumCompletelyInside:function(t,e){for(let i=0;i<e.planes.length;i++)if(0!==wo(t,e.planes[i]))return 0;return 1},capsuleWithCapsule:zo,resolve(t,e,i){void 0===i&&(i=null);const s=t._type,r=e._type,n=this[s|r];return s<r?n(t,e,i):n(e,t,i)}};ko[5]=ro,ko[9]=no,ko[17]=ao,ko[33]=io,ko[65]=so,ko[513]=ho,ko[6]=go,ko[10]=po,ko[18]=_o,ko[34]=lo,ko[66]=co,ko[4]=Ro,ko[12]=Oo,ko[20]=Lo,ko[36]=Mo,ko[132]=Po,ko[260]=Bo,ko[516]=Fo,ko[8]=fo,ko[24]=bo,ko[40]=wo,ko[136]=So,ko[264]=xo,ko[16]=Do,ko[48]=Co,ko[144]=Io,ko[272]=Eo,ko[528]=Ao,ko[512]=zo;const No=new Ki,Uo=new Ki,Vo=new ss;class Ho{static create(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_){return new Ho(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_)}static clone(t){return new Ho(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}static copy(t,e){return Ki.copy(t.center,e.center),Ki.copy(t.halfExtents,e.halfExtents),ss.copy(t.orientation,e.orientation),t}static fromPoints(t,e,i){return Ki.multiplyScalar(t.center,Ki.add(No,e,i),.5),Ki.multiplyScalar(t.halfExtents,Ki.subtract(Uo,i,e),.5),ss.identity(t.orientation),t}static set(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_,g){return Ki.set(t.center,e,i,s),Ki.set(t.halfExtents,r,n,o),ss.set(t.orientation,a,h,l,c,u,d,p,_,g),t}get type(){return this._type}constructor(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=1),void 0===r&&(r=1),void 0===n&&(n=1),void 0===o&&(o=1),void 0===a&&(a=0),void 0===h&&(h=0),void 0===l&&(l=0),void 0===c&&(c=1),void 0===u&&(u=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===_&&(_=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=16,this.center=new Ki(t,e,i),this.halfExtents=new Ki(s,r,n),this.orientation=new ss(o,a,h,l,c,u,d,p,_)}getBoundary(t,e){var i,s,r;i=No,s=this.halfExtents,r=this.orientation,Vo.m00=Math.abs(r.m00),Vo.m01=Math.abs(r.m01),Vo.m02=Math.abs(r.m02),Vo.m03=Math.abs(r.m03),Vo.m04=Math.abs(r.m04),Vo.m05=Math.abs(r.m05),Vo.m06=Math.abs(r.m06),Vo.m07=Math.abs(r.m07),Vo.m08=Math.abs(r.m08),Ki.transformMat3(i,s,Vo),Ki.subtract(t,this.center,No),Ki.add(e,this.center,No)}transform(t,e,i,s,r){Ki.transformMat4(r.center,this.center,t),ss.fromQuat(r.orientation,i),Ki.multiply(r.halfExtents,this.halfExtents,s)}translateAndRotate(t,e,i){Ki.transformMat4(i.center,this.center,t),ss.fromQuat(i.orientation,e)}setScale(t,e){Ki.multiply(e.halfExtents,this.halfExtents,t)}}function Go(t,e,i){void 0===i&&(i=1e-6);let s=0,r=t.length-1,n=r>>>1;for(;s<=r;n=s+r>>>1){const o=t[n];if(o>e+i)r=n-1;else{if(!(o<e-i))return n;s=n+1}}return~s}let Wo;Wo=Symbol.iterator;class jo{constructor(){this._times=[],this._values=[]}get keyFramesCount(){return this._times.length}get rangeMin(){return this._times[0]}get rangeMax(){return this._times[this._values.length-1]}[Wo](){let t=0;return{next:()=>{if(t>=this._times.length)return{done:!0,value:void 0};{const e=[this._times[t],this._values[t]];return++t,{done:!1,value:e}}}}}keyframes(){return this}times(){return this._times}values(){return this._values}getKeyframeTime(t){return this._times[t]}getKeyframeValue(t){return this._values[t]}addKeyFrame(t,e){return this._insertNewKeyframe(t,e)}removeKeyframe(t){this._times.splice(t,1),this._values.splice(t,1)}indexOfKeyframe(t){return Go(this._times,t)}updateTime(t,e){const i=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,i)}assignSorted(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{const e=Array.from(t);this.setKeyframes(e.map((t=>{let[e]=t;return e})),e.map((t=>{let[,e]=t;return e})))}}clear(){this._times.length=0,this._values.length=0}searchKeyframe(t){return Go(this._times,t)}setKeyframes(t,e){t.length,e.length,$o(t),this._times=t,this._values=e}_insertNewKeyframe(t,e){const i=this._times,s=this._values,r=i.length,n=Go(i,t);if(n>=0)return n;const o=~n;return 0===o?(i.unshift(t),s.unshift(e)):o===r?(i.push(t),s.push(e)):(i.splice(o-1,0,t),s.splice(o-1,0,e)),o}}function $o(t){return t.every(((t,e,i)=>0===e||t>i[e-1]||gi(t,i[e-1],1e-6)))}function qo(t,e,i,s,r){const n=i/s,o=e/s,a=n*n,h=1/3*(-1/3*a+o),l=.5*(2/27*n*a-1/3*n*o+t/s),c=h*h*h,u=l*l+c;let d=0;if(Yo(u)){if(Yo(l))return r[0]=0,1;{const t=Math.cbrt(-l);return r[0]=2*t,r[1]=-t,2}}if(u<0){const t=1/3*Math.acos(-l/Math.sqrt(-c)),e=2*Math.sqrt(-h);r[0]=e*Math.cos(t),r[1]=-e*Math.cos(t+Math.PI/3),r[2]=-e*Math.cos(t-Math.PI/3),d=3}else{const t=Math.sqrt(u),e=Math.cbrt(t-l),i=-Math.cbrt(t+l);r[0]=e+i,d=1}const p=1/3*n;for(let t=0;t<d;++t)r[t]-=p;return d}ri.fastDefine("cc.KeyframeCurve",jo,{_times:[],_values:[]}),t("RealInterpolationMode",{LINEAR:0,CONSTANT:1,CUBIC:2}),t("ExtrapolationMode",{LINEAR:0,CLAMP:1,LOOP:2,PING_PONG:3}),t("TangentWeightMode",{NONE:0,LEFT:1,RIGHT:2,BOTH:3});const Xo=1e-9;function Yo(t){return t>-Xo&&t<Xo}function Qo(t,e,i,s){return i.slice().reverse().reduce((function(i,s){return s(t,e,i)||i}),s)}const Ko=()=>{},Zo=()=>Ko,Jo=ta((()=>{}));function ta(t){return function(e){return"function"==typeof e?t(e):function(i){return t(i,e)}}}function ea(t,e,i){const s=ra(t);if(s){const t=na(s,"proto");na(t,"editor")[e]=i}}function ia(t){return e=>i=>{ea(i,t,e)}}const sa="__ccclassCache__";function ra(t){return na(t,sa)}function na(t,e){return t[e]||(t[e]={})}const oa=ta(((t,e)=>{let i=Ct(t);i===Object&&(i=null);const s={name:e,extends:i,ctor:t},r=t[sa];if(r){const e=r.proto;e&&xt(s,e),t[sa]=void 0}return ri(s)})),aa=ia("requireComponent"),ha=ia("executionOrder"),la=Jo;function ca(t,e,i){let s=null;function r(t,e,i){fa(pa(t),_a(t,e),t.constructor,e,s,i)}return void 0===t?ca({type:void 0}):void 0===e?(s=t,r):void r(t,e,i)}function ua(t){let e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}function da(t){let e;try{e=new t}catch(t){return{}}return e}function pa(t){return ra(t.constructor)}function _a(t,e){var i,s;const r=na(ra(t.constructor),"proto"),n=na(r,"properties");return null!==(s=n[i=e])&&void 0!==s?s:n[i]={}}function ga(t,e,i){var s,r;const n=ra(t.constructor),o=na(n,"proto"),a=na(o,"properties"),h=null!==(r=a[s=e])&&void 0!==r?r:a[s]={};return h.__internalFlags|=1,i&&"function"!=typeof i&&(i.get||i.set)?(i.get&&(h.get=i.get),i.set&&(h.set=i.set)):ma(n,h,t.constructor,e,i),h}function fa(t,e,i,s,r,n){let o;const a=n&&"function"!=typeof n&&(n.get||n.set);r&&(o=Ue(r,a));const h=xt(e,o||r||{});a?(n.get&&(h.get=n.get),n.set&&(h.set=n.set)):ma(t,h,i,s,n)}function ma(t,e,i,s,r){if(void 0!==r)"function"==typeof r?e.default=ua(r):null===r||r.initializer&&(e.default=ua(r.initializer));else{const r=t.default||(t.default=da(i));r.hasOwnProperty(s)&&(e.default=r[s])}}const ya=Symbol("cc:SerializationMetadata"),va=t("serializable",((t,e,i)=>{Sa(ga(t,e,i))}));function ba(t){return(e,i,s)=>{const r=ga(e,i,s);r.formerlySerializedAs=t,Sa(r)}}const wa=(t,e,i)=>{const s=ga(t,e,i);s.editorOnly=!0,Sa(s)};function Sa(t){t.__internalFlags|=4}const xa=Ko,Ta=Jo,Ca=Zo,Ia=Jo,Ea=Zo,Da=Zo,Aa=Zo,Ma=t("editable",Ko),Pa=t("visible",Zo),Ba=t("displayName",Zo),Ra=t("tooltip",Zo),Oa=t("range",Zo),La=t("rangeStep",Zo),Fa=t("slide",Ko),za=t("displayOrder",Zo),ka=t("disallowAnimation",Ko),Na=Ga(Me),Ua=Ga(Pe),Va=Ga(Be),Ha=Ga(Re);function Ga(t){return ca({type:t})}const Wa=t("override",((t,e,i)=>{ga(t,e,i).override=!0}));const ja=t("EditorExtendable",class{});var $a,qa,Xa,Ya,Qa,Ka,Za,Ja=Object.freeze({__proto__:null,boolean:Va,ccclass:oa,disallowAnimation:ka,disallowMultiple:la,displayName:Ba,displayOrder:za,editable:Ma,executeInEditMode:Ta,executionOrder:ha,float:Ua,formerlySerializedAs:ba,help:Aa,icon:Da,inspector:Ea,integer:Na,menu:Ca,override:Wa,playOnFocus:Ia,property:ca,range:Oa,rangeStep:La,requireComponent:aa,serializable:va,slide:Fa,string:Ha,tooltip:Ra,type:Ga,uniquelyReferenced:xa,visible:Pa});function th(t,e){return(e<<3)+t}function eh(t){return sh[t]}function ih(t){switch(t){case 0:return Uint8Array;case 1:return Uint16Array;case 2:return Uint32Array;case 3:return Int8Array;case 4:return Int16Array;case 5:return Int32Array;case 6:return Float32Array;case 7:return Float64Array}}t("_decorator",Ja),t("CompactValueTypeArray",oa("cc.CompactValueTypeArray")((Za=class t{constructor(){this._byteOffset=Xa&&Xa(),this._unitCount=Ya&&Ya(),this._unitElement=Qa&&Qa(),this._length=Ka&&Ka()}static lengthFor(t,e,i){return eh(e).requiredUnits*t.length*ih(i).BYTES_PER_ELEMENT}static compress(e,i,s,r,n,o){const a=eh(i),h=ih(s),l=a.requiredUnits*e.length,c=new h(r,n,l);for(let t=0;t<e.length;++t)a.compress(c,t,e[t]);const u=new t;return u._unitElement=th(s,i),u._byteOffset=o,u._unitCount=l,u._length=e.length,u}decompress(t){const{storageUnit:e,elementType:i}={storageUnit:7&(s=this._unitElement),elementType:s>>3};var s;const r=eh(i),n=new(ih(e))(t,this._byteOffset,this._unitCount),o=new Array(this._length);for(let t=0;t<this._length;++t)o[t]=r.decompress(n,t);return o}},Za.StorageUnit={Uint8:0,Uint16:1,Uint32:2,Int8:3,Int16:4,Int32:5,Float32:6,Float64:7},Za.ElementType={Scalar:0,Vec2:1,Vec3:2,Vec4:3,Quat:4,Mat4:5},Xa=Qo((qa=Za).prototype,"_byteOffset",[va],(function(){return 0})),Ya=Qo(qa.prototype,"_unitCount",[va],(function(){return 0})),Qa=Qo(qa.prototype,"_unitElement",[va],(function(){return th(0,0)})),Ka=Qo(qa.prototype,"_length",[va],(function(){return 0})),$a=qa))||$a);const sh={0:{requiredUnits:1,compress(t,e,i){t[e]=i},decompress:(t,e)=>t[e]},1:{requiredUnits:2,compress(t,e,i){t[2*e]=i.x,t[2*e+1]=i.y},decompress:(t,e)=>new Ki(t[2*e],t[2*e+1])},2:{requiredUnits:3,compress(t,e,i){t[3*e]=i.x,t[3*e+1]=i.y,t[3*e+2]=i.z},decompress:(t,e)=>new Ki(t[3*e],t[3*e+1],t[3*e+2])},3:{requiredUnits:4,compress(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:(t,e)=>new cr(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},4:{requiredUnits:4,compress(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:(t,e)=>new ys(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},5:{requiredUnits:16,compress(t,e,i){Rs.toArray(t,i,16*e)},decompress:(t,e)=>Rs.fromArray(new Rs,t,16*e)}},rh=t("serializeTag",Symbol("[[Serialize]]")),nh=t("deserializeTag",Symbol("[[Deserialize]]"));function oh(){return 0}function ah(t){return t}function hh(t){return t*t}function lh(t){return t*(2-t)}function ch(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}function uh(t){return t*t*t}function dh(t){return--t*t*t+1}function ph(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}function _h(t){return t*t*t*t}function gh(t){return 1- --t*t*t*t}function fh(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}function mh(t){return t*t*t*t*t}function yh(t){return--t*t*t*t*t+1}function vh(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}function bh(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function wh(t){return Math.sin(t*Math.PI/2)}function Sh(t){return.5*(1-Math.cos(Math.PI*t))}function xh(t){return 0===t?0:1024**(t-1)}function Th(t){return 1===t?1:1-2**(-10*t)}function Ch(t){return 0===t?0:1===t?1:(t*=2)<1?.5*1024**(t-1):.5*(2-2**(-10*(t-1)))}function Ih(t){return 1-Math.sqrt(1-t*t)}function Eh(t){return Math.sqrt(1- --t*t)}function Dh(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}function Ah(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),-i*2**(10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function Mh(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),i*2**(-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function Ph(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?i*2**(10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:i*2**(-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)}function Bh(t){if(1===t)return 1;const e=1.70158;return t*t*((e+1)*t-e)}function Rh(t){if(0===t)return 0;const e=1.70158;return--t*t*((e+1)*t+e)+1}function Oh(t){const e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}function Lh(t){return 1-Fh(1-t)}function Fh(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function zh(t){return t<.5?.5*Lh(2*t):.5*Fh(2*t-1)+.5}function kh(t){return t<=0?0:t>=1?1:t*t*(3-2*t)}function Nh(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)}l._decorator=Ja;const Uh=Qh(hh,lh),Vh=Qh(uh,dh),Hh=Qh(_h,gh),Gh=Qh(mh,yh),Wh=Qh(bh,wh),jh=Qh(xh,Th),$h=Qh(Ih,Eh),qh=Qh(Ah,Mh),Xh=Qh(Bh,Rh),Yh=Qh(Lh,Fh);function Qh(t,e){return i=>i<.5?e(2*i)/2:t(2*i-1)/2+.5}var Kh=Object.freeze({__proto__:null,backIn:Bh,backInOut:Oh,backOut:Rh,backOutIn:Xh,bounceIn:Lh,bounceInOut:zh,bounceOut:Fh,bounceOutIn:Yh,circIn:Ih,circInOut:Dh,circOut:Eh,circOutIn:$h,constant:oh,cubicIn:uh,cubicInOut:ph,cubicOut:dh,cubicOutIn:Vh,elasticIn:Ah,elasticInOut:Ph,elasticOut:Mh,elasticOutIn:qh,expoIn:xh,expoInOut:Ch,expoOut:Th,expoOutIn:jh,fade:Nh,linear:ah,quadIn:hh,quadInOut:ch,quadOut:lh,quadOutIn:Uh,quartIn:_h,quartInOut:fh,quartOut:gh,quartOutIn:Hh,quintIn:mh,quintInOut:vh,quintOut:yh,quintOutIn:Gh,sineIn:bh,sineInOut:Sh,sineOut:wh,sineOutIn:Wh,smooth:kh});t("easing",Kh),t("EasingMethod",{LINEAR:0,CONSTANT:1,QUAD_IN:2,QUAD_OUT:3,QUAD_IN_OUT:4,QUAD_OUT_IN:5,CUBIC_IN:6,CUBIC_OUT:7,CUBIC_IN_OUT:8,CUBIC_OUT_IN:9,QUART_IN:10,QUART_OUT:11,QUART_IN_OUT:12,QUART_OUT_IN:13,QUINT_IN:14,QUINT_OUT:15,QUINT_IN_OUT:16,QUINT_OUT_IN:17,SINE_IN:18,SINE_OUT:19,SINE_IN_OUT:20,SINE_OUT_IN:21,EXPO_IN:22,EXPO_OUT:23,EXPO_IN_OUT:24,EXPO_OUT_IN:25,CIRC_IN:26,CIRC_OUT:27,CIRC_IN_OUT:28,CIRC_OUT_IN:29,ELASTIC_IN:30,ELASTIC_OUT:31,ELASTIC_IN_OUT:32,ELASTIC_OUT_IN:33,BACK_IN:34,BACK_OUT:35,BACK_IN_OUT:36,BACK_OUT_IN:37,BOUNCE_IN:38,BOUNCE_OUT:39,BOUNCE_IN_OUT:40,BOUNCE_OUT_IN:41,SMOOTH:42,FADE:43});const Zh={1:oh,0:ah,2:hh,3:lh,4:ch,5:Uh,6:uh,7:dh,8:ph,9:Vh,10:_h,11:gh,12:fh,13:Hh,14:mh,15:yh,16:vh,17:Gh,18:bh,19:wh,20:Sh,21:Wh,22:xh,23:Th,24:Ch,25:jh,26:Ih,27:Eh,28:Dh,29:$h,30:Ah,31:Mh,32:Ph,33:qh,34:Bh,35:Rh,36:Oh,37:Xh,38:Lh,39:Fh,40:zh,41:Yh,42:kh,43:Nh};function Jh(t){return Zh[t]}f(255),f(65280);class tl extends ja{constructor(){super(),this.value=0,this.rightTangent=0,this.rightTangentWeight=0,this.leftTangent=0,this.leftTangentWeight=0,this._flags=0}get interpolationMode(){return 255&this._flags}set interpolationMode(t){this._flags&=-256,this._flags|=0|t}get tangentWeightMode(){return(65280&this._flags)>>8}set tangentWeightMode(t){this._flags&=-65281,this._flags|=t<<8}get easingMethod(){return(16711680&this._flags)>>16}set easingMethod(t){this._flags&=-16711681,this._flags|=t<<16}}var el,il,sl;function rl(t){const e=new tl;if("number"==typeof t)e.value=t;else{const{interpolationMode:i,tangentWeightMode:s,value:r,rightTangent:n,rightTangentWeight:o,leftTangent:a,leftTangentWeight:h,easingMethod:l,[an]:c}=t;e.value=null!=r?r:e.value,e.rightTangent=null!=n?n:e.rightTangent,e.rightTangentWeight=null!=o?o:e.rightTangentWeight,e.leftTangent=null!=a?a:e.leftTangent,e.leftTangentWeight=null!=h?h:e.leftTangentWeight,e.interpolationMode=null!=i?i:e.interpolationMode,e.tangentWeightMode=null!=s?s:e.tangentWeightMode,e.easingMethod=null!=l?l:e.easingMethod,c&&(e[an]=c)}return e}ri.fastDefine("cc.RealKeyframeValue",tl,{interpolationMode:0,tangentWeightMode:0,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:0,[an]:void 0}),ri.Attr.setClassAttr(tl,an,"editorOnly",!0),(el=tl,null!==(sl=(il=el)[ya])&&void 0!==sl?sl:il[ya]={}).uniquelyReferenced=!0;class nl extends jo{constructor(){super(),this.preExtrapolation=1,this.postExtrapolation=1}evaluate(t){const{_times:e,_values:i}=this,s=e.length;if(0===s)return 0;const r=e[0],n=e[s-1];if(t<r){const{preExtrapolation:o}=this,a=i[0];if(1===o||s<2)return a.value;switch(o){case 0:return Ml(r,i[0].value,e[1],i[1].value,t);case 2:t=Dl(t,r,n);break;case 3:t=Al(t,r,n);break;default:return a.value}}else if(t>n){const{postExtrapolation:o}=this,a=i[s-1];if(1===o||s<2)return a.value;switch(o){case 0:return Ml(n,a.value,e[s-2],i[s-2].value,t);case 2:t=Dl(t,r,n);break;case 3:t=Al(t,r,n);break;default:return a.value}}const o=Go(e,t);if(o>=0)return i[o].value;const a=~o,h=a-1,l=e[h],c=i[h],u=e[a];return Pl(l,c,u,i[a],(t-l)/(u-l))}addKeyFrame(t,e){return super.addKeyFrame(t,rl(e))}assignSorted(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((t=>rl(t))));else{const e=Array.from(t);this.setKeyframes(e.map((t=>{let[e]=t;return e})),e.map((t=>{let[,e]=t;return rl(e)})))}}isConstant(t){if(this._values.length<=1)return!0;const e=this._values[0].value;return this._values.every((i=>gi(i.value,e,t)))}[rh](t,e){if(!e.toCCON)return void t.writeThis();const{_times:i,_values:s}=this,r=i.length,n=new DataView(new ArrayBuffer(0+hl+hl+ll+cl*r+Cl*r));let o=0;n.setUint8(o,this.preExtrapolation),o+=hl,n.setUint8(o,this.postExtrapolation),o+=hl,n.setUint32(o,r,!0),o+=ll,i.forEach(((t,e)=>n.setFloat32(o+cl*e,t,!0))),o+=cl*r;for(const t of s)o=Il(n,t,o);const a=new Uint8Array(n.buffer,0,o);t.writeProperty("bytes",a);const h=s.map((t=>t[an]));h.some((t=>void 0!==t))&&t.writeProperty("keyframeValueEditorExtras",h)}[nh](t,e){if(!e.fromCCON)return void t.readThis();const i=t.readProperty("bytes"),s=new DataView(i.buffer,i.byteOffset,i.byteLength);let r=0;this.preExtrapolation=s.getUint8(r),r+=hl,this.postExtrapolation=s.getUint8(r),r+=hl;const n=s.getUint32(r,!0);r+=ll;const o=Array.from({length:n},((t,e)=>s.getFloat32(r+cl*e,!0)));r+=cl*n;const a=new Array(n);for(let t=0;t<n;++t){const e=rl({});r=El(s,e,r),a[t]=e}i.byteLength;const h=t.readProperty("keyframeValueEditorExtras");h&&(h.length,h.forEach(((t,e)=>a[e][an]=t))),this._times=o,this._values=a}}t("RealCurve",nl),ri.fastDefine("cc.RealCurve",nl,{_times:[],_values:[],preExtrapolation:1,postExtrapolation:1});const ol=8,al=255<<ol,hl=1,ll=4,cl=4,ul=4,dl=4,pl=1,_l=1,gl=4,fl=4,ml=4,yl=4,{interpolationMode:vl,tangentWeightMode:bl,leftTangent:wl,leftTangentWeight:Sl,rightTangent:xl,rightTangentWeight:Tl}=rl({}),Cl=ul+dl+pl+_l+gl+fl+ml+yl+0;function Il(t,e,i){let s=0,r=i;const n=r;r+=ul;const{value:o,interpolationMode:a,tangentWeightMode:h,rightTangent:l,rightTangentWeight:c,leftTangent:u,leftTangentWeight:d,easingMethod:p}=e;return t.setFloat32(r,o,!0),r+=dl,a!==vl&&(s|=2,t.setUint8(r,a),r+=pl),h!==bl&&(s|=4,t.setUint8(r,h),r+=_l),u!==wl&&(s|=8,t.setFloat32(r,u,!0),r+=gl),d!==Sl&&(s|=16,t.setFloat32(r,d,!0),r+=fl),l!==xl&&(s|=32,t.setFloat32(r,l,!0),r+=ml),c!==Tl&&(s|=64,t.setFloat32(r,c,!0),r+=yl),s|=p<<ol,t.setUint32(n,s,!0),r}function El(t,e,i){let s=i;const r=t.getUint32(s,!0);s+=ul,e.value=t.getFloat32(s,!0),s+=dl,2&r&&(e.interpolationMode=t.getUint8(s),s+=pl),4&r&&(e.tangentWeightMode=t.getUint8(s),s+=_l),8&r&&(e.leftTangent=t.getFloat32(s,!0),s+=gl),16&r&&(e.leftTangentWeight=t.getFloat32(s,!0),s+=fl),32&r&&(e.rightTangent=t.getFloat32(s,!0),s+=ml),64&r&&(e.rightTangentWeight=t.getFloat32(s,!0),s+=yl);const n=(r&al)>>ol;return e.easingMethod=n,s}function Dl(t,e,i){return e+Ai(t-e,i-e)}function Al(t,e,i){return e+Mi(t-e,i-e)}function Ml(t,e,i,s,r){return e+(s-e)/(i-t)*(r-t)}function Pl(t,e,i,s,r){const n=i-t;switch(e.interpolationMode){default:case 1:return e.value;case 0:{const t=0===e.easingMethod?r:Jh(e.easingMethod)(r);return yi(e.value,s.value,t)}case 2:{const o=1/3,{rightTangent:a,rightTangentWeight:h}=e,l=!!(2&e.tangentWeightMode),{leftTangent:c,leftTangentWeight:u}=s,d=!!(1&s.tangentWeightMode);if(l||d){let p=0;if(l)p=h;else{const t=n,e=n*a;p=Math.sqrt(t*t+e*e)*o}const _=Math.atan(a),g=Math.cos(_)*p+t,f=Math.sin(_)*p+e.value;let m=0;if(d)m=u;else{const t=n,e=n*c;m=Math.sqrt(t*t+e*e)*o}const y=Math.atan(c),v=(g-t)/n,b=(-Math.cos(y)*m+i-t)/n,w=f,S=-Math.sin(y)*m+s.value,x=[0,0,0],T=Rl(x,qo(0-r,3*v,3*b-6*v,3*(v-b)+1,x),r);return Bl(e.value,w,S,s.value,T)}{const t=e.value+o*a*n,i=s.value-o*c*n;return Bl(e.value,t,i,s.value,r)}}}}function Bl(t,e,i,s,r){const n=1-r;return n*n*n*t+3*n*n*r*e+3*n*r*r*i+r*r*r*s}function Rl(t,e,i){let s=i;if(1===e)s=t[0];else{s=-1/0;for(let i=0;i<e;++i){const e=t[i];e>=0&&e<=1&&e>s&&(s=e)}s===-1/0&&(s=0)}return s}function Ol(t,e,i,s,r){const n=1-r;return n*(n*(t+(3*e-t)*r)+3*i*r*r)+s*r*r*r}l.bezier=Ol;const Ll=Math.cos,Fl=Math.acos,zl=Math.max,kl=2*Math.PI,Nl=Math.sqrt;function Ul(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function Vl(t,e){const i=e-0,s=e-t[0],r=3*i,n=3*s,o=3*(e-t[2]),a=1/(-i+n-o+(e-1)),h=1/3,l=(r-6*s+o)*a,c=l*h,u=(-r+n)*a,d=(3*u-l*l)*h,p=d*h,_=(2*l*l*l-9*l*u+i*a*27)/27,g=_/2,f=g*g+p*p*p;let m,y,v,b,w;if(f<0){const t=-d*h,e=Nl(t*t*t),i=-_/(2*e),s=Fl(i<-1?-1:i>1?1:i),r=2*Ul(e);return v=r*Ll(s*h)-c,b=r*Ll((s+kl)*h)-c,w=r*Ll((s+2*kl)*h)-c,v>=0&&v<=1?b>=0&&b<=1?w>=0&&w<=1?zl(v,b,w):zl(v,b):w>=0&&w<=1?zl(v,w):v:b>=0&&b<=1?w>=0&&w<=1?zl(b,w):b:w}if(0===f)return m=g<0?Ul(-g):-Ul(g),v=2*m-c,b=-m-c,v>=0&&v<=1?b>=0&&b<=1?zl(v,b):v:b;{const t=Nl(f);return m=Ul(-g+t),y=Ul(g+t),v=m-y-c,v}}function Hl(t,e){const i=Vl(t,e),s=t[1];return((1-i)*(s+(t[3]-s)*i)*3+i*i)*i}var Gl,Wl,jl,$l,ql,Xl,Yl,Ql,Kl;l.bezierByTime=Hl,t("QuatInterpolationMode",{SLERP:0,CONSTANT:1});let Zl=oa("cc.QuatKeyframeValue")(Gl=xa((Wl=class{constructor(t){let{value:e,interpolationMode:i,easingMethod:s}=void 0===t?{}:t;this.interpolationMode=jl&&jl(),this.value=$l&&$l(),this.easingMethod=ql&&ql(),this.value=e?ys.clone(e):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=s?s:this.easingMethod}},jl=Qo(Wl.prototype,"interpolationMode",[va],(function(){return 0})),$l=Qo(Wl.prototype,"value",[va],(function(){return ys.clone(ys.IDENTITY)})),ql=Qo(Wl.prototype,"easingMethod",[va],(function(){return 0})),Gl=Wl))||Gl)||Gl;function Jl(t){return new Zl(t)}let tc=t("QuatCurve",oa("cc.QuatCurve")((Yl=class extends jo{constructor(){super(),this.preExtrapolation=Ql&&Ql(),this.postExtrapolation=Kl&&Kl()}evaluate(t,e){var i;null!==(i=e)&&void 0!==i||(e=new ys);const{_times:s,_values:r,postExtrapolation:n,preExtrapolation:o}=this,a=s.length;if(0===a)return e;const h=s[0],l=s[a-1];if(t<h){const i=r[0];switch(o){case 2:t=h+Ai(t-h,l-h);break;case 3:t=h+Mi(t-h,l-h);break;default:return ys.copy(e,i.value)}}else if(t>l){const i=r[a-1];switch(n){case 2:t=h+Ai(t-h,l-h);break;case 3:t=h+Mi(t-h,l-h);break;default:return ys.copy(e,i.value)}}const c=Go(s,t);if(c>=0)return ys.copy(e,r[c].value);const u=~c,d=u-1,p=s[d],_=r[d],g=s[u],f=r[u],m=(t-p)/(g-p);switch(_.interpolationMode){default:case 1:return ys.copy(e,_.value);case 0:{const{easingMethod:t}=_,i=0===t?m:Array.isArray(t)?Hl(t,m):Jh(t)(m);return ys.slerp(e,_.value,f.value,i)}}}addKeyFrame(t,e){const i=new Zl(e);return super.addKeyFrame(t,i)}assignSorted(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((t=>Jl(t))));else{const e=Array.from(t);this.setKeyframes(e.map((t=>{let[e]=t;return e})),e.map((t=>{let[,e]=t;return Jl(e)})))}}[rh](t,e){if(!e.toCCON)return void t.writeThis();const{_times:i,_values:s}=this;let r=!0;s.forEach(((t,e,i)=>{let[s]=i;r&&t.interpolationMode!==s.interpolationMode&&(r=!1)}));const n=i.length,o=nc*(r?1:n),a=s.reduce(((t,e)=>{let{easingMethod:i}=e;return t+(Array.isArray(i)?oc+4*hc:oc)}),0);let h=0;h+=ec+ic+sc*n+4*rc*n+a+o+0;const l=new DataView(new ArrayBuffer(h));let c=0,u=0;r&&(u|=1),l.setUint32(c,u,!0),c+=ec,l.setUint32(c,n,!0),c+=ic,i.forEach(((t,e)=>l.setFloat32(c+sc*e,t,!0))),c+=sc*n,s.forEach(((t,e)=>{let{value:{x:i,y:s,z:r,w:n}}=t;const o=c+4*rc*e;l.setFloat32(o+0*rc,i,!0),l.setFloat32(o+1*rc,s,!0),l.setFloat32(o+2*rc,r,!0),l.setFloat32(o+3*rc,n,!0)})),c+=4*rc*n,s.forEach((t=>{let{easingMethod:e}=t;Array.isArray(e)?(l.setUint8(c,ac),++c,l.setFloat32(c+0*hc,e[0],!0),l.setFloat32(c+1*hc,e[1],!0),l.setFloat32(c+2*hc,e[2],!0),l.setFloat32(c+3*hc,e[3],!0),c+=4*hc):(l.setUint8(c,e),++c)}));const d=c;c+=o;let p=d;s.forEach((t=>{let{interpolationMode:e}=t;l.setUint8(p,e),r||(p+=nc)}));const _=new Uint8Array(l.buffer);t.writeProperty("bytes",_)}[nh](t,e){if(!e.fromCCON)return void t.readThis();const i=t.readProperty("bytes"),s=new DataView(i.buffer,i.byteOffset,i.byteLength);let r=0;const n=s.getUint32(r,!0);r+=ec;const o=1&n,a=s.getUint32(r,!0);r+=ic;const h=Array.from({length:a},((t,e)=>s.getFloat32(r+sc*e,!0)));r+=sc*a;const l=r;r+=4*rc*a;const c=Array.from({length:a},((t,e)=>{const i=l+4*rc*e,n=s.getFloat32(i+0*rc,!0),o=s.getFloat32(i+1*rc,!0),a=s.getFloat32(i+2*rc,!0),h=s.getFloat32(i+3*rc,!0),c=s.getUint8(r);++r;const u=Jl({value:{x:n,y:o,z:a,w:h}});return c!==ac?u.easingMethod=c:(u.easingMethod=[s.getFloat32(r+0*hc,!0),s.getFloat32(r+1*hc,!0),s.getFloat32(r+2*hc,!0),s.getFloat32(r+3*hc,!0)],r+=4*hc),u}));if(o){const t=s.getUint8(r);++r;for(let e=0;e<a;++e)c[e].interpolationMode=t}else{for(let t=0;t<a;++t){const e=s.getUint8(r+t);c[t].interpolationMode=e}r+=a}this._times=h,this._values=c}},Ql=Qo(Yl.prototype,"preExtrapolation",[va],(function(){return 1})),Kl=Qo(Yl.prototype,"postExtrapolation",[va],(function(){return 1})),Xl=Yl))||Xl);const ec=1,ic=4,sc=4,rc=4,nc=1,oc=1,ac=255,hc=4;var lc;let cc=t("ObjectCurve",oa("cc.ObjectCurve")(lc=class extends jo{evaluate(t){const e=this.searchKeyframe(t);if(e>=0)return this._values[e];const i=fi(~e-1,0,this._values.length-1);return this._values[i]}})||lc);const uc=te({Blend:0,Fixed:1});class dc{constructor(){this.color=_r.WHITE.clone(),this.time=0}}t("ColorKey",dc),ri.fastDefine("cc.ColorKey",dc,{color:_r.WHITE.clone(),time:0}),ri.Attr.setClassAttr(dc,"color","visible",!0),ri.Attr.setClassAttr(dc,"time","visible",!0);class pc{constructor(){this.alpha=1,this.time=0}}t("AlphaKey",pc),ri.fastDefine("cc.AlphaKey",pc,{alpha:1,time:0}),ri.Attr.setClassAttr(pc,"alpha","visible",!0),ri.Attr.setClassAttr(pc,"time","visible",!0);class _c{constructor(){this.colorKeys=[],this.alphaKeys=[],this.mode=uc.Blend}setKeys(t,e){this.colorKeys=t,this.alphaKeys=e}sortKeys(){this.colorKeys.length>1&&this.colorKeys.sort(((t,e)=>t.time-e.time)),this.alphaKeys.length>1&&this.alphaKeys.sort(((t,e)=>t.time-e.time))}evaluate(t){return this.evaluateFast(new _r,t)}evaluateFast(t,e){return this.getRGB(t,e),t.a=this.getAlpha(e),t}randomColor(){return this.getRandomColor(new _r)}getRandomColor(t){const e=this.colorKeys[Math.trunc(wi()*this.colorKeys.length)],i=this.alphaKeys[Math.trunc(wi()*this.alphaKeys.length)];return t.set(e.color),t.a=i.alpha,t}getRGB(t,e){const i=this.colorKeys,s=i.length;if(s>1){e=Ai(e,1+pi);for(let r=1;r<s;++r){const s=i[r-1].time,n=i[r].time;if(e>=s&&e<n){if(this.mode===uc.Fixed)return _r.copy(t,i[r].color),t;const o=(e-s)/(n-s);return _r.lerp(t,i[r-1].color,i[r].color,o),t}}const r=s-1;gi(e,i[r].time,pi)?_r.copy(t,i[r].color):e<i[0].time?_r.lerp(t,_r.BLACK,i[0].color,e/i[0].time):e>i[r].time&&_r.lerp(t,i[r].color,_r.BLACK,(e-i[r].time)/(1-i[r].time))}else 1===s?_r.copy(t,i[0].color):_r.copy(t,_r.WHITE);return t}getAlpha(t){const e=this.alphaKeys,i=e.length;if(i>1){t=Ai(t,1+pi);for(let s=1;s<i;++s){const i=e[s-1].time,r=e[s].time;if(t>=i&&t<r){if(this.mode===uc.Fixed)return e[s].alpha;const n=(t-i)/(r-i);return yi(e[s-1].alpha,e[s].alpha,n)}}const s=i-1;return gi(t,e[s].time,pi)?e[s].alpha:t<e[0].time?yi(0,e[0].alpha,t/e[0].time):t>e[s].time?yi(e[s].alpha,0,(t-e[s].time)/(1-e[s].time)):255}return 1===i?e[0].alpha:255}}t("Gradient",_c),_c.Mode=uc,ri.fastDefine("cc.Gradient",_c,{colorKeys:[],alphaKeys:[],mode:uc.Blend}),ri.Attr.setClassAttr(_c,"colorKeys","visible",!0),ri.Attr.setClassAttr(_c,"alphaKeys","visible",!0),ri.Attr.setClassAttr(_c,"mode","visible",!0);class gc{constructor(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}}ri.fastDefine("cc.Keyframe",gc,{time:0,value:0,inTangent:0,outTangent:0});class fc{constructor(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}evaluate(t){return mc(t-this.time,this.coefficient)}}function mc(t,e){return t*(t*(t*e[0]+e[1])+e[2])+e[3]}class yc{get _internalCurve(){return this._curve}get keyFrames(){return Array.from(this._curve.keyframes()).map((t=>{let[e,i]=t;const s=new gc;return s.time=e,s.value=i.value,s.inTangent=i.leftTangent,s.outTangent=i.rightTangent,s}))}set keyFrames(t){this._curve.assignSorted(t.map((t=>[t.time,{interpolationMode:2,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}])))}get preWrapMode(){return bc(this._curve.preExtrapolation)}set preWrapMode(t){this._curve.preExtrapolation=vc(t)}get postWrapMode(){return bc(this._curve.postExtrapolation)}set postWrapMode(t){this._curve.postExtrapolation=vc(t)}constructor(t){if(void 0===t&&(t=null),this._curve=void 0,this.cachedKey=void 0,t instanceof nl)this._curve=t;else{const e=new nl;this._curve=e,e.preExtrapolation=2,e.postExtrapolation=1,t?e.assignSorted(t.map((t=>[t.time,{interpolationMode:2,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]))):e.assignSorted([[0,{interpolationMode:2,value:1}],[1,{interpolationMode:2,value:1}]])}this.cachedKey=new fc}addKey(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:2,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()}evaluate_slow(t){return this._curve.evaluate(t)}evaluate(t){const{cachedKey:e,_curve:i}=this,s=i.keyFramesCount-1;let r=t;const n=t<0?i.preExtrapolation:i.postExtrapolation,o=i.getKeyframeTime(0),a=i.getKeyframeTime(s);switch(n){case 2:r=Ai(t-o,a-o)+o;break;case 3:r=Mi(t-o,a-o)+o;break;default:r=fi(t,o,a)}if(r>=e.time&&r<e.endTime)return e.evaluate(r);const h=this.findIndex(e,r),l=Math.min(h+1,s);return this.calcOptimizedKey(e,h,l),e.evaluate(r)}calcOptimizedKey(t,e,i){const s=this._curve.getKeyframeTime(e),r=this._curve.getKeyframeTime(i),{value:n,leftTangent:o}=this._curve.getKeyframeValue(e),{value:a,rightTangent:h}=this._curve.getKeyframeValue(i);t.index=e,t.time=s,t.endTime=r;const l=r-s,c=a-n,u=1/(l*l),d=o*l,p=h*l;t.coefficient[0]=(d+p-c-c)*u/l,t.coefficient[1]=(c+c+c-d-d-p)*u,t.coefficient[2]=o,t.coefficient[3]=n}findIndex(t,e){const{_curve:i}=this,s=i.keyFramesCount,r=t.index;if(-1!==r)if(e>i.getKeyframeTime(r))for(let t=0;t<3;t++){const n=r+t;if(n+1<s&&i.getKeyframeTime(n+1)>e)return n}else for(let t=0;t<3;t++){const s=r-t;if(s>=0&&i.getKeyframeTime(s-1)<=e)return s-1}let n,o=0,a=s;for(;a-o>1;)n=Math.floor((o+a)/2),i.getKeyframeTime(n)>=e?a=n:o=n;return o}}function vc(t){switch(t){default:case 0:case 1:case 8:return 1;case 22:return 3;case 2:return 2}}function bc(t){switch(t){default:case 0:case 1:return 8;case 3:return 22;case 2:return 2}}function wc(){const t=new nl;return t.assignSorted([[0,{interpolationMode:2,value:1}],[1,{interpolationMode:2,value:1}]]),t}yc.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],ri.fastDefine("cc.AnimationCurve",yc,{_curve:null});const Sc=4294967295,xc=new Ki,Tc=new Ki,Cc=new Ki,Ic=new Ki;class Ec{constructor(t,e){void 0===t&&(t=2),void 0===e&&(e=[]),this._type=void 0,this._knots=[],this._type=1024,this._mode=t;for(let t=0;t<e.length;t++)this._knots[t]=new Ki(e[t])}static create(t,e){return void 0===e&&(e=[]),new Ec(t,e)}static clone(t){return new Ec(t.mode,t.knots)}static copy(t,e){t._mode=e.mode,t._knots.length=0;const i=e.knots,s=i.length;for(let e=0;e<s;e++)t._knots[e]=new Ki(i[e]);return t}get type(){return this._type}get mode(){return this._mode}get knots(){return this._knots}setModeAndKnots(t,e){this._mode=t,this._knots.length=0;for(let t=0;t<e.length;t++)this._knots[t]=new Ki(e[t])}clearKnots(){this._knots.length=0}getKnotCount(){return this._knots.length}addKnot(t){this._knots.push(new Ki(t))}insertKnot(t,e){const i=new Ki(e);t>=this._knots.length?this._knots.push(i):this._knots.splice(t,0,i)}removeKnot(t){Zt(this._knots,t),this._knots.splice(t,1)}setKnot(t,e){Zt(this._knots,t),this._knots[t].set(e)}getKnot(t){return Zt(this._knots,t),this._knots[t]}getPoint(t,e){void 0===e&&(e=Sc),t=fi(t,0,1);const i=this.getSegments();if(0===i)return new Ki;if(e===Sc){const s=1/i;e=Math.floor(t/s),t=t%s/s}const s=this._knots;if(e>=i)return new Ki(s[s.length-1]);switch(this._mode){case 0:return Ec.calcLinear(s[e],s[e+1],t);case 1:{const i=4*e;return Ec.calcBezier(s[i],s[i+1],s[i+2],s[i+3],t)}case 2:{const i=e>0?s[e-1]:s[e],r=e+2<s.length?s[e+2]:s[e+1];return Ec.calcCatmullRom(i,s[e],s[e+1],r,t)}default:return new Ki}}getPoints(t,e){if(void 0===e&&(e=Sc),0===t)return[];if(1===t)return[this.getPoint(0,e)];const i=[],s=1/(t-1);for(let r=0;r<t;r++){const t=r*s,n=this.getPoint(t,e);i.push(n)}return i}getSegments(){const t=this._knots.length;switch(this._mode){case 0:case 2:return t<2?(G(14300),0):t-1;case 1:return t<4||t%4!=0?(G(14301),0):t/4;default:return q(!1,16407),0}}static calcLinear(t,e,i){const s=new Ki;return Ki.multiplyScalar(xc,t,1-i),Ki.multiplyScalar(Tc,e,i),Ki.add(s,xc,Tc),s}static calcBezier(t,e,i,s,r){const n=new Ki,o=1-r;return Ki.multiplyScalar(xc,t,o*o*o),Ki.multiplyScalar(Tc,e,3*r*o*o),Ki.multiplyScalar(Cc,i,3*r*r*o),Ki.multiplyScalar(Ic,s,r*r*r),Ki.add(xc,xc,Tc),Ki.add(Cc,Cc,Ic),Ki.add(n,xc,Cc),n}static calcCatmullRom(t,e,i,s,r){const n=new Ki,o=r*r,a=o*r;return Ki.multiplyScalar(xc,t,-.5*a+o-.5*r),Ki.multiplyScalar(Tc,e,1.5*a-2.5*o+1),Ki.multiplyScalar(Cc,i,-1.5*a+2*o+.5*r),Ki.multiplyScalar(Ic,s,.5*a-.5*o),Ki.add(xc,xc,Tc),Ki.add(Cc,Cc,Ic),Ki.add(n,xc,Cc),n}}var Dc=Object.freeze({__proto__:null,AABB:Qn,AnimationCurve:yc,Capsule:class{get type(){return this._type}constructor(t,e,i){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===i&&(i=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=512,this.radius=t,this.halfHeight=e,this.axis=i,this.center=new Ki,this.rotation=new ys,this.ellipseCenter0=new Ki(0,e,0),this.ellipseCenter1=new Ki(0,-e,0),this.updateCache()}transform(t,e,i,s,r){const n=s,o=Bi(n);r.radius=this.radius*Math.abs(o);let a=(this.halfHeight+this.radius)*Math.abs(n.y)-r.radius;a<0&&(a=0),r.halfHeight=a,Ki.transformMat4(r.center,this.center,t),ys.multiply(r.rotation,this.rotation,i),r.updateCache()}updateCache(){this.updateLocalCenter(),Ki.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Ki.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}updateLocalCenter(){const t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}}},ERaycastMode:{ALL:0,CLOSEST:1,ANY:2},Frustum:eo,Keyframe:gc,Line:class t{static create(e,i,s,r,n,o){return new t(e,i,s,r,n,o)}static clone(e){return new t(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)}static copy(t,e){return Ki.copy(t.s,e.s),Ki.copy(t.e,e.e),t}static fromPoints(t,e,i){return Ki.copy(t.s,e),Ki.copy(t.e,i),t}static set(t,e,i,s,r,n,o){return t.s.x=e,t.s.y=i,t.s.z=s,t.e.x=r,t.e.y=n,t.e.z=o,t}static len(t){return Ki.distance(t.s,t.e)}get type(){return this._type}constructor(t,e,i,s,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=2,this.s=new Ki(t,e,i),this.e=new Ki(s,r,n)}length(){return Ki.distance(this.s,this.e)}},OBB:Ho,OptimizedKey:fc,Plane:$r,Ray:qr,Sphere:tn,Spline:Ec,SplineMode:{LINEAR:0,BEZIER:1,CATMULL_ROM:2},Triangle:Xr,WrapModeMask:{Default:0,Normal:1,Loop:2,ShouldWrap:4,Clamp:8,PingPong:22,Reverse:36},constructLegacyCurveAndConvert:wc,distance:Vr,enums:{SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512,SHAPE_SPLINE:1024},evalOptCurve:mc,intersect:ko});t("geometry",Dc);const Ac=/(\.[^\.\/\?\\]*)(\?.*)?$/,Mc=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,Pc=/[^\.\/]+\/\.\.\//;function Bc(){let t="";for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];for(const e of i)t=(t+(""===t?"":"/")+e).replace(/(\/|\\\\)$/,"");return t}function Rc(t){const e=Ac.exec(t);return e?e[1]:""}function Oc(t){if(t){const e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function Lc(t,e){const i=t.indexOf("?");i>0&&(t=t.substring(0,i));const s=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!s)return t;const r=s[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?r.substring(0,r.length-e.length):r}function Fc(t){const e=Mc.exec(t);return e?e[2]:""}function zc(t,e){e=e||"";let i=t.indexOf("?"),s="";return i>0&&(s=t.substring(i),t=t.substring(0,i)),i=t.lastIndexOf("."),i<0?t+e+s:t.substring(0,i)+e+s}function kc(t,e,i){if(0===e.indexOf("."))return zc(t,e);let s=t.indexOf("?"),r="";const n=i?Rc(t):"";return s>0&&(r=t.substring(s),t=t.substring(0,s)),s=t.lastIndexOf("/"),s=s<=0?0:s+1,t.substring(0,s)+e+n+r}function Nc(t){let e=t=String(t);do{e=t,t=t.replace(Pc,"")}while(e.length!==t.length);return t}function Uc(t){return t.replace(/[\/\\]$/,"")}function Vc(){return zn.os===On.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,_normalize:Nc,basename:Lc,changeBasename:kc,changeExtname:zc,dirname:Fc,extname:Rc,getSeperator:Vc,join:Bc,mainFileName:Oc,stripSep:Uc}));let Hc,Gc,Wc,jc,$c,qc=10;t("replaceProperty",Hc),t("removeProperty",Gc),t("markAsWarning",Wc);let Xc=0;const Yc=new Map;jc=(t,e,i,s,r,n,o)=>{const a=Yc.get(n);a&&a.logTimes>a.count&&(r(`'%s' is deprecated, please use '%s' instead. ${o}`,`${t}.${e}`,`${i}.${s}`),a.count++)},t("replaceProperty",Hc=(t,e,i)=>{null!=t&&i.forEach((i=>{const s=Xc++;Yc.set(s,{id:s,count:0,logTimes:void 0!==i.logTimes?i.logTimes:qc});const r=null!=i.target?i.target:t,n=null!=i.newName?i.newName:i.name,o=null!=i.targetName?i.targetName:e,a=r===t,h=i.suggest?`(${i.suggest})`:"";if(null!=i.customFunction)t[i.name]=function(){return jc(e,i.name,o,n,P,s,h),i.customFunction.call(this,...arguments)};else if(null!=i.customSetter||null!=i.customGetter){const r=null!=i.customSetter,a=null!=i.customGetter;r&&a?Object.defineProperty(t,i.name,{get(){return jc(e,i.name,o,n,P,s,h),i.customGetter.call(this)},set(t){jc(e,i.name,o,n,P,s,h),i.customSetter.call(this,t)},enumerable:!1}):r?Object.defineProperty(t,i.name,{set(t){jc(e,i.name,o,n,P,s,h),i.customSetter.call(this,t)},enumerable:!1}):a&&Object.defineProperty(t,i.name,{get(){return jc(e,i.name,o,n,P,s,h),i.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,i.name,{get(){return jc(e,i.name,o,n,P,s,h),a?this[n]:r[n]},set(t){jc(e,i.name,o,n,P,s,h),a?this[n]=t:r[n]=t},enumerable:!1})}))}),$c=(t,e,i,s,r)=>{const n=Yc.get(s);n&&n.logTimes>n.count&&(i(`'%s' has been removed. ${r}`,`${t}.${e}`),n.count++)},t("removeProperty",Gc=(t,e,i)=>{null!=t&&i.forEach((i=>{const s=Xc++;Yc.set(s,{id:s,count:0,logTimes:void 0!==i.logTimes?i.logTimes:qc});const r=i.suggest?`(${i.suggest})`:"";Object.defineProperty(t,i.name,{get:()=>$c(e,i.name,B,s,r),set(){$c(e,i.name,B,s,r)},enumerable:!1})}))}),t("markAsWarning",Wc=()=>{});const Qc={};function Kc(t){const e=Qc[t];if(!e)return;const{newName:i,since:s,removed:r}=e;r?i?j(16003,t,s,i):j(16002,t,s):i?G(16001,t,s,i):G(16e3,t,s)}let Zc;const Jc=new Ki;function tu(t,e,i,s){s||(s=new Ki),t.convertToUINode(e,i,s);const r=i.position;return s.add(r),s}function eu(t,e,i){return i||(i=new Ki),t.worldToScreen(e,i),i.x/=l.view.getScaleX(),i.y/=l.view.getScaleY(),i}const iu=t("convertUtils",{WorldNode3DToLocalNodeUI:tu,WorldNode3DToWorldNodeUI:eu});l.pipelineUtils=iu,Hc(l.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=e[0],r=e[3]||Jc;return s.convertToUINode(e[1],e[2],r),r.add(e[2].position),e[3]||r.clone()}}]);class su{constructor(){this._id="",this._priority=0,this._executeInEditMode=!1}set priority(t){this._priority=t}get priority(){return this._priority}set id(t){this._id=t}get id(){return this._id}static sortByPriority(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0}init(){}update(t){}postUpdate(t){}destroy(){}}t("System",su),su.Priority=te({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});const ru=new tt("Scheduler");class nu{static get(t,e,i,s){let r=nu._listEntries.pop();return r?(r.target=t,r.priority=e,r.paused=i,r.markedForDeletion=s):r=new nu(t,e,i,s),r}static put(t){nu._listEntries.length<20&&(t.target=null,nu._listEntries.push(t))}constructor(t,e,i,s){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=i,this.markedForDeletion=s}}nu._listEntries=[];class ou{static get(t,e,i,s){let r=ou._hashUpdateEntries.pop();return r?(r.list=t,r.entry=e,r.target=i,r.callback=s):r=new ou(t,e,i,s),r}static put(t){ou._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,ou._hashUpdateEntries.push(t))}constructor(t,e,i,s){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=i,this.callback=s}}ou._hashUpdateEntries=[];class au{static get(t,e,i,s,r,n){let o=au._hashTimerEntries.pop();return o?(o.timers=t,o.target=e,o.timerIndex=i,o.currentTimer=s,o.currentTimerSalvaged=r,o.paused=n):o=new au(t,e,i,s,r,n),o}static put(t){au._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,au._hashTimerEntries.push(t))}constructor(t,e,i,s,r,n){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=i,this.currentTimer=s,this.currentTimerSalvaged=r,this.paused=n}}au._hashTimerEntries=[];class hu{static get(){return hu._timers.pop()||new hu}static put(t){hu._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,hu._timers.push(t))}constructor(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null}initWithCallback(t,e,i,s,r,n){return this._lock=!1,this._scheduler=t,this._target=i,this._callback=e,this._timesExecuted=0,this._elapsed=-1,this._interval=s,this._delay=n,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===l.macro.REPEAT_FOREVER,!0}getInterval(){return this._interval}setInterval(t){this._interval=t}update(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}getCallback(){return this._callback}trigger(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}cancel(){this._scheduler&&this._callback&&this._target&&this._scheduler.unscheduleForTimer(this,this._target)}}hu._timers=[];class lu extends su{static enableForTarget(t){let e=!1;(t.uuid||t.id)&&(e=!0),e||(t.id=ru.getNewId())}constructor(){super(),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=dt(!0),this._hashForTimers=dt(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}setTimeScale(t){this._timeScale=t}getTimeScale(){return this._timeScale}update(t){let e,i,s,r,n;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,i=this._updatesNegList,s=i.length;e<s;e++){var o,a;r=i[e],r.paused||r.markedForDeletion||!r.target||null===(o=(a=r.target).update)||void 0===o||o.call(a,t)}for(e=0,i=this._updates0List,s=i.length;e<s;e++){var h,l;r=i[e],r.paused||r.markedForDeletion||!r.target||null===(h=(l=r.target).update)||void 0===h||h.call(l,t)}for(e=0,i=this._updatesPosList,s=i.length;e<s;e++){var c,u;r=i[e],r.paused||r.markedForDeletion||!r.target||null===(c=(u=r.target).update)||void 0===c||c.call(u,t)}const d=this._arrayForTimers;for(e=0;e<d.length;e++){var p;if(n=d[e],this._currentTarget=n,this._currentTargetSalvaged=!1,!n.paused&&n.timers)for(n.timerIndex=0;n.timerIndex<n.timers.length;++n.timerIndex)n.currentTimer=n.timers[n.timerIndex],n.currentTimerSalvaged=!1,n.currentTimer.update(t),n.currentTimer=null;this._currentTargetSalvaged&&0===(null===(p=this._currentTarget.timers)||void 0===p?void 0:p.length)&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,i=this._updatesNegList;e<i.length;)r=i[e],r.markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,i=this._updates0List;e<i.length;)r=i[e],r.markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,i=this._updatesPosList;e<i.length;)r=i[e],r.markedForDeletion?this._removeUpdateFromHash(r):e++;this._updateHashLocked=!1,this._currentTarget=null}schedule(t,e,i,s,r,n){var o,a;let h,c;"function"!=typeof t?(G(1514),h=e,c=t):(h=t,c=e),3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(n=!!s,s=l.macro.REPEAT_FOREVER,r=0),q(Boolean(c),1502);const u=c.uuid||c.id;if(!u)return void j(1510);let d,p,_=this._hashForTimers[u];if(_?_.paused!==n&&G(1511):(_=au.get(null,c,0,null,!1,Boolean(n)),this._arrayForTimers.push(_),this._hashForTimers[u]=_),null==_.timers)_.timers=[];else for(p=0;p<_.timers.length;++p)if(d=_.timers[p],d&&h===d.getCallback())return N(1507,d.getInterval(),i),void d.setInterval(i);d=hu.get(),d.initWithCallback(this,h,c,i,null!==(o=s)&&void 0!==o?o:0,null!==(a=r)&&void 0!==a?a:0),_.timers.push(d),this._currentTarget===_&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}scheduleUpdate(t,e,i){const s=t.uuid||t.id;if(!s)return void j(1510);const r=this._hashForUpdates[s];if(r&&r.entry){if(r.entry.priority===e)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return N(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(t)}const n=nu.get(t,e,i,!1);let o;0===e?(o=this._updates0List,this._appendIn(o,n)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,n,e)),this._hashForUpdates[s]=ou.get(o,n,t,null)}unschedule(t,e){if(!e||!t)return;const i=e.uuid||e.id;if(!i)return void j(1510);const s=this._hashForTimers[i];if(s){const e=s.timers;if(!e)return;for(let i=0,r=e.length;i<r;i++){const r=e[i];if(t===r.getCallback())return r!==s.currentTimer||s.currentTimerSalvaged||(s.currentTimerSalvaged=!0),e.splice(i,1),hu.put(r),s.timerIndex>=i&&s.timerIndex--,void(0===e.length&&(this._currentTarget===s?this._currentTargetSalvaged=!0:this._removeHashElement(s)))}}}unscheduleForTimer(t,e){const i=e.uuid||e.id,s=this._hashForTimers[i],r=s.timers;if(r&&0!==r.length)for(let e=r.length-1;e>=0;e--){const i=r[e];if(i===t)return r.splice(e,1),hu.put(i),s.timerIndex>=e&&s.timerIndex--,void(0===r.length&&(this._currentTargetSalvaged=!0))}}unscheduleUpdate(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void j(1510);const i=this._hashForUpdates[e];null!=i&&i.entry&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}unscheduleAllForTarget(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void j(1510);const i=this._hashForTimers[e];if(null!=i&&i.timers){const t=i.timers;i.currentTimer&&t.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(let e=0,i=t.length;e<i;e++)hu.put(t[e]);t.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(t)}unscheduleAll(){this.unscheduleAllWithMinPriority(su.Priority.SCHEDULER)}unscheduleAllWithMinPriority(t){let e,i;const s=this._arrayForTimers;for(e=s.length-1;e>=0;e--)i=s[e],i.target&&this.unscheduleAllForTarget(i.target);let r,n=0;if(t<0)for(e=0;e<this._updatesNegList.length;){var o;n=this._updatesNegList.length,r=this._updatesNegList[e],null!==(o=r)&&void 0!==o&&o.target&&r.priority>=t&&this.unscheduleUpdate(r.target),n===this._updatesNegList.length&&e++}if(t<=0)for(e=0;e<this._updates0List.length;){var a;n=this._updates0List.length,r=this._updates0List[e],null!==(a=r)&&void 0!==a&&a.target&&this.unscheduleUpdate(r.target),n===this._updates0List.length&&e++}for(e=0;e<this._updatesPosList.length;){var h;n=this._updatesPosList.length,r=this._updatesPosList[e],null!==(h=r)&&void 0!==h&&h.target&&r.priority>=t&&this.unscheduleUpdate(r.target),n===this._updatesPosList.length&&e++}}isScheduled(t,e){q(Boolean(t),1508),q(Boolean(e),1509);const i=e.uuid||e.id;if(!i)return j(1510),!1;const s=this._hashForTimers[i];if(!s)return!1;if(null==s.timers)return!1;{const e=s.timers;for(let i=0;i<e.length;++i)if(t===e[i].getCallback())return!0;return!1}}pauseAllTargets(){return this.pauseAllTargetsWithMinPriority(su.Priority.SCHEDULER)}pauseAllTargetsWithMinPriority(t){const e=[];let i;const s=this._arrayForTimers;let r,n,o;for(r=0,n=s.length;r<n;r++){var a;i=s[r],null!==(a=i)&&void 0!==a&&a.target&&(i.paused=!0,e.push(i.target))}if(t<0)for(r=0;r<this._updatesNegList.length;r++){var h;o=this._updatesNegList[r],null!==(h=o)&&void 0!==h&&h.target&&o.priority>=t&&(o.paused=!0,e.push(o.target))}if(t<=0)for(r=0;r<this._updates0List.length;r++){var l;o=this._updates0List[r],null!==(l=o)&&void 0!==l&&l.target&&(o.paused=!0,e.push(o.target))}for(r=0;r<this._updatesPosList.length;r++){var c;o=this._updatesPosList[r],null!==(c=o)&&void 0!==c&&c.target&&o.priority>=t&&(o.paused=!0,e.push(o.target))}return e}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)this.resumeTarget(t[e])}pauseTarget(t){q(Boolean(t),1503);const e=t.uuid||t.id;if(!e)return void j(1510);const i=this._hashForTimers[e];i&&(i.paused=!0);const s=this._hashForUpdates[e];null!=s&&s.entry&&(s.entry.paused=!0)}resumeTarget(t){q(Boolean(t),1504);const e=t.uuid||t.id;if(!e)return void j(1510);const i=this._hashForTimers[e];i&&(i.paused=!1);const s=this._hashForUpdates[e];null!=s&&s.entry&&(s.entry.paused=!1)}isTargetPaused(t){q(Boolean(t),1505);const e=t.uuid||t.id;if(!e)return j(1510),!1;const i=this._hashForTimers[e];if(i)return i.paused;const s=this._hashForUpdates[e];return!(null==s||!s.entry)&&s.entry.paused}_removeHashElement(t){if(!t.target)return;const e=t.target.uuid||t.target.id;if(void 0===e)return;delete this._hashForTimers[e];const i=this._arrayForTimers;for(let e=0,s=i.length;e<s;e++)if(i[e]===t){i.splice(e,1);break}au.put(t)}_removeUpdateFromHash(t){if(!t.target)return;const e=t.target.uuid||t.target.id;if(void 0===e)return;const i=this._hashForUpdates[e];if(i){const t=i.list,s=i.entry;if(t)for(let e=0,i=t.length;e<i;e++)if(t[e]===s){t.splice(e,1);break}delete this._hashForUpdates[e],s&&nu.put(s),ou.put(i)}}_priorityIn(t,e,i){for(let s=0;s<t.length;s++)if(i<t[s].priority)return void t.splice(s,0,e);t.push(e)}_appendIn(t,e){t.push(e)}}t("Scheduler",lu),lu.ID="scheduler",l.Scheduler=lu;const cu=String.prototype.charCodeAt;function uu(t){return this[t]}function du(t,e){let i=t.length,s=e^i,r=0;const n="string"==typeof t?cu:uu;for(;i>=4;){let e=255&n.call(t,r)|(255&n.call(t,++r))<<8|(255&n.call(t,++r))<<16|(255&n.call(t,++r))<<24;e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),e^=e>>>24,e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),s=1540483477*(65535&s)+((1540483477*(s>>>16)&65535)<<16)^e,i-=4,++r}switch(i){case 3:s^=(255&n.call(t,r+2))<<16;case 2:s^=(255&n.call(t,r+1))<<8;case 1:s^=255&n.call(t,r),s=1540483477*(65535&s)+((1540483477*(s>>>16)&65535)<<16)}return s^=s>>>13,s=1540483477*(65535&s)+((1540483477*(s>>>16)&65535)<<16),s^=s>>>15,s>>>0}function pu(){}function _u(t,e,i){if(Zt(t,e),Zt(t,i),e===i)return t;const s=t[e];if(e<i)for(let s=e+1;s<=i;++s)t[s-1]=t[s];else for(let s=e;s!==i;--s)t[s]=t[s-1];return t[i]=s,t}l.easing=Kh,pu.prototype.once=function(t,e,i){return this.on(t,e,i,!0)},pu.prototype.targetOff=function(t){this.removeAll(t)},t("jsbUtils",Object.freeze({__proto__:null,ExtraEventMethods:pu,syncNodeValues:function(t){const e=t._lpos;t.setPositionForJS(e.x,e.y,e.z);const i=t._lscale;t.setScaleForJS(i.x,i.y,i.z);const s=t._lrot;t.setRotationForJS(s.x,s.y,s.z,s.w);const r=t._euler;t.setRotationFromEulerForJS(r.x,r.y,r.z)},updateChildrenForDeserialize:function t(e){if(!e)return;const i=e.children;if(!i)return;const s=i.length;if(s){e._setChildren(i);for(let e=0;e<s;++e)t(i[e])}}}));const gu=t("garbageCollectionManager",new class{constructor(){this._finalizationRegistry=null,this._gcObjects=new WeakMap}registerGCObject(t){return t}init(){}finalizationRegistryCallback(t){const e=this._gcObjects.get(t);e&&(this._gcObjects.delete(t),e.destroy()),this._finalizationRegistry.unregister(t)}destroy(){}});class fu{constructor(){return gu.registerGCObject(this)}destroy(){}}function mu(t,e){for(const i of e)Array.isArray(i)?mu(t,i):t.push(i)}function yu(t){const e=[];return mu(e,t),e.join("")}t("GCObject",fu),l.math=Ar,l.geometry=Dc;const vu=(t,e,i)=>{for(let s=0;s<e.length;++s)t.length<=s&&t.push(new i),t[s].copy(e[s]);t.length=e.length},bu={UNKNOWN:0,SWAPCHAIN:1,BUFFER:2,TEXTURE:3,RENDER_PASS:4,FRAMEBUFFER:5,SAMPLER:6,SHADER:7,DESCRIPTOR_SET_LAYOUT:8,PIPELINE_LAYOUT:9,PIPELINE_STATE:10,DESCRIPTOR_SET:11,INPUT_ASSEMBLER:12,COMMAND_BUFFER:13,QUEUE:14,QUERY_POOL:15,GLOBAL_BARRIER:16,TEXTURE_BARRIER:17,BUFFER_BARRIER:18,COUNT:19},wu={UNREADY:0,FAILED:1,SUCCESS:2},Su={UNKNOWN:0,GLES2:1,GLES3:2,METAL:3,VULKAN:4,NVN:5,WEBGL:6,WEBGL2:7,WEBGPU:8},xu={IDENTITY:0,ROTATE_90:1,ROTATE_180:2,ROTATE_270:3},Tu={ELEMENT_INDEX_UINT:0,INSTANCED_ARRAYS:1,MULTIPLE_RENDER_TARGETS:2,BLEND_MINMAX:3,COMPUTE_SHADER:4,INPUT_ATTACHMENT_BENEFIT:5,SUBPASS_COLOR_INPUT:6,SUBPASS_DEPTH_STENCIL_INPUT:7,RASTERIZATION_ORDER_NOCOHERENT:8,MULTI_SAMPLE_RESOLVE_DEPTH_STENCIL:9,COUNT:10},Cu={UNKNOWN:0,A8:1,L8:2,LA8:3,R8:4,R8SN:5,R8UI:6,R8I:7,R16F:8,R16UI:9,R16I:10,R32F:11,R32UI:12,R32I:13,RG8:14,RG8SN:15,RG8UI:16,RG8I:17,RG16F:18,RG16UI:19,RG16I:20,RG32F:21,RG32UI:22,RG32I:23,RGB8:24,SRGB8:25,RGB8SN:26,RGB8UI:27,RGB8I:28,RGB16F:29,RGB16UI:30,RGB16I:31,RGB32F:32,RGB32UI:33,RGB32I:34,RGBA8:35,BGRA8:36,SRGB8_A8:37,RGBA8SN:38,RGBA8UI:39,RGBA8I:40,RGBA16F:41,RGBA16UI:42,RGBA16I:43,RGBA32F:44,RGBA32UI:45,RGBA32I:46,R5G6B5:47,R11G11B10F:48,RGB5A1:49,RGBA4:50,RGB10A2:51,RGB10A2UI:52,RGB9E5:53,DEPTH:54,DEPTH_STENCIL:55,BC1:56,BC1_ALPHA:57,BC1_SRGB:58,BC1_SRGB_ALPHA:59,BC2:60,BC2_SRGB:61,BC3:62,BC3_SRGB:63,BC4:64,BC4_SNORM:65,BC5:66,BC5_SNORM:67,BC6H_UF16:68,BC6H_SF16:69,BC7:70,BC7_SRGB:71,ETC_RGB8:72,ETC2_RGB8:73,ETC2_SRGB8:74,ETC2_RGB8_A1:75,ETC2_SRGB8_A1:76,ETC2_RGBA8:77,ETC2_SRGB8_A8:78,EAC_R11:79,EAC_R11SN:80,EAC_RG11:81,EAC_RG11SN:82,PVRTC_RGB2:83,PVRTC_RGBA2:84,PVRTC_RGB4:85,PVRTC_RGBA4:86,PVRTC2_2BPP:87,PVRTC2_4BPP:88,ASTC_RGBA_4X4:89,ASTC_RGBA_5X4:90,ASTC_RGBA_5X5:91,ASTC_RGBA_6X5:92,ASTC_RGBA_6X6:93,ASTC_RGBA_8X5:94,ASTC_RGBA_8X6:95,ASTC_RGBA_8X8:96,ASTC_RGBA_10X5:97,ASTC_RGBA_10X6:98,ASTC_RGBA_10X8:99,ASTC_RGBA_10X10:100,ASTC_RGBA_12X10:101,ASTC_RGBA_12X12:102,ASTC_SRGBA_4X4:103,ASTC_SRGBA_5X4:104,ASTC_SRGBA_5X5:105,ASTC_SRGBA_6X5:106,ASTC_SRGBA_6X6:107,ASTC_SRGBA_8X5:108,ASTC_SRGBA_8X6:109,ASTC_SRGBA_8X8:110,ASTC_SRGBA_10X5:111,ASTC_SRGBA_10X6:112,ASTC_SRGBA_10X8:113,ASTC_SRGBA_10X10:114,ASTC_SRGBA_12X10:115,ASTC_SRGBA_12X12:116,COUNT:117},Iu={NONE:0,UNORM:1,SNORM:2,UINT:3,INT:4,UFLOAT:5,FLOAT:6},Eu={UNKNOWN:0,BOOL:1,BOOL2:2,BOOL3:3,BOOL4:4,INT:5,INT2:6,INT3:7,INT4:8,UINT:9,UINT2:10,UINT3:11,UINT4:12,FLOAT:13,FLOAT2:14,FLOAT3:15,FLOAT4:16,MAT2:17,MAT2X3:18,MAT2X4:19,MAT3X2:20,MAT3:21,MAT3X4:22,MAT4X2:23,MAT4X3:24,MAT4:25,SAMPLER1D:26,SAMPLER1D_ARRAY:27,SAMPLER2D:28,SAMPLER2D_ARRAY:29,SAMPLER3D:30,SAMPLER_CUBE:31,SAMPLER:32,TEXTURE1D:33,TEXTURE1D_ARRAY:34,TEXTURE2D:35,TEXTURE2D_ARRAY:36,TEXTURE3D:37,TEXTURE_CUBE:38,IMAGE1D:39,IMAGE1D_ARRAY:40,IMAGE2D:41,IMAGE2D_ARRAY:42,IMAGE3D:43,IMAGE_CUBE:44,SUBPASS_INPUT:45,COUNT:46},Du={NONE:0,TRANSFER_SRC:1,TRANSFER_DST:2,INDEX:4,VERTEX:8,UNIFORM:16,STORAGE:32,INDIRECT:64},Au={NONE:0,ENABLE_STAGING_WRITE:1},Mu={NONE:0,READ_ONLY:1,WRITE_ONLY:2,READ_WRITE:3},Pu={NONE:0,DEVICE:1,HOST:2},Bu={TEX1D:0,TEX2D:1,TEX3D:2,CUBE:3,TEX1D_ARRAY:4,TEX2D_ARRAY:5},Ru={NONE:0,TRANSFER_SRC:1,TRANSFER_DST:2,SAMPLED:4,STORAGE:8,COLOR_ATTACHMENT:16,DEPTH_STENCIL_ATTACHMENT:32,INPUT_ATTACHMENT:64,SHADING_RATE:128},Ou={NONE:0,GEN_MIPMAP:1,GENERAL_LAYOUT:2,EXTERNAL_OES:4,EXTERNAL_NORMAL:8,LAZILY_ALLOCATED:16,MUTABLE_VIEW_FORMAT:64,MUTABLE_STORAGE:128},Lu={NONE:0,RENDER_TARGET:1,SAMPLED_TEXTURE:2,LINEAR_FILTER:4,STORAGE_TEXTURE:8,VERTEX_ATTRIBUTE:16,SHADING_RATE:32},Fu={X1:1,X2:2,X4:4,X8:8,X16:16,X32:32,X64:64},zu={OFF:0,ON:1,RELAXED:2,MAILBOX:3,HALF:4},ku={NONE:0,POINT:1,LINEAR:2,ANISOTROPIC:3},Nu={WRAP:0,MIRROR:1,CLAMP:2,BORDER:3},Uu={NEVER:0,LESS:1,EQUAL:2,LESS_EQUAL:3,GREATER:4,NOT_EQUAL:5,GREATER_EQUAL:6,ALWAYS:7},Vu={ZERO:0,KEEP:1,REPLACE:2,INCR:3,DECR:4,INVERT:5,INCR_WRAP:6,DECR_WRAP:7},Hu={ZERO:0,ONE:1,SRC_ALPHA:2,DST_ALPHA:3,ONE_MINUS_SRC_ALPHA:4,ONE_MINUS_DST_ALPHA:5,SRC_COLOR:6,DST_COLOR:7,ONE_MINUS_SRC_COLOR:8,ONE_MINUS_DST_COLOR:9,SRC_ALPHA_SATURATE:10,CONSTANT_COLOR:11,ONE_MINUS_CONSTANT_COLOR:12,CONSTANT_ALPHA:13,ONE_MINUS_CONSTANT_ALPHA:14},Gu={ADD:0,SUB:1,REV_SUB:2,MIN:3,MAX:4},Wu={NONE:0,R:1,G:2,B:4,A:8,ALL:15},ju={NONE:0,VERTEX:1,CONTROL:2,EVALUATION:4,GEOMETRY:8,FRAGMENT:16,COMPUTE:32,ALL:63},$u={LOAD:0,CLEAR:1,DISCARD:2},qu={STORE:0,DISCARD:1},Xu={NONE:0,INDIRECT_BUFFER:1,INDEX_BUFFER:2,VERTEX_BUFFER:4,VERTEX_SHADER_READ_UNIFORM_BUFFER:8,VERTEX_SHADER_READ_TEXTURE:16,VERTEX_SHADER_READ_OTHER:32,FRAGMENT_SHADER_READ_UNIFORM_BUFFER:64,FRAGMENT_SHADER_READ_TEXTURE:128,FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT:256,FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT:512,FRAGMENT_SHADER_READ_OTHER:1024,COLOR_ATTACHMENT_READ:2048,DEPTH_STENCIL_ATTACHMENT_READ:4096,COMPUTE_SHADER_READ_UNIFORM_BUFFER:8192,COMPUTE_SHADER_READ_TEXTURE:16384,COMPUTE_SHADER_READ_OTHER:32768,TRANSFER_READ:65536,HOST_READ:131072,PRESENT:262144,VERTEX_SHADER_WRITE:524288,FRAGMENT_SHADER_WRITE:1048576,COLOR_ATTACHMENT_WRITE:2097152,DEPTH_STENCIL_ATTACHMENT_WRITE:4194304,COMPUTE_SHADER_WRITE:8388608,TRANSFER_WRITE:16777216,HOST_PREINITIALIZED:33554432,HOST_WRITE:67108864,SHADING_RATE:134217728},Yu={NONE:0,SAMPLE_ZERO:1,AVERAGE:2,MIN:3,MAX:4},Qu={GRAPHICS:0,COMPUTE:1,RAY_TRACING:2},Ku={POINT_LIST:0,LINE_LIST:1,LINE_STRIP:2,LINE_LOOP:3,LINE_LIST_ADJACENCY:4,LINE_STRIP_ADJACENCY:5,ISO_LINE_LIST:6,TRIANGLE_LIST:7,TRIANGLE_STRIP:8,TRIANGLE_FAN:9,TRIANGLE_LIST_ADJACENCY:10,TRIANGLE_STRIP_ADJACENCY:11,TRIANGLE_PATCH_ADJACENCY:12,QUAD_PATCH_LIST:13},Zu={FILL:0,POINT:1,LINE:2},Ju={GOURAND:0,FLAT:1},td={NONE:0,FRONT:1,BACK:2},ed={NONE:0,LINE_WIDTH:1,DEPTH_BIAS:2,BLEND_CONSTANTS:4,DEPTH_BOUNDS:8,STENCIL_WRITE_MASK:16,STENCIL_COMPARE_MASK:32},id={FRONT:1,BACK:2,ALL:3},sd={UNKNOWN:0,UNIFORM_BUFFER:1,DYNAMIC_UNIFORM_BUFFER:2,STORAGE_BUFFER:4,DYNAMIC_STORAGE_BUFFER:8,SAMPLER_TEXTURE:16,SAMPLER:32,TEXTURE:64,STORAGE_IMAGE:128,INPUT_ATTACHMENT:256},rd={GRAPHICS:0,COMPUTE:1,TRANSFER:2},nd={OCCLUSION:0,PIPELINE_STATISTICS:1,TIMESTAMP:2},od={PRIMARY:0,SECONDARY:1},ad={NONE:0,COLOR:1,DEPTH:2,STENCIL:4,DEPTH_STENCIL:6,ALL:7},hd={FULL:0,SPLIT_BEGIN:1,SPLIT_END:2},ld={RASTER:0,COMPUTE:1,COPY:2,MOVE:3,RAYTRACE:4,PRESENT:5};class cd{constructor(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class ud{constructor(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_,g,f,m,y,v,b,w,S,x,T,C){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=0),void 0===l&&(l=0),void 0===c&&(c=0),void 0===u&&(u=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===_&&(_=0),void 0===g&&(g=1),void 0===f&&(f=0),void 0===m&&(m=0),void 0===y&&(y=new cd),void 0===v&&(v=new cd),void 0===b&&(b=!1),void 0===w&&(w=!1),void 0===S&&(S=!1),void 0===x&&(x=-1),void 0===T&&(T=1),void 0===C&&(C=1),this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=i,this.maxTextureUnits=s,this.maxImageUnits=r,this.maxVertexTextureUnits=n,this.maxColorRenderTargets=o,this.maxShaderStorageBufferBindings=a,this.maxShaderStorageBlockSize=h,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=c,this.maxTextureSize=u,this.maxCubeMapTextureSize=d,this.maxArrayTextureLayers=p,this.max3DTextureSize=_,this.uboOffsetAlignment=g,this.maxComputeSharedMemorySize=f,this.maxComputeWorkGroupInvocations=m,this.maxComputeWorkGroupSize=y,this.maxComputeWorkGroupCount=v,this.supportQuery=b,this.supportVariableRateShading=w,this.supportSubPassShading=S,this.clipSpaceMinZ=x,this.screenSpaceSignY=T,this.clipSpaceSignY=C}copy(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.maxArrayTextureLayers=t.maxArrayTextureLayers,this.max3DTextureSize=t.max3DTextureSize,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.supportQuery=t.supportQuery,this.supportVariableRateShading=t.supportVariableRateShading,this.supportSubPassShading=t.supportSubPassShading,this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this}}class dd{constructor(t){void 0===t&&(t=!0),this.enableBarrierDeduce=t}copy(t){return this.enableBarrierDeduce=t.enableBarrierDeduce,this}}class pd{constructor(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class _d{constructor(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),this.x=t,this.y=e,this.width=i,this.height=s}copy(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}}class gd{constructor(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=1),this.width=t,this.height=e,this.depth=i}copy(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this}}class fd{constructor(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=1),this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=i}copy(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class md{constructor(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=0),void 0===s&&(s=1),this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=i,this.layerCount=s}copy(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class yd{constructor(t,e,i,s,r){void 0===t&&(t=new fd),void 0===e&&(e=new pd),void 0===i&&(i=new fd),void 0===s&&(s=new pd),void 0===r&&(r=new gd),this.srcSubres=t,this.srcOffset=e,this.dstSubres=i,this.dstOffset=s,this.extent=r}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this}}class vd{constructor(t,e,i,s,r,n){void 0===t&&(t=new fd),void 0===e&&(e=new pd),void 0===i&&(i=new gd),void 0===s&&(s=new fd),void 0===r&&(r=new pd),void 0===n&&(n=new gd),this.srcSubres=t,this.srcOffset=e,this.srcExtent=i,this.dstSubres=s,this.dstOffset=r,this.dstExtent=n}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this}}class bd{constructor(t,e,i,s,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=new pd),void 0===r&&(r=new gd),void 0===n&&(n=new fd),this.buffOffset=t,this.buffStride=e,this.buffTexHeight=i,this.texOffset=s,this.texExtent=r,this.texSubres=n}copy(t){return this.buffOffset=t.buffOffset,this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this}}class wd{constructor(t,e,i,s,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=1),this.left=t,this.top=e,this.width=i,this.height=s,this.minDepth=r,this.maxDepth=n}copy(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this}reset(){this.left=0,this.top=0,this.width=0,this.height=0,this.minDepth=0,this.maxDepth=1}}class Sd{constructor(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),this.x=t,this.y=e,this.z=i,this.w=s}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}set(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}reset(){this.x=0,this.y=0,this.z=0,this.w=0}}class xd{constructor(t,e){void 0===t&&(t=""),void 0===e&&(e=new Sd),this.name=t,this.color=e}copy(t){return this.name=t.name,this.color.copy(t.color),this}}class Td{constructor(t,e,i,s,r,n,o,a){void 0===t&&(t=[0]),void 0===e&&(e=[0]),void 0===i&&(i=[0]),void 0===s&&(s=[0]),void 0===r&&(r=[0]),void 0===n&&(n=[0]),void 0===o&&(o=[0]),void 0===a&&(a=[0]),this.maxBlockCounts=t,this.maxSamplerTextureCounts=e,this.maxSamplerCounts=i,this.maxTextureCounts=s,this.maxBufferCounts=r,this.maxImageCounts=n,this.maxSubpassInputCounts=o,this.setIndices=a}copy(t){return this.maxBlockCounts=t.maxBlockCounts.slice(),this.maxSamplerTextureCounts=t.maxSamplerTextureCounts.slice(),this.maxSamplerCounts=t.maxSamplerCounts.slice(),this.maxTextureCounts=t.maxTextureCounts.slice(),this.maxBufferCounts=t.maxBufferCounts.slice(),this.maxImageCounts=t.maxImageCounts.slice(),this.maxSubpassInputCounts=t.maxSubpassInputCounts.slice(),this.setIndices=t.setIndices.slice(),this}}class Cd{constructor(t,e,i,s,r){void 0===t&&(t=0),void 0===e&&(e=null),void 0===i&&(i=1),void 0===s&&(s=0),void 0===r&&(r=0),this.windowId=t,this.windowHandle=e,this.vsyncMode=i,this.width=s,this.height=r}copy(t){return this.windowId=t.windowId,this.windowHandle=t.windowHandle,this.vsyncMode=t.vsyncMode,this.width=t.width,this.height=t.height,this}}class Id{constructor(t){void 0===t&&(t=new Td),this.bindingMappingInfo=t}copy(t){return this.bindingMappingInfo.copy(t.bindingMappingInfo),this}}class Ed{constructor(t,e,i,s,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=1),void 0===r&&(r=0),this.usage=t,this.memUsage=e,this.size=i,this.stride=s,this.flags=r}copy(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this}}class Dd{constructor(t,e,i){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=0),this.buffer=t,this.offset=e,this.range=i}copy(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this}}class Ad{constructor(t,e,i,s,r,n,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),this.vertexCount=t,this.firstVertex=e,this.indexCount=i,this.firstIndex=s,this.vertexOffset=r,this.instanceCount=n,this.firstInstance=o}copy(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this}}class Md{constructor(t,e,i,s,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=null),void 0===r&&(r=0),this.groupCountX=t,this.groupCountY=e,this.groupCountZ=i,this.indirectBuffer=s,this.indirectOffset=r}copy(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this}}class Pd{constructor(t){void 0===t&&(t=[]),this.drawInfos=t}copy(t){return vu(this.drawInfos,t.drawInfos,Ad),this}}class Bd{constructor(t,e,i,s,r,n,o,a,h,l,c){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=1),void 0===a&&(a=1),void 0===h&&(h=1),void 0===l&&(l=1),void 0===c&&(c=0),this.type=t,this.usage=e,this.format=i,this.width=s,this.height=r,this.flags=n,this.layerCount=o,this.levelCount=a,this.samples=h,this.depth=l,this.externalRes=c}copy(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this.externalRes=t.externalRes,this}}class Rd{constructor(t,e,i,s,r,n,o,a,h){void 0===t&&(t=null),void 0===e&&(e=1),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=1),void 0===n&&(n=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===h&&(h=1),this.texture=t,this.type=e,this.format=i,this.baseLevel=s,this.levelCount=r,this.baseLayer=n,this.layerCount=o,this.basePlane=a,this.planeCount=h}copy(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this.basePlane=t.basePlane,this.planeCount=t.planeCount,this}}class Od{constructor(t,e,i,s,r,n,o,a){void 0===t&&(t=2),void 0===e&&(e=2),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=7),this.minFilter=t,this.magFilter=e,this.mipFilter=i,this.addressU=s,this.addressV=r,this.addressW=n,this.maxAnisotropy=o,this.cmpFunc=a}copy(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this}}class Ld{constructor(t,e,i){void 0===t&&(t=""),void 0===e&&(e=0),void 0===i&&(i=0),this.name=t,this.type=e,this.count=i}copy(t){return this.name=t.name,this.type=t.type,this.count=t.count,this}}class Fd{constructor(t,e,i,s,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===s&&(s=[]),void 0===r&&(r=0),void 0===n&&(n=0),this.set=t,this.binding=e,this.name=i,this.members=s,this.count=r,this.flattened=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,vu(this.members,t.members,Ld),this.count=t.count,this.flattened=t.flattened,this}}class zd{constructor(t,e,i,s,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),this.set=t,this.binding=e,this.name=i,this.type=s,this.count=r,this.flattened=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.flattened=t.flattened,this}}class kd{constructor(t,e,i,s,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===s&&(s=0),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=i,this.count=s,this.flattened=r}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.flattened=t.flattened,this}}class Nd{constructor(t,e,i,s,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),this.set=t,this.binding=e,this.name=i,this.type=s,this.count=r,this.flattened=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.flattened=t.flattened,this}}class Ud{constructor(t,e,i,s,r,n,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=3),void 0===o&&(o=0),this.set=t,this.binding=e,this.name=i,this.type=s,this.count=r,this.memoryAccess=n,this.flattened=o}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this.flattened=t.flattened,this}}class Vd{constructor(t,e,i,s,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===s&&(s=0),void 0===r&&(r=3),void 0===n&&(n=0),this.set=t,this.binding=e,this.name=i,this.count=s,this.memoryAccess=r,this.flattened=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this.flattened=t.flattened,this}}class Hd{constructor(t,e,i,s,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===s&&(s=0),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=i,this.count=s,this.flattened=r}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.flattened=t.flattened,this}}class Gd{constructor(t,e){void 0===t&&(t=0),void 0===e&&(e=""),this.stage=t,this.source=e}copy(t){return this.stage=t.stage,this.source=t.source,this}}class Wd{constructor(t,e,i,s,r,n){void 0===t&&(t=""),void 0===e&&(e=0),void 0===i&&(i=!1),void 0===s&&(s=0),void 0===r&&(r=!1),void 0===n&&(n=0),this.name=t,this.format=e,this.isNormalized=i,this.stream=s,this.isInstanced=r,this.location=n}copy(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this}}class jd{constructor(t,e,i,s,r,n,o,a,h,l,c){void 0===t&&(t=""),void 0===e&&(e=[]),void 0===i&&(i=[]),void 0===s&&(s=[]),void 0===r&&(r=[]),void 0===n&&(n=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===h&&(h=[]),void 0===l&&(l=[]),void 0===c&&(c=4294967295),this.name=t,this.stages=e,this.attributes=i,this.blocks=s,this.buffers=r,this.samplerTextures=n,this.samplers=o,this.textures=a,this.images=h,this.subpassInputs=l,this.hash=c}copy(t){return this.name=t.name,vu(this.stages,t.stages,Gd),vu(this.attributes,t.attributes,Wd),vu(this.blocks,t.blocks,Fd),vu(this.buffers,t.buffers,Vd),vu(this.samplerTextures,t.samplerTextures,zd),vu(this.samplers,t.samplers,kd),vu(this.textures,t.textures,Nd),vu(this.images,t.images,Ud),vu(this.subpassInputs,t.subpassInputs,Hd),this.hash=t.hash,this}}class $d{constructor(t,e,i,s){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===i&&(i=null),void 0===s&&(s=null),this.attributes=t,this.vertexBuffers=e,this.indexBuffer=i,this.indirectBuffer=s}copy(t){return vu(this.attributes,t.attributes,Wd),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this}}class qd{constructor(t,e,i,s,r){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=1),void 0===s&&(s=0),void 0===r&&(r=null),this.format=t,this.sampleCount=e,this.loadOp=i,this.storeOp=s,this.barrier=r}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.barrier=t.barrier,this}}class Xd{constructor(t,e,i,s,r,n,o){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=1),void 0===s&&(s=0),void 0===r&&(r=1),void 0===n&&(n=0),void 0===o&&(o=null),this.format=t,this.sampleCount=e,this.depthLoadOp=i,this.depthStoreOp=s,this.stencilLoadOp=r,this.stencilStoreOp=n,this.barrier=o}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.barrier=t.barrier,this}}class Yd{constructor(t,e,i,s,r,n,o,a,h){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===i&&(i=[]),void 0===s&&(s=[]),void 0===r&&(r=-1),void 0===n&&(n=-1),void 0===o&&(o=-1),void 0===a&&(a=0),void 0===h&&(h=0),this.inputs=t,this.colors=e,this.resolves=i,this.preserves=s,this.depthStencil=r,this.depthStencilResolve=n,this.shadingRate=o,this.depthResolveMode=a,this.stencilResolveMode=h}copy(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.shadingRate=t.shadingRate,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this}}class Qd{constructor(t,e,i,s,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===s&&(s=0),void 0===r&&(r=0),this.srcSubpass=t,this.dstSubpass=e,this.generalBarrier=i,this.prevAccesses=s,this.nextAccesses=r}copy(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.generalBarrier=t.generalBarrier,this.prevAccesses=t.prevAccesses,this.nextAccesses=t.nextAccesses,this}}class Kd{constructor(t,e,i,s,r){void 0===t&&(t=[]),void 0===e&&(e=new Xd),void 0===i&&(i=new Xd),void 0===s&&(s=[]),void 0===r&&(r=[]),this.colorAttachments=t,this.depthStencilAttachment=e,this.depthStencilResolveAttachment=i,this.subpasses=s,this.dependencies=r}copy(t){return vu(this.colorAttachments,t.colorAttachments,qd),this.depthStencilAttachment.copy(t.depthStencilAttachment),this.depthStencilResolveAttachment.copy(t.depthStencilResolveAttachment),vu(this.subpasses,t.subpasses,Yd),vu(this.dependencies,t.dependencies,Qd),this}}class Zd{constructor(t,e,i,s,r,n,o,a,h){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=0),this.width=t,this.height=e,this.depthOrArraySize=i,this.firstSlice=s,this.numSlices=r,this.mipLevel=n,this.levelCount=o,this.basePlane=a,this.planeCount=h}copy(t){return this.width=t.width,this.height=t.height,this.depthOrArraySize=t.depthOrArraySize,this.firstSlice=t.firstSlice,this.numSlices=t.numSlices,this.mipLevel=t.mipLevel,this.levelCount=t.levelCount,this.basePlane=t.basePlane,this.planeCount=t.planeCount,this}}class Jd{constructor(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.prevAccesses=t,this.nextAccesses=e,this.type=i}copy(t){return this.prevAccesses=t.prevAccesses,this.nextAccesses=t.nextAccesses,this.type=t.type,this}}class tp{constructor(t,e,i,s,r,n,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=new Zd),void 0===r&&(r=!1),void 0===n&&(n=null),void 0===o&&(o=null),this.prevAccesses=t,this.nextAccesses=e,this.type=i,this.range=s,this.discardContents=r,this.srcQueue=n,this.dstQueue=o}copy(t){return this.prevAccesses=t.prevAccesses,this.nextAccesses=t.nextAccesses,this.type=t.type,this.range.copy(t.range),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this}}class ep{constructor(t,e,i,s,r,n,o,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=!1),void 0===o&&(o=null),void 0===a&&(a=null),this.prevAccesses=t,this.nextAccesses=e,this.type=i,this.offset=s,this.size=r,this.discardContents=n,this.srcQueue=o,this.dstQueue=a}copy(t){return this.prevAccesses=t.prevAccesses,this.nextAccesses=t.nextAccesses,this.type=t.type,this.offset=t.offset,this.size=t.size,this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this}}class ip{constructor(t,e,i,s){void 0===t&&(t=null),void 0===e&&(e=[]),void 0===i&&(i=null),void 0===s&&(s=null),this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=i,this.depthStencilResolveTexture=s}copy(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this.depthStencilResolveTexture=t.depthStencilResolveTexture,this}}class sp{constructor(t,e,i,s,r){void 0===t&&(t=-1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=[]),this.binding=t,this.descriptorType=e,this.count=i,this.stageFlags=s,this.immutableSamplers=r}copy(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this}}class rp{constructor(t){void 0===t&&(t=[]),this.bindings=t}copy(t){return vu(this.bindings,t.bindings,sp),this}}class np{constructor(t){void 0===t&&(t=null),this.layout=t}copy(t){return this.layout=t.layout,this}}class op{constructor(t){void 0===t&&(t=[]),this.setLayouts=t}copy(t){return this.setLayouts=t.setLayouts.slice(),this}}class ap{constructor(t){void 0===t&&(t=[]),this.attributes=t}copy(t){return vu(this.attributes,t.attributes,Wd),this}}class hp{constructor(t,e){void 0===t&&(t=null),void 0===e&&(e=0),this.queue=t,this.type=e}copy(t){return this.queue=t.queue,this.type=t.type,this}}class lp{constructor(t){void 0===t&&(t=0),this.type=t}copy(t){return this.type=t.type,this}}class cp{constructor(t,e,i){void 0===t&&(t=0),void 0===e&&(e=32767),void 0===i&&(i=!0),this.type=t,this.maxQueryObjects=e,this.forceWait=i}copy(t){return this.type=t.type,this.maxQueryObjects=t.maxQueryObjects,this.forceWait=t.forceWait,this}}class up{constructor(t,e,i,s,r,n,o,a){void 0===t&&(t=""),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=!1),void 0===n&&(n=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),this.name=t,this.size=e,this.count=i,this.type=s,this.hasAlpha=r,this.hasDepth=n,this.hasStencil=o,this.isCompressed=a}copy(t){return this.name=t.name,this.size=t.size,this.count=t.count,this.type=t.type,this.hasAlpha=t.hasAlpha,this.hasDepth=t.hasDepth,this.hasStencil=t.hasStencil,this.isCompressed=t.isCompressed,this}}class dp{constructor(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.bufferSize=t,this.textureSize=e}copy(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this}}class pp{constructor(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.writeMask=t,this.compareMask=e,this.reference=i}copy(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this}}class _p{constructor(t,e,i,s,r,n,o,a,h,l,c){void 0===t&&(t=new wd),void 0===e&&(e=new _d),void 0===i&&(i=new Sd),void 0===s&&(s=1),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=0),void 0===l&&(l=new pp),void 0===c&&(c=new pp),this.viewport=t,this.scissor=e,this.blendConstant=i,this.lineWidth=s,this.depthBiasConstant=r,this.depthBiasClamp=n,this.depthBiasSlope=o,this.depthMinBounds=a,this.depthMaxBounds=h,this.stencilStatesFront=l,this.stencilStatesBack=c}copy(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this}}class gp extends fu{get objectType(){return this._objectType}get objectID(){return this._objectID}get typedID(){return this._typedID}constructor(t){super(),this._objectType=0,this._objectID=0,this._typedID=0,this._objectType=t,this._objectID=gp._idTable[0]++,this._typedID=gp._idTable[t]++}}gp._idTable=Array(19).fill(65536);const fp={ATTR_POSITION:"a_position",ATTR_NORMAL:"a_normal",ATTR_TANGENT:"a_tangent",ATTR_BITANGENT:"a_bitangent",ATTR_WEIGHTS:"a_weights",ATTR_JOINTS:"a_joints",ATTR_COLOR:"a_color",ATTR_COLOR1:"a_color1",ATTR_COLOR2:"a_color2",ATTR_TEX_COORD:"a_texCoord",ATTR_TEX_COORD1:"a_texCoord1",ATTR_TEX_COORD2:"a_texCoord2",ATTR_TEX_COORD3:"a_texCoord3",ATTR_TEX_COORD4:"a_texCoord4",ATTR_TEX_COORD5:"a_texCoord5",ATTR_TEX_COORD6:"a_texCoord6",ATTR_TEX_COORD7:"a_texCoord7",ATTR_TEX_COORD8:"a_texCoord8",ATTR_BATCH_ID:"a_batch_id",ATTR_BATCH_UV:"a_batch_uv"},mp=Object.freeze([new up("UNKNOWN",0,0,0,!1,!1,!1,!1),new up("A8",1,1,1,!0,!1,!1,!1),new up("L8",1,1,1,!1,!1,!1,!1),new up("LA8",1,2,1,!0,!1,!1,!1),new up("R8",1,1,1,!1,!1,!1,!1),new up("R8SN",1,1,2,!1,!1,!1,!1),new up("R8UI",1,1,3,!1,!1,!1,!1),new up("R8I",1,1,4,!1,!1,!1,!1),new up("R16F",2,1,6,!1,!1,!1,!1),new up("R16UI",2,1,3,!1,!1,!1,!1),new up("R16I",2,1,4,!1,!1,!1,!1),new up("R32F",4,1,6,!1,!1,!1,!1),new up("R32UI",4,1,3,!1,!1,!1,!1),new up("R32I",4,1,4,!1,!1,!1,!1),new up("RG8",2,2,1,!1,!1,!1,!1),new up("RG8SN",2,2,2,!1,!1,!1,!1),new up("RG8UI",2,2,3,!1,!1,!1,!1),new up("RG8I",2,2,4,!1,!1,!1,!1),new up("RG16F",4,2,6,!1,!1,!1,!1),new up("RG16UI",4,2,3,!1,!1,!1,!1),new up("RG16I",4,2,4,!1,!1,!1,!1),new up("RG32F",8,2,6,!1,!1,!1,!1),new up("RG32UI",8,2,3,!1,!1,!1,!1),new up("RG32I",8,2,4,!1,!1,!1,!1),new up("RGB8",3,3,1,!1,!1,!1,!1),new up("SRGB8",3,3,1,!1,!1,!1,!1),new up("RGB8SN",3,3,2,!1,!1,!1,!1),new up("RGB8UI",3,3,3,!1,!1,!1,!1),new up("RGB8I",3,3,4,!1,!1,!1,!1),new up("RGB16F",6,3,6,!1,!1,!1,!1),new up("RGB16UI",6,3,3,!1,!1,!1,!1),new up("RGB16I",6,3,4,!1,!1,!1,!1),new up("RGB32F",12,3,6,!1,!1,!1,!1),new up("RGB32UI",12,3,3,!1,!1,!1,!1),new up("RGB32I",12,3,4,!1,!1,!1,!1),new up("RGBA8",4,4,1,!0,!1,!1,!1),new up("BGRA8",4,4,1,!0,!1,!1,!1),new up("SRGB8_A8",4,4,1,!0,!1,!1,!1),new up("RGBA8SN",4,4,2,!0,!1,!1,!1),new up("RGBA8UI",4,4,3,!0,!1,!1,!1),new up("RGBA8I",4,4,4,!0,!1,!1,!1),new up("RGBA16F",8,4,6,!0,!1,!1,!1),new up("RGBA16UI",8,4,3,!0,!1,!1,!1),new up("RGBA16I",8,4,4,!0,!1,!1,!1),new up("RGBA32F",16,4,6,!0,!1,!1,!1),new up("RGBA32UI",16,4,3,!0,!1,!1,!1),new up("RGBA32I",16,4,4,!0,!1,!1,!1),new up("R5G6B5",2,3,1,!1,!1,!1,!1),new up("R11G11B10F",4,3,6,!1,!1,!1,!1),new up("RGB5A1",2,4,1,!0,!1,!1,!1),new up("RGBA4",2,4,1,!0,!1,!1,!1),new up("RGB10A2",2,4,1,!0,!1,!1,!1),new up("RGB10A2UI",2,4,3,!0,!1,!1,!1),new up("RGB9E5",2,4,6,!0,!1,!1,!1),new up("DEPTH",4,1,6,!1,!0,!1,!1),new up("DEPTH_STENCIL",5,2,6,!1,!0,!0,!1),new up("BC1",1,3,1,!1,!1,!1,!0),new up("BC1_ALPHA",1,4,1,!0,!1,!1,!0),new up("BC1_SRGB",1,3,1,!1,!1,!1,!0),new up("BC1_SRGB_ALPHA",1,4,1,!0,!1,!1,!0),new up("BC2",1,4,1,!0,!1,!1,!0),new up("BC2_SRGB",1,4,1,!0,!1,!1,!0),new up("BC3",1,4,1,!0,!1,!1,!0),new up("BC3_SRGB",1,4,1,!0,!1,!1,!0),new up("BC4",1,1,1,!1,!1,!1,!0),new up("BC4_SNORM",1,1,2,!1,!1,!1,!0),new up("BC5",1,2,1,!1,!1,!1,!0),new up("BC5_SNORM",1,2,2,!1,!1,!1,!0),new up("BC6H_UF16",1,3,5,!1,!1,!1,!0),new up("BC6H_SF16",1,3,6,!1,!1,!1,!0),new up("BC7",1,4,1,!0,!1,!1,!0),new up("BC7_SRGB",1,4,1,!0,!1,!1,!0),new up("ETC_RGB8",1,3,1,!1,!1,!1,!0),new up("ETC2_RGB8",1,3,1,!1,!1,!1,!0),new up("ETC2_SRGB8",1,3,1,!1,!1,!1,!0),new up("ETC2_RGB8_A1",1,4,1,!0,!1,!1,!0),new up("ETC2_SRGB8_A1",1,4,1,!0,!1,!1,!0),new up("ETC2_RGBA8",2,4,1,!0,!1,!1,!0),new up("ETC2_SRGB8_A8",2,4,1,!0,!1,!1,!0),new up("EAC_R11",1,1,1,!1,!1,!1,!0),new up("EAC_R11SN",1,1,2,!1,!1,!1,!0),new up("EAC_RG11",2,2,1,!1,!1,!1,!0),new up("EAC_RG11SN",2,2,2,!1,!1,!1,!0),new up("PVRTC_RGB2",2,3,1,!1,!1,!1,!0),new up("PVRTC_RGBA2",2,4,1,!0,!1,!1,!0),new up("PVRTC_RGB4",2,3,1,!1,!1,!1,!0),new up("PVRTC_RGBA4",2,4,1,!0,!1,!1,!0),new up("PVRTC2_2BPP",2,4,1,!0,!1,!1,!0),new up("PVRTC2_4BPP",2,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_4x4",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_5x4",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_5x5",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_6x5",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_6x6",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_8x5",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_8x6",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_8x8",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_10x5",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_10x6",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_10x8",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_10x10",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_12x10",1,4,1,!0,!1,!1,!0),new up("ASTC_RGBA_12x12",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_4x4",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_5x4",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_5x5",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_6x5",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_6x6",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_8x5",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_8x6",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_8x8",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_10x5",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_10x6",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_10x8",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_10x10",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_12x10",1,4,1,!0,!1,!1,!0),new up("ASTC_SRGBA_12x12",1,4,1,!0,!1,!1,!0)]),yp=15,vp=496;function bp(t){return t>0&&!(t&t-1)}const wp=Math.ceil;function Sp(t,e,i,s){if(!mp[t].isCompressed)return e*i*s*mp[t].size;switch(t){case 56:case 57:case 58:case 59:case 72:case 73:case 74:case 75:case 79:case 80:case 85:case 86:case 88:return wp(e/4)*wp(i/4)*8*s;case 60:case 61:case 62:case 63:case 64:case 65:case 69:case 68:case 70:case 71:case 77:case 76:case 81:case 82:case 89:case 103:return wp(e/4)*wp(i/4)*16*s;case 66:case 67:return wp(e/4)*wp(i/4)*32*s;case 83:case 84:case 87:return wp(e/8)*wp(i/4)*8*s;case 90:case 104:return wp(e/5)*wp(i/4)*16*s;case 91:case 105:return wp(e/5)*wp(i/5)*16*s;case 92:case 106:return wp(e/6)*wp(i/5)*16*s;case 93:case 107:return wp(e/6)*wp(i/6)*16*s;case 94:case 108:return wp(e/8)*wp(i/5)*16*s;case 95:case 109:return wp(e/8)*wp(i/6)*16*s;case 96:case 110:return wp(e/8)*wp(i/8)*16*s;case 97:case 111:return wp(e/10)*wp(i/5)*16*s;case 98:case 112:return wp(e/10)*wp(i/6)*16*s;case 99:case 113:return wp(e/10)*wp(i/8)*16*s;case 100:case 114:return wp(e/10)*wp(i/10)*16*s;case 101:case 115:return wp(e/12)*wp(i/10)*16*s;case 102:case 116:return wp(e/12)*wp(i/12)*16*s;default:return 0}}function xp(t,e,i,s,r){let n=0;for(let o=0;o<r;++o)n+=Sp(t,e,i,s),e=Math.max(e>>1,1),i=Math.max(i>>1,1);return n}const Tp=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Cp(t){return Tp[t]||0}function Ip(t){if(t.isCompressed)return Uint8Array;const e=t.size/t.count;switch(t.type){case 1:case 3:switch(e){case 1:default:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}case 2:case 4:switch(e){case 1:default:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}case 6:return 2===e?Uint16Array:Float32Array}return Float32Array}function Ep(t){switch(t){case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:case 64:case 65:case 69:case 68:case 70:case 71:case 66:case 67:case 72:case 73:case 74:case 75:case 79:case 80:case 77:case 76:case 81:case 82:case 85:case 86:case 88:case 89:case 103:return{width:4,height:4};case 83:case 84:case 87:return{width:8,height:4};case 90:case 104:return{width:5,height:4};case 91:case 105:return{width:5,height:5};case 92:case 106:return{width:6,height:5};case 93:case 107:return{width:6,height:6};case 94:case 108:return{width:8,height:5};case 95:case 109:return{width:8,height:6};case 96:case 110:return{width:8,height:8};case 97:case 111:return{width:10,height:5};case 98:case 112:return{width:10,height:6};case 99:case 113:return{width:10,height:8};case 100:case 114:return{width:10,height:10};case 101:case 115:return{width:12,height:10};case 102:case 116:return{width:12,height:12};default:return{width:1,height:1}}}function Dp(t,e){return wp(t/e)*e}var Ap=Object.freeze({__proto__:null,API:Su,AccessFlagBit:Xu,Address:Nu,Attribute:Wd,AttributeName:fp,BarrierType:hd,BindingMappingInfo:Td,BlendFactor:Hu,BlendOp:Gu,BufferBarrierInfo:ep,BufferFlagBit:Au,BufferInfo:Ed,BufferTextureCopy:bd,BufferUsageBit:Du,BufferViewInfo:Dd,ClearFlagBit:ad,Color:Sd,ColorAttachment:qd,ColorMask:Wu,CommandBufferInfo:hp,CommandBufferType:od,ComparisonFunc:Uu,CullMode:td,DESCRIPTOR_BUFFER_TYPE:yp,DESCRIPTOR_DYNAMIC_TYPE:10,DESCRIPTOR_SAMPLER_TYPE:vp,DRAW_INFO_SIZE:28,DepthStencilAttachment:Xd,DescriptorSetInfo:np,DescriptorSetLayoutBinding:sp,DescriptorSetLayoutInfo:rp,DescriptorType:sd,DeviceCaps:ud,DeviceInfo:Id,DeviceOptions:dd,DispatchInfo:Md,DrawInfo:Ad,DynamicStateFlagBit:ed,DynamicStates:_p,DynamicStencilStates:pp,Extent:gd,Feature:Tu,Filter:ku,Format:Cu,FormatFeatureBit:Lu,FormatInfo:up,FormatInfos:mp,FormatSize:Sp,FormatSurfaceSize:xp,FormatType:Iu,FramebufferInfo:ip,GFXObject:gp,GeneralBarrierInfo:Jd,GetTypeSize:Cp,IndirectBuffer:Pd,InputAssemblerInfo:$d,InputState:ap,IsPowerOf2:bp,LoadOp:$u,MarkerInfo:xd,MemoryAccessBit:Mu,MemoryStatus:dp,MemoryUsageBit:Pu,ObjectType:bu,Offset:pd,PassType:ld,PipelineBindPoint:Qu,PipelineLayoutInfo:op,PolygonMode:Zu,PrimitiveMode:Ku,QueryPoolInfo:cp,QueryType:nd,QueueInfo:lp,QueueType:rd,Rect:_d,RenderPassInfo:Kd,ResolveMode:Yu,ResourceRange:Zd,SampleCount:Fu,SamplerInfo:Od,ShadeModel:Ju,ShaderInfo:jd,ShaderStage:Gd,ShaderStageFlagBit:ju,Size:cd,Status:wu,StencilFace:id,StencilOp:Vu,StoreOp:qu,SubpassDependency:Qd,SubpassInfo:Yd,SurfaceTransform:xu,SwapchainInfo:Cd,TextureBarrierInfo:tp,TextureBlit:vd,TextureCopy:yd,TextureFlagBit:Ou,TextureInfo:Bd,TextureSubresLayers:fd,TextureSubresRange:md,TextureType:Bu,TextureUsageBit:Ru,TextureViewInfo:Rd,Type:Eu,Uniform:Ld,UniformBlock:Fd,UniformInputAttachment:Hd,UniformSampler:kd,UniformSamplerTexture:zd,UniformStorageBuffer:Vd,UniformStorageImage:Ud,UniformTexture:Nd,Viewport:wd,VsyncMode:zu,alignTo:Dp,formatAlignment:Ep,getTypedArrayConstructor:Ip});class Mp extends gp{get usage(){return this._usage}get memUsage(){return this._memUsage}get size(){return this._size}get stride(){return this._stride}get count(){return this._count}get flags(){return this._flags}constructor(){super(2),this._usage=0,this._memUsage=0,this._size=0,this._stride=1,this._count=0,this._flags=0,this._isBufferView=!1}}class Pp extends gp{get type(){return this._type}get queue(){return this._queue}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}constructor(){super(13),this._queue=null,this._type=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}}class Bp{constructor(){this._gfxAPI=0,this._renderer="",this._vendor="",this._features=new Array(10),this._formatFeatures=new Array(117),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new dp,this._caps=new ud,this._bindingMappingInfo=new Td,this._samplers=new Map,this._generalBarrierss=new Map,this._textureBarriers=new Map,this._bufferBarriers=new Map,this._swapchainFormat=35}get gfxAPI(){return this._gfxAPI}get queue(){return this._queue}get commandBuffer(){return this._cmdBuff}get swapchainFormat(){return this._swapchainFormat}get renderer(){return this._renderer}get vendor(){return this._vendor}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}get memoryStatus(){return this._memoryStatus}get capabilities(){return this._caps}get bindingMappingInfo(){return this._bindingMappingInfo}hasFeature(t){return this._features[t]}getFormatFeatures(t){return this._formatFeatures[t]}enableAutoBarrier(t){}getMaxSampleCount(t,e,i){return 1}}Bp.canvas=void 0;class Rp extends gp{get colorTexture(){return this._colorTexture}get depthStencilTexture(){return this._depthStencilTexture}get surfaceTransform(){return this._transform}get width(){return this._colorTexture.width}get height(){return this._colorTexture.height}constructor(){super(1),this._transform=0,this._colorTexture=null,this._depthStencilTexture=null}}class Op extends gp{get renderPass(){return this._renderPass}get colorTextures(){return this._colorTextures}get depthStencilTexture(){return this._depthStencilTexture}get width(){var t,e;return this.colorTextures.length>0?null!==(t=null===(e=this.colorTextures[0])||void 0===e?void 0:e.width)&&void 0!==t?t:this._width:this.depthStencilTexture?this.depthStencilTexture.width:this._width}get height(){var t,e;return this.colorTextures.length>0?null!==(t=null===(e=this.colorTextures[0])||void 0===e?void 0:e.height)&&void 0!==t?t:this._height:this.depthStencilTexture?this.depthStencilTexture.height:this._height}get needRebuild(){return!1}constructor(){super(5),this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._width=0,this._height=0}}class Lp extends gp{get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get indirectBuffer(){return this._indirectBuffer}get attributesHash(){return this._attributesHash}set vertexCount(t){this._drawInfo.vertexCount=t}get vertexCount(){return this._drawInfo.vertexCount}set firstVertex(t){this._drawInfo.firstVertex=t}get firstVertex(){return this._drawInfo.firstVertex}set indexCount(t){this._drawInfo.indexCount=t}get indexCount(){return this._drawInfo.indexCount}set firstIndex(t){this._drawInfo.firstIndex=t}get firstIndex(){return this._drawInfo.firstIndex}set vertexOffset(t){this._drawInfo.vertexOffset=t}get vertexOffset(){return this._drawInfo.vertexOffset}set instanceCount(t){this._drawInfo.instanceCount=t}get instanceCount(){return this._drawInfo.instanceCount}set firstInstance(t){this._drawInfo.firstInstance=t}get firstInstance(){return this._drawInfo.firstInstance}set drawInfo(t){this._drawInfo=t}get drawInfo(){return this._drawInfo}constructor(){super(12),this._attributes=[],this._attributesHash=0,this._vertexBuffers=[],this._indexBuffer=null,this._indirectBuffer=null,this._drawInfo=new Ad}getVertexBuffer(t){return void 0===t&&(t=0),t<this._vertexBuffers.length?this._vertexBuffers[t]:null}computeAttributesHash(){let t="attrs";for(let e=0;e<this.attributes.length;++e){const i=this.attributes[e];t+=`,${i.name},${i.format},${i.isNormalized},${i.stream},${i.isInstanced},${i.location}`}return du(t,666)}}class Fp extends gp{get layout(){return this._layout}constructor(){super(11),this._layout=null,this._buffers=[],this._textures=[],this._samplers=[],this._isDirty=!1}bindBuffer(t,e,i){void 0===i&&(i=0);const s=this._layout.bindingIndices[t],r=this._layout.bindings[s];if(r&&r.descriptorType&yp){const s=this._layout.descriptorIndices[t];this._buffers[s+i]!==e&&(this._buffers[s+i]=e,this._isDirty=!0)}}bindSampler(t,e,i){void 0===i&&(i=0);const s=this._layout.bindingIndices[t],r=this._layout.bindings[s];if(r&&r.descriptorType&vp){const s=this._layout.descriptorIndices[t];this._samplers[s+i]!==e&&(this._samplers[s+i]=e,this._isDirty=!0)}}bindTexture(t,e,i,s){void 0===i&&(i=0);const r=this._layout.bindingIndices[t],n=this._layout.bindings[r];if(n&&n.descriptorType&vp){const s=this._layout.descriptorIndices[t];this._textures[s+i]!==e&&(this._textures[s+i]=e,this._isDirty=!0)}}getBuffer(t,e){void 0===e&&(e=0);const i=this._layout.descriptorIndices[t];return this._buffers[i+e]}getSampler(t,e){void 0===e&&(e=0);const i=this._layout.descriptorIndices[t];return this._samplers[i+e]}getTexture(t,e){void 0===e&&(e=0);const i=this._layout.descriptorIndices[t];return this._textures[i+e]}}class zp extends gp{get bindings(){return this._bindings}get bindingIndices(){return this._bindingIndices}get descriptorIndices(){return this._descriptorIndices}constructor(){super(8),this._bindings=[],this._bindingIndices=[],this._descriptorIndices=[]}}class kp extends gp{get setLayouts(){return this._setLayouts}constructor(){super(9),this._setLayouts=[]}}class Np{get native(){return this}constructor(t,e,i,s,r,n,o,a,h,l,c,u){void 0===t&&(t=!1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=2),void 0===r&&(r=!0),void 0===n&&(n=!1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=0),void 0===l&&(l=!0),void 0===c&&(c=!1),void 0===u&&(u=1),this.isDiscard=t,this.polygonMode=e,this.shadeModel=i,this.cullMode=s,this.isFrontFaceCCW=r,this.depthBiasEnabled=n,this.depthBias=o,this.depthBiasClamp=a,this.depthBiasSlop=h,this.isDepthClip=l,this.isMultisample=c,this.lineWidth=u}reset(){this.isDiscard=!1,this.polygonMode=0,this.shadeModel=0,this.cullMode=2,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}assign(t){Object.assign(this,t)}destroy(){}}class Up{get native(){return this}constructor(t,e,i,s,r,n,o,a,h,l,c,u,d,p,_,g,f,m,y){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===i&&(i=1),void 0===s&&(s=!1),void 0===r&&(r=7),void 0===n&&(n=65535),void 0===o&&(o=65535),void 0===a&&(a=1),void 0===h&&(h=1),void 0===l&&(l=1),void 0===c&&(c=1),void 0===u&&(u=!1),void 0===d&&(d=7),void 0===p&&(p=65535),void 0===_&&(_=65535),void 0===g&&(g=1),void 0===f&&(f=1),void 0===m&&(m=1),void 0===y&&(y=1),this.depthTest=t,this.depthWrite=e,this.depthFunc=i,this.stencilTestFront=s,this.stencilFuncFront=r,this.stencilReadMaskFront=n,this.stencilWriteMaskFront=o,this.stencilFailOpFront=a,this.stencilZFailOpFront=h,this.stencilPassOpFront=l,this.stencilRefFront=c,this.stencilTestBack=u,this.stencilFuncBack=d,this.stencilReadMaskBack=p,this.stencilWriteMaskBack=_,this.stencilFailOpBack=g,this.stencilZFailOpBack=f,this.stencilPassOpBack=m,this.stencilRefBack=y}reset(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=1,this.stencilTestFront=!1,this.stencilFuncFront=7,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=1,this.stencilZFailOpFront=1,this.stencilPassOpFront=1,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=7,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=1,this.stencilZFailOpBack=1,this.stencilPassOpBack=1,this.stencilRefBack=1}assign(t){Object.assign(this,t)}destroy(){}}class Vp{constructor(t,e,i,s,r,n,o,a){void 0===t&&(t=!1),void 0===e&&(e=1),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=1),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=15),this.blend=t,this.blendSrc=e,this.blendDst=i,this.blendEq=s,this.blendSrcAlpha=r,this.blendDstAlpha=n,this.blendAlphaEq=o,this.blendColorMask=a}reset(){this.blend=!1,this.blendSrc=1,this.blendDst=0,this.blendEq=0,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.blendAlphaEq=0,this.blendColorMask=15}assign(t){Object.assign(this,t)}destroy(){}}class Hp{get native(){return this}constructor(t,e,i,s){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=new Sd),void 0===s&&(s=[new Vp]),this.isA2C=t,this.isIndepend=e,this.blendColor=i,this.targets=s}setTarget(t,e){let i=this.targets[t];i||(i=this.targets[t]=new Vp),Object.assign(i,e)}reset(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()}destroy(){}}class Gp{constructor(t,e,i,s,r,n,o,a,h,l){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),void 0===s&&(s=new ap),void 0===r&&(r=new Np),void 0===n&&(n=new Up),void 0===o&&(o=new Hp),void 0===a&&(a=7),void 0===h&&(h=0),void 0===l&&(l=0),this.shader=t,this.pipelineLayout=e,this.renderPass=i,this.inputState=s,this.rasterizerState=r,this.depthStencilState=n,this.blendState=o,this.primitive=a,this.dynamicStates=h,this.bindPoint=l}}class Wp extends gp{get shader(){return this._shader}get pipelineLayout(){return this._pipelineLayout}get primitive(){return this._primitive}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get inputState(){return this._is}get dynamicStates(){return this._dynamicStates}get renderPass(){return this._renderPass}constructor(){super(10),this._shader=null,this._pipelineLayout=null,this._primitive=7,this._is=null,this._rs=new Np,this._dss=new Up,this._bs=new Hp,this._dynamicStates=0,this._renderPass=null}}class jp extends gp{get type(){return this._type}constructor(){super(14),this._type=0}}class $p extends gp{get colorAttachments(){return this._colorInfos}get depthStencilAttachment(){return this._depthStencilInfo}get subPasses(){return this._subpasses}get hash(){return this._hash}constructor(){super(4),this._colorInfos=[],this._depthStencilInfo=null,this._subpasses=[],this._hash=0}computeHash(){let t="";if(this._subpasses.length)for(let e=0;e<this._subpasses.length;++e){const i=this._subpasses[e];if(i.inputs.length){t+="ia";for(let e=0;e<i.inputs.length;++e){const s=this._colorInfos[i.inputs[e]];t+=`,${s.format},${s.sampleCount}`}}if(i.colors.length){t+="ca";for(let e=0;e<i.inputs.length;++e){const s=this._colorInfos[i.inputs[e]];t+=`,${s.format},${s.sampleCount}`}}if(i.depthStencil>=0){const e=this._colorInfos[i.depthStencil];t+=`ds,${e.format},${e.sampleCount}`}}else{t+="ca";for(let e=0;e<this._colorInfos.length;++e){const i=this._colorInfos[e];t+=`,${i.format},${i.sampleCount}`}const e=this._depthStencilInfo;e&&(t+=`ds,${e.format},${e.sampleCount}`)}return du(t,666)}}class qp extends gp{get info(){return this._info}get hash(){return this._hash}constructor(t,e){super(6),this._info=new Od,this._hash=0,this._info.copy(t),this._hash=e}static computeHash(t){let e=t.minFilter;return e|=t.magFilter<<2,e|=t.mipFilter<<4,e|=t.addressU<<6,e|=t.addressV<<8,e|=t.addressW<<10,e|=Math.min(t.maxAnisotropy,16)<<12,e|=t.cmpFunc<<17,e}static unpackFromHash(t){const e=new Od;return e.minFilter=3&t,e.magFilter=t>>2&3,e.mipFilter=t>>4&3,e.addressU=t>>6&3,e.addressV=t>>8&3,e.addressW=t>>10&3,e.maxAnisotropy=t>>12&31,e.cmpFunc=t>>17&7,e}}class Xp extends gp{get name(){return this._name}get attributes(){return this._attributes}get blocks(){return this._blocks}get samplers(){return this._samplers}get stages(){return this._stages}constructor(){super(7),this._name="",this._stages=[],this._attributes=[],this._blocks=[],this._samplers=[]}}class Yp extends gp{get type(){return this._info.type}get usage(){return this._info.usage}get format(){return this._info.format}get width(){return this._info.width}get height(){return this._info.height}get depth(){return this._info.depth}get layerCount(){return this._info.layerCount}get levelCount(){return this._info.levelCount}get samples(){return this._info.samples}get flags(){return this._info.flags}get size(){return this._size}get info(){return this._info}get viewInfo(){return this._viewInfo}get isTextureView(){return this._isTextureView}constructor(){super(3),this._info=new Bd,this._viewInfo=new Rd,this._isPowerOf2=!1,this._isTextureView=!1,this._size=0}static getLevelCount(t,e){return Math.floor(Math.log2(Math.max(t,e)))}}class Qp extends gp{get info(){return this._info}get hash(){return this._hash}constructor(t,e){super(16),this._info=new Jd,this._hash=0,this._info.copy(t),this._hash=e}static computeHash(t){return du(`${t.prevAccesses} ${t.nextAccesses} ${t.type}`,666)}}class Kp extends gp{get info(){return this._info}get hash(){return this._hash}constructor(t,e){super(17),this._info=new tp,this._hash=0,this._info.copy(t),this._hash=e}static computeHash(t){let e=`${t.prevAccesses} ${t.nextAccesses}`;return e+=t.type,e+=t.range.mipLevel,e+=t.range.levelCount,e+=t.range.firstSlice,e+=t.range.numSlices,e+=t.range.basePlane,e+=t.range.planeCount,e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,e+=t.dstQueue?t.dstQueue.type:0,du(e,666)}}class Zp extends gp{get info(){return this._info}get hash(){return this._hash}constructor(t,e){super(18),this._info=new ep,this._hash=0,this._info.copy(t),this._hash=e}static computeHash(t){let e=`${t.prevAccesses} ${t.nextAccesses}`;return e+=t.type,e+=t.offset,e+=t.size,e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,e+=t.dstQueue?t.dstQueue.type:0,du(e,666)}}const Jp={Device:Bp,Swapchain:Rp,Buffer:Mp,Texture:Yp,Sampler:qp,Shader:Xp,InputAssembler:Lp,RenderPass:$p,Framebuffer:Op,DescriptorSet:Fp,DescriptorSetLayout:zp,PipelineLayout:kp,PipelineState:Wp,CommandBuffer:Pp,Queue:jp,GeneralBarrier:Qp,TextureBarrier:Kp,BufferBarrier:Zp,RasterizerState:Np,BlendState:Hp,BlendTarget:Vp,DepthStencilState:Up,PipelineStateInfo:Gp};Object.assign(Jp,Ap),h.gfx=Jp;class t_{constructor(){this.initialized=!1,this._gfxDevice=void 0,this._canvas=null,this._swapchain=void 0,this._renderType=-1,this._deviceInitialized=!1}get gfxDevice(){return this._gfxDevice}get swapchain(){return this._swapchain}_tryInitializeWebGPUDevice(t,e){return this._deviceInitialized?Promise.resolve(!0):t?(this._gfxDevice=new t,new Promise(((t,i)=>{this._gfxDevice.initialize(e).then((e=>{this._deviceInitialized=e,t(e)})).catch((t=>{i(t)}))}))):Promise.resolve(!1)}_tryInitializeDeviceSync(t,e){return!!this._deviceInitialized||(t&&(this._gfxDevice=new t,this._deviceInitialized=this._gfxDevice.initialize(e)),this._deviceInitialized)}init(t,e){if(this.initialized)return!0;const i=ae.querySettings(oe.Category.RENDERING,"renderMode");this._canvas=t,this._canvas&&(this._canvas.oncontextmenu=()=>!1),this._renderType=this._determineRenderType(i),this._deviceInitialized=!1;const s=new Id(e);if(1===this._renderType||2===this._renderType){let e=!!globalThis.WebGL2RenderingContext;if(globalThis.navigator.userAgent.toLowerCase(),Hn.browserType===Pn.UC&&(e=!1),Bp.canvas=t,2===this._renderType&&h.WebGPUDevice)return new Promise(((t,e)=>{this._tryInitializeWebGPUDevice(h.WebGPUDevice,s).then((e=>{this._initSwapchain(),t(e)})).catch((t=>{e(t)}))}));e&&h.WebGL2Device&&this._tryInitializeDeviceSync(h.WebGL2Device,s),h.WebGLDevice&&this._tryInitializeDeviceSync(h.WebGLDevice,s),h.EmptyDevice&&this._tryInitializeDeviceSync(h.EmptyDevice,s),this._initSwapchain()}else 4===this._renderType&&h.EmptyDevice&&(this._tryInitializeDeviceSync(h.EmptyDevice,s),this._initSwapchain());return!!this._gfxDevice||(j(16337),this._renderType=-1,!1)}_initSwapchain(){const t=new Cd(1,this._canvas),e=Vn.windowSize;t.width=e.width,t.height=e.height,this._swapchain=this._gfxDevice.createSwapchain(t)}_supportWebGPU(){return"gpu"in globalThis.navigator}_determineRenderType(t){("number"!=typeof t||t>4||t<0)&&(t=0);let e=0,i=!1;if(1===t?(e=0,i=!0):0===t||4===t?(e=this._supportWebGPU()?2:1,i=!0):2===t?(e=1,i=!0):3===t&&(e=4,i=!0),!i)throw new Error(Y(3820,t));return e}}const e_=new t_;var i_=Object.freeze({__proto__:null,API:Su,AccessFlagBit:Xu,Address:Nu,Attribute:Wd,AttributeName:fp,BarrierType:hd,BindingMappingInfo:Td,BlendFactor:Hu,BlendOp:Gu,BlendState:Hp,BlendTarget:Vp,Buffer:Mp,BufferBarrierInfo:ep,BufferFlagBit:Au,BufferInfo:Ed,BufferTextureCopy:bd,BufferUsageBit:Du,BufferViewInfo:Dd,ClearFlagBit:ad,Color:Sd,ColorAttachment:qd,ColorMask:Wu,CommandBuffer:Pp,CommandBufferInfo:hp,CommandBufferType:od,ComparisonFunc:Uu,CullMode:td,DESCRIPTOR_BUFFER_TYPE:yp,DESCRIPTOR_DYNAMIC_TYPE:10,DESCRIPTOR_SAMPLER_TYPE:vp,DRAW_INFO_SIZE:28,DefaultResource:class{constructor(t){this._texture2D=null,this._texture3D=null,this._textureCube=null,this._texture2DArray=null;const e=t.capabilities,i=new Uint8Array(64);if(i.fill(255),e.maxTextureSize>=2){this._texture2D=t.createTexture(new Bd(1,12,35,2,2,0));const e=new bd(0,0,0,new pd(0,0,0),new gd(2,2,1));t.copyBuffersToTexture([i],this._texture2D,[e])}if(e.maxTextureSize>=2){this._textureCube=t.createTexture(new Bd(3,12,35,2,2,0,6));const e=new bd(0,0,0,new pd(0,0,0),new gd(2,2,1));t.copyBuffersToTexture([i],this._textureCube,[e]),e.texSubres.baseArrayLayer=1,t.copyBuffersToTexture([i],this._textureCube,[e]),e.texSubres.baseArrayLayer=2,t.copyBuffersToTexture([i],this._textureCube,[e]),e.texSubres.baseArrayLayer=3,t.copyBuffersToTexture([i],this._textureCube,[e]),e.texSubres.baseArrayLayer=4,t.copyBuffersToTexture([i],this._textureCube,[e]),e.texSubres.baseArrayLayer=5,t.copyBuffersToTexture([i],this._textureCube,[e])}if(e.max3DTextureSize>=2){this._texture3D=t.createTexture(new Bd(2,12,35,2,2,0,1,1,1,2));const e=new bd(0,0,0,new pd(0,0,0),new gd(2,2,2),new fd(0,0,1));t.copyBuffersToTexture([i],this._texture3D,[e])}if(e.maxArrayTextureLayers>=2){this._texture2DArray=t.createTexture(new Bd(5,12,35,2,2,0,2));const e=new bd(0,0,0,new pd(0,0,0),new gd(2,2,1),new fd(0,0,1));t.copyBuffersToTexture([i],this._texture2DArray,[e]),e.texSubres.baseArrayLayer=1,t.copyBuffersToTexture([i],this._texture2DArray,[e])}}getTexture(t){switch(t){case 1:return this._texture2D;case 2:return this._texture3D;case 3:return this._textureCube;case 5:return this._texture2DArray;default:return null}}},DepthStencilAttachment:Xd,DepthStencilState:Up,DescriptorSet:Fp,DescriptorSetInfo:np,DescriptorSetLayout:zp,DescriptorSetLayoutBinding:sp,DescriptorSetLayoutInfo:rp,DescriptorType:sd,Device:Bp,DeviceCaps:ud,DeviceInfo:Id,DeviceManager:t_,DeviceOptions:dd,DispatchInfo:Md,DrawInfo:Ad,DynamicStateFlagBit:ed,DynamicStates:_p,DynamicStencilStates:pp,Extent:gd,Feature:Tu,Filter:ku,Format:Cu,FormatFeatureBit:Lu,FormatInfo:up,FormatInfos:mp,FormatSize:Sp,FormatSurfaceSize:xp,FormatType:Iu,Framebuffer:Op,FramebufferInfo:ip,GFXObject:gp,GeneralBarrier:Qp,GeneralBarrierInfo:Jd,GetTypeSize:Cp,IndirectBuffer:Pd,InputAssembler:Lp,InputAssemblerInfo:$d,InputState:ap,IsPowerOf2:bp,LegacyRenderMode:{AUTO:0,CANVAS:1,WEBGL:2,HEADLESS:3,WEBGPU:4},LoadOp:$u,MarkerInfo:xd,MemoryAccessBit:Mu,MemoryStatus:dp,MemoryUsageBit:Pu,ObjectType:bu,Offset:pd,PassType:ld,PipelineBindPoint:Qu,PipelineLayout:kp,PipelineLayoutInfo:op,PipelineState:Wp,PipelineStateInfo:Gp,PolygonMode:Zu,PrimitiveMode:Ku,QueryPoolInfo:cp,QueryType:nd,Queue:jp,QueueInfo:lp,QueueType:rd,RasterizerState:Np,Rect:_d,RenderPass:$p,RenderPassInfo:Kd,RenderType:{UNKNOWN:-1,CANVAS:0,WEBGL:1,WEBGPU:2,OPENGL:3,HEADLESS:4},ResolveMode:Yu,ResourceRange:Zd,SampleCount:Fu,Sampler:qp,SamplerInfo:Od,ShadeModel:Ju,Shader:Xp,ShaderInfo:jd,ShaderStage:Gd,ShaderStageFlagBit:ju,Size:cd,Status:wu,StencilFace:id,StencilOp:Vu,StoreOp:qu,SubpassDependency:Qd,SubpassInfo:Yd,SurfaceTransform:xu,Swapchain:Rp,SwapchainInfo:Cd,Texture:Yp,TextureBarrier:Kp,TextureBarrierInfo:tp,TextureBlit:vd,TextureCopy:yd,TextureFlagBit:Ou,TextureInfo:Bd,TextureSubresLayers:fd,TextureSubresRange:md,TextureType:Bu,TextureUsageBit:Ru,TextureViewInfo:Rd,Type:Eu,Uniform:Ld,UniformBlock:Fd,UniformInputAttachment:Hd,UniformSampler:kd,UniformSamplerTexture:zd,UniformStorageBuffer:Vd,UniformStorageImage:Ud,UniformTexture:Nd,Viewport:wd,VsyncMode:zu,alignTo:Dp,deviceManager:e_,formatAlignment:Ep,getTypedArrayConstructor:Ip});t("gfx",i_);const s_=new cr;function r_(t,e,i,s){const r=i.chunk,n=i.data,o=r.vb,a=i.vertexCount,h=t.worldMatrix,l=h.m00,c=h.m01,u=h.m02,d=h.m03,p=h.m04,_=h.m05,g=h.m06,f=h.m07,m=h.m12,y=h.m13,v=h.m14,b=h.m15;s_.set(s.r/255,s.g/255,s.b/255,s.a/255);let w=0;for(let t=0;t<a;++t){const e=n[t],i=e.x,s=e.y;let r=d*i+f*s+b;r=r?1/r:1,o[w+0]=(l*i+p*s+m)*r,o[w+1]=(c*i+_*s+y)*r,o[w+2]=(u*i+g*s+v)*r,cr.toArray(o,s_,w+5),w+=9}r.bufferId;const S=r.vertexOffset,x=r.meshBuffer,T=r.meshBuffer.iData;let C=x.indexOffset;for(let t=0,e=a/4;t<e;t++){const e=S+4*t;T[C++]=e,T[C++]=e+1,T[C++]=e+2,T[C++]=e+1,T[C++]=e+3,T[C++]=e+2}x.indexOffset+=i.indexCount,x.setDirty()}function n_(t,e){const i=t.vertexFormat,s=t.chunk.vb;let r,n,o,a=0;for(let h=0;h<i.length;++h){if(r=i[h],n=mp[r.format],n.hasAlpha)if(o=t.floatStride,n.size/n.count==1){const t=~~fi(Math.round(255*e),0,255);for(let e=a;e<s.length;e+=o)s[e]=(4294967040&s[e]|t)>>>0}else if(n.size/n.count==4)for(let t=a+3;t<s.length;t+=o)s[t]=e;a+=n.size>>2}}const o_={};class a_{get map(){return this._map}constructor(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=dt(!0),this._count=0)}add(t,e){return t in this._map||this._count++,this._map[t]=e}get(t){return this._map[t]}has(t){return t in this._map}remove(t){const e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e}clear(){0!==this._count&&(this._map=dt(!0),this._count=0)}forEach(t){for(const e in this._map)t(this._map[e],e)}find(t){for(const e in this._map)if(t(this._map[e],e))return this._map[e];return null}get count(){return this._count}destroy(){this._map=null}}class h_{constructor(t,e){this.id=h_._pipelineId++,this.name="",this.pipes=[],this.name=t;for(let t=0,i=e.length;t<i;t++)this.pipes.push(e[t])}insert(t,e){return e>this.pipes.length?(G(4921),this):(this.pipes.splice(e,0,t),this)}append(t){return this.pipes.push(t),this}remove(t){return this.pipes.splice(t,1),this}sync(t){const e=this.pipes;if(0===e.length)return null;t.isFinished=!1;for(let i=0,s=e.length;i<s;){const r=(0,e[i])(t);if(r)return t.isFinished=!0,r;i++,i!==s&&(t.input=t.output,t.output=null)}return t.isFinished=!0,t.output}async(t){0!==this.pipes.length&&(t.isFinished=!1,this._flow(0,t))}_flow(t,e){(0,this.pipes[t])(e,(i=>{i?(e.isFinished=!0,e.dispatch("complete",i)):++t<this.pipes.length?(e.input=e.output,e.output=null,this._flow(t,e)):(e.isFinished=!0,e.dispatch("complete",i,e.output))}))}}h_._pipelineId=0;const l_=new a_,c_=new a_,u_=new a_,d_=new a_,p_=new h_("normal load",[]),__=new h_("fetch",[]),g_=new h_("transform url",[]),f_=new Map,m_={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};class y_{static create(t){let e;return 0!==y_._deadPool.length?(e=y_._deadPool.pop(),e.set(t)):e=new y_(t),e}get isFinish(){return this.isFinished}set isFinish(t){this.isFinished=t}constructor(t){this.id=y_._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinished=!0,this.set(t)}set(t){void 0===t&&(t=Object.create(null)),this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)}dispatch(t,e,i,s,r){switch(t){case"complete":this.onComplete&&this.onComplete(e,i);break;case"progress":this.onProgress&&this.onProgress(e,i,s,r);break;case"error":this.onError&&this.onError(e,i,s,r);break;default:{const n=`on${t[0].toUpperCase()}${t.substr(1)}`;"function"==typeof this[n]&&this[n](e,i,s,r);break}}}recycle(){y_._deadPool.length!==y_.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,y_._deadPool.push(this))}}y_.MAX_DEAD_NUM=500,y_._taskId=0,y_._deadPool=[];const v_="0123456789abcdef".split(""),b_=["","","",""],w_=b_.concat(b_,"-",b_,"-",b_,"-",b_,"-",b_,b_,b_),S_=w_.map(((t,e)=>"-"===t?NaN:e)).filter(Number.isFinite);function x_(t){const e=t.split("@")[0];if(22!==e.length)return t;w_[0]=t[0],w_[1]=t[1];for(let e=2,i=2;e<22;e+=2){const s=pe[t.charCodeAt(e)],r=pe[t.charCodeAt(e+1)];w_[S_[i++]]=v_[s>>2],w_[S_[i++]]=v_[(3&s)<<2|r>>4],w_[S_[i++]]=v_[15&r]}return t.replace(e,w_.join(""))}const T_=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function C_(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.nativeExt&&(e.ext=e.nativeExt);const i=d_.find((e=>!!e.getAssetInfo(t)));return i&&(e.bundle=i.name),D_(t,e)}function I_(t){return!!t&&(t instanceof h.SceneAsset||t instanceof h.Scene)}function E_(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function D_(t,e){const i=y_.create({input:t,options:e}),s=[];try{const t=g_.sync(i);for(const e of t){const t=e.url;e.recycle(),s.push(t)}}catch(t){for(const t of i.output)t.recycle();B(t.message,t.stack)}return i.recycle(),s.length>1?s:s[0]}var A_,M_,P_,B_=Object.freeze({__proto__:null,decodeUuid:x_,getUrlWithUuid:C_,getUuidFromURL:function(t){const e=T_.exec(t);return e?e[1]:""},isScene:I_,normalize:E_,transform:D_});const{ccclass:R_,serializable:O_,property:L_}=Ja;let F_=t("Asset",R_("cc.Asset")((M_=class extends(Dn(yn)){static deserialize(t){return h.deserialize(t)}get nativeUrl(){if(!this._nativeUrl){if(!this._native)return"";const t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=C_(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=C_(this._uuid,{__nativeName__:t,nativeExt:Rc(t),isNative:!0})}return this._nativeUrl}get uuid(){return this._uuid}get _nativeAsset(){return this._file}set _nativeAsset(t){this._file=t}get nativeAsset(){return this._file}constructor(t){void 0===t&&(t=""),super(t),this.loaded=!0,this._native=P_&&P_(),this._nativeUrl="",this._file=null,this._ref=0,Object.defineProperty(this,"_uuid",{value:"",writable:!0})}toString(){return this.nativeUrl}serialize(){}_setRawAsset(t,e){void 0===e&&(e=!0),this._native=!1!==e?t||"":`/${t}`}get _nativeDep(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}get refCount(){return this._ref}addRef(){return this._ref++,this}decRef(t){return void 0===t&&(t=!0),this._ref>0&&this._ref--,t&&h.assetManager.getReleaseManager().tryRelease(this),this}onLoaded(){}initDefault(t){t&&(this._uuid=t),this.isDefault=!0}validate(){return!0}destroy(){return O(Y(12101,this._uuid)),super.destroy()}},P_=Qo(M_.prototype,"_native",[O_],(function(){return""})),s(M_.prototype,"_nativeAsset",[L_],Object.getOwnPropertyDescriptor(M_.prototype,"_nativeAsset"),M_.prototype),A_=M_))||A_);var z_,k_,N_;F_.prototype.createNode=null,h.Asset=F_;const U_=1346981187,V_=te({PVR:0,PKM:1,ASTC:2});function H_(t,e){return 4===t?89:5===t?4===e?90:91:6===t?5===e?92:93:8===t?5===e?94:6===e?95:96:10===t?5===e?97:6===e?98:8===e?99:100:10===e?101:102}function G_(t,e){return t[e]<<8|t[e+1]}function W_(t){return!!(Hn.hasFeature(Hn.Feature.IMAGE_BITMAP)&&t instanceof ImageBitmap)}let j_=t("ImageAsset",oa("cc.ImageAsset")((N_=class t extends F_{static mergeCompressedTextureMips(t){let e=new Uint8Array(0),i=null;try{const i=8+4*t.length;let s=0;for(const e of t)s+=e.byteLength;s+=i,e=new Uint8Array(s);const r=new DataView(e.buffer,e.byteOffset,e.byteLength);r.setUint32(0,U_,!0),r.setUint32(4,t.length,!0);let n=i;for(let i=0;i<t.length;i++){const s=t[i];if(r.setUint32(8+4*i,s.byteLength,!0),s instanceof ArrayBuffer){const t=new Uint8Array(s);e.set(t,n)}else{const t=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);e.set(t,n)}n+=s.byteLength}}catch(t){i=t,P(i)}return e}static parseCompressedTextures(e,i){const s={_data:new Uint8Array(0),_compressed:!0,width:0,height:0,format:0,mipmapLevelDataSize:[]},r=e instanceof ArrayBuffer?e:e.buffer,n=new DataView(r);if(n.getUint32(0,!0)===U_){const r=n.getUint32(4,!0),o=n.getUint32(8,!0),a=8+4*r;t.parseCompressedTexture(e,0,a,o,i,s);let h=a+o;for(let o=1;o<r;o++){const r=n.getUint32(8+4*o,!0);t.parseCompressedTexture(e,o,h,r,i,s),h+=r}}else t.parseCompressedTexture(e,0,0,0,i,s);return s}static parseCompressedTexture(e,i,s,r,n,o){switch(n){case V_.PVR:t.parsePVRTexture(e,i,s,r,o);break;case V_.PKM:t.parsePKMTexture(e,i,s,r,o);break;case V_.ASTC:t.parseASTCTexture(e,i,s,r,o)}}static parsePVRTexture(t,e,i,s,r){const n=t instanceof ArrayBuffer?t:t.buffer,o=new Int32Array(n,i,13);if(55727696===o[0]){const t=i+o[12]+52,a=s-o.byteLength;if(s>0){const i=new Uint8Array(n,t,a),s=new Uint8Array(r._data.byteLength+i.byteLength);s.set(r._data),s.set(i,r._data.byteLength),r._data=s,r.mipmapLevelDataSize[e]=a}else r._data=new Uint8Array(n,t);r.width=e>0?r.width:o[7],r.height=e>0?r.height:o[6]}else{if(559044176!==o[11])throw new Error("Invalid magic number in PVR header");{const t=i+o[0],a=s-o.byteLength;if(s>0){const i=new Uint8Array(n,t,a),s=new Uint8Array(r._data.byteLength+i.byteLength);s.set(r._data),s.set(i,r._data.byteLength),r._data=s,r.mipmapLevelDataSize[e]=a}else r._data=new Uint8Array(n,t);r.width=e>0?r.width:o[1],r.height=e>0?r.height:o[2]}}}static parsePKMTexture(t,e,i,s,r){const n=t instanceof ArrayBuffer?t:t.buffer,o=new Uint8Array(n,i,16),a=G_(o,6);if(0!==a&&1!==a&&3!==a)throw new Error("Invalid magic number in ETC header");const h=i+16,l=s-16;if(s>0){const t=new Uint8Array(n,h,l),i=new Uint8Array(r._data.byteLength+t.byteLength);i.set(r._data),i.set(t,r._data.byteLength),r._data=i,r.mipmapLevelDataSize[e]=l}else r._data=new Uint8Array(n,h);r.width=e>0?r.width:G_(o,12),r.height=e>0?r.height:G_(o,14)}static parseASTCTexture(t,e,i,s,r){const n=t instanceof ArrayBuffer?t:t.buffer,o=new Uint8Array(n,i,16);if(1554098963!==o[0]+(o[1]<<8)+(o[2]<<16)+(o[3]<<24))throw new Error("Invalid magic number in ASTC header");const a=o[4],h=o[5],l=o[6];if((a<3||a>6||h<3||h>6||l<3||l>6)&&(a<4||7===a||9===a||11===a||a>12||h<4||7===h||9===h||11===h||h>12||1!==l))throw new Error("Invalid block number in ASTC header");const c=H_(a,h),u=i+16,d=s-16;if(s>0){const t=new Uint8Array(n,u,d),i=new Uint8Array(r._data.byteLength+t.byteLength);i.set(r._data),i.set(t,r._data.byteLength),r._data=i,r.mipmapLevelDataSize[e]=d}else r._data=new Uint8Array(n,u);r.width=e>0?r.width:o[7]+(o[8]<<8)+(o[9]<<16),r.height=e>0?r.height:o[10]+(o[11]<<8)+(o[12]<<16),r.format=c}extractMipmap0(){if(this.mipmapLevelDataSize&&this.mipmapLevelDataSize.length>0){const e=this.mipmapLevelDataSize[0],i=this.data,s=new Uint8Array(i.buffer,0,e),r=new t({_data:s,_compressed:!0,width:this.width,height:this.height,format:this.format,mipmapLevelDataSize:[]});return r._uuid=`${this._uuid}`,r}return this}extractMipmaps(){const e=[];if(this.mipmapLevelDataSize&&this.mipmapLevelDataSize.length>0){const i=this.mipmapLevelDataSize,s=this.data;let r=0,n=this.height,o=this.width;for(const a of i){const i=new Uint8Array(s.buffer,r,a),h=new t({_data:i,_compressed:!0,width:o,height:n,format:this.format,mipmapLevelDataSize:[]});r+=a,h._uuid=`${this._uuid}`,o=Math.max(o>>1,1),n=Math.max(n>>1,1),e.push(h)}}else e.push(this);return e}get _nativeAsset(){return this._nativeData}set _nativeAsset(t){t instanceof HTMLElement||W_(t)||(t.format=t.format||this._format),this.reset(t)}get data(){return(t=this._nativeData)instanceof HTMLImageElement||t instanceof HTMLCanvasElement||W_(t)?this._nativeData:this._nativeData&&this._nativeData._data;var t}get width(){return this._nativeData.width||this._width}get height(){return this._nativeData.height||this._height}get format(){return this._format}get isCompressed(){return this._format>=72&&this._format<=102||this._format>=1024&&this._format<=1026}get mipmapLevelDataSize(){return this._nativeData.mipmapLevelDataSize}get url(){return this.nativeUrl}constructor(t){super(),this._nativeData=void 0,this._exportedExts=void 0,this._format=35,this._width=0,this._height=0,this._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1,mipmapLevelDataSize:[]},void 0!==t&&this.reset(t)}reset(t){W_(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)}destroy(){if(this.data&&this.data instanceof HTMLImageElement)this.data.src="",this._setRawAsset("");else if(W_(this.data)){var t;null===(t=this.data)||void 0===t||t.close()}return super.destroy()}_serialize(){}_deserialize(e){let i="";"string"==typeof e?i=e:(this._width=e.w,this._height=e.h,i=e.fmt);const s=e_.gfxDevice,r=i.split("_");let n=Number.MAX_VALUE,o=this._format,a="";const h=le.SUPPORT_TEXTURE_FORMATS;for(const e of r){const i=e.split("@"),r=parseInt(i[0],void 0),l=t.extnames[r]||i[0],c=h.indexOf(l);if(-1!==c&&c<n){const t=i[1]?parseInt(i[1]):this._format;if(!(".astc"!==l||s&&2&s.getFormatFeatures(89)))continue;if(!(".pvr"!==l||s&&2&s.getFormatFeatures(86)))continue;if(!(72!==t&&1026!==t||s&&2&s.getFormatFeatures(72)))continue;if(!(73!==t&&77!==t||s&&2&s.getFormatFeatures(73)))continue;if(".webp"===l&&!Hn.hasFeature(Hn.Feature.WEBP))continue;n=c,a=l,o=t}}a?(this._setRawAsset(a),this._format=o):G(3121)}initDefault(e){if(super.initDefault(e),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{const e=u.document.createElement("canvas"),i=e.getContext("2d"),s=e.width=e.height=2;i.fillStyle="#ff00ff",i.fillRect(0,0,s,s),this.reset(e),t._sharedPlaceHolderCanvas=e}}validate(){return!!this.data}},N_.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],N_._sharedPlaceHolderCanvas=null,s((k_=N_).prototype,"_nativeAsset",[Wa],Object.getOwnPropertyDescriptor(k_.prototype,"_nativeAsset"),k_.prototype),z_=k_))||z_);var $_,q_,X_,Y_,Q_,K_,Z_,J_,tg,eg,ig;h.ImageAsset=j_,se(Cu);const sg=new tt("Tex");let rg=oa("cc.TextureBase")(((ig=class extends F_{get isCompressed(){return this._format>=72&&this._format<=102||this._format>=1024&&this._format<=1026}get width(){return this._width}get height(){return this._height}constructor(){super(),this._format=X_&&X_(),this._minFilter=Y_&&Y_(),this._magFilter=Q_&&Q_(),this._mipFilter=K_&&K_(),this._wrapS=Z_&&Z_(),this._wrapT=J_&&J_(),this._wrapR=tg&&tg(),this._anisotropy=eg&&eg(),this._width=1,this._height=1,this._samplerInfo=new Od,this._gfxSampler=null,this._gfxDevice=null,this._textureHash=0,this._id=sg.getNewId(),this._gfxDevice=this._getGFXDevice(),this._textureHash=du(this._id,666)}getId(){return this._id}getPixelFormat(){return this._format}getAnisotropy(){return this._anisotropy}setWrapMode(t,e,i){void 0===i&&(i=t),this._wrapS=t,this._samplerInfo.addressU=t,this._wrapT=e,this._samplerInfo.addressV=e,this._wrapR=i,this._samplerInfo.addressW=i,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}setFilters(t,e){this._minFilter=t,this._samplerInfo.minFilter=t,this._magFilter=e,this._samplerInfo.magFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}setMipFilter(t){this._mipFilter=t,this._samplerInfo.mipFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}setAnisotropy(t){t=Math.min(t,16),this._anisotropy=t,this._samplerInfo.maxAnisotropy=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))}destroy(){var t;const e=super.destroy();return e&&null!==(t=h.director.root)&&void 0!==t&&t.batcher2D&&h.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),e}getHash(){return this._textureHash}getGFXTexture(){return null}getSamplerInfo(){return this._samplerInfo}getGFXSampler(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):j(9302)),this._gfxSampler}_serialize(t){return""}_deserialize(t,e){const i=t.split(",");i.unshift(""),i.length>=5&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4]))),i.length>=7&&(this.setMipFilter(parseInt(i[5])),this.setAnisotropy(parseInt(i[6])))}_getGFXDevice(){return e_.gfxDevice}_getGFXFormat(){return this._getGFXPixelFormat(this._format)}_setGFXFormat(t){this._format=void 0===t?35:t}_getGFXPixelFormat(t){return 1026===t?t=72:1025===t?t=85:1024===t&&(t=83),t}}).PixelFormat={RGB565:47,RGB5A1:49,RGBA4444:50,RGB888:24,RGB32F:32,RGBA8888:35,BGRA8888:36,RGBA32F:44,A8:1,I8:2,AI8:3,RGB_PVRTC_2BPPV1:83,RGBA_PVRTC_2BPPV1:84,RGB_A_PVRTC_2BPPV1:1024,RGB_PVRTC_4BPPV1:85,RGBA_PVRTC_4BPPV1:86,RGB_A_PVRTC_4BPPV1:1025,RGB_ETC1:72,RGBA_ETC1:1026,RGB_ETC2:73,RGBA_ETC2:77,RGBA_ASTC_4x4:89,RGBA_ASTC_5x4:90,RGBA_ASTC_5x5:91,RGBA_ASTC_6x5:92,RGBA_ASTC_6x6:93,RGBA_ASTC_8x5:94,RGBA_ASTC_8x6:95,RGBA_ASTC_8x8:96,RGBA_ASTC_10x5:97,RGBA_ASTC_10x6:98,RGBA_ASTC_10x8:99,RGBA_ASTC_10x10:100,RGBA_ASTC_12x10:101,RGBA_ASTC_12x12:102},ig.WrapMode={REPEAT:0,CLAMP_TO_EDGE:2,MIRRORED_REPEAT:1,CLAMP_TO_BORDER:3},ig.Filter={NONE:0,LINEAR:2,NEAREST:1},X_=Qo((q_=ig).prototype,"_format",[va],(function(){return 35})),Y_=Qo(q_.prototype,"_minFilter",[va],(function(){return 2})),Q_=Qo(q_.prototype,"_magFilter",[va],(function(){return 2})),K_=Qo(q_.prototype,"_mipFilter",[va],(function(){return 0})),Z_=Qo(q_.prototype,"_wrapS",[va],(function(){return 0})),J_=Qo(q_.prototype,"_wrapT",[va],(function(){return 0})),tg=Qo(q_.prototype,"_wrapR",[va],(function(){return 0})),eg=Qo(q_.prototype,"_anisotropy",[va],(function(){return 0})),$_=q_))||$_;var ng,og,ag;h.TextureBase=rg;let hg=t("Script",oa("cc.Script")(ng=class extends F_{})||ng);h._Script=hg;let lg=t("JavaScript",oa("cc.JavaScript")(og=class extends hg{})||og);h._JavaScript=lg;let cg=t("TypeScript",oa("cc.TypeScript")(ag=class extends hg{})||ag);var ug,dg,pg,_g,gg,fg,mg;h._TypeScript=cg;let yg=t("EventHandler",oa("cc.ClickEvent")((dg=class t{constructor(){this.target=pg&&pg(),this.component=_g&&_g(),this._componentId=gg&&gg(),this.handler=fg&&fg(),this.customEventData=mg&&mg()}get _componentName(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)}set _componentName(t){this._componentId=this._compName2Id(t)}static emitEvents(e){for(var i=arguments.length,s=new Array(i>1?i-1:0),r=1;r<i;r++)s[r-1]=arguments[r];for(let i=0,r=e.length;i<r;i++){const r=e[i];r instanceof t&&r.emit(s)}}emit(t){const e=this.target;if(!l.isValid(e))return;this._genCompIdIfNeeded();const i=l.js.getClassById(this._componentId),s=e.getComponent(i);if(!l.isValid(s))return;const r=s[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),r.apply(s,t))}_compName2Id(t){const e=l.js.getClassByName(t);return l.js.getClassId(e)}_compId2Name(t){const e=l.js.getClassById(t);return l.js.getClassName(e)}_genCompIdIfNeeded(){this._componentId||(this._componentName=this.component,this.component="")}},pg=Qo(dg.prototype,"target",[va],(function(){return null})),_g=Qo(dg.prototype,"component",[va],(function(){return""})),gg=Qo(dg.prototype,"_componentId",[va],(function(){return""})),fg=Qo(dg.prototype,"handler",[va],(function(){return""})),mg=Qo(dg.prototype,"customEventData",[va],(function(){return""})),ug=dg))||ug);var vg,bg,wg,Sg,xg,Tg,Cg,Ig;const Eg=new tt("Comp"),Dg=yn.Flags.IsOnLoadCalled;let Ag=t("Component",(vg=oa("cc.Component"),bg=Ga(hg),vg((Ig=class extends yn{constructor(){super(),this.node=xg&&xg(),this._enabled=Tg&&Tg(),this.__prefab=Cg&&Cg(),this._sceneGetter=null,this._id=Eg.getNewId()}get name(){if(this._name)return this._name;let t=pt(this);const e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),this.node?`${this.node.name}<${t}>`:t}set name(t){this._name=t}get uuid(){return this._id}get __scriptAsset(){return null}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){const e=l.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}get enabledInHierarchy(){return this._enabled&&this.node&&this.node.activeInHierarchy}get _isOnLoadCalled(){return this._objFlags&Dg}_getRenderScene(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene}addComponent(t){return this.node.addComponent(t)}getComponent(t){return this.node.getComponent(t)}getComponents(t){return this.node.getComponents(t)}getComponentInChildren(t){return this.node.getComponentInChildren(t)}getComponentsInChildren(t){return this.node.getComponentsInChildren(t)}destroy(){return!!super.destroy()&&(this._enabled&&this.node.activeInHierarchy&&l.director._compScheduler.disableComp(this),!0)}_onPreDestroy(){this.unscheduleAllCallbacks(),l.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}_instantiate(t){return t||(t=l.instantiate._clone(this,this)),t&&(t.node=null),t}schedule(t,e,i,s){void 0===e&&(e=0),void 0===i&&(i=l.macro.REPEAT_FOREVER),void 0===s&&(s=0),q(Boolean(t),1619),q((e=e||0)>=0,1620),i=Number.isNaN(i)?l.macro.REPEAT_FOREVER:i,s=s||0;const r=l.director.getScheduler(),n=r.isTargetPaused(this);r.schedule(t,this,e,i,s,n)}scheduleOnce(t,e){void 0===e&&(e=0),this.schedule(t,0,0,e)}unschedule(t){t&&l.director.getScheduler().unschedule(t,this)}unscheduleAllCallbacks(){l.director.getScheduler().unscheduleAllForTarget(this)}get internalUpdate(){return this.update}get internalLateUpdate(){return this.lateUpdate}get internalPreload(){return this.__preload}get internalOnLoad(){return this.onLoad}get internalStart(){return this.start}get internalOnEnable(){return this.onEnable}get internalOnDisable(){return this.onDisable}get internalOnDestroy(){return this.onDestroy}},Ig.EventHandler=yg,Ig._executionOrder=0,Ig._requireComponent=null,Ig.system=null,s((Sg=Ig).prototype,"__scriptAsset",[bg],Object.getOwnPropertyDescriptor(Sg.prototype,"__scriptAsset"),Sg.prototype),xg=Qo(Sg.prototype,"node",[va],(function(){return null})),Tg=Qo(Sg.prototype,"_enabled",[va],(function(){return!0})),Cg=Qo(Sg.prototype,"__prefab",[va],(function(){return null})),wg=Sg))||wg));var Mg,Pg,Bg;ht(Ag,"_registerEditorProps",((t,e)=>{let i=e.requireComponent;i&&(Array.isArray(i)&&(i=i.filter(Boolean)),t._requireComponent=i);const s=e.executionOrder;s&&"number"==typeof s&&(t._executionOrder=s)})),l.Component=Ag;let Rg=t("MissingScript",oa("cc.MissingScript")((Pg=class extends Ag{static safeFindClass(t){const e=zt(t);if(e)return e;h.deserialize.reportMissingClass(t)}constructor(){super(),this._$erialized=Bg&&Bg()}onLoad(){G(4600,this.node.name)}},Bg=Qo(Pg.prototype,"_$erialized",[va,wa],(function(){return null})),Mg=Pg))||Mg);h._MissingScript=Rg;try{const t=Rg.__values__;0!==t.length&&"_$erialized"===t[t.length-1]||(j(16338),j(16339,t.join(", ")))}catch(zr){j(16340,`${zr}`)}class Og{constructor(t,e){this._document=t,this._chunks=e}get document(){return this._document}get chunks(){return this._chunks}}function Lg(t){const e=t;return{chunks:e.chunks,document:e.document}}function Fg(t){if(t.length<16)throw new kg(Y(13102));const e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new kg(Y(13100));const i=e.getUint32(4,!0);if(1!==i)throw new kg(Y(13101,i));if(e.getUint32(8,!0)!==e.byteLength)throw new kg(Y(13102));let s=12;const r=e.getUint32(s,!0);s+=4;const n=new Uint8Array(e.buffer,s+e.byteOffset,r);s+=r;const o=zg(n);let a;try{a=JSON.parse(o)}catch(t){throw new kg(t)}const h=[];for(;s<e.byteLength;){s%8!=0&&(s+=8-s%8);const t=e.getUint32(s,!0);s+=4,h.push(new Uint8Array(e.buffer,s+e.byteOffset,t)),s+=t}if(s!==e.byteLength)throw new kg(Y(13102));return new Og(a,h)}function zg(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis){const{Buffer:e}=globalThis;return e.from(t.buffer,t.byteOffset,t.byteLength).toString()}throw new Error(Y(13104))}class kg extends Error{}function Ng(t,e,i,s,r){if(e instanceof h.ValueType){r||t.push("if(prop){");const s=pt(e);t.push(`s._deserializeFastDefinedObject(o${i},prop,${s});`),r||t.push(`}else o${i}=null;`)}else t.push(`\nif (prop) {\n    s._deserializeAndAssignField(o, prop, ${s});\n} else {\n    o${i}=null;\n}\n`)}h.internal.parseCCONJson=Lg,h.internal.decodeCCONBinary=Fg,h.internal.CCON=Og;const Ug=function(t,e){const i=ri.Attr.getClassAttrs(e),s=e.__values__,r=["var prop;"],n=jg(e);for(let t=0;t<s.length;t++){const e=s[t];let o,a;ri.IDENTIFIER_RE.test(e)?(a=`"${e}"`,o=`.${e}`):(a=ri.escapeForJS(e),o=`[${a}]`);let h=o;if(i[e+Wg]){const t=i[e+Wg];h=ri.IDENTIFIER_RE.test(t)?`.${t}`:`[${ri.escapeForJS(t)}]`}r.push(`prop=d${h};`),r.push('if(typeof prop!=="undefined"){');const l=ri.getDefault(i[e+Gg]),c=i[e+Hg];n&&(void 0!==l||c)?$g(l,c)?r.push(`o${o}=prop;`):Ng(r,l,o,a,!0):(r.push(`if(typeof prop!=="object"){o${o}=prop;}else{`),Ng(r,l,o,a,!1),r.push("}")),r.push("}")}return(It(e,h.Node)||It(e,h.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===s[s.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))},Vg=ri.Attr.DELIMETER,Hg=`${Vg}type`,Gg=`${Vg}default`,Wg=`${Vg}formerlySerializedAs`;function jg(t){return ue.test(Ut(t))}function $g(t,e){if(void 0===t)return e instanceof ri.Attr.PrimitiveType||e===Xe||e===Ye;{const e=typeof t;return"string"===e||"number"===e||"boolean"===e}}class qg extends Vt{constructor(){super((t=>{t.clear()}),1)}}qg.prototype.get=function(t,e,i,s,r){const n=this._get();return n?(n.reset(t,e,i,s,r),n):new Xg(t,e,i,s,r)};class Xg{get ignoreEditorOnly(){return this._ignoreEditorOnly}constructor(t,e,i,s,r){this.deserializedList=[],this.deserializedData=null,this.result=t,this.customEnv=s,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced}reset(t,e,i,s,r){this.result=t,this.customEnv=s,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced}clear(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null}deserialize(t){let e,i=!1;t instanceof Og?(i=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:i};const s=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(s,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData}_deserializeObject(t,e,i,s){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,i,s):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}}_deserializeTypedArrayView(t){return globalThis[t.ctor].from(t.array)}_deserializeTypedArrayViewRef(t){const{offset:e,length:i,ctor:s}=t;return new globalThis[s](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,i)}_deserializeArray(t){const e=new Array(t.length);let i;for(let s=0;s<t.length;s++)i=t[s],"object"==typeof i&&i?this._deserializeAndAssignField(e,i,`${s}`)&&(e[s]=null):e[s]=i;return e}_deserializePlainObject(t){const e={};return this._fillPlainObject(e,t),e}_deserializeTypeTaggedObject(t,e,i,s){const r=t.__type__,n=this._classFinder(r,t,i,s);if(!n)return this._classFinder===zt&&this._reportMissingClass(r),null;const o=t=>{const i=new t;return e>=0&&(this.deserializedList[e]=i),i};{const e=o(n);return this._deserializeInto(t,e,n),e}}_deserializeInto(t,e,i,s){void 0===s&&(s=!1),s||!e[nh]?e._deserialize?e._deserialize(t.content,this):h.Class._isCCClass(i)?this._deserializeFireClass(e,t,i):this._deserializeFastDefinedObject(e,t,i):this._runCustomizedDeserialize(t,e,i)}_runCustomizedDeserialize(t,e,i){const s={readProperty:e=>{const i=t[e];return"object"==typeof i&&i?this._deserializeObjectField(i):i},readThis:()=>{this._deserializeInto(t,e,i,!0)},readSuper:()=>{const s=Ct(i);s&&this._deserializeInto(t,e,s)}};e[nh](s,this._context)}_deserializeFireClass(t,e,i){let s;if(i.hasOwnProperty("__deserialize__"))s=i.__deserialize__;else{s=Ug(0,i);try{if(i===Rg){const t=i.__values__;0!==t.length&&"_$erialized"===t[t.length-1]||(j(16341),j(16342,t.join(", ")));const e=s;s=function(t,i,s,r){e(t,i,s,r),i._$erialized||j(16343,JSON.stringify(s))}}}catch(t){j(16344,`${t}`)}ht(i,"__deserialize__",s,!0)}s(this,t,e,i)}_deserializeAndAssignField(t,e,i){const s=e.__id__;if("number"==typeof s){const e=this.deserializedList[s];if(e)t[i]=e;else{var r;const e=this._serializedData[s];t[i]=this._deserializeObject(e,s,void 0,i),null===(r=this._onDereferenced)||void 0===r||r.call(this,this.deserializedList,s,t,i)}}else{const s=e.__uuid__;if(s){const r=e.__expectedType__;this.result.push(t,i,s,r)}else t[i]=this._deserializeObject(e,-1)}return!1}_deserializeObjectField(t){const e=t.__id__;if("number"==typeof e){const t=this.deserializedList[e];if(t)return t;{const t=this._serializedData[e];return this._deserializeObject(t,e,void 0,void 0)}}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)}_fillPlainObject(t,e){for(const i in e){if(!e.hasOwnProperty(i))continue;const s=e[i];"object"!=typeof s?"__type__"!==i&&(t[i]=s):s?this._deserializeAndAssignField(t,s,i)&&(t[i]=null):t[i]=null}}_deserializeFastDefinedObject(t,e,i){if(i===h.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(i===h.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(i===h.Color){t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;const i=e.a;return void(t.a=void 0===i?255:i)}if(i===h.Size)return t.width=e.width||0,void(t.height=e.height||0);const s=ri.Attr.getClassAttrs(i),r=i.__values__;for(let i=0;i<r.length;i++){const n=r[i];let o=e[n];void 0!==o||e.hasOwnProperty(n)||(o=ri.getDefault(s[n+Gg])),"object"!=typeof o?t[n]=o:o?this._deserializeAndAssignField(t,o,n):t[n]=null}}}function Yg(t,e,i){var s;const r=(i=i||{}).classFinder||zt,n=i.createAssetRefs||Hn.platform===Ln.EDITOR_CORE,o=i.customEnv,a=i.ignoreEditorOnly,l=null!==(s=i.reportMissingClass)&&void 0!==s?s:h.deserialize.reportMissingClass;e.init();const c=Xg.pool.get(e,r,l,o,a);h.game._isCloning=!0;const u=c.deserialize(t);return h.game._isCloning=!1,Xg.pool.put(c),n&&e.assignAssetsBy(((t,e)=>EditorExtends.serialize.asAsset(t,e.type))),u}Xg.pool=new qg;const Qg=[Qs,Ki,cr,ys,_r,br,Cr,Rs];function Kg(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}const Zg=[(t,e)=>{t.x=e[1],t.y=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.z=e[3]},Kg,Kg,(t,e)=>{_r.fromUint32(t,e[1])},(t,e)=>{t.width=e[1],t.height=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},(t,e)=>{Rs.fromArray(t,e,1)}],Jg=1,tf=0,ef=0,sf=1,rf=2,nf=0,of=0;class af{constructor(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}init(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])}reset(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)}push(t,e,i,s){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(i),this.uuidTypeList.push(s||"")}}function hf(t,e,i){const s=t.length-1;let r=0;const n=3*t[s];for(;r<n;r+=3){const s=t[r],n=e[t[r+2]],o=t[r+1];o>=0?s[i[o]]=n:s[~o]=n}for(;r<s;r+=3){const s=e[t[r]],n=e[t[r+2]],o=t[r+1];o>=0?s[i[o]]=n:s[~o]=n}}function lf(t,e){const i=t[4][e[of]],s=i[nf],r=new(0,s[ef]),n=s[sf],o=s[rf],a=i[i.length-1];let h=nf+1;for(;h<a;++h)r[n[i[h]]]=e[h];for(;h<e.length;++h){const a=n[i[h]],l=s[i[h]+o];(0,gf[l])(t,r,a,e[h])}return r}function cf(t,e,i){const s=new e;return s._deserialize?s._deserialize(i,t[0]):j(5303,pt(e)),s}function uf(t,e,i,s){s>=0?e[i]=t[5][s]:t[7][3*~s]=e}function df(t){return(e,i,s,r)=>{for(let i=0;i<r.length;++i)t(e,r,i,r[i]);i[s]=r}}function pf(t,e,i,s){e[i]=null,t[8][s]=e}function _f(t,e,i,s){e[i]=lf(t,s)}t("Details",af),af.pool=new Vt((t=>{t.reset()}),5),af.pool.get=function(){return this._get()||new af};const gf=new Array(13);function ff(t){const e=t[5],i=t[6],s=i===tf?0:i.length;let r=e[e.length-1],n=e.length-s;"number"!=typeof r?r=0:(r<0&&(r=~r),--n);let o=0;for(;o<n;++o)e[o]=lf(t,e[o]);const a=t[3];for(let r=0;r<s;++r,++o){let s=i[r];const n=e[o];if(s>=0){const i=a[s];e[o]=cf(t,i,n)}else s=~s,(0,gf[s])(t,e,o,n)}return r}function mf(t,e,i){return t||i(e),Object}function yf(t,e,i,s,r,n,o){let a=t(e);if(!a){if(r)return void(i[s]=(h=i,l=s,c=e,function(){const e=t(c)||mf(n,c,o);return h[l]=e,new e}));a=mf(n,e,o)}var h,l,c;i[s]=a}function vf(t,e,i,s){const r=i||zt,n=t[3];for(let t=0;t<n.length;++t){const o=n[t];"string"!=typeof o?yf(r,o[ef],o,ef,e,i,s):yf(r,o,n,t,e,i,s)}}function bf(t){const e=t[4];if(e){const i=t[3];for(let t=0;t<e.length;++t){const s=e[t];s[nf]=i[s[nf]]}}}function wf(t){const e=t[5],i=t[2],s=t[1],r=t[8],n=t[9],o=t[10];for(let t=0;t<r.length;++t){const a=r[t];"number"==typeof a&&(r[t]=e[a]);let h=n[t];"number"==typeof h&&(h=h>=0?i[h]:~h,n[t]=h);const l=o[t];"number"==typeof l&&(o[t]=s[l])}}function Sf(t){if(Array.isArray(t)){const e=t[0];return"number"==typeof e||e instanceof Cf}return!1}function xf(t,e,i){var s;e.init(t),null!==(s=i)&&void 0!==s||(i={});let r=t[0],n=!1;if("object"==typeof r&&(n=r.preprocessed,r=r.version),r<Jg)throw new Error(Y(5304,r));const o=i;var a;o._version=r,o.result=e,t[0]=o,n||(vf(t,!1,i.classFinder,null!==(a=i.reportMissingClass)&&void 0!==a?a:Tf.reportMissingClass),bf(t))}function Tf(t,e,i){"string"==typeof t&&(t=JSON.parse(t));let s,r=!1;if(e||(e=af.pool.get(),r=!0),Sf(t)){xf(t,e,i);const r=t;h.game._isCloning=!0;const n=r[5],o=ff(r);h.game._isCloning=!1,r[7]&&hf(r[7],n,r[2]),wf(r),s=n[o]}else s=Yg(t,e,i);return r&&af.pool.put(e),s}gf[0]=function(t,e,i,s){e[i]=s},gf[1]=uf,gf[2]=df(uf),gf[3]=df(pf),gf[4]=_f,gf[5]=function(t,e,i,s){const r=s[0];{const t=e[i];(0,Zg[r])(t,s)}},gf[6]=pf,gf[7]=function(t,e,i,s){e[i].set(s)},gf[8]=function(t,e,i,s){const r=s[0],n=new Qg[r];(0,Zg[r])(n,s),e[i]=n},gf[9]=df(_f),gf[10]=function(t,e,i,s){const r=t[3][s[0]];e[i]=cf(t,r,s[1])},gf[11]=function(t,e,i,s){const r=s[0];e[i]=r;for(let e=1;e<s.length;e+=3){const i=s[e],n=s[e+1],o=s[e+2];(0,gf[n])(t,r,i,o)}},gf[12]=function(t,e,i,s){const r=s[0];for(let e=0;e<r.length;++e){const i=r[e],n=s[e+1];0!==n&&(0,gf[n])(t,r,e,i)}e[i]=r},Tf.Details=af,Tf.reportMissingClass=function(t){j(5302,t)};class Cf{constructor(t){this.preprocessed=!0,this.version=t}}function If(t,e){if(t[0]<Jg)throw new Error(Y(5304,t[0]));vf(t,!0,e,Tf.reportMissingClass),bf(t);const i=new Cf(t[0]),s=t[1],r=t[2],n=t[3],o=t[4],a=t[5];for(let t=0;t<a.length;++t)a[t].unshift(i,s,r,n,o);return a}function Ef(t,e,i){return[Jg,tf,tf,[t],tf,i?[e,-1]:[e],[0],tf,[],[],[]]}function Df(t){const e=t[5],i=e[e.length-1];return"number"==typeof i&&i<0}function Af(t){const e=t[1];return t[10].map((t=>e[t]))}h.deserialize=Tf;const Mf=new WeakMap,Pf=new WeakSet,Bf=new WeakSet;function Rf(t,e){let i;i=Rg.safeFindClass;const s=af.pool.get();let r;try{r=Tf(t,s,{classFinder:i,customEnv:e})}catch(t){throw B(t),af.pool.put(s),t}r._uuid=e.__uuid__||"";const n=s.uuidList,o=s.uuidObjList,a=s.uuidPropList,h=s.uuidTypeList||[],l=[];for(let t=0;t<n.length;t++){const e=n[t];l[t]={uuid:x_(e),owner:o[t],prop:a[t],type:zt(h[t])}}return Mf.set(r,l),r._native&&Pf.add(r),af.pool.put(s),r}class Of{static get instance(){return this._instance||(this._instance=new Of),this._instance}constructor(){this._depends=new a_}init(){this._depends.clear()}getNativeDep(t){const e=this._depends.get(t);return e&&e.nativeDep?{...e.nativeDep}:null}getDeps(t){return this._depends.has(t)?this._depends.get(t).deps:[]}getDepsRecursively(t){const e=Object.create(null),i=[];return this._descend(t,e,i),i}remove(t){this._depends.remove(t)}parse(t,e){let i=null;if(Array.isArray(e)||e.__type__||e instanceof Og){if(this._depends.has(t))return this._depends.get(t);if(Array.isArray(e)&&!Df(e))i={deps:this._parseDepsFromJson(e)};else try{const s=Rf(e,{__uuid__:t});i=this._parseDepsFromAsset(s),i.nativeDep&&(i.nativeDep.uuid=t),u_.add(`${t}@import`,s)}catch(e){c_.remove(`${t}@import`),i={deps:[]}}}else{if(this._depends.has(t)&&(i=this._depends.get(t),i.parsedFromExistAsset))return i;i=this._parseDepsFromAsset(e)}return this._depends.add(t,i),i}_parseDepsFromAsset(t){const e={deps:[],parsedFromExistAsset:!0},i=Mf.get(t);for(let t=0,s=i.length;t<s;t++)e.deps.push(i[t].uuid);return Pf.has(t)&&(e.nativeDep=t._nativeDep),e}_parseDepsFromJson(t){const e=Af(t);return e.forEach(((t,i)=>e[i]=x_(t))),e}_descend(t,e,i){const s=this.getDeps(t);for(let t=0;t<s.length;t++){const r=s[t];e[r]||(e[r]=!0,i.push(r),this._descend(r,e,i))}}}Of._instance=void 0;var Lf,Ff=Of.instance;const zf=[new bd];function kf(t,e){let i=Math.max(t,e),s=0;for(;i;)i>>=1,s++;return s}function Nf(t){return t&&!(t&t-1)}function Uf(t,e,i){return!(6===t.gfxAPI)||Nf(e)&&Nf(i)}let Vf=oa("cc.SimpleTexture")(Lf=class extends rg{constructor(){super(),this._gfxTexture=null,this._gfxTextureView=null,this._mipmapLevel=1,this._textureWidth=0,this._textureHeight=0,this._baseLevel=0,this._maxLevel=1e3}get mipmapLevel(){return this._mipmapLevel}getGFXTexture(){return this._gfxTextureView}destroy(){return this._tryDestroyTextureView(),this._tryDestroyTexture(),super.destroy()}updateImage(){this.updateMipmaps(0)}updateMipmaps(t,e){}uploadData(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=0),!this._gfxTexture||this._mipmapLevel<=e)return;const s=this._getGFXDevice();if(!s)return;const r=zf[0];r.texExtent.width=this._textureWidth>>e,r.texExtent.height=this._textureHeight>>e,r.texSubres.mipLevel=e,r.texSubres.baseArrayLayer=i,ArrayBuffer.isView(t)?s.copyBuffersToTexture([t],this._gfxTexture,zf):s.copyTexImagesToTexture([t],this._gfxTexture,zf)}_assignImage(t,e,i){const s=t.data;if(s&&(this.uploadData(s,e,i),this._checkTextureLoaded(),le.CLEANUP_IMAGE_CACHE)){const e=Ff.getDeps(this._uuid),i=e.indexOf(t._uuid);-1!==i&&(Wt(e,i),t.decRef())}}_checkTextureLoaded(){this._textureReady()}_textureReady(){this.loaded=!0,this.emit("load")}_setMipmapLevel(t){this._mipmapLevel=t<1?1:t}_setMipRange(t,e){this._baseLevel=t<1?0:t,this._maxLevel=e<1?0:e}setMipRange(t,e){q(t<=e,3124),this._setMipRange(t,e);const i=this._getGFXDevice();if(!i)return;const s=this._createTextureView(i);this._tryDestroyTextureView(),this._gfxTextureView=s}_getGfxTextureCreateInfo(t){return null}_getGfxTextureViewCreateInfo(t){return null}_tryReset(){if(this._tryDestroyTextureView(),this._tryDestroyTexture(),0===this._mipmapLevel)return;const t=this._getGFXDevice();t&&(this._createTexture(t),this._gfxTextureView=this._createTextureView(t))}isUsingOfflineMipmaps(){return!1}_createTexture(t){if(0===this._width||0===this._height)return;let e=0;0!==this._mipFilter&&Uf(t,this._width,this._height)&&(this._mipmapLevel=kf(this._width,this._height),this.isUsingOfflineMipmaps()||this.isCompressed||(e=1));const i=this._getGfxTextureCreateInfo({usage:22,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e});if(!i)return;const s=t.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=s}_createTextureView(t){if(!this._gfxTexture)return null;const e=this._maxLevel<this._mipmapLevel?this._maxLevel:this._mipmapLevel-1,i=this._getGfxTextureViewCreateInfo({texture:this._gfxTexture,format:this._getGFXFormat(),baseLevel:this._baseLevel,levelCount:e-this._baseLevel+1});return i?t.createTexture(i):null}_tryDestroyTexture(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}_tryDestroyTextureView(){this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}})||Lf;var Hf,Gf,Wf,jf,$f;h.SimpleTexture=Vf;let qf=t("Texture2D",(Hf=oa("cc.Texture2D"),Gf=Ga([j_]),Hf((jf=class extends Vf{constructor(){super(),this._mipmaps=$f&&$f(),this._generatedMipmaps=[]}get mipmaps(){return this._mipmaps}set mipmaps(t){this._mipmaps=t;const e=[];if(1===t.length){const i=t[0];e.push(...i.extractMipmaps())}else if(t.length>1)for(let i=0;i<t.length;++i){const s=t[i];e.push(s.extractMipmap0())}this._setMipmapParams(e)}_setMipmapParams(t){if(this._generatedMipmaps=t,this._setMipmapLevel(this._generatedMipmaps.length),this._generatedMipmaps.length>0){const t=this._generatedMipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._generatedMipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._generatedMipmaps.forEach(((t,e)=>{this._assignImage(t,e)}))}else this.reset({width:0,height:0,mipmapLevel:this._generatedMipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}initialize(){this.mipmaps=this._mipmaps}onLoaded(){this.initialize()}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format);const e=void 0===t.mipmapLevel?1:t.mipmapLevel;this._setMipmapLevel(e);const i=void 0===t.baseLevel?0:t.baseLevel,s=void 0===t.maxLevel?1e3:t.maxLevel;this._setMipRange(i,s),this._tryReset()}create(t,e,i,s,r,n){void 0===i&&(i=35),void 0===s&&(s=1),void 0===r&&(r=0),void 0===n&&(n=1e3),this.reset({width:t,height:e,format:i,mipmapLevel:s,baseLevel:r,maxLevel:n})}toString(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}updateMipmaps(t,e){if(void 0===t&&(t=0),void 0===e&&(e=void 0),t>=this._generatedMipmaps.length)return;const i=Math.min(void 0===e?this._generatedMipmaps.length:e,this._generatedMipmaps.length-t);for(let e=0;e<i;++e){const i=t+e;this._assignImage(this._generatedMipmaps[i],i)}}getHtmlElementObj(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}destroy(){return this._mipmaps=[],this._generatedMipmaps=[],super.destroy()}description(){return`<cc.Texture2D | Name = ${this._mipmaps[0]?this._mipmaps[0].url:""} | Dimension = ${this.width} x ${this.height}>`}releaseTexture(){this.destroy()}_serialize(t){return null}_deserialize(t,e){const i=t;super._deserialize(i.base,e),this._mipmaps=new Array(i.mipmaps.length);for(let t=0;t<i.mipmaps.length;++t){if(this._mipmaps[t]=new j_,!i.mipmaps[t])continue;const s=i.mipmaps[t];e.result.push(this._mipmaps,`${t}`,s,Ut(j_))}}_getGfxTextureCreateInfo(t){const e=new Bd(1);return e.width=this._width,e.height=this._height,Object.assign(e,t),e}_getGfxTextureViewCreateInfo(t){const e=new Rd;return e.type=1,Object.assign(e,t),e}initDefault(t){super.initDefault(t);const e=new j_;e.initDefault(),this.image=e}validate(){return this.mipmaps&&0!==this.mipmaps.length}},$f=Qo(jf.prototype,"_mipmaps",[Gf],(function(){return[]})),Wf=jf))||Wf));h.Texture2D=qf;class Xf{constructor(t,e){this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0;const i=new Yf;i.initWithSize(t,e),this._texture=i,this._width=t,this._height=e,this._x=2,this._y=2,this._nextY=2}insertSpriteFrame(t){const e=t.rect,i=t.texture,s=this._innerTextureInfos[i.getId()];let r=e.x,n=e.y;if(s)r+=s.x,n+=s.y;else{const t=i.width,e=i.height;if(this._x+t+2>this._width&&(this._x=2,this._y=this._nextY),this._y+e+2>this._nextY&&(this._nextY=this._y+e+2),this._nextY>this._height)return null;h.internal.dynamicAtlasManager.textureBleeding&&((t<=8||e<=8)&&(this._texture.drawTextureAt(i.image,this._x-1,this._y-1),this._texture.drawTextureAt(i.image,this._x-1,this._y+1),this._texture.drawTextureAt(i.image,this._x+1,this._y-1),this._texture.drawTextureAt(i.image,this._x+1,this._y+1)),this._texture.drawTextureAt(i.image,this._x-1,this._y),this._texture.drawTextureAt(i.image,this._x+1,this._y),this._texture.drawTextureAt(i.image,this._x,this._y-1),this._texture.drawTextureAt(i.image,this._x,this._y+1)),this._texture.drawTextureAt(i.image,this._x,this._y),this._innerTextureInfos[i.getId()]={x:this._x,y:this._y,texture:i},this._count++,r+=this._x,n+=this._y,this._x+=t+2}const o={x:r,y:n,texture:this._texture};return this._innerSpriteFrames.push(t),o}removeSpriteFrame(t){$t(this._innerSpriteFrames,t)}deleteInnerTexture(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)}isEmpty(){return this._count<=0}reset(){this._x=2,this._y=2,this._nextY=2;const t=this._innerSpriteFrames;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}}destroy(){this.reset(),this._texture.destroy()}}t("Atlas",Xf);class Yf extends qf{initWithSize(t,e,i){void 0===i&&(i=35),this.reset({width:t,height:e,format:i})}drawTextureAt(t,e,i){const s=this.getGFXTexture();if(!t||!s)return;const r=this._getGFXDevice();if(!r)return void G(16363);const n=new bd;n.texOffset.x=e,n.texOffset.y=i,n.texExtent.width=t.width,n.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],s,[n])}}const Qf={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295};class Kf{static init(){const t=ae.querySettings("engine","customLayers");if(t)for(let e=0;e<t.length;e++){const i=t[e];Kf.addLayer(i.name,i.bit)}}static makeMaskInclude(t){let e=0;for(const i of t)e|=i;return e}static makeMaskExclude(t){return~Kf.makeMaskInclude(t)}static addLayer(t,e){if(void 0===e)return void G(16364);if(e>19||e<0)return void G(16365);const i=1<<e;Kf.Enum[t],Y(2104,t),Kf.Enum[t]=i,ht(Kf.Enum,String(i),t),Kf.BitMask[t]=i,ht(Kf.BitMask,String(i),t),Kt.update(Kf.BitMask),te.update(Kf.Enum)}static deleteLayer(t){if(t>19||t<0)return void G(16366);const e=1<<t;delete Kf.Enum[Kf.Enum[e]],delete Kf.Enum[e],delete Kf.BitMask[Kf.BitMask[e]],delete Kf.BitMask[e],Kt.update(Kf.BitMask),te.update(Kf.Enum)}static nameToLayer(t){return void 0===t?(G(16367),-1):g(Kf.Enum[t])}static layerToName(t){return t>31||t<0?(G(16368),""):Kf.Enum[1<<t]}}var Zf,Jf,tm,em,im,sm,rm,nm,om,am,hm,lm,cm,um;t("Layers",Kf),Kf.Enum=te(Qf),Kf.BitMask=Kt({...Qf}),l.Layers=Kf;const dm={DEFAULT:100,UI:200};h.RenderPassStage=dm;const pm={bindings:[],layouts:{}},_m={bindings:[],layouts:{}},gm=new Td([4,0,7,0],[4,0,7,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,5,0],[0,0,0,0],[0,2,1,3]);class fm{}Zf=fm,fm.TIME_OFFSET=0,fm.SCREEN_SIZE_OFFSET=4,fm.NATIVE_SIZE_OFFSET=8,fm.PROBE_INFO_OFFSET=12,fm.DEBUG_VIEW_MODE_OFFSET=16,fm.COUNT=20,fm.SIZE=80,fm.NAME="CCGlobal",fm.BINDING=0,fm.DESCRIPTOR=new sp(Zf.BINDING,1,1,63),fm.LAYOUT=new Fd(0,Zf.BINDING,Zf.NAME,[new Ld("cc_time",16,1),new Ld("cc_screenSize",16,1),new Ld("cc_nativeSize",16,1),new Ld("cc_probeInfo",16,1),new Ld("cc_debug_view_mode",16,1)],1),pm.layouts[fm.NAME]=fm.LAYOUT,pm.bindings[fm.BINDING]=fm.DESCRIPTOR;class mm{}Jf=mm,mm.MAT_VIEW_OFFSET=0,mm.MAT_VIEW_INV_OFFSET=16,mm.MAT_PROJ_OFFSET=32,mm.MAT_PROJ_INV_OFFSET=48,mm.MAT_VIEW_PROJ_OFFSET=64,mm.MAT_VIEW_PROJ_INV_OFFSET=80,mm.CAMERA_POS_OFFSET=96,mm.SURFACE_TRANSFORM_OFFSET=100,mm.SCREEN_SCALE_OFFSET=104,mm.EXPOSURE_OFFSET=108,mm.MAIN_LIT_DIR_OFFSET=112,mm.MAIN_LIT_COLOR_OFFSET=116,mm.AMBIENT_SKY_OFFSET=120,mm.AMBIENT_GROUND_OFFSET=124,mm.GLOBAL_FOG_COLOR_OFFSET=128,mm.GLOBAL_FOG_BASE_OFFSET=132,mm.GLOBAL_FOG_ADD_OFFSET=136,mm.NEAR_FAR_OFFSET=140,mm.VIEW_PORT_OFFSET=144,mm.COUNT=148,mm.SIZE=592,mm.NAME="CCCamera",mm.BINDING=1,mm.DESCRIPTOR=new sp(Jf.BINDING,1,1,63),mm.LAYOUT=new Fd(0,Jf.BINDING,Jf.NAME,[new Ld("cc_matView",25,1),new Ld("cc_matViewInv",25,1),new Ld("cc_matProj",25,1),new Ld("cc_matProjInv",25,1),new Ld("cc_matViewProj",25,1),new Ld("cc_matViewProjInv",25,1),new Ld("cc_cameraPos",16,1),new Ld("cc_surfaceTransform",16,1),new Ld("cc_screenScale",16,1),new Ld("cc_exposure",16,1),new Ld("cc_mainLitDir",16,1),new Ld("cc_mainLitColor",16,1),new Ld("cc_ambientSky",16,1),new Ld("cc_ambientGround",16,1),new Ld("cc_fogColor",16,1),new Ld("cc_fogBase",16,1),new Ld("cc_fogAdd",16,1),new Ld("cc_nearFar",16,1),new Ld("cc_viewPort",16,1)],1),pm.layouts[mm.NAME]=mm.LAYOUT,pm.bindings[mm.BINDING]=mm.DESCRIPTOR;class ym{}tm=ym,ym.MAT_LIGHT_VIEW_OFFSET=0,ym.MAT_LIGHT_VIEW_PROJ_OFFSET=16,ym.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=32,ym.SHADOW_PROJ_DEPTH_INFO_OFFSET=36,ym.SHADOW_PROJ_INFO_OFFSET=40,ym.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=44,ym.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=48,ym.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=52,ym.SHADOW_COLOR_OFFSET=56,ym.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=60,ym.COUNT=64,ym.SIZE=256,ym.NAME="CCShadow",ym.BINDING=2,ym.DESCRIPTOR=new sp(tm.BINDING,1,1,63),ym.LAYOUT=new Fd(0,tm.BINDING,tm.NAME,[new Ld("cc_matLightView",25,1),new Ld("cc_matLightViewProj",25,1),new Ld("cc_shadowInvProjDepthInfo",16,1),new Ld("cc_shadowProjDepthInfo",16,1),new Ld("cc_shadowProjInfo",16,1),new Ld("cc_shadowNFLSInfo",16,1),new Ld("cc_shadowWHPBInfo",16,1),new Ld("cc_shadowLPNNInfo",16,1),new Ld("cc_shadowColor",16,1),new Ld("cc_planarNDInfo",16,1)],1),pm.layouts[ym.NAME]=ym.LAYOUT,pm.bindings[ym.BINDING]=ym.DESCRIPTOR;class vm{}em=vm,vm.CSM_LEVEL_COUNT=4,vm.CSM_VIEW_DIR_0_OFFSET=0,vm.CSM_VIEW_DIR_1_OFFSET=16,vm.CSM_VIEW_DIR_2_OFFSET=32,vm.CSM_ATLAS_OFFSET=48,vm.MAT_CSM_VIEW_PROJ_OFFSET=64,vm.CSM_PROJ_DEPTH_INFO_OFFSET=128,vm.CSM_PROJ_INFO_OFFSET=144,vm.CSM_SPLITS_INFO_OFFSET=160,vm.COUNT=164,vm.SIZE=656,vm.NAME="CCCSM",vm.BINDING=3,vm.DESCRIPTOR=new sp(em.BINDING,1,1,16),vm.LAYOUT=new Fd(0,em.BINDING,em.NAME,[new Ld("cc_csmViewDir0",16,em.CSM_LEVEL_COUNT),new Ld("cc_csmViewDir1",16,em.CSM_LEVEL_COUNT),new Ld("cc_csmViewDir2",16,em.CSM_LEVEL_COUNT),new Ld("cc_csmAtlas",16,em.CSM_LEVEL_COUNT),new Ld("cc_matCSMViewProj",25,em.CSM_LEVEL_COUNT),new Ld("cc_csmProjDepthInfo",16,em.CSM_LEVEL_COUNT),new Ld("cc_csmProjInfo",16,em.CSM_LEVEL_COUNT),new Ld("cc_csmSplitsInfo",16,1)],1),pm.layouts[vm.NAME]=vm.LAYOUT,pm.bindings[vm.BINDING]=vm.DESCRIPTOR;const bm="cc_shadowMap",wm=new sp(4,16,1,16),Sm=new zd(0,4,bm,28,1);pm.layouts[bm]=Sm,pm.bindings[4]=wm;const xm="cc_environment",Tm=new sp(5,16,1,16),Cm=new zd(0,5,xm,31,1);pm.layouts[xm]=Cm,pm.bindings[5]=Tm;const Im="cc_diffuseMap",Em=new sp(7,16,1,16),Dm=new zd(0,7,Im,31,1);pm.layouts[Im]=Dm,pm.bindings[7]=Em;const Am="cc_spotShadowMap",Mm=new sp(6,16,1,16),Pm=new zd(0,6,Am,28,1);pm.layouts[Am]=Pm,pm.bindings[6]=Mm;class Bm{}im=Bm,Bm.MAT_WORLD_OFFSET=0,Bm.MAT_WORLD_IT_OFFSET=16,Bm.LIGHTINGMAP_UVPARAM=32,Bm.LOCAL_SHADOW_BIAS=36,Bm.REFLECTION_PROBE_DATA1=40,Bm.REFLECTION_PROBE_DATA2=44,Bm.REFLECTION_PROBE_BLEND_DATA1=48,Bm.REFLECTION_PROBE_BLEND_DATA2=52,Bm.COUNT=56,Bm.SIZE=224,Bm.NAME="CCLocal",Bm.BINDING=0,Bm.DESCRIPTOR=new sp(im.BINDING,1,1,49),Bm.LAYOUT=new Fd(2,im.BINDING,im.NAME,[new Ld("cc_matWorld",25,1),new Ld("cc_matWorldIT",25,1),new Ld("cc_lightingMapUVParam",16,1),new Ld("cc_localShadowBias",16,1),new Ld("cc_reflectionProbeData1",16,1),new Ld("cc_reflectionProbeData2",16,1),new Ld("cc_reflectionProbeBlendData1",16,1),new Ld("cc_reflectionProbeBlendData2",16,1)],1),_m.layouts[Bm.NAME]=Bm.LAYOUT,_m.bindings[Bm.BINDING]=Bm.DESCRIPTOR;class Rm{}sm=Rm,Rm.WORLD_BOUND_CENTER=0,Rm.WORLD_BOUND_HALF_EXTENTS=sm.WORLD_BOUND_CENTER+4,Rm.COUNT=sm.WORLD_BOUND_HALF_EXTENTS+4,Rm.SIZE=4*sm.COUNT,Rm.NAME="CCWorldBound",Rm.BINDING=0,Rm.DESCRIPTOR=new sp(sm.BINDING,1,1,33),Rm.LAYOUT=new Fd(2,sm.BINDING,sm.NAME,[new Ld("cc_worldBoundCenter",16,1),new Ld("cc_worldBoundHalfExtents",16,1)],1),_m.layouts[Rm.NAME]=Rm.LAYOUT,_m.bindings[Rm.BINDING]=Rm.DESCRIPTOR;const Om="a_matWorld0",Lm="a_sh_linear_const_r";class Fm{}rm=Fm,Fm.BATCHING_COUNT=10,Fm.MAT_WORLDS_OFFSET=0,Fm.COUNT=16*rm.BATCHING_COUNT,Fm.SIZE=4*rm.COUNT,Fm.NAME="CCLocalBatched",Fm.BINDING=0,Fm.DESCRIPTOR=new sp(rm.BINDING,1,1,33),Fm.LAYOUT=new Fd(2,rm.BINDING,rm.NAME,[new Ld("cc_matWorlds",25,rm.BATCHING_COUNT)],1),_m.layouts[Fm.NAME]=Fm.LAYOUT,_m.bindings[Fm.BINDING]=Fm.DESCRIPTOR;class zm{}nm=zm,zm.LIGHTS_PER_PASS=1,zm.LIGHT_POS_OFFSET=0,zm.LIGHT_COLOR_OFFSET=4,zm.LIGHT_SIZE_RANGE_ANGLE_OFFSET=8,zm.LIGHT_DIR_OFFSET=12,zm.LIGHT_BOUNDING_SIZE_VS_OFFSET=16,zm.COUNT=20,zm.SIZE=80,zm.NAME="CCForwardLight",zm.BINDING=1,zm.DESCRIPTOR=new sp(nm.BINDING,2,1,16),zm.LAYOUT=new Fd(2,nm.BINDING,nm.NAME,[new Ld("cc_lightPos",16,1),new Ld("cc_lightColor",16,1),new Ld("cc_lightSizeRangeAngle",16,1),new Ld("cc_lightDir",16,1),new Ld("cc_lightBoundingSizeVS",16,1)],1),_m.layouts[zm.NAME]=zm.LAYOUT,_m.bindings[zm.BINDING]=zm.DESCRIPTOR;class km{}km.LIGHTS_PER_PASS=10;class Nm{}om=Nm,Nm.JOINTS_TEXTURE_INFO_OFFSET=0,Nm.COUNT=om.JOINTS_TEXTURE_INFO_OFFSET+4,Nm.SIZE=4*om.COUNT,Nm.NAME="CCSkinningTexture",Nm.BINDING=3,Nm.DESCRIPTOR=new sp(om.BINDING,1,1,1),Nm.LAYOUT=new Fd(2,om.BINDING,om.NAME,[new Ld("cc_jointTextureInfo",16,1)],1),_m.layouts[Nm.NAME]=Nm.LAYOUT,_m.bindings[Nm.BINDING]=Nm.DESCRIPTOR;class Um{}am=Um,Um.JOINTS_ANIM_INFO_OFFSET=0,Um.COUNT=am.JOINTS_ANIM_INFO_OFFSET+4,Um.SIZE=4*am.COUNT,Um.NAME="CCSkinningAnimation",Um.BINDING=2,Um.DESCRIPTOR=new sp(am.BINDING,1,1,1),Um.LAYOUT=new Fd(2,am.BINDING,am.NAME,[new Ld("cc_jointAnimInfo",16,1)],1),_m.layouts[Um.NAME]=Um.LAYOUT,_m.bindings[Um.BINDING]=Um.DESCRIPTOR;const Vm="a_jointAnimInfo";class Hm{static get JOINT_UNIFORM_CAPACITY(){return Hm._jointUniformCapacity}static get COUNT(){return Hm._count}static get SIZE(){return Hm._size}static initLayout(t){Hm._jointUniformCapacity=t,Hm._count=12*t,Hm._size=4*Hm._count,Hm.LAYOUT.members[0].count=3*t}}function Gm(t){Hm.initLayout(t),_m.layouts[Hm.NAME]=Hm.LAYOUT,_m.bindings[Hm.BINDING]=Hm.DESCRIPTOR}hm=Hm,Hm._jointUniformCapacity=0,Hm._count=0,Hm._size=0,Hm.NAME="CCSkinning",Hm.BINDING=3,Hm.DESCRIPTOR=new sp(hm.BINDING,1,1,1),Hm.LAYOUT=new Fd(2,hm.BINDING,hm.NAME,[new Ld("cc_joints",16,1)],1);class Wm{}lm=Wm,Wm.MAX_MORPH_TARGET_COUNT=60,Wm.OFFSET_OF_WEIGHTS=0,Wm.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=240,Wm.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=244,Wm.OFFSET_OF_VERTICES_COUNT=248,Wm.COUNT_BASE_4_BYTES=64,Wm.SIZE=256,Wm.NAME="CCMorph",Wm.BINDING=4,Wm.DESCRIPTOR=new sp(lm.BINDING,1,1,1),Wm.LAYOUT=new Fd(2,lm.BINDING,lm.NAME,[new Ld("cc_displacementWeights",16,15),new Ld("cc_displacementTextureInfo",16,1)],1),_m.layouts[Wm.NAME]=Wm.LAYOUT,_m.bindings[Wm.BINDING]=Wm.DESCRIPTOR;class jm{}cm=jm,jm.NAME="CCUILocal",jm.BINDING=5,jm.DESCRIPTOR=new sp(cm.BINDING,2,1,1),jm.LAYOUT=new Fd(2,cm.BINDING,cm.NAME,[new Ld("cc_local_data",16,1)],1),_m.layouts[jm.NAME]=jm.LAYOUT,_m.bindings[jm.BINDING]=jm.DESCRIPTOR;class $m{}um=$m,$m.SH_LINEAR_CONST_R_OFFSET=0,$m.SH_LINEAR_CONST_G_OFFSET=4,$m.SH_LINEAR_CONST_B_OFFSET=8,$m.SH_QUADRATIC_R_OFFSET=12,$m.SH_QUADRATIC_G_OFFSET=16,$m.SH_QUADRATIC_B_OFFSET=20,$m.SH_QUADRATIC_A_OFFSET=24,$m.COUNT=28,$m.SIZE=112,$m.NAME="CCSH",$m.BINDING=6,$m.DESCRIPTOR=new sp(um.BINDING,1,1,16),$m.LAYOUT=new Fd(2,um.BINDING,um.NAME,[new Ld("cc_sh_linear_const_r",16,1),new Ld("cc_sh_linear_const_g",16,1),new Ld("cc_sh_linear_const_b",16,1),new Ld("cc_sh_quadratic_r",16,1),new Ld("cc_sh_quadratic_g",16,1),new Ld("cc_sh_quadratic_b",16,1),new Ld("cc_sh_quadratic_a",16,1)],1),_m.layouts[$m.NAME]=$m.LAYOUT,_m.bindings[$m.BINDING]=$m.DESCRIPTOR;const qm="cc_jointTexture",Xm=new sp(7,16,1,1),Ym=new zd(2,7,qm,28,1);_m.layouts[qm]=Ym,_m.bindings[7]=Xm;const Qm="cc_realtimeJoint",Km=new sp(7,16,1,1),Zm=new zd(2,7,Qm,28,1);_m.layouts[Qm]=Zm,_m.bindings[7]=Km;const Jm="cc_PositionDisplacements",ty=new sp(8,16,1,1),ey=new zd(2,8,Jm,28,1);_m.layouts[Jm]=ey,_m.bindings[8]=ty;const iy="cc_NormalDisplacements",sy=new sp(9,16,1,1),ry=new zd(2,9,iy,28,1);_m.layouts[iy]=ry,_m.bindings[9]=sy;const ny="cc_TangentDisplacements",oy=new sp(10,16,1,1),ay=new zd(2,10,ny,28,1);_m.layouts[ny]=ay,_m.bindings[10]=oy;const hy="cc_lightingMap",ly=11,cy=new sp(ly,16,1,16),uy=new zd(2,ly,hy,28,1);_m.layouts[hy]=uy,_m.bindings[11]=cy;const dy="cc_spriteTexture",py=new sp(12,16,1,16),_y=new zd(2,12,dy,28,1);_m.layouts[dy]=_y,_m.bindings[12]=py;const gy="cc_reflectionTexture",fy=new sp(13,16,1,16),my=new zd(2,13,gy,28,1);_m.layouts[gy]=my,_m.bindings[13]=fy;const yy="cc_reflectionStorage",vy=new sp(14,128,1,32),by=new Ud(2,14,yy,41,1);_m.layouts[yy]=by,_m.bindings[14]=vy;const wy="cc_reflectionProbeCubemap",Sy=15,xy=new sp(Sy,16,1,16),Ty=new zd(2,Sy,wy,31,1);_m.layouts[wy]=Ty,_m.bindings[15]=xy;const Cy="cc_reflectionProbePlanarMap",Iy=16,Ey=new sp(Iy,16,1,16),Dy=new zd(2,Iy,Cy,28,1);_m.layouts[Cy]=Dy,_m.bindings[16]=Ey;const Ay="cc_reflectionProbeDataMap",My=new sp(17,16,1,16),Py=new zd(2,17,Ay,28,1);_m.layouts[Ay]=Py,_m.bindings[17]=My;const By="cc_reflectionProbeBlendCubemap",Ry=18,Oy=new sp(Ry,16,1,16),Ly=new zd(2,Ry,By,31,1);_m.layouts[By]=Ly,_m.bindings[18]=Oy;const Fy=Kf.makeMaskExclude([Kf.BitMask.UI_2D,Kf.BitMask.GIZMOS,Kf.BitMask.EDITOR,Kf.BitMask.SCENE_GIZMO,Kf.BitMask.PROFILER]),zy=Kf.makeMaskExclude([Kf.BitMask.UI_2D,Kf.BitMask.PROFILER]),ky=Kf.Enum.ALL;let Ny;function Uy(t){if(Ny)return Ny;const e=new Bd(1,0,Vy(t)?11:35,16,16,0,1,1,1,1);return Ny=t.createTexture(e),Ny}function Vy(t){return!(3&~t.getFormatFeatures(11)||6===t.gfxAPI)}function Hy(t){return!(3&~t.getFormatFeatures(41))}function Gy(){return!(!h.rendering||!h.rendering.enableEffectImport)}t("pipeline",Object.freeze({__proto__:null,CAMERA_DEFAULT_MASK:Fy,CAMERA_EDITOR_MASK:zy,INST_JOINT_ANIM_INFO:Vm,INST_MAT_WORLD:Om,INST_SH:Lm,JOINT_UNIFORM_CAPACITY:30,MODEL_ALWAYS_MASK:ky,ModelLocalBindings:{UBO_LOCAL:0,UBO_FORWARD_LIGHTS:1,UBO_SKINNING_ANIMATION:2,UBO_SKINNING_TEXTURE:3,UBO_MORPH:4,UBO_UI_LOCAL:5,UBO_SH:6,SAMPLER_JOINTS:7,SAMPLER_MORPH_POSITION:8,SAMPLER_MORPH_NORMAL:9,SAMPLER_MORPH_TANGENT:10,SAMPLER_LIGHTMAP:11,SAMPLER_SPRITE:12,SAMPLER_REFLECTION:13,STORAGE_REFLECTION:14,SAMPLER_REFLECTION_PROBE_CUBE:15,SAMPLER_REFLECTION_PROBE_PLANAR:16,SAMPLER_REFLECTION_PROBE_DATA_MAP:17,SAMPLER_REFLECTION_PROBE_BLEND_CUBE:18,COUNT:19},PIPELINE_FLOW_FORWARD:"ForwardFlow",PIPELINE_FLOW_MAIN:"MainFlow",PIPELINE_FLOW_SHADOW:"ShadowFlow",PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",PipelineGlobalBindings:{UBO_GLOBAL:0,UBO_CAMERA:1,UBO_SHADOW:2,UBO_CSM:3,SAMPLER_SHADOWMAP:4,SAMPLER_ENVIRONMENT:5,SAMPLER_SPOT_SHADOW_MAP:6,SAMPLER_DIFFUSEMAP:7,COUNT:8},RenderPassStage:dm,RenderPriority:{MIN:0,MAX:255,DEFAULT:128},SetIndex:{GLOBAL:0,MATERIAL:1,LOCAL:2,COUNT:3},UBOCSM:vm,UBOCSMEnum:{CSM_LEVEL_COUNT:4,CSM_VIEW_DIR_0_OFFSET:0,CSM_VIEW_DIR_1_OFFSET:16,CSM_VIEW_DIR_2_OFFSET:32,CSM_ATLAS_OFFSET:48,MAT_CSM_VIEW_PROJ_OFFSET:64,CSM_PROJ_DEPTH_INFO_OFFSET:128,CSM_PROJ_INFO_OFFSET:144,CSM_SPLITS_INFO_OFFSET:160,COUNT:164,SIZE:656},UBOCamera:mm,UBOCameraEnum:{MAT_VIEW_OFFSET:0,MAT_VIEW_INV_OFFSET:16,MAT_PROJ_OFFSET:32,MAT_PROJ_INV_OFFSET:48,MAT_VIEW_PROJ_OFFSET:64,MAT_VIEW_PROJ_INV_OFFSET:80,CAMERA_POS_OFFSET:96,SURFACE_TRANSFORM_OFFSET:100,SCREEN_SCALE_OFFSET:104,EXPOSURE_OFFSET:108,MAIN_LIT_DIR_OFFSET:112,MAIN_LIT_COLOR_OFFSET:116,AMBIENT_SKY_OFFSET:120,AMBIENT_GROUND_OFFSET:124,GLOBAL_FOG_COLOR_OFFSET:128,GLOBAL_FOG_BASE_OFFSET:132,GLOBAL_FOG_ADD_OFFSET:136,NEAR_FAR_OFFSET:140,VIEW_PORT_OFFSET:144,COUNT:148,SIZE:592},UBODeferredLight:km,UBOForwardLight:zm,UBOForwardLightEnum:{LIGHTS_PER_PASS:1,LIGHT_POS_OFFSET:0,LIGHT_COLOR_OFFSET:4,LIGHT_SIZE_RANGE_ANGLE_OFFSET:8,LIGHT_DIR_OFFSET:12,LIGHT_BOUNDING_SIZE_VS_OFFSET:16,COUNT:20,SIZE:80},UBOGlobal:fm,UBOGlobalEnum:{TIME_OFFSET:0,SCREEN_SIZE_OFFSET:4,NATIVE_SIZE_OFFSET:8,PROBE_INFO_OFFSET:12,DEBUG_VIEW_MODE_OFFSET:16,COUNT:20,SIZE:80},UBOLocal:Bm,UBOLocalBatched:Fm,UBOLocalEnum:{MAT_WORLD_OFFSET:0,MAT_WORLD_IT_OFFSET:16,LIGHTINGMAP_UVPARAM:32,LOCAL_SHADOW_BIAS:36,REFLECTION_PROBE_DATA1:40,REFLECTION_PROBE_DATA2:44,REFLECTION_PROBE_BLEND_DATA1:48,REFLECTION_PROBE_BLEND_DATA2:52,COUNT:56,SIZE:224},UBOMorph:Wm,UBOMorphEnum:{MAX_MORPH_TARGET_COUNT:60,OFFSET_OF_WEIGHTS:0,OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH:240,OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT:244,OFFSET_OF_VERTICES_COUNT:248,COUNT_BASE_4_BYTES:64,SIZE:256},UBOSH:$m,UBOSHEnum:{SH_LINEAR_CONST_R_OFFSET:0,SH_LINEAR_CONST_G_OFFSET:4,SH_LINEAR_CONST_B_OFFSET:8,SH_QUADRATIC_R_OFFSET:12,SH_QUADRATIC_G_OFFSET:16,SH_QUADRATIC_B_OFFSET:20,SH_QUADRATIC_A_OFFSET:24,COUNT:28,SIZE:112},UBOShadow:ym,UBOShadowEnum:{MAT_LIGHT_VIEW_OFFSET:0,MAT_LIGHT_VIEW_PROJ_OFFSET:16,SHADOW_INV_PROJ_DEPTH_INFO_OFFSET:32,SHADOW_PROJ_DEPTH_INFO_OFFSET:36,SHADOW_PROJ_INFO_OFFSET:40,SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET:44,SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET:48,SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET:52,SHADOW_COLOR_OFFSET:56,PLANAR_NORMAL_DISTANCE_INFO_OFFSET:60,COUNT:64,SIZE:256},UBOSkinning:Hm,UBOSkinningAnimation:Um,UBOSkinningTexture:Nm,UBOUILocal:jm,UBOWorldBound:Rm,UNIFORM_DIFFUSEMAP_BINDING:7,UNIFORM_ENVIRONMENT_BINDING:5,UNIFORM_JOINT_TEXTURE_BINDING:7,UNIFORM_LIGHTMAP_TEXTURE_BINDING:ly,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:9,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:8,UNIFORM_REALTIME_JOINT_TEXTURE_BINDING:7,UNIFORM_REFLECTION_PROBE_BLEND_CUBEMAP_BINDING:Ry,UNIFORM_REFLECTION_PROBE_CUBEMAP_BINDING:Sy,UNIFORM_REFLECTION_PROBE_DATA_MAP_BINDING:17,UNIFORM_REFLECTION_PROBE_TEXTURE_BINDING:Iy,UNIFORM_REFLECTION_STORAGE_BINDING:14,UNIFORM_REFLECTION_TEXTURE_BINDING:13,UNIFORM_SHADOWMAP_BINDING:4,UNIFORM_SPOT_SHADOW_MAP_TEXTURE_BINDING:6,UNIFORM_SPRITE_TEXTURE_BINDING:12,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:10,bindingMappingInfo:gm,getDefaultShadowTexture:Uy,globalDescriptorSetLayout:pm,isEnableEffect:Gy,localDescriptorSetLayout:_m,localDescriptorSetLayout_ResizeMaxJoints:Gm,supportsR16HalfFloatTexture:function(t){return!(3&~t.getFormatFeatures(8))},supportsR32FloatTexture:Vy,supportsRGBA16HalfFloatTexture:Hy,supportsRGBA32FloatTexture:function(t){return!(3&~t.getFormatFeatures(44))}}));const Wy=4227858432,jy=66060288,$y=1044480,qy=function(t,e,i,s){return void 0===s&&(s=0),e<<26&Wy|t<<20&jy|i<<12&$y|4095&s},Xy=t=>(t&Wy)>>>26,Yy=t=>(t&jy)>>>20,Qy=t=>(t&$y)>>>12,Ky=t=>4095&t,Zy=(t,e)=>67108863&t|e<<26&Wy,Jy={0:function(t,e,i){return void 0===i&&(i=0),G(12010,i)},5:function(t,e,i){return void 0===i&&(i=0),t[i]},6:function(t,e,i){return void 0===i&&(i=0),Qs.fromArray(e,t,i)},7:function(t,e,i){return void 0===i&&(i=0),Ki.fromArray(e,t,i)},8:function(t,e,i){return void 0===i&&(i=0),cr.fromArray(e,t,i)},13:function(t,e,i){return void 0===i&&(i=0),t[i]},14:function(t,e,i){return void 0===i&&(i=0),Qs.fromArray(e,t,i)},15:function(t,e,i){return void 0===i&&(i=0),Ki.fromArray(e,t,i)},16:function(t,e,i){return void 0===i&&(i=0),cr.fromArray(e,t,i)},21:function(t,e,i){return void 0===i&&(i=0),ss.fromArray(e,t,i)},25:function(t,e,i){return void 0===i&&(i=0),Rs.fromArray(e,t,i)}},tv={0:function(t,e,i){return void 0===i&&(i=0),G(12010,i)},5:function(t,e,i){return void 0===i&&(i=0),t[i]=e},6:function(t,e,i){return void 0===i&&(i=0),Qs.toArray(t,e,i)},7:function(t,e,i){return void 0===i&&(i=0),Ki.toArray(t,e,i)},8:function(t,e,i){return void 0===i&&(i=0),cr.toArray(t,e,i)},13:function(t,e,i){return void 0===i&&(i=0),t[i]=e},14:function(t,e,i){return void 0===i&&(i=0),Qs.toArray(t,e,i)},15:function(t,e,i){return void 0===i&&(i=0),Ki.toArray(t,e,i)},16:function(t,e,i){return void 0===i&&(i=0),cr.toArray(t,e,i)},21:function(t,e,i){return void 0===i&&(i=0),ss.toArray(t,e,i)},25:function(t,e,i){return void 0===i&&(i=0),Rs.toArray(t,e,i)}},ev={5:t=>"number"==typeof t,13:t=>"number"==typeof t,6:t=>!!(t instanceof Qs),14:t=>!!(t instanceof Qs),7:t=>!!(t instanceof Ki),15:t=>!!(t instanceof Ki),8:t=>!!(t instanceof cr),16:t=>!!(t instanceof cr||t instanceof _r||t instanceof ys),21:t=>!!(t instanceof ss),25:t=>!!(t instanceof Rs)},iv=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function sv(t){switch(t){case 1:case 5:case 9:case 13:return iv[0];case 2:case 6:case 10:case 14:return iv[1];case 4:case 8:case 12:case 16:return iv[2];case 25:return iv[3];case 28:return"default-texture";case 31:return"default-cube-texture";case 29:return"default-array-texture";case 30:return"default-3d-texture"}return iv[0]}function rv(t){switch(t){case 28:return"-texture";case 31:return"-cube-texture";case 29:return"-array-texture";case 30:return"-3d-texture";default:return"-unknown"}}function nv(t,e){const i=Object.entries(e);let s=!1;for(let e=0;e<i.length;e++)t[i[e][0]]!==i[e][1]&&(t[i[e][0]]=i[e][1],s=!0);return s}function ov(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return G(16369),"-1"}}function av(t,e){const i=[];for(let s=0;s<e.length;s++){const r=e[s],n=r.name,o=t[n],a=ov(r,o),h=!o||"0"===o;i.push({name:n,value:a,isDefault:h})}return i}function hv(t,e){return t+e.reduce(((t,e)=>e.isDefault?t:`${t}|${e.name}${e.value}`),"")}function lv(t,e){for(let i=0;i<t.length;i++){const s=t[i];if("!"===s[0]){if(e[s.slice(1)])return!1}else if(!e[s])return!1}return!0}function cv(t,e,i){const s=[],r=t.attributes;for(let t=0;t<r.length;t++)lv(r[t].defines,i)&&s.push(e[t]);return s}function uv(t,e){const i=t.defines;if(t.uber){let s="";for(let t=0;t<i.length;t++){const r=i[t],n=e[r.name];if(!n||!r._map)continue;const o=r._map(n);s+=`${r._offset}${o}|`}return`${s}${t.hash}`}let s=0;for(let t=0;t<i.length;t++){const r=i[t],n=e[r.name];n&&r._map&&(s|=r._map(n)<<r._offset)}return`${s.toString(16)}|${t.hash}`}const dv=new Map;function pv(t,e){if(e.count)return t+Cp(e.type)*e.count;{const i=dv.get(e.name);if(void 0!==i)return t+Cp(e.type)*i;j(16345,e.name)}return t}function _v(t){return t.reduce(pv,0)}function gv(t){const e={};for(let i=0;i<t.blocks.length;i++){const s=t.blocks[i],r=s.members;let n=0;for(let t=0;t<r.length;t++){const i=r[t];e[i.name]=qy(s.binding,i.type,i.count,n),n+=(Cp(i.type)>>2)*i.count}}for(let i=0;i<t.samplerTextures.length;i++){const s=t.samplerTextures[i];e[s.name]=qy(s.binding,s.type,s.count)}return e}function fv(t){return Math.ceil(Math.log2(Math.max(t,2)))}function mv(t){let e=0;for(let i=0;i<t.defines.length;i++){const s=t.defines[i];let r=1;if("number"===s.type){const t=s.range;r=fv(t[1]-t[0]+1),s._map=e=>e-t[0]}else"string"===s.type?(r=fv(s.options.length),s._map=t=>Math.max(0,s.options.findIndex((e=>e===t)))):"boolean"===s.type&&(s._map=t=>t?1:0);s._offset=e,e+=r}e>31&&(t.uber=!0),t.constantMacros="";for(const e in t.builtins.statistics)t.constantMacros+=`#define ${e} ${t.builtins.statistics[e]}\n`}function yv(t){return Object.keys(t).reduce(((e,i)=>e.reduce(((e,s)=>{const r=t[i];for(let t=0;t<r.length;++t){const n={...s};n[i]=r[t],e.push(n)}return e}),[])),[{}])}function vv(t){for(let e=0;e<t.techniques.length;e++){const i=t.techniques[e];for(let t=0;t<i.passes.length;t++){const e=i.passes[t];void 0!==e.propertyIndex&&void 0===e.properties&&(e.properties=i.passes[e.propertyIndex].properties)}}}dv.set("cc_joints",Hm.LAYOUT.members[0].count),dv.set("cc_lightPos",1),dv.set("cc_lightColor",1),dv.set("cc_lightSizeRangeAngle",1),dv.set("cc_lightDir",1),dv.set("cc_lightBoundingSizeVS",1);const bv=new rp;function wv(t,e,i,s){const r=t.builtins[s],n=[];for(let t=0;t<r.blocks.length;t++){const e=r.blocks[t],s=i.layouts[e.name],o=s&&i.bindings.find((t=>t.binding===s.binding));s&&o&&o.descriptorType&yp?n.push(s):G(16348,e.name)}Array.prototype.unshift.apply(e.shaderInfo.blocks,n);const o=[];for(let t=0;t<r.samplerTextures.length;t++){const e=r.samplerTextures[t],s=i.layouts[e.name],n=s&&i.bindings.find((t=>t.binding===s.binding));s&&n&&n.descriptorType&vp?o.push(s):G(16349,e.name)}Array.prototype.unshift.apply(e.shaderInfo.samplerTextures,o)}function Sv(t){switch(t.gfxAPI){case 1:case 6:return"glsl1";case 2:case 7:return"glsl3";default:return"glsl4"}}const xv=new class{constructor(){this._templates={},this._cache={},this._templateInfos={}}register(t){for(let e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name;for(let e=0;e<t.techniques.length;e++){const i=t.techniques[e];for(let t=0;t<i.passes.length;t++){const e=i.passes[t];void 0!==e.propertyIndex&&void 0===e.properties&&(e.properties=i.passes[e.propertyIndex].properties)}}}define(t){const e=this._templates[t.name];if(e&&e.hash===t.hash)return e;const i={...t};if(mv(i),this._templates[t.name]=i,!this._templateInfos[i.hash]){const t={};t.samplerStartBinding=i.blocks.length,t.shaderInfo=new jd,t.blockSizes=[],t.bindings=[];for(let e=0;e<i.blocks.length;e++){const s=i.blocks[e];t.blockSizes.push(_v(s.members)),t.bindings.push(new sp(s.binding,1,1,s.stageFlags)),t.shaderInfo.blocks.push(new Fd(1,s.binding,s.name,s.members.map((t=>new Ld(t.name,t.type,t.count))),1))}for(let e=0;e<i.samplerTextures.length;e++){const s=i.samplerTextures[e];t.bindings.push(new sp(s.binding,16,s.count,s.stageFlags)),t.shaderInfo.samplerTextures.push(new zd(1,s.binding,s.name,s.type,s.count))}for(let e=0;e<i.samplers.length;e++){const s=i.samplers[e];t.bindings.push(new sp(s.binding,32,s.count,s.stageFlags)),t.shaderInfo.samplers.push(new kd(1,s.binding,s.name,s.count))}for(let e=0;e<i.textures.length;e++){const s=i.textures[e];t.bindings.push(new sp(s.binding,64,s.count,s.stageFlags)),t.shaderInfo.textures.push(new Nd(1,s.binding,s.name,s.type,s.count))}for(let e=0;e<i.buffers.length;e++){const s=i.buffers[e];t.bindings.push(new sp(s.binding,4,1,s.stageFlags)),t.shaderInfo.buffers.push(new Vd(1,s.binding,s.name,1,s.memoryAccess))}for(let e=0;e<i.images.length;e++){const s=i.images[e];t.bindings.push(new sp(s.binding,128,s.count,s.stageFlags)),t.shaderInfo.images.push(new Ud(1,s.binding,s.name,s.type,s.count,s.memoryAccess))}for(let e=0;e<i.subpassInputs.length;e++){const s=i.subpassInputs[e];t.bindings.push(new sp(s.binding,256,s.count,s.stageFlags)),t.shaderInfo.subpassInputs.push(new Hd(1,s.binding,s.name,s.count))}t.gfxAttributes=[];for(let e=0;e<i.attributes.length;e++){const s=i.attributes[e];t.gfxAttributes.push(new Wd(s.name,s.format,s.isNormalized,0,s.isInstanced,s.location))}wv(i,t,_m,"locals"),t.shaderInfo.stages.push(new Gd(1,"")),t.shaderInfo.stages.push(new Gd(16,"")),t.handleMap=gv(i),t.setLayouts=[],this._templateInfos[i.hash]=t}return i}getTemplate(t){return this._templates[t]}getTemplateInfo(t){const e=this._templates[t].hash;return this._templateInfos[e]}getDescriptorSetLayout(t,e,i){void 0===i&&(i=!1);const s=this._templates[e],r=this._templateInfos[s.hash];return r.setLayouts.length||(bv.bindings=r.bindings,r.setLayouts[1]=t.createDescriptorSetLayout(bv),bv.bindings=_m.bindings,r.setLayouts[2]=t.createDescriptorSetLayout(bv)),r.setLayouts[i?2:1]}hasProgram(t){return void 0!==this._templates[t]}getKey(t,e){return uv(this._templates[t],e)}destroyShaderByDefines(t){const e=Object.keys(t);if(!e.length)return;const i=e.map((e=>{let i=t[e];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(`${e}${i}`)})),s=Object.keys(this._cache).filter((t=>i.every((e=>e.test(this._cache[t].name)))));for(let t=0;t<s.length;t++){const e=s[t],i=this._cache[e];O(`destroyed shader ${i.name}`),i.destroy(),delete this._cache[e]}}getGFXShader(t,e,i,s,r){Object.assign(i,s.macros),r||(r=this.getKey(e,i));const n=this._cache[r];if(n)return n;const o=this._templates[e],a=this._templateInfos[o.hash];a.pipelineLayout||(this.getDescriptorSetLayout(t,e),wv(o,a,pm,"globals"),a.setLayouts[0]=s.descriptorSetLayout,a.pipelineLayout=t.createPipelineLayout(new op(a.setLayouts)));const h=av(i,o.defines),l=s.constantMacros+o.constantMacros+h.reduce(((t,e)=>`${t}#define ${e.name} ${e.value}\n`),"");let c=o.glsl3;const u=Sv(t);u?c=o[u]:j(16346),a.shaderInfo.stages[0].source=l+c.vert,a.shaderInfo.stages[1].source=l+c.frag,a.shaderInfo.attributes=cv(o,a.gfxAttributes,i),a.shaderInfo.name=hv(e,h);let d=a.shaderInfo;return this._cache[r]=t.createShader(d)}};var Tv,Cv,Iv,Ev,Dv,Av,Mv;h.programLib=xv;const Pv=["planar-shadow","skybox","deferred-lighting","bloom","hbao","copy-pass","post-process","profiler","splash-screen","unlit","sprite","particle","particle-gpu","particle-trail","billboard","terrain","graphics","clear-stencil","spine","occlusion-query","geometry-renderer","debug-renderer","ssss-blur","float-output-process"];let Bv=t("EffectAsset",oa("cc.EffectAsset")((Mv=class t extends F_{static register(e){t._effects[e.name]=e,t._layoutValid=!1}static remove(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name]===e&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(const i in t._effects)if(t._effects[i]._uuid===e)return void delete t._effects[i]}}static get(e){if(t._effects[e])return t._effects[e];for(const i in t._effects)if(t._effects[i]._uuid===e)return t._effects[i];return Pv.includes(e)&&G(16101,e),null}static getAll(){return t._effects}static isLayoutValid(){return t._layoutValid}static setLayoutValid(){t._layoutValid=!0}constructor(){super(),this.techniques=Iv&&Iv(),this.shaders=Ev&&Ev(),this.combinations=Dv&&Dv(),this.hideInEditor=Av&&Av()}onLoaded(){if(h.rendering&&h.rendering.enableEffectImport){vv(this);const t=h.rendering.programLib;t.addEffect(this),t.init(e_.gfxDevice)}else xv.register(this);t.register(this),h.game.once(h.Game.EVENT_RENDERER_INITED,this._precompile,this)}_precompile(){if(h.rendering&&h.rendering.enableEffectImport)return void h.rendering.programLib.precompileEffect(e_.gfxDevice,this);const t=h.director.root;for(let e=0;e<this.shaders.length;e++){const i=this.shaders[e],s=this.combinations[e];s&&yv(s).forEach((e=>xv.getGFXShader(e_.gfxDevice,i.name,e,t.pipeline)))}}destroy(){return t.remove(this),super.destroy()}initDefault(e){super.initDefault(e);const i=t.get("builtin-unlit");this.name="builtin-unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques}validate(){return this.techniques.length>0&&this.shaders.length>0}},Mv._effects={},Mv._layoutValid=!0,Iv=Qo((Cv=Mv).prototype,"techniques",[va],(function(){return[]})),Ev=Qo(Cv.prototype,"shaders",[va],(function(){return[]})),Dv=Qo(Cv.prototype,"combinations",[va],(function(){return[]})),Av=Qo(Cv.prototype,"hideInEditor",[va,wa],(function(){return!1})),Tv=Cv))||Tv);var Rv,Ov,Lv,Fv,zv,kv,Nv;h.EffectAsset=Bv;let Uv=t("TextureCube",oa("cc.TextureCube")((Nv=class t extends Vf{constructor(){super(),this.isRGBE=Lv&&Lv(),this._mipmapAtlas=Fv&&Fv(),this._mipmapMode=zv&&zv(),this._mipmaps=kv&&kv(),this._generatedMipmaps=[]}get mipmaps(){return this._mipmaps}set mipmaps(t){this._mipmaps=t;const e=[];if(1===t.length){const i=t[0],s=i.front.extractMipmaps(),r=i.back.extractMipmaps(),n=i.left.extractMipmaps(),o=i.right.extractMipmaps(),a=i.top.extractMipmaps(),h=i.bottom.extractMipmaps();if(s.length!==r.length||s.length!==n.length||s.length!==o.length||s.length!==a.length||s.length!==h.length)return j(16347),void this._setMipmapParams([]);const l=s.length;for(let t=0;t<l;++t){const i={front:s[t],back:r[t],left:n[t],right:o[t],top:a[t],bottom:h[t]};e.push(i)}}else t.length>1&&t.forEach((t=>{const i={front:t.front.extractMipmap0(),back:t.back.extractMipmap0(),left:t.left.extractMipmap0(),right:t.right.extractMipmap0(),top:t.top.extractMipmap0(),bottom:t.bottom.extractMipmap0()};e.push(i)}));this._setMipmapParams(e)}_setMipmapParams(t){if(this._generatedMipmaps=t,this._setMipmapLevel(this._generatedMipmaps.length),this._generatedMipmaps.length>0){const t=this._generatedMipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._generatedMipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._generatedMipmaps.forEach(((t,e)=>{Vv(t,((t,i)=>{this._assignImage(t,e,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._generatedMipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}set mipmapAtlas(t){if(this._mipmapAtlas=t,!this._mipmapAtlas)return void this.reset({width:0,height:0,mipmapLevel:0});const e=this._mipmapAtlas.atlas.front;if(!e.data)return;const i=this._mipmapAtlas.atlas,s=this._mipmapAtlas.layout,r=s[0],n=Object.assign(u.document.createElement("canvas"),{width:e.width,height:e.height}).getContext("2d");this.reset({width:r.width,height:r.height,format:e.format,mipmapLevel:s.length});for(let t=0;t<s.length;t++){const r=s[t];Vv(i,((t,i)=>{n.clearRect(0,0,e.width,e.height);const s=t.data;n.drawImage(s,0,0);const o=n.getImageData(r.left,r.top,r.width,r.height),a=new j_({_data:o.data,_compressed:t.isCompressed,width:o.width,height:o.height,format:t.format});this._assignImage(a,r.level,i)}))}}get mipmapAtlas(){return this._mipmapAtlas}isUsingOfflineMipmaps(){return 2===this._mipmapMode}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}static fromTexture2DArray(e,i){const s=[],r=e.length/6;for(let t=0;t<r;t++){const i=6*t;s.push({front:e[i+4].image,back:e[i+5].image,left:e[i+1].image,right:e[i+0].image,top:e[i+2].image,bottom:e[i+3].image})}return(i=i||new t).mipmaps=s,i}onLoaded(){2===this._mipmapMode?this.mipmapAtlas=this._mipmapAtlas:this.mipmaps=this._mipmaps}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format);const e=void 0===t.mipmapLevel?1:t.mipmapLevel;this._setMipmapLevel(e);const i=void 0===t.baseLevel?0:t.baseLevel,s=void 0===t.maxLevel?1e3:t.maxLevel;this._setMipRange(i,s),this._tryReset()}updateMipmaps(t,e){if(void 0===t&&(t=0),void 0===e&&(e=void 0),t>=this._generatedMipmaps.length)return;const i=Math.min(void 0===e?this._generatedMipmaps.length:e,this._generatedMipmaps.length-t);for(let e=0;e<i;++e){const i=t+e;Vv(this._generatedMipmaps[i],((t,e)=>{this._assignImage(t,i,e)}))}}destroy(){return this._mipmaps=[],this._generatedMipmaps=[],this._mipmapAtlas=null,super.destroy()}releaseTexture(){this.destroy()}_serialize(t){return null}_deserialize(t,e){const i=t;if(super._deserialize(i.base,e),this.isRGBE=i.rgbe,this._mipmapMode=i.mipmapMode,2===this._mipmapMode){const t=i.mipmapAtlas,s=i.mipmapLayout;this._mipmapAtlas={atlas:{},layout:s},this._mipmapAtlas.atlas={front:new j_,back:new j_,left:new j_,right:new j_,top:new j_,bottom:new j_};const r=Ut(j_);e.result.push(this._mipmapAtlas.atlas,"front",t.front,r),e.result.push(this._mipmapAtlas.atlas,"back",t.back,r),e.result.push(this._mipmapAtlas.atlas,"left",t.left,r),e.result.push(this._mipmapAtlas.atlas,"right",t.right,r),e.result.push(this._mipmapAtlas.atlas,"top",t.top,r),e.result.push(this._mipmapAtlas.atlas,"bottom",t.bottom,r)}else{this._mipmaps=new Array(i.mipmaps.length);for(let t=0;t<i.mipmaps.length;++t){this._mipmaps[t]={front:new j_,back:new j_,left:new j_,right:new j_,top:new j_,bottom:new j_};const s=i.mipmaps[t],r=Ut(j_);e.result.push(this._mipmaps[t],"front",s.front,r),e.result.push(this._mipmaps[t],"back",s.back,r),e.result.push(this._mipmaps[t],"left",s.left,r),e.result.push(this._mipmaps[t],"right",s.right,r),e.result.push(this._mipmaps[t],"top",s.top,r),e.result.push(this._mipmaps[t],"bottom",s.bottom,r)}}}_getGfxTextureCreateInfo(t){const e=new Bd(3);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e}_getGfxTextureViewCreateInfo(t){const e=new Rd;return e.type=3,e.baseLayer=0,e.layerCount=6,Object.assign(e,t),e}_uploadAtlas(){const t=this._mipmapAtlas.layout,e=t[0];this.reset({width:e.width,height:e.height,format:this._mipmapAtlas.atlas.front.format,mipmapLevel:t.length}),Vv(this._mipmapAtlas.atlas,((e,i)=>{const s=new qf;s.image=e,s.reset({width:e.width,height:e.height,format:e.format}),s.uploadData(e.data);for(let r=0;r<t.length;r++){const n=t[r],o=s.getGFXTexture().size,a=new Uint8Array(o),h=new bd;h.texOffset.x=n.left,h.texOffset.y=n.top,h.texExtent.width=n.width,h.texExtent.height=n.height,this._getGFXDevice().copyTextureToBuffers(s.getGFXTexture(),[a],[h]);const l=new j_({_data:a,_compressed:e.isCompressed,width:n.width,height:n.height,format:e.format});this._assignImage(l,n.level,i)}}))}initDefault(t){super.initDefault(t);const e=new j_;e.initDefault(),this.mipmaps=[{front:e,back:e,top:e,bottom:e,left:e,right:e}]}validate(){if(2===this._mipmapMode){if(null===this.mipmapAtlas||0===this.mipmapAtlas.layout.length)return!1;const t=this.mipmapAtlas.atlas;return!!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)}return 0!==this._mipmaps.length&&!this._mipmaps.find((t=>!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)))}},Nv.FaceIndex={right:0,left:1,top:2,bottom:3,front:4,back:5},Lv=Qo((Ov=Nv).prototype,"isRGBE",[va],(function(){return!1})),Fv=Qo(Ov.prototype,"_mipmapAtlas",[va],(function(){return null})),zv=Qo(Ov.prototype,"_mipmapMode",[va],(function(){return 0})),kv=Qo(Ov.prototype,"_mipmaps",[va],(function(){return[]})),Rv=Ov))||Rv);function Vv(t,e){e(t.front,4),e(t.back,5),e(t.left,1),e(t.right,0),e(t.top,2),e(t.bottom,3)}l.TextureCube=Uv;const Hv=(t,e)=>!(t.length>e.length)||47===t.charCodeAt(e.length),Gv=t=>{let e=t.uuids;const i=t.paths,s=t.types,r=t.deps,n=t.paths=Object.create(null);if(!1===t.debug){for(let t=0,i=e.length;t<i;t++)e[t]=x_(e[t]);for(const t in i){const e=i[t],r=e[1];e[1]=s[r]}}else{const t=Object.create(null);for(let i=0,s=e.length;i<s;i++){const s=e[i];e[i]=t[s]=x_(s)}e=t}for(const t in i){const s=i[t];n[e[t]]=s}const o=t.scenes;for(const t in o){const i=o[t];o[t]=e[i]}const a=t.packs;for(const t in a){const i=a[t];for(let t=0;t<i.length;++t)i[t]=e[i[t]]}const h=t.versions;if(h)for(const t in h){const i=h[t];for(let t=0;t<i.length;t+=2){const s=i[t];i[t]=e[s]||s}}const l=t.redirect;if(l)for(let t=0;t<l.length;t+=2)l[t]=e[l[t]],l[t+1]=r[l[t+1]];if(t.extensionMap)for(const i in t.extensionMap)Object.prototype.hasOwnProperty.call(t.extensionMap,i)&&t.extensionMap[i].forEach(((s,r)=>{t.extensionMap[i][r]=e[s]||s}))};class Wv{constructor(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new a_,this.scenes=new a_,this.paths=new a_}init(t){Gv(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);for(const e in t.extensionMap)Object.prototype.hasOwnProperty.call(t.extensionMap,e)&&t.extensionMap[e].forEach((t=>{const i=this.assetInfos.get(t);i&&(i.extension=e)}))}getInfoWithPath(t,e){if(!t)return null;t=E_(t);const i=this.paths.get(t);if(i){if(!e)return i[0];for(let t=0,s=i.length;t<s;t++){const s=i[t];if(It(s.ctor,e))return s}}return null}getDirWithPath(t,e,i){"/"===(t=E_(t))[t.length-1]&&(t=t.slice(0,-1));const s=i||[];return this.paths.forEach(((i,r)=>{if(r.startsWith(t)&&Hv(r,t)||!t)for(let t=0,r=i.length;t<r;t++){const r=i[t];e&&!It(r.ctor,e)||s.push(r)}})),s}getAssetInfo(t){return this.assetInfos.get(t)||null}getSceneInfo(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t=`/${t}`),this.scenes.find(((e,i)=>i.endsWith(t)))}destroy(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()}_initUuid(t){if(t){this.assetInfos.clear();for(let e=0,i=t.length;e<i;e++){const i=t[e];this.assetInfos.add(i,{uuid:i})}}}_initPath(t){if(!t)return;const e=this.paths;e.clear();for(const i in t){const s=t[i],r=s[0],n=s[1],o=3===s.length,a=this.assetInfos.get(i);a.path=r,a.ctor=zt(n),e.has(r)?o?e.get(r).push(a):e.get(r).unshift(a):e.add(r,[a])}}_initScene(t){if(!t)return;const e=this.scenes;e.clear();const i=this.assetInfos;for(const s in t){const r=t[s],n=i.get(r);n.url=s,e.add(s,n)}}_initPackage(t){if(!t)return;const e=this.assetInfos;for(const i in t){const s=t[i],r={uuid:i,packedUuids:s,ext:".json"};e.add(i,r);for(let t=0,i=s.length;t<i;t++){const n=s[t],o=e.get(n),a=o.packs;a?1===i?a.unshift(r):a.push(r):o.packs=[r]}}}_initVersion(t){if(!t)return;const e=this.assetInfos;let i=t.import;if(i)for(let t=0,s=i.length;t<s;t+=2){const s=i[t];e.get(s).ver=i[t+1]}if(i=t.native,i)for(let t=0,s=i.length;t<s;t+=2){const s=i[t];e.get(s).nativeVer=i[t+1]}}_initRedirect(t){if(!t)return;const e=this.assetInfos;for(let i=0,s=t.length;i<s;i+=2){const s=t[i];e.get(s).redirect=t[i+1]}}}function jv(t,e){t._uuid&&e.push(t._uuid)}function $v(t,e){const i=Object.getOwnPropertyNames(t);for(let s=0;s<i.length;s++){const r=i[s];if("node"===r||"__eventTargets"===r)continue;const n=t[r];if("object"==typeof n&&n)if(Array.isArray(n))for(let t=0;t<n.length;t++){const i=n[t];i instanceof F_&&jv(i,e)}else if(n.constructor&&n.constructor!==Object)n instanceof F_&&jv(n,e);else{const t=Object.getOwnPropertyNames(n);for(let i=0;i<t.length;i++){const s=n[t[i]];s instanceof F_&&jv(s,e)}}}}function qv(t,e){for(let i=0;i<t._components.length;i++)$v(t._components[i],e);for(let i=0;i<t._children.length;i++)qv(t._children[i],e)}function Xv(t,e,i,s){i.push(t._uuid);const r=Ff.getDeps(t._uuid);for(let t=0,n=r.length;t<n;t++){const n=l_.get(r[t]);if(!n)continue;const o=n._uuid;o in e?e[o]+=s:e[o]=n.refCount+s,i.includes(o)||Xv(n,e,i,s)}}const Yv=[];function Qv(t){const e=Object.create(null);if(e[t._uuid]=t.refCount,Xv(t,e,Yv,-1),Yv.length=0,0!==e[t._uuid])return e[t._uuid];for(const t in e)0!==e[t]&&Xv(l_.get(t),e,Yv,1);return Yv.length=0,e[t._uuid]}const Kv=new class{constructor(){this._persistNodeDeps=new a_,this._toDelete=new a_,this._eventListener=!1,this._dontDestroyAssets=[]}addIgnoredAsset(t){this._dontDestroyAssets.push(t._uuid)}init(){this._persistNodeDeps.clear(),this._toDelete.clear()}_addPersistNodeRef(t){const e=[];qv(t,e);for(let t=0,i=e.length;t<i;t++){const i=l_.get(e[t]);i&&i.addRef()}this._persistNodeDeps.add(t.uuid,e)}_removePersistNodeRef(t){if(!this._persistNodeDeps.has(t.uuid))return;const e=this._persistNodeDeps.get(t.uuid);for(let t=0,i=e.length;t<i;t++){const i=l_.get(e[t]);i&&i.decRef()}this._persistNodeDeps.remove(t.uuid)}_autoRelease(t,e,i){if(t){const i=Ff.getDeps(t.uuid);for(let e=0,s=i.length;e<s;e++){const s=l_.get(i[e]);s&&s.decRef(t.autoReleaseAssets)}const s=Ff._depends.get(t.uuid);if(s&&s.persistDeps){const e=s.persistDeps;for(let i=0,s=e.length;i<s;i++){const s=l_.get(e[i]);s&&s.decRef(t.autoReleaseAssets)}}t.uuid!==e.uuid&&Ff.remove(t.uuid)}const s=Ff._depends.get(e.uuid);s&&(s.persistDeps=[]);for(const t in i){const e=i[t],r=this._persistNodeDeps.get(e.uuid);for(const t of r){const e=l_.get(t);e&&e.addRef()}s&&s.persistDeps.push(...r)}}tryRelease(t,e){void 0===e&&(e=!1),t instanceof F_&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,ye(this._freeAssets.bind(this)))))}_freeAssets(){this._eventListener=!1,this._toDelete.forEach((t=>{this._free(t)})),this._toDelete.clear()}_free(t,e){void 0===e&&(e=!1);const i=t._uuid;if(this._toDelete.remove(i),!bn(t,!0)||-1!==this._dontDestroyAssets.indexOf(i))return;if(!e&&t.refCount>0&&Qv(t)>0)return;l_.remove(i);const s=Ff.getDeps(i);for(let t=0,e=s.length;t<e;t++){const e=l_.get(s[t]);e&&(e.decRef(!1),this._free(e,!1))}t.destroy(),Ff.remove(i)}};function Zv(t){for(let e=0,i=t.input.length;e<i;e++){const i=t.input[e];!i.isNative&&i.content instanceof F_&&i.content.decRef(!1),i.recycle()}t.input=null}function Jv(t,e){return e?/\?/.test(t)?`${t}&_t=${Date.now()}`:`${t}?_t=${Date.now()}`:t}function tb(t,e,i,s,r){void 0===r&&(r=0),t(r,((n,o)=>{r++,!n||r>e?s&&s(n,o):setTimeout((()=>{tb(t,e,i,s,r)}),i)}))}function eb(t,e,i,s,r){try{const n=Ff.parse(t,e);for(let t=0,e=n.deps.length;t<e;t++){const e=n.deps[t];e in i||(i[e]=!0,s.push({uuid:e,bundle:r&&r.name}))}n.nativeDep&&(r&&(n.nativeDep.bundle=r.name),s.push({...n.nativeDep}))}catch(t){B(t.message,t.stack)}}function ib(t,e,i){e&&(i=void 0!==i?i:h.assetManager.cacheAsset,I_(e)||!i||e.isDefault||l_.add(t,e))}function sb(t,e,i){let s=!1;const r=Mf.get(e);if(r){for(let t=0,n=r.length;t<n;t++){const n=r[t],o=i[`${n.uuid}@import`];if(o)n.owner[n.prop]=o.addRef();else{if(j(16350,n.uuid),h.assetManager.dispatchAssetMissing(e,n.owner,n.prop,n.uuid),n.type&&n.type!==F_){const t=new n.type;t.initDefault(n.uuid),n.owner[n.prop]=t}s=!0}}Mf.delete(e)}return Pf.has(e)&&(i[`${t}@native`]?e._nativeAsset=i[`${t}@native`]:(s=!0,j(16351,t)),Pf.delete(e)),s}function rb(t){const e=t.source;if(t.options.__outputAsArray__||1!==e.length){const i=t.output=[];for(let t=0,s=e.length;t<s;t++)i.push(e[t].content)}else t.output=e[0].content}function nb(t,e,i){let s=0;const r=[],n=t.length;0===n&&i&&i(r);const o=t=>{t&&r.push(t),s++,s===n&&i&&i(r)};for(let i=0;i<n;i++)e(t[i],o)}function ob(t,e,i){let s=t,r=e,n=i;if(void 0===i){const i="function"==typeof t;e?(n=e,i||(r=null)):void 0===e&&i&&(n=t,s=null,r=null),void 0!==e&&i&&(r=t,s=null)}return{options:s||Object.create(null),onProgress:r,onComplete:n}}function ab(t,e,i){let s=t,r=e,n=i;if(void 0===i){const i=It(t,F_);e?(n=e,i&&(r=null)):void 0!==e||i||(n=t,r=null,s=null),void 0===e||i||(r=t,s=null)}return{type:s,onProgress:r||null,onComplete:n}}function hb(t,e,i,s){if(void 0===s&&(s={}),!i[e]||s[e])return!1;s[e]=!0;let r=!1;const n=Ff.getDeps(e);if(n)for(let e=0,o=n.length;e<o;e++){const o=n[e];if(o===t||hb(t,o,i,s)){r=!0;break}}return r}function lb(t){return(e,i)=>{if(!t)return;const s=[];Array.isArray(i)?i.forEach((t=>t instanceof F_&&s.push(t.addRef()))):i instanceof F_&&s.push(i.addRef()),ye((()=>{s.forEach((t=>t.decRef(!1))),t(e,i)}))}}class cb{constructor(){this._config=new Wv}get config(){return this._config}get name(){return this._config.name}get deps(){return this._config.deps}get base(){return this._config.base}getInfoWithPath(t,e){return this._config.getInfoWithPath(t,e)}getDirWithPath(t,e,i){return this._config.getDirWithPath(t,e,i)}getAssetInfo(t){return this._config.getAssetInfo(t)}getSceneInfo(t){return this._config.getSceneInfo(t)}init(t){this._config.init(t),d_.add(t.name,this)}load(t,e,i,s){const{type:r,onProgress:n,onComplete:o}=ab(e,i,s),a={__requestType__:"path",type:r,bundle:this.name,__outputAsArray__:Array.isArray(t)};h.assetManager.loadAny(t,a,n,o)}preload(t,e,i,s){const{type:r,onProgress:n,onComplete:o}=ab(e,i,s);h.assetManager.preloadAny(t,{__requestType__:"path",type:r,bundle:this.name},n,o)}loadDir(t,e,i,s){const{type:r,onProgress:n,onComplete:o}=ab(e,i,s);h.assetManager.loadAny(t,{__requestType__:"dir",type:r,bundle:this.name,__outputAsArray__:!0},n,o)}preloadDir(t,e,i,s){const{type:r,onProgress:n,onComplete:o}=ab(e,i,s);h.assetManager.preloadAny(t,{__requestType__:"dir",type:r,bundle:this.name},n,o)}loadScene(t,e,i,s){const{options:r,onProgress:n,onComplete:o}=ob(e,i,s);r.preset=r.preset||"scene",r.bundle=this.name,h.assetManager.loadAny({scene:t},r,n,((t,e)=>{if(t)B(t.message,t.stack);else if(e.scene){const t=e.scene;t.id=e._uuid,t.name=e.name}else t=new Error(`The asset ${e._uuid} is not a scene`);o&&o(t,e)}))}preloadScene(t,e,i,s){const{options:r,onProgress:n,onComplete:o}=ob(e,i,s);r.bundle=this.name,h.assetManager.preloadAny({scene:t},r,n,(e=>{e&&j(1210,t,e.message),o&&o(e)}))}get(t,e){const i=this.getInfoWithPath(t,e);return i&&l_.get(i.uuid)||null}release(t,e){const i=this.get(t,e);i&&Kv.tryRelease(i,!0)}releaseUnusedAssets(){l_.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&Kv.tryRelease(t)}))}releaseAll(){l_.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&Kv.tryRelease(t,!0)}))}_destroy(){this._config.destroy()}}const ub=t("resources",new cb);function db(t,e,i){const s=new u.Image;function r(){s.removeEventListener("load",r),s.removeEventListener("error",n),i&&i(null,s)}function n(){s.removeEventListener("load",r),s.removeEventListener("error",n),i&&i(new Error(Y(4930,t)))}return"file:"!==u.location.protocol&&(s.crossOrigin="anonymous"),s.addEventListener("load",r),s.addEventListener("error",n),s.src=t,s}function pb(t,e,i,s){const r=new XMLHttpRequest,n=`download failed: ${t}, status: `;if(r.open("GET",t,!0),void 0!==e.xhrResponseType&&(r.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(r.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(r.timeout=e.xhrTimeout),e.xhrHeader)for(const t in e.xhrHeader)r.setRequestHeader(t,e.xhrHeader[t]);return r.onload=()=>{200===r.status||0===r.status?s&&s(null,r.response):s&&s(new Error(`${n}${r.status}(no response)`))},i&&(r.onprogress=t=>{t.lengthComputable&&i(t.loaded,t.total)}),r.onerror=()=>{s&&s(new Error(`${n}${r.status}(error)`))},r.ontimeout=()=>{s&&s(new Error(`${n}${r.status}(time out)`))},r.onabort=()=>{s&&s(new Error(`${n}${r.status}(abort)`))},r.send(null),r}h.resources=ub;const _b=u.document,gb={};function fb(t,e,i){if(gb[t])return i&&i(null),null;const s=_b.createElement("script");function r(){s.parentNode.removeChild(s),s.removeEventListener("load",r,!1),s.removeEventListener("error",n,!1),gb[t]=!0,i&&i(null)}function n(){s.parentNode.removeChild(s),s.removeEventListener("load",r,!1),s.removeEventListener("error",n,!1),i&&i(new Error(Y(4928,t)))}return"file:"!==u.location.protocol&&(s.crossOrigin="anonymous"),s.async=e.scriptAsyncLoading||!1,s.src=t,s.addEventListener("load",r,!1),s.addEventListener("error",n,!1),_b.body.appendChild(s),s}const mb=/^(?:\w+:\/\/|\.+\/).+/,yb=(t,e,i)=>{(Hn.hasFeature(Hn.Feature.IMAGE_BITMAP)&&h.assetManager.allowImageBitmap?vb:db)(t,e,i)},vb=(t,e,i)=>{e.xhrResponseType="blob",pb(t,e,e.onFileProgress,i)},bb=(t,e,i)=>{e.xhrResponseType="json",pb(t,e,e.onFileProgress,i)},wb=(t,e,i)=>{e.xhrResponseType="arraybuffer",pb(t,e,e.onFileProgress,i)},Sb=(t,e,i)=>{Eb._downloadJson(t,e,((e,s)=>{if(e)return void i(e);const r=Lg(s);Promise.all(r.chunks.map((i=>new Promise(((s,r)=>{Eb._downloadArrayBuffer(`${Oc(t)}${i}`,{},((t,i)=>{e?r(e):s(new Uint8Array(i))}))}))))).then((t=>{const e=new Og(r.document,t);i(null,e)})).catch((t=>{i(t)}))}))},xb=(t,e,i)=>{Eb._downloadArrayBuffer(t,e,((t,e)=>{if(t)i(t);else try{const t=Fg(new Uint8Array(e));i(null,t)}catch(t){i(t)}}))},Tb=(t,e,i)=>{e.xhrResponseType="text",pb(t,e,e.onFileProgress,i)},Cb=(t,e,i)=>{const s=Lc(t);let r=t;mb.test(r)||(r=-1!==Eb.remoteBundles.indexOf(s)?`${Eb.remoteServerAddress}remote/${s}`:`assets/${s}`);const n=e.version||Eb.bundleVers[s];let o=0,a=null,h=null;bb(`${r}/config.${n?`${n}.`:""}json`,e,((t,e)=>{h=t||h,a=e,a&&(a.base=`${r}/`),2==++o&&i(h,a)})),fb(`${r}/index.${n?`${n}.`:""}js`,e,(t=>{h=t||h,2==++o&&i(h,a)}))};class Ib{static get instance(){return Ib._instance||(Ib._instance=new Ib),Ib._instance}get remoteServerAddress(){return this._remoteServerAddress}init(t,e,i){void 0===t&&(t=""),void 0===e&&(e={}),void 0===i&&(i=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=i}get handlers(){return this._downloaders}register(t,e){"object"==typeof t?xt(this._downloaders,t):this._downloaders[t]=e}download(t,e,i,s,r){const n=c_.get(t);if(n)return void r(null,n);const o=this._downloading.get(t);if(o){o.push(r);const e=this._queue.find((e=>e.id===t));if(!e)return;const i=s.priority||0;return void(e.priority<i&&(e.priority=i,this._queueDirty=!0))}const a=void 0!==s.maxRetryCount?s.maxRetryCount:this.maxRetryCount,h=void 0!==s.maxConcurrency?s.maxConcurrency:this.maxConcurrency,l=void 0!==s.maxRequestsPerFrame?s.maxRequestsPerFrame:this.maxRequestsPerFrame,c=this._downloaders[i]||this._downloaders.default;tb(((i,n)=>{if(0===i&&this._downloading.add(t,[r]),!this.limited)return void c(Jv(e,this.appendTimeStamp),s,n);this._updateTime();const o=(t,e)=>{this._totalNum--,this._handleQueueInNextFrame(h,l),n(t,e)};this._totalNum<h&&this._totalNumThisPeriod<l?(c(Jv(e,this.appendTimeStamp),s,o),this._totalNum++,this._totalNumThisPeriod++):(this._queue.push({id:t,priority:s.priority||0,url:e,options:s,done:o,handler:c}),this._queueDirty=!0,this._totalNum<h&&this._handleQueueInNextFrame(h,l))}),a,this.retryInterval,((e,i)=>{e||c_.add(t,i);const s=this._downloading.remove(t);for(let t=0,r=s.length;t<r;t++)s[t](e,i)}))}loadSubpackage(t,e){h.assetManager.loadBundle(t,null,e)}constructor(){this.maxConcurrency=15,this.maxRequestsPerFrame=15,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers={},this.remoteBundles=[],this.downloadDomImage=db,this.downloadDomAudio=null,this.downloadFile=pb,this.downloadScript=fb,this._downloadArrayBuffer=wb,this._downloadJson=bb,this._downloaders={".png":yb,".jpg":yb,".bmp":yb,".jpeg":yb,".gif":yb,".ico":yb,".tiff":yb,".webp":yb,".image":yb,".pvr":wb,".pkm":wb,".astc":wb,".txt":Tb,".xml":Tb,".vsh":Tb,".fsh":Tb,".atlas":Tb,".tmx":Tb,".tsx":Tb,".json":bb,".ExportJson":bb,".plist":Tb,".ccon":Sb,".cconb":xb,".fnt":Tb,".binary":wb,".bin":wb,".dbbin":wb,".skel":wb,".js":fb,bundle:Cb,default:Tb},this._downloading=new a_,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}_updateTime(){const t=performance.now(),e=h.game.deltaTime,i=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*i&&(this._totalNumThisPeriod=0,this._lastDate=t)}_handleQueue(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort(((t,e)=>t.priority-e.priority)),this._queueDirty=!1);const t=this._queue.pop();if(!t)break;this._totalNum++,this._totalNumThisPeriod++,t.handler(Jv(t.url,this.appendTimeStamp),t.options,t.done)}this._handleQueueInNextFrame(t,e)}_handleQueueInNextFrame(t,e){!this._checkNextPeriod&&this._queue.length>0&&(ye(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)}}Ib._instance=void 0;const Eb=Ib.instance;var Db,Ab,Mb,Pb=Ib.instance;let Bb=t("JsonAsset",oa("cc.JsonAsset")((Ab=class extends F_{constructor(){super(),this.json=Mb&&Mb()}},Mb=Qo(Ab.prototype,"json",[va],(function(){return null})),Db=Ab))||Db);var Rb,Ob,Lb;h.JsonAsset=Bb;let Fb=t("TextAsset",oa("cc.TextAsset")((Ob=class extends F_{toString(){return this.text}constructor(){super(),this.text=Lb&&Lb()}},Lb=Qo(Ob.prototype,"text",[va],(function(){return""})),Rb=Ob))||Rb);var zb,kb;h.TextAsset=Fb;let Nb=t("BufferAsset",oa("cc.BufferAsset")((s((kb=class extends F_{constructor(){super(),this._buffer=null}get _nativeAsset(){return this._buffer}set _nativeAsset(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}buffer(){return this._buffer,this._buffer}validate(){return!!this._buffer}}).prototype,"_nativeAsset",[Wa],Object.getOwnPropertyDescriptor(kb.prototype,"_nativeAsset"),kb.prototype),zb=kb))||zb);function Ub(t,e,i,s){let r=null,n=null;try{r=new j_,r._nativeUrl=t,r._nativeAsset=e}catch(t){n=t}s(n,r)}function Vb(t,e,i,s){const r=new Bb;r.json=e,s(null,r)}function Hb(t,e,i,s){const r=new Fb;r.text=e,s(null,r)}function Gb(t,e,i,s){const r=new Nb;r._nativeUrl=t,r._nativeAsset=e,s(null,r)}function Wb(t,e,i,s){const r=new F_;r._nativeUrl=t,r._nativeAsset=e,s(null,r)}function jb(t,i,s,r){let n=d_.get(i.name);n||(n="resources"===i.name?ub:new cb,i.base=i.base||`${t}/`,n.init(i)),e.import(`virtual:///prerequisite-imports/${n.name}`).then((()=>{r(null,n)})).catch(r)}h.BufferAsset=Nb;var $b=new class{constructor(){this._creating=new a_,this._producers={".png":Ub,".jpg":Ub,".bmp":Ub,".jpeg":Ub,".gif":Ub,".ico":Ub,".tiff":Ub,".webp":Ub,".image":Ub,".pvr":Ub,".pkm":Ub,".astc":Ub,".txt":Hb,".xml":Hb,".vsh":Hb,".fsh":Hb,".atlas":Hb,".tmx":Hb,".tsx":Hb,".fnt":Hb,".json":Vb,".ExportJson":Vb,".binary":Gb,".bin":Gb,".dbbin":Gb,".skel":Gb,bundle:jb,default:Wb}}register(t,e){"object"==typeof t?xt(this._producers,t):this._producers[t]=e}create(t,e,i,s,r){const n=this._producers[i]||this._producers.default,o=l_.get(t);if(!s.reloadAsset&&o)return void r(null,o);const a=this._creating.get(t);a?a.push(r):(this._creating.add(t,[r]),n(t,e,s,((e,i)=>{!e&&i instanceof F_&&(i._uuid=t,ib(t,i,s.cacheAsset));const r=this._creating.remove(t);for(let t=0,s=r.length;t<s;t++)r[t](e,i)})))}},qb=new class{constructor(){this._loading=new a_,this._unpackers={".json":this.unpackJson}}unpackJson(t,e,i,s){const r=dt(!0);let n=null;if(Array.isArray(e)){(e=If(e)).length!==t.length&&j(4915);for(let i=0;i<t.length;i++)r[`${t[i]}@import`]=e[i]}else{const i=Ut(qf),o=Ut(j_);if(e.type===i&&e.data){const s=e.data;s.length!==t.length&&j(4915);for(let e=0;e<t.length;e++)r[`${t[e]}@import`]=Ef(i,{base:s[e][0],mipmaps:s[e][1]})}else{if(e.type!==o||!e.data)return n=new Error("unmatched type pack!"),void s(n,null);{const i=e.data;i.length!==t.length&&j(4915);for(let e=0;e<t.length;e++)r[`${t[e]}@import`]=i[e]}}}s(n,r)}init(){this._loading.clear()}register(t,e){"object"==typeof t?xt(this._unpackers,t):this._unpackers[t]=e}unpack(t,e,i,s,r){e?(0,this._unpackers[i])(t,e,s,r):r(new Error("package data is wrong!"))}load(t,e,i){if(t.isNative||!t.info||!t.info.packs)return void Pb.download(t.id,t.url,t.ext,t.options,i);if(c_.has(t.id))return void i(null,c_.get(t.id));const s=t.info.packs,r=s.find((t=>this._loading.has(t.uuid)));if(r)return void this._loading.get(r.uuid).push({onComplete:i,id:t.id});const n=s[0];this._loading.add(n.uuid,[{onComplete:i,id:t.id}]),t.config;const o=D_(n.uuid,{ext:n.ext,bundle:t.config.name});Pb.download(n.uuid,o,n.ext,t.options,((e,i)=>{c_.remove(n.uuid),e&&B(e.message,e.stack),this.unpack(n.packedUuids,i,n.ext,t.options,((t,i)=>{if(!t)for(const t in i)c_.add(t,i[t]);const s=this._loading.remove(n.uuid);for(let r=0,n=s.length;r<n;r++){const n=s[r];if(e||t){n.onComplete(e||t);continue}const o=i[n.id];o?n.onComplete(null,o):n.onComplete(new Error("can not retrieve data from package"))}}))}))}};function Xb(t,e){let i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);const{options:s,progress:r}=t,n=[],o=r.total,a=s.__exclude__=s.__exclude__||Object.create(null);t.output=[],nb(t.input,((s,l)=>{if(!s.isNative&&l_.has(s.uuid)){const e=l_.get(s.uuid);return s.content=e.addRef(),t.output.push(s),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s),void l()}qb.load(s,t.options,((c,u)=>{c?t.isFinished||(!h.assetManager.force||i?(B(c.message,c.stack),r.canInvoke=!1,e(c)):(t.output.push(s),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s))):t.isFinished||(s.file=u,t.output.push(s),s.isNative||(a[s.uuid]=!0,eb(s.uuid,u,a,n,s.config),r.total=o+n.length),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s)),l()}))}),(()=>{if(t.isFinished)return Zv(t),void t.dispatch("error");if(n.length>0){const o=y_.create({input:n,progress:r,options:s,onProgress:t.onProgress,onError:y_.prototype.recycle,onComplete:s=>{s||(t.output.push(...o.output),o.recycle()),i&&Yb(t),e(s)}});__.async(o)}else i&&Yb(t),e()}))}function Yb(t){const e=t.output;for(let t=0,i=e.length;t<i;t++)e[t].content&&e[t].content.decRef(!1)}class Qb{constructor(){this._parser=null,globalThis.DOMParser&&(this._parser=new DOMParser)}parse(t){return this._parseXML(t)}_parseXML(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")}}const Kb=new class extends Qb{parse(t){const e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return G(5100),{};let i=null;for(let t=0,s=e.childNodes.length;t<s&&(i=e.childNodes[t],1!==i.nodeType);t++);return this._parseNode(i)}_parseNode(t){let e=null;const i=t.tagName;if("dict"===i)e=this._parseDict(t);else if("array"===i)e=this._parseArray(t);else if("string"===i)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(let i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].nodeValue}else"false"===i?e=!1:"true"===i?e=!0:"real"===i?e=parseFloat(t.firstChild.nodeValue):"integer"===i&&(e=parseInt(t.firstChild.nodeValue,10));return e}_parseArray(t){const e=[];for(let i=0,s=t.childNodes.length;i<s;i++){const s=t.childNodes[i];1===s.nodeType&&e.push(this._parseNode(s))}return e}_parseDict(t){const e={};let i="";for(let s=0,r=t.childNodes.length;s<r;s++){const r=t.childNodes[s];1===r.nodeType&&("key"===r.tagName?i=r.firstChild.nodeValue:e[i]=this._parseNode(r))}return e}};let Zb=class t{static get instance(){return this._instance||(this._instance=new t),this._instance}constructor(){this._parsing=new a_,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}parseImage(t,e,i){t instanceof HTMLImageElement?i(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((t=>{i(null,t)}),(t=>{i(t,null)}))}parsePVRTex(t,e,i){let s=null,r=null;try{r=j_.parseCompressedTextures(t,0)}catch(t){s=t,P(s)}i(s,r)}parsePKMTex(t,e,i){let s=null,r=null;try{r=j_.parseCompressedTextures(t,1)}catch(t){s=t,P(s)}i(s,r)}parseASTCTex(t,e,i){let s=null,r=null;try{r=j_.parseCompressedTextures(t,2)}catch(t){s=t,P(s)}i(s,r)}parsePlist(t,e,i){let s=null;const r=Kb.parse(t);r||(s=new Error("parse failed")),i(s,r)}parseImport(t,e,i){if(!t)return void i(new Error(`The json file of asset ${e.__uuid__} is empty or missing`));let s=null,r=null;try{s=Rf(t,e)}catch(t){r=t}i(r,s)}init(){this._parsing.clear()}register(t,e){"object"==typeof t?xt(this._parsers,t):this._parsers[t]=e}parse(t,e,i,s,r){const n=u_.get(t);if(n)return void r(null,n);const o=this._parsing.get(t);if(o)return void o.push(r);const a=this._parsers[i];a?(this._parsing.add(t,[r]),a(e,s,((e,i)=>{e?c_.remove(t):I_(i)||u_.add(t,i);const s=this._parsing.remove(t);for(let t=0,r=s.length;t<r;t++)s[t](e,i)}))):r(null,e)}};Zb._instance=void 0;var Jb=Zb.instance;function tw(t,e){let i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);const{options:s,progress:r}=t;s.__exclude__=s.__exclude__||Object.create(null),t.output=[],nb(t.input,((n,o)=>{const a=y_.create({input:n,onProgress:t.onProgress,options:s,progress:r,onComplete:(s,l)=>{s&&!t.isFinished&&(!h.assetManager.force||i?(B(s.message,s.stack),r.canInvoke=!1,e(s)):r.canInvoke&&t.dispatch("progress",++r.finish,r.total,n)),t.output.push(l),a.recycle(),o(null)}});ew.async(a)}),(()=>{if(s.__exclude__=null,t.isFinished)return Zv(t),void t.dispatch("error");rb(t),Zv(t),e()}))}const ew=new h_("loadOneAsset",[function(t,e){const i=t.output=t.input,{options:s,isNative:r,uuid:n,file:o}=i,{reloadAsset:a}=s;o||!a&&!r&&l_.has(n)?e():qb.load(i,t.options,((t,s)=>{i.file=s,e(t)}))},function(t,e){const i=t.output=t.input,s=t.progress,r=t.options.__exclude__,{id:n,file:o,options:a}=i;if(i.isNative)Jb.parse(n,o,i.ext,a,((r,o)=>{r?e(r):(i.content=o,s.canInvoke&&t.dispatch("progress",++s.finish,s.total,i),c_.remove(n),u_.remove(n),e())}));else{const{uuid:h}=i;if(h in r){const{finish:n,content:o,err:a,callbacks:l}=r[h];s.canInvoke&&t.dispatch("progress",++s.finish,s.total,i),n||hb(h,h,r)?(o&&o.addRef(),i.content=o,e(a)):l.push({done:e,item:i})}else if(!a.reloadAsset&&l_.has(h)){const r=l_.get(h);i.content=r.addRef(),s.canInvoke&&t.dispatch("progress",++s.finish,s.total,i),e()}else a.__uuid__=h,Jb.parse(n,o,"import",a,((i,s)=>{i?e(i):iw(t,s,e)}))}}]);function iw(t,e,i){const{input:s,progress:r}=t,{uuid:n,id:o,options:a,config:h}=s,{cacheAsset:l}=a,c=[];e.addRef&&e.addRef(),eb(n,e,Object.create(null),c,h),r.canInvoke&&t.dispatch("progress",++r.finish,r.total+=c.length,s);const u=t.options.__exclude__[n]={content:e,finish:!1,callbacks:[{done:i,item:s}]},d=y_.create({input:c,options:t.options,onProgress:t.onProgress,onError:y_.prototype.recycle,progress:r,onComplete:t=>{if(e.decRef&&e.decRef(!1),u.finish=!0,u.err=t,!t){const t=Array.isArray(d.output)?d.output:[d.output],i=Object.create(null);for(const e of t)e&&(i[e instanceof F_?`${e._uuid}@import`:`${n}@native`]=e);sb(n,e,i);try{"function"!=typeof e.onLoaded||Bf.has(e)||Pf.has(e)||(e.onLoaded(),Bf.add(e))}catch(t){j(16352,n,t.message,t.stack)}c_.remove(o),u_.remove(o),ib(n,e,l),d.recycle()}const i=u.callbacks;for(let s=0,r=i.length;s<r;s++){const r=i[s];e.addRef&&e.addRef(),r.item.content=e,r.done(t)}i.length=0}});p_.async(d)}function sw(t,e){const i=t.options,s=Object.create(null),r=Object.create(null);for(const t in i)switch(t){case"path":case"uuid":case"dir":case"scene":case"url":break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":s[t]=i[t];break;case"__exclude__":case"__outputAsArray__":r[t]=i[t];break;default:s[t]=i[t],r[t]=i[t]}t.options=r;const n=y_.create({input:t.input,options:s});let o=null;try{t.output=t.source=g_.sync(n)}catch(t){o=t;for(let t=0,e=n.output.length;t<e;t++)n.output[t].recycle()}n.recycle(),e(o)}class rw{constructor(){this.uuid="",this.overrideUuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}get id(){return this._id||(this._id=`${this.overrideUuid||this.uuid}@${this.isNative?"native":"import"}`),this._id}static create(){let t;return t=0!==rw._deadPool.length?rw._deadPool.pop():new rw,t}recycle(){rw._deadPool.length!==rw.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.overrideUuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),rw._deadPool.push(this))}}rw.MAX_DEAD_NUM=500,rw._deadPool=[];const nw=[];function ow(t){var e;const i=t.options,s=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(let n=0;n<s.length;n++){let o=s[n],a=rw.create(),h=null,l=null;if("string"==typeof o&&(o=Object.create(null),o[i.__requestType__||"uuid"]=s[n]),"object"==typeof o){St(o,i),o.preset&&St(o,m_[o.preset]);for(const t in o){switch(t){case"uuid":{var r;const t=a.uuid=x_(o.uuid);if(!o.bundle){const e=d_.find((e=>!!e.getAssetInfo(t)));o.bundle=e&&e.name}if(d_.has(o.bundle)){if(h=d_.get(o.bundle).config,l=h.getAssetInfo(t),l&&l.redirect){if(!d_.has(l.redirect))throw new Error(`Please load bundle ${l.redirect} first`);h=d_.get(l.redirect).config,l=h.getAssetInfo(t)}a.config=h,a.info=l}a.ext=o.ext||(null===(r=l)||void 0===r?void 0:r.extension)||".json";break}case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case"dir":if(d_.has(o.bundle)){d_.get(o.bundle).config.getDirWithPath(o.dir,o.type,nw);for(const t of nw)s.push({uuid:t.uuid,__isNative__:!1,ext:t.extension||".json",bundle:o.bundle});nw.length=0}a.recycle(),a=null;break;case"path":if(d_.has(o.bundle)){if(h=d_.get(o.bundle).config,l=h.getInfoWithPath(o.path,o.type),l&&l.redirect){if(!d_.has(l.redirect))throw new Error(`you need to load bundle ${l.redirect} first`);h=d_.get(l.redirect).config,l=h.getAssetInfo(l.uuid)}if(!l)throw a.recycle(),new Error(`Bundle ${o.bundle} doesn't contain ${o.path}`);a.config=h,a.uuid=l.uuid,a.info=l}a.ext=o.ext||(null===(e=l)||void 0===e?void 0:e.extension)||".json";break;case"scene":if(!o.bundle){const t=d_.find((t=>!!t.getSceneInfo(o.scene)));o.bundle=t&&t.name}if(d_.has(o.bundle)){if(h=d_.get(o.bundle).config,l=h.getSceneInfo(o.scene),l&&l.redirect){if(!d_.has(l.redirect))throw new Error(`you need to load bundle ${l.redirect} first`);h=d_.get(l.redirect).config,l=h.getAssetInfo(l.uuid)}if(!l)throw a.recycle(),new Error(`Bundle ${h.name} doesn't contain scene ${o.scene}`);a.config=h,a.uuid=l.uuid,a.info=l}break;case"__isNative__":a.isNative=o.__isNative__;break;case"url":a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||Rc(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[t]=o[t]}if(!a)break}}if(a&&(t.output.push(a),!a.uuid&&!a.url))throw new Error(`Can not parse this input:${JSON.stringify(o)}`)}return null}function aw(t){const e=t.output=t.input;for(let t=0;t<e.length;t++){const s=e[t];if(f_.has(s.uuid)){const t=f_.get(s.uuid),e=d_.find((e=>!!e.getAssetInfo(t)));if(e){var i;s.overrideUuid=t;let r=e.config,n=r.getAssetInfo(t);if(n&&n.redirect){if(!d_.has(n.redirect))throw new Error(`Please load bundle ${n.redirect} first`);r=d_.get(n.redirect).config,n=r.getAssetInfo(t)}s.config=r,s.info=n,s.ext=s.isNative?s.ext:(null===(i=n)||void 0===i?void 0:i.extension)||".json"}else G(16201,t,s.uuid)}}}function hw(t){const e=t.output=t.input;for(let t=0;t<e.length;t++){const i=e[t];if(i.url)continue;let s="",r="";const n=i.config;r=i.isNative?n&&n.nativeBase?n.base+n.nativeBase:h.assetManager.generalNativeBase:n&&n.importBase?n.base+n.importBase:h.assetManager.generalImportBase;const o=i.overrideUuid||i.uuid;let a="";i.info&&(a=i.isNative?i.info.nativeVer?`.${i.info.nativeVer}`:"":i.info.ver?`.${i.info.ver}`:""),s=".ttf"===i.ext?`${r}/${o.slice(0,2)}/${o}${a}/${i.options.__nativeName__}`:`${r}/${o.slice(0,2)}/${o}${a}${i.ext}`,i.url=s}return null}const lw="asset-missing";class cw{static get instance(){return this._instance||(this._instance=new cw),this._instance}constructor(){this.pipeline=p_.append(sw).append(tw),this.fetchPipeline=__.append(sw).append(Xb),this.transformPipeline=g_.append(ow).append(aw).append(hw),this.bundles=d_,this.assets=l_,this.assetsOverrideMap=f_,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Ff,this.force=o,this.allowImageBitmap=!1,this.utils=B_,this.downloader=Pb,this.parser=Jb,this.packManager=qb,this.cacheAsset=!0,this.cacheManager=null,this.presets=m_,this.factory=$b,this.preprocessPipe=sw,this.fetchPipe=Xb,this.loadPipe=tw,this.references=null,this._releaseManager=Kv,this._files=c_,this._parsed=u_,this._parsePipeline=null,this._projectBundles=[],this._eventTarget=new An}get files(){return this._files}getReleaseManager(){return this._releaseManager}get main(){return d_.get("main")||null}get resources(){return d_.get("resources")||null}onAssetMissing(t,e){this._eventTarget.on(lw,t,e)}offAssetMissing(t,e){this._eventTarget.off(lw,t,e)}dispatchAssetMissing(t,e,i,s){this._eventTarget.emit(lw,t,e,i,s)}init(t){void 0===t&&(t={});const e=t.server||ae.querySettings("assets","server")||"",i=t.bundleVers||ae.querySettings("assets","bundleVers")||{},s=t.remoteBundles||ae.querySettings("assets","remoteBundles")||[],r=t.downloadMaxConcurrency||ae.querySettings("assets","downloadMaxConcurrency");r&&r>0&&(this.downloader.maxConcurrency=r),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e,i,s),this.parser.init(),this.dependUtil.init();let n=t.importBase||ae.querySettings("assets","importBase")||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1));let o=t.nativeBase||ae.querySettings("assets","nativeBase")||"";o&&o.endsWith("/")&&(o=o.substr(0,o.length-1)),this.generalImportBase=n,this.generalNativeBase=o,this._projectBundles=ae.querySettings("assets","projectBundles")||[];const a=ae.querySettings("assets","assetsOverrides")||{};for(const t in a)this.assetsOverrideMap.set(t,a[t])}getBundle(t){return d_.get(t)||null}removeBundle(t){t._destroy(),d_.remove(t.name)}loadAny(t,e,i,s){const{options:r,onProgress:n,onComplete:o}=ob(e,i,s);r.preset=r.preset||"default",t=Array.isArray(t)?t.slice():t;const a=y_.create({input:t,onProgress:n,onComplete:lb(o),options:r});p_.async(a)}preloadAny(t,e,i,s){const{options:r,onProgress:n,onComplete:o}=ob(e,i,s);r.preset=r.preset||"preload",t=Array.isArray(t)?t.slice():t;const a=y_.create({input:t,onProgress:n,onComplete:lb(o),options:r});__.async(a)}loadRemote(t,e,i){const{options:s,onComplete:r}=ob(e,void 0,i);s.reloadAsset||!this.assets.has(t)?(s.__isNative__=!0,s.preset=s.preset||"remote",this.loadAny({url:t},s,null,((e,i)=>{e?(B(e.message,e.stack),r&&r(e,i)):$b.create(t,i,s.ext||Rc(t),s,((t,e)=>{r&&r(t,e)}))}))):lb(r)(null,this.assets.get(t))}loadBundle(t,e,i){const{options:s,onComplete:r}=ob(e,void 0,i),n=Lc(t);this.bundles.has(n)?lb(r)(null,this.getBundle(n)):(s.preset=s.preset||"bundle",s.ext="bundle",s.__isNative__=!0,this.loadAny({url:t},s,null,((e,i)=>{e?(B(e.message,e.stack),r&&r(e,i)):$b.create(t,i,"bundle",s,((t,e)=>{r&&r(t,e)}))})))}releaseAsset(t){Kv.tryRelease(t,!0)}releaseUnusedAssets(){l_.forEach((t=>{Kv.tryRelease(t)}))}releaseAll(){l_.forEach((t=>{Kv.tryRelease(t,!0)}))}loadWithJson(t,e,i,s){throw new Error("Only valid in Editor")}}t("AssetManager",cw),cw._instance=void 0,cw.Pipeline=h_,cw.Task=y_,cw.Cache=a_,cw.RequestItem=rw,cw.Bundle=cb,cw.BuiltinBundleName={INTERNAL:"internal",RESOURCES:"resources",MAIN:"main",START_SCENE:"start-scene"},cw.CacheManager=class{constructor(){this.cacheDir=void 0,this.cacheEnabled=void 0,this.autoClear=void 0,this.cacheInterval=void 0,this.deleteInterval=void 0,this.cachedFiles=void 0}},cw.Downloader=Ib,cw.Parser=Zb,cw.DependUtil=Of;const uw=t("assetManager",h.assetManager=cw.instance);h.AssetManager=cw;class dw{constructor(){this._resources={},this._materialsToBeCompiled=[]}init(){const t=this._resources,e=new Uint8Array(16),i=new Uint8Array(16),s=new Uint8Array(16),r=new Uint8Array(16),n=new Uint8Array(16);let o=0;for(let t=0;t<4;t++)e[o]=0,e[o+1]=0,e[o+2]=0,e[o+3]=255,i[o]=0,i[o+1]=0,i[o+2]=0,i[o+3]=0,s[o]=119,s[o+1]=119,s[o+2]=119,s[o+3]=255,r[o]=255,r[o+1]=255,r[o+2]=255,r[o+3]=255,n[o]=127,n[o+1]=127,n[o+2]=255,n[o+3]=255,o+=4;const a=new Uint8Array(1024);o=0;for(let t=0;t<256;t++)a[o]=221,a[o+1]=221,a[o+2]=221,a[o+3]=255,o+=4;o=0;for(let t=0;t<8;t++){for(let t=0;t<8;t++)a[o]=85,a[o+1]=85,a[o+2]=85,a[o+3]=255,o+=4;o+=32}o+=32;for(let t=0;t<8;t++){for(let t=0;t<8;t++)a[o]=85,a[o+1]=85,a[o+2]=85,a[o+3]=255,o+=4;o+=32}const l={width:2,height:2,_data:e,_compressed:!1,format:35},c={width:2,height:2,_data:i,_compressed:!1,format:35},u={width:2,height:2,_data:s,_compressed:!1,format:35},d={width:2,height:2,_data:r,_compressed:!1,format:35},p={width:2,height:2,_data:n,_compressed:!1,format:35},_={width:16,height:16,_data:a,_compressed:!1,format:35},g=new j_(l),f=new qf;f._uuid="black-texture",f.image=g,t[f._uuid]=f;const m=new j_(c),y=new qf;y._uuid="empty-texture",y.image=m,t[y._uuid]=y;const v=new Uv;v._uuid="black-cube-texture",v.setMipFilter(1),v.image={front:new j_(l),back:new j_(l),left:new j_(l),right:new j_(l),top:new j_(l),bottom:new j_(l)},t[v._uuid]=v;const b=new j_(u),w=new qf;w._uuid="grey-texture",w.image=b,t[w._uuid]=w;const S=new Uv;S._uuid="grey-cube-texture",S.setMipFilter(1),S.image={front:new j_(u),back:new j_(u),left:new j_(u),right:new j_(u),top:new j_(u),bottom:new j_(u)},t[S._uuid]=S;const x=new j_(d),T=new qf;T._uuid="white-texture",T.image=x,t[T._uuid]=T;const C=new Uv;C._uuid="white-cube-texture",C.setMipFilter(1),C.image={front:new j_(d),back:new j_(d),left:new j_(d),right:new j_(d),top:new j_(d),bottom:new j_(d)},t[C._uuid]=C;const I=new j_(p),E=new qf;E._uuid="normal-texture",E.image=I,t[E._uuid]=E;const D=new j_(_),A=new qf;A._uuid="default-texture",A.image=D,t[A._uuid]=A;const M=new Uv;if(M.setMipFilter(1),M._uuid="default-cube-texture",M.image={front:new j_(_),back:new j_(_),left:new j_(_),right:new j_(_),top:new j_(_),bottom:new j_(_)},t[M._uuid]=M,h.SpriteFrame){const e=new h.SpriteFrame,i=g,s=new qf;s.image=i,e.texture=s,e._uuid="default-spriteframe",t[e._uuid]=e}}addAsset(t,e){this._resources[t]=e}get(t){return this._resources[t]}loadBuiltinAssets(){const t=ae.querySettings("engine","builtinAssets");if(!t)return Promise.resolve();const e=this._resources;return new Promise(((i,s)=>{uw.loadBundle("internal",(r=>{r?s(r):uw.loadAny(t,((t,r)=>{t?s(t):(r.forEach((t=>{e[t.name]=t,Kv.addIgnoredAsset(t),t instanceof h.Material&&this._materialsToBeCompiled.push(t)})),i())}))}))}))}compileBuiltinMaterial(){for(let t=0;t<this._materialsToBeCompiled.length;++t){const e=this._materialsToBeCompiled[t];for(let t=0;t<e.passes.length;++t)e.passes[t].tryCompile()}this._materialsToBeCompiled.length=0}}t("BuiltinResMgr",dw);const pw=t("builtinResMgr",h.builtinResMgr=new dw),_w=t("getPhaseID",(()=>{const t=new Map;let e=0;return i=>"number"==typeof i?i:(t.has(i)||(t.set(i,1<<e),e++),t.get(i))})());class gw{constructor(t){this.instances=[],this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=t.device,this.pass=t}destroy(){for(let t=0;t<this.instances.length;++t){const e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0}merge(t,e,i){void 0===i&&(i=null);const s=t.instancedAttributeBlock,r=s.buffer.length;if(!r)return;const n=t.inputAssembler,o=t.descriptorSet.getTexture(ly),a=t.descriptorSet.getTexture(Sy),h=t.descriptorSet.getTexture(Iy),l=t.descriptorSet.getTexture(Ry),c=t.useReflectionProbeType;let u=i;u||(u=t.shaders[e]);const d=t.descriptorSet;for(let t=0;t<this.instances.length;++t){var p,_;const e=this.instances[t];if(!((null===(p=e.ia.indexBuffer)||void 0===p?void 0:p.objectID)!==(null===(_=n.indexBuffer)||void 0===_?void 0:_.objectID)||e.count>=1024)&&e.lightingMap.objectID===o.objectID&&e.useReflectionProbeType===c&&e.reflectionProbeCubemap.objectID===a.objectID&&e.reflectionProbePlanarMap.objectID===h.objectID&&e.reflectionProbeBlendCubemap.objectID===l.objectID&&e.stride===r){if(e.count>=e.capacity){e.capacity<<=1;const t=e.stride*e.capacity,i=e.data;e.data=new Uint8Array(t),e.data.set(i),e.vb.resize(t)}return e.shader=u,e.descriptorSet=d,e.data.set(s.buffer,e.stride*e.count++),void(this.hasPendingModels=!0)}}const g=this._device.createBuffer(new Ed(10,3,32*r,r)),f=new Uint8Array(32*r),m=n.vertexBuffers.slice(),y=n.attributes.slice(),v=n.indexBuffer;for(let t=0;t<s.attributes.length;t++){const e=s.attributes[t],i=new Wd(e.name,e.format,e.isNormalized,m.length,!0);y.push(i)}f.set(s.buffer),m.push(g);const b=new $d(y,m,v),w=this._device.createInputAssembler(b);this.instances.push({count:1,capacity:32,vb:g,data:f,ia:w,stride:r,shader:u,descriptorSet:d,lightingMap:o,reflectionProbeCubemap:a,reflectionProbePlanarMap:h,useReflectionProbeType:c,reflectionProbeBlendCubemap:l}),this.hasPendingModels=!0}uploadBuffers(t){for(let e=0;e<this.instances.length;++e){const i=this.instances[e];i.count&&(i.ia.instanceCount=i.count,t.updateBuffer(i.vb,i.data))}}clear(){for(let t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1}}t("InstancedBuffer",gw);const fw=new Ed(18,1),mw=new Dd(null),yw=new np(null);class vw{static fillPipelineInfo(t,e){void 0!==e.priority&&(t._priority=e.priority),void 0!==e.primitive&&(t._primitive=e.primitive),void 0!==e.stage&&(t._stage=e.stage),void 0!==e.dynamicStates&&(t._dynamicStates=e.dynamicStates),void 0!==e.phase&&(t._phase=_w(e.phase));const i=t._bs;if(e.blendState){const t=e.blendState,{targets:s}=t;s&&s.forEach(((t,e)=>{i.setTarget(e,t)})),void 0!==t.isA2C&&(i.isA2C=t.isA2C),void 0!==t.isIndepend&&(i.isIndepend=t.isIndepend),void 0!==t.blendColor&&(i.blendColor=t.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)}static getPassHash(t){let e="";if(h.rendering&&h.rendering.enableEffectImport){const i=h.rendering.programLib.getKey(t._phaseID,t.program,t.defines);e=`${t._phaseID.toString()},${i}`}else e=xv.getKey(t.program,t.defines);let i=`${e},${t._primitive},${t._dynamicStates}`;var s;return i+=bw(t._bs),i+=ww(t._dss),i+=`,rs,${(s=t._rs).cullMode},${s.depthBias},${s.isFrontFaceCCW}`,du(i,666)}constructor(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Hp,this._dss=new Up,this._rs=new Np,this._priority=128,this._stage=100,this._phase=_w("default"),this._passID=4294967295,this._subpassID=4294967295,this._phaseID=4294967295,this._primitive=7,this._batchingScheme=0,this._dynamicStates=0,this._instancedBuffers={},this._hash=0,this._rootBufferDirty=!1,this._root=t,this._device=e_.gfxDevice}initialize(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()}getHandle(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);let s=this._propertyHandleMap[t];return s?(i?s=Zy(s,i):e&&(s=Zy(s,Xy(s)-e)),s+e):0}getBinding(t){const e=this.getHandle(t);return e?vw.getBindingFromHandle(e):-1}setUniform(t,e){const i=vw.getBindingFromHandle(t),s=vw.getTypeFromHandle(t),r=vw.getOffsetFromHandle(t),n=this._getBlockView(s,i);tv[s](n,e,r),this._rootBufferDirty=!0}getUniform(t,e){const i=vw.getBindingFromHandle(t),s=vw.getTypeFromHandle(t),r=vw.getOffsetFromHandle(t),n=this._getBlockView(s,i);return Jy[s](n,e,r)}setUniformArray(t,e){const i=vw.getBindingFromHandle(t),s=vw.getTypeFromHandle(t),r=Cp(s)>>2,n=this._getBlockView(s,i);let o=vw.getOffsetFromHandle(t);for(let t=0;t<e.length;t++,o+=r)null!==e[t]&&tv[s](n,e[t],o);this._rootBufferDirty=!0}bindTexture(t,e,i){this._descriptorSet.bindTexture(t,e,i||0)}bindSampler(t,e,i){this._descriptorSet.bindSampler(t,e,i||0)}setDynamicState(t,e){const i=this._dynamics[t];i&&i.value===e||(i.value=e,i.dirty=!0)}overridePipelineStates(t,e){G(12102)}update(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()):j(12006)}getInstancedBuffer(t){return void 0===t&&(t=0),this._instancedBuffers[t]||(this._instancedBuffers[t]=new gw(this))}destroy(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null);for(const t in this._instancedBuffers)this._instancedBuffers[t].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy()}resetUniform(t){const e=this.getHandle(t);if(!e)return;const i=vw.getTypeFromHandle(e),s=vw.getBindingFromHandle(e),r=vw.getOffsetFromHandle(e),n=vw.getCountFromHandle(e),o=this._getBlockView(i,s),a=this._properties[t],h=a&&a.value||sv(i),l=(Cp(i)>>2)*n;for(let t=0;t+h.length<=l;t+=h.length)o.set(h,r+t);this._rootBufferDirty=!0}resetTexture(t,e){const i=this.getHandle(t);if(!i)return;const s=vw.getTypeFromHandle(i),r=vw.getBindingFromHandle(i),n=this._properties[t],o=n&&n.value;let a;a="string"==typeof o?pw.get(`${o}${rv(s)}`):o||pw.get(sv(s));const h=a&&a.getGFXTexture(),l=n&&void 0!==n.samplerHash?qp.unpackFromHash(n.samplerHash):a&&a.getSamplerInfo(),c=this._device.getSampler(l);this._descriptorSet.bindSampler(r,c,e||0),this._descriptorSet.bindTexture(r,h,e||0)}resetUBOs(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t];let i=0;for(let t=0;t<e.members.length;t++){const s=e.members[t],r=this._getBlockView(s.type,e.binding),n=this._properties[s.name],o=n&&n.value||sv(s.type),a=(Cp(s.type)>>2)*s.count;for(let t=0;t+o.length<=a;t+=o.length)r.set(o,i+t);i+=a}}this._rootBufferDirty=!0}resetTextures(){if(h.rendering){const t=this._shaderInfo.descriptors[1];for(const e of t.samplerTextures)for(let t=0;t<e.count;++t)this.resetTexture(e.name,t)}else for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++)this.resetTexture(e.name,t)}}tryCompile(){const{pipeline:t}=this._root;if(!t)return!1;if(this._syncBatchingScheme(),h.rendering&&h.rendering.enableEffectImport){const t=h.rendering.programLib,e=t.getProgramVariant(this._device,this._phaseID,this._programName,this._defines);if(!e)return G(12103,this._programName),!1;this._shader=e.shader,this._pipelineLayout=t.getPipelineLayout(this.device,this._phaseID,this._programName)}else{const e=xv.getGFXShader(this._device,this._programName,this._defines,t);if(!e)return G(12104,this._programName),!1;this._shader=e,this._pipelineLayout=xv.getTemplateInfo(this._programName).pipelineLayout}return this._hash=vw.getPassHash(this),!0}getShaderVariant(t){if(void 0===t&&(t=null),!this._shader&&!this.tryCompile())return G(12105),null;if(!t)return this._shader;const{pipeline:e}=this._root;for(let e=0;e<t.length;e++){const i=t[e];this._defines[i.name]=i.value}this._isBlend&&(this._defines.CC_IS_TRANSPARENCY_PASS=1);let i=null;if(h.rendering&&h.rendering.enableEffectImport){const t=h.rendering.programLib.getProgramVariant(this._device,this._phaseID,this._programName,this._defines);t&&(i=t.shader)}else i=xv.getGFXShader(this._device,this._programName,this._defines,e);for(let e=0;e<t.length;e++){const i=t[e];delete this._defines[i.name]}return i}get _isBlend(){let t=!1;for(const e of this.blendState.targets)e.blend&&(t=!0);return t}beginChangeStatesSilently(){}endChangeStatesSilently(){}_doInit(t,e){if(void 0===e&&(e=!1),this._priority=128,this._stage=100,h.rendering&&h.rendering.enableEffectImport){const e=h.rendering;if("number"==typeof t.phase?(this._passID=t._passID,this._subpassID=t._subpassID,this._phaseID=t._phaseID):(this._passID=e.getPassID(t.pass),this._passID!==e.INVALID_ID&&(t.subpass?(this._subpassID=e.getSubpassID(this._passID,t.subpass),this._phaseID=e.getPhaseID(this._subpassID,t.phase)):this._phaseID=e.getPhaseID(this._passID,t.phase))),this._passID===e.INVALID_ID)return void j(12107,t.program);if(this._phaseID===e.INVALID_ID)return void j(12108,t.program)}else"number"==typeof t.phase?this._passID=t._passID:t.pass&&"default"!==t.pass&&(q(4294967295===this._passID,12110),this._passID=0);this._phase=_w("default"),this._primitive=7,this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=e?{...t.defines}:t.defines,h.rendering&&h.rendering.enableEffectImport?this._shaderInfo=h.rendering.programLib.getProgramInfo(this._phaseID,this._programName):this._shaderInfo=xv.getTemplate(t.program),this._properties=t.properties||this._properties;const i=this._device;vw.fillPipelineInfo(this,t),t.stateOverrides&&vw.fillPipelineInfo(this,t.stateOverrides),h.rendering&&h.rendering.enableEffectImport?yw.layout=h.rendering.programLib.getMaterialDescriptorSetLayout(this._device,this._phaseID,t.program):yw.layout=xv.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(yw);const s=this._shaderInfo.blocks;let r,n;if(h.rendering&&h.rendering.enableEffectImport){const t=h.rendering.programLib;r=t.getBlockSizes(this._phaseID,this._programName),n=t.getHandleMap(this._phaseID,this._programName)}else{const e=xv.getTemplateInfo(t.program);r=e.blockSizes,n=e.handleMap}if(h.rendering&&h.rendering.enableEffectImport){const t=h.rendering.programLib.getShaderInfo(this._phaseID,this.program);this._buildMaterialUniformBlocks(i,t.blocks,r)}else this._buildUniformBlocks(i,s,r);const o=this._propertyHandleMap=n,a={};for(const t in this._properties){const e=this._properties[t];e.handleInfo&&(a[t]=this.getHandle.apply(this,e.handleInfo))}Object.assign(o,a)}_buildUniformBlocks(t,e,i){const s=t.capabilities.uboOffsetAlignment,r=[];let n=0,o=0;for(let t=0;t<e.length;t++){const e=i[t];r.push(o),o+=Math.ceil(e/s)*s,n=e}const a=r[r.length-1]+n;a&&(fw.size=16*Math.ceil(a/16),this._rootBuffer=t.createBuffer(fw),this._rootBlock=new ArrayBuffer(a));for(let s=0,n=0;s<e.length;s++){const{binding:o}=e[s],a=i[s];mw.buffer=this._rootBuffer,mw.offset=r[n++],mw.range=16*Math.ceil(a/16);const h=this._buffers[o]=t.createBuffer(mw);this._blocks[o]=new Float32Array(this._rootBlock,mw.offset,a/4),this._blocksInt[o]=new Int32Array(this._blocks[o].buffer,this._blocks[o].byteOffset,this._blocks[o].length),this._descriptorSet.bindBuffer(o,h)}}_buildMaterialUniformBlocks(t,e,i){const s=t.capabilities.uboOffsetAlignment,r=[];let n=0,o=0;for(let t=0;t<e.length;t++){if(1!==e[t].set)continue;const a=i[t];r.push(o),o+=Math.ceil(a/s)*s,n=a}if(0!==n){const e=r[r.length-1]+n;e&&(fw.size=16*Math.ceil(e/16),this._rootBuffer=t.createBuffer(fw),this._rootBlock=new ArrayBuffer(e))}for(let s=0,n=0;s<e.length;s++){if(1!==e[s].set)continue;const{binding:o}=e[s],a=i[s];mw.buffer=this._rootBuffer,mw.offset=r[n++],mw.range=16*Math.ceil(a/16);const h=this._buffers[o]=t.createBuffer(mw);this._blocks[o]=new Float32Array(this._rootBlock,mw.offset,a/4),this._blocksInt[o]=new Int32Array(this._blocks[o].buffer,this._blocks[o].byteOffset,this._blocks[o].length),this._descriptorSet.bindBuffer(o,h)}}_syncBatchingScheme(){this._defines.USE_INSTANCING?this._device.hasFeature(1)?this._batchingScheme=1:(this._defines.USE_INSTANCING=!1,this._batchingScheme=0):this._batchingScheme=0}_getBlockView(t,e){return t<13?this._blocksInt[e]:this._blocks[e]}_initPassFromTarget(t,e,i){this._priority=t.priority,this._stage=t.stage,this._phase=t.phase,this._phaseID=t._phaseID,this._passID=t._passID,this._batchingScheme=t.batchingScheme,this._primitive=t.primitive,this._dynamicStates=t.dynamicStates,this._bs=t.blendState,this._dss=e,this._descriptorSet=t.descriptorSet,this._rs=t.rasterizerState,this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._blocksInt=t._blocksInt,this._dynamics=t._dynamics,this._shader=t._shader,h.rendering&&h.rendering.enableEffectImport?this._pipelineLayout=h.rendering.programLib.getPipelineLayout(this.device,this._phaseID,this._programName):this._pipelineLayout=xv.getTemplateInfo(this._programName).pipelineLayout,this._hash=t._hash^i}_updatePassHash(){this._hash=vw.getPassHash(this)}get root(){return this._root}get device(){return this._device}get shaderInfo(){return this._shaderInfo}get localSetLayout(){return h.rendering&&h.rendering.enableEffectImport?h.rendering.programLib.getLocalDescriptorSetLayout(this._device,this._phaseID,this._programName):xv.getDescriptorSetLayout(this._device,this._programName,!0)}get program(){return this._programName}get properties(){return this._properties}get defines(){return this._defines}get passIndex(){return this._passIndex}get propertyIndex(){return this._propertyIndex}get dynamics(){return this._dynamics}get blocks(){return this._blocks}get blocksInt(){return this._blocksInt}get rootBufferDirty(){return this._rootBufferDirty}setRootBufferDirty(t){this._rootBufferDirty=t}get priority(){return this._priority}setPriority(t){this._priority=t}get primitive(){return this._primitive}get stage(){return this._stage}get phase(){return this._phase}get passID(){return this._passID}get phaseID(){return this._phaseID}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get dynamicStates(){return this._dynamicStates}get batchingScheme(){return this._batchingScheme}get descriptorSet(){return this._descriptorSet}get hash(){return this._hash}get pipelineLayout(){return this._pipelineLayout}}function bw(t){let e=`,bs,${t.isA2C}`;for(const i of t.targets)e+=`,bt,${i.blend},${i.blendEq},${i.blendAlphaEq},${i.blendColorMask}`,e+=`,${i.blendSrc},${i.blendDst},${i.blendSrcAlpha},${i.blendDstAlpha}`;return e}function ww(t){let e=`,dss,${t.depthTest},${t.depthWrite},${t.depthFunc}`;return e+=`,${t.stencilTestFront},${t.stencilFuncFront},${t.stencilRefFront},${t.stencilReadMaskFront}`,e+=`,${t.stencilFailOpFront},${t.stencilZFailOpFront},${t.stencilPassOpFront},${t.stencilWriteMaskFront}`,e+=`,${t.stencilTestBack},${t.stencilFuncBack},${t.stencilRefBack},${t.stencilReadMaskBack}`,e+=`,${t.stencilFailOpBack},${t.stencilZFailOpBack},${t.stencilPassOpBack},${t.stencilWriteMaskBack}`,e}vw.getTypeFromHandle=Xy,vw.getBindingFromHandle=Yy,vw.getCountFromHandle=Qy,vw.getOffsetFromHandle=Ky;class Sw{static getOrCreatePipelineState(t,e,i,s,r){const n=e.hash^s.hash^r.attributesHash^i.typedID;let o=this._PSOHashMap.get(n);if(!o){const a=e.pipelineLayout,h=new ap(r.attributes),l=new Gp(i,a,s,h,e.rasterizerState,e.depthStencilState,e.blendState,e.primitive,e.dynamicStates);o=t.createPipelineState(l),this._PSOHashMap.set(n,o)}return o}}function xw(t,e){t.x=e.x*e.x,t.y=e.y*e.y,t.z=e.z*e.z}function Tw(t){for(let e=t.length-1;e>=0;--e)if(t[e].window.swapchain)return}var Cw,Iw,Ew,Dw,Aw,Mw,Pw,Bw,Rw;t("PipelineStateManager",Sw),Sw._PSOHashMap=new Map,new wd,new _d;const Ow=new cr;let Lw=t("Material",(Cw=oa("cc.Material"),Iw=Ga(Bv),Cw((Dw=class t extends F_{static getHash(t){let e=0;for(const i of t.passes)e^=i.hash;return e}constructor(){super(),this._effectAsset=Aw&&Aw(),this._techIdx=Mw&&Mw(),this._defines=Pw&&Pw(),this._states=Bw&&Bw(),this._props=Rw&&Rw(),this._passes=[],this._hash=0}get effectAsset(){return this._effectAsset}get effectName(){return this._effectAsset?this._effectAsset.name:""}get technique(){return this._techIdx}get passes(){return this._passes}get hash(){return this._hash}get parent(){return null}get owner(){return null}initialize(t){this._passes.length?G(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(t),this._update())}reset(t){this.initialize(t)}destroy(){return this._doDestroy(),super.destroy()}recompileShaders(t,e){G(16370,this.name)}overridePipelineStates(t,e){G(16371,this.name)}onLoaded(){this._update()}resetUniforms(t){void 0===t&&(t=!0),this._props.length=this._passes.length;for(let t=0;t<this._props.length;t++)this._props[t]={};if(t)for(const t of this._passes)t.resetUBOs(),t.resetTextures()}setProperty(t,e,i){let s=!1;if(void 0===i){const i=this._passes,r=i.length;for(let n=0;n<r;n++){const r=i[n];this._uploadProperty(r,t,e)&&(this._props[r.propertyIndex][t]=e,s=!0)}}else{i>=this._passes.length&&G(16372,i);const r=this._passes[i];this._uploadProperty(r,t,e)&&(this._props[r.propertyIndex][t]=e,s=!0)}s||G(16373,t)}getProperty(t,e){if(void 0===e){const e=this._props,i=e.length;for(let s=0;s<i;s++){const i=e[s];if(t in i)return i[t]}}else{if(e>=this._passes.length)return G(16372,e),null;const i=this._props[this._passes[e].propertyIndex];if(t in i)return i[t]}return null}copy(t,e){this._techIdx=t._techIdx,this._props.length=t._props.length;for(let e=0;e<t._props.length;e++)this._props[e]={...t._props[e]};this._defines.length=t._defines.length;for(let e=0;e<t._defines.length;e++)this._defines[e]={...t._defines[e]};this._states.length=t._states.length;for(let e=0;e<t._states.length;e++)this._states[e]={...t._states[e]};this._effectAsset=t._effectAsset,e&&this._fillInfo(e),this._update()}_fillInfo(t){void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Bv.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states)}_prepareInfo(t,e){let i=t;if(!Array.isArray(i)){const t=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(t).fill(i)}for(let t=0;t<i.length;++t)Object.assign(e[t]||(e[t]={}),i[t])}_createPasses(){const t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];const e=t.passes.length,i=[];for(let s=0;s<e;++s){const e=t.passes[s],r=e.passIndex=s,n=e.defines=this._defines[r]||(this._defines[r]={});if(e.stateOverrides=this._states[r]||(this._states[r]={}),void 0!==e.propertyIndex&&Object.assign(n,this._defines[e.propertyIndex]),void 0!==e.embeddedMacros&&Object.assign(n,e.embeddedMacros),e.switch&&!n[e.switch])continue;const o=new vw(h.director.root);o.initialize(e),i.push(o)}return i}_update(e){if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();const t=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=t,e)this._passes.forEach(((t,e)=>{let i=this._props[e];i||(i=this._props[e]={}),void 0!==t.propertyIndex&&Object.assign(i,this._props[t.propertyIndex]);for(const e in i)this._uploadProperty(t,e,i[e])}));else for(let t=0;t<this._props.length;t++)this._props[t]={}}this._hash=t.getHash(this)}_uploadProperty(t,e,i){const s=t.getHandle(e);if(!s)return!1;if(vw.getTypeFromHandle(s)<26)if(Array.isArray(i))t.setUniformArray(s,i);else if(null!==i){var r;if(null!==(r=t.properties[e])&&void 0!==r&&r.linear){const t=i;xw(Ow,t),Ow.w=t.w,i=Ow}t.setUniform(s,i)}else t.resetUniform(e);else if(Array.isArray(i))for(let e=0;e<i.length;e++)this._bindTexture(t,s,i[e],e);else i?this._bindTexture(t,s,i):t.resetTexture(e);return!0}_bindTexture(t,e,i,s){const r=vw.getBindingFromHandle(e);if(i instanceof Yp)t.bindTexture(r,i,s);else if(i instanceof rg){const e=i.getGFXTexture();if(!e||!e.width||!e.height)return;t.bindTexture(r,e,s),t.bindSampler(r,i.getGFXSampler(),s)}}_doDestroy(){if(this._passes&&this._passes.length)for(const t of this._passes)t.destroy();this._passes.length=0}initDefault(t){super.initDefault(t),this.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0},technique:0}),this.setProperty("mainColor",new _r("#ff00ff"))}validate(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0}},Aw=Qo(Dw.prototype,"_effectAsset",[Iw],(function(){return null})),Mw=Qo(Dw.prototype,"_techIdx",[va],(function(){return 0})),Pw=Qo(Dw.prototype,"_defines",[va],(function(){return[]})),Bw=Qo(Dw.prototype,"_states",[va],(function(){return[]})),Rw=Qo(Dw.prototype,"_props",[va],(function(){return[]})),Ew=Dw))||Ew));h.Material=Lw;class Fw{constructor(){this.quadIB=null,this.quadVB=null,this.quadIA=null}}t("PipelineInputAssemblerData",Fw);const zw=new cr,kw=te({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),Nw=kw.LAYERED+1;class Uw{constructor(){this._fogColor=new _r("#C8C8C8"),this._colorArray=new cr(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._activated=!1}set enabled(t){this._enabled=t,t?this.activate():(this._type=Nw,this._updatePipeline())}get enabled(){return this._enabled}set accurate(t){this._accurate=t,this._updatePipeline()}get accurate(){return this._accurate}set fogColor(t){this._fogColor.set(t),zw.set(t.x,t.y,t.z,t.w),xw(this._colorArray,zw)}get fogColor(){return this._fogColor}get type(){return this._type}set type(t){this._type=this.enabled?t:Nw,this.enabled&&this._updatePipeline()}get fogDensity(){return this._fogDensity}set fogDensity(t){this._fogDensity=t}get fogStart(){return this._fogStart}set fogStart(t){this._fogStart=t}get fogEnd(){return this._fogEnd}set fogEnd(t){this._fogEnd=t}get fogAtten(){return this._fogAtten}set fogAtten(t){this._fogAtten=t}get fogTop(){return this._fogTop}set fogTop(t){this._fogTop=t}get fogRange(){return this._fogRange}set fogRange(t){this._fogRange=t}get colorArray(){return this._colorArray}initialize(t){this._activated=!1,this.fogColor=t.fogColor,this._enabled=t.enabled,this._type=this.enabled?t.type:Nw,this._accurate=t.accurate,this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange}activate(){this._updatePipeline(),this._activated=!0}_updatePipeline(){const t=h.director.root,e=this.enabled?this.type:Nw,i=this.accurate?1:0,s=t.pipeline;s.macros.CC_USE_FOG===e&&s.macros.CC_USE_ACCURATE_FOG===i||(s.macros.CC_USE_FOG=e,s.macros.CC_USE_ACCURATE_FOG=i,this._activated&&t.onGlobalPipelineStateChanged())}}h.Fog=Uw;class Vw{constructor(){this._groundAlbedoHDR=new cr(.2,.2,.2,1),this._skyColorHDR=new cr(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new cr(.2,.2,.2,1),this._skyColorLDR=new cr(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}set enabled(t){this._enabled=t}get enabled(){return this._enabled}get skyColor(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR}set skyColor(t){h.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t)}get skyIllum(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR}set skyIllum(t){h.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t}get groundAlbedo(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR}set groundAlbedo(t){h.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t)}initialize(t){this._skyColorHDR=t.skyColorHDR,this._groundAlbedoHDR.set(t.groundAlbedoHDR),this._skyIllumHDR=t.skyIllumHDR,this._skyColorLDR=t.skyColorLDR,this._groundAlbedoLDR.set(t.groundAlbedoLDR),this._skyIllumLDR=t.skyIllumLDR}}Vw.SUN_ILLUM=65e3,Vw.SKY_ILLUM=2e4,h.Ambient=Vw;class Hw extends vw{get parent(){return this._parent}constructor(t,e){super(t.root),this._dontNotify=!1,this._parent=t,this._owner=e,this._doInit(this._parent,!0);for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],i=this._blocks[e.binding],s=this._parent.blocks[e.binding];i.set(s)}this._rootBufferDirty=!0;const i=this._parent;for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++){const s=i._descriptorSet.getSampler(e.binding,t),r=i._descriptorSet.getTexture(e.binding,t);this._descriptorSet.bindSampler(e.binding,s,t),this._descriptorSet.bindTexture(e.binding,r,t)}}super.tryCompile()}overridePipelineStates(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),vw.fillPipelineInfo(this,t),vw.fillPipelineInfo(this,e),this._onStateChange()}tryCompile(t){if(t&&!nv(this._defines,t))return!1;const e=super.tryCompile();return this._onStateChange(),e}beginChangeStatesSilently(){this._dontNotify=!0}endChangeStatesSilently(){this._dontNotify=!1}_syncBatchingScheme(){this._defines.USE_INSTANCING=!1,this._batchingScheme=0}_onStateChange(){this._hash=vw.getPassHash(this),this._owner.onPassStateChange(this._dontNotify)}}class Gw extends Lw{get parent(){return this._parent}get owner(){return this._owner}constructor(t){super(),this._passes=[],this._subModelIdx=0,this._parent=t.parent,this._owner=t.owner||null,this._subModelIdx=t.subModelIdx||0,this.copy(this._parent)}recompileShaders(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(const e of this._passes)e.tryCompile(t);else this._passes[e].tryCompile(t)}overridePipelineStates(t,e){if(!this._passes||!this.effectAsset)return;const i=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(let e=0;e<this._passes.length;e++){const s=this._passes[e],r=this._states[e]||(this._states[e]={});for(const e in t)r[e]=t[e];s.overridePipelineStates(i[s.passIndex],r)}else{const s=this._states[e]||(this._states[e]={});for(const e in t)s[e]=t[e];this._passes[e].overridePipelineStates(i[e],s)}}destroy(){return this._doDestroy(),!0}onPassStateChange(t){this._hash=Lw.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}_createPasses(){const t=[],e=this._parent.passes;if(!e)return t;for(let i=0;i<e.length;++i)t.push(new Hw(e[i],this));return t}}let Ww=null,jw=null;const $w={HEMISPHERE_DIFFUSE:0,AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION:1,DIFFUSEMAP_WITH_REFLECTION:2};te($w);class qw{constructor(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1,this._editableMaterial=null,this._activated=!1,this._reflectionHDR=null,this._reflectionLDR=null,this._rotationAngle=0}get model(){return this._model}get enabled(){return this._enabled}set enabled(t){this._enabled=t,t?this.activate():this._updatePipeline()}get useHDR(){return this._useHDR}set useHDR(t){this._useHDR=t,this.setEnvMaps(this._envmapHDR,this._envmapLDR)}get useIBL(){return this._useIBL}set useIBL(t){this._useIBL=t,this._updatePipeline()}get useDiffuseMap(){return this._useDiffuseMap}set useDiffuseMap(t){this._useDiffuseMap=t,this._updatePipeline()}get isRGBE(){return!!this.envmap&&this.envmap.isRGBE}get useConvolutionMap(){return this.reflectionMap?this.reflectionMap.isUsingOfflineMipmaps():!!this.envmap&&this.envmap.isUsingOfflineMipmaps()}get envmap(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR}set envmap(t){h.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}get diffuseMap(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR}set diffuseMap(t){h.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}get reflectionMap(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR:this._reflectionLDR}get editableMaterial(){return this._editableMaterial}initialize(t){this._activated=!1,this._enabled=t.enabled,this._useIBL=t.useIBL,this._useDiffuseMap=t.applyDiffuseMap,this._useHDR=t.useHDR}setEnvMaps(t,e){this._envmapHDR=t,this._envmapLDR=e,this._updateGlobalBinding(),this._updatePipeline()}setDiffuseMaps(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()}setSkyboxMaterial(t){t?(this._editableMaterial=new Gw({parent:t}),this._editableMaterial.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE})):this._editableMaterial=null,this._updatePipeline()}setReflectionMaps(t,e){this._reflectionHDR=t,this._reflectionLDR=e,this._updateGlobalBinding(),this._updatePipeline()}setRotationAngle(t){this._rotationAngle=t}getRotationAngle(){return this._rotationAngle}updateMaterialRenderInfo(){this._updateGlobalBinding(),this._updatePipeline()}activate(){const t=h.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=pw.get("default-cube-texture"),this._model||(this._model=h.director.root.createModel(h.renderer.scene.Model));let e=this._default.isRGBE;if(this._default.isUsingOfflineMipmaps(),this.envmap&&(e=this.envmap.isRGBE,this.envmap.isUsingOfflineMipmaps()),!jw){const t=new Lw;t.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:e}}),jw=new Gw({parent:t})}this.enabled&&(Ww||(Ww=h.utils.createMesh(h.primitives.box({width:2,height:2,length:2}))),this._editableMaterial?this._model.initSubModel(0,Ww.renderingSubMeshes[0],this._editableMaterial):this._model.initSubModel(0,Ww.renderingSubMeshes[0],jw)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline(),this._activated=!0}_updatePipeline(){const t=h.director.root,e=t.pipeline,i=this.useIBL?this.isRGBE?2:1:0,s=this.useIBL&&this.useDiffuseMap&&this.diffuseMap&&this.diffuseMap!==this._default?this.isRGBE?2:1:0,r=this.useHDR,n=this.useConvolutionMap;if(e.macros.CC_USE_IBL===i&&e.macros.CC_USE_DIFFUSEMAP===s&&e.macros.CC_USE_HDR===r&&e.macros.CC_IBL_CONVOLUTED===n||(e.macros.CC_USE_IBL=i,e.macros.CC_USE_DIFFUSEMAP=s,e.macros.CC_USE_HDR=r,e.macros.CC_IBL_CONVOLUTED=n,this._activated&&t.onGlobalPipelineStateChanged()),this.enabled){const t=this.envmap?this.envmap:this._default,e=this._editableMaterial?this._editableMaterial:jw;e&&(e.setProperty("environmentMap",t),e.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE})),this._model&&(this._model.setSubModelMaterial(0,e),this._updateSubModes())}}_updateGlobalBinding(){if(this._globalDSManager){const t=e_.gfxDevice;if(this.reflectionMap){const e=this.reflectionMap.getGFXTexture(),i=t.getSampler(this.reflectionMap.getSamplerInfo());this._globalDSManager.bindSampler(5,i),this._globalDSManager.bindTexture(5,e)}else{const e=this.envmap?this.envmap:this._default;if(e){const i=e.getGFXTexture(),s=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(5,s),this._globalDSManager.bindTexture(5,i)}}const e=this.diffuseMap?this.diffuseMap:this._default;if(e){const i=e.getGFXTexture(),s=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(7,s),this._globalDSManager.bindTexture(7,i)}this._globalDSManager.update()}}_updateSubModes(){if(this._model){const t=this._model.subModels;for(let e=0;e<t.length;e++)t[e].update()}}}h.Skybox=qw;const Xw=te({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Yw=te({Planar:0,ShadowMap:1}),Qw=te({HARD:0,SOFT:1,SOFT_2X:2,SOFT_4X:3}),Kw=te({LEVEL_1:1,LEVEL_2:2,LEVEL_3:3,LEVEL_4:4}),Zw=te({NONE:1,RemoveDuplicates:2,DisableRotationFix:3}),Jw=Yw.ShadowMap+1;class tS{constructor(){this.fixedSphere=new tn(0,0,0,.01),this.maxReceived=4,this._matLight=new Rs,this._material=null,this._instancingMaterial=null,this._enabled=!1,this._type=Jw,this._distance=0,this._planeBias=1,this._normal=new Ki(0,1,0),this._shadowColor=new _r(0,0,0,76),this._size=new Qs(1024,1024),this._shadowMapDirty=!1}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.activate()}get type(){return this._type}set type(t){this._type=this.enabled?t:Jw,this.activate()}get normal(){return this._normal}set normal(t){Ki.copy(this._normal,t)}get distance(){return this._distance}set distance(t){this._distance=t}get planeBias(){return this._planeBias}set planeBias(t){this._planeBias=t}get shadowColor(){return this._shadowColor}set shadowColor(t){this._shadowColor=t}get size(){return this._size}set size(t){this._size.set(t)}get shadowMapDirty(){return this._shadowMapDirty}set shadowMapDirty(t){this._shadowMapDirty=t}get matLight(){return this._matLight}get material(){return this._material}get instancingMaterial(){return this._instancingMaterial}getPlanarShader(t){this._material||(this._material=new Lw,this._material.initialize({effectName:"pipeline/planar-shadow"}));const e=this._material.passes;return e.length>0?e[0].getShaderVariant(t):null}initialize(t){this._enabled=t.enabled,this._type=this.enabled?t.type:Jw,this.normal=t.planeDirection,this.distance=t.planeHeight,this.planeBias=t.planeBias,this.shadowColor=t.shadowColor,this.maxReceived=t.maxReceived,t.shadowMapSize!==this._size.x&&(this.size.set(t.shadowMapSize,t.shadowMapSize),this._shadowMapDirty=!0)}activate(){if(this._enabled)if(this.type===Yw.Planar)this._updatePlanarInfo();else{const t=h.director.root;t.pipeline.macros.CC_SHADOW_TYPE=2,t.onGlobalPipelineStateChanged()}else{const t=h.director.root;t.pipeline.macros.CC_SHADOW_TYPE=0,t.onGlobalPipelineStateChanged()}}_updatePlanarInfo(){this._material||(this._material=new Lw,this._material.initialize({effectName:"pipeline/planar-shadow"}));const t=h.director.root;t.pipeline.macros.CC_SHADOW_TYPE=1,t.onGlobalPipelineStateChanged()}destroy(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()}}tS.MAX_FAR=2e3,tS.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),h.Shadows=tS;class eS{constructor(){this._enabled=!1,this._minPos=new Ki(0,0,0),this._maxPos=new Ki(0,0,0),this._depth=0}set enabled(t){this._enabled=t}get enabled(){return this._enabled}get minPos(){return this._minPos}set minPos(t){this._minPos=t}get maxPos(){return this._maxPos}set maxPos(t){this._maxPos=t}get depth(){return this._depth}set depth(t){this._depth=t}initialize(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth}}var iS;const sS=new qd;sS.format=35;const rS=new Xd;rS.format=55;const nS=new Kd([sS],rS),oS={width:1,height:1,renderPassInfo:nS};let aS=t("RenderTexture",oa("cc.RenderTexture")(iS=class extends rg{constructor(){super(),this._window=null}get window(){return this._window}initialize(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)}reset(t){this.initialize(t)}destroy(){if(this._window){const t=h.director.root;null==t||t.destroyWindow(this._window),this._window=null}return super.destroy()}resize(t,e){this._width=Math.floor(fi(t,1,2048)),this._height=Math.floor(fi(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)}_serialize(t){return{}}_deserialize(t,e){const i=t;this._width=i.w,this._height=i.h,this._name=i.n,super._deserialize(i.base,e)}getGFXTexture(){return this._window&&this._window.framebuffer.colorTextures[0]}onLoaded(){this._initWindow()}_initWindow(t){const e=h.director.root;oS.title=this._name,oS.width=this._width,oS.height=this._height,oS.renderPassInfo=t&&t.passInfo?t.passInfo:nS,oS.externalResLow=t&&t.externalResLow?t.externalResLow:0,oS.externalResHigh=t&&t.externalResHigh?t.externalResHigh:0,oS.externalFlag=t&&t.externalFlag?t.externalFlag:0,oS.renderPassInfo.colorAttachments.forEach((t=>{t.format=e.device.swapchainFormat})),sS.barrier=e_.gfxDevice.getGeneralBarrier(new Jd(128,128)),this._window?(this._window.destroy(),this._window.initialize(e_.gfxDevice,oS)):this._window=e.createWindow(oS)}initDefault(t){super.initDefault(t),this._width=this._height=1,this._initWindow()}validate(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048}readPixels(t,e,i,s,r){t=t||0,e=e||0,i=i||this.width,s=s||this.height;const n=this.getGFXTexture();if(!n)return j(7606),null;const o=4*i*s;if(void 0===r)r=new Uint8Array(o);else if(r.length<o)return j(7607,o),null;const a=this._getGFXDevice(),h=[],l=[],c=new bd;return c.texOffset.x=t,c.texOffset.y=e,c.texExtent.width=i,c.texExtent.height=s,l.push(c),h.push(r),null==a||a.copyTextureToBuffers(n,h,l),r}})||iS);h.RenderTexture=aS,Gc(rg.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Hc(aS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction(){return this.window}}]);const hS={1:"Uint",2:"Int",3:"Uint",4:"Int",5:"Float",6:"Float",default:"Uint"};function lS(t){return`${hS[t.type]||hS.default}${t.size/t.count*8}`}function cS(t,e,i,s,r){void 0===i&&(i=11),void 0===s&&(s=0),void 0===r&&(r=0);const n=mp[i];r||(r=n.size);const o=`set${lS(n)}`,a=n.size/n.count,h=Math.floor(e.length/n.count),l=Hn.isLittleEndian;for(let i=0;i<h;++i){const h=s+r*i;for(let s=0;s<n.count;++s){const r=h+a*s;t[o](r,e[n.count*i+s],l)}}}function uS(t,e,i,s,r,n){void 0===e&&(e=11),void 0===i&&(i=0),void 0===s&&(s=t.byteLength-i),void 0===r&&(r=0),void 0===n&&(n=[]);const o=mp[e];r||(r=o.size);const a=`get${lS(o)}`,h=o.size/o.count,l=Math.floor(s/r),c=Hn.isLittleEndian;for(let e=0;e<l;++e){const s=i+r*e;for(let i=0;i<o.count;++i){const r=s+h*i;n[o.count*e+i]=t[a](r,c)}}return n}function dS(t,e,i,s,r,n,o){void 0===i&&(i=11),void 0===s&&(s=0),void 0===r&&(r=t.byteLength-s),void 0===n&&(n=0),o||(o=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));const a=mp[i];n||(n=a.size);const h=`set${lS(a)}`,l=`get${lS(a)}`,c=a.size/a.count,u=Math.floor(r/n),d=Hn.isLittleEndian;for(let i=0;i<u;++i){const r=s+n*i;for(let i=0;i<a.count;++i){const s=r+c*i,n=t[l](s,d);o[h](s,e(n,i,t),d)}}return o}const pS={positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Ki.ZERO,max:Ki.ZERO}};class _S{constructor(t,e,i,s,r,n){void 0===s&&(s=null),void 0===r&&(r=null),void 0===n&&(n=!0),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._drawInfo=null,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=s,this._indirectBuffer=r,this._primitiveMode=i,this._iaInfo=new $d(e,t,s,r),this._isOwnerOfIndexBuffer=n}get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get indirectBuffer(){return this._indirectBuffer}get primitiveMode(){return this._primitiveMode}get geometricInfo(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return pS;if(void 0===this.subMeshIdx)return pS;const{mesh:t}=this,e=this.subMeshIdx,i=this.attributes.find((t=>"a_position"===t.name));if(!i)return pS;let s;switch(i.format){case 21:case 32:if(s=t.readAttribute(e,"a_position"),!s)return pS;break;case 44:{const i=t.readAttribute(e,"a_position");if(!i)return pS;const r=i.length/4;s=new Float32Array(3*r);for(let t=0;t<r;++t){const e=3*t,r=4*t;s[e]=i[r],s[e+1]=i[r+1],s[e+2]=i[r+2]}break}case 18:case 29:{const i=t.readAttribute(e,"a_position");if(!i)return pS;s=new Float32Array(i.length);for(let t=0;t<i.length;++t)s[t]=ki(i[t]);break}case 41:{const i=t.readAttribute(e,"a_position");if(!i)return pS;const r=i.length/4;s=new Float32Array(3*r);for(let t=0;t<r;++t){const e=3*t,r=4*t;s[e]=ki(i[r]),s[e+1]=ki(i[r+1]),s[e+2]=ki(i[r+2])}break}default:return pS}const r=t.readIndices(e)||void 0,n=new Ki,o=new Ki,a=mp[i.format].count;2===a?(n.set(s[0],s[1],0),o.set(s[0],s[1],0)):(n.set(s[0],s[1],s[2]),o.set(s[0],s[1],s[2]));for(let t=0;t<s.length;t+=a)2===a?(n.x=s[t]>n.x?s[t]:n.x,n.y=s[t+1]>n.y?s[t+1]:n.y,o.x=s[t]<o.x?s[t]:o.x,o.y=s[t+1]<o.y?s[t+1]:o.y):(n.x=s[t]>n.x?s[t]:n.x,n.y=s[t+1]>n.y?s[t+1]:n.y,n.z=s[t+2]>n.z?s[t+2]:n.z,o.x=s[t]<o.x?s[t]:o.x,o.y=s[t+1]<o.y?s[t+1]:o.y,o.z=s[t+2]<o.z?s[t+2]:o.z);return this._geometricInfo={positions:s,indices:r,boundingBox:{max:n,min:o}},this._geometricInfo}invalidateGeometricInfo(){this._geometricInfo=void 0}set drawInfo(t){this._drawInfo=t}get drawInfo(){return this._drawInfo}get flatBuffers(){return this._flatBuffers}genFlatBuffers(){if(this._flatBuffers.length||!this.mesh||void 0===this.subMeshIdx)return;const{mesh:t}=this;let e=0;const i=t.struct.primitives[this.subMeshIdx];i.indexView&&(e=i.indexView.count);for(let s=0;s<i.vertexBundelIndices.length;s++){const r=i.vertexBundelIndices[s],n=t.struct.vertexBundles[r],o=i.indexView?i.indexView.count:n.view.count,a=n.view.stride,h=a*o,l=new Uint8Array(t.data.buffer,n.view.offset,n.view.length),c=new Uint8Array(i.indexView?h:n.view.length);if(!i.indexView){c.set(t.data.subarray(n.view.offset,n.view.offset+n.view.length)),this._flatBuffers.push({stride:a,count:o,buffer:c});continue}const u=t.readIndices(this.subMeshIdx);for(let t=0;t<e;++t){const e=t*a,i=u[t]*a;for(let t=0;t<a;++t)c[e+t]=l[i+t]}this._flatBuffers.push({stride:a,count:o,buffer:c})}}get jointMappedBuffers(){if(this._jointMappedBuffers)return this._jointMappedBuffers;const t=this._jointMappedBuffers=[],e=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;const{struct:i}=this.mesh,s=i.primitives[this.subMeshIdx];if(!i.jointMaps||void 0===s.jointMapIndex||!i.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;let r,n;const{device:o}=h.director.root;for(let a=0;a<s.vertexBundelIndices.length;a++){const h=i.vertexBundles[s.vertexBundelIndices[a]];n=0,r=0;for(let t=0;t<h.attributes.length;t++){const e=h.attributes[t];if("a_joints"===e.name){r=e.format;break}n+=mp[e.format].size}if(r){const l=new Uint8Array(this.mesh.data.buffer,h.view.offset,h.view.length),c=new DataView(l.slice().buffer),u=i.jointMaps[s.jointMapIndex];dS(c,(t=>u.indexOf(t)),r,n,h.view.length,h.view.stride,c);const d=o.createBuffer(new Ed(10,1,h.view.length,h.view.stride));d.update(c.buffer),t.push(d),e.push(a)}else t.push(this.vertexBuffers[s.vertexBundelIndices[a]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(o)),t}get iaInfo(){return this._iaInfo}destroy(){for(let t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._isOwnerOfIndexBuffer&&this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(let t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)}enableVertexIdChannel(t){if(this._vertexIdChannel)return;const e=this.vertexBuffers.length,i=this.attributes.length,s=this._allocVertexIdBuffer(t);this._vertexBuffers.push(s),this._attributes.push(new Wd("a_vertexId",11,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:i}}_allocVertexIdBuffer(t){const e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(e);for(let t=0;t<e;++t)i[t]=t+.5;const s=t.createBuffer(new Ed(10,1,i.byteLength,i.BYTES_PER_ELEMENT));return s.update(i),s}}t("RenderingSubMesh",_S);class gS{get uiTransformComp(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp}set uiTransformComp(t){this._uiTransformComp=t}get uiComp(){return this._uiComp}set uiComp(t){this._uiComp&&t?G(12002):this._uiComp=t}setOpacity(t){this._opacity=t}get opacity(){return this._opacity}get localOpacity(){return this._localOpacity}set localOpacity(t){this._localOpacity=t,this.colorDirty=!0}constructor(t){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=t}applyOpacity(t){this._opacity=this._localOpacity*t}static markOpacityTree(t,e){}}yn.Flags.Destroying,l.GAME_VIEW;const fS=t("NodeSpace",{LOCAL:0,WORLD:1}),mS=t("TransformBit",{NONE:0,POSITION:1,ROTATION:2,SCALE:4,RS:6,TRS:7,TRS_MASK:-8});l.internal.TransformBit=mS;const yS=t("MobilityMode",te({Static:0,Stationary:1,Movable:2})),vS=t("NodeEventType",{TOUCH_START:"touch-start",TOUCH_MOVE:"touch-move",TOUCH_END:"touch-end",TOUCH_CANCEL:"touch-cancel",MOUSE_DOWN:"mouse-down",MOUSE_MOVE:"mouse-move",MOUSE_UP:"mouse-up",MOUSE_WHEEL:"mouse-wheel",MOUSE_ENTER:"mouse-enter",MOUSE_LEAVE:"mouse-leave",KEY_DOWN:"keydown",KEY_UP:"keyup",DEVICEMOTION:"devicemotion",TRANSFORM_CHANGED:"transform-changed",MOBILITY_CHANGED:"mobility-changed",SCENE_CHANGED_FOR_PERSISTS:"scene-changed-for-persists",SIZE_CHANGED:"size-changed",ANCHOR_CHANGED:"anchor-changed",COLOR_CHANGED:"color-changed",CHILD_ADDED:"child-added",CHILD_REMOVED:"child-removed",PARENT_CHANGED:"parent-changed",NODE_DESTROYED:"node-destroyed",LAYER_CHANGED:"layer-changed",SIBLING_ORDER_CHANGED:"sibling-order-changed",CHILDREN_ORDER_CHANGED:"sibling-order-changed",ACTIVE_IN_HIERARCHY_CHANGED:"active-in-hierarchy-changed",COMPONENT_ADDED:"component-added",COMPONENT_REMOVED:"component-removed",LIGHT_PROBE_CHANGED:"light-probe-changed",LIGHT_PROBE_BAKING_CHANGED:"light-probe-baking-changed",ACTIVE_CHANGED:"active-changed"});var bS,wS,SS,xS,TS,CS,IS,ES,DS,AS,MS,PS,BS,RS,OS,LS,FS;const zS=yn.Flags.Destroying,kS=yn.Flags.DontDestroy,NS=yn.Flags.Deactivating,US=new tt("Node");function VS(t){return t?"string"==typeof t?kt(t):t:(j(3804),null)}const HS=Zi(),GS=Zi(),WS=Ts(),jS=Ts(),$S=Ts(),qS=new ss,XS=Fs(),YS=Fs(),QS=[],KS=Symbol("ReserveContentsForAllSyncablePrefab");let ZS=0,JS=(bS=oa("cc.Node"),wS=Ga(Ki),SS=Ga(yS),bS((FS=class t extends yn{get components(){return this._components}get _persistNode(){return(this._objFlags&kS)>0}set _persistNode(t){t?this._objFlags|=kS:this._objFlags&=~kS}get name(){return this._name}set name(t){this._name=t}get uuid(){return this._id}get children(){return this._children}get active(){return this._active}set active(t){if(t=!!t,this._active!==t){this._active=t;const e=this._parent;e&&e._activeInHierarchy&&l.director._nodeActivator.activateNode(this,t)}}_setActiveInHierarchy(t){this._activeInHierarchy=t}get activeInHierarchy(){return this._activeInHierarchy}get parent(){return this._parent}set parent(t){this.setParent(t)}get scene(){return this._scene}get eventProcessor(){return this._eventProcessor}static _setScene(t){t._updateScene()}static _findComponent(t,e){const i=e,s=t._components;if(i._sealed)for(let t=0;t<s.length;++t){const i=s[t];if(i.constructor===e)return i}else for(let t=0;t<s.length;++t){const i=s[t];if(i instanceof e)return i}return null}static _findComponents(t,e,i){const s=e,r=t._components;if(s._sealed)for(let t=0;t<r.length;++t){const s=r[t];s.constructor===e&&i.push(s)}else for(let t=0;t<r.length;++t){const s=r[t];s instanceof e&&i.push(s)}}static _findChildComponent(e,i){for(let s=0;s<e.length;++s){const r=e[s];let n=t._findComponent(r,i);if(n)return n;if(r._children.length>0&&(n=t._findChildComponent(r._children,i),n))return n}return null}static _findChildComponents(e,i,s){for(let r=0;r<e.length;++r){const n=e[r];t._findComponents(n,i,s),n._children.length>0&&t._findChildComponents(n._children,i,s)}}getWritableComponents(){return this._components}get prefab(){return this._prefab}set id(t){this._id=t}get siblingIndex(){return this._siblingIndex}set siblingIndex(t){this._siblingIndex=t}_updateScene(){null==this._parent?j(1640,this.name,this.uuid):this._scene=this._parent._scene}attr(t){xt(this,t)}getParent(){return this._parent}modifyParent(t){this._parent=t}setParent(t,e){if(void 0===e&&(e=!1),e&&this.updateWorldTransform(),this._parent===t)return;const i=this._parent,s=t;if(this._parent=s,this._siblingIndex=0,this._onSetParent(i,e),this.emit&&this.emit("parent-changed",i),i&&!(i._objFlags&zS)){const t=i._children.indexOf(this);i._children.splice(t,1),i._updateSiblingIndex(),i.emit&&i.emit("child-removed",this)}s&&(s._children.push(this),this._siblingIndex=s._children.length-1,s.emit&&s.emit("child-added",this)),this._onHierarchyChanged(i)}getChildByUuid(t){if(!t)return M("Invalid uuid"),null;const e=this._children;for(let i=0,s=e.length;i<s;i++)if(e[i]._id===t)return e[i];return null}getChildByName(t){if(!t)return M("Invalid name"),null;const e=this._children;for(let i=0,s=e.length;i<s;i++)if(e[i]._name===t)return e[i];return null}getChildByPath(t){const e=t.split("/");let i=this;for(let t=0;t<e.length;++t){const s=e[t];if(0===s.length)continue;const r=i.children.find((t=>t.name===s));if(!r)return null;i=r}return i}addChild(t){t.setParent(this)}insertChild(t,e){t.setParent(this),t.setSiblingIndex(e)}getSiblingIndex(){return this._siblingIndex}setSiblingIndex(t){if(!this._parent)return;if(this._parent._objFlags&NS)return void j(3821);const e=this._parent._children;t=t>=0?t:e.length+t;const i=e.indexOf(this);t!==i&&(e.splice(i,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t),this._eventProcessor.onUpdatingSiblingIndex())}walk(e,i){let s=1,r=null,n=null,o=0,a=t._stacks[t._stackId];a||(a=[],t._stacks.push(a)),t._stackId++,a.length=0,a[0]=this;let h=null,l=!1;for(;s;)if(s--,n=a[s],n)if(!l&&e?e(n):l&&i&&i(n),a[s]=null,l){if(h===this._parent)break;if(l=!1,r)if(o++,r[o])a[s]=r[o],s++;else if(h&&(a[s]=h,s++,l=!0,h._parent?(r=h._parent._children,o=r.indexOf(h),h=h._parent):(h=null,r=null),o<0))break}else n._children.length>0?(h=n,r=n._children,o=0,a[s]=r[o],s++):(a[s]=n,s++,l=!0);a.length=0,t._stackId--}removeFromParent(){this._parent&&this._parent.removeChild(this)}removeChild(t){this._children.indexOf(t)>-1&&(t.parent=null)}removeAllChildren(){const t=this._children;for(let e=t.length-1;e>=0;e--){const i=t[e];i&&(i.parent=null)}this._children.length=0}isChildOf(t){let e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1}getComponent(e){const i=VS(e);return i?t._findComponent(this,i):null}getComponents(e){const i=VS(e),s=[];return i&&t._findComponents(this,i,s),s}getComponentInChildren(e){const i=VS(e);return i?t._findChildComponent(this._children,i):null}getComponentsInChildren(e){const i=VS(e),s=[];return i&&(t._findComponents(this,i,s),t._findChildComponents(this._children,i,s)),s}addComponent(t){let e;if("string"==typeof t){if(e=kt(t),!e)throw l._RF.peek()&&j(3808,t),TypeError(Y(3807,t))}else{if(!t)throw TypeError(Y(3804));e=t}if("function"!=typeof e)throw TypeError(Y(3809));if(!It(e,l.Component))throw TypeError(Y(3810));const i=e._requireComponent;if(i)if(Array.isArray(i))for(let t=0;t<i.length;t++){const e=i[t];this.getComponent(e)||this.addComponent(e)}else{const t=i;this.getComponent(t)||this.addComponent(t)}const s=new e;return s.node=this,this._components.push(s),this.emit("component-added",s),this._activeInHierarchy&&l.director._nodeActivator.activateComp(s),s}removeComponent(t){if(!t)return void j(3813);let e=null;e=t instanceof Ag?t:this.getComponent(t),e&&e.destroy()}on(t,e,i,s){switch(void 0===s&&(s=!1),t){case"transform-changed":this._eventMask|=1;break;case"active-changed":this._eventMask|=2}this._eventProcessor.on(t,e,i,s)}off(t,e,i,s){if(void 0===s&&(s=!1),this._eventProcessor.off(t,e,i,s),!this._eventProcessor.hasEventListener(t))switch(t){case"transform-changed":this._eventMask&=-2;break;case"active-changed":this._eventMask&=-3}}once(t,e,i,s){this._eventProcessor.once(t,e,i,s)}emit(t,e,i,s,r,n){this._eventProcessor.emit(t,e,i,s,r,n)}dispatchEvent(t){this._eventProcessor.dispatchEvent(t)}hasEventListener(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)}targetOff(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener("transform-changed")&&(this._eventMask&=-2),2&this._eventMask&&!this._eventProcessor.hasEventListener("active-changed")&&(this._eventMask&=-3)}destroy(){return!!super.destroy()&&(this.active=!1,!0)}destroyAllChildren(){const t=this._children;for(let e=0;e<t.length;++e)t[e].destroy()}_removeComponent(t){if(t){if(!(this._objFlags&zS)){const e=this._components.indexOf(t);-1!==e?(this._components.splice(e,1),this.emit("component-removed",t)):t.node!==this&&j(3815)}}else j(3814)}_updateSiblingIndex(){for(let t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit("sibling-order-changed")}_instantiate(t,e){return void 0===e&&(e=!1),t||(t=l.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t}_onHierarchyChangedBase(t){const e=this._parent;!this._persistNode||e instanceof l.Scene||l.game.removePersistRootNode(this);const i=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==i&&l.director._nodeActivator.activateNode(this,i)}_onPreDestroyBase(){this._objFlags|=zS;const t=this._parent,e=!!t&&!!(t._objFlags&zS);if(this._persistNode&&l.game.removePersistRootNode(this),!e&&t){this.emit("parent-changed",this);const e=t._children.indexOf(this);t._children.splice(e,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit("child-removed",this)}this.emit("node-destroyed",this),this._eventProcessor.destroy();const i=this._children;for(let t=0;t<i.length;++t)i[t]._destroyImmediate();const s=this._components;for(let t=0;t<s.length;++t)s[t]._destroyImmediate();return e}constructor(t){void 0===t&&(t="New Node"),super(t),this._parent=CS&&CS(),this._children=IS&&IS(),this._active=ES&&ES(),this._components=DS&&DS(),this._prefab=AS&&AS(),this._scene=null,this._activeInHierarchy=!1,this._id=US.getNewId(),this._eventProcessor=new l.NodeEventProcessor(this),this._eventMask=0,this._siblingIndex=0,this._originalSceneId="",this._uiProps=new gS(this),this._static=!1,this._lpos=MS&&MS(),this._lrot=PS&&PS(),this._lscale=BS&&BS(),this._mobility=RS&&RS(),this._layer=OS&&OS(),this._euler=LS&&LS(),this._transformFlags=7,this._eulerDirty=!1,this._flagChangeVersion=0,this._hasChangedFlags=0,this._pos=new Ki,this._rot=new ys,this._scale=new Ki(1,1,1),this._mat=new Rs}static isNode(e){return e instanceof t&&(e.constructor===t||!(e instanceof l.Scene))}_onPreDestroy(){return this._onPreDestroyBase()}get position(){return this._lpos}set position(t){this.setPosition(t)}get worldPosition(){return this.updateWorldTransform(),this._pos}set worldPosition(t){this.setWorldPosition(t)}get rotation(){return this._lrot}set rotation(t){this.setRotation(t)}set eulerAngles(t){this.setRotationFromEuler(t.x,t.y,t.z)}get eulerAngles(){return this._eulerDirty&&(ys.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}get angle(){return this.eulerAngles.z}set angle(t){Ki.set(this._euler,0,0,t),ys.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(2),1&this._eventMask&&this.emit("transform-changed",2)}get worldRotation(){return this.updateWorldTransform(),this._rot}set worldRotation(t){this.setWorldRotation(t)}get scale(){return this._lscale}set scale(t){this.setScale(t)}get worldScale(){return this.updateWorldTransform(),this._scale}set worldScale(t){this.setWorldScale(t)}set matrix(t){Rs.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(7),this._eulerDirty=!0,1&this._eventMask&&this.emit("transform-changed",7)}get worldMatrix(){return this.updateWorldTransform(),this._mat}get forward(){return Ki.transformQuat(new Ki,Ki.FORWARD,this.worldRotation)}set forward(t){const e=t.length();Ki.multiplyScalar(HS,t,-1/e),ys.fromViewUp(WS,HS),this.setWorldRotation(WS)}get up(){return Ki.transformQuat(new Ki,Ki.UP,this.worldRotation)}get right(){return Ki.transformQuat(new Ki,Ki.RIGHT,this.worldRotation)}set mobility(t){this._mobility!==t&&(this._mobility=t,this.emit("mobility-changed"))}get mobility(){return this._mobility}set layer(t){this._layer!==t&&(this._layer=t,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit("layer-changed",this._layer))}get layer(){return this._layer}get flagChangedVersion(){return this._flagChangeVersion}get hasChangedFlags(){return this._flagChangeVersion===ZS?this._hasChangedFlags:0}set hasChangedFlags(t){this._flagChangeVersion=ZS,this._hasChangedFlags=t}[rh](t,e){t.writeThis()}_onSetParent(e,i){if(void 0===i&&(i=!1),this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(t._setScene)),i){const t=this._parent;t?(t.updateWorldTransform(),gi(Rs.determinant(t._mat),0,pi)?(G(14300),this._transformFlags|=7,this.updateWorldTransform()):(Rs.multiply(XS,Rs.invert(XS,t._mat),this._mat),Rs.toRTS(XS,this._lrot,this._lpos,this._lscale))):(Ki.copy(this._lpos,this._pos),ys.copy(this._lrot,this._rot),Ki.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(7)}_onHierarchyChanged(t){this.eventProcessor.reattach(),this._onHierarchyChangedBase(t)}_onBatchCreated(t){2&this._eventMask&&(this._activeInHierarchy||this.emit("active-changed",this,!1)),this.hasChangedFlags=7;const e=this._children.length;for(let i=0;i<e;++i)this._children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)}_onBeforeSerialize(){this.eulerAngles}_onPostActivated(t){2&this._eventMask&&this.emit("active-changed",this,t),this._eventProcessor.setEnabled(t),t&&(this.invalidateChildren(7),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData()))}translate(t,e){const i=e||0;if(0===i)Ki.transformQuat(HS,t,this._lrot),this._lpos.x+=HS.x,this._lpos.y+=HS.y,this._lpos.z+=HS.z;else if(1===i)if(this._parent){ys.invert(WS,this._parent.worldRotation),Ki.transformQuat(HS,t,WS);const e=this.worldScale;this._lpos.x+=HS.x/e.x,this._lpos.y+=HS.y/e.y,this._lpos.z+=HS.z/e.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(1),1&this._eventMask&&this.emit("transform-changed",1)}rotate(t,e){const i=e||0;if(ys.normalize(WS,t),0===i)ys.multiply(this._lrot,this._lrot,WS);else if(1===i){const t=this.worldRotation;ys.multiply(jS,WS,t),ys.invert(WS,t),ys.multiply(jS,WS,jS),ys.multiply(this._lrot,this._lrot,jS)}this._eulerDirty=!0,this.invalidateChildren(2),1&this._eventMask&&this.emit("transform-changed",2)}lookAt(t,e){this.getWorldPosition(HS),Ki.subtract(HS,HS,t),Ki.normalize(HS,HS),ys.fromViewUp(WS,HS,e),this.setWorldRotation(WS)}invalidateChildren(t){let e,i,s=0,r=0,n=0,o=0;const a=1|t;for(QS[0]=this;s>=0;){if(e=QS[s--],o=e.hasChangedFlags,e.isValid&&(e._transformFlags&o&t)!==t)for(e._transformFlags|=t,e.hasChangedFlags=o|t,i=e._children,n=i.length,r=0;r<n;r++)QS[++s]=i[r];t=a}}updateWorldTransform(){if(!this._transformFlags)return;let t,e=this,i=0;for(;e&&e._transformFlags;)QS[i++]=e,e=e._parent;let s=0;for(;i;){if(t=QS[--i],s|=t._transformFlags,e){if(1&s&&(Ki.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),6&s){Rs.fromSRT(t._mat,t._lrot,t._lpos,t._lscale),Rs.multiply(t._mat,e._mat,t._mat);const i=2&s?t._rot:null;Rs.toSRT(t._mat,i,null,t._scale)}}else 1&s&&(Ki.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),6&s&&(2&s&&ys.copy(t._rot,t._lrot),4&s&&Ki.copy(t._scale,t._lscale),Rs.fromRTS(t._mat,t._rot,t._pos,t._scale));t._transformFlags=0,e=t}}setPosition(t,e,i){const s=this._lpos;void 0===e?Ki.copy(s,t):(void 0===i&&(i=s.z),Ki.set(s,t,e,i)),this.invalidateChildren(1),1&this._eventMask&&this.emit("transform-changed",1)}getPosition(t){return t?Ki.set(t,this._lpos.x,this._lpos.y,this._lpos.z):Ki.copy(new Ki,this._lpos)}setRotation(t,e,i,s){void 0===e?ys.copy(this._lrot,t):ys.set(this._lrot,t,e,i,s),this._eulerDirty=!0,this.invalidateChildren(2),1&this._eventMask&&this.emit("transform-changed",2)}setRotationFromEuler(t,e,i){if(void 0===e)Ki.copy(this._euler,t),ys.fromEuler(this._lrot,t.x,t.y,t.z);else{const s=void 0===i?this._euler.z:i;Ki.set(this._euler,t,e,s),ys.fromEuler(this._lrot,t,e,s)}this._eulerDirty=!1,this.invalidateChildren(2),1&this._eventMask&&this.emit("transform-changed",2)}getRotation(t){return t?ys.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):ys.copy(new ys,this._lrot)}setScale(t,e,i){const s=this._lscale;void 0===e?Ki.copy(s,t):(void 0===i&&(i=s.z),Ki.set(s,t,e,i)),this.invalidateChildren(4),1&this._eventMask&&this.emit("transform-changed",4)}getScale(t){return t?Ki.set(t,this._lscale.x,this._lscale.y,this._lscale.z):Ki.copy(new Ki,this._lscale)}inverseTransformPoint(t,e){Ki.copy(t,e);let i=this,s=0;for(;i._parent;)QS[s++]=i,i=i._parent;for(;s>=0;)Ki.transformInverseRTS(t,t,i._lrot,i._lpos,i._lscale),i=QS[--s];return t}setWorldPosition(t,e,i){const s=this._pos;void 0===e?Ki.copy(s,t):Ki.set(s,t,e,i);const r=this._parent,n=this._lpos;r?(r.updateWorldTransform(),Ki.transformMat4(n,s,Rs.invert(XS,r._mat))):Ki.copy(n,s),this.invalidateChildren(1),1&this._eventMask&&this.emit("transform-changed",1)}getWorldPosition(t){return this.updateWorldTransform(),t?Ki.copy(t,this._pos):Ki.copy(new Ki,this._pos)}setWorldRotation(t,e,i,s){const r=this._rot;void 0===e?ys.copy(r,t):ys.set(r,t,e,i,s),this._parent?(this._parent.updateWorldTransform(),ys.multiply(this._lrot,ys.conjugate(this._lrot,this._parent._rot),r)):ys.copy(this._lrot,r),this._eulerDirty=!0,this.invalidateChildren(2),1&this._eventMask&&this.emit("transform-changed",2)}setWorldRotationFromEuler(t,e,i){ys.fromEuler(WS,t,e,i),this.setWorldRotation(WS)}getWorldRotation(t){return this.updateWorldTransform(),t?ys.copy(t,this._rot):ys.copy(new ys,this._rot)}setWorldScale(t,e,i){const s=this._parent;s&&this.updateWorldTransform();const r=this._scale;void 0===e?Ki.copy(r,t):Ki.set(r,t,e,i);let n=0;if(s){const t=Ki.set(GS,this._mat.m00,this._mat.m01,this._mat.m02).length(),e=Ki.set(GS,this._mat.m04,this._mat.m05,this._mat.m06).length(),i=Ki.set(GS,this._mat.m08,this._mat.m09,this._mat.m10).length();0===t?(HS.x=r.x,this._mat.m00=1,n=2):HS.x=r.x/t,0===e?(HS.y=r.y,this._mat.m05=1,n=2):HS.y=r.y/e,0===i?(HS.z=r.z,this._mat.m10=1,n=2):HS.z=r.z/i,Rs.scale(XS,this._mat,HS),Rs.multiply(YS,Rs.invert(YS,s._mat),XS),ss.fromQuat(qS,ys.conjugate($S,this._lrot)),ss.multiplyMat4(qS,qS,YS);const o=this._lscale;o.x=Ki.set(HS,qS.m00,qS.m01,qS.m02).length(),o.y=Ki.set(HS,qS.m03,qS.m04,qS.m05).length(),o.z=Ki.set(HS,qS.m06,qS.m07,qS.m08).length(),0!==o.x&&0!==o.y&&0!==o.z||(n=2)}else Ki.copy(this._lscale,r);this.invalidateChildren(4|n),1&this._eventMask&&this.emit("transform-changed",4|n)}getWorldScale(t){return this.updateWorldTransform(),t?Ki.copy(t,this._scale):Ki.copy(new Ki,this._scale)}getWorldMatrix(t){this.updateWorldTransform();const e=t||new Rs;return Rs.copy(e,this._mat)}getWorldRS(t){this.updateWorldTransform();const e=t||new Rs;return Rs.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}getWorldRT(t){this.updateWorldTransform();const e=t||new Rs;return Rs.fromRT(e,this._rot,this._pos)}setRTS(t,e,i){let s=0;t&&(s|=2,void 0!==t.w?(ys.copy(this._lrot,t),this._eulerDirty=!0):(Ki.copy(this._euler,t),ys.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(Ki.copy(this._lpos,e),s|=1),i&&(Ki.copy(this._lscale,i),s|=4),s&&(this.invalidateChildren(s),1&this._eventMask&&this.emit("transform-changed",s))}isTransformDirty(){return 0!==this._transformFlags}pauseSystemEvents(t){this._eventProcessor.setEnabled(!1,t)}resumeSystemEvents(t){this._eventProcessor.setEnabled(!0,t)}static resetHasChangedFlags(){ZS+=1}static clearNodeArray(){t.ClearFrame<t.ClearRound?t.ClearFrame++:(t.ClearFrame=0,QS.length=0)}getPathInHierarchy(){let t=this.name,e=this.parent;for(;e&&!(e instanceof l.Scene);)t=`${e.name}/${t}`,e=e.parent;return t}},FS.idGenerator=US,FS._stacks=[[]],FS._stackId=0,FS.EventType=vS,FS.NodeSpace=fS,FS.TransformDirtyBit=mS,FS.TransformBit=mS,FS.reserveContentsForAllSyncablePrefabTag=KS,FS.ClearFrame=0,FS.ClearRound=1e3,s((TS=FS).prototype,"_persistNode",[ca],Object.getOwnPropertyDescriptor(TS.prototype,"_persistNode"),TS.prototype),CS=Qo(TS.prototype,"_parent",[va],(function(){return null})),IS=Qo(TS.prototype,"_children",[va],(function(){return[]})),ES=Qo(TS.prototype,"_active",[va],(function(){return!0})),DS=Qo(TS.prototype,"_components",[va],(function(){return[]})),AS=Qo(TS.prototype,"_prefab",[va],(function(){return null})),MS=Qo(TS.prototype,"_lpos",[va],(function(){return new Ki})),PS=Qo(TS.prototype,"_lrot",[va],(function(){return new ys})),BS=Qo(TS.prototype,"_lscale",[va],(function(){return new Ki(1,1,1)})),RS=Qo(TS.prototype,"_mobility",[va],(function(){return yS.Static})),OS=Qo(TS.prototype,"_layer",[va],(function(){return Kf.Enum.DEFAULT})),LS=Qo(TS.prototype,"_euler",[va],(function(){return new Ki})),s(TS.prototype,"eulerAngles",[wS],Object.getOwnPropertyDescriptor(TS.prototype,"eulerAngles"),TS.prototype),s(TS.prototype,"mobility",[SS],Object.getOwnPropertyDescriptor(TS.prototype,"mobility"),TS.prototype),xS=TS))||xS);t({Node:JS,BaseNode:JS}),l.Node=JS;const tx=te({DEFAULT:0,LINEAR:1});class ex{constructor(){this._toneMappingType=tx.DEFAULT,this._activated=!1}set toneMappingType(t){this._toneMappingType=t,this._updatePipeline()}get toneMappingType(){return this._toneMappingType}initialize(t){this._toneMappingType=t.toneMappingType}activate(){this._updatePipeline(),this._activated=!0}_updatePipeline(){const t=h.director.root;t.pipeline.macros.CC_TONE_MAPPING_TYPE=this._toneMappingType,this._activated&&t.onGlobalPipelineStateChanged()}}var ix,sx,rx,nx,ox,ax,hx,lx,cx,ux,dx,px,_x,gx,fx,mx,yx,vx,bx,wx,Sx,xx,Tx,Cx,Ix,Ex,Dx,Ax,Mx,Px,Bx,Rx,Ox,Lx,Fx,zx,kx,Nx,Ux,Vx,Hx,Gx,Wx,jx,$x,qx,Xx,Yx,Qx,Kx,Zx,Jx,tT,eT,iT,sT,rT,nT,oT,aT,hT,lT,cT,uT,dT,pT,_T,gT,fT,mT,yT,vT,bT,wT,ST,xT,TT,CT,IT,ET,DT,AT,MT,PT,BT,RT,OT,LT,FT,zT,kT,NT,UT,VT,HT,GT,WT,jT,$T,qT,XT,YT,QT,KT,ZT,JT,tC,eC,iC,sC,rC,nC,oC,aC,hC,lC,cC,uC,dC,pC,_C,gC,fC,mC,yC,vC,bC,wC,SC,xC;const TC=new Ki(0,1,0),CC=new Ki,IC=new cr,EC=new _r,DC=new ys,AC=t=>{const e=1/Math.max(Math.max(Math.max(t.x,t.y),t.z),1e-4);e<1&&(t.x*=e,t.y*=e,t.z*=e)};let MC=t("AmbientInfo",(ix=oa("cc.AmbientInfo"),sx=Ga(Pe),rx=ba("_skyColor"),nx=ba("_skyIllum"),ox=ba("_groundAlbedo"),ix((s((hx=class{constructor(){this._skyColorHDR=lx&&lx(),this._skyIllumHDR=cx&&cx(),this._groundAlbedoHDR=ux&&ux(),this._skyColorLDR=dx&&dx(),this._skyIllumLDR=px&&px(),this._groundAlbedoLDR=_x&&_x(),this._resource=null}get skyColorHDR(){return this._skyColorHDR}get groundAlbedoHDR(){return this._groundAlbedoHDR}get skyIllumHDR(){return this._skyIllumHDR}get skyColorLDR(){return this._skyColorLDR}get groundAlbedoLDR(){return this._groundAlbedoLDR}get skyIllumLDR(){return this._skyIllumLDR}set skyLightingColor(t){IC.set(t.x,t.y,t.z,t.w),l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(IC):this._skyColorLDR.set(IC),this._resource&&this._resource.skyColor.set(IC)}get skyLightingColor(){const t=l.director.root.pipeline.pipelineSceneData.isHDR;return IC.set(t?this._skyColorHDR:this._skyColorLDR),AC(IC),EC.set(255*IC.x,255*IC.y,255*IC.z,255)}set skyColor(t){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._resource&&this._resource.skyColor.set(t)}set skyIllum(t){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t,this._resource&&(this._resource.skyIllum=t)}get skyIllum(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR}set groundLightingColor(t){IC.set(t.x,t.y,t.z,t.w),l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(IC):this._groundAlbedoLDR.set(IC),this._resource&&this._resource.groundAlbedo.set(IC)}get groundLightingColor(){const t=l.director.root.pipeline.pipelineSceneData.isHDR;return IC.set(t?this._groundAlbedoHDR:this._groundAlbedoLDR),AC(IC),EC.set(255*IC.x,255*IC.y,255*IC.z,255)}set groundAlbedo(t){l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._resource&&this._resource.groundAlbedo.set(t)}activate(t){this._resource=t,this._resource.initialize(this)}}).prototype,"skyIllum",[sx],Object.getOwnPropertyDescriptor(hx.prototype,"skyIllum"),hx.prototype),lx=Qo(hx.prototype,"_skyColorHDR",[va,rx],(function(){return new cr(.2,.5,.8,1)})),cx=Qo(hx.prototype,"_skyIllumHDR",[va,nx],(function(){return Vw.SKY_ILLUM})),ux=Qo(hx.prototype,"_groundAlbedoHDR",[va,ox],(function(){return new cr(.2,.2,.2,1)})),dx=Qo(hx.prototype,"_skyColorLDR",[va],(function(){return new cr(.2,.5,.8,1)})),px=Qo(hx.prototype,"_skyIllumLDR",[va],(function(){return Vw.SKY_ILLUM})),_x=Qo(hx.prototype,"_groundAlbedoLDR",[va],(function(){return new cr(.2,.2,.2,1)})),ax=hx))||ax));l.AmbientInfo=MC;let PC=t("SkyboxInfo",(gx=oa("cc.SkyboxInfo"),fx=Ga($w),mx=Ga(Uv),yx=Ga(Pe),vx=Ga(Uv),bx=Ga(Uv),wx=Ga(Lw),Sx=Ga(Uv),xx=ba("_envmap"),Tx=Ga(Uv),Cx=Ga(Uv),Ix=Ga(Uv),Ex=Ga(Lw),Dx=Ga(Uv),Ax=Ga(Uv),gx((s((Px=class{constructor(){this._envLightingType=Bx&&Bx(),this._envmapHDR=Rx&&Rx(),this._envmapLDR=Ox&&Ox(),this._diffuseMapHDR=Lx&&Lx(),this._diffuseMapLDR=Fx&&Fx(),this._enabled=zx&&zx(),this._useHDR=kx&&kx(),this._editableMaterial=Nx&&Nx(),this._reflectionHDR=Ux&&Ux(),this._reflectionLDR=Vx&&Vx(),this._rotationAngle=Hx&&Hx(),this._resource=null}set applyDiffuseMap(t){this._resource&&(this._resource.useDiffuseMap=t)}get applyDiffuseMap(){return 2===this._envLightingType}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}get enabled(){return this._enabled}set envLightingType(t){this.envmap||0===t?(0===t?(this.useIBL=!1,this.applyDiffuseMap=!1):1===t?(this.useIBL=!0,this.applyDiffuseMap=!1):2===t&&(this.useIBL=!0,this.applyDiffuseMap=!0),this._envLightingType=t):(this.useIBL=!1,this.applyDiffuseMap=!1,this._envLightingType=0,G(15001))}get envLightingType(){return this._envLightingType}set useIBL(t){this._resource&&(this._resource.useIBL=t)}get useIBL(){return 0!==this._envLightingType}set useHDR(t){l.director.root.pipeline.pipelineSceneData.isHDR=t,this._useHDR=t,this._resource&&2===this.envLightingType&&(null===this.diffuseMap?(this.envLightingType=1,G(15e3)):this.diffuseMap.isDefault&&G(15002)),this._resource&&(this._resource.useHDR=this._useHDR,this._resource.updateMaterialRenderInfo())}get useHDR(){return l.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR}set envmap(t){const e=l.director.root.pipeline.pipelineSceneData.isHDR;e?(this._envmapHDR=t,this._reflectionHDR=null):(this._envmapLDR=t,this._reflectionLDR=null),t||(e?this._diffuseMapHDR=null:this._diffuseMapLDR=null,this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=0,G(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=t)}get envmap(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR}set rotationAngle(t){this._rotationAngle=t,this._resource&&this._resource.setRotationAngle(this._rotationAngle)}get rotationAngle(){return this._rotationAngle}set diffuseMap(t){l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=t:this._diffuseMapLDR=t,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}get diffuseMap(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR}set reflectionMap(t){l.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR=t:this._reflectionLDR=t,this._resource&&this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR)}get reflectionMap(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR:this._reflectionLDR}set skyboxMaterial(t){this._editableMaterial=t,this._resource&&this._resource.setSkyboxMaterial(this._editableMaterial)}get skyboxMaterial(){return this._editableMaterial}activate(t){this.envLightingType=this._envLightingType,this._resource=t,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setSkyboxMaterial(this._editableMaterial),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.setRotationAngle(this._rotationAngle),this._resource.activate()}updateEnvMap(t){t||(this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=0,G(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=t)}setMaterialProperty(t,e,i){this._resource&&this._resource.enabled&&this._resource.editableMaterial&&(this._resource.editableMaterial.setProperty(t,e,i),this._resource.editableMaterial.passes.forEach((t=>{t.update()})))}}).prototype,"envLightingType",[fx],Object.getOwnPropertyDescriptor(Px.prototype,"envLightingType"),Px.prototype),s(Px.prototype,"envmap",[mx],Object.getOwnPropertyDescriptor(Px.prototype,"envmap"),Px.prototype),s(Px.prototype,"rotationAngle",[yx],Object.getOwnPropertyDescriptor(Px.prototype,"rotationAngle"),Px.prototype),s(Px.prototype,"diffuseMap",[vx],Object.getOwnPropertyDescriptor(Px.prototype,"diffuseMap"),Px.prototype),s(Px.prototype,"reflectionMap",[bx],Object.getOwnPropertyDescriptor(Px.prototype,"reflectionMap"),Px.prototype),s(Px.prototype,"skyboxMaterial",[wx],Object.getOwnPropertyDescriptor(Px.prototype,"skyboxMaterial"),Px.prototype),Bx=Qo(Px.prototype,"_envLightingType",[va],(function(){return 0})),Rx=Qo(Px.prototype,"_envmapHDR",[va,Sx,xx],(function(){return null})),Ox=Qo(Px.prototype,"_envmapLDR",[va,Tx],(function(){return null})),Lx=Qo(Px.prototype,"_diffuseMapHDR",[va,Cx],(function(){return null})),Fx=Qo(Px.prototype,"_diffuseMapLDR",[va,Ix],(function(){return null})),zx=Qo(Px.prototype,"_enabled",[va],(function(){return!1})),kx=Qo(Px.prototype,"_useHDR",[va],(function(){return!0})),Nx=Qo(Px.prototype,"_editableMaterial",[va,Ex],(function(){return null})),Ux=Qo(Px.prototype,"_reflectionHDR",[va,Dx],(function(){return null})),Vx=Qo(Px.prototype,"_reflectionLDR",[va,Ax],(function(){return null})),Hx=Qo(Px.prototype,"_rotationAngle",[va],(function(){return 0})),Mx=Px))||Mx));l.SkyboxInfo=PC;let BC=t("FogInfo",(Gx=oa("cc.FogInfo"),Wx=Ga(kw),jx=Ga(Pe),$x=Ga(Pe),qx=Ga(Pe),Xx=Ga(Pe),Yx=Ga(Pe),Qx=Ga(Pe),Gx(((lT=class{constructor(){this._type=Jx&&Jx(),this._fogColor=tT&&tT(),this._enabled=eT&&eT(),this._fogDensity=iT&&iT(),this._fogStart=sT&&sT(),this._fogEnd=rT&&rT(),this._fogAtten=nT&&nT(),this._fogTop=oT&&oT(),this._fogRange=aT&&aT(),this._accurate=hT&&hT(),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set accurate(t){this._accurate!==t&&(this._accurate=t,this._resource&&(this._resource.accurate=t,t&&(this._resource.type=this._type)))}get accurate(){return this._accurate}set fogColor(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}get fogColor(){return this._fogColor}get type(){return this._type}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get fogDensity(){return this._fogDensity}set fogDensity(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}get fogStart(){return this._fogStart}set fogStart(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}get fogEnd(){return this._fogEnd}set fogEnd(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}get fogAtten(){return this._fogAtten}set fogAtten(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}get fogTop(){return this._fogTop}set fogTop(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}get fogRange(){return this._fogRange}set fogRange(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).FogType=kw,s((Zx=lT).prototype,"type",[Wx],Object.getOwnPropertyDescriptor(Zx.prototype,"type"),Zx.prototype),s(Zx.prototype,"fogDensity",[jx],Object.getOwnPropertyDescriptor(Zx.prototype,"fogDensity"),Zx.prototype),s(Zx.prototype,"fogStart",[$x],Object.getOwnPropertyDescriptor(Zx.prototype,"fogStart"),Zx.prototype),s(Zx.prototype,"fogEnd",[qx],Object.getOwnPropertyDescriptor(Zx.prototype,"fogEnd"),Zx.prototype),s(Zx.prototype,"fogAtten",[Xx],Object.getOwnPropertyDescriptor(Zx.prototype,"fogAtten"),Zx.prototype),s(Zx.prototype,"fogTop",[Yx],Object.getOwnPropertyDescriptor(Zx.prototype,"fogTop"),Zx.prototype),s(Zx.prototype,"fogRange",[Qx],Object.getOwnPropertyDescriptor(Zx.prototype,"fogRange"),Zx.prototype),Jx=Qo(Zx.prototype,"_type",[va],(function(){return kw.LINEAR})),tT=Qo(Zx.prototype,"_fogColor",[va],(function(){return new _r("#C8C8C8")})),eT=Qo(Zx.prototype,"_enabled",[va],(function(){return!1})),iT=Qo(Zx.prototype,"_fogDensity",[va],(function(){return.3})),sT=Qo(Zx.prototype,"_fogStart",[va],(function(){return.5})),rT=Qo(Zx.prototype,"_fogEnd",[va],(function(){return 300})),nT=Qo(Zx.prototype,"_fogAtten",[va],(function(){return 5})),oT=Qo(Zx.prototype,"_fogTop",[va],(function(){return 1.5})),aT=Qo(Zx.prototype,"_fogRange",[va],(function(){return 1.2})),hT=Qo(Zx.prototype,"_accurate",[va],(function(){return!1})),Kx=Zx))||Kx)),RC=t("ShadowsInfo",(cT=oa("cc.ShadowsInfo"),uT=Ga(Yw),dT=Ga(Pe),pT=Ga(Pe),_T=Ga(Me),gT=Ga(Xw),cT((mT=class{constructor(){this._enabled=yT&&yT(),this._type=vT&&vT(),this._normal=bT&&bT(),this._distance=wT&&wT(),this._planeBias=ST&&ST(),this._shadowColor=xT&&xT(),this._maxReceived=TT&&TT(),this._size=CT&&CT(),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get type(){return this._type}set shadowColor(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}get shadowColor(){return this._shadowColor}set planeDirection(t){Ki.copy(this._normal,t),this._resource&&(this._resource.normal=t)}get planeDirection(){return this._normal}set planeHeight(t){this._distance=t,this._resource&&(this._resource.distance=t)}get planeHeight(){return this._distance}set planeBias(t){this._planeBias=t,this._resource&&(this._resource.planeBias=t)}get planeBias(){return this._planeBias}set maxReceived(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}get maxReceived(){return this._maxReceived}set shadowMapSize(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}get shadowMapSize(){return this._size.x}setPlaneFromNode(t){t.getWorldRotation(DC),this.planeDirection=Ki.transformQuat(CC,TC,DC),t.getWorldPosition(CC),this.planeHeight=Ki.dot(this._normal,CC)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}},s(mT.prototype,"type",[uT],Object.getOwnPropertyDescriptor(mT.prototype,"type"),mT.prototype),s(mT.prototype,"planeHeight",[dT],Object.getOwnPropertyDescriptor(mT.prototype,"planeHeight"),mT.prototype),s(mT.prototype,"planeBias",[pT],Object.getOwnPropertyDescriptor(mT.prototype,"planeBias"),mT.prototype),s(mT.prototype,"maxReceived",[_T],Object.getOwnPropertyDescriptor(mT.prototype,"maxReceived"),mT.prototype),s(mT.prototype,"shadowMapSize",[gT],Object.getOwnPropertyDescriptor(mT.prototype,"shadowMapSize"),mT.prototype),yT=Qo(mT.prototype,"_enabled",[va],(function(){return!1})),vT=Qo(mT.prototype,"_type",[va],(function(){return Yw.Planar})),bT=Qo(mT.prototype,"_normal",[va],(function(){return new Ki(0,1,0)})),wT=Qo(mT.prototype,"_distance",[va],(function(){return 0})),ST=Qo(mT.prototype,"_planeBias",[va],(function(){return 1})),xT=Qo(mT.prototype,"_shadowColor",[va],(function(){return new _r(0,0,0,76)})),TT=Qo(mT.prototype,"_maxReceived",[va],(function(){return 4})),CT=Qo(mT.prototype,"_size",[va],(function(){return new Qs(1024,1024)})),fT=mT))||fT));l.ShadowsInfo=RC;const OC=t("DEFAULT_WORLD_MIN_POS",new Ki(-1024,-1024,-1024)),LC=t("DEFAULT_WORLD_MAX_POS",new Ki(1024,1024,1024)),FC=t("DEFAULT_OCTREE_DEPTH",8);let zC=t("OctreeInfo",(IT=oa("cc.OctreeInfo"),ET=Ga(Me),IT((s((AT=class{constructor(){this._enabled=MT&&MT(),this._minPos=PT&&PT(),this._maxPos=BT&&BT(),this._depth=RT&&RT(),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}get enabled(){return this._enabled}set minPos(t){this._minPos=t,this._resource&&(this._resource.minPos=t)}get minPos(){return this._minPos}set maxPos(t){this._maxPos=t,this._resource&&(this._resource.maxPos=t)}get maxPos(){return this._maxPos}set depth(t){this._depth=t,this._resource&&(this._resource.depth=t)}get depth(){return this._depth}activate(t){this._resource=t,this._resource.initialize(this)}}).prototype,"depth",[ET],Object.getOwnPropertyDescriptor(AT.prototype,"depth"),AT.prototype),MT=Qo(AT.prototype,"_enabled",[va],(function(){return!1})),PT=Qo(AT.prototype,"_minPos",[va],(function(){return new Ki(OC)})),BT=Qo(AT.prototype,"_maxPos",[va],(function(){return new Ki(LC)})),RT=Qo(AT.prototype,"_depth",[va],(function(){return FC})),DT=AT))||DT));l.OctreeInfo=zC;let kC=t("SkinInfo",(OT=oa("cc.SkinInfo"),LT=Ga(Pe),FT=Ga(Pe),OT((s((kT=class{constructor(){this._enabled=NT&&NT(),this._blurRadius=UT&&UT(),this._sssIntensity=VT&&VT(),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}get enabled(){return this._enabled}set blurRadius(t){this._blurRadius=t,this._resource&&(this._resource.blurRadius=t)}get blurRadius(){return this._blurRadius}set sssIntensity(t){this._sssIntensity=t,this._resource&&(this._resource.sssIntensity=t)}get sssIntensity(){return this._sssIntensity}activate(t){this._resource=t,this._resource.initialize(this)}}).prototype,"blurRadius",[LT],Object.getOwnPropertyDescriptor(kT.prototype,"blurRadius"),kT.prototype),s(kT.prototype,"sssIntensity",[FT],Object.getOwnPropertyDescriptor(kT.prototype,"sssIntensity"),kT.prototype),NT=Qo(kT.prototype,"_enabled",[va],(function(){return!0})),UT=Qo(kT.prototype,"_blurRadius",[va],(function(){return.01})),VT=Qo(kT.prototype,"_sssIntensity",[va],(function(){return 3})),zT=kT))||zT));l.SkinInfo=kC;let NC=t("PostSettingsInfo",(HT=oa("cc.PostSettingsInfo"),GT=Ga(tx),HT((s((jT=class{constructor(){this._toneMappingType=$T&&$T(),this._resource=null}set toneMappingType(t){this._toneMappingType=t,this._resource&&(this._resource.toneMappingType=t)}get toneMappingType(){return this._toneMappingType}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"toneMappingType",[GT],Object.getOwnPropertyDescriptor(jT.prototype,"toneMappingType"),jT.prototype),$T=Qo(jT.prototype,"_toneMappingType",[va],(function(){return tx.DEFAULT})),WT=jT))||WT));l.PostSettingsInfo=NC;let UC=t("LightProbeInfo",(qT=oa("cc.LightProbeInfo"),XT=Ga(Pe),YT=Ga(Me),QT=Ga(Me),KT=Ga(Pe),ZT=Ga(Pe),qT((tC=class{constructor(){this._giScale=eC&&eC(),this._giSamples=iC&&iC(),this._bounces=sC&&sC(),this._reduceRinging=rC&&rC(),this._showProbe=nC&&nC(),this._showWireframe=oC&&oC(),this._showConvex=aC&&aC(),this._data=hC&&hC(),this._lightProbeSphereVolume=lC&&lC(),this._nodes=[],this._scene=null,this._resource=null}set giScale(t){this._giScale!==t&&(this._giScale=t,this._resource&&(this._resource.giScale=t))}get giScale(){return this._giScale}set giSamples(t){this._giSamples!==t&&(this._giSamples=t,this._resource&&(this._resource.giSamples=t))}get giSamples(){return this._giSamples}set bounces(t){this._bounces!==t&&(this._bounces=t,this._resource&&(this._resource.bounces=t))}get bounces(){return this._bounces}set reduceRinging(t){this._reduceRinging!==t&&(this._reduceRinging=t,this._resource&&(this._resource.reduceRinging=t))}get reduceRinging(){return this._reduceRinging}set showProbe(t){this._showProbe!==t&&(this._showProbe=t,this._resource&&(this._resource.showProbe=t))}get showProbe(){return this._showProbe}set showWireframe(t){this._showWireframe!==t&&(this._showWireframe=t,this._resource&&(this._resource.showWireframe=t))}get showWireframe(){return this._showWireframe}set showConvex(t){this._showConvex!==t&&(this._showConvex=t,this._resource&&(this._resource.showConvex=t))}get showConvex(){return this._showConvex}set data(t){this._data!==t&&(this._data=t,this._resource&&(this._resource.data=t))}get data(){return this._data}set lightProbeSphereVolume(t){this._lightProbeSphereVolume!==t&&(this._lightProbeSphereVolume=t,this._resource&&(this._resource.lightProbeSphereVolume=t))}get lightProbeSphereVolume(){return this._lightProbeSphereVolume}activate(t,e){this._scene=t,this._resource=e,this._resource.initialize(this)}onProbeBakeFinished(){this.onProbeBakingChanged(this._scene)}onProbeBakeCleared(){this.clearSHCoefficients(),this.onProbeBakingChanged(this._scene)}onProbeBakingChanged(t){if(t){t.emit("light-probe-baking-changed");for(let e=0;e<t.children.length;e++){const i=t.children[e];this.onProbeBakingChanged(i)}}}clearSHCoefficients(){if(!this._data)return;const t=this._data.probes;for(let e=0;e<t.length;e++)t[e].coefficients.length=0;this.clearAllSHUBOs()}isUniqueNode(){return 1===this._nodes.length}addNode(t){if(!t)return!1;for(let e=0;e<this._nodes.length;e++)if(this._nodes[e].node===t)return!1;return this._nodes.push({node:t,probes:null}),!0}removeNode(t){if(!t)return!1;const e=this._nodes.findIndex((e=>e.node===t));return-1!==e&&(this._nodes.splice(e,1),!0)}syncData(t,e){for(let i=0;i<this._nodes.length;i++)if(this._nodes[i].node===t)return void(this._nodes[i].probes=e)}update(t){if(void 0===t&&(t=!0),!h.internal.LightProbesData)return;this._data||(this._data=new h.internal.LightProbesData,this._resource&&(this._resource.data=this._data));const e=[];for(let t=0;t<this._nodes.length;t++){const i=this._nodes[t].node,s=this._nodes[t].probes,r=i.worldPosition;if(s)for(let t=0;t<s.length;t++){const i=new Ki(0,0,0);Ki.add(i,s[t],r),e.push(i)}}if(e.length<4)return this.resetAllTetraIndices(),void this._data.reset();this._data.updateProbes(e),t&&(this.resetAllTetraIndices(),this._data.updateTetrahedrons())}clearAllSHUBOs(){if(!this._scene)return;const t=this._scene.renderScene;if(!t)return;const e=t.models;for(let t=0;t<e.length;t++)e[t].clearSHUBOs()}resetAllTetraIndices(){if(!this._scene)return;const t=this._scene.renderScene;if(!t)return;const e=t.models;for(let t=0;t<e.length;t++)e[t].tetrahedronIndex=-1}},s(tC.prototype,"giScale",[XT],Object.getOwnPropertyDescriptor(tC.prototype,"giScale"),tC.prototype),s(tC.prototype,"giSamples",[YT],Object.getOwnPropertyDescriptor(tC.prototype,"giSamples"),tC.prototype),s(tC.prototype,"bounces",[QT],Object.getOwnPropertyDescriptor(tC.prototype,"bounces"),tC.prototype),s(tC.prototype,"reduceRinging",[KT],Object.getOwnPropertyDescriptor(tC.prototype,"reduceRinging"),tC.prototype),s(tC.prototype,"lightProbeSphereVolume",[ZT],Object.getOwnPropertyDescriptor(tC.prototype,"lightProbeSphereVolume"),tC.prototype),eC=Qo(tC.prototype,"_giScale",[va],(function(){return 1})),iC=Qo(tC.prototype,"_giSamples",[va],(function(){return 1024})),sC=Qo(tC.prototype,"_bounces",[va],(function(){return 2})),rC=Qo(tC.prototype,"_reduceRinging",[va],(function(){return 0})),nC=Qo(tC.prototype,"_showProbe",[va],(function(){return!0})),oC=Qo(tC.prototype,"_showWireframe",[va],(function(){return!0})),aC=Qo(tC.prototype,"_showConvex",[va],(function(){return!1})),hC=Qo(tC.prototype,"_data",[va],(function(){return null})),lC=Qo(tC.prototype,"_lightProbeSphereVolume",[va],(function(){return 1})),JT=tC))||JT)),VC=t("SceneGlobals",(cC=oa("cc.SceneGlobals"),uC=Ga(PC),cC((pC=class{constructor(){this.ambient=_C&&_C(),this.shadows=gC&&gC(),this._skybox=fC&&fC(),this.fog=mC&&mC(),this.octree=yC&&yC(),this.skin=vC&&vC(),this.lightProbeInfo=bC&&bC(),this.postSettings=wC&&wC(),this.bakedWithStationaryMainLight=SC&&SC(),this.bakedWithHighpLightmap=xC&&xC(),this.disableLightmap=!1}get skybox(){return this._skybox}set skybox(t){this._skybox=t}activate(t){const e=l.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree),this.skin.activate(e.skin),this.postSettings.activate(e.postSettings),this.lightProbeInfo&&e.lightProbes&&this.lightProbeInfo.activate(t,e.lightProbes),l.director.root.onGlobalPipelineStateChanged()}},_C=Qo(pC.prototype,"ambient",[va],(function(){return new MC})),gC=Qo(pC.prototype,"shadows",[va],(function(){return new RC})),fC=Qo(pC.prototype,"_skybox",[va],(function(){return new PC})),mC=Qo(pC.prototype,"fog",[va],(function(){return new BC})),s(pC.prototype,"skybox",[uC],Object.getOwnPropertyDescriptor(pC.prototype,"skybox"),pC.prototype),yC=Qo(pC.prototype,"octree",[va],(function(){return new zC})),vC=Qo(pC.prototype,"skin",[va],(function(){return new kC})),bC=Qo(pC.prototype,"lightProbeInfo",[va],(function(){return new UC})),wC=Qo(pC.prototype,"postSettings",[va],(function(){return new NC})),SC=Qo(pC.prototype,"bakedWithStationaryMainLight",[va],(function(){return!1})),xC=Qo(pC.prototype,"bakedWithHighpLightmap",[va],(function(){return!1})),dC=pC))||dC));var HC,GC,WC,jC,$C,qC,XC,YC,QC,KC,ZC,JC,tI,eI,iI,sI,rI,nI,oI,aI,hI,lI,cI,uI,dI,pI,_I,gI,fI,mI,yI,vI,bI,wI,SI,xI,TI,CI,II,EI,DI,AI,MI,PI,BI,RI,OI,LI,FI,zI,kI,NI,UI,VI,HI,GI,WI,jI,$I,qI,XI,YI,QI,KI,ZI,JI,tE,eE,iE;l.SceneGlobals=VC;let sE=(HC=oa("cc.TargetInfo"),GC=Ga([Re]),HC((jC=class{constructor(){this.localID=$C&&$C()}},$C=Qo(jC.prototype,"localID",[va,GC],(function(){return[]})),WC=jC))||WC),rE=(qC=oa("cc.TargetOverrideInfo"),XC=Ga(yn),YC=Ga(sE),QC=Ga([Re]),KC=Ga(JS),ZC=Ga(sE),qC((tI=class{constructor(){this.source=eI&&eI(),this.sourceInfo=iI&&iI(),this.propertyPath=sI&&sI(),this.target=rI&&rI(),this.targetInfo=nI&&nI()}},eI=Qo(tI.prototype,"source",[va,XC],(function(){return null})),iI=Qo(tI.prototype,"sourceInfo",[va,YC],(function(){return null})),sI=Qo(tI.prototype,"propertyPath",[va,QC],(function(){return[]})),rI=Qo(tI.prototype,"target",[va,KC],(function(){return null})),nI=Qo(tI.prototype,"targetInfo",[va,ZC],(function(){return null})),JC=tI))||JC),nE=oa("cc.CompPrefabInfo")((aI=class{constructor(){this.fileId=hI&&hI()}},hI=Qo(aI.prototype,"fileId",[va],(function(){return""})),oI=aI))||oI,oE=(lI=oa("CCPropertyOverrideInfo"),cI=Ga(sE),uI=Ga([Re]),lI((pI=class{constructor(){this.targetInfo=_I&&_I(),this.propertyPath=gI&&gI(),this.value=fI&&fI()}isTarget(t,e){}},_I=Qo(pI.prototype,"targetInfo",[va,cI],(function(){return null})),gI=Qo(pI.prototype,"propertyPath",[va,uI],(function(){return[]})),fI=Qo(pI.prototype,"value",[va],null),dI=pI))||dI),aE=(mI=oa("cc.MountedChildrenInfo"),yI=Ga(sE),vI=Ga([JS]),mI((wI=class{constructor(){this.targetInfo=SI&&SI(),this.nodes=xI&&xI()}isTarget(t){}},SI=Qo(wI.prototype,"targetInfo",[va,yI],(function(){return null})),xI=Qo(wI.prototype,"nodes",[va,vI],(function(){return[]})),bI=wI))||bI),hE=(TI=oa("cc.MountedComponentsInfo"),CI=Ga(sE),II=Ga([Ag]),TI((DI=class{constructor(){this.targetInfo=AI&&AI(),this.components=MI&&MI()}isTarget(t){}},AI=Qo(DI.prototype,"targetInfo",[va,CI],(function(){return null})),MI=Qo(DI.prototype,"components",[va,II],(function(){return[]})),EI=DI))||EI),lE=(PI=oa("cc.PrefabInstance"),BI=Ga(JS),RI=Ga([aE]),OI=Ga([hE]),LI=Ga([oE]),FI=Ga([sE]),PI((kI=class{constructor(){this.fileId=NI&&NI(),this.prefabRootNode=UI&&UI(),this.mountedChildren=VI&&VI(),this.mountedComponents=HI&&HI(),this.propertyOverrides=GI&&GI(),this.removedComponents=WI&&WI(),this.targetMap={},this.expanded=!1}findPropertyOverride(t,e){}removePropertyOverride(t,e){}},NI=Qo(kI.prototype,"fileId",[va],(function(){return""})),UI=Qo(kI.prototype,"prefabRootNode",[va,BI],null),VI=Qo(kI.prototype,"mountedChildren",[va,RI],(function(){return[]})),HI=Qo(kI.prototype,"mountedComponents",[va,OI],(function(){return[]})),GI=Qo(kI.prototype,"propertyOverrides",[va,LI],(function(){return[]})),WI=Qo(kI.prototype,"removedComponents",[va,FI],(function(){return[]})),zI=kI))||zI),cE=(jI=oa("cc.PrefabInfo"),$I=Ga(JS),qI=Ga(lE),XI=Ga([rE]),jI((QI=class{constructor(){this.root=KI&&KI(),this.asset=ZI&&ZI(),this.fileId=JI&&JI(),this.instance=tE&&tE(),this.targetOverrides=eE&&eE(),this.nestedPrefabInstanceRoots=iE&&iE()}},KI=Qo(QI.prototype,"root",[va,$I],null),ZI=Qo(QI.prototype,"asset",[va],null),JI=Qo(QI.prototype,"fileId",[va],(function(){return""})),tE=Qo(QI.prototype,"instance",[va,qI],null),eE=Qo(QI.prototype,"targetOverrides",[va,XI],null),iE=Qo(QI.prototype,"nestedPrefabInstanceRoots",[va],null),YI=QI))||YI);function uE(t){const e=null==t?void 0:t.prefab;if(!e)return;if(!e.instance)return;if(!e.asset)return j(3701,t.name),void(e.instance=void 0);const i=t._objFlags,s=t.getParent(),r=t.uuid;t[an],h.game._isCloning=!0,e.asset._doInstantiate(t),h.game._isCloning=!1,t._objFlags=i,t.modifyParent(s),t.id=r,t.prefab&&(t.prefab.instance=e.instance)}function dE(t,e,i){var s;if(!e)return;if(!t)return;let r=e;const n=null===(s=t.prefab)||void 0===s?void 0:s.instance;!i&&n&&(e[n.fileId]={},r=e[n.fileId]);const o=t.prefab;o&&(r[o.fileId]=t);const a=t.components;for(let t=0;t<a.length;t++){const e=a[t];e.__prefab&&(r[e.__prefab.fileId]=e)}for(let e=0;e<t.children.length;e++)dE(t.children[e],r,!1)}function pE(t,e){if(!t)return null;let i=null,s=e;for(let e=0;e<t.length;e++){if(!s)return null;s=s[t[e]]}return i=s,i}function _E(t,e,i){if(e)for(let t=0;t<e.length;t++){const s=e[t];if(s&&s.targetInfo){const t=pE(s.targetInfo.localID,i);if(!t)continue;let e=i;const r=s.targetInfo.localID;if(r.length>0)for(let t=0;t<r.length-1;t++)e=e[r[t]];if(s.nodes)for(let i=0;i<s.nodes.length;i++){const r=s.nodes[i];r&&!t.children.includes(r)&&(t.children.push(r),r.modifyParent(t),dE(r,e,!1),r.siblingIndex=t.children.length-1,vE(r,!0))}}}}function gE(t,e,i){if(e)for(let t=0;t<e.length;t++){const s=e[t];if(s&&s.targetInfo){const t=pE(s.targetInfo.localID,i);if(!t)continue;if(s.components)for(let e=0;e<s.components.length;e++){const i=s.components[e];i&&(i.node=t,t.getWritableComponents().push(i))}}}}function fE(t,e,i){if(e)for(let t=0;t<e.length;t++){const s=e[t];if(s){const t=pE(s.localID,i);if(!t||!t.node)continue;const e=t.node.components.indexOf(t);e>=0&&t.node.getWritableComponents().splice(e,1)}}}function mE(t,e,i){if(e.length<=0)return;let s=null;for(let t=0;t<e.length;t++){const r=e[t];if(r&&r.targetInfo){if(s=pE(r.targetInfo.localID,i),!s)continue;let t=s;const e=r.propertyPath.slice();if(e.length>0){const i=e.pop();if(!i)continue;for(let i=0;i<e.length&&(t=t[e[i]],t);i++);if(!t)continue;if(Array.isArray(t))if("length"===i)t[i]=r.value;else{const e=Number.parseInt(i);Number.isInteger(e)&&e<t.length&&(t[i]=r.value)}else t[i]instanceof re?t[i].set(r.value):t[i]=r.value}}}}function yE(t){var e;const i=null===(e=t.prefab)||void 0===e?void 0:e.targetOverrides;if(i)for(let t=0;t<i.length;t++){var s;const e=i[t];let n=e.source;const o=e.sourceInfo;if(o){var r;const t=e.source,i=null==t||null===(r=t.prefab)||void 0===r?void 0:r.instance;i&&i.targetMap&&(n=pE(o.localID,i.targetMap))}if(!n)continue;let a=null;const h=e.targetInfo;if(!h)continue;const l=e.target,c=null==l||null===(s=l.prefab)||void 0===s?void 0:s.instance;if(!c||!c.targetMap)continue;if(a=pE(h.localID,c.targetMap),!a)continue;const u=e.propertyPath.slice();let d=n;if(u.length>0){const t=u.pop();if(!t)return;for(let t=0;t<u.length&&(d=d[u[t]],d);t++);if(!d)continue;d[t]=a}}}function vE(t,e){var i;void 0===e&&(e=!1);const s=null==t||null===(i=t.prefab)||void 0===i?void 0:i.instance;if(s&&!s.expanded){uE(t),e&&t&&t.children&&t.children.forEach((t=>{vE(t,!0)}));const i={};s.targetMap=i,dE(t,i,!0),_E(0,s.mountedChildren,i),fE(0,s.removedComponents,i),gE(0,s.mountedComponents,i),mE(0,s.propertyOverrides,i),s.expanded=!0}else e&&t&&t.children&&t.children.forEach((t=>{vE(t,!0)}))}function bE(t){const e=t.prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach((t=>{vE(t)}))}h._PrefabInfo=cE;var wE,SE,xE,TE,CE=Object.freeze({__proto__:null,CompPrefabInfo:nE,MountedChildrenInfo:aE,MountedComponentsInfo:hE,PrefabInfo:cE,PrefabInstance:lE,PropertyOverrideInfo:oE,TargetInfo:sE,TargetOverrideInfo:rE,applyMountedChildren:_E,applyMountedComponents:gE,applyNodeAndComponentId:function t(e,i){const{components:s,children:r}=e;for(let t=0;t<s.length;t++){var n,o;const e=s[t],r=null!==(n=null===(o=e.__prefab)||void 0===o?void 0:o.fileId)&&void 0!==n?n:"";e._id=`${i}${r}`}for(let e=0;e<r.length;e++){const s=r[e],n=s.prefab,o=null!=n&&n.instance?n.instance.fileId:null==n?void 0:n.fileId;o&&(s.id=`${i}${o}`,null!=n&&n.instance||t(s,i))}},applyPropertyOverrides:mE,applyRemovedComponents:fE,applyTargetOverrides:yE,createNodeWithPrefab:uE,expandNestedPrefabInstanceNode:bE,expandPrefabInstanceNode:vE,generateTargetMap:dE,getTarget:pE});let IE=t("Scene",oa("cc.Scene")((SE=class extends JS{get renderScene(){return this._renderScene}get globals(){return this._globals}_updateScene(){this._scene=this}constructor(t){super(t),this.autoReleaseAssets=xE&&xE(),this._globals=TE&&TE(),this.dependAssets=null,this._renderScene=null,this._prefabSyncedInLiveReload=!1,this._activeInHierarchy=!1,l.director&&l.director.root&&(this._renderScene=l.director.root.createScene({})),this._inited=!l.game||!l.game._isCloning}destroy(){const t=yn.prototype.destroy.call(this);if(t){const t=this._children;for(let e=0;e<t.length;++e)t[e].active=!1}return this._renderScene&&l.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t}addComponent(){throw new Error(Y(3822))}_onHierarchyChanged(){}_onPostActivated(t){}_onBatchCreated(t){const e=this._children.length;for(let i=0;i<e;++i)this._children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)}updateWorldTransform(){}_instantiate(t,e){return null}_load(){this._inited||(bE(this),yE(this),this._onBatchCreated(n),this._inited=!0),this.walk(JS._setScene)}_activate(t){void 0===t&&(t=!0),l.director._nodeActivator.activateNode(this,t),this._globals.activate(this)}},xE=Qo(SE.prototype,"autoReleaseAssets",[va],(function(){return!1})),TE=Qo(SE.prototype,"_globals",[va],(function(){return new VC})),wE=SE))||wE);var EE,DE,AE;l.Scene=IE;let ME=t("SceneAsset",oa("cc.SceneAsset")((DE=class extends F_{constructor(){super(),this.scene=AE&&AE()}initDefault(t){super.initDefault(t),this.scene=new IE("New Scene")}validate(){return!!this.scene}},AE=Qo(DE.prototype,"scene",[va],(function(){return null})),EE=DE))||EE);h.SceneAsset=ME;const PE=new Rs,BE=new Rs,RE=new Rs,OE=new Rs,LE=new Rs,FE=new Rs,zE=new Rs,kE=new Ki(0,0,0),NE=new Ki,UE=new Qs,VE=new Ki,HE=new Ki,GE=new Ki(1e7,1e7,1e7),WE=new Ki(-1e7,-1e7,-1e7),jE=new Ki;let $E=0,qE=0;class XE{constructor(t){this._shadowObjects=[],this._shadowCameraFar=0,this._matShadowView=new Rs,this._matShadowProj=new Rs,this._matShadowViewProj=new Rs,this._validFrustum=new eo,this._splitFrustum=new eo,this._lightViewFrustum=new eo,this._castLightViewBoundingBox=new Qn,this._level=t,this._validFrustum.accurate=!0,this._splitFrustum.accurate=!0,this._lightViewFrustum.accurate=!0}get level(){return this._level}get shadowObjects(){return this._shadowObjects}get shadowCameraFar(){return this._shadowCameraFar}set shadowCameraFar(t){this._shadowCameraFar=t}get matShadowView(){return this._matShadowView}set matShadowView(t){this._matShadowView=t}get matShadowProj(){return this._matShadowProj}set matShadowProj(t){this._matShadowProj=t}get matShadowViewProj(){return this._matShadowViewProj}set matShadowViewProj(t){this._matShadowViewProj=t}get validFrustum(){return this._validFrustum}get splitFrustum(){return this._splitFrustum}get lightViewFrustum(){return this._lightViewFrustum}get castLightViewBoundingBox(){return this._castLightViewBoundingBox}copyToValidFrustum(t){eo.copy(this._validFrustum,t)}calculateValidFrustumOrtho(t,e,i,s,r){eo.createOrtho(this._validFrustum,t,e,i,s,r)}calculateSplitFrustum(t,e,i,s){this._splitFrustum.split(i,s,t.aspect,t.fov,e)}destroy(){this._shadowObjects.length=0}createMatrix(t,e,i){const s=h.director.root.device,r=t.shadowInvisibleOcclusionRange;eo.copy(this._lightViewFrustum,this._splitFrustum),Rs.fromRT(BE,t.node.rotation,kE),Rs.invert(RE,BE);const n=RE.clone();let o,a;this._lightViewFrustum.transform(RE),Qn.fromPoints(this._castLightViewBoundingBox,GE,WE),this._castLightViewBoundingBox.mergeFrustum(this._lightViewFrustum),t.csmOptimizationMode===Zw.DisableRotationFix?(o=2*this._castLightViewBoundingBox.halfExtents.x,a=2*this._castLightViewBoundingBox.halfExtents.y):o=a=Ki.distance(this._lightViewFrustum.vertices[0],this._lightViewFrustum.vertices[6]);const l=h.director.root.pipeline.pipelineSceneData.csmSupported?t.csmLevel:1;if(l>1&&t.csmOptimizationMode===Zw.RemoveDuplicates)if(this._level>=l-1)qE=this._castLightViewBoundingBox.halfExtents.z,$E=this._castLightViewBoundingBox.center.z;else{const t=Math.abs(this._castLightViewBoundingBox.center.z-$E)+qE;this._castLightViewBoundingBox.halfExtents.z=Math.max(this._castLightViewBoundingBox.center.z,t)}const c=this._castLightViewBoundingBox.halfExtents.z;this._shadowCameraFar=2*c+r;const u=this._castLightViewBoundingBox.center;if(jE.set(u.x,u.y,u.z+c+r),Ki.transformMat4(jE,jE,BE),Rs.fromRT(BE,t.node.rotation,jE),Rs.invert(RE,BE),!i){const i=.5*o,r=.5*a;Rs.ortho(OE,-i,i,-r,r,.1,this._shadowCameraFar,s.capabilities.clipSpaceMinZ,s.capabilities.clipSpaceSignY),Rs.multiply(FE,OE,n),Ki.transformMat4(NE,jE,FE);const h=2/e;UE.set(h,h);const l=NE.x%UE.x,c=NE.y%UE.y;VE.set(NE.x-l,NE.y-c,NE.z),Rs.invert(zE,FE),Ki.transformMat4(HE,VE,zE),Rs.fromRT(BE,t.node.rotation,HE),Rs.invert(RE,BE),Rs.multiply(LE,OE,RE),Rs.copy(this._matShadowView,RE),Rs.copy(this._matShadowProj,OE),Rs.copy(this._matShadowViewProj,LE)}eo.createOrtho(this._validFrustum,o,a,.1,this._shadowCameraFar,BE)}}class YE extends XE{constructor(t){super(t),this._splitCameraNear=0,this._splitCameraFar=0,this._csmAtlas=new cr,this._calculateAtlas(t)}get splitCameraNear(){return this._splitCameraNear}set splitCameraNear(t){this._splitCameraNear=t}get splitCameraFar(){return this._splitCameraFar}set splitCameraFar(t){this._splitCameraFar=t}get csmAtlas(){return this._csmAtlas}set csmAtlas(t){this._csmAtlas=t}destroy(){super.destroy()}_calculateAtlas(t){const e=h.director.root.device.capabilities.clipSpaceSignY,i=t%2-.5,s=(.5-Math.floor(t/2))*e;this._csmAtlas.set(.5,.5,i,s)}}class QE{get castShadowObjects(){return this._castShadowObjects}get layerObjects(){return this._layerObjects}get layers(){return this._layers}get specialLayer(){return this._specialLayer}constructor(){this._castShadowObjects=[],this._layerObjects=new on(64),this._layers=[],this._levelCount=0,this._specialLayer=new XE(1),this._shadowDistance=0;for(let t=0;t<Kw.LEVEL_4;t++)this._layers[t]=new YE(t)}update(t,e){const i=e.scene.mainLight;if(null===i)return;const s=t.shadows,r=h.director.root.pipeline.pipelineSceneData.csmSupported?i.csmLevel:1,n=i.shadowDistance;s.enabled&&i.shadowEnabled&&(i.shadowFixedArea?this._updateFixedArea(i):((i.csmNeedUpdate||this._levelCount!==r||this._shadowDistance!==n)&&(this._splitFrustumLevels(i),this._levelCount=r,this._shadowDistance=n),this._calculateCSM(e,i,s)))}destroy(){this._castShadowObjects.length=0;for(let t=0;t<this._layers.length;t++)this._layers[t].destroy();this._layers.length=0}_updateFixedArea(t){const e=h.director.root.device,i=t.shadowOrthoSize,s=t.shadowOrthoSize,r=t.shadowNear,n=t.shadowFar;Rs.fromRT(BE,t.node.getWorldRotation(),t.node.getWorldPosition()),Rs.invert(RE,BE),Rs.ortho(OE,-i,i,-s,s,r,n,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY),Rs.multiply(LE,OE,RE),this._specialLayer.matShadowView=RE,this._specialLayer.matShadowProj=OE,this._specialLayer.matShadowViewProj=LE,this._specialLayer.calculateValidFrustumOrtho(2*i,2*s,r,n,BE)}_splitFrustumLevels(t){const e=.1,i=t.shadowDistance,s=i/e,r=h.director.root.pipeline.pipelineSceneData.csmSupported?t.csmLevel:1,n=t.csmLayerLambda;this._layers[0].splitCameraNear=e;for(let t=1;t<r;t++){const o=t/r,a=n*e*s**o+(1-n)*(e+(i-e)*o),h=1.005*a;this._layers[t].splitCameraNear=a,this._layers[t-1].splitCameraFar=h}this._layers[r-1].splitCameraFar=i,t.csmNeedUpdate=!1}_calculateCSM(t,e,i){const s=h.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1,r=s>1?.5*i.size.x:i.size.x;if(!(r<0)){this._getCameraWorldMatrix(PE,t);for(let i=s-1;i>=0;i--){const s=this._layers[i],n=s.splitCameraNear,o=s.splitCameraFar;s.calculateSplitFrustum(t,PE,n,o),s.createMatrix(e,r,!1)}s===Kw.LEVEL_1?(this._specialLayer.shadowCameraFar=this._layers[0].shadowCameraFar,Rs.copy(this._specialLayer.matShadowView,this._layers[0].matShadowView),Rs.copy(this._specialLayer.matShadowProj,this._layers[0].matShadowProj),Rs.copy(this._specialLayer.matShadowViewProj,this._layers[0].matShadowViewProj),this._specialLayer.copyToValidFrustum(this._layers[0].validFrustum)):(this._specialLayer.calculateSplitFrustum(t,PE,.1,e.shadowDistance),this._specialLayer.createMatrix(e,r,!0))}}_getCameraWorldMatrix(t,e){if(!e.node)return;const i=e.node,s=i.getWorldPosition(),r=i.getWorldRotation();Rs.fromRT(t,r,s)}}class KE{constructor(){this._enabled=!0,this._blurRadius=.01,this._sssIntensity=3}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set blurRadius(t){this._blurRadius=t}get blurRadius(){return this._blurRadius}set sssIntensity(t){this._sssIntensity=t}get sssIntensity(){return this._sssIntensity}initialize(t){this._enabled=t.enabled,this._blurRadius=t.blurRadius,this._sssIntensity=t.sssIntensity}}class ZE{get isHDR(){return this._isHDR}set isHDR(t){this._isHDR=t}get shadingScale(){return this._shadingScale}set shadingScale(t){this._shadingScale=t}get csmSupported(){return this._csmSupported}set csmSupported(t){this._csmSupported=t}get standardSkinModel(){return this._standardSkinModel}set standardSkinModel(t){this._standardSkinModel=t}get standardSkinMeshRenderer(){return this._standardSkinMeshRenderer}set standardSkinMeshRenderer(t){this._standardSkinMeshRenderer&&this._standardSkinMeshRenderer!==t&&this._standardSkinMeshRenderer.clearGlobalStandardSkinObjectFlag(),this._standardSkinMeshRenderer=t,this.standardSkinModel=t?t.model:null}get skinMaterialModel(){return this._skinMaterialModel}set skinMaterialModel(t){this._skinMaterialModel=t}constructor(){this.fog=new Uw,this.ambient=new Vw,this.skybox=new qw,this.shadows=new tS,this.csmLayers=new QE,this.octree=new eS,this.skin=new KE,this.postSettings=new ex,this.lightProbes=l.internal.LightProbes?new l.internal.LightProbes:null,this.validPunctualLights=[],this.renderObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._csmSupported=!0,this._standardSkinMeshRenderer=null,this._standardSkinModel=null,this._skinMaterialModel=null,this._shadingScale=1}activate(t){return this._device=t,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0}initGeometryRendererMaterials(){let t=0;for(let e=0;e<6;e++){this._geometryRendererMaterials[e]=new Lw,this._geometryRendererMaterials[e]._uuid=`geometry-renderer-material-${e}`,this._geometryRendererMaterials[e].initialize({effectName:"internal/builtin-geometry-renderer",technique:e});for(let i=0;i<this._geometryRendererMaterials[e].passes.length;++i)this._geometryRendererPasses[t]=this._geometryRendererMaterials[e].passes[i],this._geometryRendererShaders[t]=this._geometryRendererMaterials[e].passes[i].getShaderVariant(),t++}}get geometryRendererPasses(){return this._geometryRendererPasses}get geometryRendererShaders(){return this._geometryRendererShaders}initOcclusionQuery(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){const t=new Lw;t._uuid="default-occlusion-query-material",t.initialize({effectName:"internal/builtin-occlusion-query"}),this._occlusionQueryMaterial=t,t.passes.length>0&&(this._occlusionQueryShader=t.passes[0].getShaderVariant())}}getOcclusionQueryPass(){return this._occlusionQueryMaterial&&this._occlusionQueryMaterial.passes.length>0?this._occlusionQueryMaterial.passes[0]:null}updatePipelineSceneData(){}destroy(){var t,e,i;this.shadows.destroy(),this.csmLayers.destroy(),this.validPunctualLights.length=0,null===(t=this._occlusionQueryInputAssembler)||void 0===t||t.destroy(),this._occlusionQueryInputAssembler=null,null===(e=this._occlusionQueryVertexBuffer)||void 0===e||e.destroy(),this._occlusionQueryVertexBuffer=null,null===(i=this._occlusionQueryIndicesBuffer)||void 0===i||i.destroy(),this._occlusionQueryIndicesBuffer=null,this._standardSkinMeshRenderer=null,this._standardSkinModel=null,this._skinMaterialModel=null}_createOcclusionQueryIA(){const t=this._device,e=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]);this._occlusionQueryVertexBuffer=t.createBuffer(new Ed(10,1,96,12)),this._occlusionQueryVertexBuffer.update(e);const i=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]);this._occlusionQueryIndicesBuffer=t.createBuffer(new Ed(6,1,72,2)),this._occlusionQueryIndicesBuffer.update(i);const s=[new Wd("a_position",32)],r=new $d(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return t.createInputAssembler(r)}}t("PipelineSceneData",ZE),t("PipelineEventType",{RENDER_FRAME_BEGIN:"render-frame-begin",RENDER_FRAME_END:"render-frame-end",RENDER_CAMERA_BEGIN:"render-camera-begin",RENDER_CAMERA_END:"render-camera-end",ATTACHMENT_SCALE_CAHNGED:"attachment-scale-changed"});class JE extends An{constructor(){super(),this.eventTargetOn=super.on,this.eventTargetOnce=super.once}on(t,e,i,s){return this.eventTargetOn(t,e,i,s)}once(t,e,i){return this.eventTargetOnce(t,e,i)}}t("PipelineEventProcessor",JE);class tD{get singleMode(){return this._singleMode}set singleMode(t){this._singleMode=t,this._updatePipeline()}get lightingWithAlbedo(){return this._lightingWithAlbedo}set lightingWithAlbedo(t){this._lightingWithAlbedo=t,this._updatePipeline()}get csmLayerColoration(){return this._csmLayerColoration}set csmLayerColoration(t){this._csmLayerColoration=t,this._updatePipeline()}get debugViewType(){return this._getType()}constructor(){this._singleMode=0,this._compositeModeValue=0,this._lightingWithAlbedo=!0,this._csmLayerColoration=!1,this._activate()}isCompositeModeEnabled(t){return!!(this._compositeModeValue&1<<t)}enableCompositeMode(t,e){this._enableCompositeMode(t,e),this._updatePipeline()}enableAllCompositeMode(t){this._enableAllCompositeMode(t),this._updatePipeline()}isEnabled(){return 0!==this._getType()}reset(){this._activate(),this._updatePipeline()}_activate(){this._singleMode=0,this._enableAllCompositeMode(!0),this._lightingWithAlbedo=!0,this._csmLayerColoration=!1}_updatePipeline(){const t=h.director.root,e=t.pipeline,i=this._getType();e.macros.CC_USE_DEBUG_VIEW!==i&&(e.macros.CC_USE_DEBUG_VIEW=i,t.onGlobalPipelineStateChanged())}_enableCompositeMode(t,e){e?this._compositeModeValue|=1<<t:this._compositeModeValue&=~(1<<t)}_enableAllCompositeMode(t){for(let e=0;e<17;e++)t?this._compositeModeValue|=1<<e:this._compositeModeValue&=~(1<<e)}_getType(){if(0!==this._singleMode)return 1;if(!0!==this._lightingWithAlbedo||!1!==this._csmLayerColoration)return 2;for(let t=0;t<17;t++)if(!this.isCompositeModeEnabled(t))return 2;return 0}}t("DebugView",tD);class eD{constructor(t,e){this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}unuse(){this.type=eD.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=eD.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}reuse(t,e){this.type=t,this.bubbles=e||!1}isStopped(){return this.propagationStopped||this.propagationImmediateStopped}getCurrentTarget(){return this.currentTarget}getType(){return this.type}}t("Event",eD),eD.NO_TYPE="no_type",eD.TOUCH="touch",eD.MOUSE="mouse",eD.KEYBOARD="keyboard",eD.ACCELERATION="acceleration",eD.NONE=0,eD.CAPTURING_PHASE=1,eD.AT_TARGET=2,eD.BUBBLING_PHASE=3,h.Event=eD;class iD extends eD{constructor(t,e){super("devicemotion",e),this.acc=t}}t("EventAcceleration",iD),eD.EventAcceleration=iD;class sD extends eD{get isPressed(){return this._isPressed}constructor(t,e,i){"boolean"==typeof e&&(e=e?"keydown":"keyup"),super(e,i),this.rawEvent=void 0,this._isPressed="keyup"!==e,"number"==typeof t?this.keyCode=t:(this.keyCode=t.keyCode,this.rawEvent=t),this.windowId=0}}t("EventKeyboard",sD),eD.EventKeyboard=sD;class rD extends eD{get eventType(){return this._eventType}constructor(t,e,i,s){super(t,e),this.movementX=0,this.movementY=0,this.windowId=0,this.preventSwallow=!1,this._button=rD.BUTTON_MISSING,this._x=0,this._y=0,this._prevX=0,this._prevY=0,this._scrollX=0,this._scrollY=0,this._eventType=t,i&&(this._prevX=i.x,this._prevY=i.y),this.windowId=null!=s?s:this.windowId}setScrollData(t,e){this._scrollX=t,this._scrollY=e}getScrollX(){return this._scrollX}getScrollY(){return this._scrollY}setLocation(t,e){this._x=t,this._y=e}getLocation(t){return t||(t=new Qs),Qs.set(t,this._x,this._y),t}getLocationInView(t){return t||(t=new Qs),Qs.set(t,this._x,h.view._designResolutionSize.height-this._y),t}getUILocation(t){return t||(t=new Qs),Qs.set(t,this._x,this._y),h.view._convertToUISpace(t),t}getPreviousLocation(t){return t||(t=new Qs),Qs.set(t,this._prevX,this._prevY),t}getUIPreviousLocation(t){return t||(t=new Qs),Qs.set(t,this._prevX,this._prevY),h.view._convertToUISpace(t),t}getDelta(t){return t||(t=new Qs),Qs.set(t,this._x-this._prevX,this._y-this._prevY),t}getDeltaX(){return this._x-this._prevX}getDeltaY(){return this._y-this._prevY}getUIDelta(t){t||(t=new Qs);const e=h.view;return Qs.set(t,(this._x-this._prevX)/e.getScaleX(),(this._y-this._prevY)/e.getScaleY()),t}getUIDeltaX(){return(this._x-this._prevX)/h.view.getScaleX()}getUIDeltaY(){return(this._y-this._prevY)/h.view.getScaleY()}setButton(t){this._button=t}getButton(){return this._button}getLocationX(){return this._x}getLocationY(){return this._y}getUILocationX(){const t=h.view,e=t.getViewportRect();return(this._x-e.x)/t.getScaleX()}getUILocationY(){const t=h.view,e=t.getViewportRect();return(this._y-e.y)/t.getScaleY()}}t("EventMouse",rD),rD.BUTTON_MISSING=-1,rD.BUTTON_LEFT=0,rD.BUTTON_RIGHT=2,rD.BUTTON_MIDDLE=1,rD.BUTTON_4=3,rD.BUTTON_5=4,rD.BUTTON_6=5,rD.BUTTON_7=6,rD.BUTTON_8=7,eD.EventMouse=rD;const nD=new Qs;class oD extends eD{constructor(t,e,i,s){void 0===s&&(s=[]),super(i,e),this.touch=null,this.simulate=!1,this.windowId=0,this.preventSwallow=!1,this._eventCode=i,this._touches=t||[],this._allTouches=s}getEventCode(){return this._eventCode}getTouches(){return this._touches}getAllTouches(){return this._allTouches}setLocation(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)}getLocation(t){return this.touch?this.touch.getLocation(t):new Qs}getUILocation(t){return this.touch?this.touch.getUILocation(t):new Qs}getLocationInView(t){return this.touch?this.touch.getLocationInView(t):new Qs}getPreviousLocation(t){return this.touch?this.touch.getPreviousLocation(t):new Qs}getStartLocation(t){return this.touch?this.touch.getStartLocation(t):new Qs}getUIStartLocation(t){return this.touch?this.touch.getUIStartLocation(t):new Qs}getID(){return this.touch?this.touch.getID():null}getDelta(t){return this.touch?this.touch.getDelta(t):new Qs}getUIDelta(t){return this.touch?this.touch.getUIDelta(t):new Qs}getDeltaX(){return this.touch?this.touch.getDelta(nD).x:0}getDeltaY(){return this.touch?this.touch.getDelta(nD).y:0}getLocationX(){return this.touch?this.touch.getLocationX():0}getLocationY(){return this.touch?this.touch.getLocationY():0}}t("EventTouch",oD),oD.MAX_TOUCHES=5,eD.EventTouch=oD;class aD extends eD{constructor(t,e){super(t,!1),this.gamepad=e}}t("EventGamepad",aD);class hD extends eD{constructor(t,e){super(t,!1),this.handleInputDevice=e}}t("EventHandle",hD);class lD extends eD{constructor(t,e){super(t,!1),this.hmdInputDevice=e}}t("EventHMD",lD),t("EventHandheld",class extends eD{constructor(t,e){super(t,!1),this.handheldInputDevice=e}});class cD{constructor(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),this.x=t,this.y=e,this.z=i,this.timestamp=s}}t("Acceleration",cD);const uD=t("SystemEventType",{TOUCH_START:"touch-start",TOUCH_MOVE:"touch-move",TOUCH_END:"touch-end",TOUCH_CANCEL:"touch-cancel",MOUSE_DOWN:"mouse-down",MOUSE_MOVE:"mouse-move",MOUSE_UP:"mouse-up",MOUSE_WHEEL:"mouse-wheel",MOUSE_ENTER:"mouse-enter",MOUSE_LEAVE:"mouse-leave",KEY_DOWN:"keydown",KEY_UP:"keyup",DEVICEMOTION:"devicemotion",TRANSFORM_CHANGED:"transform-changed",SCENE_CHANGED_FOR_PERSISTS:"scene-changed-for-persists",SIZE_CHANGED:"size-changed",ANCHOR_CHANGED:"anchor-changed",COLOR_CHANGED:"color-changed",CHILD_ADDED:"child-added",CHILD_REMOVED:"child-removed",PARENT_CHANGED:"parent-changed",NODE_DESTROYED:"node-destroyed",LAYER_CHANGED:"layer-changed",SIBLING_ORDER_CHANGED:"sibling-order-changed"});h.SystemEventType=uD,t("KeyCode",{NONE:0,MOBILE_BACK:6,BACKSPACE:8,TAB:9,ENTER:13,SHIFT_LEFT:16,CTRL_LEFT:17,ALT_LEFT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,INSERT:45,DELETE:46,DIGIT_0:48,DIGIT_1:49,DIGIT_2:50,DIGIT_3:51,DIGIT_4:52,DIGIT_5:53,DIGIT_6:54,DIGIT_7:55,DIGIT_8:56,DIGIT_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,NUM_0:96,NUM_1:97,NUM_2:98,NUM_3:99,NUM_4:100,NUM_5:101,NUM_6:102,NUM_7:103,NUM_8:104,NUM_9:105,NUM_MULTIPLY:106,NUM_PLUS:107,NUM_SUBTRACT:109,NUM_DECIMAL:110,NUM_DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUAL:187,COMMA:188,DASH:189,PERIOD:190,SLASH:191,BACK_QUOTE:192,BRACKET_LEFT:219,BACKSLASH:220,BRACKET_RIGHT:221,QUOTE:222,SHIFT_RIGHT:2e3,CTRL_RIGHT:2001,ALT_RIGHT:2002,NUM_ENTER:2003});const dD=new Qs;class pD{get lastModified(){return this._lastModified}constructor(t,e,i){void 0===i&&(i=0),this._point=new Qs,this._prevPoint=new Qs,this._lastModified=0,this._id=0,this._startPoint=new Qs,this._startPointCaptured=!1,this.setTouchInfo(i,t,e)}getLocation(t){return t||(t=new Qs),t.set(this._point.x,this._point.y),t}getLocationX(){return this._point.x}getLocationY(){return this._point.y}getUILocation(t){return t||(t=new Qs),t.set(this._point.x,this._point.y),h.view._convertToUISpace(t),t}getUILocationX(){const t=h.view,e=t.getViewportRect();return(this._point.x-e.x)/t.getScaleX()}getUILocationY(){const t=h.view,e=t.getViewportRect();return(this._point.y-e.y)/t.getScaleY()}getPreviousLocation(t){return t||(t=new Qs),t.set(this._prevPoint.x,this._prevPoint.y),t}getUIPreviousLocation(t){return t||(t=new Qs),t.set(this._prevPoint.x,this._prevPoint.y),h.view._convertToUISpace(t),t}getStartLocation(t){return t||(t=new Qs),t.set(this._startPoint.x,this._startPoint.y),t}getUIStartLocation(t){return t||(t=new Qs),t.set(this._startPoint.x,this._startPoint.y),h.view._convertToUISpace(t),t}getDelta(t){return t||(t=new Qs),t.set(this._point),t.subtract(this._prevPoint),t}getUIDelta(t){t||(t=new Qs),dD.set(this._point),dD.subtract(this._prevPoint);const e=h.view;return t.set(e.getScaleX(),e.getScaleY()),Qs.divide(t,dD,t),t}getLocationInView(t){return t||(t=new Qs),t.set(this._point.x,h.view._designResolutionSize.height-this._point.y),t}getPreviousLocationInView(t){return t||(t=new Qs),t.set(this._prevPoint.x,h.view._designResolutionSize.height-this._prevPoint.y),t}getStartLocationInView(t){return t||(t=new Qs),t.set(this._startPoint.x,h.view._designResolutionSize.height-this._startPoint.y),t}getID(){return this._id}setTouchInfo(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this._prevPoint=this._point,this._point=new Qs(e||0,i||0),this._id=t,this._startPointCaptured||(this._startPoint=new Qs(this._point),this._startPointCaptured=!0)}setPoint(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=h.game.frameStartTime}setPrevPoint(t,e){this._prevPoint="object"==typeof t?new Qs(t.x,t.y):new Qs(t||0,e||0),this._lastModified=h.game.frameStartTime}clone(){const t=this.getID();this.getStartLocation(dD);const e=new pD(dD.x,dD.y,t);return this.getLocation(dD),e.setPoint(dD.x,dD.y),this.getPreviousLocation(dD),e.setPrevPoint(dD),e}}t("Touch",pD),h.Touch=pD;class _D{constructor(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new An,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,zn.browserType===Pn.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}_registerEvent(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)}_unregisterEvent(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)}_didAccelerate(t){const e=performance.now();if(e-this._accelTimer<this._intervalInMileSeconds)return;this._accelTimer=e;let i=0,s=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){const e=t.accelerationIncludingGravity;i=.1*((null==e?void 0:e.x)||0),s=.1*((null==e?void 0:e.y)||0),r=.1*((null==e?void 0:e.z)||0)}else{const e=t;i=(e.gamma||0)/90*.981,s=-(e.beta||0)/90*.981,r=(e.alpha||0)/90*.981}if(Un.isFrameRotated){const t=i;i=-s,s=t}const n=i;90===window.orientation?(i=-s,s=n):-90===window.orientation?(i=s,s=-n):180===window.orientation&&(i=-i,s=-s),zn.os===On.ANDROID&&zn.browserType!==Pn.MOBILE_QQ&&(i=-i,s=-s);const o=performance.now(),a=new cD(i,s,r,o),h=new iD(a);this._eventTarget.emit("devicemotion",h)}start(){window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((t=>{"granted"===t&&this._registerEvent()})).catch((t=>{P(t)})):this._registerEvent()}stop(){this._unregisterEvent()}setInterval(t){this._intervalInMileSeconds=t}on(t,e,i){this._eventTarget.on(t,e,i)}}class gD{}class fD extends gD{getValue(){throw new Error("Method not implemented.")}}class mD extends gD{getValue(){throw new Error("Method not implemented.")}}class yD extends gD{getValue(){throw new Error("Method not implemented.")}}class vD extends gD{getValue(){throw new Error("Method not implemented.")}}class bD extends fD{constructor(t){super(),this.positive=t.positive,this.negative=t.negative}getValue(){const t=this.positive.getValue(),e=this.negative.getValue();return Math.abs(t)>Math.abs(e)?t:-e}}class wD extends mD{constructor(t){super(),this.up=t.up,this.down=t.down,this.left=t.left,this.right=t.right,this.xAxis=new bD({positive:this.right,negative:this.left}),this.yAxis=new bD({positive:this.up,negative:this.down})}getValue(){return new Qs(this.xAxis.getValue(),this.yAxis.getValue())}}class SD extends fD{getValue(){return super.getValue()}}class xD extends wD{}class TD extends wD{}class CD extends vD{getValue(){return super.getValue()}}class ID extends yD{getValue(){return super.getValue()}}class ED extends fD{getValue(){return super.getValue()}}const DD="left",AD="right",MD=[];var PD,BD;!function(t){t[t.HAND_LEFT=1]="HAND_LEFT",t[t.HAND_RIGHT=4]="HAND_RIGHT",t[t.AIM_LEFT=2]="AIM_LEFT",t[t.AIM_RIGHT=5]="AIM_RIGHT"}(PD||(PD={}));class RD{get buttonNorth(){return this._buttonNorth}get buttonEast(){return this._buttonEast}get buttonWest(){return this._buttonWest}get buttonSouth(){return this._buttonSouth}get buttonL1(){return this._buttonL1}get buttonL2(){return this._buttonL2}get buttonL3(){return this._buttonL3}get buttonR1(){return this._buttonR1}get buttonR2(){return this._buttonR2}get buttonR3(){return this._buttonR3}get buttonShare(){return this._buttonShare}get buttonOptions(){return this._buttonOptions}get dpad(){return this._dpad}get leftStick(){return this._leftStick}get rightStick(){return this._rightStick}get buttonStart(){return this._buttonStart}get gripLeft(){return this._gripLeft}get gripRight(){return this._gripRight}get handLeftPosition(){return this._handLeftPosition}get handLeftOrientation(){return this._handLeftOrientation}get handRightPosition(){return this._handRightPosition}get handRightOrientation(){return this._handRightOrientation}get aimLeftPosition(){return this._aimLeftPosition}get aimLeftOrientation(){return this._aimLeftOrientation}get aimRightPosition(){return this._aimRightPosition}get aimRightOrientation(){return this._aimRightOrientation}get deviceId(){return this._deviceId}get connected(){return this._connected}constructor(t){this._deviceId=-1,this._connected=!1,this._webPoseState={[PD.HAND_LEFT]:{position:Ki.ZERO,orientation:ys.IDENTITY},[PD.HAND_RIGHT]:{position:Ki.ZERO,orientation:ys.IDENTITY},[PD.AIM_LEFT]:{position:Ki.ZERO,orientation:ys.IDENTITY},[PD.AIM_RIGHT]:{position:Ki.ZERO,orientation:ys.IDENTITY}},this._deviceId=t,this._initInputSource()}static _init(){zn.hasFeature(Fn.EVENT_GAMEPAD)&&RD._registerEvent()}static _on(t,e,i){RD._eventTarget.on(t,e,i)}static _removeInputDevice(t){const e=RD.all.findIndex((e=>e.deviceId===t));-1!==e&&Wt(RD.all,e)}static _getOrCreateInputDevice(t,e){let i=RD.all.find((e=>e.deviceId===t));return i||(i=new RD(t),RD.all.push(i)),i._connected=e,i}static _ensureDirectorDefined(t){RD._intervalId=setInterval((()=>{l.director&&l.Director&&(clearInterval(RD._intervalId),RD._intervalId=-1,t())}),50)}static _updateGamepadCnt(){let t=0;for(let e=0,i=RD._cachedWebGamepads.length;e<i;e++)RD._cachedWebGamepads[e]&&t++;RD._totalGamepadCnt=t}static _registerEvent(){RD._ensureDirectorDefined((()=>{RD._cachedWebGamepads=RD._getWebGamePads(),RD._updateGamepadCnt(),l.director.on(l.Director.EVENT_BEGIN_FRAME,RD._scanGamepads)})),window.addEventListener("gamepadconnected",(t=>{RD._cachedWebGamepads[t.gamepad.index]=t.gamepad,RD._updateGamepadCnt();const e=RD._getOrCreateInputDevice(t.gamepad.index,!0);RD._eventTarget.emit("gamepad-change",new aD("gamepad-change",e))})),window.addEventListener("gamepaddisconnected",(t=>{RD._cachedWebGamepads[t.gamepad.index]=null,RD._updateGamepadCnt();const e=RD._getOrCreateInputDevice(t.gamepad.index,!1);RD._removeInputDevice(t.gamepad.index),RD._eventTarget.emit("gamepad-change",new aD("gamepad-change",e))}))}static _scanWebGamepads(t){if(0===RD._totalGamepadCnt)return;const e=RD._getWebGamePads();if(e){for(let i=0;i<e.length;++i){const s=e[i];if(!s)continue;const r=RD._cachedWebGamepads[s.index];if(r){let e;const i=r.buttons;for(let t=0;t<i.length;++t){const r=i[t],n=s.buttons[t];if(Math.abs(r.value-n.value)>.01){e=RD._getOrCreateInputDevice(s.index,!0);break}}if(e){t.push(e);continue}const n=r.axes;for(let t=0;t<n.length;++t){const i=n[t],r=s.axes[t];if(Math.abs(i-r)>.01){e=RD._getOrCreateInputDevice(s.index,!0);break}}if(e){t.push(e);continue}}}RD._cachedWebGamepads=e}}static _scanGamepads(){MD.length=0,RD._scanWebGamepads(MD),RD._scanWebXRGamepads(MD);for(let t=0;t<MD.length;++t){const e=MD[t];RD._eventTarget.emit("gamepad-input",new aD("gamepad-input",e))}RD._scanWebXRGamepadsPose()}static _scanWebXRGamepads(t){var e,i;const s=RD._getWebXRGamepadMap();if(!s)return RD._cachedWebXRGamepadMap=null,void(RD.xr&&RD.xr._connected&&(RD.xr._connected=!1,RD._eventTarget.emit("gamepad-change",new aD("gamepad-change",RD.xr)),t.push(RD.xr)));RD.xr||(RD.xr=new RD(-1));const r=s.get(DD),n=s.get(AD);r||n?RD.xr._connected||(RD.xr._connected=!0,RD._eventTarget.emit("gamepad-change",new aD("gamepad-change",RD.xr))):RD.xr._connected&&(RD.xr._connected=!1,RD._eventTarget.emit("gamepad-change",new aD("gamepad-change",RD.xr))),(RD.checkGamepadChanged(r,null===(e=RD._cachedWebXRGamepadMap)||void 0===e?void 0:e.get(DD))||RD.checkGamepadChanged(n,null===(i=RD._cachedWebXRGamepadMap)||void 0===i?void 0:i.get(AD)))&&t.push(RD.xr),RD._cachedWebXRGamepadMap||(RD._cachedWebXRGamepadMap=new Map),RD._cachedWebXRGamepadMap.set(DD,RD._copyCacheGamepadValue(r)),RD._cachedWebXRGamepadMap.set(AD,RD._copyCacheGamepadValue(n))}static checkGamepadChanged(t,e){if(!t&&!e)return!1;if(!t||!e)return!0;const i=e.buttons;for(let e=0;e<i.length;++e){const s=i[e];if(0!==t.buttons[e].value||0!==s)return!0}const s=e.axes;for(let e=0;e<s.length;++e){const i=s[e];if(0!==t.axes[e]||0!==i)return!0}return!1}static _copyCacheGamepadValue(t){if(!t)return;const e={buttons:new Array(t.buttons.length),axes:new Array(t.axes.length)};for(let i=0;i<t.buttons.length;++i)e.buttons[i]=t.buttons[i].value;for(let i=0;i<t.axes.length;++i)e.axes[i]=t.axes[i];return e}static _scanWebXRGamepadsPose(){var t;const e=null===(t=globalThis.__globalXR)||void 0===t?void 0:t.webxrHandlePoseInfos;if(e&&RD.xr){for(let t=0;t<e.length;++t){const i=e[t];RD.xr._updateWebPoseState(i)}RD._eventTarget.emit("handle-pose-input",new aD("handle-pose-input",RD.xr))}}static _getWebXRGamepadMap(){var t;return null===(t=globalThis.__globalXR)||void 0===t?void 0:t.webxrGamepadMap}static _getWebGamePads(){return"function"==typeof navigator.getGamepads?navigator.getGamepads():"function"==typeof navigator.webkitGetGamepads?navigator.webkitGetGamepads():[]}static _getWebGamepad(t){const e=RD._getWebGamePads();for(let i=0;i<e.length;++i){const s=e[i];if(s&&s.index===t)return s}}_axisToButtons(t){const e=Math.abs(t);return t>0?{negative:0,positive:e}:t<0?{negative:e,positive:0}:{negative:0,positive:0}}_updateWebPoseState(t){t.code!==PD.HAND_LEFT&&t.code!==PD.AIM_LEFT&&t.code!==PD.HAND_RIGHT&&t.code!==PD.AIM_RIGHT||(this._webPoseState[t.code]={position:new Ki(t.position.x,t.position.y,t.position.z),orientation:new ys(t.orientation.x,t.orientation.y,t.orientation.z,t.orientation.w)})}_initInputSource(){this._buttonNorth=new SD,this._buttonNorth.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(DD);return e&&e.buttons.length>5?e.buttons[5].value:0}const e=RD._getWebGamepad(this.deviceId);return e?e.buttons[3].value:0},this._buttonEast=new SD,this._buttonEast.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(AD);return e&&e.buttons.length>5?e.buttons[5].value:0}const e=RD._getWebGamepad(this.deviceId);return e?e.buttons[1].value:0},this._buttonWest=new SD,this._buttonWest.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(DD);return e&&e.buttons.length>4?e.buttons[4].value:0}const e=RD._getWebGamepad(this.deviceId);return e?e.buttons[2].value:0},this._buttonSouth=new SD,this._buttonSouth.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(AD);return e&&e.buttons.length>4?e.buttons[4].value:0}const e=RD._getWebGamepad(this.deviceId);return e?e.buttons[0].value:0},this._buttonL1=new SD,this._buttonL1.getValue=()=>{const t=RD._getWebGamepad(this.deviceId);return t?t.buttons[4].value:0},this._buttonL2=new SD,this._buttonL2.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(DD);return e&&e.buttons.length>0?e.buttons[0].value:0}const e=RD._getWebGamepad(this.deviceId);return e?e.buttons[6].value:0},this._buttonL3=new SD,this._buttonL3.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(DD);if(e){if(e.buttons.length>3&&0!==e.buttons[3].value)return e.buttons[3].value;if(e.buttons.length>2&&0!==e.buttons[2].value)return e.buttons[2].value}return 0}const e=RD._getWebGamepad(this.deviceId);return e?e.buttons[10].value:0},this._buttonR1=new SD,this._buttonR1.getValue=()=>{const t=RD._getWebGamepad(this.deviceId);return t?t.buttons[5].value:0},this._buttonR2=new SD,this._buttonR2.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(AD);return e&&e.buttons.length>0?e.buttons[0].value:0}const e=RD._getWebGamepad(this.deviceId);return e?e.buttons[7].value:0},this._buttonR3=new SD,this._buttonR3.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(AD);if(e){if(e.buttons.length>3&&0!==e.buttons[3].value)return e.buttons[3].value;if(e.buttons.length>2&&0!==e.buttons[2].value)return e.buttons[2].value}return 0}const e=RD._getWebGamepad(this.deviceId);return e?e.buttons[11].value:0},this._buttonShare=new SD,this._buttonShare.getValue=()=>{const t=RD._getWebGamepad(this.deviceId);return t?t.buttons[8].value:0},this._buttonOptions=new SD,this._buttonOptions.getValue=()=>{const t=RD._getWebGamepad(this.deviceId);return t?t.buttons[9].value:0};const t=new SD;t.getValue=()=>{const t=RD._getWebGamepad(this.deviceId);return t?t.buttons[12].value:0};const e=new SD;e.getValue=()=>{const t=RD._getWebGamepad(this.deviceId);return t?t.buttons[13].value:0};const i=new SD;i.getValue=()=>{const t=RD._getWebGamepad(this.deviceId);return t?t.buttons[14].value:0};const s=new SD;s.getValue=()=>{const t=RD._getWebGamepad(this.deviceId);return t?t.buttons[15].value:0},this._dpad=new xD({up:t,down:e,left:i,right:s});const r=new SD;r.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(DD);if(e){if(e.axes.length>3&&0!==e.axes[3])return this._axisToButtons(e.axes[3]).negative;if(e.axes.length>1&&0!==e.axes[1])return this._axisToButtons(e.axes[1]).negative}return 0}const e=RD._getWebGamepad(this.deviceId);return e?this._axisToButtons(e.axes[1]).negative:0};const n=new SD;n.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(DD);if(e){if(e.axes.length>3&&0!==e.axes[3])return this._axisToButtons(e.axes[3]).positive;if(e.axes.length>1&&0!==e.axes[1])return this._axisToButtons(e.axes[1]).positive}return 0}const e=RD._getWebGamepad(this.deviceId);return e?this._axisToButtons(e.axes[1]).positive:0};const o=new SD;o.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(DD);if(e){if(e.axes.length>2&&0!==e.axes[2])return this._axisToButtons(e.axes[2]).negative;if(e.axes.length>0&&0!==e.axes[0])return this._axisToButtons(e.axes[0]).negative}return 0}const e=RD._getWebGamepad(this.deviceId);return e?this._axisToButtons(e.axes[0]).negative:0};const a=new SD;a.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(DD);if(e){if(e.axes.length>2&&0!==e.axes[2])return this._axisToButtons(e.axes[2]).positive;if(e.axes.length>0&&0!==e.axes[0])return this._axisToButtons(e.axes[0]).positive}return 0}const e=RD._getWebGamepad(this.deviceId);return e?this._axisToButtons(e.axes[0]).positive:0},this._leftStick=new TD({up:r,down:n,left:o,right:a});const h=new SD;h.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(AD);if(e){if(e.axes.length>3&&0!==e.axes[3])return this._axisToButtons(e.axes[3]).negative;if(e.axes.length>1&&0!==e.axes[1])return this._axisToButtons(e.axes[1]).negative}return 0}const e=RD._getWebGamepad(this.deviceId);return e?this._axisToButtons(e.axes[3]).negative:0};const l=new SD;l.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(AD);if(e){if(e.axes.length>3&&0!==e.axes[3])return this._axisToButtons(e.axes[3]).positive;if(e.axes.length>1&&0!==e.axes[1])return this._axisToButtons(e.axes[1]).positive}return 0}const e=RD._getWebGamepad(this.deviceId);return e?this._axisToButtons(e.axes[3]).positive:0};const c=new SD;c.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(AD);if(e){if(e.axes.length>2&&0!==e.axes[2])return this._axisToButtons(e.axes[2]).negative;if(e.axes.length>0&&0!==e.axes[0])return this._axisToButtons(e.axes[0]).negative}return 0}const e=RD._getWebGamepad(this.deviceId);return e?this._axisToButtons(e.axes[2]).negative:0};const u=new SD;u.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(AD);if(e){if(e.axes.length>2&&0!==e.axes[2])return this._axisToButtons(e.axes[2]).positive;if(e.axes.length>0&&0!==e.axes[0])return this._axisToButtons(e.axes[0]).positive}return 0}const e=RD._getWebGamepad(this.deviceId);return e?this._axisToButtons(e.axes[2]).positive:0},this._rightStick=new TD({up:h,down:l,left:c,right:u}),this._buttonStart=new SD,this._buttonStart.getValue=()=>0,this._gripLeft=new SD,this._gripLeft.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(DD);if(e&&e.buttons.length>1)return e.buttons[1].value}return 0},this._gripRight=new SD,this._gripRight.getValue=()=>{if(-1===this.deviceId){var t;const e=null===(t=RD._getWebXRGamepadMap())||void 0===t?void 0:t.get(AD);if(e&&e.buttons.length>1)return e.buttons[1].value}return 0},this._handLeftPosition=new ID,this._handLeftPosition.getValue=()=>this._webPoseState[PD.HAND_LEFT].position,this._handLeftOrientation=new CD,this._handLeftOrientation.getValue=()=>this._webPoseState[PD.HAND_LEFT].orientation,this._handRightPosition=new ID,this._handRightPosition.getValue=()=>this._webPoseState[PD.HAND_RIGHT].position,this._handRightOrientation=new CD,this._handRightOrientation.getValue=()=>this._webPoseState[PD.HAND_RIGHT].orientation,this._aimLeftPosition=new ID,this._aimLeftPosition.getValue=()=>this._webPoseState[PD.AIM_LEFT].position,this._aimLeftOrientation=new CD,this._aimLeftOrientation.getValue=()=>this._webPoseState[PD.AIM_LEFT].orientation,this._aimRightPosition=new ID,this._aimRightPosition.getValue=()=>this._webPoseState[PD.AIM_RIGHT].position,this._aimRightOrientation=new CD,this._aimRightOrientation.getValue=()=>this._webPoseState[PD.AIM_RIGHT].orientation}}let OD;var LD,FD,zD;RD.all=[],RD.xr=null,RD._eventTarget=new An,RD._cachedWebGamepads=[],RD._cachedWebXRGamepadMap=null,RD._intervalId=-1,RD._totalGamepadCnt=0,function(t){t[t.BUTTON_EAST=0]="BUTTON_EAST",t[t.BUTTON_SOUTH=1]="BUTTON_SOUTH",t[t.BUTTON_WEST=2]="BUTTON_WEST",t[t.BUTTON_NORTH=3]="BUTTON_NORTH",t[t.BUTTON_TRIGGER_LEFT=4]="BUTTON_TRIGGER_LEFT",t[t.BUTTON_TRIGGER_RIGHT=5]="BUTTON_TRIGGER_RIGHT",t[t.TRIGGER_LEFT=6]="TRIGGER_LEFT",t[t.TRIGGER_RIGHT=7]="TRIGGER_RIGHT",t[t.GRIP_LEFT=8]="GRIP_LEFT",t[t.GRIP_RIGHT=9]="GRIP_RIGHT",t[t.BUTTON_LEFT_STICK=10]="BUTTON_LEFT_STICK",t[t.LEFT_STICK_UP=11]="LEFT_STICK_UP",t[t.LEFT_STICK_DOWN=12]="LEFT_STICK_DOWN",t[t.LEFT_STICK_LEFT=13]="LEFT_STICK_LEFT",t[t.LEFT_STICK_RIGHT=14]="LEFT_STICK_RIGHT",t[t.BUTTON_RIGHT_STICK=15]="BUTTON_RIGHT_STICK",t[t.RIGHT_STICK_UP=16]="RIGHT_STICK_UP",t[t.RIGHT_STICK_DOWN=17]="RIGHT_STICK_DOWN",t[t.RIGHT_STICK_LEFT=18]="RIGHT_STICK_LEFT",t[t.RIGHT_STICK_RIGHT=19]="RIGHT_STICK_RIGHT",t[t.ROKID_MENU=20]="ROKID_MENU",t[t.ROKID_START=21]="ROKID_START"}(BD||(BD={})),function(t){t[t.KET_CLICK=0]="KET_CLICK",t[t.KET_STICK=1]="KET_STICK",t[t.KET_GRAB=2]="KET_GRAB",t[t.KET_TOUCH=3]="KET_TOUCH"}(OD||(OD={})),function(t){t[t.UNDEFINE=0]="UNDEFINE",t[t.A=1]="A",t[t.B=2]="B",t[t.X=3]="X",t[t.Y=4]="Y",t[t.L1=5]="L1",t[t.R1=6]="R1",t[t.MINUS=7]="MINUS",t[t.PLUS=8]="PLUS",t[t.L3=9]="L3",t[t.R3=10]="R3",t[t.MENU=11]="MENU",t[t.START=12]="START",t[t.TRIGGER_LEFT=13]="TRIGGER_LEFT",t[t.TRIGGER_RIGHT=14]="TRIGGER_RIGHT"}(LD||(LD={})),function(t){t[t.UNDEFINE=0]="UNDEFINE",t[t.X=1]="X",t[t.Y=2]="Y",t[t.LEFT_STICK_X=3]="LEFT_STICK_X",t[t.LEFT_STICK_Y=4]="LEFT_STICK_Y",t[t.RIGHT_STICK_X=5]="RIGHT_STICK_X",t[t.RIGHT_STICK_Y=6]="RIGHT_STICK_Y",t[t.L2=7]="L2",t[t.R2=8]="R2",t[t.LEFT_GRIP=9]="LEFT_GRIP",t[t.RIGHT_GRIP=10]="RIGHT_GRIP"}(FD||(FD={})),function(t){t[t.UNDEFINE=0]="UNDEFINE",t[t.A=1]="A",t[t.B=2]="B",t[t.X=3]="X",t[t.Y=4]="Y",t[t.LEFT_TRIGGER=5]="LEFT_TRIGGER",t[t.RIGHT_TRIGGER=6]="RIGHT_TRIGGER",t[t.LEFT_THUMBSTICK=7]="LEFT_THUMBSTICK",t[t.RIGHT_THUMBSTICK=8]="RIGHT_THUMBSTICK"}(zD||(zD={}));const kD={1:BD.BUTTON_EAST,2:BD.BUTTON_SOUTH,3:BD.BUTTON_NORTH,4:BD.BUTTON_WEST,9:BD.BUTTON_LEFT_STICK,10:BD.BUTTON_RIGHT_STICK,11:BD.ROKID_MENU,12:BD.ROKID_START,13:BD.BUTTON_TRIGGER_LEFT,14:BD.BUTTON_TRIGGER_RIGHT};class ND{get buttonNorth(){return this._buttonNorth}get buttonEast(){return this._buttonEast}get buttonWest(){return this._buttonWest}get buttonSouth(){return this._buttonSouth}get buttonTriggerLeft(){return this._buttonTriggerLeft}get buttonTriggerRight(){return this._buttonTriggerRight}get triggerLeft(){return this._triggerLeft}get triggerRight(){return this._triggerRight}get gripLeft(){return this._gripLeft}get gripRight(){return this._gripRight}get leftStick(){return this._leftStick}get rightStick(){return this._rightStick}get buttonLeftStick(){return this._buttonLeftStick}get buttonRightStick(){return this._buttonRightStick}get buttonOptions(){return this._buttonOptions}get buttonStart(){return this._buttonStart}get handLeftPosition(){return this._handLeftPosition}get handLeftOrientation(){return this._handLeftOrientation}get handRightPosition(){return this._handRightPosition}get handRightOrientation(){return this._handRightOrientation}get aimLeftPosition(){return this._aimLeftPosition}get aimLeftOrientation(){return this._aimLeftOrientation}get aimRightPosition(){return this._aimRightPosition}get aimRightOrientation(){return this._aimRightOrientation}get touchButtonA(){return this._touchButtonA}get touchButtonB(){return this._touchButtonB}get touchButtonX(){return this._touchButtonX}get touchButtonY(){return this._touchButtonY}get touchButtonTriggerLeft(){return this._touchButtonTriggerLeft}get touchButtonTriggerRight(){return this._touchButtonTriggerRight}get touchButtonThumbStickLeft(){return this._touchButtonThumbStickLeft}get touchButtonThumbStickRight(){return this._touchButtonThumbStickRight}constructor(){this._eventTarget=new An,this._nativeButtonState={[BD.BUTTON_SOUTH]:0,[BD.BUTTON_EAST]:0,[BD.BUTTON_WEST]:0,[BD.BUTTON_NORTH]:0,[BD.BUTTON_TRIGGER_LEFT]:0,[BD.BUTTON_TRIGGER_RIGHT]:0,[BD.TRIGGER_LEFT]:0,[BD.TRIGGER_RIGHT]:0,[BD.GRIP_LEFT]:0,[BD.GRIP_RIGHT]:0,[BD.LEFT_STICK_UP]:0,[BD.LEFT_STICK_DOWN]:0,[BD.LEFT_STICK_LEFT]:0,[BD.LEFT_STICK_RIGHT]:0,[BD.RIGHT_STICK_UP]:0,[BD.RIGHT_STICK_DOWN]:0,[BD.RIGHT_STICK_LEFT]:0,[BD.RIGHT_STICK_RIGHT]:0,[BD.BUTTON_LEFT_STICK]:0,[BD.BUTTON_RIGHT_STICK]:0,[BD.ROKID_MENU]:0,[BD.ROKID_START]:0},this._nativeTouchState={[zD.UNDEFINE]:0,[zD.A]:0,[zD.B]:0,[zD.X]:0,[zD.Y]:0,[zD.LEFT_TRIGGER]:0,[zD.RIGHT_TRIGGER]:0,[zD.LEFT_THUMBSTICK]:0,[zD.RIGHT_THUMBSTICK]:0},this._initInputSource(),window.addEventListener("xr-remote-input",(t=>{const e=t,i=e.detail.keyEventType,s=e.detail.stickAxisCode,r=e.detail.stickAxisValue,n=e.detail.stickKeyCode,o=e.detail.isButtonPressed,a=e.detail.touchCode,h=e.detail.touchValue;if(i===OD.KET_CLICK){const t=kD[n];this._nativeButtonState[t]=o?1:0}else if(i===OD.KET_STICK||i===OD.KET_GRAB){let t,e,i;switch(s){case FD.LEFT_STICK_X:t=BD.LEFT_STICK_LEFT,e=BD.LEFT_STICK_RIGHT,i=this._axisToButtons(r);break;case FD.LEFT_STICK_Y:t=BD.LEFT_STICK_DOWN,e=BD.LEFT_STICK_UP,i=this._axisToButtons(r);break;case FD.RIGHT_STICK_X:t=BD.RIGHT_STICK_LEFT,e=BD.RIGHT_STICK_RIGHT,i=this._axisToButtons(r);break;case FD.RIGHT_STICK_Y:t=BD.RIGHT_STICK_DOWN,e=BD.RIGHT_STICK_UP,i=this._axisToButtons(r);break;case FD.L2:this._nativeButtonState[BD.TRIGGER_LEFT]=r;break;case FD.R2:this._nativeButtonState[BD.TRIGGER_RIGHT]=r;break;case FD.LEFT_GRIP:this._nativeButtonState[BD.GRIP_LEFT]=r;break;case FD.RIGHT_GRIP:this._nativeButtonState[BD.GRIP_RIGHT]=r}t&&e&&i&&(this._nativeButtonState[t]=i.negative,this._nativeButtonState[e]=i.positive)}else if(i===OD.KET_TOUCH)switch(a){case zD.A:case zD.B:case zD.X:case zD.Y:case zD.LEFT_TRIGGER:case zD.RIGHT_TRIGGER:case zD.LEFT_THUMBSTICK:case zD.RIGHT_THUMBSTICK:this._nativeTouchState[a]=h}this._eventTarget.emit("handle-input",new hD("handle-input",this))}))}_axisToButtons(t){const e=Math.abs(t);return t>0?{negative:0,positive:e}:t<0?{negative:e,positive:0}:{negative:0,positive:0}}_on(t,e,i){this._eventTarget.on(t,e,i)}_initInputSource(){this._buttonNorth=new SD,this._buttonNorth.getValue=()=>this._nativeButtonState[BD.BUTTON_NORTH],this._buttonEast=new SD,this._buttonEast.getValue=()=>this._nativeButtonState[BD.BUTTON_EAST],this._buttonWest=new SD,this._buttonWest.getValue=()=>this._nativeButtonState[BD.BUTTON_WEST],this._buttonSouth=new SD,this._buttonSouth.getValue=()=>this._nativeButtonState[BD.BUTTON_SOUTH],this._buttonTriggerLeft=new SD,this._buttonTriggerLeft.getValue=()=>this._nativeButtonState[BD.BUTTON_TRIGGER_LEFT],this._buttonTriggerRight=new SD,this._buttonTriggerRight.getValue=()=>this._nativeButtonState[BD.BUTTON_TRIGGER_RIGHT],this._triggerLeft=new SD,this._triggerLeft.getValue=()=>this._nativeButtonState[BD.TRIGGER_LEFT],this._triggerRight=new SD,this._triggerRight.getValue=()=>this._nativeButtonState[BD.TRIGGER_RIGHT],this._gripLeft=new SD,this._gripLeft.getValue=()=>this._nativeButtonState[BD.GRIP_LEFT],this._gripRight=new SD,this._gripRight.getValue=()=>this._nativeButtonState[BD.GRIP_RIGHT],this._buttonLeftStick=new SD,this._buttonLeftStick.getValue=()=>this._nativeButtonState[BD.BUTTON_LEFT_STICK];const t=new SD;t.getValue=()=>this._nativeButtonState[BD.LEFT_STICK_UP];const e=new SD;e.getValue=()=>this._nativeButtonState[BD.LEFT_STICK_DOWN];const i=new SD;i.getValue=()=>this._nativeButtonState[BD.LEFT_STICK_LEFT];const s=new SD;s.getValue=()=>this._nativeButtonState[BD.LEFT_STICK_RIGHT],this._leftStick=new TD({up:t,down:e,left:i,right:s}),this._buttonRightStick=new SD,this._buttonRightStick.getValue=()=>this._nativeButtonState[BD.BUTTON_RIGHT_STICK];const r=new SD;r.getValue=()=>this._nativeButtonState[BD.RIGHT_STICK_UP];const n=new SD;n.getValue=()=>this._nativeButtonState[BD.RIGHT_STICK_DOWN];const o=new SD;o.getValue=()=>this._nativeButtonState[BD.RIGHT_STICK_LEFT];const a=new SD;a.getValue=()=>this._nativeButtonState[BD.RIGHT_STICK_RIGHT],this._rightStick=new TD({up:r,down:n,left:o,right:a}),this._buttonOptions=new SD,this._buttonOptions.getValue=()=>this._nativeButtonState[BD.ROKID_MENU],this._buttonStart=new SD,this._buttonStart.getValue=()=>this._nativeButtonState[BD.ROKID_START],this._handLeftPosition=new ID,this._handLeftPosition.getValue=()=>Ki.ZERO,this._handLeftOrientation=new CD,this._handLeftOrientation.getValue=()=>ys.IDENTITY,this._handRightPosition=new ID,this._handRightPosition.getValue=()=>Ki.ZERO,this._handRightOrientation=new CD,this._handRightOrientation.getValue=()=>ys.IDENTITY,this._aimLeftPosition=new ID,this._aimLeftPosition.getValue=()=>Ki.ZERO,this._aimLeftOrientation=new CD,this._aimLeftOrientation.getValue=()=>ys.IDENTITY,this._aimRightPosition=new ID,this._aimRightPosition.getValue=()=>Ki.ZERO,this._aimRightOrientation=new CD,this._aimRightOrientation.getValue=()=>ys.IDENTITY,this._touchButtonA=new ED,this._touchButtonA.getValue=()=>this._nativeTouchState[zD.A],this._touchButtonB=new ED,this._touchButtonB.getValue=()=>this._nativeTouchState[zD.B],this._touchButtonX=new ED,this._touchButtonX.getValue=()=>this._nativeTouchState[zD.X],this._touchButtonY=new ED,this._touchButtonY.getValue=()=>this._nativeTouchState[zD.Y],this._touchButtonTriggerLeft=new ED,this._touchButtonTriggerLeft.getValue=()=>this._nativeTouchState[zD.LEFT_TRIGGER],this._touchButtonTriggerRight=new ED,this._touchButtonTriggerRight.getValue=()=>this._nativeTouchState[zD.RIGHT_TRIGGER],this._touchButtonThumbStickLeft=new ED,this._touchButtonThumbStickLeft.getValue=()=>this._nativeTouchState[zD.LEFT_THUMBSTICK],this._touchButtonThumbStickRight=new ED,this._touchButtonThumbStickRight.getValue=()=>this._nativeTouchState[zD.RIGHT_THUMBSTICK]}}var UD;!function(t){t[t.VIEW_LEFT=0]="VIEW_LEFT",t[t.VIEW_RIGHT=3]="VIEW_RIGHT",t[t.HEAD_MIDDLE=6]="HEAD_MIDDLE"}(UD||(UD={}));class VD{get viewLeftPosition(){return this._viewLeftPosition}get viewLeftOrientation(){return this._viewLeftOrientation}get viewRightPosition(){return this._viewRightPosition}get viewRightOrientation(){return this._viewRightOrientation}get headMiddlePosition(){return this._headMiddlePosition}get headMiddleOrientation(){return this._headMiddleOrientation}constructor(){this._eventTarget=new An,this._intervalId=-1,this._webPoseState={[UD.VIEW_LEFT]:{position:Ki.ZERO,orientation:ys.IDENTITY},[UD.VIEW_RIGHT]:{position:Ki.ZERO,orientation:ys.IDENTITY},[UD.HEAD_MIDDLE]:{position:Ki.ZERO,orientation:ys.IDENTITY}},this._initInputSource(),this._registerEvent()}_ensureDirectorDefined(){return new Promise((t=>{this._intervalId=setInterval((()=>{l.director&&l.Director&&(clearInterval(this._intervalId),this._intervalId=-1,t())}),50)}))}_registerEvent(){this._ensureDirectorDefined().then((()=>{l.director.on(l.Director.EVENT_BEGIN_FRAME,this._scanHmd,this)})).catch((()=>{}))}_scanHmd(){var t;const e=null===(t=globalThis.__globalXR)||void 0===t?void 0:t.webxrHmdPoseInfos;if(e){for(let t=0;t<e.length;++t){const i=e[t];this._updateWebPoseState(i)}this._eventTarget.emit("hmd-pose-input",new lD("hmd-pose-input",this))}}_on(t,e,i){this._eventTarget.on(t,e,i)}_updateWebPoseState(t){t.code!==UD.VIEW_LEFT&&t.code!==UD.VIEW_RIGHT&&t.code!==UD.HEAD_MIDDLE||(this._webPoseState[t.code]={position:new Ki(t.position.x,t.position.y,t.position.z),orientation:new ys(t.orientation.x,t.orientation.y,t.orientation.z,t.orientation.w)})}_initInputSource(){this._viewLeftPosition=new ID,this._viewLeftPosition.getValue=()=>this._webPoseState[UD.VIEW_LEFT].position,this._viewLeftOrientation=new CD,this._viewLeftOrientation.getValue=()=>this._webPoseState[UD.VIEW_LEFT].orientation,this._viewRightPosition=new ID,this._viewRightPosition.getValue=()=>this._webPoseState[UD.VIEW_RIGHT].position,this._viewRightOrientation=new CD,this._viewRightOrientation.getValue=()=>this._webPoseState[UD.VIEW_RIGHT].orientation,this._headMiddlePosition=new ID,this._headMiddlePosition.getValue=()=>this._webPoseState[UD.HEAD_MIDDLE].position,this._headMiddleOrientation=new CD,this._headMiddleOrientation.getValue=()=>this._webPoseState[UD.HEAD_MIDDLE].orientation}}class HD{get handheldPosition(){return this._handheldPosition}get handheldOrientation(){return this._handheldOrientation}constructor(){this._eventTarget=new An,this._initInputSource()}_on(t,e,i){this._eventTarget.on(t,e,i)}_initInputSource(){this._handheldPosition=new ID,this._handheldPosition.getValue=()=>Ki.ZERO,this._handheldOrientation=new CD,this._handheldOrientation.getValue=()=>ys.IDENTITY}}const GD={Backspace:8,Tab:9,Enter:13,ShiftLeft:16,ControlLeft:17,AltLeft:18,ShiftRight:2e3,ControlRight:2001,AltRight:2002,Pause:19,CapsLock:20,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40,Insert:45,Delete:46,Digit0:48,Digit1:49,Digit2:50,Digit3:51,Digit4:52,Digit5:53,Digit6:54,Digit7:55,Digit8:56,Digit9:57,KeyA:65,KeyB:66,KeyC:67,KeyD:68,KeyE:69,KeyF:70,KeyG:71,KeyH:72,KeyI:73,KeyJ:74,KeyK:75,KeyL:76,KeyM:77,KeyN:78,KeyO:79,KeyP:80,KeyQ:81,KeyR:82,KeyS:83,KeyT:84,KeyU:85,KeyV:86,KeyW:87,KeyX:88,KeyY:89,KeyZ:90,Numpad0:96,Numpad1:97,Numpad2:98,Numpad3:99,Numpad4:100,Numpad5:101,Numpad6:102,Numpad7:103,Numpad8:104,Numpad9:105,NumpadMultiply:106,NumpadAdd:107,NumpadSubtract:109,NumpadDecimal:110,NumpadDivide:111,NumpadEnter:2003,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NumLock:144,ScrollLock:145,Semicolon:186,Equal:187,Comma:188,Minus:189,Period:190,Slash:191,Backquote:192,BracketLeft:219,Backslash:220,BracketRight:221,Quote:222};class WD{constructor(){this._eventTarget=new An,this._registerEvent()}dispatchKeyboardDownEvent(t){this._handleKeyboardDown(t)}dispatchKeyboardUpEvent(t){this._handleKeyboardUp(t)}on(t,e,i){this._eventTarget.on(t,e,i)}_registerEvent(){const t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",this._handleKeyboardDown.bind(this)),null==t||t.addEventListener("keyup",this._handleKeyboardUp.bind(this))}_getInputEvent(t,e){const i=(s=t.code,GD[s]||0);var s;return new sD(i,e)}_handleKeyboardDown(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){const e=this._getInputEvent(t,"key-pressing");this._eventTarget.emit("key-pressing",e)}else{const e=this._getInputEvent(t,"keydown");this._eventTarget.emit("keydown",e)}}_handleKeyboardUp(t){const e=this._getInputEvent(t,"keyup");t.stopPropagation(),t.preventDefault(),this._eventTarget.emit("keyup",e)}}class jD{constructor(){this._canvas=void 0,this._eventTarget=new An,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Qs,this._handleMouseDown=void 0,this._handleMouseMove=void 0,this._handleMouseUp=void 0,zn.hasFeature(Fn.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||P("failed to access canvas"),this._handleMouseDown=this._createCallback("mouse-down"),this._handleMouseMove=this._createCallback("mouse-move"),this._handleMouseUp=this._createCallback("mouse-up"),this._registerEvent())}dispatchMouseDownEvent(t){this._handleMouseDown(t)}dispatchMouseMoveEvent(t){this._handleMouseMove(t)}dispatchMouseUpEvent(t){this._handleMouseUp(t)}dispatchScrollEvent(t){this._handleMouseWheel(t)}on(t,e,i){this._eventTarget.on(t,e,i)}_getCanvasRect(){const t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new Cr(e.x,e.y,e.width,e.height):new Cr(0,0,0,0)}_getLocation(t){const e=this._getCanvasRect(),i=Un.devicePixelRatio;let s=this._pointLocked?this._preMousePos.x/i+t.movementX:t.clientX-e.x,r=this._pointLocked?this._preMousePos.y/i-t.movementY:e.y+e.height-t.clientY;return s*=i,r*=i,new Qs(s,r)}_registerEvent(){var t,e,i,s,r,n;window.addEventListener("mousedown",(()=>{this._isPressed=!0})),null===(t=this._canvas)||void 0===t||t.addEventListener("mousedown",this._handleMouseDown),null===(e=this._canvas)||void 0===e||e.addEventListener("mousemove",this._handleMouseMove),window.addEventListener("mouseup",this._handleMouseUp),null===(i=this._canvas)||void 0===i||i.addEventListener("mouseup",this._handleMouseUp),null===(s=this._canvas)||void 0===s||s.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent(),null===(r=this._canvas)||void 0===r||r.addEventListener("mouseleave",this._handleMouseLeave.bind(this)),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseenter",this._handleMouseEnter.bind(this))}_registerPointerLockEvent(){const t=()=>{const t=this._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?this._pointLocked=!0:this._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)}_createCallback(t){return e=>{var i;const s=this._getLocation(e),{button:r,buttons:n}=e;let o=r;switch(t){case"mouse-down":null===(i=this._canvas)||void 0===i||i.focus(),this._isPressed=!0;break;case"mouse-up":this._isPressed=!1;break;case"mouse-move":o=1&n?rD.BUTTON_LEFT:2&n?rD.BUTTON_RIGHT:4&n?rD.BUTTON_MIDDLE:rD.BUTTON_MISSING}const a=new rD(t,!1,this._preMousePos);a.setLocation(s.x,s.y),a.setButton(o),a.movementX=e.movementX,a.movementY=e.movementY,this._preMousePos.set(s.x,s.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,a)}}_handleMouseWheel(t){const e="mouse-wheel",i=this._getLocation(t),s=t.button,r=new rD(e,!1,this._preMousePos);r.setLocation(i.x,i.y),r.setButton(s),r.movementX=t.movementX,r.movementY=t.movementY,r.setScrollData(5*t.deltaX,5*-t.deltaY),this._preMousePos.set(i.x,i.y),t.stopPropagation(),t.target===this._canvas&&t.preventDefault(),this._eventTarget.emit(e,r)}_handleMouseLeave(t){const e="mouse-leave-window",i=new rD(e,!1);this._eventTarget.emit(e,i)}_handleMouseEnter(t){const e="mouse-enter-window",i=new rD(e,!1);this._eventTarget.emit(e,i)}dispatchEventsInCache(){}}const $D=new Qs,qD=new class{constructor(){this._touchMap=new Map,this._maxTouches=8}_createTouch(t,e,i){if(this._touchMap.has(t))return void N(2301);if(this._checkTouchMapSizeMoreThanMax(t))return void N(2300);const s=new pD(e,i,t);return this._touchMap.set(t,s),this._updateTouch(s,e,i),s}releaseTouch(t){this._touchMap.has(t)&&this._touchMap.delete(t)}getTouch(t){return this._touchMap.get(t)}getOrCreateTouch(t,e,i){let s=this.getTouch(t);return s?this._updateTouch(s,e,i):s=this._createTouch(t,e,i),s}getAllTouches(){const t=[];return this._touchMap.forEach((e=>{e&&t.push(e)})),t}getTouchCount(){return this._touchMap.size}_updateTouch(t,e,i){t.getLocation($D),t.setPrevPoint($D),t.setPoint(e,i)}_checkTouchMapSizeMoreThanMax(t){if(this._touchMap.has(t))return!1;const e=le.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<e)return!1;const i=performance.now();return this._touchMap.forEach((t=>{i-t.lastModified>le.TOUCH_TIMEOUT&&(N(2302,t.getID()),this.releaseTouch(t.getID()))})),e>=this._touchMap.size}};class XD{constructor(){this._canvas=void 0,this._eventTarget=new An,zn.hasFeature(Fn.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||P("failed to access canvas"),this._registerEvent())}_registerEvent(){var t,e,i,s;null===(t=this._canvas)||void 0===t||t.addEventListener("touchstart",this._createCallback("touch-start")),null===(e=this._canvas)||void 0===e||e.addEventListener("touchmove",this._createCallback("touch-move")),null===(i=this._canvas)||void 0===i||i.addEventListener("touchend",this._createCallback("touch-end")),null===(s=this._canvas)||void 0===s||s.addEventListener("touchcancel",this._createCallback("touch-cancel"))}_createCallback(t){return e=>{const i=this._getCanvasRect(),s=[],r=e.changedTouches.length;for(let n=0;n<r;++n){const r=e.changedTouches[n],o=r.identifier;if(null===o)continue;const a=this._getLocation(r,i),h=qD.getOrCreateTouch(o,a.x,a.y);h&&("touch-end"!==t&&"touch-cancel"!==t||qD.releaseTouch(o),s.push(h))}var n;if(e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),"touch-start"===t&&(null===(n=this._canvas)||void 0===n||n.focus()),s.length>0){const e=new oD(s,!1,t,qD.getAllTouches());this._eventTarget.emit(t,e)}}}_getCanvasRect(){const t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new Cr(e.x,e.y,e.width,e.height):new Cr(0,0,0,0)}_getLocation(t,e){if(globalThis.__globalXR&&globalThis.__globalXR.ar&&globalThis.__globalXR.ar.isWebXR())return new Qs(t.clientX,t.clientY);let i=t.clientX-e.x,s=e.y+e.height-t.clientY;if(Un.isFrameRotated){const t=i;i=e.height-s,s=t}const r=Un.devicePixelRatio;return i*=r,s*=r,new Qs(i,s)}on(t,e,i){this._eventTarget.on(t,e,i)}dispatchEventsInCache(){}}class YD{constructor(t){this.priority=0,this._inputEventTarget=t}onThrowException(){}dispatchEvent(t){return this._inputEventTarget.emit(t.type,t),!0}}const QD={"mouse-down":"touch-start","mouse-move":"touch-move","mouse-up":"touch-end"};class KD{constructor(){this._eventTarget=new An,this._touchInput=new XD,this._mouseInput=new jD,this._keyboardInput=new WD,this._accelerometerInput=new _D,this._handleInput=new ND,this._hmdInput=new VD,this._handheldInput=new HD,this._eventKeyboardList=[],this._eventAccelerationList=[],this._eventGamepadList=[],this._eventHandleList=[],this._eventHMDList=[],this._eventHandheldList=[],this._needSimulateTouchMoveEvent=!1,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new YD(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher),RD._init()}_dispatchMouseDownEvent(t){var e,i;null===(e=(i=this._mouseInput).dispatchMouseDownEvent)||void 0===e||e.call(i,t)}_dispatchMouseMoveEvent(t){var e,i;null===(e=(i=this._mouseInput).dispatchMouseMoveEvent)||void 0===e||e.call(i,t)}_dispatchMouseUpEvent(t){var e,i;null===(e=(i=this._mouseInput).dispatchMouseUpEvent)||void 0===e||e.call(i,t)}_dispatchMouseScrollEvent(t){var e,i;null===(e=(i=this._mouseInput).dispatchScrollEvent)||void 0===e||e.call(i,t)}_dispatchKeyboardDownEvent(t){var e,i;null===(e=(i=this._keyboardInput).dispatchKeyboardDownEvent)||void 0===e||e.call(i,t)}_dispatchKeyboardUpEvent(t){var e,i;null===(e=(i=this._keyboardInput).dispatchKeyboardUpEvent)||void 0===e||e.call(i,t)}on(t,e,i){return this._eventTarget.on(t,e,i),e}once(t,e,i){return this._eventTarget.once(t,e,i),e}off(t,e,i){this._eventTarget.off(t,e,i)}getTouch(t){return qD.getTouch(t)}getAllTouches(){return qD.getAllTouches()}getTouchCount(){return qD.getTouchCount()}setAccelerometerEnabled(t){t?this._accelerometerInput.start():this._accelerometerInput.stop()}setAccelerometerInterval(t){this._accelerometerInput.setInterval(t)}_simulateEventTouch(t){const e=QD[t.type],i=qD.getOrCreateTouch(0,t.getLocationX(),t.getLocationY());if(!i)return;const s=[i],r=new oD(s,!1,e,"touch-end"===e?[]:s);r.windowId=t.windowId,"touch-end"===e&&qD.releaseTouch(0),this._dispatchEventTouch(r)}_registerEventDispatcher(t){this._eventDispatcherList.push(t),this._eventDispatcherList.sort(((t,e)=>e.priority-t.priority))}_emitEvent(t){const e=this._eventDispatcherList.length;for(let i=0;i<e;++i){const e=this._eventDispatcherList[i];try{if(!e.dispatchEvent(t))break}catch(t){throw this._clearEvents(),e.onThrowException(),t}}}_registerEvent(){if(Hn.hasFeature(Hn.Feature.INPUT_TOUCH)&&(this._touchInput.on("touch-start",(t=>{this._dispatchEventTouch(t)})),this._touchInput.on("touch-move",(t=>{this._dispatchEventTouch(t)})),this._touchInput.on("touch-end",(t=>{this._dispatchEventTouch(t)})),this._touchInput.on("touch-cancel",(t=>{this._dispatchEventTouch(t)}))),Hn.hasFeature(Hn.Feature.EVENT_MOUSE)&&(this._mouseInput.on("mouse-down",(t=>{this._needSimulateTouchMoveEvent=!0,this._simulateEventTouch(t),this._dispatchEventMouse(t)})),this._mouseInput.on("mouse-move",(t=>{this._needSimulateTouchMoveEvent&&this._simulateEventTouch(t),this._dispatchEventMouse(t)})),this._mouseInput.on("mouse-up",(t=>{this._needSimulateTouchMoveEvent=!1,this._simulateEventTouch(t),this._dispatchEventMouse(t)})),this._mouseInput.on("mouse-wheel",(t=>{this._dispatchEventMouse(t)})),this._mouseInput.on("mouse-leave-window",(t=>{this._dispatchEventMouse(t)})),this._mouseInput.on("mouse-enter-window",(t=>{this._dispatchEventMouse(t)}))),Hn.hasFeature(Hn.Feature.EVENT_KEYBOARD)){const t=this._eventKeyboardList;this._keyboardInput.on("keydown",(e=>{this._dispatchOrPushEvent(e,t)})),this._keyboardInput.on("key-pressing",(e=>{this._dispatchOrPushEvent(e,t)})),this._keyboardInput.on("keyup",(e=>{this._dispatchOrPushEvent(e,t)}))}if(Hn.hasFeature(Hn.Feature.EVENT_ACCELEROMETER)){const t=this._eventAccelerationList;this._accelerometerInput.on("devicemotion",(e=>{this._dispatchOrPushEvent(e,t)}))}if(Hn.hasFeature(Hn.Feature.EVENT_GAMEPAD)){const t=this._eventGamepadList;RD._on("gamepad-change",(e=>{this._dispatchOrPushEvent(e,t)})),RD._on("gamepad-input",(e=>{this._dispatchOrPushEvent(e,t)})),RD._on("handle-pose-input",(e=>{this._dispatchOrPushEvent(e,t)}))}if(Hn.hasFeature(Hn.Feature.EVENT_HANDLE)){const t=this._eventHandleList;this._handleInput._on("handle-input",(e=>{this._dispatchOrPushEvent(e,t)})),this._handleInput._on("handle-pose-input",(e=>{this._dispatchOrPushEvent(e,t)}))}if(Hn.hasFeature(Hn.Feature.EVENT_HMD)){const t=this._eventHMDList;this._hmdInput._on("hmd-pose-input",(e=>{this._dispatchOrPushEvent(e,t)}))}if(Hn.hasFeature(Hn.Feature.EVENT_HANDHELD)){const t=this._eventHandheldList;this._handheldInput._on("handheld-pose-input",(e=>{this._dispatchOrPushEvent(e,t)}))}}_clearEvents(){this._eventKeyboardList.length=0,this._eventAccelerationList.length=0,this._eventGamepadList.length=0,this._eventHandleList.length=0,this._eventHMDList.length=0}_dispatchOrPushEvent(t,e){this._emitEvent(t)}_dispatchEventMouse(t){this._emitEvent(t)}_dispatchEventTouch(t){const e=t.getTouches(),i=e.length;for(let s=0;s<i;++s)t.touch=e[s],t.propagationStopped=t.propagationImmediateStopped=!1,this._emitEvent(t)}_frameDispatchEvents(){}}t("Input",KD),KD.EventType={TOUCH_START:"touch-start",TOUCH_MOVE:"touch-move",TOUCH_END:"touch-end",TOUCH_CANCEL:"touch-cancel",MOUSE_DOWN:"mouse-down",MOUSE_MOVE:"mouse-move",MOUSE_UP:"mouse-up",MOUSE_LEAVE:"mouse-leave-window",MOUSE_ENTER:"mouse-enter-window",MOUSE_WHEEL:"mouse-wheel",KEY_DOWN:"keydown",KEY_PRESSING:"key-pressing",KEY_UP:"keyup",DEVICEMOTION:"devicemotion",GAMEPAD_INPUT:"gamepad-input",GAMEPAD_CHANGE:"gamepad-change",HANDLE_INPUT:"handle-input",HANDLE_POSE_INPUT:"handle-pose-input",HMD_POSE_INPUT:"hmd-pose-input",HANDHELD_POSE_INPUT:"handheld-pose-input"};const ZD=t("input",new KD);class JD extends An{constructor(){super(),ZD.on("mouse-down",(t=>{this.emit("mouse-down",t)})),ZD.on("mouse-move",(t=>{this.emit("mouse-move",t)})),ZD.on("mouse-up",(t=>{this.emit("mouse-up",t)})),ZD.on("mouse-wheel",(t=>{this.emit("mouse-wheel",t)})),ZD.on("touch-start",(t=>{this.emit("touch-start",t.touch,t)})),ZD.on("touch-move",(t=>{this.emit("touch-move",t.touch,t)})),ZD.on("touch-end",(t=>{this.emit("touch-end",t.touch,t)})),ZD.on("touch-cancel",(t=>{this.emit("touch-cancel",t.touch,t)})),ZD.on("keydown",(t=>{this.emit("keydown",t)})),ZD.on("key-pressing",(t=>{this.emit("keydown",t)})),ZD.on("keyup",(t=>{this.emit("keyup",t)})),ZD.on("devicemotion",(t=>{this.emit("devicemotion",t)}))}setAccelerometerEnabled(t){ZD.setAccelerometerEnabled(t)}setAccelerometerInterval(t){ZD.setAccelerometerInterval(t)}on(t,e,i,s){return super.on(t,e,i,s),e}off(t,e,i){super.off(t,e,i)}}t("SystemEvent",JD),JD.EventType=uD,h.SystemEvent=JD;const tA=t("systemEvent",new JD);h.systemEvent=tA;const eA={VERTICAL:0,HORIZONTAL:1},iA={ORTHO:0,PERSPECTIVE:1},sA={F1_8:0,F2_0:1,F2_2:2,F2_5:3,F2_8:4,F3_2:5,F3_5:6,F4_0:7,F4_5:8,F5_0:9,F5_6:10,F6_3:11,F7_1:12,F8_0:13,F9_0:14,F10_0:15,F11_0:16,F13_0:17,F14_0:18,F16_0:19,F18_0:20,F20_0:21,F22_0:22},rA={ISO100:0,ISO200:1,ISO400:2,ISO800:3},nA={D1:0,D2:1,D4:2,D8:3,D15:4,D30:5,D60:6,D125:7,D250:8,D500:9,D1000:10,D2000:11,D4000:12},oA=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],aA=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],hA=[100,200,400,800],lA=new Ki,cA=new Ki,uA=new Rs,dA=[];let pA=0,_A=class{static get standardExposureValue(){return 1/38400}static get standardLightMeterScale(){return 1e4}get name(){return this._name}get scene(){return this._scene}set node(t){this._node=t}get node(){return this._node}get systemWindowId(){return this._windowId}set window(t){this._window=t}get window(){return this._window}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set visibility(t){this._visibility=t}get visibility(){return this._visibility}get priority(){return this._priority}set priority(t){this._priority=t}get width(){return this._width}get height(){return this._height}set position(t){this._position=t}get position(){return this._position}set forward(t){this._forward=t}get forward(){return this._forward}set aperture(t){this._aperture=t,this._apertureValue=oA[this._aperture],this.updateExposure()}get aperture(){return this._aperture}get apertureValue(){return this._apertureValue}set shutter(t){this._shutter=t,this._shutterValue=aA[this._shutter],this.updateExposure()}get shutter(){return this._shutter}get shutterValue(){return this._shutterValue}set iso(t){this._iso=t,this._isoValue=hA[this._iso],this.updateExposure()}get iso(){return this._iso}get isoValue(){return this._isoValue}get exposure(){return this._exposure}get clearFlag(){return this._clearFlag}set clearFlag(t){this._clearFlag=t}set clearColor(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}get clearColor(){return this._clearColor}get clearDepth(){return this._clearDepth}set clearDepth(t){this._clearDepth=t}get clearStencil(){return this._clearStencil}set clearStencil(t){this._clearStencil=t}set projectionType(t){this._proj=t,this._isProjDirty=!0}get projectionType(){return this._proj}get aspect(){return this._aspect}set orthoHeight(t){this._orthoHeight=t,this._isProjDirty=!0}get orthoHeight(){return this._orthoHeight}set fovAxis(t){this._fovAxis=t,this._isProjDirty=!0}get fovAxis(){return this._fovAxis}set fov(t){this._fov=t,this._isProjDirty=!0}get fov(){return this._fov}set nearClip(t){this._nearClip=t,this._isProjDirty=!0}get nearClip(){return this._nearClip}set farClip(t){this._farClip=t,this._isProjDirty=!0}get farClip(){return this._farClip}get viewport(){return this._viewport}set viewport(t){G(8302),this.setViewportInOrientedSpace(t)}set frustum(t){this._frustum=t}get frustum(){return this._frustum}get matView(){return this._matView}get matProj(){return this._matProj}get matProjInv(){return this._matProjInv}get matViewProj(){return this._matViewProj}get matViewProjInv(){return this._matViewProjInv}get cameraId(){return this._cameraId}constructor(t){if(this.isWindowSize=!0,this.screenScale=1,this.postProcess=null,this.usePostProcess=!1,this.pipeline="",this.pipelineSettings=null,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=1,this._orthoHeight=10,this._fovAxis=0,this._fov=vi(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Sd(.2,.2,.2,1),this._viewport=Ir(0,0,1,1),this._orientedViewport=Ir(0,0,1,1),this._curTransform=0,this._isProjDirty=!0,this._matView=Fs(),this._matProj=Fs(),this._matProjInv=Fs(),this._matViewProj=Fs(),this._matViewProjInv=Fs(),this._frustum=new eo,this._forward=Zi(),this._position=Zi(),this._priority=0,this._aperture=19,this._shutter=7,this._shutterValue=0,this._iso=0,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=0,this._clearDepth=1,this._visibility=Fy,this._exposure=0,this._clearStencil=0,this._geometryRenderer=null,this._windowId=0,this._cameraType=-1,this._trackingType=0,this._usage=100,this._cameraId=pA++,this._device=t,this._apertureValue=oA[this._aperture],this._shutterValue=aA[this._shutter],this._isoValue=hA[this._iso],this._frustum.accurate=!0,!dA.length){const e=t.capabilities.clipSpaceSignY;dA[0]=new Rs(1,0,0,0,0,e),dA[1]=new Rs(0,1,0,0,-e,0),dA[2]=new Rs(-1,0,0,0,0,-e),dA[3]=new Rs(0,-1,0,0,e,0)}}_updateAspect(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){const t=this.window.swapchain;(t&&t.surfaceTransform||0)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0}initialize(t){void 0!==t.usage?this._usage=t.usage:this.setDefaultUsage(),void 0!==t.trackingType&&(this._trackingType=t.trackingType),void 0!==t.cameraType&&(this._cameraType=t.cameraType),this.node=t.node,this._width=1,this._height=1,this.clearFlag=0,this.clearDepth=1,this.visibility=Fy,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)}destroy(){var t;this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,null===(t=this._geometryRenderer)||void 0===t||t.destroy()}attachToScene(t){this._enabled=!0,this._scene=t}detachFromScene(){this._enabled=!1,this._scene=null}resize(t,e){this._window&&(this._width=t,this._height=e,this._aspect=t*this._viewport.width/(e*this._viewport.height),this._isProjDirty=!0)}setFixedSize(t,e){this._width=t,this._height=e,this._updateAspect(),this.isWindowSize=!1}syncCameraEditor(t){}update(t){var e;if(void 0===t&&(t=!1),!this._node)return;let i=!1;const s=globalThis.__globalXR;if(s&&s.isWebXR&&s.webXRWindowMap&&s.updateViewport){const t=s.webXRMatProjs?1/s.webXRMatProjs.length:1,e=s.webXRWindowMap.get(this._window);this.setViewportInOrientedSpace(new Cr(t*e,0,t,1))}(this._node.hasChangedFlags||t)&&(Rs.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,Rs.multiply(this._matView,(new Rs).scale(this._node.worldScale),this._matView),this._node.getWorldPosition(this._position),i=!0);const r=null===(e=this.window)||void 0===e?void 0:e.swapchain,n=r&&r.surfaceTransform||0;if(this._isProjDirty||this._curTransform!==n){this._curTransform=n;const t=this._device.capabilities.clipSpaceSignY;if(1===this._proj)if(s&&s.isWebXR&&s.webXRWindowMap&&s.webXRMatProjs){const t=s.webXRWindowMap.get(this._window);this._matProj.set(s.webXRMatProjs[t])}else Rs.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,0===this._fovAxis,this._device.capabilities.clipSpaceMinZ,t,n);else{const e=this._orthoHeight*this._aspect,i=this._orthoHeight;Rs.ortho(this._matProj,-e,e,-i,i,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,t,n)}Rs.invert(this._matProjInv,this._matProj),i=!0,this._isProjDirty=!1}i&&(Rs.multiply(this._matViewProj,this._matProj,this._matView),Rs.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}get surfaceTransform(){return this._curTransform}setViewportInOrientedSpace(t){var e;const{x:i,width:s,height:r}=t,n=this._device.capabilities.screenSpaceSignY<0?1-t.y-r:t.y,o=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(o&&o.surfaceTransform||0){case 1:this._viewport.x=1-n-r,this._viewport.y=i,this._viewport.width=r,this._viewport.height=s;break;case 2:this._viewport.x=1-i-s,this._viewport.y=1-n-r,this._viewport.width=s,this._viewport.height=r;break;case 3:this._viewport.x=n,this._viewport.y=1-i-s,this._viewport.width=r,this._viewport.height=s;break;case 0:this._viewport.x=i,this._viewport.y=n,this._viewport.width=s,this._viewport.height=r}this._orientedViewport.x=i,this._orientedViewport.y=n,this._orientedViewport.width=s,this._orientedViewport.height=r,this.resize(this.width,this.height)}initGeometryRenderer(){if(!this._geometryRenderer){var t;const e=h.internal.GeometryRenderer;this._geometryRenderer=e?new e:null,null===(t=this._geometryRenderer)||void 0===t||t.activate(this._device)}}get geometryRenderer(){return this._geometryRenderer}get cameraType(){return this._cameraType}set cameraType(t){this._cameraType=t}get trackingType(){return this._trackingType}set trackingType(t){this._trackingType=t}get cameraUsage(){return this._usage}set cameraUsage(t){this._usage=t}changeTargetWindow(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);const e=t||h.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;const t=e.swapchain;(t&&t.surfaceTransform||0)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}}detachCamera(){this._window&&this._window.detachCamera(this)}screenPointToRay(t,e,i){if(!this._node)return null;const s=this.width,r=this.height,n=this._orientedViewport.x*s,o=this._orientedViewport.y*r,a=this._orientedViewport.width*s,h=this._orientedViewport.height*r,l=1===this._proj,c=this._device.capabilities.clipSpaceSignY,u=Is[this._curTransform];Ki.set(lA,(e-n)/a*2-1,(i-o)/h*2-1,l?1:-1);const{x:d,y:p}=lA;return lA.x=d*u[0]+p*u[2]*c,lA.y=d*u[1]+p*u[3]*c,Ki.transformMat4(l?lA:t.o,lA,this._matViewProjInv),l?(this._node.getWorldPosition(cA),qr.fromPoints(t,cA,lA)):Ki.transformQuat(t.d,Ki.FORWARD,this._node.worldRotation),t}screenToWorld(t,e){const i=this.width,s=this.height,r=this._orientedViewport.x*i,n=this._orientedViewport.y*s,o=this._orientedViewport.width*i,a=this._orientedViewport.height*s,h=this._device.capabilities.clipSpaceSignY,l=Is[this._curTransform];if(1===this._proj){Ki.set(t,(e.x-r)/o*2-1,(e.y-n)/a*2-1,1);const{x:i,y:s}=t;t.x=i*l[0]+s*l[2]*h,t.y=i*l[1]+s*l[3]*h,Ki.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(lA),Ki.lerp(t,lA,t,yi(this._nearClip/this._farClip,1,e.z))}else{Ki.set(t,(e.x-r)/o*2-1,(e.y-n)/a*2-1,2*e.z-1);const{x:i,y:s}=t;t.x=i*l[0]+s*l[2]*h,t.y=i*l[1]+s*l[3]*h,Ki.transformMat4(t,t,this._matViewProjInv)}return t}worldToScreen(t,e){const i=this._device.capabilities.clipSpaceSignY,s=Is[this._curTransform];Ki.transformMat4(t,e,this._matViewProj);const{x:r,y:n}=t;t.x=r*s[0]+n*s[2]*i,t.y=r*s[1]+n*s[3]*i;const o=this.width,a=this.height,h=this._orientedViewport.x*o,l=this._orientedViewport.y*a,c=this._orientedViewport.width*o,u=this._orientedViewport.height*a;return t.x=h+.5*(t.x+1)*c,t.y=l+.5*(t.y+1)*u,t.z=.5*t.z+.5,t}worldMatrixToScreen(t,e,i,s){Rs.multiply(t,this._matViewProj,e),Rs.multiply(t,dA[this._curTransform],t);const r=i/2,n=s/2;return Rs.identity(uA),Rs.transform(uA,uA,Ki.set(lA,r,n,0)),Rs.scale(uA,uA,Ki.set(lA,r,n,1)),Rs.multiply(t,uA,t),t}calculateObliqueMat(t){const e=new cr(Math.sign(t.x),Math.sign(t.y),1,1).transformMat4(this._matProjInv),i=new cr(this._matProj.m03,this._matProj.m07,this._matProj.m11,this._matProj.m15),s=2/cr.dot(t,e),r=t.multiplyScalar(s).subtract(i);this._matProj.m02=r.x,this._matProj.m06=r.y,this._matProj.m10=r.z,this._matProj.m14=r.w}getClipSpaceMinz(){return this._device.capabilities.clipSpaceMinZ}setExposure(t){this._exposure=.833333/2**t}updateExposure(){const t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)}setDefaultUsage(){this._usage=100}};const gA=new np(null);class fA{constructor(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=128,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._reflectionTex=null,this._reflectionSampler=null,this._instancedAttributeBlock={buffer:null,views:[],attributes:[]},this._instancedWorldMatrixIndex=-1,this._instancedSHIndex=-1,this._useReflectionProbeType=0}set passes(t){t.length>8?j(12004,8):(this._passes=t,this._flushPassInfo(),this._descriptorSet&&(this._descriptorSet.destroy(),gA.layout=t[0].localSetLayout,this._descriptorSet=this._device.createDescriptorSet(gA)))}get passes(){return this._passes}get shaders(){return this._shaders}set subMesh(t){this._inputAssembler.destroy(),this._inputAssembler=this._device.createInputAssembler(t.iaInfo),this._subMesh=t}get subMesh(){return this._subMesh}set priority(t){this._priority=t}get priority(){return this._priority}get inputAssembler(){return this._inputAssembler}get descriptorSet(){return this._descriptorSet}get worldBoundDescriptorSet(){return this._worldBoundDescriptorSet}get patches(){return this._patches}get instancedAttributeBlock(){return this._instancedAttributeBlock}set instancedWorldMatrixIndex(t){this._instancedWorldMatrixIndex=t}get instancedWorldMatrixIndex(){return this._instancedWorldMatrixIndex}set instancedSHIndex(t){this._instancedSHIndex=t}get instancedSHIndex(){return this._instancedSHIndex}set useReflectionProbeType(t){this._useReflectionProbeType=t}get useReflectionProbeType(){return this._useReflectionProbeType}initialize(t,e,i){void 0===i&&(i=null);const s=h.director.root;this._device=e_.gfxDevice,gA.layout=e[0].localSetLayout,this._inputAssembler=this._device.createInputAssembler(t.iaInfo),this._descriptorSet=this._device.createDescriptorSet(gA);const r=h.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass();if(r){const t=new np(null);t.layout=r.localSetLayout,this._worldBoundDescriptorSet=this._device.createDescriptorSet(t)}this._subMesh=t,this._patches=i?i.sort():null,this._passes=e,this._flushPassInfo(),this.priority=128;const n=h.rendering;if((!n||!n.enableEffectImport)&&e[0].phase===_w("reflection")||Gy()&&e[0].phaseID===n.getPhaseID(n.getPassID("default"),"reflection")){let t=s.mainWindow.width,e=s.mainWindow.height;const i=512;e<t?(t=i*t/e,e=i):(t=i,e=i*e/t),this._reflectionTex=this._device.createTexture(new Bd(1,13,35,t,e)),this.descriptorSet.bindTexture(13,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new Od(2,2,0,2,2,2)),this.descriptorSet.bindSampler(13,this._reflectionSampler),this.descriptorSet.bindTexture(14,this._reflectionTex)}}destroy(){var t;this._descriptorSet.destroy(),this._descriptorSet=null,this._inputAssembler.destroy(),this._inputAssembler=null,null===(t=this._worldBoundDescriptorSet)||void 0===t||t.destroy(),this._worldBoundDescriptorSet=null,this.priority=128,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null}update(){var t;for(let t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),null===(t=this._worldBoundDescriptorSet)||void 0===t||t.update()}onPipelineStateChanged(){const t=this._passes;if(t){for(let e=0;e<t.length;e++){const i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}onMacroPatchesStateChanged(t){if(!t&&!this._patches)return;if(t&&(t=t.sort(),this._patches&&t.length===this._patches.length)&&JSON.stringify(t)===JSON.stringify(this._patches))return;this._patches=t;const e=this._passes;if(e){for(let t=0;t<e.length;t++){const i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}onGeometryChanged(){if(!this._subMesh)return;const t=this._subMesh.drawInfo;if(this._inputAssembler&&t){const e=this._inputAssembler.drawInfo;Object.keys(t).forEach((i=>{e[i]=t[i]})),this._inputAssembler.drawInfo=e}}getInstancedAttributeIndex(t){const{attributes:e}=this.instancedAttributeBlock;for(let i=0;i<e.length;i++)if(e[i].name===t)return i;return-1}updateInstancedWorldMatrix(t,e){const i=this.instancedAttributeBlock.views,s=i[e],r=i[e+1],n=i[e+2];s[0]=t.m00,s[1]=t.m01,s[2]=t.m02,s[3]=t.m12,r[0]=t.m04,r[1]=t.m05,r[2]=t.m06,r[3]=t.m13,n[0]=t.m08,n[1]=t.m09,n[2]=t.m10,n[3]=t.m14}updateInstancedSH(t,e){const i=this.instancedAttributeBlock.views;let s=0;for(let r=e;r<e+3;r++)for(let e=0;e<4;e++)i[r][e]=t[s++]}UpdateInstancedAttributes(t){this.instancedWorldMatrixIndex=-1,this.instancedSHIndex=-1;const e=this.passes[0];if(!e.device.hasFeature(1))return;let i=0;for(let e=0;e<t.length;e++){const s=t[e];s.isInstanced&&(i+=mp[s.format].size)}const s=this.instancedAttributeBlock;s.buffer=new Uint8Array(i),s.views.length=s.attributes.length=0;let r=0;for(let e=0;e<t.length;e++){const i=t[e];if(!i.isInstanced)continue;const n=new Wd;n.format=i.format,n.name=i.name,n.isNormalized=i.isNormalized,n.location=i.location,s.attributes.push(n);const o=mp[i.format],a=new(Ip(o))(s.buffer.buffer,r,o.count);s.views.push(a),r+=o.size}1===e.batchingScheme&&e.getInstancedBuffer().destroy(),this.instancedWorldMatrixIndex=this.getInstancedAttributeIndex(Om),this.instancedSHIndex=this.getInstancedAttributeIndex(Lm)}_flushPassInfo(){const t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(let e=0,i=t.length;e<i;e++)this._shaders[e]=t[e].getShaderVariant(this.patches)}}}const mA=new Rs,yA=[{name:"CC_RECEIVE_SHADOW",value:!0}],vA=[{name:"CC_USE_LIGHTMAP",value:1}],bA=[{name:"CC_USE_LIGHTMAP",value:2}],wA=[{name:"CC_LIGHT_MAP_VERSION",value:2}],SA=[{name:"CC_USE_LIGHT_PROBE",value:!0}],xA=new Od(2,2,0,2,2,2),TA=new Od(2,2,2,2,2,2);class CA{get subModels(){return this._subModels}get inited(){return this._inited}get worldBounds(){return this._worldBounds}get modelBounds(){return this._modelBounds}get localBuffer(){return this._localBuffer}get localSHBuffer(){return this._localSHBuffer}get worldBoundBuffer(){return this._worldBoundBuffer}get updateStamp(){return this._updateStamp}get useLightProbe(){return this._useLightProbe}set useLightProbe(t){this._useLightProbe=t,this.onMacroPatchesStateChanged()}get tetrahedronIndex(){return this._tetrahedronIndex}set tetrahedronIndex(t){this._tetrahedronIndex=t}get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t}get receiveShadow(){return this._receiveShadow}set receiveShadow(t){this._receiveShadow=t,this.onMacroPatchesStateChanged()}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}get receiveDirLight(){return this._receiveDirLight}set receiveDirLight(t){this._receiveDirLight=t,this.onMacroPatchesStateChanged()}get node(){return this._node}set node(t){this._node=t}get transform(){return this._transform}set transform(t){this._transform=t}get visFlags(){return this._visFlags}set visFlags(t){this._visFlags=t}get enabled(){return this._enabled}set enabled(t){this._enabled=t}get priority(){return this._priority}set priority(t){this._priority=t}get bakeToReflectionProbe(){return this._bakeToReflectionProbe}set bakeToReflectionProbe(t){this._bakeToReflectionProbe=t}get reflectionProbeType(){return this._reflectionProbeType}set reflectionProbeType(t){this._reflectionProbeType=t;const e=this._subModels;for(let i=0;i<e.length;i++)e[i].useReflectionProbeType=t;this.onMacroPatchesStateChanged()}get reflectionProbeId(){return this._reflectionProbeId}set reflectionProbeId(t){this._reflectionProbeId=t}get reflectionProbeBlendId(){return this._reflectionProbeBlendId}set reflectionProbeBlendId(t){this._reflectionProbeBlendId=t}get reflectionProbeBlendWeight(){return this._reflectionProbeBlendWeight}set reflectionProbeBlendWeight(t){this._reflectionProbeBlendWeight=t}constructor(){this.type=0,this.scene=null,this.isDynamicBatching=!1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(56),this._localBuffer=null,this._localSHData=null,this._localSHBuffer=null,this._lightmap=null,this._lightmapUVParam=ur(),this._tetrahedronIndex=-1,this._lastWorldBoundCenter=Zi(1/0,1/0,1/0),this._useLightProbe=!1,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._receiveDirLight=!0,this._shadowBias=0,this._shadowNormalBias=0,this._reflectionProbeId=-1,this._reflectionProbeBlendId=-1,this._reflectionProbeBlendWeight=0,this._enabled=!0,this._visFlags=Kf.Enum.NONE,this._priority=0,this._bakeToReflectionProbe=!0,this._reflectionProbeType=0,this._device=e_.gfxDevice}initialize(){this._inited||(this._receiveShadow=!0,this.castShadow=!1,this.enabled=!0,this.visFlags=Kf.Enum.NONE,this._inited=!0,this._bakeToReflectionProbe=!0,this._reflectionProbeType=0)}destroy(){const t=this._subModels;for(let e=0;e<t.length;e++)this._subModels[e].destroy();this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._localSHBuffer&&(this._localSHBuffer.destroy(),this._localSHBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1}attachToScene(t){this.scene=t,this._localDataUpdated=!0}detachFromScene(){this.scene=null}updateTransform(t){const e=this.transform;if(e.hasChangedFlags||e.isTransformDirty()){e.updateWorldTransform(),this._localDataUpdated=!0;const t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}}updateWorldBound(){const t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;const e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}}updateUBOs(t){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].update();this._updateStamp=t,this.updateSHUBOs();const i=this.node.scene.globals.shadows.enabled&&this.node.scene.globals.shadows.type===Yw.Planar;if(!this._localDataUpdated)return;this._localDataUpdated=!1;const s=this.transform._mat;let r=!1;for(let t=0;t<e.length;t++){const i=e[t],n=i.instancedWorldMatrixIndex;n>=0?i.updateInstancedWorldMatrix(s,n):r=!0}(r||i)&&this._localBuffer&&(Rs.toArray(this._localData,s,0),Rs.invert(mA,s),Rs.transpose(mA,mA),Rs.toArray(this._localData,mA,16),this._localBuffer.update(this._localData))}invalidateLocalData(){this._localDataUpdated=!0}showTetrahedron(){return this.isLightProbeAvailable()}isLightProbeAvailable(){if(!this._useLightProbe)return!1;const t=h.director.root.pipeline.pipelineSceneData.lightProbes;return!(!t||t.empty()||!this._worldBounds)}updateSHBuffer(){if(!this._localSHData)return;const t=this._subModels;let e=!1;for(let i=0;i<t.length;i++){const s=t[i],r=s.instancedSHIndex;r>=0?s.updateInstancedSH(this._localSHData,r):e=!0}e&&this._localSHBuffer&&this._localSHBuffer.update(this._localSHData)}clearSHUBOs(){if(this._localSHData){for(let t=0;t<28;t++)this._localSHData[t]=0;this.updateSHBuffer()}}updateSHUBOs(){if(!this.isLightProbeAvailable())return;const t=this._worldBounds.center;if(t.equals(this._lastWorldBoundCenter,pi))return;const e=[],i=new cr,s=h.director.root.pipeline.pipelineSceneData.lightProbes;if(this._lastWorldBoundCenter.set(t),this._tetrahedronIndex=s.data.getInterpolationWeights(t,this._tetrahedronIndex,i),!s.data.getInterpolationSHCoefficients(this._tetrahedronIndex,i,e))return;if(!this._localSHData)return;const r=h.internal.SH;r.reduceRinging(e,s.reduceRinging),r.updateUBOData(this._localSHData,0,e),this.updateSHBuffer()}createBoundingShape(t,e){t&&e&&(this._modelBounds||(this._modelBounds=Qn.create()),this._worldBounds||(this._worldBounds=Qn.create()),Qn.fromPoints(this._modelBounds,t,e),this._worldBounds.copy(this._modelBounds))}_createSubModel(){return new fA}initSubModel(t,e,i){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,i.passes,this.getMacroPatches(t)),this._updateAttributesAndBinding(t)}setSubModelMesh(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)}setSubModelMaterial(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))}onGlobalPipelineStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onPipelineStateChanged()}onMacroPatchesStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))}onGeometryChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onGeometryChanged()}initLightingmap(t,e){this._lightmap=t,this._lightmapUVParam=e}updateLightingmap(t,e){cr.toArray(this._localData,e,32),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,this.onMacroPatchesStateChanged(),t||(t=pw.get("empty-texture"));const i=t.getGFXTexture();if(i){const e=this._device.getSampler(t.mipmaps.length>1?TA:xA),s=this._subModels;for(let t=0;t<s.length;t++){const{descriptorSet:r}=s[t];r.bindTexture(ly,i),r.bindSampler(ly,e),r.update()}}}updateReflectionProbeCubemap(t){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),t||(t=pw.get("default-cube-texture"));const e=t.getGFXTexture();if(e){const i=this._device.getSampler(t.getSamplerInfo()),s=this._subModels;for(let t=0;t<s.length;t++){const{descriptorSet:r}=s[t];r&&(r.bindSampler(Sy,i),r.bindTexture(Sy,e),r.update())}}}updateReflectionProbeBlendCubemap(t){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),t||(t=pw.get("default-cube-texture"));const e=t.getGFXTexture();if(e){const i=this._device.getSampler(t.getSamplerInfo()),s=this._subModels;for(let t=0;t<s.length;t++){const{descriptorSet:r}=s[t];r&&(r.bindSampler(Ry,i),r.bindTexture(Ry,e),r.update())}}}updateReflectionProbePlanarMap(t){this._localDataUpdated=!0,this.onMacroPatchesStateChanged();const e=this._device.getSampler(new Od(2,2,0,2,2,2));if(t||(t=pw.get("empty-texture").getGFXTexture()),t){const i=this._subModels;for(let s=0;s<i.length;s++){const{descriptorSet:r}=i[s];r&&(r.bindTexture(Iy,t),r.bindSampler(Iy,e),r.update())}}}updateReflectionProbeDataMap(t){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),t||(t=pw.get("empty-texture"));const e=t.getGFXTexture();if(e){const i=this._subModels;for(let s=0;s<i.length;s++){const{descriptorSet:r}=i[s];r&&(r.bindTexture(17,e),r.bindSampler(17,t.getGFXSampler()),r.update())}}}updateLocalShadowBias(){const t=this._localData;t[36]=this._shadowBias,t[37]=this._shadowNormalBias,this._localDataUpdated=!0}updateReflectionProbeId(){const t=this._localData;t[38]=this._reflectionProbeId,t[39]=this._reflectionProbeBlendId;let e=null,i=null;if(h.internal.reflectionProbeManager&&(e=h.internal.reflectionProbeManager.getProbeById(this._reflectionProbeId),i=h.internal.reflectionProbeManager.getProbeById(this._reflectionProbeBlendId)),e){if(1===e.probeType)t[40]=e.node.up.x,t[41]=e.node.up.y,t[42]=e.node.up.z,t[43]=1,t[44]=1,t[45]=0,t[46]=0,t[47]=1;else{t[40]=e.node.worldPosition.x,t[41]=e.node.worldPosition.y,t[42]=e.node.worldPosition.z,t[43]=0,t[44]=e.size.x,t[45]=e.size.y,t[46]=e.size.z;const i=e.isRGBE()?1e3:0;t[47]=e.cubemap?e.cubemap.mipmapLevel+i:1+i}if(3===this._reflectionProbeType||4===this._reflectionProbeType)if(i){t[48]=i.node.worldPosition.x,t[49]=i.node.worldPosition.y,t[50]=i.node.worldPosition.z,t[51]=this.reflectionProbeBlendWeight,t[52]=i.size.x,t[53]=i.size.y,t[54]=i.size.z;const e=i.isRGBE()?1e3:0;t[55]=i.cubemap?i.cubemap.mipmapLevel+e:1+e}else 4===this._reflectionProbeType&&(t[51]=this.reflectionProbeBlendWeight)}this._localDataUpdated=!0}getMacroPatches(t){let e=this.receiveShadow?yA:null;if(null!=this._lightmap&&this.node&&this.node.scene&&!this.node.scene.globals.disableLightmap){const t=this.node.scene.globals.bakedWithStationaryMainLight?bA:vA;e=e?e.concat(t):t,this.node.scene.globals.bakedWithHighpLightmap&&(e=e.concat(wA))}this._useLightProbe&&(e=e?e.concat(SA):SA);const i=[{name:"CC_USE_REFLECTION_PROBE",value:this._reflectionProbeType}];e=e?e.concat(i):i;const s=[{name:"CC_DISABLE_DIRECTIONAL_LIGHT",value:!this._receiveDirLight}];return e=e?e.concat(s):s,e}_updateAttributesAndBinding(t){const e=this._subModels[t];if(!e)return;this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initLocalSHDescriptors(t),this._updateLocalSHDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),e.worldBoundDescriptorSet&&this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);const i=[],s=new Set;for(const t of e.passes){const r=t.getShaderVariant(e.patches);for(const t of r.attributes)s.has(t.name)||(i.push(t),s.add(t.name))}this._updateInstancedAttributes(i,e)}_updateInstancedAttributes(t,e){e.UpdateInstancedAttributes(t),this._localDataUpdated=!0}_initLocalDescriptors(t){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Ed(18,1,224,224)))}_initLocalSHDescriptors(t){this._useLightProbe&&(this._localSHData||(this._localSHData=new Float32Array(28)),this._localSHBuffer||(this._localSHBuffer=this._device.createBuffer(new Ed(18,1,112,112))))}_initWorldBoundDescriptors(t){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new Ed(18,1,Rm.SIZE,Rm.SIZE)))}_updateLocalDescriptors(t,e){this._localBuffer&&e.bindBuffer(Bm.BINDING,this._localBuffer)}_updateLocalSHDescriptors(t,e){this._localSHBuffer&&e.bindBuffer($m.BINDING,this._localSHBuffer)}_updateWorldBoundDescriptors(t,e){this._worldBoundBuffer&&e.bindBuffer(Rm.BINDING,this._worldBoundBuffer)}}function IA(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);const i=e*e,s=(.860117757+.000154118254*e+1.28641212e-7*i)/(1+.000842420235*e+7.08145163e-7*i),r=(.317398726+422806245e-13*e+4.20481691e-8*i)/(1-289741816e-13*e+1.61456053e-7*i),n=2*s-8*r+4,o=3*s/n,a=2*r/n,h=1/a*o,l=1/a*(1-o-a);t.x=3.2404542*h-1.5371385+-.4985314*l,t.y=-.969266*h+1.8760108+.041556*l,t.z=.0556434*h-.2040259+1.0572252*l}const EA={DIRECTIONAL:0,SPHERE:1,SPOT:2,POINT:3,RANGED_DIRECTIONAL:4,UNKNOWN:5},DA=t=>4*Math.PI*Math.PI*t*t;let AA=class{constructor(){this._baked=!1,this._color=Zi(1,1,1),this._colorTemp=6550,this._colorTempRGB=Zi(1,1,1),this._finalColor=Zi(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=5,this._visibility=Fy}get baked(){return this._baked}set baked(t){this._baked=t}set color(t){this._color.set(t),this._useColorTemperature&&Ki.multiply(this._finalColor,this._color,this._colorTempRGB)}get color(){return this._color}set useColorTemperature(t){this._useColorTemperature=t,t&&Ki.multiply(this._finalColor,this._color,this._colorTempRGB)}get useColorTemperature(){return this._useColorTemperature}set colorTemperature(t){this._colorTemp=t,IA(this._colorTempRGB,this._colorTemp),this._useColorTemperature&&Ki.multiply(this._finalColor,this._color,this._colorTempRGB)}get colorTemperature(){return this._colorTemp}get colorTemperatureRGB(){return this._colorTempRGB}get finalColor(){return this._finalColor}set visibility(t){this._visibility=t}get visibility(){return this._visibility}set node(t){this._node=t,this._node&&(this._node.hasChangedFlags|=2)}get node(){return this._node}get type(){return this._type}get name(){return this._name}set name(t){this._name=t}get scene(){return this._scene}initialize(){this.color=Zi(1,1,1),this.colorTemperature=6550}attachToScene(t){this._scene=t}detachFromScene(){this._scene=null}destroy(){this._name=null,this._node=null}update(){}};const MA=new Ki(0,0,-1),PA=new Ki;let BA=class extends AA{set direction(t){Ki.normalize(this._dir,t)}get direction(){return this._dir}get illuminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR}set illuminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}get illuminanceHDR(){return this._illuminanceHDR}set illuminanceHDR(t){this._illuminanceHDR=t}get illuminanceLDR(){return this._illuminanceLDR}set illuminanceLDR(t){this._illuminanceLDR=t}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(t){this._shadowEnabled=t,this.activate()}get shadowPcf(){return this._shadowPcf}set shadowPcf(t){this._shadowPcf=t,this.activate()}get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t}get shadowSaturation(){return this._shadowSaturation}set shadowSaturation(t){this._shadowSaturation=t}get shadowDistance(){return this._shadowDistance}set shadowDistance(t){this._shadowDistance=Math.min(t,tS.MAX_FAR)}get shadowInvisibleOcclusionRange(){return this._shadowInvisibleOcclusionRange}set shadowInvisibleOcclusionRange(t){this._shadowInvisibleOcclusionRange=Math.min(t,tS.MAX_FAR)}get csmLevel(){return this._csmLevel}set csmLevel(t){this._csmLevel=t,this.activate()}get csmNeedUpdate(){return this._csmNeedUpdate}set csmNeedUpdate(t){this._csmNeedUpdate=t}get csmLayerLambda(){return this._csmLayerLambda}set csmLayerLambda(t){this._csmLayerLambda=t}get csmOptimizationMode(){return this._csmOptimizationMode}set csmOptimizationMode(t){this._csmOptimizationMode=t}get shadowFixedArea(){return this._shadowFixedArea}set shadowFixedArea(t){this._shadowFixedArea=t,this.activate()}get shadowNear(){return this._shadowNear}set shadowNear(t){this._shadowNear=t}get shadowFar(){return this._shadowFar}set shadowFar(t){this._shadowFar=Math.min(t,tS.MAX_FAR)}get shadowOrthoSize(){return this._shadowOrthoSize}set shadowOrthoSize(t){this._shadowOrthoSize=t}get csmLayersTransition(){return this._csmLayersTransition}set csmLayersTransition(t){this._csmLayersTransition=t,this.activate()}get csmTransitionRange(){return this._csmTransitionRange}set csmTransitionRange(t){this._csmTransitionRange=t}constructor(){super(),this._dir=new Ki(1,-1,-1),this._illuminanceHDR=Vw.SUN_ILLUM,this._illuminanceLDR=1,this._shadowEnabled=!1,this._shadowPcf=Qw.HARD,this._shadowBias=1e-5,this._shadowNormalBias=0,this._shadowSaturation=1,this._shadowDistance=50,this._shadowInvisibleOcclusionRange=200,this._csmLevel=Kw.LEVEL_4,this._csmNeedUpdate=!1,this._csmLayerLambda=.75,this._csmOptimizationMode=Zw.DisableRotationFix,this._csmLayersTransition=!1,this._csmTransitionRange=.05,this._shadowFixedArea=!1,this._shadowNear=.1,this._shadowFar=10,this._shadowOrthoSize=5,this._type=0}initialize(){super.initialize(),this.illuminance=Vw.SUN_ILLUM,this.direction=new Ki(1,-1,-1)}update(){this._node&&this._node.hasChangedFlags&&(this.direction=Ki.transformQuat(PA,MA,this._node.worldRotation))}activate(){const t=h.director.root,e=t.pipeline;this._shadowEnabled?(this._shadowFixedArea||!e.pipelineSceneData.csmSupported?e.macros.CC_DIR_LIGHT_SHADOW_TYPE=1:this.csmLevel>1&&e.pipelineSceneData.csmSupported?(e.macros.CC_DIR_LIGHT_SHADOW_TYPE=2,e.macros.CC_CASCADED_LAYERS_TRANSITION=this._csmLayersTransition):e.macros.CC_DIR_LIGHT_SHADOW_TYPE=1,e.macros.CC_DIR_SHADOW_PCF_TYPE=this._shadowPcf):e.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,t.onGlobalPipelineStateChanged()}},RA=class extends AA{get position(){return this._pos}set size(t){this._size=t}get size(){return this._size}set range(t){this._range=t,this._needUpdate=!0}get range(){return this._range}get luminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR}set luminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}get luminanceHDR(){return this._luminanceHDR}set luminanceHDR(t){this._luminanceHDR=t}set luminanceLDR(t){this._luminanceLDR=t}get aabb(){return this._aabb}constructor(){super(),this._needUpdate=!1,this._size=.15,this._range=1,this._luminanceHDR=0,this._luminanceLDR=0,this._pos=new Ki,this._aabb=Qn.create(),this._type=1}initialize(){super.initialize(),this.size=.15,this.range=1,this.luminanceHDR=1700/DA(.15),this.luminanceLDR=1}update(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);const t=this._range;Qn.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}}};const OA=new Ki(0,0,-1),LA=new ys,FA=new Rs,zA=new Rs,kA=new Rs,NA=new Rs;let UA=class extends AA{get position(){return this._pos}set size(t){this._size=t}get size(){return this._size}set range(t){this._range=t,this._needUpdate=!0}get range(){return this._range}get luminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR}set luminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}get luminanceHDR(){return this._luminanceHDR}set luminanceHDR(t){this._luminanceHDR=t}get luminanceLDR(){return this._luminanceLDR}set luminanceLDR(t){this._luminanceLDR=t}get direction(){return this._dir}get spotAngle(){return this._spotAngle}set spotAngle(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._needUpdate=!0}get angleAttenuationStrength(){return this._angleAttenuationStrength}set angleAttenuationStrength(t){this._angleAttenuationStrength=t,this._needUpdate=!0}get angle(){return this._angle}get aabb(){return this._aabb}get frustum(){return this._frustum}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(t){this._shadowEnabled=t}get shadowPcf(){return this._shadowPcf}set shadowPcf(t){this._shadowPcf=t}get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t}constructor(){super(),this._dir=new Ki(1,-1,-1),this._range=5,this._spotAngle=Math.cos(Math.PI/6),this._angleAttenuationStrength=0,this._pos=new Ki,this._aabb=Qn.create(),this._frustum=eo.create(),this._angle=0,this._needUpdate=!1,this._size=.15,this._luminanceHDR=0,this._luminanceLDR=0,this._shadowEnabled=!1,this._shadowPcf=Qw.HARD,this._shadowBias=1e-5,this._shadowNormalBias=0,this._type=2}initialize(){super.initialize(),this.size=.15,this.luminanceHDR=1700/DA(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._dir.set(new Ki(1,-1,-1))}update(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Ki.transformQuat(this._dir,OA,this._node.getWorldRotation(LA)),Ki.normalize(this._dir,this._dir),Qn.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(FA),Rs.invert(FA,FA),Rs.perspective(zA,this._angle,1,.001,this._range),Rs.multiply(kA,zA,FA),this._frustum.update(kA,NA),this._needUpdate=!1)}},VA=class extends AA{get position(){return this._pos}set range(t){this._range=t,this._needUpdate=!0}get range(){return this._range}get luminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR}set luminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}get luminanceHDR(){return this._luminanceHDR}set luminanceHDR(t){this._luminanceHDR=t}set luminanceLDR(t){this._luminanceLDR=t}get aabb(){return this._aabb}constructor(){super(),this._needUpdate=!1,this._range=1,this._luminanceHDR=0,this._luminanceLDR=0,this._pos=Zi(),this._aabb=Qn.create(),this._type=3}initialize(){super.initialize(),this.range=1,this.luminanceHDR=1700/DA(1),this.luminanceLDR=1}update(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);const t=this._range;Qn.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}}};const HA=new Ki(0,0,-1);let GA=class extends AA{get direction(){return this._dir}get right(){return this._right}get position(){return this._pos}get scale(){return this._scale}get illuminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR}set illuminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}get illuminanceHDR(){return this._illuminanceHDR}set illuminanceHDR(t){this._illuminanceHDR=t}get illuminanceLDR(){return this._illuminanceLDR}set illuminanceLDR(t){this._illuminanceLDR=t}constructor(){super(),this._dir=new Ki(0,0,-1),this._pos=new Ki(0,0,0),this._scale=new Ki(1,1,1),this._right=new Ki(1,0,0),this._illuminanceHDR=Vw.SUN_ILLUM,this._illuminanceLDR=1,this._type=4}initialize(){super.initialize(),this.illuminance=Vw.SUN_ILLUM}update(){this._node&&this._node.hasChangedFlags&&(this._node.getWorldPosition(this._pos),this._node.getWorldScale(this._scale),Ki.transformQuat(this._dir,HA,this._node.worldRotation),Ki.transformQuat(this._right,Ki.RIGHT,this._node.worldRotation))}};const WA={SKYBOX:14,SOLID_COLOR:7},jA={CUBE:0,PLANAR:1},$A=[new Ki(0,-90,0),new Ki(0,90,0),new Ki(90,0,0),new Ki(-90,0,0),new Ki(0,0,0),new Ki(0,180,0)];let qA=class{set probeType(t){this._probeType=t}get probeType(){return this._probeType}get resolution(){return this._resolution}set resolution(t){t!==this._resolution&&this.bakedCubeTextures.forEach((e=>{e.resize(t,t)})),this._resolution=t}set clearFlag(t){this._clearFlag=t,this.camera.clearFlag=this._clearFlag}get clearFlag(){return this._clearFlag}set backgroundColor(t){this._backgroundColor=t,this.camera.clearColor=this._backgroundColor}get backgroundColor(){return this._backgroundColor}get visibility(){return this._visibility}set visibility(t){this._visibility=t,this._camera.visibility=this._visibility}set size(t){this._size.set(t);const e=this.node.getWorldPosition();Qn.set(this._boundingBox,e.x,e.y,e.z,this._size.x,this._size.y,this._size.z)}get size(){return this._size}set cubemap(t){this._cubemap=t}get cubemap(){return this._cubemap}get node(){return this._node}get camera(){return this._camera}set needRefresh(t){this._needRefresh=t}get needRefresh(){return this._needRefresh}set needRender(t){this._needRender=t}get needRender(){return this._needRender}get boundingBox(){return this._boundingBox}set cameraNode(t){this._cameraNode=t}get cameraNode(){return this._cameraNode}set previewSphere(t){this._previewSphere=t}get previewSphere(){return this._previewSphere}set previewPlane(t){this._previewPlane=t}get previewPlane(){return this._previewPlane}constructor(t){this.bakedCubeTextures=[],this.realtimePlanarTexture=null,this._resolution=256,this._clearFlag=14,this._backgroundColor=new _r(0,0,0,255),this._visibility=Fy,this._probeType=0,this._cubemap=null,this._size=new Ki(1,1,1),this._camera=null,this._probeId=0,this._needRefresh=!1,this._needRender=!1,this._node=null,this._cameraNode=null,this._boundingBox=null,this._cameraWorldPos=Zi(),this._cameraWorldRotation=Ts(),this._forward=Zi(),this._up=Zi(),this._previewSphere=null,this._previewPlane=null,this._probeId=t}initialize(t,e){this._node=t,this._cameraNode=e;const i=this.node.getWorldPosition();this._boundingBox=Qn.create(i.x,i.y,i.z,this._size.x,this._size.y,this._size.z),this._createCamera(e)}initBakedTextures(){if(0===this.bakedCubeTextures.length)for(let t=0;t<6;t++){const t=this._createTargetTexture(this._resolution,this._resolution);this.bakedCubeTextures.push(t)}}captureCubemap(){this.initBakedTextures(),this._resetCameraParams(),this._needRender=!0}renderPlanarReflection(t){if(t){if(!this.realtimePlanarTexture){const t=h.view.getDesignResolutionSize();this.realtimePlanarTexture=this._createTargetTexture(t.width,t.height),h.internal.reflectionProbeManager.updatePlanarMap(this,this.realtimePlanarTexture.getGFXTexture())}this._syncCameraParams(t),this._transformReflectionCamera(t),this._needRender=!0}}switchProbeType(t,e){0===t?this._needRender=!1:null!==e&&this.renderPlanarReflection(e)}getProbeId(){return this._probeId}updateProbeId(t){this._probeId=t}renderArea(){return 1===this._probeType?new Qs(this.realtimePlanarTexture.width,this.realtimePlanarTexture.height):new Qs(this.resolution,this.resolution)}isFinishedRendering(){return!0}validate(){return null!==this.cubemap}destroy(){this._camera&&(this._camera.destroy(),this._camera=null);for(let t=0;t<this.bakedCubeTextures.length;t++)this.bakedCubeTextures[t].destroy();this.bakedCubeTextures=[],this.realtimePlanarTexture&&(this.realtimePlanarTexture.destroy(),this.realtimePlanarTexture=null)}enable(){}disable(){}updateCameraDir(t){this.cameraNode.setRotationFromEuler($A[t]),this.camera.update(!0)}updateBoundingBox(){if(this.node){const t=this.node.getWorldPosition();Qn.set(this._boundingBox,t.x,t.y,t.z,this._size.x,this._size.y,this._size.z)}}hasFrameBuffer(t){if(1===this.probeType){var e;if(!this.realtimePlanarTexture)return!1;if((null===(e=this.realtimePlanarTexture.window)||void 0===e?void 0:e.framebuffer)===t)return!0}else{if(0===this.bakedCubeTextures.length)return!1;for(let e=0;e<this.bakedCubeTextures.length;e++){var i;if((null===(i=this.bakedCubeTextures[e].window)||void 0===i?void 0:i.framebuffer)===t)return!0}}return!1}isRGBE(){return!0}_syncCameraParams(t){this.camera.projectionType=t.projectionType,this.camera.orthoHeight=t.orthoHeight,this.camera.nearClip=t.nearClip,this.camera.farClip=t.farClip,this.camera.fov=t.fov,this.camera.clearFlag=t.clearFlag,this.camera.clearColor=t.clearColor,this.camera.priority=t.priority-1,this.camera.resize(t.width,t.height)}_createCamera(t){const e=h.director.root;if(!this._camera){if(this._camera=e.createCamera(),!this._camera)return null;this._camera.initialize({name:t.name,node:t,projection:1,window:e&&e.tempWindow,priority:0,cameraType:-1,trackingType:0})}return this._camera.setViewportInOrientedSpace(new Cr(0,0,1,1)),this._camera.fovAxis=0,this._camera.fov=vi(90),this._camera.orthoHeight=10,this._camera.nearClip=1,this._camera.farClip=1e3,this._camera.clearColor=this._backgroundColor,this._camera.clearDepth=1,this._camera.clearStencil=0,this._camera.clearFlag=this._clearFlag,this._camera.visibility=this._visibility,this._camera.aperture=19,this._camera.shutter=7,this._camera.iso=0,this._camera}_resetCameraParams(){this.camera.projectionType=1,this.camera.orthoHeight=10,this.camera.nearClip=1,this.camera.farClip=1e3,this.camera.fov=vi(90),this.camera.priority=0,this.camera.resize(this.resolution,this.resolution),this.camera.visibility=this._visibility,this.camera.clearFlag=this._clearFlag,this.camera.clearColor=this._backgroundColor,this.cameraNode.worldPosition=this.node.worldPosition,this.cameraNode.worldRotation=this.node.worldRotation,this.camera.update(!0)}_createTargetTexture(t,e){const i=new aS;return i.reset({width:t,height:e}),i}_transformReflectionCamera(t){const e=Ki.dot(this.node.worldPosition,this.node.up);this._reflect(this._cameraWorldPos,t.node.worldPosition,this.node.up,e),this.cameraNode.worldPosition=this._cameraWorldPos,Ki.transformQuat(this._forward,Ki.FORWARD,t.node.worldRotation),this._reflect(this._forward,this._forward,this.node.up,0),this._forward.normalize(),this._forward.negative(),Ki.transformQuat(this._up,Ki.UP,t.node.worldRotation),this._reflect(this._up,this._up,this.node.up,0),this._up.normalize(),ys.fromViewUp(this._cameraWorldRotation,this._forward,this._up),this.cameraNode.worldRotation=this._cameraWorldRotation,this.camera.update(!0);const i=new cr(this.node.up.x,this.node.up.y,this.node.up.z,-Ki.dot(this.node.up,this.node.worldPosition));i.transformMat4(this.camera.matView.clone().invert().transpose()),this.camera.calculateObliqueMat(i)}_reflect(t,e,i,s){const r=Ki.clone(i);r.normalize();const n=Ki.dot(r,e)-s;return r.multiplyScalar(2*n),Ki.subtract(t,e,r),t}};class XA{constructor(){this.screenUsagePercentage=1,this._models=[]}get models(){return this._models}addModel(t){this._models.splice(0,0,t)}eraseModel(t){const e=this._models.indexOf(t);e>=0&&this._models.splice(e,1)}clearModels(){this._models.length=0}}let YA=class{constructor(){this.scene=void 0,this.node=null,this.enabled=!0,this._localBoundaryCenter=Zi(0,0,0),this._objectSize=1,this._lodDataArray=[],this._lockedLODLevelVec=[],this._isLockLevelChanged=!1,this._device=e_.gfxDevice}set localBoundaryCenter(t){this._localBoundaryCenter.set(t)}get localBoundaryCenter(){return this._localBoundaryCenter.clone()}get lodCount(){return this._lodDataArray.length}set objectSize(t){this._objectSize=t}get objectSize(){return this._objectSize}get lodDataArray(){return this._lodDataArray}attachToScene(t){this.scene=t}detachFromScene(){this.scene=null}lockLODLevels(t){if(t.length!==this._lockedLODLevelVec.length)this._isLockLevelChanged=!0;else{const e=t.length;let i=0;for(;i<e;i++)if(t[i]!==this._lockedLODLevelVec[i]){this._isLockLevelChanged=!0;break}}this._lockedLODLevelVec=t.slice()}isLockLevelChanged(){return this._isLockLevelChanged}resetLockChangeFlag(){this._isLockLevelChanged=!1}getLockedLODLevels(){return this._lockedLODLevelVec}clearLODs(){this._lodDataArray.length=0}insertLOD(t,e){this._lodDataArray.splice(t,0,e)}updateLOD(t,e){this._lodDataArray[t]=e}eraseLOD(t){this._lodDataArray.splice(t,1)}getVisibleLODLevel(t){const e=this.getScreenUsagePercentage(t);let i=-1;for(let t=0;t<this.lodCount;++t)if(e>=this.lodDataArray[t].screenUsagePercentage){i=t;break}return i}getScreenUsagePercentage(t){if(!this.node)return 0;let e;return 1===t.projectionType&&(e=Ki.len(this.localBoundaryCenter.transformMat4(this.node.worldMatrix).subtract(t.node.worldPosition))),this.distanceToScreenUsagePercentage(t,e,this.getWorldSpaceSize())}distanceToScreenUsagePercentage(t,e,i){return 1===t.projectionType?i*t.matProj.m05/(2*e):i*t.matProj.m05*.5}getWorldSpaceSize(){const t=this.node.scale;return Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.objectSize}};var QA=Object.freeze({__proto__:null,Ambient:Vw,CSMLevel:Kw,CSMOptimizationMode:Zw,Camera:_A,CameraAperture:sA,CameraFOVAxis:eA,CameraISO:rA,CameraProjection:iA,CameraShutter:nA,CameraType:{DEFAULT:-1,LEFT_EYE:0,RIGHT_EYE:1,MAIN:2},CameraUsage:{EDITOR:0,GAME_VIEW:1,SCENE_VIEW:2,PREVIEW:3,GAME:100},ColorTemperatureToRGB:IA,DirectionalLight:BA,EnvironmentLightingType:$w,FOG_TYPE_NONE:Nw,Fog:Uw,FogType:kw,LODData:XA,LODGroup:YA,Light:AA,LightType:EA,Model:CA,ModelType:{DEFAULT:0,SKINNING:1,BAKED_SKINNING:2,BATCH_2D:3,PARTICLE_BATCH:4,LINE:5},Octree:eS,PCFType:Qw,PointLight:VA,PostSettings:ex,ProbeClearFlag:WA,ProbeType:jA,RangedDirectionalLight:GA,ReflectionProbe:qA,SKYBOX_FLAG:8,ShadowSize:Xw,ShadowType:Yw,Shadows:tS,Skin:KE,SkyBoxFlagValue:{VALUE:8},Skybox:qw,SphereLight:RA,SpotLight:UA,SubModel:fA,ToneMappingType:tx,TrackingType:{NO_TRACKING:0,POSITION_AND_ROTATION:1,POSITION:2,ROTATION:3},nt2lm:DA});class KA{get root(){return this._root}get name(){return this._name}get cameras(){return this._cameras}get mainLight(){return this._mainLight}get sphereLights(){return this._sphereLights}get spotLights(){return this._spotLights}get pointLights(){return this._pointLights}get rangedDirLights(){return this._rangedDirLights}get models(){return this._models}get batches(){return this._batches}get lodGroups(){return this._lodGroups}static registerCreateFunc(t){t._createSceneFun=t=>new KA(t)}constructor(t){this._name="",this._cameras=[],this._models=[],this._lodGroups=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._pointLights=[],this._rangedDirLights=[],this._mainLight=null,this._modelId=0,this._lodStateCache=null,this._root=t}initialize(t){return this._name=t.name,this._lodStateCache=new JA(this),!0}update(t){const e=this._mainLight;e&&e.update();const i=this._sphereLights;for(let t=0;t<i.length;t++)i[t].update();const s=this._spotLights;for(let t=0;t<s.length;t++)s[t].update();const r=this._pointLights;for(let t=0;t<r.length;t++)r[t].update();const n=this._rangedDirLights;for(let t=0;t<n.length;t++)n[t].update();const o=this._models;for(let e=0;e<o.length;e++){const i=o[e];i.enabled&&(i.updateTransform(t),i.updateUBOs(t))}this._lodStateCache.updateLodState()}destroy(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeRangedDirLights(),this.removeModels(),this.removeLODGroups(),this._lodStateCache.clearCache()}isCulledByLod(t,e){return this._lodStateCache.isLodModelCulled(t,e)}addCamera(t){t.attachToScene(this),this._cameras.push(t),this._lodStateCache.addCamera(t)}removeCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),t.detachFromScene(),void this._lodStateCache.removeCamera(t)}removeCameras(){for(const t of this._cameras)t.detachFromScene(),this._lodStateCache.removeCamera(t);this._cameras.splice(0)}setMainLight(t){this._mainLight=t,this._mainLight&&this._mainLight.activate()}unsetMainLight(t){if(this._mainLight===t){const t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=2));this.setMainLight(null)}}addDirectionalLight(t){t.attachToScene(this),this._directionalLights.push(t)}removeDirectionalLight(t){for(let e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)}addSphereLight(t){t.attachToScene(this),this._sphereLights.push(t)}removeSphereLight(t){for(let e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),void this._sphereLights.splice(e,1)}addSpotLight(t){t.attachToScene(this),this._spotLights.push(t)}removeSpotLight(t){for(let e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),void this._spotLights.splice(e,1)}removeSphereLights(){for(let t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0}removeSpotLights(){for(let t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights.length=0}addPointLight(t){t.attachToScene(this),this._pointLights.push(t)}removePointLight(t){for(let e=0;e<this._pointLights.length;++e)if(this._pointLights[e]===t)return t.detachFromScene(),void this._pointLights.splice(e,1)}removePointLights(){for(let t=0;t<this._pointLights.length;++t)this._pointLights[t].detachFromScene();this._pointLights.length=0}addRangedDirLight(t){t.attachToScene(this),this._rangedDirLights.push(t)}removeRangedDirLight(t){for(let e=0;e<this._rangedDirLights.length;++e)if(this._rangedDirLights[e]===t)return t.detachFromScene(),void this._rangedDirLights.splice(e,1)}removeRangedDirLights(){for(let t=0;t<this._rangedDirLights.length;++t)this._rangedDirLights[t].detachFromScene();this._rangedDirLights.length=0}addModel(t){t.attachToScene(this),this._models.push(t)}removeModel(t){for(let e=0;e<this._models.length;++e)if(this._models[e]===t)return this._lodStateCache.removeModel(t),t.detachFromScene(),void this._models.splice(e,1)}removeModels(){for(const t of this._models)this._lodStateCache.removeModel(t),t.detachFromScene(),t.destroy();this._models.length=0}addBatch(t){this._batches.push(t)}removeBatch(t){for(let e=0;e<this._batches.length;++e)if(this._batches[e]===t)return void this._batches.splice(e,1)}removeBatches(){this._batches.length=0}addLODGroup(t){this._lodGroups.push(t),t.attachToScene(this),this._lodStateCache.addLodGroup(t)}removeLODGroup(t){const e=this._lodGroups.indexOf(t);e>=0&&(this._lodGroups.splice(e,1),t.detachFromScene(),this._lodStateCache.removeLodGroup(t))}removeLODGroups(){for(const t of this._lodGroups)this._lodStateCache.removeLodGroup(t);this._lodGroups.length=0}onGlobalPipelineStateChanged(){for(const t of this._models)t.onGlobalPipelineStateChanged()}generateModelId(){return this._modelId++}}class ZA{constructor(){this.usedLevel=-1,this.lastUsedLevel=-1,this.transformDirty=!0}}class JA{constructor(t){this._renderScene=null,this._modelsInLODGroup=new Map,this._lodStateInCamera=new Map,this._newAddedLodGroupVec=new Array,this._levelModels=new Map,this._renderScene=t}addCamera(t){for(const e of this._renderScene.lodGroups){const i=e.node.layer;if((t.visibility&i)===i){this._lodStateInCamera.has(t)||this._lodStateInCamera.set(t,new Map);break}}}removeCamera(t){this._lodStateInCamera.has(t)&&this._lodStateInCamera.delete(t)}addLodGroup(t){this._newAddedLodGroupVec.push(t);for(const e of this._renderScene.cameras){if(this._lodStateInCamera.has(e))continue;const i=t.node.layer;(e.visibility&i)===i&&this._lodStateInCamera.set(e,new Map)}}removeLodGroup(t){for(let e=0;e<t.lodCount;e++){const i=t.lodDataArray[e];for(const t of i.models)this._modelsInLODGroup.delete(t)}for(const e of this._lodStateInCamera)e[1].delete(t);this._levelModels.delete(t)}removeModel(t){this._modelsInLODGroup.has(t)&&this._modelsInLODGroup.delete(t)}updateLodState(){for(const t of this._newAddedLodGroupVec){let e=this._levelModels.get(t);e||(e=new Map,this._levelModels.set(t,e));for(let i=0;i<t.lodCount;i++){let s=e.get(i);s||(s=new Array);const r=t.lodDataArray[i];for(const t of r.models){let e=this._modelsInLODGroup.get(t);e||(e=new Map),this._modelsInLODGroup.set(t,e),s.push(t)}e.set(i,s)}}this._newAddedLodGroupVec.length=0;for(const t of this._renderScene.lodGroups)if(t.enabled){const e=t.getLockedLODLevels();if(e.length>0){if(t.node.hasChangedFlags>0)for(const e of this._lodStateInCamera){let i=e[1].get(t);i||(i=new ZA,e[1].set(t,i)),i.transformDirty=!0}if(t.isLockLevelChanged()){t.resetLockChangeFlag();const i=this._levelModels.get(t);if(i){i.forEach((t=>{t.forEach((t=>{const e=this._modelsInLODGroup.get(t);e&&e.clear()}))}));for(const t of e){const e=i.get(t);e&&e.forEach((t=>{const e=this._modelsInLODGroup.get(t);if(e&&t.node&&t.node.active)for(const t of this._lodStateInCamera)e.set(t[0],!0)}))}}}continue}let i=!1;for(const e of this._lodStateInCamera){let s=e[1].get(t);s||(s=new ZA,e[1].set(t,s));const r=e[0].node.hasChangedFlags,n=t.node.hasChangedFlags;if(r>0||n>0||s.transformDirty){s.transformDirty&&(s.transformDirty=!1);const r=t.getVisibleLODLevel(e[0]);r!==s.usedLevel&&(s.lastUsedLevel=s.usedLevel,s.usedLevel=r,i=!0)}}const s=this._levelModels.get(t);if(!s)continue;t.isLockLevelChanged()?(t.resetLockChangeFlag(),s.forEach((t=>{t.forEach((t=>{const e=this._modelsInLODGroup.get(t);e&&e.clear()}))})),i=!0):i&&this._lodStateInCamera.forEach((e=>{const i=e.get(t);if(i&&i.usedLevel!==i.lastUsedLevel){const t=s.get(i.lastUsedLevel);t&&t.forEach((t=>{const e=this._modelsInLODGroup.get(t);e&&e.clear()}))}})),i&&this._lodStateInCamera.forEach(((e,i)=>{const r=e.get(t);if(r){const t=r.usedLevel,e=s.get(t);e&&e.forEach((t=>{const e=this._modelsInLODGroup.get(t);e&&t.node&&t.node.active&&e.set(i,!0)}))}}))}}isLodModelCulled(t,e){const i=this._modelsInLODGroup.get(e);return!!i&&!i.has(t)}clearCache(){this._levelModels.clear(),this._modelsInLODGroup.clear(),this._lodStateInCamera.clear(),this._newAddedLodGroupVec.length=0}isLodGroupVisibleByCamera(t,e){const i=t.node.layer;return(e.visibility&i)===i}}const tM={[he.PORTRAIT]:0,[he.LANDSCAPE_RIGHT]:1,[he.PORTRAIT_UPSIDE_DOWN]:2,[he.LANDSCAPE_LEFT]:3};let eM=0;class iM{get width(){return this._width}get height(){return this._height}get swapchain(){return this._swapchain}get framebuffer(){return this._framebuffer}get cameras(){return this._cameras}get renderWindowId(){return this._renderWindowId}get colorName(){return this._colorName}get depthStencilName(){return this._depthStencilName}isRenderWindowResized(){return this._isResized}setRenderWindowResizeHandled(){this._isResized=!1}static registerCreateFunc(t){t._createWindowFun=t=>new iM(t)}constructor(t){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null,this._device=null,this._renderWindowId=eM++,this._isResized=!0,this._colorName=`Color${this._renderWindowId}`,this._depthStencilName=`DepthStencil${this._renderWindowId}`}initialize(t,e){if(void 0!==e.title&&(this._title=e.title),void 0!==e.swapchain&&(this._swapchain=e.swapchain),this._width=e.width,this._height=e.height,this._device=t,this._renderPass=t.createRenderPass(e.renderPassInfo),e.swapchain)this._swapchain=e.swapchain,this._colorTextures.push(e.swapchain.colorTexture),this._depthStencilTexture=e.swapchain.depthStencilTexture;else{for(let i=0;i<e.renderPassInfo.colorAttachments.length;i++){const s=new Bd(1,21,e.renderPassInfo.colorAttachments[i].format,this._width,this._height);e.externalFlag&&(8&e.externalFlag||4&e.externalFlag)&&(s.flags|=e.externalFlag,s.externalRes=e.externalResLow?e.externalResLow:0),this._colorTextures.push(t.createTexture(s))}e.renderPassInfo.depthStencilAttachment&&0!==e.renderPassInfo.depthStencilAttachment.format&&(this._depthStencilTexture=t.createTexture(new Bd(1,36,e.renderPassInfo.depthStencilAttachment.format,this._width,this._height)),this._hasOffScreenAttachments=!0)}return this._framebuffer=t.createFramebuffer(new ip(this._renderPass,this._colorTextures,this._depthStencilTexture)),!0}destroy(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(let t=0;t<this._colorTextures.length;t++){const e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._device=null}resize(t,e){if(this._swapchain)this._swapchain.resize(t,e,tM[Un.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(let i=0;i<this._colorTextures.length;i++)this._colorTextures[i].resize(t,e);this._depthStencilTexture&&this._depthStencilTexture.resize(t,e),this._width=t,this._height=e}this.framebuffer&&(this.framebuffer.destroy(),this._framebuffer=this._device.createFramebuffer(new ip(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(const i of this._cameras)i.resize(t,e);this._isResized=!0}extractRenderCameras(t){for(let e=0;e<this._cameras.length;e++){const i=this._cameras[e];i.enabled&&(i.update(),t.push(i))}}attachCamera(t){for(let e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras(),this._isResized=!0}detachCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)}clearCameras(){this._cameras.length=0}sortCameras(){this._cameras.sort(((t,e)=>t.priority-e.priority))}}class sM{get device(){return this._device}get mainWindow(){return this._mainWindow}set curWindow(t){this._curWindow=t}get curWindow(){return this._curWindow}set tempWindow(t){this._tempWindow=t}get tempWindow(){return this._tempWindow}get windows(){return this._windows}get usesCustomPipeline(){return this._usesCustomPipeline}get pipeline(){return this._pipeline}get customPipeline(){return this._customPipeline}get pipelineEvent(){return this._pipelineEvent}get batcher2D(){return this._batcher}get scenes(){return this._scenes}get debugView(){return this._debugView}get cumulativeTime(){return this._cumulativeTime}get frameTime(){return this._frameTime}get frameCount(){return this._frameCount}get fps(){return this._fps}set fixedFPS(t){t>0&&(this._fixedFPS=t)}get fixedFPS(){return this._fixedFPS}get dataPoolManager(){return this._dataPoolMgr}get useDeferredPipeline(){return this._useDeferredPipeline}get cameraList(){return this._cameraList}constructor(t){this._createSceneFun=null,this._createWindowFun=null,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._usesCustomPipeline=!0,this._pipeline=null,this._pipelineEvent=new JE,this._classicPipeline=null,this._customPipeline=null,this._batcher=null,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._debugView=new tD,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._cumulativeTime=0,this._frameTime=0,this._cameraList=[],this._device=t,this._dataPoolMgr=h.internal.DataPoolManager&&new h.internal.DataPoolManager(t),KA.registerCreateFunc(this),iM.registerCreateFunc(this),this._cameraPool=new rn((()=>new _A(this._device)),4,(t=>t.destroy()))}initialize(t){var e;const i=e_.swapchain,s=new qd;s.format=i.colorTexture.format;const r=new Xd;r.format=i.depthStencilTexture.format,r.depthStoreOp=1,r.stencilStoreOp=1;const n=new Kd([s],r);this._mainWindow=this.createWindow({title:"rootMainWindow",width:i.width,height:i.height,renderPassInfo:n,swapchain:i}),this._curWindow=this._mainWindow;const o=ae.querySettings("animation","customJointTextureLayouts")||[];null===(e=this._dataPoolMgr)||void 0===e||e.jointTexturePool.registerCustomTextureLayouts(o),this._resizeMaxJointForDS()}destroy(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null,this._pipelineEvent=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),h.rendering&&h.rendering.destroy()}resize(t,e,i){for(const i of this._windows)i.swapchain&&i.resize(t,e)}setRenderPipeline(t){const{internal:e,director:i,rendering:s,legacy_rendering:r}=h;if(void 0===s&&void 0===r)return j(1223),!1;let n=!1;if(t)this._customPipeline=s.createCustomPipeline(),n=!0,this._pipeline=this._customPipeline,M(`Using custom pipeline: ${le.CUSTOM_PIPELINE_NAME}`);else{const t=r.createDefaultPipeline();n=!0,M("Using legacy pipeline"),this._classicPipeline=t,this._pipeline=this._classicPipeline,this._pipelineEvent=this._classicPipeline,this._usesCustomPipeline=!1}if((3!==ae.querySettings("rendering","renderMode")||this._classicPipeline)&&!this._pipeline.activate(this._mainWindow.swapchain))return n&&this._pipeline.destroy(),this._classicPipeline=null,this._customPipeline=null,this._pipeline=null,this._pipelineEvent=null,!1;const o=i.getScene();return o&&o.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&e.Batcher2D&&(this._batcher=new e.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))}onGlobalPipelineStateChanged(){for(let t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.skybox.enabled&&this._pipeline.pipelineSceneData.skybox.model.onGlobalPipelineStateChanged(),this._pipeline.onGlobalPipelineStateChanged()}activeWindow(t){this._curWindow=t}resetCumulativeTime(){this._cumulativeTime=0}frameMove(t){var e;this._frameTime=t,++this._frameCount,this._cumulativeTime+=t,this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),null!==(e=globalThis.__globalXR)&&void 0!==e&&e.isWebXR?this._doWebXRFrameMove():(this._frameMoveBegin(),this._frameMoveProcess(),this._frameMoveEnd())}createWindow(t){const e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e}destroyWindow(t){for(let e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)}destroyWindows(){for(const t of this._windows)t.destroy();this._windows.length=0}createScene(t){const e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e}destroyScene(t){for(let e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)}destroyScenes(){for(const t of this._scenes)t.destroy();this._scenes.length=0}createModel(t){let e=this._modelPools.get(t);e||(this._modelPools.set(t,new rn((()=>new t),10,(t=>t.destroy()))),e=this._modelPools.get(t));const i=e.alloc();return i.initialize(),i}destroyModel(t){const e=this._modelPools.get(t.constructor);e?(e.free(t),t.scene&&t.scene.removeModel(t)):G(1300,t.constructor.name),t.destroy()}createCamera(){return this._cameraPool.alloc()}createLight(t){let e=this._lightPools.get(t);e||(this._lightPools.set(t,new rn((()=>new t),4,(t=>t.destroy()))),e=this._lightPools.get(t));const i=e.alloc();return i.initialize(),i}destroyLight(t){if(t.scene)switch(t.type){case 0:t.scene.removeDirectionalLight(t);break;case 1:t.scene.removeSphereLight(t);break;case 2:t.scene.removeSpotLight(t);break;case 3:t.scene.removePointLight(t);break;case 4:t.scene.removeRangedDirLight(t)}t.destroy()}recycleLight(t){const e=this._lightPools.get(t.constructor);if(e&&(e.free(t),t.scene))switch(t.type){case 0:t.scene.removeDirectionalLight(t);break;case 1:t.scene.removeSphereLight(t);break;case 2:t.scene.removeSpotLight(t);break;case 3:t.scene.removePointLight(t);break;case 4:t.scene.removeRangedDirLight(t)}}_doWebXRFrameMove(){const t=globalThis.__globalXR;if(!t)return;const e=this._windows,i=this._cameraList,s=t.webXRMatProjs?t.webXRMatProjs.length:1;t.webXRWindowMap||(t.webXRWindowMap=new Map);let r=[];const n=t.webxrHmdPoseInfos;for(let o=0;o<s;o++){for(const i of e)r=r.concat(i.cameras),i.swapchain&&t.webXRWindowMap.set(i,o);if(n){let t=[0,0,0];for(let e=0;e<n.length;e++){const i=n[e];if(0===i.code&&0===o||3===i.code&&1===o){t[0]=i.position.x,t[1]=i.position.y,t[2]=i.position.z;break}}for(const e of r)0!==e.trackingType&&e.node&&(3===e.trackingType&&(t=[0,0,0]),e.node.setPosition(t[0],t[1],t[2]))}r.length=0,this._frameMoveBegin(),this._frameMoveProcess();for(let t=i.length-1;t>=0;t--){const e=i[t];(0===o&&1===e.cameraType||1===o&&0===e.cameraType)&&i.splice(t,1)}this._frameMoveEnd()}}_frameMoveBegin(){for(let t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();this._cameraList.length=0}_frameMoveProcess(){const{director:t}=h,e=this._windows,i=this._cameraList;for(let t=0;t<e.length;t++)e[t].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([e_.swapchain]);const e=this._scenes,i=t.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(let t=0;t<e.length;t++)e[t].update(i)}}_frameMoveEnd(){const{director:t,Director:e}=h,i=this._cameraList;if(this._pipeline&&i.length>0){t.emit(e.EVENT_BEFORE_COMMIT),i.sort(((t,e)=>t.priority-e.priority));for(let t=0;t<i.length;++t){var s;null===(s=i[t].geometryRenderer)||void 0===s||s.update()}t.emit(e.EVENT_BEFORE_RENDER),this._pipeline.render(i),t.emit(e.EVENT_AFTER_RENDER),this._device.present()}this._batcher&&this._batcher.reset()}_resizeMaxJointForDS(){const t=Math.max((288+Rm.COUNT)/4,100);let e=Math.floor((e_.gfxDevice.capabilities.maxVertexUniformVectors-t)/3);e=e<256?e:256,Gm(e)}}t("Root",sM),h.Root=sM,ri.Attr.setClassAttr(yg,"target","type","Object"),ri.Attr.setClassAttr(yg,"target","ctor",JS);const rM=new rn((()=>new Array(16)),3);let nM=null;const oM=new Qs,aM=["touch-start","touch-move","touch-end","touch-cancel"],hM=["mouse-down","mouse-enter","mouse-move","mouse-leave","mouse-up","mouse-wheel"];class lM{get isEnabled(){return this._isEnabled}get node(){return this._node}constructor(t){this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._dispatchingTouch=null,this._isEnabled=!1,this._isMouseLeaveWindow=!1,this._node=t}setEnabled(t,e){if(void 0===e&&(e=!1),this._isEnabled===t)return;this._isEnabled=t;const i=this.node.children;if(t&&this._attachMask(),lM.callbacksInvoker.emit(2),e&&i.length>0)for(let e=0;e<i.length;++e)i[e].eventProcessor.setEnabled(t,!0)}reattach(){let t;this.node.walk((e=>{t||(t=this._searchComponentsInParent(lM._maskComp)),e.eventProcessor.maskList=t}))}destroy(){if(nM===this._node&&(nM=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),lM.callbacksInvoker.emit(1,this),this._dispatchingTouch){const t=new oD([this._dispatchingTouch],!0,"touch-cancel");t.touch=this._dispatchingTouch,this.dispatchEvent(t),this._dispatchingTouch=null}}on(t,e,i,s){let r;var n,o;return this._tryEmittingAddEvent(t),r=(s=!!s)?null!==(n=this.capturingTarget)&&void 0!==n?n:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker(),r.on(t,e,i),e}once(t,e,i,s){let r;var n,o;return this._tryEmittingAddEvent(t),r=(s=!!s)?null!==(n=this.capturingTarget)&&void 0!==n?n:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker(),r.on(t,e,i,!0),e}off(t,e,i,s){var r;let n;n=(s=!!s)?this.capturingTarget:this.bubblingTarget,null===(r=n)||void 0===r||r.off(t,e,i)}targetOff(t){var e,i;null===(e=this.capturingTarget)||void 0===e||e.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||lM.callbacksInvoker.emit(1,this)}emit(t,e,i,s,r,n){var o;null===(o=this.bubblingTarget)||void 0===o||o.emit(t,e,i,s,r,n)}dispatchEvent(t){const e=this.node;let i,s=0;t.target=e;const r=rM.alloc();for(r.length=0,this.getCapturingTargets(t.type,r),t.eventPhase=1,s=r.length-1;s>=0;--s)if(i=r[s],i.eventProcessor.capturingTarget&&(t.currentTarget=i,i.eventProcessor.capturingTarget.emit(t.type,t,r),t.propagationStopped))return void rM.free(r);if(t.eventPhase=2,t.currentTarget=e,this.capturingTarget&&this.capturingTarget.emit(t.type,t),!t.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(r.length=0,this.getBubblingTargets(t.type,r),t.eventPhase=3,s=0;s<r.length;++s)if(i=r[s],i.eventProcessor.bubblingTarget&&(t.currentTarget=i,i.eventProcessor.bubblingTarget.emit(t.type,t),t.propagationStopped))return void rM.free(r);rM.free(r)}hasEventListener(t,e,i){let s=!1;return this.bubblingTarget&&(s=this.bubblingTarget.hasEventListener(t,e,i)),!s&&this.capturingTarget&&(s=this.capturingTarget.hasEventListener(t,e,i)),s}getCapturingTargets(t,e){let i=this._node.parent;for(;i;){var s;null!==(s=i.eventProcessor.capturingTarget)&&void 0!==s&&s.hasEventListener(t)&&e.push(i),i=i.parent}}getBubblingTargets(t,e){let i=this._node.parent;for(;i;){var s;null!==(s=i.eventProcessor.bubblingTarget)&&void 0!==s&&s.hasEventListener(t)&&e.push(i),i=i.parent}}onUpdatingSiblingIndex(){lM.callbacksInvoker.emit(2)}_searchComponentsInParent(t){const e=this.node;if(t){let i=0,s=[];for(let r=e;r&&JS.isNode(r);r=r.parent,++i){const e=r.getComponent(t);if(e){const t={index:i,comp:e};s?s.push(t):s=[t]}}return s.length>0?s:null}return null}_attachMask(){this.maskList=this._searchComponentsInParent(lM._maskComp)}_isTouchEvent(t){return-1!==aM.indexOf(t)}_isMouseEvent(t){return-1!==hM.indexOf(t)}_hasTouchListeners(){for(let t=0;t<aM.length;++t){const e=aM[t];if(this.hasEventListener(e))return!0}return!1}_hasMouseListeners(){for(let t=0;t<hM.length;++t){const e=hM[t];if(this.hasEventListener(e))return!0}return!1}_hasPointerListeners(){return!!this._hasTouchListeners()||this._hasMouseListeners()}_tryEmittingAddEvent(t){const e=this._isTouchEvent(t),i=this._isMouseEvent(t);e?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!e&&!i||this._hasPointerListeners()||lM.callbacksInvoker.emit(0,this)}_newCallbacksInvoker(){const t=new En;return t._registerOffCallback((()=>{this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||lM.callbacksInvoker.emit(1,this)})),t}_handleEventMouse(t){switch(t.type){case"mouse-down":return this._handleMouseDown(t);case"mouse-move":return this._handleMouseMove(t);case"mouse-up":return this._handleMouseUp(t);case"mouse-wheel":return this._handleMouseWheel(t);case"mouse-leave-window":return this._handleMouseLeave(t);case"mouse-enter-window":return this._handleMouseEnter(t);default:return!1}}_handleMouseDown(t){const e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(oM),!e._uiProps.uiTransformComp.hitTest(oM,t.windowId)||(t.type="mouse-down",t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))}_handleMouseMove(t){const e=this._node;return!(!e||!e._uiProps.uiTransformComp||this._isMouseLeaveWindow)&&(t.getLocation(oM),e._uiProps.uiTransformComp.hitTest(oM,t.windowId)?(this.previousMouseIn||(nM&&nM!==e&&(t.type="mouse-leave",nM.dispatchEvent(t),nM.eventProcessor.previousMouseIn=!1),nM=e,t.type="mouse-enter",e.dispatchEvent(t),this.previousMouseIn=!0),t.type="mouse-move",t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,!0):(this.previousMouseIn&&(t.type="mouse-leave",e.dispatchEvent(t),this.previousMouseIn=!1,nM=null),!1))}_handleMouseUp(t){const e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(oM),!e._uiProps.uiTransformComp.hitTest(oM,t.windowId)||(t.type="mouse-up",t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))}_handleMouseWheel(t){const e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(oM),!e._uiProps.uiTransformComp.hitTest(oM,t.windowId)||(t.type="mouse-wheel",t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))}_handleMouseLeave(t){return this._isMouseLeaveWindow=!0,this.previousMouseIn&&(t.type="mouse-leave",this._node.dispatchEvent(t),this.previousMouseIn=!1,nM=null),!1}_handleMouseEnter(t){return this._isMouseLeaveWindow=!1,!1}_handleEventTouch(t){try{switch(t.type){case"touch-start":return this._handleTouchStart(t);case"touch-move":return this._handleTouchMove(t);case"touch-end":return this._handleTouchEnd(t);case"touch-cancel":return this._handleTouchCancel(t);default:return!1}}catch(t){throw this.claimedTouchIdList.length=0,t}}_handleTouchStart(t){const e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(oM),!e._uiProps.uiTransformComp.hitTest(oM,t.windowId)||(t.type="touch-start",t.bubbles=!0,this._dispatchingTouch=t.touch,e.dispatchEvent(t),0)))}_handleTouchMove(t){const e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.type="touch-move",t.bubbles=!0,this._dispatchingTouch=t.touch,e.dispatchEvent(t),0))}_handleTouchEnd(t){const e=this.node;e&&e._uiProps.uiTransformComp&&(t.getLocation(oM),e._uiProps.uiTransformComp.hitTest(oM,t.windowId)?t.type="touch-end":t.type="touch-cancel",t.bubbles=!0,e.dispatchEvent(t),this._dispatchingTouch=null)}_handleTouchCancel(t){const e=this.node;e&&e._uiProps.uiTransformComp&&(t.type="touch-cancel",t.bubbles=!0,e.dispatchEvent(t),this._dispatchingTouch=null)}}function cM(t,e){if(!e){const t=l.director.getScene();if(!t)return null;e=t}return e.getChildByPath(t)}lM._maskComp=null,lM.callbacksInvoker=new En,l.NodeEventProcessor=lM,l.find=cM;const uM=Wt,dM=yn.Flags.IsStartCalled,pM=yn.Flags.IsOnEnableCalled;function _M(t,e){const i=e.constructor._executionOrder,s=e._id;let r=0;for(let e=t.length-1,n=e>>>1;r<=e;n=r+e>>>1){const o=t[n],a=o.constructor._executionOrder;if(a>i)e=n-1;else if(a<i)r=n+1;else{const t=o._id;if(t>s)e=n-1;else{if(!(t<s))return n;r=n+1}}}return~r}function gM(t,e){const i=t.array;let s=t.i+1;for(;s<i.length;){const r=i[s];r.node._activeInHierarchy?++s:(t.removeAt(s),e&&(r._objFlags&=~e))}}yn.Flags.IsEditorOnEnableCalled;class fM{get zero(){return this._zero}get neg(){return this._neg}get pos(){return this._pos}constructor(t){const e=Ht;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t}}function mM(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}fM.stableRemoveInactive=gM;class yM extends fM{add(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)}remove(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)}cancelInactive(t){gM(this._zero,t),gM(this._neg,t),gM(this._pos,t)}invoke(){const t=this._neg;t.array.length>0&&(t.array.sort(mM),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;const e=this._pos;e.array.length>0&&(e.array.sort(mM),this._invoke(e),e.array.length=0)}}class vM extends fM{add(t){const e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{const i=e<0?this._neg.array:this._pos.array,s=_M(i,t);s<0&&i.splice(~s,0,t)}}remove(t){const e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{const i=e<0?this._neg:this._pos,s=_M(i.array,t);s>=0&&i.removeAt(s)}}invoke(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)}}function bM(t,e,i){const s=`var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];${t}}`,r=e?Function("it","dt",s):Function("it",s);return wM(Function("c","dt",t),r,i)}function wM(t,e,i){return(s,r)=>{try{e(s,r)}catch(e){l._throw(e);const n=s.array;for(i&&(n[s.i]._objFlags|=i),++s.i;s.i<n.length;++s.i)try{t(n[s.i],r)}catch(t){l._throw(t),i&&(n[s.i]._objFlags|=i)}}}}const SM=bM(`c.start();c._objFlags|=${dM}`,!1,dM),xM=bM("c.update(dt)",!0),TM=bM("c.lateUpdate(dt)",!0),CM=t=>{const e=l.director._compScheduler,i=t.array;for(t.i=0;t.i<i.length;++t.i){const s=i[t.i];s._enabled&&(s.onEnable(),!s.node._activeInHierarchy||e._onEnabled(s))}};class IM{constructor(){this._deferredComps=[],this.unscheduleAll()}unscheduleAll(){this.startInvoker=new yM(SM),this.updateInvoker=new vM(xM),this.lateUpdateInvoker=new vM(TM),this._updating=!1}_onEnabled(t){l.director.getScheduler().resumeTarget(t),t._objFlags|=pM,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)}_onDisabled(t){l.director.getScheduler().pauseTarget(t),t._objFlags&=~pM;const e=this._deferredComps.indexOf(t);e>=0?uM(this._deferredComps,e):(!t.internalStart||t._objFlags&dM||this.startInvoker.remove(t),t.internalUpdate&&this.updateInvoker.remove(t),t.internalLateUpdate&&this.lateUpdateInvoker.remove(t))}enableComp(t,e){if(!(t._objFlags&pM)){if(t.internalOnEnable){if(e)return void e.add(t);if(t.internalOnEnable(),!t.node.activeInHierarchy)return}this._onEnabled(t)}}disableComp(t){t._objFlags&pM&&(t.internalOnDisable&&t.internalOnDisable(),this._onDisabled(t))}startPhase(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}updatePhase(t){this.updateInvoker.invoke(t)}lateUpdatePhase(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()}_startForNewComps(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}_scheduleImmediate(t){"function"!=typeof t.internalStart||t._objFlags&dM||this.startInvoker.add(t),"function"==typeof t.internalUpdate&&this.updateInvoker.add(t),"function"==typeof t.internalLateUpdate&&this.lateUpdateInvoker.add(t)}_deferredSchedule(){const t=this._deferredComps;for(let e=0,i=t.length;e<i;e++)this._scheduleImmediate(t[e]);t.length=0}}const EM=yn.Flags.IsPreloadStarted,DM=yn.Flags.IsOnLoadStarted,AM=yn.Flags.IsOnLoadCalled,MM=yn.Flags.IsOnEnableCalled,PM=yn.Flags.Deactivating;class BM extends fM{add(t){this._zero.array.push(t)}remove(t){this._zero.fastRemove(t)}cancelInactive(t){fM.stableRemoveInactive(this._zero,t)}invoke(){this._invoke(this._zero),this._zero.array.length=0}}const RM=bM("c.__preload();"),OM=bM(`c.onLoad();c._objFlags|=${AM}`,!1,AM),LM=new Vt(4);function FM(t,e,i){j(3817,t.name,i),console.log("Corrupted component value:",e),e?t._removeComponent(e):Gt(t.getWritableComponents(),i)}LM.get=function(){const t=this._get()||{preload:new BM(RM),onLoad:new yM(OM),onEnable:new yM(CM)};t.preload.zero.i=-1;let e=t.onLoad;return e.zero.i=-1,e.neg.i=-1,e.pos.i=-1,e=t.onEnable,e.zero.i=-1,e.neg.i=-1,e.pos.i=-1,t};class zM{constructor(){this.reset()}reset(){this._activatingStack=[]}activateNode(t,e){if(e){const e=LM.get();e&&(this._activatingStack.push(e),this._activateNodeRecursively(t,e.preload,e.onLoad,e.onEnable),e.preload.invoke(),e.onLoad.invoke(),e.onEnable.invoke(),this._activatingStack.pop(),LM.put(e))}else{this._deactivateNodeRecursively(t);const e=this._activatingStack;for(const t of e)t.preload.cancelInactive(EM),t.onLoad.cancelInactive(DM),t.onEnable.cancelInactive(MM)}t.emit("active-in-hierarchy-changed",t)}activateComp(t,e,i,s){if(bn(t,!0)&&(t._objFlags&EM||(t._objFlags|=EM,t.internalPreload&&(e?e.add(t):t.internalPreload())),t._objFlags&DM||(t._objFlags|=DM,t.internalOnLoad?i?i.add(t):(t.internalOnLoad(),t._objFlags|=AM):t._objFlags|=AM),t._enabled)){if(!t.node.activeInHierarchy)return;l.director._compScheduler.enableComp(t,s)}}destroyComp(t){l.director._compScheduler.disableComp(t),t.internalOnDestroy&&t._objFlags&AM&&t.internalOnDestroy()}_activateNodeRecursively(t,e,i,s){if(t._objFlags&PM)return void j(3816,t.name);t._setActiveInHierarchy(!0);let r=t.components.length;for(let n=0;n<r;++n){const o=t.components[n];o instanceof l.Component?this.activateComp(o,e,i,s):(FM(t,o,n),--n,--r)}for(let r=0,n=t.children.length;r<n;++r){const n=t.children[r];n.active&&this._activateNodeRecursively(n,e,i,s)}t._onPostActivated(!0)}_deactivateNodeRecursively(t){t._objFlags|=PM,t._setActiveInHierarchy(!1);const e=t.components.length;for(let i=0;i<e;++i){const e=t.components[i];if(e._enabled&&(l.director._compScheduler.disableComp(e),t.activeInHierarchy))return void(t._objFlags&=~PM)}for(let e=0,i=t.children.length;e<i;++e){const i=t.children[e];if(i.activeInHierarchy&&(this._deactivateNodeRecursively(i),t.activeInHierarchy))return void(t._objFlags&=~PM)}t._onPostActivated(!1),t._objFlags&=~PM}}t("NodeActivator",zM);const kM=yn.Flags.Destroyed,NM=yn.Flags.PersistentMask,UM=`${ri.Attr.DELIMETER}default`,VM=ri.IDENTIFIER_RE,HM="var ",GM="o",WM={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},jM=ri.escapeForJS;class $M{constructor(t,e){this.varName=t,this.expression=e}toString(){return`${HM+this.varName}=${this.expression};`}}function qM(t,e){return e instanceof $M?new $M(e.varName,t+e.expression):t+e}function XM(t,e,i){Array.isArray(i)?(i[0]=qM(e,i[0]),t.push(i)):t.push(`${qM(e,i)};`)}class YM{constructor(t){this._exps=[],this._targetExp=t}append(t,e){this._exps.push([t,e])}writeCode(t){let e;if(this._exps.length>1)t.push(`t=${this._targetExp};`),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(let i=0;i<this._exps.length;i++){const s=this._exps[i];XM(t,`${e+QM(s[0])}=`,s[1])}}}function QM(t){return VM.test(t)?`.${t}`:`[${jM(t)}]`}YM.pool=void 0,YM.pool=new Vt((t=>{t._exps.length=0,t._targetExp=null}),1),YM.pool.get=function(t){const e=this._get()||new YM;return e._targetExp=t,e};class KM{constructor(t,e){let i;this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.parent=e,this.funcModuleCache=dt(),xt(this.funcModuleCache,WM),this.codeArray.push(`${HM+GM},t;`,"if(R){",`${GM}=R;`,"}else{",`${GM}=R=new ${this.getFuncModule(t.constructor,!0)}();`,"}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(i=`${HM+this.globalVariables.join(",")};`);const s=yu(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",s)(this.objs,this.funcs);for(let t=0,e=this.objsToClear_iN$t.length;t<e;++t)this.objsToClear_iN$t[t]._iN$t=null;this.objsToClear_iN$t.length=0}getFuncModule(t,e){const i=pt(t);if(i){const e=this.funcModuleCache[i];if(e)return e;if(void 0===e){let e=-1!==i.indexOf(".");if(e)try{if(e=t===Function(`return ${i}`)(),e)return this.funcModuleCache[i]=i,i}catch(t){}}}let s=this.funcs.indexOf(t);s<0&&(s=this.funcs.length,this.funcs.push(t));let r=`F[${s}]`;return e&&(r=`(${r})`),this.funcModuleCache[i]=r,r}getObjRef(t){let e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),`O[${e}]`}setValueType(t,e,i,s){const r=YM.pool.get(s);let n=e.constructor.__props__;n||(n=Object.keys(e));for(let t=0;t<n.length;t++){const s=n[t],o=i[s];if(e[s]===o)continue;const a=this.enumerateField(i,s,o);r.append(s,a)}r.writeCode(t),YM.pool.put(r)}enumerateCCClass(t,e,i){const s=i.__values__,r=ri.Attr.getClassAttrs(i);for(let i=0;i<s.length;i++){const n=s[i],o=e[n];let a=r[n+UM];if(!ZM(a,o))if("object"==typeof o&&o instanceof h.ValueType&&(a=ri.getDefault(a),a&&a.constructor===o.constructor)){const e=GM+QM(n);this.setValueType(t,a,o,e)}else this.setObjProp(t,e,n,o)}}instantiateArray(t){if(0===t.length)return"[]";const e="a"+ ++this.localVariableId,i=[new $M(e,`new Array(${t.length})`)];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(let s=0;s<t.length;++s)XM(i,`${e}[${s}]=`,this.enumerateField(t,s,t[s]));return i}instantiateTypedArray(t){const e=t.constructor.name;if(0===t.length)return`new ${e}`;const i="a"+ ++this.localVariableId,s=[new $M(i,`new ${e}(${t.length})`)];t._iN$t={globalVar:"",source:s},this.objsToClear_iN$t.push(t);for(let e=0;e<t.length;++e)0!==t[e]&&XM(s,`${i}[${e}]=`,t[e]);return s}enumerateField(t,e,i){if("object"==typeof i&&i){const t=i._iN$t;if(t){let e=t.globalVar;if(!e){e=t.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(e);const i=t.source[0];t.source[0]=qM(`${e}=`,i)}return e}return ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?jM(i):("_objFlags"===e&&vn(t)&&(i&=NM),i)}setObjProp(t,e,i,s){XM(t,`${GM+QM(i)}=`,this.enumerateField(e,i,s))}enumerateObject(t,e){const i=e.constructor;if(ni(i))this.enumerateCCClass(t,e,i);else for(const i in e){if(!e.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__type__"!==i)continue;const s=e[i];"object"==typeof s&&s&&s===e._iN$t||this.setObjProp(t,e,i,s)}}instantiateObj(t){if(t instanceof h.ValueType)return ri.getNewValueTypeCode(t);if(t instanceof h.Asset)return this.getObjRef(t);if(t._objFlags&kM)return null;let e;const i=t.constructor;if(ni(i)){if(this.parent)if(this.parent instanceof h.Component){if(t instanceof h.Node||t instanceof h.Component)return this.getObjRef(t)}else if(this.parent instanceof h.Node)if(t instanceof h.Node){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof h.Component){var s;if(null===(s=t.node)||void 0===s||!s.isChildOf(this.parent))return this.getObjRef(t)}e=new $M(GM,`new ${this.getFuncModule(i,!0)}()`)}else if(i===Object)e=new $M(GM,"{}");else{if(i)return this.getObjRef(t);e=new $M(GM,"Object.create(null)")}const r=[e];return t._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(t),this.enumerateObject(r,t),["(function(){",r,"return o;})();"]}}function ZM(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof h.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return at(t)&&at(e)}return!1}function JM(t){const e=t instanceof h.Node&&t;return new KM(t,e).result}var tP,eP,iP,sP,rP,nP;const oP=te({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2});let aP=t("Prefab",oa("cc.Prefab")((nP=class t extends F_{constructor(){super(),this.data=iP&&iP(),this.optimizationPolicy=sP&&sP(),this.persistent=rP&&rP(),this._createFunction=null,this._instantiatedTimes=0}createNode(t){const e=l.instantiate(this);e.name=this.name,t(null,e)}compileCreateFunction(){this._createFunction=JM(this.data)}_doInstantiate(t){return this.data._prefab||G(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)}_instantiate(){let e,i=!1;return i=this.optimizationPolicy!==oP.SINGLE_INSTANCE&&(this.optimizationPolicy===oP.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold),i?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e}initDefault(t){super.initDefault(t),this.data=new JS,this.data.name="(Missing Node)";const e=new l._PrefabInfo;e.asset=this,e.root=this.data,this.data._prefab=e}validate(){return!!this.data}onLoaded(){const t=this.data;bE(t),yE(t)}},nP.OptimizationPolicy=oP,nP.OptimizationPolicyThreshold=3,iP=Qo((eP=nP).prototype,"data",[va],(function(){return null})),sP=Qo(eP.prototype,"optimizationPolicy",[va],(function(){return oP.AUTO})),rP=Qo(eP.prototype,"persistent",[va],(function(){return!1})),tP=eP))||tP);ht(aP,"_utils",CE),l.Prefab=aP,_t(l,"cc._Prefab","Prefab");const hP=new class{constructor(){this._allRenderers=[],this._dirtyRenderers=[],this._dirtyVersion=0}addRenderer(t){-1===t._internalId&&(t._internalId=this._allRenderers.length,this._allRenderers.push(t))}removeRenderer(t){if(-1!==t._internalId){const e=t._internalId;this._allRenderers[this._allRenderers.length-1]._internalId=e,Wt(this._allRenderers,e),t._internalId=-1,t._dirtyVersion===this._dirtyVersion&&($t(this._dirtyRenderers,t),t._dirtyVersion=-1)}}markDirtyRenderer(t){t._dirtyVersion!==this._dirtyVersion&&-1!==t._internalId&&(this._dirtyRenderers.push(t),t._dirtyVersion=this._dirtyVersion)}updateAllDirtyRenderers(){const t=this._dirtyRenderers;for(let e=0;e<this._dirtyRenderers.length;e++)t[e].updateRenderer();this._dirtyRenderers.length=0,this._dirtyVersion++}},lP=t("DirectorEvent",{INIT:"director_init",RESET:"director_reset",BEFORE_SCENE_LOADING:"director_before_scene_loading",BEFORE_SCENE_LAUNCH:"director_before_scene_launch",AFTER_SCENE_LAUNCH:"director_after_scene_launch",BEFORE_UPDATE:"director_before_update",AFTER_UPDATE:"director_after_update",BEFORE_DRAW:"director_before_draw",AFTER_DRAW:"director_after_draw",BEFORE_COMMIT:"director_before_commit",BEFORE_RENDER:"director_before_render",AFTER_RENDER:"director_after_render",BEFORE_PHYSICS:"director_before_physics",AFTER_PHYSICS:"director_after_physics",BEGIN_FRAME:"director_begin_frame",END_FRAME:"director_end_frame"});class cP extends An{constructor(){super(),this._compScheduler=new IM,this._nodeActivator=new zM,this._invalid=!1,this._paused=!1,this._root=null,this._loadingScene="",this._scene=null,this._totalFrames=0,this._scheduler=new lu,this._systems=[],this._persistRootNodes={}}end(){this.once("director_end_frame",(()=>{this.purgeDirector()}))}pause(){this._paused=!0}purgeDirector(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),bn(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),uw.releaseAll()}reset(){var t;this.purgeDirector();for(const t in this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[t]);null===(t=this.getScene())||void 0===t||t.destroy(),this.emit("director_reset"),this.startAnimation()}runSceneImmediate(t,e,i){t instanceof ME&&(t=t.scene),q(t instanceof IE,1216),t._load();const s=Object.keys(this._persistRootNodes).map((t=>this._persistRootNodes[t]));for(let e=0;e<s.length;e++){const i=s[e];i.emit("scene-changed-for-persists",t.renderScene);const r=t.uuid===i._originalSceneId&&t.getChildByUuid(i.uuid);if(r){const e=r.getSiblingIndex();i.hideFlags&=~yn.Flags.DontSave,i.hideFlags|=yn.Flags.DontSave&r.hideFlags,r._destroyImmediate(),t.insertChild(i,e)}else i.hideFlags|=yn.Flags.DontSave,i.parent=t}const r=this._scene;bn(r)&&r.destroy(),Kv._autoRelease(r,t,this._persistRootNodes),this._scene=null,yn._deferredDestroy(),e&&e(),this.emit("director_before_scene_launch",t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,t),this.emit("director_after_scene_launch",t)}runScene(t,e,i){t instanceof ME&&(t=t.scene),q(Boolean(t),1205),q(t instanceof IE,1216),this.once("director_end_frame",(()=>{this.runSceneImmediate(t,e,i)}))}loadScene(t,e,i){if(this._loadingScene)return G(1208,t,this._loadingScene),!1;const s=uw.bundles.find((e=>!!e.getSceneInfo(t)));return s?(this.emit("director_before_scene_loading",t),this._loadingScene=t,console.time(`LoadScene ${t}`),s.loadScene(t,((s,r)=>{console.timeEnd(`LoadScene ${t}`),this._loadingScene="",s?(B(s),e&&e(s)):this.runSceneImmediate(r,i,e)})),!0):(j(1209,t),!1)}preloadScene(t,e,i){const s=uw.bundles.find((e=>!!e.getSceneInfo(t)));if(s)s.preloadScene(t,null,e,i);else{const e=`Can not preload the scene "${t}" because it is not in the build settings.`;i&&i(new Error(e)),B(`preloadScene: ${e}`)}}resume(){this._paused=!1}get root(){return this._root}getScene(){return this._scene}getDeltaTime(){return h.game.deltaTime}getTotalTime(){return h.game.totalTime}getCurrentTime(){return h.game.frameStartTime}getTotalFrames(){return this._totalFrames}isPaused(){return this._paused}getScheduler(){return this._scheduler}setScheduler(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(lu.ID,t,200))}registerSystem(t,e,i){e.id=t,e.priority=i,this._systems.push(e),this._systems.sort(su.sortByPriority)}unregisterSystem(t){$t(this._systems,t),this._systems.sort(su.sortByPriority)}getSystem(t){return this._systems.find((e=>e.id===t))}getAnimationManager(){return this.getSystem(h.AnimationManager.ID)}startAnimation(){this._invalid=!1}stopAnimation(){this._invalid=!0}mainLoop(t){let e;e=h.game._calculateDT(!1),this.tick(e)}tick(t){if(!this._invalid){if(this.emit("director_begin_frame"),ZD._frameDispatchEvents(),!this._paused){this.emit("director_before_update"),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(let e=0;e<this._systems.length;++e)this._systems[e].update(t);this._compScheduler.lateUpdatePhase(t),this.emit("director_after_update"),yn._deferredDestroy();for(let e=0;e<this._systems.length;++e)this._systems[e].postUpdate(t)}this.emit("director_before_draw"),hP.updateAllDirtyRenderers(),this._root.frameMove(t),this.emit("director_after_draw"),JS.resetHasChangedFlags(),JS.clearNodeArray(),sn.update(t),this.emit("director_end_frame"),this._totalFrames++}}buildRenderPipeline(){if(!this._root)return;const t=this._root.customPipeline,e=this._root.cameraList;t.beginSetup();const i=h.rendering.getCustomPipeline(le.CUSTOM_PIPELINE_NAME);h.rendering.dispatchResizeEvents(e,i,t),i.setup(e,t),t.endSetup()}setupRenderPipelineBuilder(){""!==le.CUSTOM_PIPELINE_NAME&&h.rendering&&this._root&&this._root.usesCustomPipeline&&(this.on("director_before_render",this.buildRenderPipeline,this),this.on("director_before_scene_launch",h.rendering.forceResizeAllWindows,h.rendering))}init(){this._totalFrames=0,this._paused=!1,this.registerSystem(lu.ID,this._scheduler,200),this._root=new sM(e_.gfxDevice),this._root.initialize({}),this.setupRenderPipelineBuilder();for(let t=0;t<this._systems.length;t++)this._systems[t].init();this.emit("director_init")}addPersistRootNode(t){if(!JS.isNode(t)||!t.uuid)return void G(3800);const e=t.uuid;if(!this._persistRootNodes[e]){const i=this._scene;if(bn(i))if(t.parent){if(!(t.parent instanceof IE))return void G(3801);if(t.parent!==i)return void G(3802);t._originalSceneId=i.uuid}else t.parent=i,t._originalSceneId=i.uuid;this._persistRootNodes[e]=t,t._persistNode=!0,Kv._addPersistNodeRef(t)}}removePersistRootNode(t){const e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",Kv._removePersistNodeRef(t))}isPersistRootNode(t){return!!t._persistNode}}t("Director",cP),cP.EVENT_INIT="director_init",cP.EVENT_RESET="director_reset",cP.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",cP.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",cP.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",cP.EVENT_BEFORE_UPDATE="director_before_update",cP.EVENT_AFTER_UPDATE="director_after_update",cP.EVENT_BEFORE_DRAW="director_before_draw",cP.EVENT_AFTER_DRAW="director_after_draw",cP.EVENT_BEFORE_COMMIT="director_before_commit",cP.EVENT_BEFORE_RENDER="director_before_render",cP.EVENT_AFTER_RENDER="director_after_render",cP.EVENT_BEFORE_PHYSICS="director_before_physics",cP.EVENT_AFTER_PHYSICS="director_after_physics",cP.EVENT_BEGIN_FRAME="director_begin_frame",cP.EVENT_END_FRAME="director_end_frame",cP.instance=void 0,h.Director=cP,h.DirectorEvent=lP;const uP=t("director",cP.instance=h.director=new cP),dP=wr(),pP={[le.ORIENTATION_AUTO]:he.AUTO,[le.ORIENTATION_LANDSCAPE]:he.LANDSCAPE,[le.ORIENTATION_PORTRAIT]:he.PORTRAIT};class _P extends(Dn(su)){constructor(){super(),this._designResolutionSize=wr(0,0),this._scaleX=1,this._scaleY=1,this._viewportRect=Ir(),this._visibleRect=Ir(),this._autoFullScreen=!1,this._retinaEnabled=!1,this._resizeCallback=null;const t=gP,e=fP;this._rpExactFit=new mP(t.EQUAL_TO_FRAME,e.EXACT_FIT),this._rpShowAll=new mP(t.EQUAL_TO_FRAME,e.SHOW_ALL),this._rpNoBorder=new mP(t.EQUAL_TO_FRAME,e.NO_BORDER),this._rpFixedHeight=new mP(t.EQUAL_TO_FRAME,e.FIXED_HEIGHT),this._rpFixedWidth=new mP(t.EQUAL_TO_FRAME,e.FIXED_WIDTH),this._resolutionPolicy=this._rpShowAll}init(){const t=Vn.windowSize,e=t.width,i=t.height;this._designResolutionSize.width=e,this._designResolutionSize.height=i,this._viewportRect.width=e,this._viewportRect.height=i,this._visibleRect.width=e,this._visibleRect.height=i,dP.width=this._visibleRect.width,dP.height=this._visibleRect.height,Gn&&Gn.init(this._visibleRect);{this.resizeWithBrowserSize(!0);const t=ae.querySettings("screen","designResolution");t&&this.setDesignResolutionSize(Number(t.width),Number(t.height),t.policy||mP.FIXED_HEIGHT)}Vn.on("window-resize",this._updateAdaptResult,this),Vn.on("fullscreen-change",this._updateAdaptResult,this)}resizeWithBrowserSize(t){Un.handleResizeEvent=t}setResizeCallback(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)}setOrientation(t){Un.orientation=pP[t]}adjustViewportMeta(t){}enableRetina(t){this._retinaEnabled=!!t}isRetinaEnabled(){return this._retinaEnabled}enableAutoFullScreen(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&Vn.requestFullScreen().catch((()=>{})))}isAutoFullScreenEnabled(){return this._autoFullScreen}setCanvasSize(t,e){Un.resolutionScale=1;const i=Un.devicePixelRatio,s=new br(t*i,e*i);Vn.windowSize=s}getCanvasSize(){return Vn.windowSize}getFrameSize(){const t=Un.devicePixelRatio,e=Vn.windowSize;return e.width/=t,e.height/=t,e}setFrameSize(t,e){const i=Un.devicePixelRatio;Vn.windowSize=new br(t*i,e*i)}getVisibleSize(){return new br(this._visibleRect.width,this._visibleRect.height)}getVisibleSizeInPixel(){return new br(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}getVisibleOrigin(){return new Qs(this._visibleRect.x,this._visibleRect.y)}getVisibleOriginInPixel(){return new Qs(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}getResolutionPolicy(){return this._resolutionPolicy}_updateResolutionPolicy(t){if(t instanceof mP)this._resolutionPolicy=t;else{const e=mP;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}}setResolutionPolicy(t){this._updateResolutionPolicy(t);const e=yP.getDesignResolutionSize();yP.setDesignResolutionSize(e.width,e.height,t)}setDesignResolutionSize(t,e,i){if(!(t>0&&e>0))return void j(2200);this._updateResolutionPolicy(i);const s=this._resolutionPolicy;s&&s.preApply(this),this._designResolutionSize.width=t,this._designResolutionSize.height=e;const r=s.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){const t=this._viewportRect,e=this._visibleRect,i=r.viewport;t.x=i.x,t.y=i.y,t.width=i.width,t.height=i.height,e.x=0,e.y=0,e.width=i.width/this._scaleX,e.height=i.height/this._scaleY}s.postApply(this),dP.width=this._visibleRect.width,dP.height=this._visibleRect.height,Gn&&Gn.init(this._visibleRect),this.emit("design-resolution-changed")}getDesignResolutionSize(){return new br(this._designResolutionSize.width,this._designResolutionSize.height)}setRealPixelResolution(t,e,i){document.documentElement.style.width=`${t}px`,document.body.style.width=`${t}px`,document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(t,e,i)}getViewportRect(){return this._viewportRect}getScaleX(){return this._scaleX}getScaleY(){return this._scaleY}getDevicePixelRatio(){return Un.devicePixelRatio}convertToLocationInView(t,e,i,s){void 0===s&&(s=new Qs);const r=Un.devicePixelRatio*(t-i.left),n=Un.devicePixelRatio*(i.top+i.height-e);return Un.isFrameRotated?(s.x=Vn.windowSize.width-n,s.y=r):(s.x=r,s.y=n),s}_convertToUISpace(t){const e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY}_updateAdaptResult(t,e,i){var s;h.director.root.resize(t,e,void 0===i||0===i?1:i);const r=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&e>0?this.setDesignResolutionSize(r,n,this._resolutionPolicy):R(!1,"_updateAdaptResult Invalid size."),this.emit("canvas-resize"),null===(s=this._resizeCallback)||void 0===s||s.call(this)}}t("View",_P),_P.instance=void 0;class gP{constructor(){this.name="ContainerStrategy"}preApply(t){}apply(t,e){}postApply(t){}_setupCanvas(){const t=h.game.canvas;if(t){const e=Vn.windowSize;t.width!==e.width&&(t.width=e.width),t.height!==e.height&&(t.height=e.height)}}}gP.EQUAL_TO_FRAME=void 0,gP.PROPORTION_TO_FRAME=void 0;class fP{get strategy(){return this._strategy}constructor(){this.name="ContentStrategy",this._result={scale:[1,1],viewport:null},this._strategy=mP.UNKNOWN}preApply(t){}apply(t,e){return{scale:[1,1]}}postApply(t){}_buildResult(t,e,i,s,r,n){Math.abs(t-i)<2&&(i=t),Math.abs(e-s)<2&&(s=e);const o=new Cr(Math.round((t-i)/2),Math.round((e-s)/2),i,s);return this._result.scale=[r,n],this._result.viewport=o,this._result}}gP.EQUAL_TO_FRAME=new class extends gP{constructor(){super(),this.name="EqualToFrame"}apply(t,e){Un.isProportionalToFrame=!1,this._setupCanvas()}},gP.PROPORTION_TO_FRAME=new class extends gP{constructor(){super(),this.name="ProportionalToFrame"}apply(t,e){Un.isProportionalToFrame=!0,this._setupCanvas()}};class mP{constructor(t,e){this.name="ResolutionPolicy",this._containerStrategy=t,this._contentStrategy=e}get canvasSize(){return Vn.windowSize}preApply(t){this._contentStrategy.preApply(t)}apply(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)}postApply(t){this._contentStrategy.postApply(t)}setContainerStrategy(t){this._containerStrategy=t}setContentStrategy(t){this._contentStrategy=t}getContentStrategy(){return this._contentStrategy}}t("ResolutionPolicy",mP),mP.EXACT_FIT=0,mP.NO_BORDER=1,mP.SHOW_ALL=2,mP.FIXED_HEIGHT=3,mP.FIXED_WIDTH=4,mP.UNKNOWN=5,mP.ContainerStrategy=gP,mP.ContentStrategy=fP,h.ResolutionPolicy=mP,fP.EXACT_FIT=new class extends fP{constructor(){super(),this.name="ExactFit",this._strategy=mP.EXACT_FIT}apply(t,e){const i=Vn.windowSize,s=i.width,r=i.height,n=s/e.width,o=r/e.height;return this._buildResult(s,r,s,r,n,o)}},fP.SHOW_ALL=new class extends fP{constructor(){super(),this.name="ShowAll",this._strategy=mP.SHOW_ALL}apply(t,e){const i=Vn.windowSize,s=i.width,r=i.height,n=e.width,o=e.height,a=s/n,h=r/o;let l,c,u=0;return a<h?(u=a,l=s,c=o*u):(u=h,l=n*u,c=r),this._buildResult(s,r,l,c,u,u)}},fP.NO_BORDER=new class extends fP{constructor(){super(),this.name="NoBorder",this._strategy=mP.NO_BORDER}apply(t,e){const i=Vn.windowSize,s=i.width,r=i.height,n=e.width,o=e.height,a=s/n,h=r/o;let l,c,u;return a<h?(l=h,c=n*l,u=r):(l=a,c=s,u=o*l),this._buildResult(s,r,c,u,l,l)}},fP.FIXED_HEIGHT=new class extends fP{constructor(){super(),this.name="FixedHeight",this._strategy=mP.FIXED_HEIGHT}apply(t,e){const i=Vn.windowSize,s=i.width,r=i.height,n=r/e.height,o=s,a=r;return this._buildResult(s,r,o,a,n,n)}},fP.FIXED_WIDTH=new class extends fP{constructor(){super(),this.name="FixedWidth",this._strategy=mP.FIXED_WIDTH}apply(t,e){const i=Vn.windowSize,s=i.width,r=i.height,n=s/e.width,o=s,a=r;return this._buildResult(s,r,o,a,n,n)}};const yP=t("view",_P.instance=h.view=new _P);uP.registerSystem("view",yP,0),h.winSize=dP;const vP=new Qs;class bP{get isFinished(){return this._curTime>=this.settings.totalTime}set curTime(t){this._curTime=t}get curTime(){return this._curTime}init(){var t,e,i,s,r,n,o;let a=mP.SHOW_ALL;{const t=ae.querySettings("screen","designResolution");null!==t&&(a=t.policy)}if(this.settings={policy:null!==(t=a)&&void 0!==t?t:mP.SHOW_ALL,displayRatio:null!==(e=ae.querySettings("splashScreen","displayRatio"))&&void 0!==e?e:.4,totalTime:null!==(i=ae.querySettings("splashScreen","totalTime"))&&void 0!==i?i:3e3,watermarkLocation:null!==(s=ae.querySettings("splashScreen","watermarkLocation"))&&void 0!==s?s:"default",autoFit:null===(r=ae.querySettings("splashScreen","autoFit"))||void 0===r||r,logo:null!==(n=ae.querySettings("splashScreen","logo"))&&void 0!==n?n:void 0,background:null!==(o=ae.querySettings("splashScreen","background"))&&void 0!==o?o:void 0},this._curTime=0,!(this.settings.totalTime<=0||void 0===this.settings.logo||void 0===this.settings.background)){this.device=h.director.root.device,this.swapchain=h.director.root.mainWindow.swapchain,this.preInit(),this.initLayout(),"default"===this.settings.logo.type&&this.initWaterMark();let t=Promise.resolve(),e=Promise.resolve();return"custom"===this.settings.background.type&&(t=new Promise(((t,e)=>{this.bgImage=new u.Image,this.bgImage.onload=()=>{this.initBG(),t()},this.bgImage.onerror=()=>{e()},this.bgImage.src=this.settings.background.base64}))),"none"!==this.settings.logo.type&&(e=new Promise(((t,e)=>{this.logoImage=new u.Image,this.logoImage.onload=()=>{this.initLogo(),t()},this.logoImage.onerror=()=>{e()},this.logoImage.src=this.settings.logo.base64}))),Promise.all([t,e])}return this.settings.totalTime=0,Promise.resolve([])}preInit(){var t;const e=null===(t=this.settings.background)||void 0===t?void 0:t.color;this.clearColors=e?[new Sd(e.x,e.y,e.z,e.w)]:[new Sd(0,0,0,1)];const{device:i,swapchain:s}=this;this.renderArea=new _d(0,0,s.width,s.height),this.cmdBuff=i.commandBuffer;const r=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]);this.vertexBuffers=i.createBuffer(new Ed(10,1,64,16)),this.vertexBuffers.update(r);const n=new Uint16Array([0,1,2,1,3,2]);this.indicesBuffers=i.createBuffer(new Ed(6,1,12,2)),this.indicesBuffers.update(n);const o=[new Wd("a_position",21),new Wd("a_texCoord",21)],a=new $d(o,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=i.createInputAssembler(a),this.projection=new Rs,Rs.ortho(this.projection,-1,1,-1,1,-1,1,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY,s.surfaceTransform),this.isMobile=Hn.isMobile}initLayout(){this.isMobile?(this.bgWidth=812,this.bgHeight=375,this.logoWidthTemp=70,this.logoHeightTemp=100,this.textSize=12,this.textHeight=this.textSize+this.textExpandSize,this.textXTrans=.5,this.textYExtraTrans=16):(this.bgWidth=1920,this.bgHeight=1080,this.logoWidthTemp=140,this.logoHeightTemp=200,this.textSize=24,this.textHeight=this.textSize+this.textExpandSize,this.textXTrans=.5,this.textYExtraTrans=32),this.logoXTrans=.5,this.logoYTrans=1/6+2.5/6,this.initScale()}initScale(){const t=this.swapchain.width,e=this.swapchain.height;let i=this.isMobile?375:1080,s=this.isMobile?812:1920;if(t>e){const t=s;s=i,i=t}this.scaleSize=t/e>16/9?e/s:t/i}update(t){const e=this.settings,{device:i,swapchain:s}=this;Rs.ortho(this.projection,-1,1,-1,1,-1,1,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY,s.surfaceTransform);const r=s.width,n=s.height;this.initScale(),this._curTime+=1e3*t;const o=dh(mi(this._curTime/e.totalTime));let a=1,h=1;"custom"===this.settings.background.type&&(this.settings.policy===mP.FIXED_WIDTH?(a=r,h=r/this.bgImage.width*this.bgImage.height):this.settings.policy===mP.FIXED_HEIGHT?(a=n/this.bgImage.height*this.bgImage.width,h=n):this.settings.policy===mP.SHOW_ALL?this.bgImage.width/this.bgHeight>r/n?(a=r,h=r/this.bgImage.width*this.bgImage.height):(a=n/this.bgImage.height*this.bgImage.width,h=n):this.settings.policy===mP.NO_BORDER?this.bgImage.width/this.bgImage.height>r/n?(a=n/this.bgImage.height*this.bgImage.width,h=n):(a=r,h=r/this.bgImage.width*this.bgImage.height):(a=r,h=n),this.bgMat.setProperty("resolution",vP.set(r,n),0),this.bgMat.setProperty("scale",vP.set(a,h),0),this.bgMat.setProperty("translate",vP.set(.5*r,.5*n),0),this.bgMat.setProperty("percent",1),this.bgMat.setProperty("u_projection",this.projection),this.bgMat.passes[0].update());const l=n*this.logoYTrans;if("none"!==this.settings.logo.type&&(h=.185*n*e.displayRatio,a=this.logoWidth*(.185*n/this.logoHeight)*e.displayRatio,this.logoMat.setProperty("resolution",vP.set(r,n),0),this.logoMat.setProperty("scale",vP.set(a,h),0),this.logoMat.setProperty("translate",vP.set(r*this.logoXTrans,l),0),this.logoMat.setProperty("percent",o),this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update()),"default"===this.settings.logo.type&&this.watermarkMat){const t=this.watermarkTexture.width,i=this.watermarkTexture.height;a=t,h=i;const s=l-(.5*this.logoHeight*e.displayRatio+this.textYExtraTrans)*this.scaleSize-.5*i;this.watermarkMat.setProperty("resolution",vP.set(r,n),0),this.watermarkMat.setProperty("scale",vP.set(a,h),0),this.watermarkMat.setProperty("translate",vP.set(r*this.textXTrans,s),0),this.watermarkMat.setProperty("percent",o),this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update()}this.frame()}initBG(){const t=this.device;this.bgMat=new Lw,this.bgMat.initialize({effectName:"util/splash-screen"});const e=new Od;e.addressU=2,e.addressV=2,e.addressW=2,this.sampler=t.getSampler(e),this.bgTexture=t.createTexture(new Bd(1,6,35,this.bgImage.width,this.bgImage.height));const i=this.bgMat.passes[0],s=i.getBinding("mainTexture");i.bindTexture(s,this.bgTexture),this.shader=i.getShaderVariant();const r=i.descriptorSet;r.bindSampler(s,this.sampler),r.update();const n=new bd;n.texExtent.width=this.bgImage.width,n.texExtent.height=this.bgImage.height,n.texExtent.depth=1,t.copyTexImagesToTexture([this.bgImage],this.bgTexture,[n])}initLogo(){const t=this.device;this.logoMat=new Lw,this.logoMat.initialize({effectName:"util/splash-screen"});const e=new Od;e.addressU=2,e.addressV=2,e.addressW=2,this.sampler=t.getSampler(e),this.logoTexture=t.createTexture(new Bd(1,6,35,this.logoImage.width,this.logoImage.height));const i=this.logoMat.passes[0],s=i.getBinding("mainTexture");i.bindTexture(s,this.logoTexture),this.shader=i.getShaderVariant();const r=i.descriptorSet;r.bindSampler(s,this.sampler),r.update();const n=new bd;n.texExtent.width=this.logoImage.width,n.texExtent.height=this.logoImage.height,n.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[n]);const o=this.logoImage.width/this.logoImage.height;o<1?(this.logoWidth=this.logoWidthTemp,this.logoHeight=this.logoWidthTemp/o):(this.logoWidth=this.logoHeightTemp*o,this.logoHeight=this.logoHeightTemp)}initWaterMark(){const t=u.document.createElement("canvas");t.height=this.textHeight*this.scaleSize,t.style.width=`${t.width}`,t.style.height=`${t.height}`;const e="Created with Cocos",i=t.getContext("2d");i.font=this.textSize*this.scaleSize+"px Arial",i.textBaseline="top",i.textAlign="center",i.fillStyle="#707070";const s=i.measureText(e).width+10;t.width=s,i.font=this.textSize*this.scaleSize+"px Arial",i.textBaseline="top",i.textAlign="center",i.fillStyle="#707070",i.fillText(e,t.width/2,0);const r=new bd;r.texExtent.width=t.width,r.texExtent.height=t.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Bd(1,6,35,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[r]),this.watermarkMat=new Lw,this.watermarkMat.initialize({effectName:"util/splash-screen"});const n=this.watermarkMat.passes[0],o=n.getBinding("mainTexture");n.bindTexture(o,this.watermarkTexture),n.descriptorSet.update()}frame(){const{device:t,swapchain:e}=this;if(!Hn.isXR||xr.entry.isRenderAllowable()){const i=Hn.isXR?2:1;for(let s=0;s<i;s++){if(Hn.isXR){xr.entry.renderLoopStart(s);const i=xr.entry.getEyeFov(s);let r=1,n=1;0===s?r=Math.abs(Math.tan(i[0]))/Math.abs(Math.tan(i[1])):1===s&&(n=Math.abs(Math.tan(i[1]))/Math.abs(Math.tan(i[0]))),Rs.ortho(this.projection,-r,n,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,e.surfaceTransform),this.projection.m00=Is[e.surfaceTransform][0],this.projection.m05=Is[e.surfaceTransform][3]*t.capabilities.clipSpaceSignY,"custom"===this.settings.background.type&&(this.bgMat.setProperty("u_projection",this.projection),this.bgMat.passes[0].update()),"none"!==this.settings.logo.type&&(this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update()),"default"===this.settings.logo.type&&this.watermarkMat&&(this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update())}t.enableAutoBarrier(!0),t.acquire([e]);const i=this.cmdBuff,r=h.director.root.mainWindow.framebuffer,n=this.renderArea;n.width=e.width,n.height=e.height,i.begin(),i.beginRenderPass(r.renderPass,r,n,this.clearColors,1,0);const o=h.director.root.pipeline;if("custom"===this.settings.background.type){const e=this.bgMat.passes[0],s=Sw.getOrCreatePipelineState(t,e,this.shader,r.renderPass,this.quadAssmebler);i.bindPipelineState(s),i.bindDescriptorSet(0,o.descriptorSet),i.bindDescriptorSet(1,e.descriptorSet),i.bindInputAssembler(this.quadAssmebler),i.draw(this.quadAssmebler)}if("none"!==this.settings.logo.type){const e=this.logoMat.passes[0],s=Sw.getOrCreatePipelineState(t,e,this.shader,r.renderPass,this.quadAssmebler);i.bindPipelineState(s),i.bindDescriptorSet(0,o.descriptorSet),i.bindDescriptorSet(1,e.descriptorSet),i.bindInputAssembler(this.quadAssmebler),i.draw(this.quadAssmebler)}if("default"===this.settings.logo.type&&this.watermarkMat){const e=this.watermarkMat.passes[0],s=Sw.getOrCreatePipelineState(t,e,this.shader,r.renderPass,this.quadAssmebler);i.bindPipelineState(s),i.bindDescriptorSet(0,o.descriptorSet),i.bindDescriptorSet(1,e.descriptorSet),i.bindInputAssembler(this.quadAssmebler),i.draw(this.quadAssmebler)}i.endRenderPass(),i.end(),t.flushCommands([i]),t.queue.submit([i]),t.present(),t.enableAutoBarrier(!l.rendering),Hn.isXR&&xr.entry.renderLoopEnd(s)}}}destroy(){this.device=null,this.swapchain=null,this.clearColors=null,this.bgImage&&(this.bgImage.destroy&&this.bgImage.destroy(),this.bgImage=null),this.bgMat&&(this.bgMat.destroy(),this.bgMat=null),this.bgTexture&&(this.bgTexture.destroy(),this.bgTexture=null),this.logoImage&&(this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null),this.logoMat&&(this.logoMat.destroy(),this.logoMat=null),this.logoTexture&&(this.logoTexture.destroy(),this.logoTexture=null),this.renderArea=null,this.cmdBuff=null,this.shader=null,this.quadAssmebler&&(this.quadAssmebler.destroy(),this.quadAssmebler=null),this.vertexBuffers&&(this.vertexBuffers.destroy(),this.vertexBuffers=null),this.indicesBuffers&&(this.indicesBuffers.destroy(),this.indicesBuffers=null),this.sampler=null,this.watermarkMat&&(this.watermarkMat.destroy(),this.watermarkMat=null),this.watermarkTexture&&(this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null}static get instance(){return bP._ins}static createInstance(){return bP._ins=new bP,bP._ins}static releaseInstance(){bP._ins&&(bP._ins.destroy(),bP._ins=null)}constructor(){this.settings=void 0,this._curTime=0,this.device=void 0,this.swapchain=void 0,this.shader=void 0,this.sampler=void 0,this.cmdBuff=void 0,this.quadAssmebler=void 0,this.vertexBuffers=void 0,this.indicesBuffers=void 0,this.renderArea=void 0,this.clearColors=void 0,this.projection=void 0,this.isMobile=!1,this.bgMat=void 0,this.bgImage=void 0,this.bgTexture=void 0,this.logoMat=void 0,this.logoImage=void 0,this.logoTexture=void 0,this.watermarkMat=void 0,this.watermarkTexture=void 0,this.bgWidth=1920,this.bgHeight=1080,this.logoWidthTemp=140,this.logoHeightTemp=200,this.logoWidth=0,this.logoHeight=0,this.logoXTrans=.5,this.logoYTrans=1/6+2.5/6,this.textSize=24,this.textHeight=24,this.textXTrans=.5,this.textYExtraTrans=32,this.textExpandSize=4,this.scaleSize=1}}bP._ins=null,h.internal.SplashScreen=bP;class wP{constructor(){this._stHandle=0,this._onTick=null,this._targetFrameRate=60,this._frameTime=0,this._startTime=0,this._isPlaying=!1,this._frameCount=0,this._callback=null,this._rAF=void 0,this._cAF=void 0,this._handleRAF=()=>{const t=performance.now(),e=t-this._startTime,i=Math.floor(e/this._frameTime);i<0&&(this._startTime=t,this._frameCount=0),i<this._frameCount?this._stHandle=this._rAF.call(window,this._handleRAF):(this._frameCount=i+1,this._callback&&this._callback())},this._frameTime=1e3/this._targetFrameRate,this._rAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame,this._cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame}get targetFrameRate(){return this._targetFrameRate}set targetFrameRate(t){this._targetFrameRate!==t&&(this._targetFrameRate=t,this._frameTime=1e3/this._targetFrameRate,this._isPlaying&&(this.stop(),this.start()))}set onTick(t){this._onTick=t}get onTick(){return this._onTick}start(){var t;if(this._isPlaying)return;const e=void 0===this._rAF||(null===(t=globalThis.__globalXR)||void 0===t?void 0:t.isWebXR),i=()=>{e&&(this._startTime=performance.now()),this._isPlaying&&(this._stHandle=this._stTime(i)),this._onTick&&this._onTick()};this._startTime=performance.now(),this._stHandle=this._stTime(i),this._isPlaying=!0,this._frameCount=0}stop(){this._isPlaying&&(this._ctTime(this._stHandle),this._stHandle=0,this._isPlaying=!1,this._frameCount=0)}_stTime(t){var e;if(void 0===this._rAF||null!==(e=globalThis.__globalXR)&&void 0!==e&&e.isWebXR){const e=performance.now(),i=Math.max(0,e-this._startTime),s=Math.max(0,this._frameTime-i);return setTimeout(t,s)}return this._callback=t,this._rAF.call(window,this._handleRAF)}_ctTime(t){var e;void 0===this._cAF||null!==(e=globalThis.__globalXR)&&void 0!==e&&e.isWebXR?clearTimeout(t):t&&this._cAF.call(window,t)}}const SP=new class{constructor(){this._data=null}init(t){return void 0===t&&(t=""),l.rendering&&l.rendering.enableEffectImport&&t?new Promise(((e,i)=>{{const s=new XMLHttpRequest;s.open("GET",t),s.responseType="arraybuffer",s.onload=()=>{this._data=s.response,e()},s.onerror=()=>{i(new Error("request effect settings failed!"))},s.send(null)}})):Promise.resolve()}get data(){return this._data}};l.effectSettings=SP;class xP extends An{constructor(){super(),this.frame=null,this.container=null,this.canvas=null,this.renderType=-1,this.eventTargetOn=super.on,this.eventTargetOnce=super.once,this.config={},this.onStart=null,this.frameTime=1e3/60,this._isCloning=!1,this._inited=!1,this._engineInited=!1,this._rendererInitialized=!1,this._paused=!0,this._pausedByEngine=!1,this._frameRate=60,this._pacer=null,this._initTime=0,this._startTime=0,this._deltaTime=0,this._useFixedDeltaTime=!1,this._shouldLoadLaunchScene=!0,this.onPreBaseInitDelegate=new Mn,this.onPostBaseInitDelegate=new Mn,this.onPreInfrastructureInitDelegate=new Mn,this.onPostInfrastructureInitDelegate=new Mn,this.onPreSubsystemInitDelegate=new Mn,this.onPostSubsystemInitDelegate=new Mn,this.onPreProjectInitDelegate=new Mn,this.onPostProjectInitDelegate=new Mn}get inited(){return this._inited}get frameRate(){return this._frameRate}set frameRate(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._pacer&&(this._pacer.targetFrameRate=this._frameRate)}get deltaTime(){return this._useFixedDeltaTime?this.frameTime/1e3:this._deltaTime}get totalTime(){return performance.now()-this._initTime}get frameStartTime(){return this._startTime}setFrameRate(t){this.frameRate=t}getFrameRate(){return this.frameRate}step(){uP.tick(this._calculateDT(!0))}pauseByEngine(){this._paused||(this._pausedByEngine=!0,this.pause())}resumeByEngine(){this._pausedByEngine&&(this.resume(),this._pausedByEngine=!1)}pause(){var t;this._paused||(this._paused=!0,null===(t=this._pacer)||void 0===t||t.stop(),this.emit(xP.EVENT_PAUSE))}resume(){var t;this._paused&&(ZD._clearEvents(),this._paused=!1,null===(t=this._pacer)||void 0===t||t.start(),this.emit(xP.EVENT_RESUME))}isPaused(){return this._paused}restart(){return new Promise((t=>{uP.once("director_end_frame",(()=>t()))})).then((()=>{uP.reset(),h.Object._deferredDestroy(),this.pause(),this.resume(),this._shouldLoadLaunchScene=!0})).then((()=>bP.createInstance().init())).then((()=>{this._safeEmit(xP.EVENT_RESTART)}))}end(){zn.close()}on(t,e,i,s){return this.canRegisterEvent(t)&&e.call(i),this.eventTargetOn(t,e,i,s)}once(t,e,i){return this.canRegisterEvent(t)?e.call(i):this.eventTargetOnce(t,e,i)}canRegisterEvent(t){return this._engineInited&&t===xP.EVENT_ENGINE_INITED||this._inited&&t===xP.EVENT_GAME_INITED||this._rendererInitialized&&t===xP.EVENT_RENDERER_INITED}init(t){return this._compatibleWithOldParams(t),Promise.resolve().then((()=>(this.emit(xP.EVENT_PRE_BASE_INIT),this.onPreBaseInitDelegate.dispatch()))).then((()=>{L(t.debugMode||0)})).then((()=>Hn.init())).then((()=>{this._initEvents()})).then((()=>ae.init(t.settingsPath,t.overrideSettings))).then((()=>(this.emit(xP.EVENT_POST_BASE_INIT),this.onPostBaseInitDelegate.dispatch()))).then((()=>(this.emit(xP.EVENT_PRE_INFRASTRUCTURE_INIT),this.onPreInfrastructureInitDelegate.dispatch()))).then((()=>{le.init(),this._initXR();const t={frame:document.querySelector("#GameDiv"),container:document.querySelector("#Cocos3dGameContainer"),canvas:document.querySelector("#GameCanvas")};return t&&(this.canvas=t.canvas,this.frame=t.frame,this.container=t.container),Vn.init(),gu.init(),e_.init(this.canvas,gm)})).then((()=>{if(ae.querySettings("rendering","customPipeline")){if(!h.rendering)return void j(12109);le.CUSTOM_PIPELINE_NAME||(le.CUSTOM_PIPELINE_NAME="Builtin")}else h.rendering=void 0;uw.init(),pw.init(),Kf.init(),this.initPacer()})).then((()=>(this.emit(xP.EVENT_POST_INFRASTRUCTURE_INIT),this.onPostInfrastructureInitDelegate.dispatch()))).then((()=>(this.emit(xP.EVENT_PRE_SUBSYSTEM_INIT),this.onPreSubsystemInitDelegate.dispatch()))).then((()=>SP.init(ae.querySettings("rendering","effectSettingsPath")))).then((()=>{if(!h.rendering||!h.rendering.enableEffectImport)return;if(3===ae.querySettings("rendering","renderMode"))return void h.rendering.init(e_.gfxDevice,null);const t=SP.data;null!==t?h.rendering.init(e_.gfxDevice,t):j(1102)})).then((()=>{const t=ae.querySettings("scripting","scriptPackages");return t?Promise.all(t.map((t=>e.import(t)))):Promise.resolve([])})).then((()=>(uP.init(),pw.loadBuiltinAssets()))).then((()=>(this.emit(xP.EVENT_POST_SUBSYSTEM_INIT),this.onPostSubsystemInitDelegate.dispatch()))).then((()=>{M(`Cocos Creator v${c}`),this.emit(xP.EVENT_ENGINE_INITED),this._engineInited=!0})).then((()=>(this.emit(xP.EVENT_PRE_PROJECT_INIT),this.onPreProjectInitDelegate.dispatch()))).then((()=>{const t=ae.querySettings("plugins","jsList");let e=Promise.resolve();return t&&t.forEach((t=>{e=e.then((()=>{return e=`src/${t}`,new Promise(((t,i)=>{let s;function r(t){t.filename===e&&(s=t.error)}window.addEventListener("error",r);const n=document.createElement("script");n.charset="utf-8",n.async=!0,n.crossOrigin="anonymous",n.addEventListener("error",(()=>{window.removeEventListener("error",r),i(Error(`Error loading ${e}`))})),n.addEventListener("load",(()=>{window.removeEventListener("error",r),document.head.removeChild(n),s?i(s):t()})),n.src=e.replace("#","%23"),document.head.appendChild(n)}));var e}))})),e})).then((()=>this._loadProjectBundles())).then((()=>this._loadCCEScripts())).then((()=>this._setupRenderPipeline())).then((()=>this._loadPreloadAssets())).then((()=>(pw.compileBuiltinMaterial(),bP.createInstance().init()))).then((()=>(this.emit(xP.EVENT_POST_PROJECT_INIT),this.onPostProjectInitDelegate.dispatch()))).then((()=>{this._inited=!0,this._safeEmit(xP.EVENT_GAME_INITED)}))}_initXR(){var t;if(void 0===globalThis.__globalXR&&(globalThis.__globalXR={}),globalThis.__globalXR.webxrCompatible=null!==(t=ae.querySettings("xr","webxrCompatible"))&&void 0!==t&&t,Hn.isXR){var e,i;xr.entry=xr.XrEntry.getInstance();const t=null!==(e=ae.querySettings("rendering","msaa"))&&void 0!==e?e:1,s=null!==(i=ae.querySettings("rendering","renderingScale"))&&void 0!==i?i:1;xr.entry.setMultisamplesRTT(t),xr.entry.setRenderingScale(s)}}_compatibleWithOldParams(t){const e=t.overrideSettings=t.overrideSettings||{};"showFPS"in t&&(e.profiling=e.profiling||{},e.profiling.showFPS=t.showFPS),"frameRate"in t&&(e.screen=e.screen||{},e.screen.frameRate=t.frameRate),"renderMode"in t&&(e.rendering=e.rendering||{},e.rendering.renderMode=t.renderMode),"renderPipeline"in t&&(e.rendering=e.rendering||{},e.rendering.renderPipeline=t.renderPipeline),"assetOptions"in t&&(e.assets=e.assets||{},Object.assign(e.assets,t.assetOptions)),"customJointTextureLayouts"in t&&(e.animation=e.animation||{},e.animation.customJointTextureLayouts=t.customJointTextureLayouts),"physics"in t&&(e.physics=e.physics||{},Object.assign(e.physics,t.physics)),"orientation"in t&&(e.screen=e.screen||{},e.screen.orientation=t.orientation),"exactFitScreen"in t&&(e.screen=e.screen||{},e.screen.exactFitScreen=t.exactFitScreen)}_loadPreloadAssets(){const t=ae.querySettings("assets","preloadAssets");return t?Promise.all(t.map((t=>new Promise(((e,i)=>{uw.loadAny(t,(t=>{t?i(t):e()}))}))))):Promise.resolve([])}_loadCCEScripts(){return new Promise((t=>{t()}))}_loadProjectBundles(){const t=ae.querySettings("assets","preloadBundles");return t?Promise.all(t.map((t=>{let{bundle:e,version:i}=t;return new Promise(((t,s)=>{const r={};i&&(r.version=i),uw.loadBundle(e,r,(e=>{e?s(e):t()}))}))}))):Promise.resolve([])}run(t){t&&(this.onStart=t),this._inited&&this.resume()}_calculateDT(t){if(this._useFixedDeltaTime=t,t)return this._startTime=performance.now(),this.frameTime/1e3;const e=performance.now();return this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>xP.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime}_updateCallback(){if(this._inited)if(bP.instance&&!bP.instance.isFinished)bP.instance.update(this._calculateDT(!1));else if(this._shouldLoadLaunchScene){bP.releaseInstance(),this._shouldLoadLaunchScene=!1;const e=ae.querySettings("launch","launchScene");var t;e?uP.loadScene(e,(()=>{var t;N(1103,e),this._initTime=performance.now(),uP.startAnimation(),null===(t=this.onStart)||void 0===t||t.call(this)})):(this._initTime=performance.now(),uP.startAnimation(),null===(t=this.onStart)||void 0===t||t.call(this))}else uP.tick(this._calculateDT(!1))}initPacer(){var t;const e=null!==(t=ae.querySettings("screen","frameRate"))&&void 0!==t?t:60;R("number"==typeof e),this._pacer=new wP,this._pacer.onTick=this._updateCallback.bind(this),this.frameRate=e}_initEvents(){zn.on("show",this._onShow,this),zn.on("hide",this._onHide,this),zn.on("close",this._onClose,this)}_onHide(){this.emit(xP.EVENT_HIDE),this.pauseByEngine()}_onShow(){this.emit(xP.EVENT_SHOW),this.resumeByEngine()}_onClose(){this.emit(xP.EVENT_CLOSE),zn.exit()}addPersistRootNode(t){uP.addPersistRootNode(t)}removePersistRootNode(t){uP.removePersistRootNode(t)}isPersistRootNode(t){return uP.isPersistRootNode(t)}_setupRenderPipeline(){const t=ae.querySettings("rendering","customPipeline");return this._setRenderPipeline(!!t)}_setRenderPipeline(t){uP.root.setRenderPipeline(t)?(this._rendererInitialized=!0,this._safeEmit(xP.EVENT_RENDERER_INITED)):j(1222)}_safeEmit(t){this.emit(t)}}t("Game",xP),xP.EVENT_HIDE="game_on_hide",xP.EVENT_SHOW="game_on_show",xP.EVENT_LOW_MEMORY="game_on_low_memory",xP.EVENT_GAME_INITED="game_inited",xP.EVENT_ENGINE_INITED="engine_inited",xP.EVENT_RENDERER_INITED="renderer_inited",xP.EVENT_PRE_BASE_INIT="pre_base_init",xP.EVENT_POST_BASE_INIT="post_base_init",xP.EVENT_PRE_INFRASTRUCTURE_INIT="pre_infrastructure_init",xP.EVENT_POST_INFRASTRUCTURE_INIT="post_infrastructure_init",xP.EVENT_PRE_SUBSYSTEM_INIT="pre_subsystem_init",xP.EVENT_POST_SUBSYSTEM_INIT="post_subsystem_init",xP.EVENT_PRE_PROJECT_INIT="pre_project_init",xP.EVENT_POST_PROJECT_INIT="post_project_init",xP.EVENT_RESTART="game_on_restart",xP.EVENT_PAUSE="game_on_pause",xP.EVENT_RESUME="game_on_resume",xP.EVENT_CLOSE="game_on_close",xP.RENDER_TYPE_CANVAS=0,xP.RENDER_TYPE_WEBGL=1,xP.RENDER_TYPE_OPENGL=2,xP.RENDER_TYPE_HEADLESS=3,xP.DEBUG_DT_THRESHOLD=1,h.Game=xP;const TP=t("game",h.game=new xP);class CP extends su{constructor(){super(),this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){this._enabled!==t&&(t?(this.reset(),uP.on("director_before_scene_launch",this.beforeSceneLoad,this)):(this.reset(),uP.off("director_before_scene_launch",this.beforeSceneLoad,this)),this._enabled=t)}get maxAtlasCount(){return this._maxAtlasCount}set maxAtlasCount(t){this._maxAtlasCount=t}get atlasCount(){return this._atlases.length}get textureBleeding(){return this._textureBleeding}set textureBleeding(t){this._textureBleeding=t}get textureSize(){return this._textureSize}set textureSize(t){this._textureSize=t}get maxFrameSize(){return this._maxFrameSize}set maxFrameSize(t){this._maxFrameSize=t}newAtlas(){let t=this._atlases[++this._atlasIndex];return!t&&this._atlasIndex<this.maxAtlasCount&&(t=new Xf(this._textureSize,this._textureSize),this._atlases.push(t)),t}beforeSceneLoad(){this.reset()}init(){this.enabled=!le.CLEANUP_IMAGE_CACHE}insertSpriteFrame(t){if(!this._enabled||this._atlasIndex>=this._maxAtlasCount||!t||t.original)return null;if(!t.packable)return null;const e=t.texture.getSamplerInfo();if(2!==e.minFilter||2!==e.magFilter||0!==e.mipFilter)return null;let i=this._atlases[this._atlasIndex];i||(i=this.newAtlas());const s=i?i.insertSpriteFrame(t):null;return!s&&this._atlasIndex<this._maxAtlasCount?(i=this.newAtlas(),i?i.insertSpriteFrame(t):null):s}reset(){for(let t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1}deleteAtlasSpriteFrame(t){if(!t.original)return;let e;for(let i=this._atlases.length-1;i>=0;i--)e=this._atlases[i],e.removeSpriteFrame(t);const i=t.original._texture;this.deleteAtlasTexture(i)}deleteAtlasTexture(t){if(t)for(let e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)}packToDynamicAtlas(t,e){if(this._enabled&&e&&!e.original&&e.packable&&e.texture&&e.texture.width>0&&e.texture.height>0){const t=this.insertSpriteFrame(e);t&&e._setDynamicAtlasFrame(t)}}}t("DynamicAtlasManager",CP),CP.instance=void 0;const IP=t("dynamicAtlasManager",CP.instance=new CP);uP.registerSystem("dynamicAtlasManager",IP,0),h.internal.dynamicAtlasManager=IP;const EP={positions:"a_position",normals:"a_normal",uvs:"a_texCoord",colors:"a_color"};class DP{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(t){if(0!==t){const e=this._length%t;if(0!==e){const i=t-e;this._arrayBufferOrPaddings.push(i),this._length+=i}}}addBuffer(t){const e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e}getLength(){return this._length}getCombined(){const t=new Uint8Array(this._length);let e=0;return this._arrayBufferOrPaddings.forEach((i=>{"number"==typeof i?e+=i:(t.set(new Uint8Array(i),e),e+=i.byteLength)})),t.buffer}}function AP(t,e){return new MP(t,e)}class MP{constructor(t,e){if(this._subMeshRenderings=[],this._mesh=t,!this._mesh.struct.morph)return;const i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(let t=0;t<i;++t){const i=this._mesh.struct.morph.subMeshMorphs[t];i&&(i.targets.length>60?this._subMeshRenderings[t]=new BP(this._mesh,t,this._mesh.struct.morph,e):this._subMeshRenderings[t]=new PP(this._mesh,t,this._mesh.struct.morph,e))}}createInstance(){const t=this._mesh.struct.primitives.length,e=new Array(t);for(let r=0;r<t;++r){var i,s;e[r]=null!==(i=null===(s=this._subMeshRenderings[r])||void 0===s?void 0:s.createInstance())&&void 0!==i?i:null}return{setWeights(t,i){var s;null===(s=e[t])||void 0===s||s.setWeights(i)},requiredPatches:t=>{this._mesh.struct.morph;const i=this._mesh.struct.morph.subMeshMorphs[t],s=e[t];if(null===s)return null;const r=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes("a_position")&&r.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes("a_normal")&&r.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes("a_tangent")&&r.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),r.push(...s.requiredPatches()),r},adaptPipelineState:(t,i)=>{var s;null===(s=e[t])||void 0===s||s.adaptPipelineState(i)},destroy:()=>{for(const t of e)null==t||t.destroy()}}}}class PP{constructor(t,e,i,s){this._gfxDevice=s;const r=i.subMeshMorphs[e];this._subMeshMorph=r,FP(t,e,s);const n=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=n;const o=r.targets.length,a=LP(s,n*o);this._textureInfo={width:a.width,height:a.height},this._attributes=r.attributes.map(((e,i)=>{const s=a.create(),o=s.valueView;return r.targets.forEach(((e,s)=>{const r=e.displacements[i],a=new Float32Array(t.data.buffer,t.data.byteOffset+r.offset,r.count),h=n*s*4;for(let t=0;t<n;++t)o[h+4*t+0]=a[3*t+0],o[h+4*t+1]=a[3*t+1],o[h+4*t+2]=a[3*t+2]})),s.updatePixels(),{name:e,morphTexture:s}}))}destroy(){for(const t of this._attributes)t.morphTexture.destroy()}createInstance(){const t=new OP(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:e=>{t.setWeights(e),t.commit()},requiredPatches:()=>[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}],adaptPipelineState:e=>{for(const t of this._attributes){let i;switch(t.name){case"a_position":i=8;break;case"a_normal":i=9;break;case"a_tangent":i=10;break;default:G(16374)}void 0!==i&&(e.bindSampler(i,t.morphTexture.sampler),e.bindTexture(i,t.morphTexture.texture))}e.bindBuffer(Wm.BINDING,t.buffer),e.update()},destroy:()=>{}}}}class BP{constructor(t,e,i,s){this._attributes=[],this._gfxDevice=s;const r=i.subMeshMorphs[e];FP(t,e,s),this._attributes=r.attributes.map(((e,i)=>({name:e,targets:r.targets.map((e=>({displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[i].offset,e.displacements[i].count)})))})))}get data(){return this._attributes}createInstance(){return new RP(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)}}class RP{constructor(t,e,i){this._owner=t,this._morphUniforms=new OP(i,0);const s=LP(i,e);this._morphUniforms.setMorphTextureInfo(s.width,s.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((t=>{const e=s.create();return{attributeName:t.name,morphTexture:e}}))}setWeights(t){for(let e=0;e<this._attributes.length;++e){const i=this._attributes[e],s=i.morphTexture.valueView,r=this._owner.data[e];t.length,r.targets.length;for(let e=0;e<r.targets.length;++e){const i=r.targets[e].displacements,n=t[e],o=i.length/3;if(0===e)for(let t=0;t<o;++t)s[4*t+0]=i[3*t+0]*n,s[4*t+1]=i[3*t+1]*n,s[4*t+2]=i[3*t+2]*n;else if(0!==n)for(let t=0;t<o;++t)s[4*t+0]+=i[3*t+0]*n,s[4*t+1]+=i[3*t+1]*n,s[4*t+2]+=i[3*t+2]*n}i.morphTexture.updatePixels()}}requiredPatches(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]}adaptPipelineState(t){for(const e of this._attributes){let i;switch(e.attributeName){case"a_position":i=8;break;case"a_normal":i=9;break;case"a_tangent":i=10;break;default:G(16374)}void 0!==i&&(t.bindSampler(i,e.morphTexture.sampler),t.bindTexture(i,e.morphTexture.texture))}t.bindBuffer(Wm.BINDING,this._morphUniforms.buffer),t.update()}destroy(){this._morphUniforms.destroy();for(let t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()}}class OP{constructor(t,e){this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(256)),this._remoteBuffer=t.createBuffer(new Ed(18,3,256,256))}destroy(){this._remoteBuffer.destroy()}get buffer(){return this._remoteBuffer}setWeights(t){t.length,this._targetCount;const e=h.sys.isLittleEndian;for(let i=0;i<t.length;++i)this._localBuffer.setFloat32(0+4*i,t[i],e)}setMorphTextureInfo(t,e){const i=h.sys.isLittleEndian;this._localBuffer.setFloat32(240,t,i),this._localBuffer.setFloat32(244,e,i)}setVerticesCount(t){const e=h.sys.isLittleEndian;this._localBuffer.setFloat32(248,t,e)}commit(){this._remoteBuffer.update(this._localBuffer.buffer)}}function LP(t,e){let i,s,r,n;2&t.getFormatFeatures(44)?(i=e,r=16,s=44,n=Float32Array):(i=4*e,r=4,s=35,n=Uint8Array);const{width:o,height:a}=zP(i);return{width:o,height:a,create:()=>{const e=new ArrayBuffer(o*a*r),i=new Float32Array(e),h=n===Float32Array?i:new n(e),l=new j_({width:o,height:a,_data:h,_compressed:!1,format:s}),c=new qf;c.setFilters(1,1),c.setMipFilter(0),c.setWrapMode(2,2,2),c.image=l,c.getGFXTexture()||G(16375);const u=t.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return u},get valueView(){return i},destroy(){c.destroy()},updatePixels(){c.uploadData(h)}}}}}function FP(t,e,i){t.renderingSubMeshes[e].enableVertexIdChannel(i)}function zP(t){t<5&&(t=5);const e=g(Di(t)),i=e>>1;return{width:1<<(1&e?i+1:i),height:1<<i}}function kP(t,i){return(s=t,new Promise(((t,i)=>{try{s=new URL(s,e.meta.url).href,fetch(s).then((e=>e.arrayBuffer().then(t))).catch((()=>{}))}catch(t){i(t)}}))).then((t=>WebAssembly.instantiate(t,i)));var s}function NP(){return Promise.resolve()}const UP={};TP.onPostInfrastructureInitDelegate.add((function(){return NP().then((()=>Promise.all([e.import("./meshopt_decoder.wasm-DKe5VOQW.js"),e.import("./meshopt_decoder.wasm-Cvy1kpGq.js")]).then((t=>{let[{default:e},{default:i}]=t;return s=e,r=i,Promise.all([s.ready((function(t){return kP(r,t)}))]).then((()=>{UP.supported=s.supported,UP.ready=Promise.resolve(),UP.decodeVertexBuffer=s.decodeVertexBuffer,UP.decodeIndexBuffer=s.decodeIndexBuffer,UP.decodeIndexSequence=s.decodeIndexSequence,UP.decodeGltfBuffer=s.decodeGltfBuffer,UP.useWorkers=s.useWorkers,UP.decodeGltfBufferAsync=s.decodeGltfBufferAsync,N(14203)}));var s,r})))).catch((t=>{B(t)}))}));var VP={};(function(){function t(t){throw t}var e=void 0,i=this;function s(t,s){var r,n=t.split("."),o=i;!(n[0]in o)&&o.execScript&&o.execScript("var "+n[0]);for(;n.length&&(r=n.shift());)n.length||s===e?o=o[r]?o[r]:o[r]={}:o[r]=s}var r="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function n(t){var e,i,s,n,o,a,h,l,c,u,d=t.length,p=0,_=Number.POSITIVE_INFINITY;for(l=0;l<d;++l)t[l]>p&&(p=t[l]),t[l]<_&&(_=t[l]);for(e=1<<p,i=new(r?Uint32Array:Array)(e),s=1,n=0,o=2;s<=p;){for(l=0;l<d;++l)if(t[l]===s){for(a=0,h=n,c=0;c<s;++c)a=a<<1|1&h,h>>=1;for(u=s<<16|l,c=a;c<e;c+=o)i[c]=u;++n}++s,n<<=1,o<<=1}return[i,p,_]}function o(e,i){switch(this.g=[],this.h=32768,this.d=this.f=this.a=this.j=0,this.input=r?new Uint8Array(e):e,this.k=!1,this.e=h,this.o=!1,!i&&(i={})||(i.index&&(this.a=i.index),i.bufferSize&&(this.h=i.bufferSize),i.bufferType&&(this.e=i.bufferType),i.resize&&(this.o=i.resize)),this.e){case a:this.b=32768,this.c=new(r?Uint8Array:Array)(32768+this.h+258);break;case h:this.b=0,this.c=new(r?Uint8Array:Array)(this.h);break;default:t(Error("invalid inflate mode"))}}var a=0,h=1,l={q:a,p:h};o.prototype.i=function(){for(;!this.k;){var i=D(this,3);switch(1&i&&(this.k=!0),i>>>=1){case 0:var s=this.input,o=this.a,l=this.c,c=this.b,u=s.length,d=e,_=l.length,g=e;switch(this.d=this.f=0,o+1>=u&&t(Error("invalid uncompressed block header: LEN")),d=s[o++]|s[o++]<<8,o+1>=u&&t(Error("invalid uncompressed block header: NLEN")),d===~(s[o++]|s[o++]<<8)&&t(Error("invalid uncompressed block header: length verify")),o+d>s.length&&t(Error("input buffer is broken")),this.e){case a:for(;c+d>l.length;){if(d-=g=_-c,r)l.set(s.subarray(o,o+g),c),c+=g,o+=g;else for(;g--;)l[c++]=s[o++];this.b=c,l=B(this),c=this.b}break;case h:for(;c+d>l.length;)l=R(this,{m:2});break;default:t(Error("invalid inflate mode"))}if(r)l.set(s.subarray(o,o+d),c),c+=d,o+=d;else for(;d--;)l[c++]=s[o++];this.a=o,this.b=c,this.c=l;break;case 1:switch(this.e){case h:P(this,C,E);break;case a:M(this,C,E);break;default:t(Error("invalid inflate mode"))}break;case 2:var f,m,y,v,b=D(this,5)+257,w=D(this,5)+1,S=D(this,4)+4,x=new(r?Uint8Array:Array)(p.length),T=e,I=e,O=e,L=e,F=e;for(F=0;F<S;++F)x[p[F]]=D(this,3);if(!r)for(F=S,S=x.length;F<S;++F)x[p[F]]=0;for(f=n(x),T=new(r?Uint8Array:Array)(b+w),F=0,v=b+w;F<v;)switch(I=A(this,f),I){case 16:for(L=3+D(this,2);L--;)T[F++]=O;break;case 17:for(L=3+D(this,3);L--;)T[F++]=0;O=0;break;case 18:for(L=11+D(this,7);L--;)T[F++]=0;O=0;break;default:O=T[F++]=I}switch(m=n(r?T.subarray(0,b):T.slice(0,b)),y=n(r?T.subarray(b):T.slice(b)),this.e){case h:P(this,m,y);break;case a:M(this,m,y);break;default:t(Error("invalid inflate mode"))}break;default:t(Error("unknown BTYPE: "+i))}}switch(this.e){case a:var z,k,N,U,V,H,G=0,W=this.c,j=this.g,$=new(r?Uint8Array:Array)(this.j+(this.b-32768));if(0===j.length)z=r?this.c.subarray(32768,this.b):this.c.slice(32768,this.b);else{for(N=0,U=j.length;N<U;++N)for(V=0,H=(k=j[N]).length;V<H;++V)$[G++]=k[V];for(N=32768,U=this.b;N<U;++N)$[G++]=W[N];this.g=[],z=this.buffer=$}return z;case h:var q,X=this.b;return r?this.o?(q=new Uint8Array(X)).set(this.c.subarray(0,X)):q=this.c.subarray(0,X):(this.c.length>X&&(this.c.length=X),q=this.c),this.buffer=q;default:t(Error("invalid inflate mode"))}};var c,u,d=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],p=r?new Uint16Array(d):d,_=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],g=r?new Uint16Array(_):_,f=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],m=r?new Uint8Array(f):f,y=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],v=r?new Uint16Array(y):y,b=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],w=r?new Uint8Array(b):b,S=new(r?Uint8Array:Array)(288);for(c=0,u=S.length;c<u;++c)S[c]=143>=c?8:255>=c?9:279>=c?7:8;var x,T,C=n(S),I=new(r?Uint8Array:Array)(30);for(x=0,T=I.length;x<T;++x)I[x]=5;var E=n(I);function D(e,i){var s,r=e.f,n=e.d,o=e.input,a=e.a;for(a+(i-n+7>>3)>=o.length&&t(Error("input buffer is broken"));n<i;)r|=o[a++]<<n,n+=8;return s=r&(1<<i)-1,e.f=r>>>i,e.d=n-i,e.a=a,s}function A(e,i){for(var s,r,n=e.f,o=e.d,a=e.input,h=e.a,l=a.length,c=i[0],u=i[1];o<u&&!(h>=l);)n|=a[h++]<<o,o+=8;return(r=(s=c[n&(1<<u)-1])>>>16)>o&&t(Error("invalid code length: "+r)),e.f=n>>r,e.d=o-r,e.a=h,65535&s}function M(t,e,i){var s=t.c,r=t.b;t.l=e;for(var n,o,a,h,l=s.length-258;256!==(n=A(t,e));)if(256>n)r>=l&&(t.b=r,s=B(t),r=t.b),s[r++]=n;else for(h=g[o=n-257],0<m[o]&&(h+=D(t,m[o])),n=A(t,i),a=v[n],0<w[n]&&(a+=D(t,w[n])),r>=l&&(t.b=r,s=B(t),r=t.b);h--;)s[r]=s[r++-a];for(;8<=t.d;)t.d-=8,t.a--;t.b=r}function P(t,e,i){var s=t.c,r=t.b;t.l=e;for(var n,o,a,h,l=s.length;256!==(n=A(t,e));)if(256>n)r>=l&&(l=(s=R(t)).length),s[r++]=n;else for(h=g[o=n-257],0<m[o]&&(h+=D(t,m[o])),n=A(t,i),a=v[n],0<w[n]&&(a+=D(t,w[n])),r+h>l&&(l=(s=R(t)).length);h--;)s[r]=s[r++-a];for(;8<=t.d;)t.d-=8,t.a--;t.b=r}function B(t){var e,i,s=new(r?Uint8Array:Array)(t.b-32768),n=t.b-32768,o=t.c;if(r)s.set(o.subarray(32768,s.length));else for(e=0,i=s.length;e<i;++e)s[e]=o[e+32768];if(t.g.push(s),t.j+=s.length,r)o.set(o.subarray(n,n+32768));else for(e=0;32768>e;++e)o[e]=o[n+e];return t.b=32768,o}function R(t,e){var i,s,n,o=t.input.length/t.a+1|0,a=t.input,h=t.c;return e&&("number"==typeof e.m&&(o=e.m),"number"==typeof e.r&&(o+=e.r)),s=2>o?(n=(a.length-t.a)/t.l[2]/2*258|0)<h.length?h.length+n:h.length<<1:h.length*o,r?(i=new Uint8Array(s)).set(h):i=h,t.c=i,t.c}function O(e,i){var s,r;this.input=e,this.a=0,!i&&(i={})||(i.index&&(this.a=i.index),i.verify&&(this.s=i.verify)),s=e[this.a++],r=e[this.a++],(15&s)===L?this.method=L:t(Error("unsupported compression method")),0!=((s<<8)+r)%31&&t(Error("invalid fcheck flag:"+((s<<8)+r)%31)),32&r&&t(Error("fdict flag is not supported")),this.n=new o(e,{index:this.a,bufferSize:i.bufferSize,bufferType:i.bufferType,resize:i.resize})}O.prototype.i=function(){var e,i,s=this.input;if(e=this.n.i(),this.a=this.n.a,this.s){i=(s[this.a++]<<24|s[this.a++]<<16|s[this.a++]<<8|s[this.a++])>>>0;var r=e;if("string"==typeof r){var n,o,a=r.split("");for(n=0,o=a.length;n<o;n++)a[n]=(255&a[n].charCodeAt(0))>>>0;r=a}for(var h,l=1,c=0,u=r.length,d=0;0<u;){u-=h=1024<u?1024:u;do{c+=l+=r[d++]}while(--h);l%=65521,c%=65521}i!==(c<<16|l)>>>0&&t(Error("invalid adler-32 checksum"))}return e};var L=8;s("Zlib.Inflate",O),s("Zlib.Inflate.prototype.decompress",O.prototype.i);var F,z,k,N,U={ADAPTIVE:l.p,BLOCK:l.q};if(Object.keys)F=Object.keys(U);else for(z in F=[],k=0,U)F[k++]=z;for(k=0,N=F.length;k<N;++k)s("Zlib.Inflate.BufferType."+(z=F[k]),U[z])}).call(VP);var HP,GP,WP,jP,$P,qP=VP.Zlib;function XP(t){switch(t){case 1:default:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}}qP.Inflate=qP.Inflate,qP.Inflate.BufferType=qP.Inflate.BufferType,qP.Inflate.prototype.decompress=qP.Inflate.prototype.decompress;const YP=new Ki,QP=new Ki,KP=new Uint8Array;let ZP=t("Mesh",oa("cc.Mesh")((GP=class extends F_{get _nativeAsset(){return this._data.buffer}set _nativeAsset(t){this._data=new Uint8Array(t)}get subMeshCount(){const t=this.renderingSubMeshes;return t?t.length:0}get minPosition(){return this.struct.minPosition}get maxPosition(){return this.struct.maxPosition}get struct(){return this._struct}get data(){return this._data}get hash(){return this._hash||(this._hash=du(this._data,666)),this._hash}get jointBufferIndices(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((t=>t.jointMapIndex||0))}get renderingSubMeshes(){return this.initialize(),this._renderingSubMeshes}constructor(){super(),this.morphRendering=null,this._struct=WP&&WP(),this._hash=jP&&jP(),this._data=KP,this._initialized=!1,this._allowDataAccess=$P&&$P(),this._isMeshDataUploaded=!1,this._renderingSubMeshes=null,this._boneSpaceBounds=new Map,this._jointBufferIndices=null}onLoaded(){this.initialize()}initialize(){if(this._initialized)return;this._initialized=!0;let t={struct:this.struct,data:this.data};if(t.struct.compressed&&(t=nB(t)),this.struct.encoded&&(t=rB(t)),!this.struct.quantized||16&e_.gfxDevice.getFormatFeatures(29)||(t=oB(t)),this._struct=t.struct,this._data=t.data,this._struct.dynamic){const t=e_.gfxDevice,e=[],i=[];for(let i=0;i<this._struct.vertexBundles.length;i++){const s=this._struct.vertexBundles[i],r=t.createBuffer(new Ed(10,1,s.view.length,s.view.stride));e.push(r)}for(let s=0;s<this._struct.primitives.length;s++){const r=this._struct.primitives[s],n=r.indexView;let o=null;n&&(o=t.createBuffer(new Ed(6,1,n.length,n.stride)));const a=[];for(let t=0;t<r.vertexBundelIndices.length;t++){const i=r.vertexBundelIndices[t];a.push(e[i])}const h=[];for(let t=0;t<r.vertexBundelIndices.length;t++){const e=r.vertexBundelIndices[t],i=this._struct.vertexBundles[e];for(const t of i.attributes){const e=new Wd;e.copy(t),h.push(e)}}const l=new _S(a,h,r.primitiveMode,o);l.drawInfo=new Ad,l.mesh=this,l.subMeshIdx=s,i.push(l)}this._renderingSubMeshes=i}else{const{buffer:t}=this._data,e=e_.gfxDevice,i=this._createVertexBuffers(e,t),s=[];for(let r=0;r<this._struct.primitives.length;r++){const n=this._struct.primitives[r];if(0===n.vertexBundelIndices.length)continue;let o,a=null;if(n.indexView){const i=n.indexView;let s=i.stride,r=i.length;if(4===s&&!e.hasFeature(0)){const t=this._struct.vertexBundles[n.vertexBundelIndices[0]].view.count;if(t>=65536){G(10001,t,65536);continue}s>>=1,r>>=1}a=e.createBuffer(new Ed(4,1,r,s)),o=new(XP(i.stride))(t,i.offset,i.count),i.stride!==s&&(o=XP(s).from(o)),a.update(o)}const h=n.vertexBundelIndices.map((t=>i[t])),l=[];if(n.vertexBundelIndices.length>0){const t=n.vertexBundelIndices[0],e=this._struct.vertexBundles[t].attributes;for(let t=0;t<e.length;++t){const i=e[t];l[t]=new Wd(i.name,i.format,i.isNormalized,i.stream,i.isInstanced,i.location)}}const c=new _S(h,l,n.primitiveMode,a);c.mesh=this,c.subMeshIdx=r,s.push(c)}this._renderingSubMeshes=s,this._struct.morph&&(this.morphRendering=AP(this,e)),this._isMeshDataUploaded=!0,this._allowDataAccess||this.releaseData()}}updateSubMesh(t,e){if(!this._struct.dynamic)return void G(14200);if(t>=this._struct.primitives.length)return void G(14201);const i=[];if(e.positions.length>0&&i.push(e.positions),e.normals&&e.normals.length>0&&i.push(e.normals),e.uvs&&e.uvs.length>0&&i.push(e.uvs),e.tangents&&e.tangents.length>0&&i.push(e.tangents),e.colors&&e.colors.length>0&&i.push(e.colors),e.customAttributes)for(let t=0;t<e.customAttributes.length;t++)i.push(e.customAttributes[t].values);const s=this._struct.dynamic,r=s.info,n=this._struct.primitives[t],o=this._renderingSubMeshes[t],a=o.drawInfo;for(let t=0;t<i.length;t++){const e=i[t],s=this._struct.vertexBundles[n.vertexBundelIndices[t]],h=s.view.stride,l=e.byteLength/h,c=e.byteLength,u=new Uint8Array(this._data.buffer,s.view.offset,c),d=new Uint8Array(e.buffer,e.byteOffset,c),p=o.vertexBuffers[t];r.maxSubMeshVertices,c>0&&(u.set(d),p.update(d,c)),s.view.count=l,a.vertexCount=l}if(n.indexView){const t=n.indexView,i=t.stride,s=2===i?e.indices16.length:e.indices32.length,h=s*i,l=new Uint8Array(this._data.buffer,t.offset,h),c=2===i?new Uint8Array(e.indices16.buffer,e.indices16.byteOffset,h):new Uint8Array(e.indices32.buffer,e.indices32.byteOffset,h),u=o.indexBuffer;r.maxSubMeshIndices,h>0&&(l.set(c),u.update(c,h)),t.count=s,a.indexCount=s}if(e.minPos&&e.maxPos){const i=new Ki(e.minPos.x,e.minPos.y,e.minPos.z),r=new Ki(e.maxPos.x,e.maxPos.y,e.maxPos.z);s.bounds[t]||(s.bounds[t]=new Qn),Qn.fromPoints(s.bounds[t],i,r);const n=new Ki,o=new Ki;for(const t of s.bounds)t&&(t.getBoundary(n,o),Ki.min(i,n,i),Ki.max(r,o,r));this._struct.minPosition=new Ki(i.x,i.y,i.z),this._struct.maxPosition=new Ki(r.x,r.y,r.z)}o.invalidateGeometricInfo()}destroy(){return this.destroyRenderingMesh(),super.destroy()}destroyRenderingMesh(){if(this._renderingSubMeshes){for(let t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1,this._isMeshDataUploaded=!1}}assign(t,e){this.reset({struct:t,data:e})}reset(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0}getBoneSpaceBounds(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);const e=[];this._boneSpaceBounds.set(t.hash,e);const i=[],{bindposes:s}=t;for(let t=0;t<s.length;t++)e.push(new Qn(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);const{primitives:r}=this._struct;for(let t=0;t<r.length;t++){const r=this.readAttribute(t,"a_joints"),n=this.readAttribute(t,"a_weights"),o=this.readAttribute(t,"a_position");if(!r||!n||!o)continue;const a=Math.min(r.length/4,n.length/4,o.length/3);for(let t=0;t<a;t++){Ki.set(YP,o[3*t+0],o[3*t+1],o[3*t+2]);for(let o=0;o<4;++o){const a=4*t+o,h=r[a];if(0===n[a]||h>=s.length)continue;Ki.transformMat4(QP,YP,s[h]),i[h]=!0;const l=e[h];Ki.min(l.center,l.center,QP),Ki.max(l.halfExtents,l.halfExtents,QP)}}}for(let t=0;t<s.length;t++){const s=e[t];i[t]?Qn.fromPoints(s,s.center,s.halfExtents):e[t]=null}return e}merge(t,e,i){if(i&&!this.validateMergingMesh(t))return!1;const s=new Ki,r=e&&new ys,n=e&&new Qn;if(r&&e.getRotation(r),!this._initialized){const i=JSON.parse(JSON.stringify(t._struct)),o=t._data.slice();if(e){i.maxPosition&&i.minPosition&&(Ki.add(n.center,i.maxPosition,i.minPosition),Ki.multiplyScalar(n.center,n.center,.5),Ki.subtract(n.halfExtents,i.maxPosition,i.minPosition),Ki.multiplyScalar(n.halfExtents,n.halfExtents,.5),Qn.transform(n,n,e),Ki.add(i.maxPosition,n.center,n.halfExtents),Ki.subtract(i.minPosition,n.center,n.halfExtents));for(let t=0;t<i.vertexBundles.length;t++){const n=i.vertexBundles[t];for(let t=0;t<n.attributes.length;t++)if("a_position"===n.attributes[t].name||"a_normal"===n.attributes[t].name){const{format:i}=n.attributes[t],a=new DataView(o.buffer,n.view.offset+JP(n.attributes,t)),h=iB(a,i),l=sB(a,i);if(!h||!l)continue;const c=n.view.count,u=n.view.stride,d=eB(i);for(let i=0;i<c;i++){const o=i*u,a=o+d,c=a+d;switch(s.set(h(o),h(a),h(c)),n.attributes[t].name){case"a_position":s.transformMat4(e);break;case"a_normal":Ki.transformQuat(s,s,r)}l(o,s.x),l(a,s.y),l(c,s.z)}}}}return this.reset({struct:i,data:o}),this.initialize(),!0}const o=new DP;let a,h,l,c,u,d=0,p=0,_=0,g=0,f=0,m=0,y=0,v=0,b=!1;const w=new Array(this._struct.vertexBundles.length);for(let i=0;i<this._struct.vertexBundles.length;++i){const n=this._struct.vertexBundles[i],S=t._struct.vertexBundles[i];_=n.view.offset,g=S.view.offset,p=n.view.stride,d=n.view.count+S.view.count,a=new ArrayBuffer(d*p),h=new Uint8Array(a),l=this._data.subarray(_,_+n.view.length),_+=l.length,c=t._data.subarray(g,g+S.view.length),g+=c.length,h.set(l),f=0;for(const t of n.attributes){y=0,b=!1;for(const e of S.attributes){if(t.name===e.name&&t.format===e.format){b=!0;break}y+=mp[e.format].size}if(b){v=mp[t.format].size,m=n.view.length+f;for(let i=0;i<S.view.count;++i){if(u=c.subarray(y,y+v),h.set(u,m),("a_position"===t.name||"a_normal"===t.name)&&e){const i=new Float32Array(h.buffer,m,3);switch(s.set(i[0],i[1],i[2]),t.name){case"a_position":s.transformMat4(e);break;case"a_normal":Ki.transformQuat(s,s,r)}i[0]=s.x,i[1]=s.y,i[2]=s.z}m+=n.view.stride,y+=S.view.stride}}f+=mp[t.format].size}w[i]={attributes:n.attributes,view:{offset:o.getLength(),length:a.byteLength,count:d,stride:p}},o.addBuffer(a)}let S,x,T,C=0,I=2;const E=new Array(this._struct.primitives.length);for(let e=0;e<this._struct.primitives.length;++e){const i=this._struct.primitives[e],s=t._struct.primitives[e];E[e]={primitiveMode:i.primitiveMode,vertexBundelIndices:i.vertexBundelIndices};let r=0;for(const t of i.vertexBundelIndices)r=Math.max(r,this._struct.vertexBundles[t].view.count);if(i.indexView&&s.indexView){C=i.indexView.count,C+=s.indexView.count,_=i.indexView.offset,g=s.indexView.offset,I=C<256?1:C<65536?2:4;const n=new ArrayBuffer(C*I);if(S=2===I?new Uint16Array(n):1===I?new Uint8Array(n):new Uint32Array(n),x=2===i.indexView.stride?new Uint16Array(this._data.buffer,_,i.indexView.count):1===i.indexView.stride?new Uint8Array(this._data.buffer,_,i.indexView.count):new Uint32Array(this._data.buffer,_,i.indexView.count),I===i.indexView.stride)S.set(x);else for(let t=0;t<i.indexView.count;++t)S[t]=x[t];_+=i.indexView.length,T=2===s.indexView.stride?new Uint16Array(t._data.buffer,g,s.indexView.count):1===s.indexView.stride?new Uint8Array(t._data.buffer,g,s.indexView.count):new Uint32Array(t._data.buffer,g,s.indexView.count);for(let t=0;t<s.indexView.count;++t)S[i.indexView.count+t]=r+T[t];g+=s.indexView.length,E[e].indexView={offset:o.getLength(),length:n.byteLength,count:C,stride:I},o.setNextAlignment(I),o.addBuffer(n)}}const D={vertexBundles:w,primitives:E,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return D.minPosition&&t._struct.minPosition&&D.maxPosition&&t._struct.maxPosition&&(e?(Ki.add(n.center,t._struct.maxPosition,t._struct.minPosition),Ki.multiplyScalar(n.center,n.center,.5),Ki.subtract(n.halfExtents,t._struct.maxPosition,t._struct.minPosition),Ki.multiplyScalar(n.halfExtents,n.halfExtents,.5),Qn.transform(n,n,e),Ki.add(s,n.center,n.halfExtents),Ki.max(D.maxPosition,D.maxPosition,s),Ki.subtract(s,n.center,n.halfExtents),Ki.min(D.minPosition,D.minPosition,s)):(Ki.min(D.minPosition,D.minPosition,t._struct.minPosition),Ki.max(D.maxPosition,D.maxPosition,t._struct.maxPosition))),this.reset({struct:D,data:new Uint8Array(o.getCombined())}),this.initialize(),!0}validateMergingMesh(t){if(this._struct.dynamic||t._struct.dynamic)return!1;if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(let e=0;e<this._struct.vertexBundles.length;++e){const i=this._struct.vertexBundles[e],s=t._struct.vertexBundles[e];if(i.attributes.length!==s.attributes.length)return!1;for(let t=0;t<i.attributes.length;++t)if(i.attributes[t].format!==s.attributes[t].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(let e=0;e<this._struct.primitives.length;++e){const i=this._struct.primitives[e],s=t._struct.primitives[e];if(i.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(let t=0;t<i.vertexBundelIndices.length;++t)if(i.vertexBundelIndices[t]!==s.vertexBundelIndices[t])return!1;if(i.primitiveMode!==s.primitiveMode)return!1;if(i.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0}readAttribute(t,e){let i=null;return this._accessAttribute(t,e,((t,e)=>{const s=t.view.count,{format:r}=t.attributes[e],n=Ip(mp[r]);if(0===s)return;const o=new DataView(this._data.buffer,t.view.offset+JP(t.attributes,e)),a=mp[r],h=iB(o,r);if(!n||!h)return;const l=a.count,c=new n(s*l),u=t.view.stride;for(let t=0;t<s;++t)for(let e=0;e<l;++e)c[l*t+e]=h(u*t+c.BYTES_PER_ELEMENT*e);i=c})),i}copyAttribute(t,e,i,s,r){let n=!1;return this._accessAttribute(t,e,((t,e)=>{const o=t.view.count;if(0===o)return void(n=!0);const{format:a}=t.attributes[e],h=new DataView(this._data.buffer,t.view.offset+JP(t.attributes,e)),l=new DataView(i,r),c=mp[a],u=iB(h,a),d=sB(l,a);if(!u||!d)return;const p=c.count,_=t.view.stride,g=eB(a),f=s,m=g;for(let t=0;t<o;++t)for(let e=0;e<p;++e)d(f*t+m*e,u(_*t+g*e));n=!0})),n}readIndices(t){if(t>=this._struct.primitives.length)return null;const e=this._struct.primitives[t];if(!e.indexView)return null;const{stride:i}=e.indexView;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)}copyIndices(t,e){if(t>=this._struct.primitives.length)return!1;const i=this._struct.primitives[t];if(!i.indexView)return!1;const s=i.indexView.count,r=1===i.indexView.stride?6:2===i.indexView.stride?9:12,n=iB(new DataView(this._data.buffer),r);for(let t=0;t<s;++t)e[t]=n(i.indexView.offset+mp[r].size*t);return!0}readAttributeFormat(t,e){let i=null;return this._accessAttribute(t,e,((t,e)=>{const s=t.attributes[e].format;i=mp[s]})),i}_accessAttribute(t,e,i){if(t>=this._struct.primitives.length)return;const s=this._struct.primitives[t];for(const t of s.vertexBundelIndices){const s=this._struct.vertexBundles[t],r=s.attributes.findIndex((t=>t.name===e));if(!(r<0)){i(s,r);break}}}_createVertexBuffers(t,e){return this._struct.vertexBundles.map((i=>{const s=t.createBuffer(new Ed(8,1,i.view.length,i.view.stride)),r=new Uint8Array(e,i.view.offset,i.view.length);return s.update(r),s}))}initDefault(t){super.initDefault(t),this.reset({struct:{vertexBundles:[],primitives:[]},data:KP})}set allowDataAccess(t){this._allowDataAccess=t,this._isMeshDataUploaded&&!this._allowDataAccess&&this.releaseData()}get allowDataAccess(){return this._allowDataAccess}releaseData(){this._data=KP}},WP=Qo(GP.prototype,"_struct",[va],(function(){return{vertexBundles:[],primitives:[]}})),jP=Qo(GP.prototype,"_hash",[va],(function(){return 0})),$P=Qo(GP.prototype,"_allowDataAccess",[va],(function(){return!0})),HP=GP))||HP);function JP(t,e){let i=0;for(let s=0;s<e;++s){const e=t[s];i+=mp[e.format].size}return i}h.Mesh=ZP;const{isLittleEndian:tB}=Hn;function eB(t){const e=mp[t];return e.size/e.count}function iB(t,e){const i=mp[e],s=i.size/i.count;switch(i.type){case 1:case 3:switch(s){case 1:return e=>t.getUint8(e);case 2:return e=>t.getUint16(e,tB);case 4:return e=>t.getUint32(e,tB)}break;case 2:case 4:switch(s){case 1:return e=>t.getInt8(e);case 2:return e=>t.getInt16(e,tB);case 4:return e=>t.getInt32(e,tB)}break;case 6:switch(s){case 2:return e=>t.getUint16(e,tB);case 4:return e=>t.getFloat32(e,tB)}}return null}function sB(t,e){const i=mp[e],s=i.size/i.count;switch(i.type){case 1:case 3:switch(s){case 1:return(e,i)=>t.setUint8(e,i);case 2:return(e,i)=>t.setUint16(e,i,tB);case 4:return(e,i)=>t.setUint32(e,i,tB)}break;case 2:case 4:switch(s){case 1:return(e,i)=>t.setInt8(e,i);case 2:return(e,i)=>t.setInt16(e,i,tB);case 4:return(e,i)=>t.setInt32(e,i,tB)}break;case 6:switch(s){case 2:return(e,i)=>t.setUint16(e,i,tB);case 4:return(e,i)=>t.setFloat32(e,i,tB)}}return null}function rB(t){if(!t.struct.encoded)return t;const e=t=>{t<0&&j(14204,t)},i=JSON.parse(JSON.stringify(t.struct)),s=new DP;s.setNextAlignment(0);for(const r of i.vertexBundles){const i=r.view,n=i.count*i.stride,o=new Uint8Array(n),a=new Uint8Array(t.data.buffer,i.offset,i.length);e(UP.decodeVertexBuffer(o,i.count,i.stride,a)),s.setNextAlignment(i.stride);const h={offset:s.getLength(),length:o.byteLength,count:i.count,stride:i.stride};r.view=h,s.addBuffer(o)}for(const r of i.primitives){if(void 0===r.indexView)continue;const i=r.indexView,n=i.count*i.stride,o=new Uint8Array(n),a=new Uint8Array(t.data.buffer,i.offset,i.length);e(UP.decodeIndexBuffer(o,i.count,i.stride,a)),s.setNextAlignment(i.stride);const h={offset:s.getLength(),length:o.byteLength,count:i.count,stride:i.stride};r.indexView=h,s.addBuffer(o)}return{struct:i,data:new Uint8Array(s.getCombined())}}function nB(t){const e=new qP.Inflate(t.data).decompress();return t.data=e,t.struct.compressed=!1,t}function oB(t){const e=JSON.parse(JSON.stringify(t.struct)),i=new DP;function s(t,e,i,s,r,n,o){for(let a=0;a<i;a++)for(let i=0;i<s;i++)e(o*a+r*i,t(n*a+r*i))}function r(t,e,i,s,r,n){for(let o=0;o<i;o++)for(let i=0;i<s;i++)e(n*o+4*i,ki(t(r*o+2*i)))}i.setNextAlignment(0);for(let n=0;n<e.vertexBundles.length;++n){const o=e.vertexBundles[n],a=o.view,h=o.attributes,l=t.struct.vertexBundles[n].attributes,c=[],u=[],d=[];for(let e=0;e<h.length;++e){const i=h[e],s=iB(new DataView(t.data.buffer,a.offset+JP(l,e)),i.format);let r=!0;switch(i.format){case 8:i.format=11;break;case 18:i.format=21;break;case 29:i.format=32;break;case 41:i.format=44;break;default:r=!1}c.push(mp[i.format].size),u.push(r),d.push(s)}const p=c.reduce(((t,e)=>t+e),0),_=new Uint8Array(p*a.count);for(let t=0;t<h.length;++t){const e=h[t],i=d[t],n=sB(new DataView(_.buffer,JP(h,t)),e.format),o=u[t],l=mp[e.format];o?r(i,n,a.count,l.count,a.stride,p):s(i,n,a.count,l.count,l.size/l.count,a.stride,p)}i.setNextAlignment(p);const g={offset:i.getLength(),length:_.byteLength,count:a.count,stride:p};o.view=g,i.addBuffer(_)}for(const s of e.primitives){if(void 0===s.indexView)continue;const e=s.indexView,r=new Uint8Array(t.data.buffer,e.offset,e.length);i.setNextAlignment(e.stride);const n={offset:i.getLength(),length:r.byteLength,count:e.count,stride:e.stride};s.indexView=n,i.addBuffer(r)}const n=new Uint8Array(i.getCombined());return e.quantized=!1,{struct:e,data:n}}const aB=[new Wd("a_position",32),new Wd("a_normal",32),new Wd("a_texCoord",21),new Wd("a_tangent",44),new Wd("a_color",44)],hB=new Ki;function lB(t,e,i){i=i||{};const s=[];let r=0;const n=[];let o,a=0;const h=t.positions.slice();if(h.length>0){if(o=null,t.attributes)for(const e of t.attributes)if("a_position"===e.name){o=e;break}o||(o=aB[0]),s.push(o);const e=mp[o.format];a=Math.max(a,Math.floor(h.length/e.count)),n.push({offset:r,data:h,attribute:o}),r+=e.size}if(t.normals&&t.normals.length>0){if(o=null,t.attributes)for(const e of t.attributes)if("a_normal"===e.name){o=e;break}o||(o=aB[1]);const e=mp[o.format];s.push(o),a=Math.max(a,Math.floor(t.normals.length/e.count)),n.push({offset:r,data:t.normals,attribute:o}),r+=e.size}if(t.uvs&&t.uvs.length>0){if(o=null,t.attributes)for(const e of t.attributes)if("a_texCoord"===e.name){o=e;break}o||(o=aB[2]);const e=mp[o.format];s.push(o),a=Math.max(a,Math.floor(t.uvs.length/e.count)),n.push({offset:r,data:t.uvs,attribute:o}),r+=e.size}if(t.tangents&&t.tangents.length>0){if(o=null,t.attributes)for(const e of t.attributes)if("a_tangent"===e.name){o=e;break}o||(o=aB[3]);const e=mp[o.format];s.push(o),a=Math.max(a,Math.floor(t.tangents.length/e.count)),n.push({offset:r,data:t.tangents,attribute:o}),r+=e.size}if(t.colors&&t.colors.length>0){if(o=null,t.attributes)for(const e of t.attributes)if("a_color"===e.name){o=e;break}o||(o=aB[4]);const e=mp[o.format];s.push(o),a=Math.max(a,Math.floor(t.colors.length/e.count)),n.push({offset:r,data:t.colors,attribute:o}),r+=e.size}if(t.customAttributes)for(let e=0;e<t.customAttributes.length;e++){const i=t.customAttributes[e],o=mp[i.attr.format];s.push(i.attr),a=Math.max(a,Math.floor(i.values.length/o.count)),n.push({offset:r,data:i.values,attribute:i.attr}),r+=o.size}const l=new DP,c=new ArrayBuffer(a*r),u=new DataView(c);for(const t of n)cS(u,t.data,t.attribute.format,t.offset,r);l.setNextAlignment(0);const d={attributes:s,view:{offset:l.getLength(),length:c.byteLength,count:a,stride:r}};l.addBuffer(c);let p=null,_=0;if(t.indices){const{indices:e}=t;_=e.length,p=new ArrayBuffer(2*_),cS(new DataView(p),e,9)}const g={primitiveMode:t.primitiveMode||7,vertexBundelIndices:[0]};p&&(l.setNextAlignment(2),g.indexView={offset:l.getLength(),length:p.byteLength,count:_,stride:2},l.addBuffer(p));let f=t.minPos;if(!f&&i.calculateBounds){f=Ki.set(new Ki,1/0,1/0,1/0);for(let t=0;t<a;++t)Ki.set(hB,h[3*t+0],h[3*t+1],h[3*t+2]),Ki.min(f,f,hB)}let m=t.maxPos;if(!m&&i.calculateBounds){m=Ki.set(new Ki,-1/0,-1/0,-1/0);for(let t=0;t<a;++t)Ki.set(hB,h[3*t+0],h[3*t+1],h[3*t+2]),Ki.max(m,m,hB)}const y={vertexBundles:[d],primitives:[g]};return f&&(y.minPosition=new Ki(f.x,f.y,f.z)),m&&(y.maxPosition=new Ki(m.x,m.y,m.z)),e||(e=new ZP),e.reset({struct:y,data:new Uint8Array(l.getCombined())}),e}function cB(t,e){if(e>0){const i=t%e;if(0!==i)return e-i}return 0}function uB(t,e,i,s){s=s||{maxSubMeshes:1,maxSubMeshVertices:1024,maxSubMeshIndices:1024};const r=[];let n=0;if(e.positions.length>0&&r.push(new Wd("a_position",32,!1,n++,!1,0)),e.normals&&e.normals.length>0&&r.push(new Wd("a_normal",32,!1,n++,!1,0)),e.uvs&&e.uvs.length>0&&r.push(new Wd("a_texCoord",21,!1,n++,!1,0)),e.tangents&&e.tangents.length>0&&r.push(new Wd("a_tangent",44,!1,n++,!1,0)),e.colors&&e.colors.length>0&&r.push(new Wd("a_color",44,!1,n++,!1,0)),e.customAttributes)for(let t=0;t<e.customAttributes.length;t++){const i=e.customAttributes[t],s=new Wd;s.copy(i.attr),s.stream=n++,r.push(s)}const o=[],a=[];let h=0;for(let t=0;t<s.maxSubMeshes;t++){const t={vertexBundelIndices:[],primitiveMode:e.primitiveMode||7};for(const e of r){const i=mp[e.format],r=s.maxSubMeshVertices*i.size,n={view:{offset:h,length:r,count:0,stride:i.size},attributes:[e]},a=o.length;t.vertexBundelIndices.push(a),o.push(n),h+=r}let i=0;if(e.indices16&&e.indices16.length>0?i=2:e.indices32&&e.indices32.length>0&&(i=4),i>0){h+=cB(h,i);const e=s.maxSubMeshIndices*i,r={offset:h,length:e,count:0,stride:i};t.indexView=r,h+=e}a.push(t)}const l={info:{maxSubMeshes:s.maxSubMeshes,maxSubMeshVertices:s.maxSubMeshVertices,maxSubMeshIndices:s.maxSubMeshIndices},bounds:[]};l.bounds.length=s.maxSubMeshes;const c={struct:{vertexBundles:o,primitives:a,dynamic:l},data:new Uint8Array(h)};return i||(i=new ZP),i.reset(c),i.initialize(),i.updateSubMesh(t,e),i}var dB,pB,_B=Object.freeze({__proto__:null,MeshUtils:class{static createMesh(t,e,i){return lB(t,e,i)}static createDynamicMesh(t,e,i,s){return uB(t,e,i,s)}static decodeMesh(t){return rB(t)}static inflateMesh(t){return nB(t)}},createMesh:lB,find:cM,mapBuffer:dS,readBuffer:uS,readMesh:function(t,e){void 0===e&&(e=0);const i={positions:[]},s=new DataView(t.data.buffer,t.data.byteOffset,t.data.byteLength),r=t.struct,n=r.primitives[e];for(const t of n.vertexBundelIndices){const e=r.vertexBundles[t];let n=e.view.offset;const{length:o,stride:a}=e.view;for(const t of e.attributes){const e=EP[t.name];e&&(i[e]=(i[e]||[]).concat(uS(s,t.format,n,o,a))),n+=mp[t.format].size}}const o=n.indexView;return i.indices=uS(s,Cu[`R${8*o.stride}UI`],o.offset,o.length),i},toPPM:function(t,e,i){return`P3 ${e} ${i} 255\n${t.filter(((t,e)=>e%4<3)).toString()}\n`},writeBuffer:cS});t("utils",_B);const gB=Zi(),fB=Fs(),mB=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}];t("SpriteFrameEvent",{UV_UPDATED:"uv_updated"});let yB=t("SpriteFrame",oa("cc.SpriteFrame")((pB=class t extends F_{static createWithImage(e){const i=e instanceof j_?e:new j_(e),s=new qf;s.image=i;const r=new t;return r.texture=s,r}get insetTop(){return this._capInsets[1]}set insetTop(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}get insetBottom(){return this._capInsets[3]}set insetBottom(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}get insetLeft(){return this._capInsets[0]}set insetLeft(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}get insetRight(){return this._capInsets[2]}set insetRight(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}get rect(){return this._rect}set rect(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV(),this._calcTrimmedBorder())}get originalSize(){return this._originalSize}set originalSize(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV(),this._calcTrimmedBorder())}get offset(){return this._offset}set offset(t){this._offset.set(t),this._calcTrimmedBorder()}get rotated(){return this._rotated}set rotated(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}get texture(){return this._texture}set texture(t){t?t!==this._texture&&this.reset({texture:t},!0):G(3122,this.name)}get atlasUuid(){return this._atlasUuid}set atlasUuid(t){this._atlasUuid=t}get width(){return this._texture.width}get height(){return this._texture.height}set _textureSource(t){globalThis.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}get flipUVX(){return this._isFlipUVX}set flipUVX(t){this._isFlipUVX=t,this._calculateUV()}get flipUVY(){return this._isFlipUVY}set flipUVY(t){this._isFlipUVY=t,this._calculateUV()}get packable(){return this._packable}set packable(t){this._packable=t}get original(){return this._original}get pixelsToUnit(){return this._pixelsToUnit}get pivot(){return this._pivot}get mesh(){return this._mesh}get trimmedBorder(){return this._trimmedBorder}constructor(){super(),this.vertices=null,this.uv=[],this.unbiasUV=[],this.uvSliced=[],this._rect=Ir(),this._trimmedBorder=ur(),this._offset=Ks(),this._originalSize=wr(),this._rotated=!1,this._capInsets=[0,0,0,0],this._atlasUuid="",this._texture=void 0,this._isFlipUVY=!1,this._isFlipUVX=!1,this._original=null,this._packable=!0,this._pixelsToUnit=100,this._pivot=Ks(.5,.5),this._meshType=0,this._extrude=0,this._customOutLine=[],this._mesh=null,this._minPos=Zi(),this._maxPos=Zi()}textureLoaded(){return!!this.texture}isRotated(){return this._rotated}setRotated(t){this.rotated=t}getRect(t){return t?(t.set(this._rect),t):this._rect.clone()}setRect(t){this.rect=t}getOriginalSize(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()}setOriginalSize(t){this.originalSize=t}getOffset(t){return t?(t.set(this._offset),t):this._offset.clone()}setOffset(t){this.offset=t}getGFXTexture(){return this._texture.getGFXTexture()}getGFXSampler(){return this._texture.getGFXSampler()}getHash(){return this._texture.getHash()}getSamplerInfo(){return this._texture.getSamplerInfo()}reset(t,e){void 0===e&&(e=!1);let i=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),t&&(t.texture&&(this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),i=!0),i&&this.texture&&this._calculateUV(),this._calcTrimmedBorder()}checkRect(t){const e=this._rect;let i=e.x,s=e.y;return this._rotated?(i+=e.height,s+=e.width):(i+=e.width,s+=e.height),i>t.width?(j(3300,`${this.name}/${t.name}`,i,t.width),!1):!(s>t.height&&(j(3301,`${this.name}/${t.name}`,s,t.height),1))}_calcTrimmedBorder(){const t=this._originalSize.width,e=this._originalSize.height,i=.5*(t-this._rect.width),s=.5*(e-this._rect.height);this._trimmedBorder.x=this._offset.x+i,this._trimmedBorder.y=this._offset.x-i,this._trimmedBorder.z=this._offset.y+s,this._trimmedBorder.w=this._offset.y-s}ensureMeshData(){this._mesh||(this._initVertices(),this._createMesh())}destroy(){return this._packable&&IP&&IP.deleteAtlasSpriteFrame(this),super.destroy()}_calculateSlicedUV(){const t=this._rect,e=this.texture,i=e.width,s=e.height,r=this._capInsets[0],n=this._capInsets[2],o=t.width-r-n,a=this._capInsets[1],h=this._capInsets[3],l=t.height-a-h,c=this.uvSliced;if(c.length=0,this._rotated){mB[0].u=t.x/i,mB[1].u=(t.x+h)/i,mB[2].u=(t.x+h+l)/i,mB[3].u=(t.x+t.height)/i,mB[3].v=t.y/s,mB[2].v=(t.y+r)/s,mB[1].v=(t.y+r+o)/s,mB[0].v=(t.y+t.width)/s;for(let t=0;t<4;++t){const e=mB[t];for(let t=0;t<4;++t){const i=mB[3-t];c.push({u:e.u,v:i.v})}}}else{mB[0].u=t.x/i,mB[1].u=(t.x+r)/i,mB[2].u=(t.x+r+o)/i,mB[3].u=(t.x+t.width)/i,mB[3].v=t.y/s,mB[2].v=(t.y+a)/s,mB[1].v=(t.y+a+l)/s,mB[0].v=(t.y+t.height)/s;for(let t=0;t<4;++t){const e=mB[t];for(let t=0;t<4;++t){const i=mB[t];c.push({u:i.u,v:e.v})}}}this.emit("uv_updated",this)}_calculateUV(){const t=this._rect,e=this.uv,i=this.unbiasUV,s=this.texture,r=s.width,n=s.height;if(this._rotated){const s=0===r?0:t.x/r,o=0===r?1:(t.x+t.height)/r,a=0===n?0:t.y/n,h=0===n?1:(t.y+t.width)/n;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=h,e[2]=o,e[3]=a,e[4]=s,e[5]=h,e[6]=s,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=o,e[3]=h,e[4]=s,e[5]=a,e[6]=s,e[7]=h):this._isFlipUVY?(e[0]=s,e[1]=h,e[2]=s,e[3]=a,e[4]=o,e[5]=h,e[6]=o,e[7]=a):(e[0]=s,e[1]=a,e[2]=s,e[3]=h,e[4]=o,e[5]=a,e[6]=o,e[7]=h);const l=0===r?0:t.x/r,c=0===r?1:(t.x+t.height)/r,u=0===n?0:t.y/n,d=0===n?1:(t.y+t.width)/n;this._isFlipUVX&&this._isFlipUVY?(i[0]=c,i[1]=d,i[2]=c,i[3]=u,i[4]=l,i[5]=d,i[6]=l,i[7]=u):this._isFlipUVX?(i[0]=c,i[1]=u,i[2]=c,i[3]=d,i[4]=l,i[5]=u,i[6]=l,i[7]=d):this._isFlipUVY?(i[0]=l,i[1]=d,i[2]=l,i[3]=u,i[4]=c,i[5]=d,i[6]=c,i[7]=u):(i[0]=l,i[1]=u,i[2]=l,i[3]=d,i[4]=c,i[5]=u,i[6]=c,i[7]=d)}else{const s=0===r?0:t.x/r,o=0===r?1:(t.x+t.width)/r,a=0===n?1:(t.y+t.height)/n,h=0===n?0:t.y/n;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=h,e[2]=s,e[3]=h,e[4]=o,e[5]=a,e[6]=s,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=s,e[3]=a,e[4]=o,e[5]=h,e[6]=s,e[7]=h):this._isFlipUVY?(e[0]=s,e[1]=h,e[2]=o,e[3]=h,e[4]=s,e[5]=a,e[6]=o,e[7]=a):(e[0]=s,e[1]=a,e[2]=o,e[3]=a,e[4]=s,e[5]=h,e[6]=o,e[7]=h);const l=0===r?0:t.x/r,c=0===r?1:(t.x+t.width)/r,u=0===n?1:(t.y+t.height)/n,d=0===n?0:t.y/n;this._isFlipUVX&&this._isFlipUVY?(i[0]=c,i[1]=d,i[2]=l,i[3]=d,i[4]=c,i[5]=u,i[6]=l,i[7]=u):this._isFlipUVX?(i[0]=c,i[1]=u,i[2]=l,i[3]=u,i[4]=c,i[5]=d,i[6]=l,i[7]=d):this._isFlipUVY?(i[0]=l,i[1]=d,i[2]=c,i[3]=d,i[4]=l,i[5]=u,i[6]=c,i[7]=u):(i[0]=l,i[1]=u,i[2]=c,i[3]=u,i[4]=l,i[5]=d,i[6]=c,i[7]=d)}this._calculateSlicedUV()}_setDynamicAtlasFrame(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())}_resetDynamicAtlasFrame(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())}_checkPackable(){const t=IP;if(!t)return;const e=this._texture;if(!(e instanceof qf)||e.isCompressed)return void(this._packable=!1);const i=this.width,s=this.height;if(!e.image||i>t.maxFrameSize||s>t.maxFrameSize)return void(this._packable=!1);const r=u.HTMLCanvasElement;e.image&&e.image instanceof r&&(this._packable=!0)}_serialize(t){return null}_deserialize(t,e){const i=t,s=i.rect;s&&(this._rect=new Cr(s.x,s.y,s.width,s.height));const r=i.offset;i.offset&&(this._offset=Ks(r.x,r.y));const n=i.originalSize;i.originalSize&&(this._originalSize=wr(n.width,n.height)),this._rotated=!!i.rotated,this._name=i.name,this._packable=!!i.packable,this._pixelsToUnit=i.pixelsToUnit;const o=i.pivot;o&&(this._pivot=Ks(o.x,o.y)),this._meshType=i.meshType;const a=i.capInsets;a&&(this._capInsets[0]=a[0],this._capInsets[1]=a[1],this._capInsets[2]=a[2],this._capInsets[3]=a[3]);const h=i.vertices;if(h){this.vertices||(this.vertices={rawPosition:[],positions:[],indexes:h.indexes,uv:h.uv,nuv:h.nuv,minPos:Zi(h.minPos.x,h.minPos.y,h.minPos.z),maxPos:Zi(h.maxPos.x,h.maxPos.y,h.maxPos.z)}),this.vertices.rawPosition.length=0;const t=h.rawPosition;for(let e=0;e<t.length;e+=3)this.vertices.rawPosition.push(Zi(t[e],t[e+1],t[e+2]));this._updateMeshVertices()}}clone(){const e=new t,i=this.vertices;return e.vertices=i?{rawPosition:i.rawPosition.slice(0),positions:i.positions.slice(0),indexes:i.indexes.slice(0),uv:i.uv.slice(0),nuv:i.nuv.slice(0),minPos:i.minPos.clone(),maxPos:i.maxPos.clone()}:null,e.uv.splice(0,e.uv.length,...this.uv),e.unbiasUV.splice(0,e.unbiasUV.length,...this.unbiasUV),e.uvSliced.splice(0,e.uvSliced.length,...this.uvSliced),e._rect.set(this._rect),e._trimmedBorder.set(this._trimmedBorder),e._offset.set(this._offset),e._originalSize.set(this._originalSize),e._rotated=this._rotated,e._capInsets.splice(0,e._capInsets.length,...this._capInsets),e._atlasUuid=this._atlasUuid,e._texture=this._texture,e._isFlipUVX=this._isFlipUVX,e._isFlipUVY=this._isFlipUVY,this._original?e._original={_texture:this._original._texture,_x:this._original._x,_y:this._original._y}:e._original=null,e._packable=this._packable,e._pixelsToUnit=this._pixelsToUnit,e._pivot.set(this._pivot),e._meshType=this._meshType,e._extrude=this._extrude,e._customOutLine.splice(0,e._customOutLine.length,...this._customOutLine),e._minPos=this._minPos,e._maxPos=this._maxPos,this._mesh&&e._createMesh(),e}_refreshTexture(t){this._texture=t;const e=this._texture,i={};let s=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(i.rect=Ir(0,0,e.width,e.height),s=!0),(0===this._originalSize.width||0===this._originalSize.height||s)&&(i.originalSize=wr(e.width,e.height),s=!0),s&&this.reset(i),this._checkPackable(),this._mesh&&this._updateMesh()}onLoaded(){this._calcTrimmedBorder()}initDefault(t){super.initDefault(t);const e=new qf;e.initDefault(),this._refreshTexture(e),this._calculateUV()}validate(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height}_initVertices(){if(this.vertices?(this.vertices.rawPosition.length=0,this.vertices.positions.length=0,this.vertices.indexes.length=0,this.vertices.uv.length=0,this.vertices.nuv.length=0,this.vertices.minPos.set(0,0,0),this.vertices.maxPos.set(0,0,0)):this.vertices={rawPosition:[],positions:[],indexes:[],uv:[],nuv:[],minPos:Zi(),maxPos:Zi()},1===this._meshType);else{const t=this.texture,e=t.width,i=t.height,s=this.rect,r=s.width,n=s.height,o=s.x,a=i-s.y-n,h=r/2,l=n/2,c=0===e?0:o/e,u=0===e?1:(o+r)/e,d=0===i?1:(a+n)/i,p=0===i?0:a/i;gB.set(-h,-l,0),this.vertices.rawPosition.push(gB.clone()),this.vertices.uv.push(o),this.vertices.uv.push(a+n),this.vertices.nuv.push(c),this.vertices.nuv.push(p),this.vertices.minPos.set(gB),gB.set(h,-l,0),this.vertices.rawPosition.push(gB.clone()),this.vertices.uv.push(o+r),this.vertices.uv.push(a+n),this.vertices.nuv.push(u),this.vertices.nuv.push(p),gB.set(-h,l,0),this.vertices.rawPosition.push(gB.clone()),this.vertices.uv.push(o),this.vertices.uv.push(a),this.vertices.nuv.push(c),this.vertices.nuv.push(d),gB.set(h,l,0),this.vertices.rawPosition.push(gB.clone()),this.vertices.uv.push(o+r),this.vertices.uv.push(a),this.vertices.nuv.push(u),this.vertices.nuv.push(d),this.vertices.maxPos.set(gB),this.vertices.indexes.push(0),this.vertices.indexes.push(1),this.vertices.indexes.push(2),this.vertices.indexes.push(2),this.vertices.indexes.push(1),this.vertices.indexes.push(3)}this._updateMeshVertices()}_updateMeshVertices(){fB.identity();const t=1/this._pixelsToUnit,e=Zi(-(this._pivot.x-.5)*this.rect.width*t,-(this._pivot.y-.5)*this.rect.height*t,0);fB.transform(e),e.set(t,t,1),fB.scale(e);const i=this.vertices;for(let t=0;t<i.rawPosition.length;t++){const s=i.rawPosition[t];Ki.transformMat4(e,s,fB),Ki.toArray(i.positions,e,3*t)}Ki.transformMat4(this._minPos,i.minPos,fB),Ki.transformMat4(this._maxPos,i.maxPos,fB)}_createMesh(){this._mesh=lB({primitiveMode:7,positions:this.vertices.positions,uvs:this.vertices.nuv,indices:this.vertices.indexes,minPos:this._minPos,maxPos:this._maxPos,attributes:[new Wd("a_position",32),new Wd("a_texCoord",21)]})}_updateMesh(){this._mesh&&this._mesh.destroy(),this._initVertices(),this._createMesh()}},pB.EVENT_UV_UPDATED="uv_updated",pB.MeshType={RECT:0,POLYGON:1},dB=pB))||dB);var vB,bB,wB;h.SpriteFrame=yB;let SB=t("SpriteAtlas",oa("cc.SpriteAtlas")((bB=class extends F_{constructor(){super(),this.spriteFrames=wB&&wB()}getTexture(){const t=Object.keys(this.spriteFrames);if(t.length>0){const e=this.spriteFrames[t[0]];return e&&e.texture}return null}getSpriteFrame(t){const e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null}getSpriteFrames(){const t=[],e=this.spriteFrames;for(const i of Object.keys(e))t.push(e[i]);return t}_serialize(t){return null}_deserialize(t,e){const i=t;this._name=i.name;const s=i.spriteFrames;this.spriteFrames=dt();for(let t=0;t<s.length;t+=2)e.result.push(this.spriteFrames,s[t],s[t+1],Ut(yB))}},wB=Qo(bB.prototype,"spriteFrames",[va],(function(){return dt()})),vB=bB))||vB);var xB;h.SpriteAtlas=SB;let TB=t("Font",oa("cc.Font")(xB=class extends F_{})||xB);var CB,IB,EB;h.Font=TB;let DB=t("TTFFont",oa("cc.TTFFont")((IB=class extends TB{constructor(){super(),this._fontFamily=EB&&EB()}get _nativeAsset(){return this._fontFamily}set _nativeAsset(t){this._fontFamily=t||"Arial"}get _nativeDep(){return{uuid:this._uuid,__nativeName__:this._native,ext:Rc(this._native),__isNative__:!0}}initDefault(t){this._fontFamily="Arial",super.initDefault(t)}},EB=Qo(IB.prototype,"_fontFamily",[va],(function(){return null})),s(IB.prototype,"_nativeAsset",[Wa,Ha],Object.getOwnPropertyDescriptor(IB.prototype,"_nativeAsset"),IB.prototype),s(IB.prototype,"_nativeDep",[Wa],Object.getOwnPropertyDescriptor(IB.prototype,"_nativeDep"),IB.prototype),CB=IB))||CB);h.TTFFont=DB;const AB=t("BASELINE_RATIO",.26);let MB=0;const PB=t("MIDDLE_RATIO",(AB+1)/2-AB);function BB(){return MB}const RB=new Vt(2);RB.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};class OB{constructor(t){this.count=0,this.limit=0,this.datas={},this.limit=t}moveToHead(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t}put(t,e){const i=RB.get();if(i.key=t,i.value=e,this.count>=this.limit){const t=this.tail;delete this.datas[t.key],this.count--,this.tail=t.prev,this.tail.next=null,t.prev=null,t.next=null,RB.put(t)}this.moveToHead(i)}remove(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--}get(t){const e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null}clear(){this.count=0,this.datas={},this.head=null,this.tail=null}has(t){return!!this.datas[t]}delete(t){const e=this.datas[t];this.remove(e)}}t("LRUCache",OB);const LB=new OB(100),FB=/([a-zA-Z0-9--]+|\S)/,zB=/^[!,.:;'}\]%\?>]/,kB=/([a-zA-Z0-9--iI]+|\S)$/,NB=/[a-zA-Z0-9--iI]+$/,UB=/^[a-zA-Z0-9--iI]/;function VB(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function HB(t){const e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function GB(t,e,i){const s=`${i||t.font}${e}`,r=LB.get(s);if(null!==r)return r;const n=t.measureText(e),o=n&&n.width||0;return LB.put(s,o),o}function WB(t){const e=t.length;let i=0,s=0;for(let r=0;r<e;r++)s=t.charCodeAt(r),8205!==s&&(s>=55296&&s<=56319&&(s=t.charCodeAt(r+1),s>=56320&&s<=57343)?((r+2>=e||8205!==t.charCodeAt(r+2))&&i++,r++):i++);return i}function jB(t,e){const i=t.length;let s=0,r=0,n=0,o=0;for(let a=0;a<i;a++)if(o=t.charCodeAt(a),8205!==o)if(o>=55296&&o<=56319&&(s++,o=t.charCodeAt(a+1),o>=56320&&o<=57343)){if(s++,a+2>=i||8205!==t.charCodeAt(a+2)){if(e===r)return t.slice(n,n+s);n+=s,r++,s=0}a++}else{if(e===r)return t.charAt(a);n=a+1,r++,s=0}else s++;return""}function $B(t,e){const i=jB(t,e);if(1===i.length)return`${i.charCodeAt(0)}`;let s="";for(let t=0;t<i.length;t++)s+=`${i.charCodeAt(t)}`;return`${s}`}function qB(t,e){if(e>=t.length)return t.length;let i=e,s=t[i];for(;i>=0&&(""===s&&(i--,s=t[i]),s>="\udc00"&&s<="\udfff"&&i-1>=0&&(i--,s=t[i]),s>="\ud800"&&s<="\udbff")&&i-1>=0&&""===t[i-1];)i--,s=t[i];return i}function XB(t,e){let i=e,s=e,r=t[s];for(;s<t.length;)if(""===r&&(s++,i++,r=t[s],r>="\ud800"&&r<="\udbff"&&(s++,i++,r=t[s])),r>="\ud800"&&r<="\udbff")s++,i++,r=t[s];else{if(!(r>="\udc00"&&r<="\udfff"))break;if(s++,r=t[s],!(s<t.length&&""===t[s]))break;i++,r=t[s]}return i}function YB(t,e,i){let s=qB(t,e);s<e&&(s=XB(t,e)+1);let r=i;if(void 0!==i){r=XB(t,i=Math.max(0,i-1));const n=qB(t,i);n<s||n===s&&e>s?r=s:r+=1}return t.substring(s,r)}function QB(t){return UB.exec(t)}function KB(t){return NB.exec(t)}function ZB(t,e,i,s){const r=[];if(0===t.length||i<0)return r.push(""),r;let n=t;for(;e>i&&n.length>1;){let t=n.length*(i/e)|0,o=YB(n,t),a=e-s(o),h=o,l=0,c=0;const u=100;for(;a>i&&c++<u;)t*=i/a,t|=0,o=YB(n,t),a=e-s(o);for(c=0;o&&a<=i&&c++<u;){const i=FB.exec(o);l=i?i[0].length:1,h=o,t+=l,o=YB(n,t),a=e-s(o)}t-=l,0===t?(t=1,h=YB(n,1)):1===t&&n[0]>="\ud800"&&n[0]<="\udbff"&&(t=2,h=YB(n,2));let d,p=YB(n,0,t);zB.test(h||o)&&(d=kB.exec(p),t-=d?d[0].length:0,0===t&&(t=1),h=YB(n,t),p=YB(n,0,t)),UB.test(h)&&(d=NB.exec(p),d&&p!==d[0]&&(t-=d[0].length,h=YB(n,t),p=YB(n,0,t))),0===r.length?r.push(p):(p=p.trim(),p.length>0&&r.push(p)),n=h||o,e=s(n)}return 0===r.length?r.push(n):(n=n.trim(),n.length>0&&r.push(n)),r}const JB=u.document;let tR=null,eR=-1;const iR="BES bswy:->@123",sR=Object.create(null),rR=[],nR=3e3,oR=(()=>{let t;return()=>{if(void 0===t)if("FontFace"in u){const e=/Gecko.*Firefox\/(\d+)/.exec(u.navigator.userAgent),i=/OS X.*Version\/10\..*Safari/.exec(u.navigator.userAgent)&&/Apple/.exec(u.navigator.vendor);t=e?parseInt(e[1],10)>42:!i}else t=!1;return t}})();function aR(){let t=!0;const e=Date.now();for(let i=rR.length-1;i>=0;i--){const s=rR[i],r=s.fontFamilyName;if(e-s.startTime>nR){G(4933,r),s.onComplete(null,r),rR.splice(i,1);continue}const n=s.refWidth,o=`40px ${r}`;tR.font=o,n!==GB(tR,iR,o)?(rR.splice(i,1),s.onComplete(null,r)):t=!1}t&&(clearInterval(eR),eR=-1)}function hR(t,e,i){const s=new Promise(((i,s)=>{const r=()=>{Date.now()-t>=nR?s():JB.fonts.load(`40px ${e}`).then((t=>{t.length>=1?i():setTimeout(r,100)}),(()=>{s()}))};r()}));let r=null;const n=new Promise(((t,e)=>{r=setTimeout(e,nR)}));Promise.race([n,s]).then((()=>{r&&(clearTimeout(r),r=null),i(null,e)}),(()=>{G(4933,e),i(null,e)}))}function lR(t,e,i){const s=cR(t);if(sR[s])return void i(null,s);if(!tR){const t=JB.createElement("canvas");t.width=100,t.height=100,tR=t.getContext("2d")}const r=`40px ${s}`,n=JB.createElement("style");n.type="text/css";let o="";Number.isNaN(s)?o+=`@font-face { font-family:${s}; src:`:o+=`@font-face { font-family:"${s}"; src:`,o+=`url("${t}");`,n.textContent=`${o}}`,JB.body.appendChild(n);const a=JB.createElement("div"),h=a.style;if(h.fontFamily=s,a.innerHTML=".",h.position="absolute",h.left="-100px",h.top="-100px",JB.body.appendChild(a),oR())hR(Date.now(),s,i);else{const t={fontFamilyName:s,refWidth:GB(tR,iR,r),onComplete:i,startTime:Date.now()};rR.push(t),-1===eR&&(eR=setInterval(aR,100))}sR[s]=n}function cR(t){const e=t.lastIndexOf(".ttf");if(-1===e)return t;const i=t.lastIndexOf("/");let s;return s=-1===i?`${t.substring(0,e)}_LABEL`:`${t.substring(i+1,e)}_LABEL`,-1!==s.indexOf(" ")&&(s=`"${s}"`),s}function uR(t,e,i,s){const r=new DB;r._nativeUrl=t,r._nativeAsset=e,s(null,r)}Pb.register({".font":lR,".eot":lR,".ttf":lR,".woff":lR,".svg":lR,".ttc":lR}),$b.register({".font":uR,".eot":uR,".ttf":uR,".woff":uR,".svg":uR,".ttc":uR});const dR=/^(click)(\s)*=|(param)(\s)*=/,pR=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;class _R{constructor(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}parse(t){this._resultObjectArray.length=0,this._stack.length=0;let e=0;const i=t.length;for(;e<i;){let s=t.indexOf(">",e),r=-1;if(s>=0&&(r=t.lastIndexOf("<",s),r<e-1&&(r=t.indexOf("<",s+1),s=t.indexOf(">",r+1))),r<0)this._stack.pop(),this._processResult(t.substring(e)),e=i;else{let i=t.substring(e,r);const n=t.substring(r+1,s);""===n&&(i=t.substring(e,s+1)),this._processResult(i),-1===s?s=r:"/"===t.charAt(r+1)?this._stack.pop():this._addToStack(n),e=s+1}}return this._resultObjectArray}_attributeToObject(t){t=t.trim();const e={};let i=/^(color|size)(\s)*=/.exec(t),s="",r=0,n="";if(i){if(s=i[0],""===(t=t.substring(s.length).trim()))return e;switch(r=t.indexOf(" "),s[0]){case"c":e.color=r>-1?t.substring(0,r).trim():t;break;case"s":e.size=parseInt(t)}return r>-1&&(n=t.substring(r+1).trim(),e.event=this._processEventHandler(n)),e}if(i=/^(br(\s)*\/)/.exec(t),i&&i[0].length>0&&(s=i[0].trim(),s.startsWith("br")&&"/"===s[s.length-1]))return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;i=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t);let o="",a=-1;if(i&&i[0].length>0&&(s=i[0].trim(),s.startsWith("img")&&"/"===s[s.length-1])){let n;i=pR.exec(t);let h=!1;for(;i;){s=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length);const l=s.length;if(s=s.replace(/[^a-zA-Z]/g,"").trim(),s=s.toLowerCase(),o=t.substring(l).trim(),a="src"===s?this.getRightQuotationIndex(o):-1,r=o.indexOf(" ",a+1>=o.length?-1:a+1),n=r>-1?o.substr(0,r):o,t=o.substring(r).trim(),n.endsWith("/")&&(n=n.slice(0,-1)),"src"===s){switch(n.charCodeAt(0)){case 34:case 39:h=!0,n=n.slice(1,-1)}e.isImage=!0,e.src=n}else if("height"===s)e.imageHeight=parseInt(n);else if("width"===s)e.imageWidth=parseInt(n);else if("align"===s){switch(n.charCodeAt(0)){case 34:case 39:n=n.slice(1,-1)}e.imageAlign=n.toLowerCase()}else"offset"===s?e.imageOffset=n:"click"===s&&(e.event=this._processEventHandler(`${s}=${n}`));e.event&&"param"===s&&(e.event[s]=n.replace(/^"|"$/g,"")),i=pR.exec(t)}return h&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(i=/^(outline(\s)*[^>]*)/.exec(t),i){const n={color:"#ffffff",width:1};if(t=i[0].substring(7).trim()){const a=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;let h;for(i=a.exec(t);i;)s=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length),o=t.substring(s.length).trim(),r=o.indexOf(" "),h=r>-1?o.substr(0,r):o,s=s.replace(/[^a-zA-Z]/g,"").trim(),s=s.toLowerCase(),t=o.substring(r).trim(),"click"===s?e.event=this._processEventHandler(`${s}=${h}`):"color"===s?n.color=h:"width"===s&&(n.width=parseInt(h)),e.event&&"param"===s&&(e.event[s]=h.replace(/^"|"$/g,"")),i=a.exec(t)}e.outline=n}if(i=/^(on|u|b|i)(\s)*/.exec(t),i&&i[0].length>0){switch(s=i[0],t=t.substring(s.length).trim(),s[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e}getRightQuotationIndex(t){let e=-1,i=-1;const s=t.indexOf("'"),r=t.indexOf('"'),n=r>-1&&(r<s||-1===s);return s>-1&&(s<r||-1===r)?(e=s,i=t.indexOf("'",e+1>=t.length?-1:e+1)):n&&(e=r,i=t.indexOf('"',e+1>=t.length?-1:e+1)),i}_processEventHandler(t){const e={};let i=0,s=!1,r=dR.exec(t);for(;r;){let n=r[0],o="";if(s=!1,'"'===(t=t.substring(n.length).trim()).charAt(0))i=t.indexOf('"',1),i>-1&&(o=t.substring(1,i).trim(),s=!0),i++;else if("'"===t.charAt(0))i=t.indexOf("'",1),i>-1&&(o=t.substring(1,i).trim(),s=!0),i++;else{const e=/(\S)+/.exec(t);o=e?e[0]:"",i=o.length}s&&(n=n.substring(0,n.length-1).trim(),e[n]=o),t=t.substring(i).trim(),r=dR.exec(t)}return e}_addToStack(t){const e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;const t=this._stack[this._stack.length-1];for(const i in t)e[i]||(e[i]=t[i]);this._stack.push(e)}}_processResult(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))}_escapeSpecialSymbol(t){for(const e of this._specialSymbolArray){const i=e[0],s=e[1];t=t.replace(i,s)}return t}}var gR,fR,mR,yR,vR,bR,wR,SR;t("HtmlTextParser",_R);class xR{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}}class TR{constructor(t){this.letterDefinitions={},this.texture=t}addLetterDefinitions(t,e){this.letterDefinitions[t]=e}cloneLetterDefinition(){const t={};for(const e of Object.keys(this.letterDefinitions)){const i=new xR;xt(i,this.letterDefinitions[e]),t[e]=i}return t}getTexture(){return this.texture}getLetter(t){return this.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const i=$B(t,0);let s=null;return Object.prototype.hasOwnProperty.call(this.letterDefinitions,i)&&(s=this.letterDefinitions[i]),s}clear(){this.letterDefinitions={}}}let CR=t("BitmapFont",(gR=oa("cc.BitmapFont"),fR=Ga(yB),gR((yR=class extends TB{constructor(){super(),this.fntDataStr=vR&&vR(),this.spriteFrame=bR&&bR(),this.fontSize=wR&&wR(),this.fntConfig=SR&&SR()}onLoaded(){const t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new TR(t.texture));const e=this.fntConfig;if(!e)return void G(16376);const i=e.fontDefDictionary;for(const t in i){const e=i[t],s=new xR,r=e.rect;s.offsetX=e.xOffset,s.offsetY=e.yOffset,s.w=r.width,s.h=r.height,s.u=r.x,s.v=r.y,s.valid=!0,s.xAdvance=e.xAdvance,this.fontDefDictionary.addLetterDefinitions(t,s)}}},vR=Qo(yR.prototype,"fntDataStr",[va],(function(){return""})),bR=Qo(yR.prototype,"spriteFrame",[fR],(function(){return null})),wR=Qo(yR.prototype,"fontSize",[va],(function(){return-1})),SR=Qo(yR.prototype,"fntConfig",[va],(function(){return null})),mR=yR))||mR));var IR;h.BitmapFont=CR;let ER,DR=t("LabelAtlas",oa("cc.LabelAtlas")(IR=class extends CR{})||IR);h.LabelAtlas=DR;class AR{constructor(){this.pool=[]}static getInstance(){return ER||(ER=new AR),ER}get(){let t=this.pool.pop();if(!t){const e=u.document.createElement("canvas"),i=e.getContext("2d");t={canvas:e,context:i}}return t}put(t){this.pool.length>=le.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)}}const MR=_r.WHITE.clone(),PR=`rgba(255, 255, 255, ${(1/255).toFixed(3)})`,BR=BB();class RR{constructor(t,e){this.image=null,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.char=t,this.labelInfo=e,this.hash=`${$B(t,0)}${e.hash}`}updateRenderData(){this._updateProperties(),this._updateTexture()}destroy(){this.image=null,AR.getInstance().put(this.data)}_updateProperties(){if(this.data=AR.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){const t=this.labelInfo.fontScale;this.context.font=this.labelInfo.fontDesc;const e=GB(this.context,this.char,this.labelInfo.fontDesc),i=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))*t+i,this.height=(1+AB)*this.labelInfo.fontSize*t+i,this.offsetY=-this.labelInfo.fontSize*AB*t/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new j_),this.image.reset(this.canvas)}_updateTexture(){if(!this.context||!this.canvas)return;const t=this.context,e=this.labelInfo,i=this.canvas.width,s=this.canvas.height,r=e.fontScale;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,i,s),t.fillStyle=PR,t.fillRect(0,0,i,s),t.font=e.fontDesc.replace(/(\d+)(\.\d+)?(px|em|rem|pt)/g,((t,e,i,s)=>(+e*r+(+i||0)*r).toString()+s));const n=e.fontSize*r,o=i/2,a=s/2+n*PB+n*BR,h=e.color;if(t.lineJoin="round",t.fillStyle=`rgba(${h.r}, ${h.g}, ${h.b}, 1)`,e.isOutlined){const i=e.out||MR;t.strokeStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${i.a/255})`,t.lineWidth=2*e.margin*r,t.strokeText(this.char,o,a)}t.fillText(this.char,o,a)}}class OR extends qf{initWithSize(t,e,i){void 0===i&&(i=35),this.reset({width:t,height:e,format:i})}drawTextureAt(t,e,i){const s=this.getGFXTexture();if(!t||!s)return;const r=this._getGFXDevice();if(!r)return void G(16363);const n=new bd;n.texOffset.x=e,n.texOffset.y=i,n.texExtent.width=t.width,n.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],s,[n])}}class LR{get width(){return this._width}get height(){return this._height}constructor(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;const i=new OR;i.initWithSize(t,e),this.fontDefDictionary=new TR(i),this._halfBleed=1,this._width=t,this._height=e,uP.on("director_before_scene_launch",this.beforeSceneLoad,this)}insertLetterTexture(t){const e=t.image,i=uP.root.device;if(!e||!this.fontDefDictionary||!i)return null;const s=e.width,r=e.height;if(this._x+s+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return G(12100),null;if(!this.fontDefDictionary.texture)return null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;const n=new xR;return n.u=this._x+this._halfBleed,n.v=this._y+this._halfBleed,n.valid=!0,n.w=t.width-2,n.h=t.height-2,n.xAdvance=n.w,n.offsetY=t.offsetY,this._x+=s+0,this.fontDefDictionary.addLetterDefinitions(t.hash,n),n}update(){this._dirty&&(this._dirty=!1)}reset(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()}destroy(){this.reset();const t=this.fontDefDictionary;t&&t.texture&&(t.texture.destroy(),t.texture=null)}getTexture(){return this.fontDefDictionary.getTexture()}beforeSceneLoad(){this.clearAllCache()}clearAllCache(){this.destroy();const t=new OR;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t}getLetter(t){return this.fontDefDictionary.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const i=$B(t,0)+e.hash;let s=this.fontDefDictionary.letterDefinitions[i];if(!s){const i=new RR(t,e);i.updateRenderData(),s=this.insertLetterTexture(i),i.destroy()}return s}}const FR={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:_r.WHITE.clone(),isOutlined:!1,out:_r.WHITE.clone(),margin:0,fontScale:1};function zR(t){const e=t.color.toHEX();let i="";return t.isOutlined&&t.margin>0&&(i=i+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+i}const kR=[new Wd("a_position",32)],NR=[new Wd("a_position",32),new Wd("a_color",44)],UR=[new Wd("a_position",32),new Wd("a_texCoord",21),new Wd("a_color",44)],VR=[new Wd("a_position",32),new Wd("a_texCoord",21),new Wd("a_color",35,!0)],HR=[new Wd("a_position",32),new Wd("a_texCoord",21),new Wd("a_color",44),new Wd("a_color2",44)],GR=[new Wd("a_position",32),new Wd("a_texCoord",21),new Wd("a_color",35,!0),new Wd("a_color2",35,!0)];function WR(t){let e=0;for(let i=0;i<t.length;i++){const s=t[i];e+=mp[s.format].size}return e}h.internal.vfmtPosUvColor=UR,h.internal.vfmtPosUvTwoColor=HR,h.internal.vfmtPosUvColor4B=VR,h.internal.vfmtPosUvTwoColor4B=GR;class jR{get attributes(){return this._attributes}get vertexFormatBytes(){return this._vertexFormatBytes}get byteOffset(){return this._byteOffset}set byteOffset(t){this._byteOffset=t}get vertexOffset(){return this._vertexOffset}set vertexOffset(t){this._vertexOffset=t}get indexOffset(){return this._indexOffset}set indexOffset(t){this._indexOffset=t}get dirty(){return this._dirty}set dirty(t){this._dirty=t}get floatsPerVertex(){return this._floatsPerVertex}set floatsPerVertex(t){this._floatsPerVertex=t}get vData(){return this._vData}set vData(t){this._vData=t}get iData(){return this._iData}set iData(t){this._iData=t}get nativeObj(){return this._nativeObj}get sharedBuffer(){return this._sharedBuffer}initSharedBuffer(){}syncSharedBufferToNative(){}constructor(){this._byteOffset=0,this._vertexOffset=0,this._indexOffset=0,this._dirty=!1,this._floatsPerVertex=0,this._vData=null,this._iData=null,this._vertexFormatBytes=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0,this.initSharedBuffer(),this.syncSharedBufferToNative()}initialize(t,e,i,s){this._initVDataCount=i,this._initIDataCount=s,this._attributes=e,this.floatsPerVertex=WR(e)>>2,this._initVDataCount,this._floatsPerVertex,Y(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(t))}reset(){this._nextFreeIAHandle=0,this.dirty=!1}destroy(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(let t=0;t<this._iaPool.length;++t){const e=this._iaPool[t];e.vertexBuffers[0]&&e.vertexBuffers[0].destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.ia.destroy()}this._iaPool.length=0}setDirty(){this.dirty=!0}request(t,e){return G(9002),!1}requireFreeIA(t){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(t)),this._iaPool[this._nextFreeIAHandle++].ia}recycleIA(t){const e=this._iaPool;for(let i=0;i<this._nextFreeIAHandle;++i)if(t===e[i].ia){const t=e[i];return e[i]=e[--this._nextFreeIAHandle],void(e[this._nextFreeIAHandle]=t)}}checkCapacity(t,e){const i=(this.vertexOffset+t)*this._floatsPerVertex,s=this.indexOffset+e;return!(i>this._initVDataCount||s>this._initIDataCount)}uploadBuffers(){if(0===this.byteOffset||!this._dirty)return;const t=Hn.__isWebIOS14OrIPadOS14Env,e=t?this._nextFreeIAHandle:1;if(t&&e/this._iaPool.length<.5){const t=e/.5;for(let e=this._iaPool.length-1;e>=t;e--){const t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=t}const i=this.byteOffset,s=this.indexOffset;for(let t=0;t<e;++t){const e=this._iaPool[t],r=new Float32Array(this.vData.buffer,0,i>>2),n=new Uint16Array(this.iData.buffer,0,s),o=e.vertexBuffers[0];i>o.size&&o.resize(i),o.update(r),2*s>e.indexBuffer.size&&e.indexBuffer.resize(2*s),e.indexBuffer.update(n)}this.dirty=!1}createNewIA(t){let e,i,s;if(Hn.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){const r=this._vertexFormatBytes=4*this._floatsPerVertex,n=2,o=t.createBuffer(new Ed(10,3,r,r));s=t.createBuffer(new Ed(6,3,n,n)),i=[o],this._iaInfo=new $d(this._attributes,i,s),e=t.createInputAssembler(this._iaInfo)}else e=t.createInputAssembler(this._iaInfo),i=this._iaInfo.vertexBuffers,s=this._iaInfo.indexBuffer;return{ia:e,vertexBuffers:i,indexBuffer:s}}}t("MeshBuffer",jR);class $R{get attributes(){return this._attributes}get vertexFormatBytes(){return this._vertexFormatBytes}get floatsPerVertex(){return this._floatsPerVertex}constructor(t,e){this._buffers=[],this._device=t,this._attributes=e,this._floatsPerVertex=WR(e)>>2,this._vertexFormatBytes=4*this._floatsPerVertex}initialize(){}reset(){}request(t,e){}appendBuffers(t,e){}uploadBuffers(){}destroy(){this._attributes.length=0}}const qR=new rn((()=>({offset:0,length:0})),32);class XR{get ib(){return this._ib}constructor(t,e,i,s,r,n){this.vertexAccessor=t,this.bufferId=e,this.meshBuffer=i,this.vertexOffset=s,this.vb=r,this.indexCount=n,this._ib=new Uint16Array(n),t.getMeshBuffer(e)}setIndexBuffer(t){}}class YR extends $R{get id(){return this._id}constructor(t,e,i,s){super(t,e),this._freeLists=[],this._vCount=0,this._iCount=0,this._id=0,this._vCount=i||Math.floor(1024*le.BATCHER2D_MEM_INCREMENT/this._vertexFormatBytes),this._iCount=s||this._vCount*YR.IB_SCALE,this._id=YR.generateID(),this._allocateBuffer()}destroy(){for(let t=0;t<this._buffers.length;++t){this._buffers[t].destroy();const e=this._freeLists[t];for(let t=0;t<e.length;++t)qR.free(e[t])}this._buffers.length=0,this._freeLists.length=0,super.destroy()}reset(){for(let t=0;t<this._buffers.length;++t){const e=this._buffers[t];e.indexOffset=0,e.reset()}}getVertexBuffer(t){return this._buffers[t].vData}getIndexBuffer(t){return this._buffers[t].iData}getMeshBuffer(t){return this._buffers[t]}uploadBuffers(){for(let t=0;t<this._buffers.length;++t){const e=this._freeLists[t][0],i=this._buffers[t];(!e||e.length<i.vData.byteLength)&&i.uploadBuffers()}}appendIndices(t,e){const i=this._buffers[t];if(e.length){const t=i.indexOffset+e.length;if(i.iData.length<t){const e=Math.floor(1.25*t),s=new Uint16Array(e);s.set(i.iData),i.iData=s}i.iData.set(e,i.indexOffset),i.indexOffset+=e.length}}allocateChunk(t,e){const i=t*this.vertexFormatBytes;if(t>this._vCount||e>this._iCount)return j(9004,i),null;let s,r=null,n=0,o=-1,a=null;for(let t=0;t<this._buffers.length;++t){r=this._buffers[t],s=this._freeLists[t];for(let e=0;e<s.length;++e)if(s[e].length>=i){a=s[e],n=t,o=e;break}if(a)break}if(a||(n=this._allocateBuffer(),r=this._buffers[n],r&&(o=0,a=this._freeLists[n][o])),a){const t=a.offset/this.vertexFormatBytes,s=new Float32Array(r.vData.buffer,a.offset,i>>2).fill(0);return this._allocateChunkFromEntry(n,o,a,i),new XR(this,n,r,t,s,e)}return null}recycleChunk(t){const e=this._freeLists[t.bufferId],i=this._buffers[t.bufferId];let s=t.vertexOffset*this.vertexFormatBytes,r=t.vb.byteLength;if(0===r)return;let n=!1,o=0,a=null,h=e[o];for(;h&&h.offset<s;)a=h,h=e[++o];if(a&&0==s-(a.offset+a.length)&&(a.length+=r,s=a.offset,r=a.length,h&&h.offset-(s+r)==0&&(a.length+=h.length,e.splice(o,1),qR.free(h),h=null),n=!0),!n&&h){if(0==h.offset-(s+r))h.offset=s,h.length+=r;else{const t=qR.alloc();t.offset=s,t.length=r,e.splice(o,0,t)}n=!0}if(n)s+r===i.byteOffset&&(i.byteOffset=s);else{const t=qR.alloc();t.offset=s,t.length=r,e.push(t)}}_allocateChunkFromEntry(t,e,i,s){const r=i.length-s,n=i.offset+s,o=this._buffers[t];o.byteOffset<n&&(o.byteOffset=n),q(r>=0,9004,t,i.offset,i.length),0===r?(this._freeLists[t].splice(e,1),qR.free(i)):(i.offset+=s,i.length=r)}_allocateBuffer(){q(this._buffers.length===this._freeLists.length,9003);const t=new jR,e=this._vCount*this._floatsPerVertex;t.initialize(this._device,this._attributes,e,this._iCount),this._buffers.push(t);const i=qR.alloc();i.offset=0,i.length=t.vData.byteLength;const s=[i];return this._freeLists.push(s),uP.root.batcher2D.syncMeshBuffersToNative(this.id,this._buffers),this._buffers.length-1}static generateID(){return YR.ID_COUNT++}}YR.IB_SCALE=4,YR.ID_COUNT=0;const QR=WR(UR)>>2;class KR{get vertexCount(){return this._vc}get indexCount(){return this._ic}get stride(){return this._floatStride<<2}get floatStride(){return this._floatStride}get vertexFormat(){return this._vertexFormat}get drawInfoType(){return this._drawInfoType}set drawInfoType(t){this._drawInfoType=t,this._renderDrawInfo&&this._renderDrawInfo.setDrawInfoType(t)}get renderDrawInfo(){return this._renderDrawInfo}get material(){return this._material}set material(t){this._material=t,this._renderDrawInfo&&this._renderDrawInfo.setMaterial(t)}get dataHash(){return this._dataHash}set dataHash(t){this._dataHash=t,this._renderDrawInfo&&this._renderDrawInfo.setDataHash(t)}get multiOwner(){return this._multiOwner}set multiOwner(t){this._multiOwner=t}get batcher(){return this._batcher||(this._batcher=uP.root.batcher2D),this._batcher}constructor(t){void 0===t&&(t=UR),this.chunk=null,this._renderDrawInfo=null,this._material=null,this._dataHash=0,this._isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=UR,this._drawInfoType=0,this._multiOwner=!1,this._batcher=null,this._floatStride=t===UR?QR:WR(t)>>2,this._vertexFormat=t}isValid(){return this._ic>0&&this.chunk.vertexAccessor}initRenderDrawInfo(t,e){}removeRenderDrawInfo(t){}setRenderDrawInfoAttributes(){}}t("BaseRenderData",KR);let ZR=class t extends KR{static add(e,i){void 0===e&&(e=UR),void 0===i&&(i=null);const s=new t(e,i);return i||(i=uP.root.batcher2D.switchBufferAccessor(s._vertexFormat)),s._accessor=i,s}static remove(t){t.clear(),t._accessor=null}get dataLength(){return this._data.length}set dataLength(t){const e=this._data;if(e.length!==t){for(let i=e.length;i<t;i++)e.push({x:0,y:0,z:0,u:0,v:0,color:_r.WHITE.clone()});e.length=t}this.syncRender2dBuffer()}get data(){return this._data}get vertDirty(){return this._vertDirty}set vertDirty(t){this._vertDirty=t,this._renderDrawInfo&&t&&this._renderDrawInfo.setVertDirty(t)}get textureHash(){return this._textureHash}set textureHash(t){this._textureHash=t}set frame(t){this._frame=t,this._renderDrawInfo&&(this._frame?(this._renderDrawInfo.setTexture(this._frame.getGFXTexture()),this._renderDrawInfo.setSampler(this._frame.getGFXSampler())):(this._renderDrawInfo.setTexture(null),this._renderDrawInfo.setSampler(null)))}get frame(){return this._frame}get accessor(){return this._accessor}constructor(t,e){void 0===t&&(t=UR),void 0===e&&(e=null),super(t),this._vertDirty=!0,this._textureHash=0,this.indices=null,this.layer=0,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this._data=[],this._frame=null,this._accessor=null,this.vertexRow=1,this.vertexCol=1,e||(e=this.batcher.switchBufferAccessor(this._vertexFormat)),this._accessor=e}resize(t,e){t===this._vc&&e===this._ic&&this.chunk||(this._vc=t,this._ic=e,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(t,e),this.updateHash())}setRenderDrawInfoAttributes(){}fillDrawInfoAttributes(t){}syncRender2dBuffer(){}resizeAndCopy(t,e){if(t===this._vc&&e===this._ic&&this.chunk)return;this._vc=t,this._ic=e;const i=this.chunk;this.chunk=this._accessor.allocateChunk(t,e),i&&(this.chunk.vb.set(i.vb),this._accessor.recycleChunk(i)),this.updateHash()}getMeshBuffer(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null}updateNode(t){this.layer=t.node.layer,this.nodeDirty=!1,this.hashDirty=!0}updatePass(t){this.material=t.getRenderMaterial(0),this.passDirty=!1,this.hashDirty=!0}updateTexture(t){this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0}updateHash(){const t=`${this.chunk?this.chunk.bufferId:-1}${this.layer} ${this.textureHash}`;this.dataHash=du(t,666),this.hashDirty=!1}updateRenderData(t,e){if(this.passDirty&&(this.material=t.getRenderMaterial(0),this.passDirty=!1,this.hashDirty=!0,this._renderDrawInfo&&this._renderDrawInfo.setMaterial(this.material)),this.nodeDirty){const e=t.node.scene?t._getRenderScene():null;this.layer=t.node.layer,null!==e&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0,this._renderDrawInfo&&(this._renderDrawInfo.setTexture(this.frame?this.frame.getGFXTexture():null),this._renderDrawInfo.setSampler(this.frame?this.frame.getGFXSampler():null))),this.hashDirty&&(this.updateHash(),this._renderDrawInfo&&this._renderDrawInfo.setDataHash(this.dataHash))}clear(){this.resize(0,0),this._data.length=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.frame=null,this.textureHash=0,this.dataHash=0}static createStaticVBAccessor(t,e,i){const s=uP.root.device;return new YR(s,t,e,i)}};t("RenderData",ZR);class JR extends KR{static add(t){void 0===t&&(t=UR);const e=new JR;return e._floatStride=t===UR?QR:WR(t)>>2,e._vertexFormat=t,e}static remove(t){t.clear()}set formatByte(t){}get formatByte(){return this.stride}get floatStride(){return this._floatStride}get vDataOffset(){return this._byteLength>>>2}constructor(t){void 0===t&&(t=UR),super(t),this._isMeshBuffer=!0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.frame=null,this._byteLength=0,this._vertexBuffers=[],this._indexBuffer=null,this._iaPool=null,this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)}request(t,e){const i=this._byteLength+t*this.stride;return!!this.reserve(t,e)&&(this._vc+=t,this._ic+=e,this._byteLength=i,this.vertexRange=this._vc,this.indexRange=this._ic,!0)}reserve(t,e){const i=this._byteLength+t*this.stride,s=this.indexCount+e;if(t+this.vertexCount>65535)return!1;let r=this.vData.byteLength,n=this.iData.length,o=this.vData.length,a=this.iData.length;if(i>r||s>n){for(;r<i||n<s;)o*=2,a*=2,r=4*o,n=a;this._reallocBuffer(o,a)}return!0}resize(t,e){const i=t*this.stride;t>=0&&e>=0&&i<=this.vData.byteLength&&this.iData.length,this._vc=t,this._ic=e,this._byteLength=i,this.updateRange(0,t,0,e)}updateRange(t,e,i,s){e>=0&&s>=0&&e<=this._vc&&this._ic,this.vertexStart=t,this.indexStart=i,this.vertexRange=e,this.indexRange=s}requestIA(t){this._initIAInfo(t);const e=this._iaPool.add();return e.firstIndex=this.indexStart,e.indexCount=this.indexRange,e}uploadBuffers(){if(0===this._byteLength||!this._vertexBuffers[0]||!this._indexBuffer)return;const t=this._ic,e=new Float32Array(this.vData.buffer,0,this._byteLength>>2),i=new Uint16Array(this.iData.buffer,0,t),s=this._vertexBuffers[0];this._byteLength>s.size&&s.resize(this._byteLength),s.update(e);const r=t<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(i)}freeIAPool(){this._iaPool&&this._iaPool.reset()}reset(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()}clear(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)}_initIAInfo(t){if(!this._iaInfo){const e=this.stride,i=this._vertexBuffers;i.length||i.push(t.createBuffer(new Ed(10,1,e,e)));const s=2;this._indexBuffer||(this._indexBuffer=t.createBuffer(new Ed(6,1,s,s))),this._iaInfo=new $d(this._vertexFormat,i,this._indexBuffer),this._iaPool=new nn((()=>t.createInputAssembler(this._iaInfo)),1,(t=>{t.destroy()}))}}_reallocBuffer(t,e){const i=this.vData;this.vData=new Float32Array(t),i&&this.vData.set(i,0);const s=this.iData;this.iData=new Uint16Array(e),s&&this.iData.set(s,0)}setRenderDrawInfoAttributes(){}particleInitRenderDrawInfo(t){}}var tO,eO,iO,sO,rO;t("MeshRenderData",JR);const nO=new Qs,oO=new Qs,aO=new Ki,hO=new Rs,lO=new Rs,cO=new Rs,uO=new Rs(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),dO=new Cr;let pO=t("UITransform",oa("cc.UITransform")(tO=ha(110)(tO=la((rO=class t extends Ag{constructor(){super(),this._priority=0,this._contentSize=iO&&iO(),this._anchorPoint=sO&&sO()}get contentSize(){return this._contentSize}set contentSize(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit("size-changed"),this._markRenderDataDirty())}get width(){return this._contentSize.width}set width(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit("size-changed"),this._markRenderDataDirty())}get height(){return this._contentSize.height}set height(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit("size-changed"),this._markRenderDataDirty())}get anchorPoint(){return this._anchorPoint}set anchorPoint(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit("anchor-changed",this._anchorPoint),this._markRenderDataDirty())}get anchorX(){return this._anchorPoint.x}set anchorX(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit("anchor-changed",this._anchorPoint),this._markRenderDataDirty())}get anchorY(){return this._anchorPoint.y}set anchorY(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit("anchor-changed",this._anchorPoint),this._markRenderDataDirty())}get priority(){return this._priority}set priority(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?G(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}get visibility(){const t=uP.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}get cameraPriority(){const t=uP.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}__preload(){this.node._uiProps.uiTransformComp=this}onLoad(){this.node.parent&&t.insertChangeMap(this.node.parent)}onEnable(){this.node.on("parent-changed",this._parentChanged,this),this._markRenderDataDirty()}onDisable(){this.node.off("parent-changed",this._parentChanged,this)}onDestroy(){this.node._uiProps.uiTransformComp=null}setContentSize(t,e){const i=this._contentSize;let s,r;if(void 0===e){if(gi(t.width,i.width,pi)&&gi(t.height,i.height,pi))return;s=t.width,r=t.height}else{if(gi(t,i.width,pi)&&gi(e,i.height,pi))return;s=t,r=e}i.width=s,i.height=r,this.node.emit("size-changed"),this._markRenderDataDirty()}setAnchorPoint(t,e){const i=this._anchorPoint;if(void 0===e){if(t.x===i.x&&t.y===i.y)return;i.x=t.x,i.y=t.y}else{if(t===i.x&&e===i.y)return;i.x=t,i.y=e}this.node.emit("anchor-changed",this._anchorPoint),this._markRenderDataDirty()}isHit(t){const e=this._contentSize.width,i=this._contentSize.height,s=nO,r=oO,n=this._getRenderScene().cameras;for(let o=0;o<n.length;o++){const a=n[o];if(!(a.visibility&this.node.layer))continue;a.node.getWorldRT(hO);const h=hO.m12,l=hO.m13,c=Gn.center;if(hO.m12=c.x-(hO.m00*h+hO.m04*l),hO.m13=c.y-(hO.m01*h+hO.m05*l),Rs.invert(hO,hO),Qs.transformMat4(s,t,hO),this.node.getWorldMatrix(cO),Rs.invert(hO,cO),Rs.strictEquals(hO,uO))continue;Qs.transformMat4(r,s,hO),r.x+=this._anchorPoint.x*e,r.y+=this._anchorPoint.y*i;let u=!1;if(r.x>=0&&r.y>=0&&r.x<=e&&r.y<=i&&(u=this._maskTest(s)),u)return!0}return!1}hitTest(t,e){void 0===e&&(e=0);const i=this._contentSize.width,s=this._contentSize.height,r=aO,n=nO,o=oO,a=this._getRenderScene().cameras;for(let h=0;h<a.length;h++){const l=a[h];if(!(l.visibility&this.node.layer)||l.window&&!l.window.swapchain)continue;if(l.systemWindowId!==e)continue;if(Ki.set(r,t.x,t.y,0),l.screenToWorld(r,r),Qs.set(n,r.x,r.y),this.node.getWorldMatrix(cO),Rs.invert(hO,cO),Rs.strictEquals(hO,uO))continue;Qs.transformMat4(o,n,hO),o.x+=this._anchorPoint.x*i,o.y+=this._anchorPoint.y*s;let c=!1;if(o.x>=0&&o.y>=0&&o.x<=i&&o.y<=s&&(c=this._maskTest(n)),c)return!0}return!1}_maskTest(t){var e,i;const s=null===(e=this.node)||void 0===e||null===(i=e.eventProcessor)||void 0===i?void 0:i.maskList;if(s){let e=this.node;const i=s.length;for(let r=0,n=0;e&&n<i;++r,e=e.parent){const i=s[n];if(r===i.index){if(e!==i.comp.node){s.length=n;break}{const e=i.comp;if(e&&e._enabled&&!e.isHit(t))return!1;n++}}else if(r>i.index){s.length=n;break}}}return!0}convertToNodeSpaceAR(t,e){return this.node.getWorldMatrix(cO),Rs.invert(hO,cO),e||(e=new Ki),Ki.transformMat4(e,t,hO)}convertToWorldSpaceAR(t,e){return this.node.getWorldMatrix(cO),e||(e=new Ki),Ki.transformMat4(e,t,cO)}getBoundingBox(){const t=new Cr;return this._selfBoundingBox(t),Rs.fromSRT(lO,this.node.rotation,this.node.position,this.node.scale),t.transformMat4(lO),t}getBoundingBoxToWorld(){const e=new Cr,i=this.node.children;for(let s=0;s<i.length;++s){const r=i[s];if(r&&r.active){const i=r.getComponent(t);i&&i.contentSize.width&&i.contentSize.height&&(i._selfBoundingBox(dO),dO.transformMat4(r.worldMatrix),0===e.width?e.set(dO):Cr.union(e,e,dO))}}return this._contentSize.width&&this._contentSize.height&&(this._selfBoundingBox(dO),dO.transformMat4(this.node.worldMatrix),0===e.width?e.set(dO):Cr.union(e,e,dO)),e}getBoundingBoxTo(e){const i=new Cr,s=this.node.children;Rs.invert(hO,e);for(let e=0;e<s.length;++e){const r=s[e];if(r&&r.active){const e=r.getComponent(t);e&&e.contentSize.width&&e.contentSize.height&&(e._selfBoundingBox(dO),Rs.multiply(lO,r.worldMatrix,hO),dO.transformMat4(lO),0===i.width?i.set(dO):Cr.union(i,i,dO))}}return this._contentSize.width&&this._contentSize.height&&(this._selfBoundingBox(dO),Rs.multiply(lO,this.node.worldMatrix,hO),dO.transformMat4(lO),0===i.width?i.set(dO):Cr.union(i,i,dO)),i}getComputeAABB(t){const e=this._contentSize.width,i=this._contentSize.height;dO.set(-this._anchorPoint.x*e,-this._anchorPoint.y*i,e,i),dO.transformMat4(this.node.worldMatrix);const s=dO.x+.5*dO.width,r=dO.y+.5*dO.height,n=this.node.worldPosition.z,o=dO.width/2,a=dO.height/2;return null!=t?(Qn.set(t,s,r,n,o,a,.001),t):new Qn(s,r,n,o,a,.001)}_selfBoundingBox(t){const e=this._contentSize.width,i=this._contentSize.height;return t.set(-this._anchorPoint.x*e,-this._anchorPoint.y*i,e,i),t}_parentChanged(e){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)}_markRenderDataDirty(){const t=this.node._uiProps.uiComp;t&&t.markForUpdateRenderData()}static insertChangeMap(e){const i=e.uuid;t.priorityChangeNodeMap.has(i)||t.priorityChangeNodeMap.set(i,e)}static _sortChildrenSibling(t){const e=t.children;e&&e.sort(((t,e)=>{const i=t._uiProps.uiTransformComp,s=e._uiProps.uiTransformComp,r=(i?i._priority:0)-(s?s._priority:0);return 0===r?t.getSiblingIndex()-e.getSiblingIndex():r}))}static _sortSiblings(){t.priorityChangeNodeMap.forEach((e=>{t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()}static _cleanChangeMap(){t.priorityChangeNodeMap.clear()}},rO.EventType=vS,rO.priorityChangeNodeMap=new Map,iO=Qo((eO=rO).prototype,"_contentSize",[va],(function(){return new br(100,100)})),sO=Qo(eO.prototype,"_anchorPoint",[va],(function(){return new Qs(.5,.5)})),tO=eO))||tO)||tO)||tO);var _O,gO,fO,mO,yO,vO;uP.on("director_after_update",pO._sortSiblings),uP.on("director_before_scene_launch",pO._cleanChangeMap);const bO={parent:null,owner:null,subModelIdx:0},{ccclass:wO,serializable:SO,disallowMultiple:xO,type:TO,displayOrder:CO,displayName:IO}=Ja;let EO=t("Renderer",(_O=wO("cc.Renderer"),gO=TO(Lw),fO=TO([Lw]),_O(mO=xO((yO=class extends Ag{constructor(){super(),this._materials=vO&&vO(),this._materialInstances=[]}get sharedMaterial(){return this.getSharedMaterial(0)}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setSharedMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setSharedMaterial(null,e);this._materials.splice(t.length)}}get material(){return this.getMaterialInstance(0)}set material(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}get materials(){for(let t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances}set materials(t){const e=t.length,i=this._materials.length;for(let t=e;t<i;t++)this.setMaterialInstance(null,t);this._materials.length=e,this._materialInstances.length=e;for(let i=0;i<e;i++)this._materialInstances[i]!=t[i]&&this.setMaterialInstance(t[i],i)}getMaterial(t){return this.getSharedMaterial(t)}setMaterial(t,e){this.setSharedMaterial(t,e)}getSharedMaterial(t){return t<0||t>=this._materials.length?null:this._materials[t]}setSharedMaterial(t,e){t&&t instanceof Gw&&j(12012),this._materials[e]=t;const i=this._materialInstances[e];i&&(i.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])}getMaterialInstance(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){bO.parent=this._materials[t],bO.owner=this,bO.subModelIdx=t;const e=new Gw(bO);bO.parent=null,bO.owner=null,bO.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]}setMaterialInstance(t,e){if("number"==typeof t){G(12007);const i=t;t=e,e=i}const i=this._materialInstances[e];t&&t.parent?t!==i&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||i)&&this.setSharedMaterial(t,e)}getRenderMaterial(t){return this._materialInstances[t]||this._materials[t]}_onMaterialModified(t,e){}_onRebuildPSO(t,e){}_clearMaterials(){}},s(yO.prototype,"sharedMaterials",[gO],Object.getOwnPropertyDescriptor(yO.prototype,"sharedMaterials"),yO.prototype),vO=Qo(yO.prototype,"_materials",[fO],(function(){return[]})),mO=yO))||mO)||mO));class DO{get nativeObj(){return this._nativeObj}get renderDrawInfoArr(){return this._dynamicDrawInfoArr}get renderEntityType(){return this._renderEntityType}get color(){return this._color}set color(t){this._color=t}get localOpacity(){return this._localOpacity}set localOpacity(t){this._localOpacity=t}get colorDirty(){return this._colorDirty}set colorDirty(t){this._colorDirty=t}get enabled(){return this._enabled}set enabled(t){this._enabled=t}constructor(t){this._renderEntityType=0,this._dynamicDrawInfoArr=[],this._node=null,this._renderTransform=null,this._stencilStage=0,this._useLocal=!1,this._maskMode=0,this._color=_r.WHITE.clone(),this._localOpacity=255,this._colorDirty=!0,this._enabled=!1}addDynamicRenderDrawInfo(t){}removeDynamicRenderDrawInfo(){}clearDynamicRenderDrawInfos(){}clearStaticRenderDrawInfos(){}setDynamicRenderDrawInfo(t,e){}setMaskMode(t){this._maskMode=t}getStaticRenderDrawInfo(){return null}setNode(t){this._node=t}setRenderTransform(t){this._renderTransform=t}setStencilStage(t){this._stencilStage=t}setUseLocal(t){this._useLocal=t}initSharedBuffer(){}}var AO,MO,PO,BO,RO,OO,LO,FO,zO,kO,NO,UO;se(Hu),se(Gu),se(Wu),t("InstanceMaterialType",{ADD_COLOR:0,ADD_COLOR_AND_TEXTURE:1,GRAYSCALE:2,USE_ALPHA_SEPARATED:3,USE_ALPHA_SEPARATED_AND_GRAY:4});let VO=t("UIRenderer",(AO=oa("cc.UIRenderer"),MO=aa(pO),PO=Ga(Lw),BO=Ga(Lw),AO(RO=MO((UO=class t extends EO{constructor(){super(),this._renderData=null,this._materials=LO&&LO(),this._customMaterial=FO&&FO(),this._srcBlendFactor=zO&&zO(),this._dstBlendFactor=kO&&kO(),this._color=NO&&NO(),this._stencilStage=0,this._assembler=null,this._postAssembler=null,this._renderDataFlag=!0,this._renderFlag=!0,this._instanceMaterialType=-1,this._srcBlendFactorCache=2,this._dstBlendFactorCache=4,this._dirtyVersion=-1,this._internalId=-1,this._flagChangedVersion=-1,this._useVertexOpacity=!1,this._lastParent=null,this._renderEntity=this.createRenderEntity()}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setSharedMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setSharedMaterial(null,e);this._materials.splice(t.length)}}get customMaterial(){return this._customMaterial}set customMaterial(t){this._customMaterial=t,this.updateMaterial()}get color(){return this._color}set color(t){this._color.equals(t)||(this._color.set(t),this._updateColor())}get renderData(){return this._renderData}setRenderData(t){this._renderData=t}get useVertexOpacity(){return this._useVertexOpacity}get stencilStage(){return this._stencilStage}set stencilStage(t){this._stencilStage=t,this._renderEntity.setStencilStage(t)}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){this._srcBlendFactor=t}get batcher(){return uP.root.batcher2D}get renderEntity(){return this._renderEntity}onLoad(){this._renderEntity.setNode(this.node)}__preload(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}onEnable(){this.node.on("anchor-changed",this._nodeStateChange,this),this.node.on("size-changed",this._nodeStateChange,this),this.node.on("parent-changed",this._colorDirty,this),this.updateMaterial(),this._colorDirty(),hP.addRenderer(this),this.markForUpdateRenderData()}onRestore(){this.updateMaterial(),this.markForUpdateRenderData()}onDisable(){this.node.off("anchor-changed",this._nodeStateChange,this),this.node.off("size-changed",this._nodeStateChange,this),this.node.off("parent-changed",this._colorDirty,this),hP.removeRenderer(this),this._renderFlag=!1,this._renderEntity.enabled=!1}onDestroy(){if(this._renderEntity.setNode(null),this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(let t=0;t<this._materialInstances.length;t++){const e=this._materialInstances[t];e&&e.destroy()}}markForUpdateRenderData(t){if(void 0===t&&(t=!0),t){const t=this._renderData;t&&(t.vertDirty=!0),hP.markDirtyRenderer(this)}}requestRenderData(t){void 0===t&&(t=0);const e=ZR.add();return e.initRenderDrawInfo(this,t),this._renderData=e,e}destroyRenderData(){this._renderData&&(this._renderData.removeRenderDrawInfo(this),ZR.remove(this._renderData),this._renderData=null)}updateRenderer(){this._assembler&&this._assembler.updateRenderData(this),this._renderFlag=this._canRender(),this._renderEntity.enabled=this._renderFlag}fillBuffers(t){this._renderFlag&&this._render(t)}postUpdateAssembler(t){this._postAssembler&&this._renderFlag&&this._postRender(t)}_render(t){}_postRender(t){}_canRender(){return null!==this.getSharedMaterial(0)&&this._enabled&&this._color.a>0}_postCanRender(){}updateMaterial(){if(this._customMaterial)return void(this.getSharedMaterial(0)!==this._customMaterial&&this.setSharedMaterial(this._customMaterial,0));const t=this._updateBuiltinMaterial();this.setSharedMaterial(t,0),2!==this.stencilStage&&6!==this.stencilStage||this.getMaterialInstance(0).recompileShaders({USE_ALPHA_TEST:!0}),this._updateBlendFunc()}_updateColor(){if(this.node._uiProps.colorDirty=!0,this.setEntityColorDirty(!0),this.setEntityColor(this._color),this.setEntityOpacity(this.node._uiProps.localOpacity),this._assembler){this._assembler.updateColor(this);const t=this._renderFlag;if(this._renderFlag=this._canRender(),this.setEntityEnabled(this._renderFlag),t!==this._renderFlag){const t=this.renderData;t&&(t.vertDirty=!0)}}}static setEntityColorDirtyRecursively(e,i){const s=e._uiProps.uiComp;s&&s.color&&(s._renderEntity.colorDirty=i);for(let s=0;s<e.children.length;s++)t.setEntityColorDirtyRecursively(e.children[s],i)}setEntityColorDirty(t){}setEntityColor(t){}setEntityOpacity(t){}setEntityEnabled(t){}_updateBlendFunc(){let t=this.getRenderMaterial(0).passes[0].blendState.targets[0];if(this._dstBlendFactorCache=t.blendDst,this._srcBlendFactorCache=t.blendSrc,this._dstBlendFactorCache!==this._dstBlendFactor||this._srcBlendFactorCache!==this._srcBlendFactor){t=this.getMaterialInstance(0).passes[0].blendState.targets[0],t.blend=!0,t.blendDstAlpha=4,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor;const e=this.getMaterialInstance(0).passes[0];e.blendState.setTarget(0,t),e._updatePassHash(),this._dstBlendFactorCache=this._dstBlendFactor,this._srcBlendFactorCache=this._srcBlendFactor}}_nodeStateChange(e){this._renderData&&this.markForUpdateRenderData();for(let e=0;e<this.node.children.length;++e){const i=this.node.children[e].getComponent(t);i&&i.markForUpdateRenderData()}}_colorDirty(){this.node._uiProps.colorDirty=!0,this.setEntityColorDirty(!0)}_onMaterialModified(t,e){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),super._onMaterialModified(t,e)}_updateBuiltinMaterial(){let t;switch(this._instanceMaterialType){case 0:t=pw.get("ui-base-material");break;case 2:t=pw.get("ui-sprite-gray-material");break;case 3:t=pw.get("ui-sprite-alpha-sep-material");break;case 4:t=pw.get("ui-sprite-gray-alpha-sep-material");break;default:t=pw.get("ui-sprite-material")}return t}setNodeDirty(){this._renderData&&(this._renderData.nodeDirty=!0)}setTextureDirty(){this._renderData&&(this._renderData.textureDirty=!0)}createRenderEntity(){return new DO(0)}},UO.BlendState=Hu,UO.Assembler=null,UO.PostAssembler=null,s((OO=UO).prototype,"sharedMaterials",[Wa],Object.getOwnPropertyDescriptor(OO.prototype,"sharedMaterials"),OO.prototype),s(OO.prototype,"customMaterial",[PO],Object.getOwnPropertyDescriptor(OO.prototype,"customMaterial"),OO.prototype),LO=Qo(OO.prototype,"_materials",[Wa],(function(){return[]})),FO=Qo(OO.prototype,"_customMaterial",[BO],(function(){return null})),zO=Qo(OO.prototype,"_srcBlendFactor",[va],(function(){return 2})),kO=Qo(OO.prototype,"_dstBlendFactor",[va],(function(){return 4})),NO=Qo(OO.prototype,"_color",[va],(function(){return _r.WHITE.clone()})),RO=OO))||RO)||RO));h.internal.UIRenderer=VO;class HO{constructor(){this.isBold=!1,this.isItalic=!1,this.isUnderline=!1,this.underlineHeight=1,this.isOutlined=!1,this.outlineColor=_r.WHITE.clone(),this.outlineWidth=1,this.hasShadow=!1,this.shadowColor=_r.BLACK.clone(),this.shadowBlur=2,this.shadowOffsetX=0,this.shadowOffsetY=0,this.color=_r.WHITE.clone(),this.fontSize=40,this.actualFontSize=0,this.isSystemFontUsed=!1,this.originFontSize=0,this.bmfontScale=1,this.fontFamily="Arial",this.fontDesc="",this.fntConfig=null,this.spriteFrame=null,this.fontScale=1}reset(){this.isBold=!1,this.isItalic=!1,this.isUnderline=!1,this.underlineHeight=1,this.isOutlined=!1,this.outlineColor.set(),this.outlineWidth=1,this.hasShadow=!1,this.shadowColor.set(),this.shadowBlur=2,this.shadowOffsetX=0,this.shadowOffsetY=0}}class GO{constructor(){this.horizontalAlign=0,this.verticalAlign=0,this.wrapping=!0,this.overFlow=0,this.lineHeight=10,this.maxLineWidth=0,this.spacingX=0,this.textWidthTemp=0,this.textHeightTemp=0,this.textDimensions=new br,this.horizontalKerning=[],this.numberOfLines=1,this.linesOffsetX=[],this.letterOffsetY=0,this.tailoredTopY=0,this.tailoredBottomY=0,this.textDesiredHeight=0,this.linesWidth=[]}reset(){this.horizontalAlign=0,this.verticalAlign=0,this.wrapping=!0,this.overFlow=0,this.lineHeight=10,this.maxLineWidth=0,this.spacingX=0,this.textWidthTemp=0,this.textHeightTemp=0,this.textDimensions.set(),this.horizontalKerning.length=0,this.numberOfLines=1,this.linesOffsetX.length=0,this.letterOffsetY=0,this.tailoredTopY=0,this.tailoredBottomY=0,this.textDesiredHeight=0,this.linesWidth.length=0}}class WO{constructor(){this.parsedString=[],this.nodeContentSize=br.ZERO.clone(),this.canvasSize=new br,this.canvasPadding=new Cr,this.contentSizeExtend=br.ZERO.clone(),this.startPosition=Qs.ZERO.clone()}reset(){this.parsedString.length=0,this.nodeContentSize.set(0,0),this.canvasSize.set(),this.canvasPadding.set(),this.contentSizeExtend.set(),this.startPosition.set()}}class jO{constructor(){this.quadCount=0,this.vertexBuffer=[],this.texture=null,this.uiTransAnchorX=.5,this.uiTransAnchorY=.5}reset(){this.quadCount=0,this.vertexBuffer.length=0,this.texture=null,this.uiTransAnchorX=.5,this.uiTransAnchorY=.5}}var $O,qO,XO,YO,QO,KO,ZO,JO,tL,eL,iL,sL,rL,nL,oL,aL,hL,lL,cL,uL,dL,pL,_L,gL,fL,mL,yL,vL,bL,wL,SL,xL,TL,CL;_r.WHITE.clone();const IL=t("HorizontalTextAlignment",{LEFT:0,CENTER:1,RIGHT:2});se(IL);const EL=t("VerticalTextAlignment",{TOP:0,CENTER:1,BOTTOM:2});se(EL);const DL=t("Overflow",{NONE:0,CLAMP:1,SHRINK:2,RESIZE_HEIGHT:3});se(DL);const AL=t("CacheMode",{NONE:0,BITMAP:1,CHAR:2});se(AL);let ML=t("Label",($O=oa("cc.Label"),qO=ha(110),XO=Ga(IL),YO=Ga(EL),QO=Ga(DL),KO=Ga(TB),ZO=Ga(AL),$O(JO=qO((CL=class t extends VO{get string(){return this._string}set string(t){t=null==t?"":t.toString(),this._string!==t&&(this._string=t,this.markForUpdateRenderData())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.markForUpdateRenderData())}get verticalAlign(){return this._verticalAlign}set verticalAlign(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.markForUpdateRenderData())}get actualFontSize(){return this._actualFontSize}set actualFontSize(t){this._actualFontSize=t}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this.markForUpdateRenderData())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.markForUpdateRenderData())}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this.markForUpdateRenderData())}get overflow(){return this._overflow}set overflow(t){this._overflow!==t&&(this._overflow=t,this.markForUpdateRenderData())}get enableWrapText(){return this._enableWrapText}set enableWrapText(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.markForUpdateRenderData())}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.markForUpdateRenderData())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this.markForUpdateRenderData())}get font(){return this._font}set font(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this.destroyRenderData(),this._fontAtlas=null,this.updateRenderData(!0))}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(1!==this._cacheMode||this._font instanceof CR||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),2===this._cacheMode&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}get isBold(){return this._isBold}set isBold(t){this._isBold!==t&&(this._isBold=t,this.markForUpdateRenderData())}get isItalic(){return this._isItalic}set isItalic(t){this._isItalic!==t&&(this._isItalic=t,this.markForUpdateRenderData())}get isUnderline(){return this._isUnderline}set isUnderline(t){this._isUnderline!==t&&(this._isUnderline=t,this.markForUpdateRenderData())}get underlineHeight(){return this._underlineHeight}set underlineHeight(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.markForUpdateRenderData())}get enableOutline(){return this._enableOutline}set enableOutline(t){this._enableOutline!==t&&(this._enableOutline=t,this.markForUpdateRenderData())}get outlineColor(){return this._outlineColor}set outlineColor(t){this._outlineColor!==t&&(this._outlineColor.set(t),this.markForUpdateRenderData())}get outlineWidth(){return this._outlineWidth}set outlineWidth(t){this._outlineWidth!==t&&(this._outlineWidth=t,this.markForUpdateRenderData())}get enableShadow(){return this._enableShadow}set enableShadow(t){this._enableShadow!==t&&(this._enableShadow=t,this.markForUpdateRenderData())}get shadowColor(){return this._shadowColor}set shadowColor(t){this._shadowColor!==t&&(this._shadowColor.set(t),this.markForUpdateRenderData())}get shadowOffset(){return this._shadowOffset}set shadowOffset(t){this._shadowOffset!==t&&(this._shadowOffset.set(t),this.markForUpdateRenderData())}get shadowBlur(){return this._shadowBlur}set shadowBlur(t){this._shadowBlur!==t&&(this._shadowBlur=t,this.markForUpdateRenderData())}get spriteFrame(){return this._texture}get ttfSpriteFrame(){return this._ttfSpriteFrame}get assemblerData(){return this._assemblerData}get fontAtlas(){return this._fontAtlas}set fontAtlas(t){this._fontAtlas=t}get _bmFontOriginalSize(){return this._font instanceof CR?this._font.fontSize:-1}get textStyle(){return this._textStyle}get textLayout(){return this._textLayout}get textRenderData(){return this._textRenderData}get textLayoutData(){return this._textLayoutData}get contentWidth(){return this._contentWidth}set contentWidth(t){this._contentWidth=t}constructor(){super(),this._string=eL&&eL(),this._horizontalAlign=iL&&iL(),this._verticalAlign=sL&&sL(),this._actualFontSize=rL&&rL(),this._fontSize=nL&&nL(),this._fontFamily=oL&&oL(),this._lineHeight=aL&&aL(),this._overflow=hL&&hL(),this._enableWrapText=lL&&lL(),this._font=cL&&cL(),this._isSystemFontUsed=uL&&uL(),this._spacingX=dL&&dL(),this._isItalic=pL&&pL(),this._isBold=_L&&_L(),this._isUnderline=gL&&gL(),this._underlineHeight=fL&&fL(),this._cacheMode=mL&&mL(),this._enableOutline=yL&&yL(),this._outlineColor=vL&&vL(),this._outlineWidth=bL&&bL(),this._enableShadow=wL&&wL(),this._shadowColor=SL&&SL(),this._shadowOffset=xL&&xL(),this._shadowBlur=TL&&TL(),this._N$file=null,this._texture=null,this._ttfSpriteFrame=null,this._userDefinedFont=null,this._assemblerData=null,this._fontAtlas=null,this._letterTexture=null,this._contentWidth=0,this._textStyle=null,this._textLayout=null,this._textRenderData=null,this._textLayoutData=null,this._ttfSpriteFrame=null,this._textStyle=new HO,this._textLayout=new GO,this._textLayoutData=new WO,this._textRenderData=new jO}onEnable(){super.onEnable(),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()}destroyTtfSpriteFrame(){if(!this._ttfSpriteFrame)return;this._ttfSpriteFrame._resetDynamicAtlasFrame();const t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){const e=t;e.image&&e.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}_onPreDestroy(){super._onPreDestroy(),this._isOnLoadCalled||this.destroyTtfSpriteFrame()}onDestroy(){this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this.destroyTtfSpriteFrame(),this._letterTexture=null,super.onDestroy()}updateRenderData(t){void 0===t&&(t=!1),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture()),this._assembler&&this._assembler.updateRenderData(this)}_render(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)}_updateColor(){super._updateColor(),this.markForUpdateRenderData()}setEntityColor(t){}_canRender(){if(!super._canRender()||!this._string)return!1;const t=this._font;if(t&&t instanceof CR){const e=t.spriteFrame;if(!e||!e.texture)return!1}return!0}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e,this.textStyle.reset(),this.textLayout.reset(),this.textLayoutData.reset(),this.textRenderData.reset()),this.renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.renderData.material=this.material,this._updateColor())}_applyFontTexture(){this.markForUpdateRenderData();const t=this._font;if(t instanceof CR){const e=t.spriteFrame;e&&e.texture&&(this._texture=e,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(2===this.cacheMode)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new yB,this._assemblerData=this._assembler.getAssemblerData();const t=new j_(this._assemblerData.canvas),e=new qf;e.image=t,this._ttfSpriteFrame.texture=e}2!==this.cacheMode&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}}changeMaterialForDefine(){if(!this._texture)return;let t=!1;if(2!==this.cacheMode){const e=this._texture.texture;if(e instanceof rg){const i=e.getPixelFormat();t=1026===i||1025===i||1024===i}}this._instanceMaterialType=t?3:1,this.updateMaterial()}_updateBlendFunc(){super._updateBlendFunc()}},CL.HorizontalAlign=IL,CL.VerticalAlign=EL,CL.Overflow=DL,CL.CacheMode=AL,CL._canvasPool=AR.getInstance(),s((tL=CL).prototype,"horizontalAlign",[XO],Object.getOwnPropertyDescriptor(tL.prototype,"horizontalAlign"),tL.prototype),s(tL.prototype,"verticalAlign",[YO],Object.getOwnPropertyDescriptor(tL.prototype,"verticalAlign"),tL.prototype),s(tL.prototype,"overflow",[QO],Object.getOwnPropertyDescriptor(tL.prototype,"overflow"),tL.prototype),s(tL.prototype,"font",[KO],Object.getOwnPropertyDescriptor(tL.prototype,"font"),tL.prototype),s(tL.prototype,"cacheMode",[ZO],Object.getOwnPropertyDescriptor(tL.prototype,"cacheMode"),tL.prototype),eL=Qo(tL.prototype,"_string",[va],(function(){return"label"})),iL=Qo(tL.prototype,"_horizontalAlign",[va],(function(){return 1})),sL=Qo(tL.prototype,"_verticalAlign",[va],(function(){return 1})),rL=Qo(tL.prototype,"_actualFontSize",[va],(function(){return 0})),nL=Qo(tL.prototype,"_fontSize",[va],(function(){return 40})),oL=Qo(tL.prototype,"_fontFamily",[va],(function(){return"Arial"})),aL=Qo(tL.prototype,"_lineHeight",[va],(function(){return 40})),hL=Qo(tL.prototype,"_overflow",[va],(function(){return 0})),lL=Qo(tL.prototype,"_enableWrapText",[va],(function(){return!0})),cL=Qo(tL.prototype,"_font",[va],(function(){return null})),uL=Qo(tL.prototype,"_isSystemFontUsed",[va],(function(){return!0})),dL=Qo(tL.prototype,"_spacingX",[va],(function(){return 0})),pL=Qo(tL.prototype,"_isItalic",[va],(function(){return!1})),_L=Qo(tL.prototype,"_isBold",[va],(function(){return!1})),gL=Qo(tL.prototype,"_isUnderline",[va],(function(){return!1})),fL=Qo(tL.prototype,"_underlineHeight",[va],(function(){return 2})),mL=Qo(tL.prototype,"_cacheMode",[va],(function(){return 0})),yL=Qo(tL.prototype,"_enableOutline",[va],(function(){return!1})),vL=Qo(tL.prototype,"_outlineColor",[va],(function(){return new _r(0,0,0,255)})),bL=Qo(tL.prototype,"_outlineWidth",[va],(function(){return 2})),wL=Qo(tL.prototype,"_enableShadow",[va],(function(){return!1})),SL=Qo(tL.prototype,"_shadowColor",[va],(function(){return new _r(0,0,0,255)})),xL=Qo(tL.prototype,"_shadowOffset",[va],(function(){return new Qs(2,2)})),TL=Qo(tL.prototype,"_shadowBlur",[va],(function(){return 2})),JO=tL))||JO)||JO));h.Label=ML;let PL=0;const BL={};var RL={addStage(t){if(void 0!==BL[t])return;const e=1<<PL;BL[t]=e,PL+=1},stageID(t){const e=BL[t];return void 0===e?-1:e},stageIDs(t){let e=0;for(const i of t){const t=BL[i];void 0!==t&&(e|=t)}return e}};function OL(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function LL(t,e){return Math.ceil(t/e)*e}class FL{constructor(t){this._format=0,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new bd,this._region1=new bd,this._region2=new bd,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}initialize(t){const e=mp[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=Ip(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)}destroy(){for(let t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0}alloc(t,e){t=LL(t,this._alignment);let i=-1,s=-1;if(void 0!==e&&(i=e,s=this._findAvailableSpace(t,i)),s<0)for(let e=0;e<this._chunkCount&&(i=e,s=this._findAvailableSpace(t,i),!(s>=0));++e);if(s>=0){const e=this._chunks[i];e.start+=t;const r={chunkIdx:i,start:s,end:s+t,texture:e.texture};return this._handles.push(r),r}const r=Math.sqrt(t/this._formatSize),n=this._roundUpFn&&this._roundUpFn(r,this._formatSize)||Math.max(1024,OL(r)),o=this._chunks[this.createChunk(n)];o.start+=t;const a={chunkIdx:this._chunkCount-1,start:0,end:t,texture:o.texture};return this._handles.push(a),a}free(t){for(let e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)}createChunk(t){const e=t*t*this._formatSize;O(`TextureBufferPool: Allocate chunk ${this._chunkCount}, size: ${e}, format: ${this._format}`);const i={texture:this._device.createTexture(new Bd(1,6,this._format,t,t)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=i,this._chunkCount++}update(t,e){const i=[],s=[],r=t.start/this._formatSize;let n=e.byteLength/this._formatSize,o=r%t.texture.width,a=Math.floor(r/t.texture.width),h=Math.min(t.texture.width-o,n),l=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=a,this._region0.texExtent.width=h,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(e,l*this._formatSize,h*this._channels)),s.push(this._region0),o=0,a+=1,n-=h,l+=h),n>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=a,n>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(n/t.texture.width),h=this._region1.texExtent.width*this._region1.texExtent.height):(h=n,this._region1.texExtent.width=h,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(e,l*this._formatSize,h*this._channels)),s.push(this._region1),o=0,a+=this._region1.texExtent.height,n-=h,l+=h),n>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=a,this._region2.texExtent.width=n,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(e,l*this._formatSize,n*this._channels)),s.push(this._region2)),this._device.copyBuffersToTexture(i,t.texture,s)}_findAvailableSpace(t,e){const i=this._chunks[e];let s=!1,r=i.start;if(r+t<=i.size)s=!0;else{r=0;const n=this._handles.filter((t=>t.chunkIdx===e)).sort(((t,e)=>t.start-e.start));for(let e=0;e<n.length;e++){const i=n[e];if(r+t<=i.start){s=!0;break}r=i.end}!s&&r+t<=i.size&&(s=!0)}return s?r:-1}_McDonaldAlloc(t){t=LL(t,this._alignment);for(let e=0;e<this._chunkCount;++e){const i=this._chunks[e];let s=!1,r=i.start;if(r+t<=i.end?s=!0:r>i.end?r+t<=i.size?s=!0:t<=i.end&&(i.start=r=0,s=!0):r===i.end&&(i.start=r=0,i.end=i.size,t<=i.end&&(s=!0)),s){i.start+=t;const s={chunkIdx:e,start:r,end:r+t,texture:i.texture};return this._handles.push(s),s}}const e=Math.sqrt(t/this._formatSize),i=this._roundUpFn&&this._roundUpFn(e,this._formatSize)||Math.max(1024,OL(e)),s=this._chunks[this.createChunk(i)];s.start+=t;const r={chunkIdx:this._chunkCount,start:0,end:t,texture:s.texture};return this._handles.push(r),r}}class zL{constructor(t,e,i){this._arrayBuffers=[],this._chunkSize=i*(1<<e)}allocateNewChunk(){return new ArrayBuffer(this._chunkSize)}}class kL{constructor(t,e,i,s,r){void 0===r&&(r=8),this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._elementCount=s.COUNT,this._entryBits=r,this._dataType=e,this._dataMembers=i,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new zL(t,r,this._stride);let n=2,o=!1,a=!1;for(const t in e){if(o=this._hasFloat32,a=this._hasUint32,a&&o)break;n=e[t],o||1!==n?a||0!==n||(this._hasUint32=!0):this._hasFloat32=!0}}alloc(){let t=0;for(;t<this._freeLists.length;t++){const e=this._freeLists[t];if(e.length){const i=e[e.length-1];return e.length--,(t<<this._entryBits)+i+this._poolFlag}}const e=this._nativePool.allocateNewChunk(),i=[],s=[],r=[],n=this._hasFloat32,o=this._hasUint32;for(let t=0;t<this._entriesPerChunk;t++)n&&i.push(new Float32Array(e,this._stride*t,this._elementCount)),o&&s.push(new Uint32Array(e,this._stride*t,this._elementCount)),t&&r.push(t);return o&&this._uint32BufferViews.push(s),n&&this._float32BufferViews.push(i),this._freeLists.push(r),this._arrayBuffers.push(e),(t<<this._entryBits)+this._poolFlag}getBuffer(t){const e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][i]}getTypedArray(t,e){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t,r=e,n=(0===this._dataType[e]?this._uint32BufferViews:this._float32BufferViews)[i][s],o=this._dataMembers[e];return n.subarray(r,r+o)}free(t){const e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][i].fill(0),this._freeLists[e].push(i)}}const NL={POSITION:0,UV:3,COLOR:5,COUNT:9},UL=new kL(3,{0:1,3:1,5:0,9:2},{0:3,3:2,5:4,9:1},NL),VL={DIRTY_FLAG:0,LAYER:1,WORLD_SCALE:2,WORLD_POSITION:5,WORLD_ROTATION:8,WORLD_MATRIX:12,LOCAL_SCALE:28,LOCAL_POSITION:31,LOCAL_ROTATION:34,COUNT:38},HL=new kL(0,{0:0,1:0,2:1,5:1,8:1,12:1,28:1,31:1,34:1,38:2},{0:1,1:1,2:3,5:3,8:4,12:16,28:3,31:3,34:4,38:1},VL),GL={PRIORITY:0,STAGE:1,PHASE:2,PRIMITIVE:3,BATCHING_SCHEME:4,DYNAMIC_STATE:5,HASH:6,COUNT:7},WL=new kL(1,{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:2},{0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1},GL),jL={CENTER:0,HALFEXTENTS:3,COUNT:6},$L=new kL(2,{0:1,3:1,6:2},{0:3,3:3,6:1},jL),qL=RL.addStage;var XL=Object.freeze({__proto__:null,AABBPool:$L,AABBView:jL,BatchingSchemes:{NONE:0,INSTANCING:1},MaterialInstance:Gw,NULL_HANDLE:0,NodePool:HL,NodeView:VL,Pass:vw,PassInstance:Hw,PassPool:WL,PassStage:{DEFAULT:1,FORWARD:2,SHADOWCAST:4},PassView:GL,PoolType:{NODE:0,PASS:1,AABB:2,RENDER2D:3},Render2dPool:UL,Render2dView:NL,RenderQueue:{OPAQUE:0,TRANSPARENT:1,OVERLAY:2},RenderScene:KA,RenderWindow:iM,TextureBufferPool:FL,addStage:qL,createIA:function(t,e){if(!e.positions)return j(16306),null;const i=[],s=e.positions.length/3;for(let t=0;t<s;++t)i.push(e.positions[3*t],e.positions[3*t+1],e.positions[3*t+2]),e.normals&&i.push(e.normals[3*t],e.normals[3*t+1],e.normals[3*t+2]),e.uvs&&i.push(e.uvs[2*t],e.uvs[2*t+1]),e.colors&&i.push(e.colors[3*t],e.colors[3*t+1],e.colors[3*t+2]);const r=[];r.push(new Wd("a_position",32)),e.normals&&r.push(new Wd("a_normal",32)),e.uvs&&r.push(new Wd("a_texCoord",21)),e.colors&&r.push(new Wd("a_color",32));const n=t.createBuffer(new Ed(10,1,4*i.length,4*i.length/s));n.update(new Float32Array(i));let o=null;return e.indices&&(o=t.createBuffer(new Ed(6,1,2*e.indices.length,2)),o.update(new Uint16Array(e.indices))),t.createInputAssembler(new $d(r,[n],o))},customizeType:Zy,genHandle:qy,getBindingFromHandle:Yy,getCountFromHandle:Qy,getDefaultFromType:sv,getDeviceShaderVersion:Sv,getOffsetFromHandle:Ky,getStringFromType:rv,getTypeFromHandle:Xy,nearestPOT:OL,overrideMacros:nv,programLib:xv,scene:QA,type2reader:Jy,type2validator:ev,type2writer:tv});t("renderer",XL);const YL={BUTT:0,ROUND:1,SQUARE:2};se(YL);const QL={BEVEL:0,ROUND:1,MITER:2};se(QL),se({PT_CORNER:1,PT_LEFT:2,PT_BEVEL:4,PT_INNERBEVEL:8});const KL=Math.PI,ZL=Math.min,JL=Math.max,tF=Math.cos,eF=Math.sin,iF=Math.abs,sF=Math.sign,rF=.5522847493;function nF(t,e,i,s,r,n,o){let a=0,h=0,l=0,c=0,u=0,d=0,p=0,_=0,g=0,f=0,m=0,y=0,v=0,b=0,w=0,S=0;if(h=n-r,o=o||!1)if(iF(h)>=2*KL)h=2*KL;else for(;h<0;)h+=2*KL;else if(iF(h)>=2*KL)h=2*-KL;else for(;h>0;)h-=2*KL;for(S=0|JL(1,ZL(iF(h)/(.5*KL)+.5,5)),l=h/S/2,c=iF(4/3*(1-tF(l))/eF(l)),o||(c=-c),w=0;w<=S;w++)a=r+h*(w/S),u=tF(a),d=eF(a),p=e+u*s,_=i+d*s,g=-d*s*c,f=u*s*c,0===w?t.moveTo(p,_):t.bezierCurveTo(m+v,y+b,p-g,_-f,p,_),m=p,y=_,v=g,b=f}function oF(t,e,i,s,r){t.moveTo(e-s,i),t.bezierCurveTo(e-s,i+r*rF,e-s*rF,i+r,e,i+r),t.bezierCurveTo(e+s*rF,i+r,e+s,i+r*rF,e+s,i),t.bezierCurveTo(e+s,i-r*rF,e+s*rF,i-r,e,i-r),t.bezierCurveTo(e-s*rF,i-r,e-s,i-r*rF,e-s,i),t.close()}function aF(t,e,i,s,r,n){if(n<.1)t.rect(e,i,s,r);else{const o=ZL(n,.5*iF(s))*sF(s),a=ZL(n,.5*iF(r))*sF(r);t.moveTo(e,i+a),t.lineTo(e,i+r-a),t.bezierCurveTo(e,i+r-a*(1-rF),e+o*(1-rF),i+r,e+o,i+r),t.lineTo(e+s-o,i+r),t.bezierCurveTo(e+s-o*(1-rF),i+r,e+s,i+r-a*(1-rF),e+s,i+r-a),t.lineTo(e+s,i+a),t.bezierCurveTo(e+s,i+a*(1-rF),e+s-o*(1-rF),i,e+s-o,i),t.lineTo(e+o,i),t.bezierCurveTo(e+o*(1-rF),i,e,i+a*(1-rF),e,i+a),t.close()}}function hF(t,e,i,s,r,n,o,a,h,l,c){let u=0,d=0,p=0,_=0,g=0,f=0,m=0,y=0,v=0,b=0,w=0,S=0,x=0,T=0,C=0,I=0;l>10||(u=.5*(e+s),d=.5*(i+r),p=.5*(s+n),_=.5*(r+o),g=.5*(n+a),f=.5*(o+h),m=.5*(u+p),y=.5*(d+_),x=a-e,T=h-i,C=iF((s-a)*T-(r-h)*x),I=iF((n-a)*T-(o-h)*x),(C+I)*(C+I)<t.tessTol*(x*x+T*T)?t.addPoint(a,h,0===c?4|c:c):(v=.5*(p+g),b=.5*(_+f),w=.5*(m+v),S=.5*(y+b),hF(t,e,i,u,d,m,y,w,S,l+1,0),hF(t,w,S,v,b,g,f,a,h,l+1,c)))}class lF extends Qs{constructor(t,e){super(t,e),this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}reset(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}class cF{constructor(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[]}reset(){this.closed=!1,this.bevel=0,this.complex=!0,this.points.length=0}}class uF{constructor(t){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=_r.WHITE.clone(),this.lineCap=0,this.strokeColor=_r.BLACK.clone(),this.lineJoin=2,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null,this._comp=t}moveTo(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,1),this._commandX=t,this._commandY=e}lineTo(t,e){this.addPoint(t,e,1),this._commandX=t,this._commandY=e}bezierCurveTo(t,e,i,s,r,n){const o=this._curPath,a=o.points[o.points.length-1];a&&(a.x!==t||a.y!==e||i!==r||s!==n?(hF(this,a.x,a.y,t,e,i,s,r,n,0,1),this._commandX=r,this._commandY=n):this.lineTo(r,n))}quadraticCurveTo(t,e,i,s){const r=this._commandX,n=this._commandY;this.bezierCurveTo(r+2/3*(t-r),n+2/3*(e-n),i+2/3*(t-i),s+2/3*(e-s),i,s)}arc(t,e,i,s,r,n){nF(this,t,e,i,s,r,n)}ellipse(t,e,i,s){oF(this,t,e,i,s),this._curPath.complex=!1}circle(t,e,i){oF(this,t,e,i,i),this._curPath.complex=!1}rect(t,e,i,s){this.moveTo(t,e),this.lineTo(t+i,e),this.lineTo(t+i,e+s),this.lineTo(t,e+s),this.close(),this._curPath.complex=!1}roundRect(t,e,i,s,r){aF(this,t,e,i,s,r),this._curPath.complex=!1}clear(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;const t=this._renderDataList;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&(JR.remove(i),i.removeRenderDrawInfo(this._comp))}this._renderDataList.length=0}close(){this._curPath.closed=!0}requestRenderData(){const t=JR.add();return this._renderDataList.push(t),t}getRenderDataList(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}addPoint(t,e,i){const s=this._curPath;if(!s)return;const r=this._points,n=s.points;let o=r[this.pointsOffset++];o?(o.x=t,o.y=e):(o=new lF(t,e),r.push(o)),o.flags=i,n.push(o)}_addPath(){const t=this.pathLength;let e=this.paths[t];return e?e.reset():(e=new cF,this.paths.push(e)),this.pathLength++,this._curPath=e,e}}var dF,pF,_F,gF,fF,mF,yF,vF,bF,wF,SF,xF,TF;const CF=NR.concat([new Wd("a_dist",11)]),IF=function(t){let e=0;for(let i=0;i<t.length;i++){const s=t[i];e+=mp[s.format].count}return e}(CF),EF=WR(CF);let DF=t("Graphics",(dF=oa("cc.Graphics"),pF=ha(110),_F=Ga(QL),gF=Ga(YL),dF(fF=pF((TF=class t extends VO{get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}get lineCap(){return this._lineCap}set lineCap(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}get strokeColor(){return this._strokeColor}set strokeColor(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}get fillColor(){return this._fillColor}set fillColor(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit=t}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get graphicsNativeProxy(){return this._graphicsNativeProxy}constructor(){super(),this.impl=null,this.model=null,this._lineWidth=yF&&yF(),this._strokeColor=vF&&vF(),this._lineJoin=bF&&bF(),this._lineCap=wF&&wF(),this._fillColor=SF&&SF(),this._miterLimit=xF&&xF(),this._isDrawing=!1,this._isNeedUploadData=!0,this._graphicsUseSubMeshes=[],this._instanceMaterialType=0,this.impl=new uF(this)}onRestore(){this.impl||this._flushAssembler()}onLoad(){super.onLoad(),this.model=uP.root.createModel(CA),this.model.node=this.model.transform=this.node,this._flushAssembler()}onEnable(){super.onEnable(),this._updateMtlForGraphics()}onDestroy(){this._sceneGetter=null;{this.model&&(uP.root.destroyModel(this.model),this.model=null);const t=this._graphicsUseSubMeshes.length;if(t>0){for(let e=0;e<t;++e)this._graphicsUseSubMeshes[e].destroy();this._graphicsUseSubMeshes.length=0}}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),super.onDestroy()}moveTo(t,e){this.impl&&this.impl.moveTo(t,e)}lineTo(t,e){this.impl&&this.impl.lineTo(t,e)}bezierCurveTo(t,e,i,s,r,n){this.impl&&this.impl.bezierCurveTo(t,e,i,s,r,n)}quadraticCurveTo(t,e,i,s){this.impl&&this.impl.quadraticCurveTo(t,e,i,s)}arc(t,e,i,s,r,n){this.impl&&this.impl.arc(t,e,i,s,r,n)}ellipse(t,e,i,s){this.impl&&this.impl.ellipse(t,e,i,s)}circle(t,e,i){this.impl&&this.impl.circle(t,e,i)}rect(t,e,i,s){this.impl&&this.impl.rect(t,e,i,s)}roundRect(t,e,i,s,r){this.impl&&this.impl.roundRect(t,e,i,s,r)}fillRect(t,e,i,s){this.rect(t,e,i,s),this.fill()}clear(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(let t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}}close(){this.impl&&this.impl.close()}stroke(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)}fill(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)}_updateMtlForGraphics(){let t;this._customMaterial?t=this.getMaterialInstance(0):(t=pw.get("ui-graphics-material"),this.setSharedMaterial(t,0),t=this.getMaterialInstance(0),t.recompileShaders({USE_LOCAL:!0}))}activeSubModel(t){if(this.model){if(this.model.subModels.length<=t){const e=e_.gfxDevice,i=e.createBuffer(new Ed(10,1,65535*EF,EF)),s=e.createBuffer(new Ed(6,1,262140,2)),r=new _S([i],CF,7,s);r.subMeshIdx=0,this.model.initSubModel(t,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else G(4500,this.node.name)}_uploadData(){const t=this.impl;if(!t)return;const e=t&&t.getRenderDataList();if(e.length<=0||!this.model)return;const i=this.model.subModels;for(let t=0;t<e.length;t++){const s=e[t],r=i[t].inputAssembler;if(s.lastFilledVertex===s.vertexStart)continue;const n=new Float32Array(s.vData.buffer,0,s.vertexStart*IF);r.vertexBuffers[0].update(n),r.vertexCount=s.vertexStart;const o=new Uint16Array(s.iData.buffer,0,s.indexStart);r.indexBuffer.update(o),r.indexCount=s.indexStart,s.lastFilledVertex=s.vertexStart,s.lastFilledIndex=s.indexStart}this._isNeedUploadData=!1}_render(t){if(this._isNeedUploadData){if(this.impl){const t=this.impl.getRenderDataList(),e=this.model.subModels.length;if(t.length>e)for(let i=e;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}t.commitModel(this,this.model,this.getMaterialInstance(0))}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}_canRender(){return!!super._canRender()&&!!this.model&&this._isDrawing}updateRenderer(){super.updateRenderer()}createRenderEntity(){return new DO(1)}},TF.LineJoin=QL,TF.LineCap=YL,s((mF=TF).prototype,"lineJoin",[_F],Object.getOwnPropertyDescriptor(mF.prototype,"lineJoin"),mF.prototype),s(mF.prototype,"lineCap",[gF],Object.getOwnPropertyDescriptor(mF.prototype,"lineCap"),mF.prototype),s(mF.prototype,"color",[Wa],Object.getOwnPropertyDescriptor(mF.prototype,"color"),mF.prototype),yF=Qo(mF.prototype,"_lineWidth",[va],(function(){return 1})),vF=Qo(mF.prototype,"_strokeColor",[va],(function(){return _r.BLACK.clone()})),bF=Qo(mF.prototype,"_lineJoin",[va],(function(){return 2})),wF=Qo(mF.prototype,"_lineCap",[va],(function(){return 0})),SF=Qo(mF.prototype,"_fillColor",[va],(function(){return _r.WHITE.clone()})),xF=Qo(mF.prototype,"_miterLimit",[va],(function(){return 10})),fF=mF))||fF)||fF));var AF,MF,PF,BF,RF,OF,LF,FF,zF,kF,NF,UF,VF,HF,GF,WF,jF,$F,qF,XF;h.Graphics=DF;const YF={SIMPLE:0,SLICED:1,TILED:2,FILLED:3};se(YF);const QF={HORIZONTAL:0,VERTICAL:1,RADIAL:2};se(QF);const KF={CUSTOM:0,TRIMMED:1,RAW:2};se(KF);let ZF=t("Sprite",(AF=oa("cc.Sprite"),MF=ha(110),PF=Ga(SB),BF=Ga(yB),RF=Ga(YF),OF=Ga(QF),LF=Ga(KF),AF(FF=MF((XF=class t extends VO{constructor(){super(),this._spriteFrame=kF&&kF(),this._type=NF&&NF(),this._fillType=UF&&UF(),this._sizeMode=VF&&VF(),this._fillCenter=HF&&HF(),this._fillStart=GF&&GF(),this._fillRange=WF&&WF(),this._isTrimmedMode=jF&&jF(),this._useGrayscale=$F&&$F(),this._atlas=qF&&qF()}get spriteAtlas(){return this._atlas}set spriteAtlas(t){this._atlas!==t&&(this._atlas=t)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(),this._applySpriteFrame(e)}get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this._flushAssembler())}get fillType(){return this._fillType}set fillType(t){this._fillType!==t&&(2===t||2===this._fillType?this.destroyRenderData():this.renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}get fillCenter(){return this._fillCenter}set fillCenter(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,3===this._type&&this.renderData&&this.markForUpdateRenderData()}get fillStart(){return this._fillStart}set fillStart(t){this._fillStart=fi(t,0,1),3===this._type&&this.renderData&&(this.markForUpdateRenderData(),this._updateUVs())}get fillRange(){return this._fillRange}set fillRange(t){this._fillRange=fi(t,-1,1),3===this._type&&this.renderData&&(this.markForUpdateRenderData(),this._updateUVs())}get trim(){return this._isTrimmedMode}set trim(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,0===this._type&&this.renderData&&this.markForUpdateRenderData(!0))}get grayscale(){return this._useGrayscale}set grayscale(t){this._useGrayscale!==t&&(this._useGrayscale=t,this.changeMaterialForDefine(),this.updateMaterial())}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,0!==t&&this._applySpriteSize())}__preload(){this.changeMaterialForDefine(),super.__preload()}onEnable(){super.onEnable(),this._activateMaterial();const t=this._spriteFrame;t&&(this._updateUVs(),1===this._type&&t.on("uv_updated",this._updateUVs,this))}onDisable(){super.onDisable(),this._spriteFrame&&1===this._type&&this._spriteFrame.off("uv_updated",this._updateUVs,this)}onDestroy(){super.onDestroy()}changeSpriteFrameFromAtlas(t){if(!this._atlas)return void G(16377);const e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}changeMaterialForDefine(){let t;const e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);let i=!1;if(t instanceof rg){const e=t.getPixelFormat();i=1026===e||1025===e||1024===e}i&&this.grayscale?this._instanceMaterialType=4:i?this._instanceMaterialType=3:this.grayscale?this._instanceMaterialType=2:this._instanceMaterialType=1,e!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let t=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof aS){const e=new Lw;e.copy(t,{defines:{SAMPLE_FROM_RT:!0}}),t=e}return t}_render(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const t=this._spriteFrame;return!(!t||!t.texture)}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(1===this._type?this._spriteFrame.on("uv_updated",this._updateUVs,this):this._spriteFrame.off("uv_updated",this._updateUVs,this))}_applySpriteSize(){if(this._spriteFrame)if(2===this._sizeMode){const t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(1===this._sizeMode){const t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}}_resized(){}_activateMaterial(){const t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this.renderData&&(this.renderData.material=e)}_updateUVs(){this._assembler&&this._assembler.updateUVs(this)}_applySpriteFrame(t){const e=this._spriteFrame;t&&1===this._type&&t.off("uv_updated",this._updateUVs,this);let i=!1;e&&(t&&t.texture===e.texture||(i=!0),i&&(this.renderData&&(this.renderData.textureDirty=!0),(!!t&&t.texture instanceof aS)!=e.texture instanceof aS&&(this._instanceMaterialType=-1),this.changeMaterialForDefine()),this._applySpriteSize(),1===this._type&&e.on("uv_updated",this._updateUVs,this))}_applyAtlas(t){}},XF.FillType=QF,XF.Type=YF,XF.SizeMode=KF,XF.EventType={SPRITE_FRAME_CHANGED:"spriteframe-changed"},s((zF=XF).prototype,"spriteAtlas",[PF],Object.getOwnPropertyDescriptor(zF.prototype,"spriteAtlas"),zF.prototype),s(zF.prototype,"spriteFrame",[BF],Object.getOwnPropertyDescriptor(zF.prototype,"spriteFrame"),zF.prototype),s(zF.prototype,"type",[RF],Object.getOwnPropertyDescriptor(zF.prototype,"type"),zF.prototype),s(zF.prototype,"fillType",[OF],Object.getOwnPropertyDescriptor(zF.prototype,"fillType"),zF.prototype),s(zF.prototype,"sizeMode",[LF],Object.getOwnPropertyDescriptor(zF.prototype,"sizeMode"),zF.prototype),kF=Qo(zF.prototype,"_spriteFrame",[va],(function(){return null})),NF=Qo(zF.prototype,"_type",[va],(function(){return 0})),UF=Qo(zF.prototype,"_fillType",[va],(function(){return 0})),VF=Qo(zF.prototype,"_sizeMode",[va],(function(){return 1})),HF=Qo(zF.prototype,"_fillCenter",[va],(function(){return new Qs(0,0)})),GF=Qo(zF.prototype,"_fillStart",[va],(function(){return 0})),WF=Qo(zF.prototype,"_fillRange",[va],(function(){return 0})),jF=Qo(zF.prototype,"_isTrimmedMode",[va],(function(){return!0})),$F=Qo(zF.prototype,"_useGrayscale",[va],(function(){return!1})),qF=Qo(zF.prototype,"_atlas",[va],(function(){return null})),FF=zF))||FF)||FF));var JF,tz,ez,iz,sz,rz,nz,oz,az,hz;h.Sprite=ZF;const lz=new Rs,cz=new Qs,uz=new Rs,dz=[];function pz(t,e,i){dz.length=0;const s=2*Math.PI/i;for(let r=0;r<i;++r)dz.push(new Ki(e.x*Math.cos(s*r)+t.x,e.y*Math.sin(s*r)+t.y,0));return dz}const _z={GRAPHICS_RECT:0,GRAPHICS_ELLIPSE:1,GRAPHICS_STENCIL:2,SPRITE_STENCIL:3};se(_z);let gz=t("Mask",(JF=oa("cc.Mask"),tz=ha(110),ez=Ga(_z),JF(iz=tz((hz=class extends Ag{constructor(){super(),this._type=rz&&rz(),this._inverted=nz&&nz(),this._segments=oz&&oz(),this._alphaThreshold=az&&az(),this._sprite=null,this._graphics=null,this._stencilStage=0}get type(){return this._type}set type(t){this._type!==t&&(this._type=t,3!==this._type?(this._sprite&&(this.node.removeComponent(ZF),this._sprite._destroyImmediate(),this._sprite=null),this._changeRenderType(),this._updateGraphics()):(this._graphics&&(this._graphics.clear(),this.node.removeComponent(DF),this._graphics._destroyImmediate(),this._graphics=null),this._changeRenderType()))}get inverted(){return this._inverted}set inverted(t){this._inverted=t,this.subComp.stencilStage=this.inverted?6:2}get segments(){return this._segments}set segments(t){this._segments!==t&&(this._segments=fi(t,3,1e4),this._updateGraphics())}get spriteFrame(){return this._sprite?this._sprite.spriteFrame:null}set spriteFrame(t){this._sprite?this._sprite.spriteFrame=t:j(16307)}get alphaThreshold(){return this._alphaThreshold}set alphaThreshold(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,3===this.type&&this._sprite)&&this._sprite.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold)}get subComp(){return this._graphics||this._sprite}onLoad(){this._changeRenderType()}onEnable(){this._changeRenderType(),this._updateGraphics(),this._enableRender(),this.node.on("anchor-changed",this._nodeStateChange,this),this.node.on("size-changed",this._nodeStateChange,this)}onRestore(){this._changeRenderType(),this._updateGraphics()}onDisable(){this._disableRender(),this.node.off("anchor-changed",this._nodeStateChange,this),this.node.off("size-changed",this._nodeStateChange,this)}onDestroy(){this._removeMaskNode()}isHit(t){const e=this.node._uiProps.uiTransformComp,i=e.contentSize,s=i.width,r=i.height,n=cz;this.node.getWorldMatrix(lz),Rs.invert(uz,lz),Qs.transformMat4(n,t,uz);const o=e.anchorPoint;n.x+=o.x*s,n.y+=o.y*r;let a=!1;if(0===this.type||2===this.type||3===this.type)a=n.x>=0&&n.y>=0&&n.x<=s&&n.y<=r;else if(1===this.type){const t=s/2,e=r/2,i=n.x-.5*s,o=n.y-.5*r;a=i*i/(t*t)+o*o/(e*e)<1}return this._inverted&&(a=!a),a}_nodeStateChange(t){this._updateGraphics()}_changeRenderType(){3!==this._type?this._createGraphics():this._createSprite()}_createSprite(){if(!this._sprite){let t=this._sprite=this.node.getComponent(ZF);if(!t){const e=this.node;t=this._sprite=e.addComponent(ZF)}}this._sprite.stencilStage=this.inverted?6:2,this._sprite.updateMaterial()}_createGraphics(){if(!this._graphics){let t=this._graphics=this.node.getComponent(DF);if(!t){const e=this.node;t=this._graphics=e.addComponent(DF)}t.lineWidth=1;const e=_r.WHITE.clone();e.a=0,t.fillColor=e}this._graphics.stencilStage=this.inverted?6:2}_updateGraphics(){if(!this._graphics||0!==this._type&&1!==this._type)return;const t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();const i=t.contentSize,s=i.width,r=i.height,n=t.anchorPoint,o=-s*n.x,a=-r*n.y;if(0===this._type)e.rect(o,a,s,r);else if(1===this._type){const t=pz(new Ki(o+s/2,a+r/2,0),new Ki(s/2,r/2,0),this._segments);for(let i=0;i<t.length;++i){const s=t[i];0===i?e.moveTo(s.x,s.y):e.lineTo(s.x,s.y)}e.close()}e.fill()}_enableRender(){this.subComp&&(this.subComp.enabled=!0)}_disableRender(){this.subComp&&(this.subComp.stencilStage=0,this.subComp.updateMaterial(),this.node.activeInHierarchy&&(this.subComp.enabled=!1))}_removeMaskNode(){this._sprite&&(this._sprite=null),this._graphics&&(this._graphics=null)}get customMaterial(){return G(9007),this.subComp?this.subComp.customMaterial:null}set customMaterial(t){G(9007),this.subComp&&(this.subComp.customMaterial=t)}get color(){return G(9007),this.subComp?this.subComp.color:null}set color(t){G(9007),this.subComp&&t&&(this.subComp.color=t)}markForUpdateRenderData(t){void 0===t&&(t=!0),G(9007),this.subComp&&this.subComp.markForUpdateRenderData(t)}requestRenderData(t){G(9007)}destroyRenderData(){G(9007)}updateRenderer(){G(9007),this.subComp&&this.subComp.updateRenderer()}fillBuffers(t){G(9007)}postUpdateAssembler(t){G(9007)}setNodeDirty(){G(9007),this.subComp&&this.subComp.setNodeDirty()}setTextureDirty(){G(9007),this.subComp&&this.subComp.setTextureDirty()}get sharedMaterial(){return G(9007),this.subComp?this.subComp.sharedMaterial:null}get sharedMaterials(){return G(9007),this.subComp?this.subComp.sharedMaterials:null}set sharedMaterials(t){G(9007),this.subComp&&t&&(this.subComp.sharedMaterials=t)}get material(){return G(9007),this.subComp?this.subComp.material:null}set material(t){G(9007),this.subComp&&(this.subComp.material=t)}get materials(){return G(9007),this.subComp?this.subComp.materials:[null]}set materials(t){G(9007),this.subComp&&(this.subComp.materials=t)}getMaterial(t){return G(9007),this.subComp?this.subComp.getSharedMaterial(t):null}setMaterial(t,e){G(9007),this.subComp&&this.subComp.setMaterial(t,e)}getMaterialInstance(t){return G(9007),this.subComp?this.subComp.getMaterialInstance(t):null}setMaterialInstance(t,e){G(9007),this.subComp&&this.subComp.setMaterialInstance(t,e)}getRenderMaterial(t){return G(9007),this.subComp?this.subComp.getRenderMaterial(t):null}},hz.Type=_z,s((sz=hz).prototype,"type",[ez],Object.getOwnPropertyDescriptor(sz.prototype,"type"),sz.prototype),rz=Qo(sz.prototype,"_type",[va],(function(){return 0})),nz=Qo(sz.prototype,"_inverted",[va],(function(){return!1})),oz=Qo(sz.prototype,"_segments",[va],(function(){return 64})),az=Qo(sz.prototype,"_alphaThreshold",[va],(function(){return.1})),iz=sz))||iz)||iz));var fz,mz,yz,vz,bz,wz;lM._maskComp=gz,h.Mask=gz;let Sz=oa("cc.PostProcess")(fz=la((wz=class t extends Ag{constructor(){super(),this.global=yz&&yz(),this._shadingScale=vz&&vz(),this.enableShadingScaleInEditor=bz&&bz(),this.settings=new Map}get shadingScale(){return this._shadingScale}set shadingScale(t){this._shadingScale=t}addSetting(t){this.settings.set(t.constructor,t)}removeSetting(t){this.settings.delete(t.constructor)}getSetting(t){return this.settings.get(t)}onEnable(){t.all.push(this)}onDisable(){const e=t.all.indexOf(this);-1!==e&&t.all.splice(e,1)}},wz.all=[],yz=Qo((mz=wz).prototype,"global",[ca,va],(function(){return!0})),vz=Qo(mz.prototype,"_shadingScale",[va],(function(){return 1})),s(mz.prototype,"shadingScale",[ca],Object.getOwnPropertyDescriptor(mz.prototype,"shadingScale"),mz.prototype),bz=Qo(mz.prototype,"enableShadingScaleInEditor",[ca,va],(function(){return!1})),fz=mz))||fz)||fz;var xz,Tz,Cz,Iz,Ez,Dz,Az,Mz,Pz,Bz,Rz,Oz,Lz,Fz,zz,kz,Nz,Uz,Vz,Hz,Gz,Wz,jz,$z,qz,Xz,Yz,Qz,Kz,Zz,Jz,tk,ek,ik,sk;const rk=new Ki,nk=te(iA),ok=te(eA),ak=te(sA),hk=te(nA),lk=te(rA),ck=te({SKYBOX:14,SOLID_COLOR:7,DEPTH_ONLY:6,DONT_CLEAR:0});let uk=t("Camera",(xz=oa("cc.Camera"),Tz=Ga(Kf.BitMask),Cz=Ga(ck),Iz=Ga(nk),Ez=Ga(ok),Dz=Ga(ak),Az=Ga(hk),Mz=Ga(lk),Pz=Ga(aS),Bz=Ga(Sz),xz((sk=class extends Ag{constructor(){super(),this._projection=Lz&&Lz(),this._priority=Fz&&Fz(),this._fov=zz&&zz(),this._fovAxis=kz&&kz(),this._orthoHeight=Nz&&Nz(),this._near=Uz&&Uz(),this._far=Vz&&Vz(),this._color=Hz&&Hz(),this._depth=Gz&&Gz(),this._stencil=Wz&&Wz(),this._clearFlags=jz&&jz(),this._rect=$z&&$z(),this._aperture=qz&&qz(),this._shutter=Xz&&Xz(),this._iso=Yz&&Yz(),this._screenScale=Qz&&Qz(),this._visibility=Kz&&Kz(),this._targetTexture=Zz&&Zz(),this._postProcess=Jz&&Jz(),this._usePostProcess=tk&&tk(),this._camera=null,this._inEditorMode=!1,this._flows=void 0,this._cameraType=ek&&ek(),this._trackingType=ik&&ik()}get camera(){return this._camera}get priority(){return this._priority}set priority(t){this._priority=t,this._camera&&(this._camera.priority=t)}get visibility(){return this._visibility}set visibility(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}get clearFlags(){return this._clearFlags}set clearFlags(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}get clearColor(){return this._color}set clearColor(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}get clearDepth(){return this._depth}set clearDepth(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}get clearStencil(){return this._stencil}set clearStencil(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}get projection(){return this._projection}set projection(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}get fovAxis(){return this._fovAxis}set fovAxis(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,this.fov=0===t?this._fov*this._camera.aspect:this._fov/this._camera.aspect))}get fov(){return this._fov}set fov(t){this._fov=t,this._camera&&(this._camera.fov=vi(t))}get orthoHeight(){return this._orthoHeight}set orthoHeight(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}get near(){return this._near}set near(t){this._near=t,this._camera&&(this._camera.nearClip=t)}get far(){return this._far}set far(t){this._far=t,this._camera&&(this._camera.farClip=t)}get aperture(){return this._aperture}set aperture(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}get shutter(){return this._shutter}set shutter(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}get iso(){return this._iso}set iso(t){this._iso=t,this._camera&&(this._camera.iso=t)}get rect(){return this._rect}set rect(t){this._rect=t,this._camera&&this._camera.setViewportInOrientedSpace(t)}get targetTexture(){return this._targetTexture}set targetTexture(t){if(this._targetTexture===t)return;const e=this._targetTexture;this._targetTexture=t,this._checkTargetTextureEvent(e),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit("tex-change",this)}get usePostProcess(){return this._usePostProcess}set usePostProcess(t){this._usePostProcess=t,this._camera&&(this._camera.usePostProcess=t)}get postProcess(){return this._postProcess}set postProcess(t){this._postProcess=t,this._camera&&(this._camera.postProcess=t)}get screenScale(){return this._screenScale}set screenScale(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}get inEditorMode(){return this._inEditorMode}set inEditorMode(t){if(this._inEditorMode=t,this._camera){const e=h.director.root;this._camera.changeTargetWindow(t?e&&e.mainWindow:e&&e.tempWindow)}}get cameraType(){return this._cameraType}set cameraType(t){this._cameraType!==t&&(this._cameraType=t,this.camera&&(this.camera.cameraType=t))}get trackingType(){return this._trackingType}set trackingType(t){this._trackingType!==t&&(this._trackingType=t,this.camera&&(this.camera.trackingType=t))}onLoad(){this._createCamera()}onEnable(){this.node.hasChangedFlags|=1,this._camera&&this._attachToScene()}onDisable(){this._camera&&this._detachFromScene()}onDestroy(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}screenPointToRay(t,e,i){return i||(i=qr.create()),this._camera&&this._camera.screenPointToRay(i,t,e),i}worldToScreen(t,e){return e||(e=new Ki),this._camera&&this._camera.worldToScreen(e,t),e}screenToWorld(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e}convertToUINode(t,e,i){if(i||(i=new Ki),!this._camera)return i;this.worldToScreen(t,rk);const s=e.getComponent("cc.UITransform"),r=h.view,n=r.getVisibleSize(),o=rk.x-.5*this._camera.width,a=rk.y-.5*this._camera.height;return rk.x=o/r.getScaleX()+.5*n.width,rk.y=a/r.getScaleY()+.5*n.height,s&&s.convertToNodeSpaceAR(rk,i),i}_createCamera(){this._camera||(this._camera=h.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?h.director.root&&h.director.root.mainWindow:h.director.root&&h.director.root.tempWindow,priority:this._priority,cameraType:this.cameraType,trackingType:this.trackingType}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=vi(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso,this._camera.postProcess=this._postProcess,this._camera.usePostProcess=this._usePostProcess),this._updateTargetTexture()}_attachToScene(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}_detachFromScene(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}_checkTargetTextureEvent(t){t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(t=>{this._camera&&this._camera.setFixedSize(t.width,t.height)}),this)}_updateTargetTexture(){if(this._camera&&this._targetTexture){const t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}}},sk.ProjectionType=nk,sk.FOVAxis=ok,sk.ClearFlag=ck,sk.Aperture=ak,sk.Shutter=hk,sk.ISO=lk,sk.TARGET_TEXTURE_CHANGE="tex-change",Lz=Qo((Oz=sk).prototype,"_projection",[va],(function(){return nk.PERSPECTIVE})),Fz=Qo(Oz.prototype,"_priority",[va],(function(){return 0})),zz=Qo(Oz.prototype,"_fov",[va],(function(){return 45})),kz=Qo(Oz.prototype,"_fovAxis",[va],(function(){return ok.VERTICAL})),Nz=Qo(Oz.prototype,"_orthoHeight",[va],(function(){return 10})),Uz=Qo(Oz.prototype,"_near",[va],(function(){return 1})),Vz=Qo(Oz.prototype,"_far",[va],(function(){return 1e3})),Hz=Qo(Oz.prototype,"_color",[va],(function(){return new _r("#333333")})),Gz=Qo(Oz.prototype,"_depth",[va],(function(){return 1})),Wz=Qo(Oz.prototype,"_stencil",[va],(function(){return 0})),jz=Qo(Oz.prototype,"_clearFlags",[va],(function(){return ck.SOLID_COLOR})),$z=Qo(Oz.prototype,"_rect",[va],(function(){return new Cr(0,0,1,1)})),qz=Qo(Oz.prototype,"_aperture",[va],(function(){return ak.F16_0})),Xz=Qo(Oz.prototype,"_shutter",[va],(function(){return hk.D125})),Yz=Qo(Oz.prototype,"_iso",[va],(function(){return lk.ISO100})),Qz=Qo(Oz.prototype,"_screenScale",[va],(function(){return 1})),Kz=Qo(Oz.prototype,"_visibility",[va],(function(){return Fy})),Zz=Qo(Oz.prototype,"_targetTexture",[va],(function(){return null})),Jz=Qo(Oz.prototype,"_postProcess",[va],(function(){return null})),tk=Qo(Oz.prototype,"_usePostProcess",[va],(function(){return!1})),ek=Qo(Oz.prototype,"_cameraType",[va],(function(){return-1})),ik=Qo(Oz.prototype,"_trackingType",[va],(function(){return 0})),s(Oz.prototype,"visibility",[Tz],Object.getOwnPropertyDescriptor(Oz.prototype,"visibility"),Oz.prototype),s(Oz.prototype,"clearFlags",[Cz],Object.getOwnPropertyDescriptor(Oz.prototype,"clearFlags"),Oz.prototype),s(Oz.prototype,"projection",[Iz],Object.getOwnPropertyDescriptor(Oz.prototype,"projection"),Oz.prototype),s(Oz.prototype,"fovAxis",[Ez],Object.getOwnPropertyDescriptor(Oz.prototype,"fovAxis"),Oz.prototype),s(Oz.prototype,"aperture",[Dz],Object.getOwnPropertyDescriptor(Oz.prototype,"aperture"),Oz.prototype),s(Oz.prototype,"shutter",[Az],Object.getOwnPropertyDescriptor(Oz.prototype,"shutter"),Oz.prototype),s(Oz.prototype,"iso",[Mz],Object.getOwnPropertyDescriptor(Oz.prototype,"iso"),Oz.prototype),s(Oz.prototype,"targetTexture",[Pz],Object.getOwnPropertyDescriptor(Oz.prototype,"targetTexture"),Oz.prototype),s(Oz.prototype,"usePostProcess",[ca],Object.getOwnPropertyDescriptor(Oz.prototype,"usePostProcess"),Oz.prototype),s(Oz.prototype,"postProcess",[Bz],Object.getOwnPropertyDescriptor(Oz.prototype,"postProcess"),Oz.prototype),Rz=Oz))||Rz));var dk;h.Camera=uk;let pk=t("RenderRoot2D",oa("cc.RenderRoot2D")(dk=ha(100)(dk=aa(pO)(dk=la(dk=class extends Ag{onEnable(){h.director.root.batcher2D.addScreen(this)}onDisable(){h.director.root.batcher2D.removeScreen(this)}onDestroy(){h.director.root.batcher2D.removeScreen(this)}})||dk)||dk)||dk)||dk);var _k,gk,fk,mk,yk,vk,bk,wk;const Sk=new Ki,xk=te({OVERLAY:0,INTERSPERSE:1});let Tk=t("Canvas",(_k=oa("cc.Canvas"),gk=ha(100),fk=Ga(uk),mk=Ga(uk),_k(yk=gk(yk=la((vk=class extends pk{get renderMode(){return this._renderMode}set renderMode(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}get cameraComponent(){return this._cameraComponent}set cameraComponent(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}get alignCanvasWithScreen(){return this._alignCanvasWithScreen}set alignCanvasWithScreen(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}constructor(){super(),this._cameraComponent=bk&&bk(),this._alignCanvasWithScreen=wk&&wk(),this._pos=new Ki,this._renderMode=xk.OVERLAY,this._thisOnCameraResized=this._onResizeCamera.bind(this)}__preload(){const t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on("tex-change",this._thisOnCameraResized)),this._onResizeCamera(),yP.on("canvas-resize",this._thisOnCameraResized,this),yP.on("design-resolution-changed",this._thisOnCameraResized,this)}onEnable(){super.onEnable(),this._cameraComponent&&this._cameraComponent.node.on("tex-change",this._thisOnCameraResized)}onDisable(){super.onDisable(),this._cameraComponent&&this._cameraComponent.node.off("tex-change",this._thisOnCameraResized)}onDestroy(){super.onDestroy(),yP.off("canvas-resize",this._thisOnCameraResized,this),yP.off("design-resolution-changed",this._thisOnCameraResized,this)}_onResizeCamera(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=Gn.height/2;else{const t=Vn.windowSize;this._cameraComponent.orthoHeight=t.height/yP.getScaleY()/2}this.node.getWorldPosition(Sk),this._cameraComponent.node.setWorldPosition(Sk.x,Sk.y,1e3)}}_getViewPriority(){if(this._cameraComponent){var t;let e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return e=this._renderMode===xk.OVERLAY?e|1<<30:e&~(1<<30),e}return 0}},s(vk.prototype,"cameraComponent",[fk],Object.getOwnPropertyDescriptor(vk.prototype,"cameraComponent"),vk.prototype),bk=Qo(vk.prototype,"_cameraComponent",[mk],(function(){return null})),wk=Qo(vk.prototype,"_alignCanvasWithScreen",[va],(function(){return!0})),yk=vk))||yk)||yk)||yk));var Ck;function Ik(t,e,i){const s=t.o,r=t.d,n=1/r.x,o=1/r.y,a=1/r.z,h=(e.x-s.x)*n,l=(i.x-s.x)*n,c=(e.y-s.y)*o,u=(i.y-s.y)*o,d=(e.z-s.z)*a,p=(i.z-s.z)*a,_=Math.max(Math.max(Math.min(h,l),Math.min(c,u)),Math.min(d,p)),g=Math.min(Math.min(Math.max(h,l),Math.max(c,u)),Math.max(d,p));return g<0||_>g?0:_>0?_:g}h.Canvas=Tk,t("UIComponent",oa("cc.UIComponent")(Ck=aa(pO)(Ck=ha(110)(Ck=la(Ck=class extends Ag{constructor(){super(),this._lastParent=null,this.stencilStage=0}__preload(){this.node._uiProps.uiComp=this}onEnable(){}onDisable(){}onDestroy(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}postUpdateAssembler(t){}markForUpdateRenderData(t){}setNodeDirty(){}setTextureDirty(){}})||Ck)||Ck)||Ck)||Ck);const Ek=function(){const t=Xr.create(),e={distance:1/0,doubleSided:!1,mode:2};let i=0;const s=(t,e,s,r,n,o)=>{1===t?(i>e||0===i)&&(i=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:s/3,vertexIndex1:r/3,vertexIndex2:n/3}):(o[0].distance=e,o[0].vertexIndex0=s/3,o[0].vertexIndex1=r/3,o[0].vertexIndex2=n/3))):(i=e,o&&o.push({distance:e,vertexIndex0:s/3,vertexIndex1:r/3,vertexIndex2:n/3}))},r=(e,r,n,o,a)=>{if(7===n){const i=r.length;for(let n=0;n<i;n+=3){const i=3*r[n],h=3*r[n+1],l=3*r[n+2];Ki.set(t.a,e[i],e[i+1],e[i+2]),Ki.set(t.b,e[h],e[h+1],e[h+2]),Ki.set(t.c,e[l],e[l+1],e[l+2]);const c=ko.rayTriangle(o,t,a.doubleSided);if(!(0===c||c>a.distance)&&(s(a.mode,c,i,h,l,a.result),2===a.mode))return c}}else if(8===n){const i=r.length-2;let n=0;for(let h=0;h<i;h+=1){const i=3*r[h-n],l=3*r[h+n+1],c=3*r[h+2];Ki.set(t.a,e[i],e[i+1],e[i+2]),Ki.set(t.b,e[l],e[l+1],e[l+2]),Ki.set(t.c,e[c],e[c+1],e[c+2]),n=~n;const u=ko.rayTriangle(o,t,a.doubleSided);if(!(0===u||u>a.distance)&&(s(a.mode,u,i,l,c,a.result),2===a.mode))return u}}else if(9===n){const i=r.length-1,n=3*r[0];Ki.set(t.a,e[n],e[n+1],e[n+2]);for(let h=1;h<i;h+=1){const i=3*r[h],l=3*r[h+1];Ki.set(t.b,e[i],e[i+1],e[i+2]),Ki.set(t.c,e[l],e[l+1],e[l+2]);const c=ko.rayTriangle(o,t,a.doubleSided);if(!(0===c||c>a.distance)&&(s(a.mode,c,n,i,l,a.result),2===a.mode))return c}}return i};return function(t,s,n){if(i=0,0===s.geometricInfo.positions.length)return i;const o=void 0===n?e:n;if(Ik(t,s.geometricInfo.boundingBox.min,s.geometricInfo.boundingBox.max)){const e=s.primitiveMode,{positions:i,indices:n}=s.geometricInfo;r(i,n,e,t,o)}return i}}(),Dk=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:2};return function(i,s,r){t=0;const n=void 0===r?e:r,o=s.renderingSubMeshes.length,a=s.struct.minPosition,h=s.struct.maxPosition;if(a&&h&&!Ik(i,a,h))return t;for(let e=0;e<o;e++){const r=s.renderingSubMeshes[e],o=Ek(i,r,n);if(o)if(1===n.mode)(0===t||t>o)&&(t=o,n.subIndices&&(n.subIndices[0]=e));else if(t=o,n.subIndices&&n.subIndices.push(e),2===n.mode)return o}return t&&1===n.mode&&(n.result&&(n.result[0].distance=t,n.result.length=1),n.subIndices&&(n.subIndices.length=1)),t}}(),Ak=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:2},i=new qr,s=new Rs;return function(r,n,o){t=0;const a=void 0===o?e:o,h=n.worldBounds;if(h&&!ko.rayAABB(r,h))return t;qr.copy(i,r),n.node&&(Rs.invert(s,n.node.getWorldMatrix(s)),Ki.transformMat4(i.o,r.o,s),Ki.transformMat4Normal(i.d,r.d,s));const l=n.subModels;for(let e=0;e<l.length;e++){const s=l[e].subMesh,r=Ek(i,s,a);if(r)if(1===a.mode)(0===t||t>r)&&(t=r,a.subIndices&&(a.subIndices[0]=e));else if(t=r,a.subIndices&&a.subIndices.push(e),2===a.mode)return r}return t&&1===a.mode&&(a.result&&(a.result[0].distance=t,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),t}}();var Mk,Pk,Bk;ko.rayModel=Ak,ko.raySubMesh=Ek,ko.rayMesh=Dk,_w("specular-pass");let Rk=t("ModelRenderer",oa("cc.ModelRenderer")((Pk=class extends EO{constructor(){super(),this._visFlags=Bk&&Bk(),this._models=[],this._priority=0}get visibility(){return this._visFlags}set visibility(t){this._visFlags=t,this._onVisibilityChange(t)}get priority(){return this._priority}set priority(t){t!==this._priority&&(this._priority=t,this._updatePriority())}_collectModels(){return this._models}onEnable(){this._updatePriority()}_attachToScene(){}_detachFromScene(){}_onVisibilityChange(t){}_updatePriority(){if(this._models.length>0)for(let t=0;t<this._models.length;t++)this._models[t].priority=this._priority}},Bk=Qo(Pk.prototype,"_visFlags",[va],(function(){return Kf.Enum.NONE})),Mk=Pk))||Mk);var Ok,Lk,Fk,zk,kk;const{ccclass:Nk,serializable:Uk,type:Vk,visible:Hk}=Ja;var Gk,Wk,jk,$k,qk,Xk,Yk,Qk,Kk,Zk,Jk,tN,eN,iN,sN,rN,nN,oN,aN,hN,lN,cN,uN,dN,pN,_N,gN,fN,mN,yN,vN,bN,wN,SN,xN,TN;t("PrefabLink",(Ok=Nk("cc.PrefabLink"),Lk=Vk(aP),Ok((zk=class extends Ag{constructor(){super(),this.prefab=kk&&kk()}},kk=Qo(zk.prototype,"prefab",[Lk,Uk],(function(){return null})),Fk=zk))||Fk)),t("SpriteRenderer",(Gk=oa("cc.SpriteRenderer"),Wk=ha(100),jk=Ga(yB),Gk($k=Wk((qk=class extends Rk{constructor(){super(),this._spriteFrame=Xk&&Xk(),this._mode=Yk&&Yk(),this._color=Qk&&Qk(),this._flipX=Kk&&Kk(),this._flipY=Zk&&Zk(),this._size=Jk&&Jk(),this._model=null}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._spriteFrame!==t&&(this._spriteFrame,this._spriteFrame=t,this._spriteFrame&&(this._spriteFrame.ensureMeshData(),this._spriteFrame.mesh.initialize()),this._updateModels(),this.enabledInHierarchy&&this._attachToScene())}get model(){return this._model}onLoad(){this._spriteFrame&&(this._spriteFrame.mesh||this._spriteFrame.ensureMeshData(),this._spriteFrame.mesh.initialize()),this._updateModels()}onRestore(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene()}onEnable(){super.onEnable(),this._model||this._updateModels(),this._attachToScene()}onDisable(){this._model&&this._detachFromScene()}onDestroy(){this._model&&(h.director.root.destroyModel(this._model),this._model=null,this._models.length=0)}_updateModels(){if(!this._spriteFrame)return;const t=this._model;if(t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model){const t=this._spriteFrame.mesh;this._model.createBoundingShape(t.struct.minPosition,t.struct.maxPosition),this._updateModelParams(),this._onUpdateLocalDescriptorSet()}}_createModel(){const t=this._model=h.director.root.createModel(CA);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model)}_updateModelParams(){if(!this._spriteFrame||!this._model)return;this._spriteFrame.ensureMeshData();const t=this._spriteFrame.mesh;this.node.hasChangedFlags|=1,this._model.transform.hasChangedFlags|=1;const e=t?t.renderingSubMeshes:null;if(e){const t=e.length;for(let i=0;i<t;++i){let t=this.getRenderMaterial(i);t&&!t.isValid&&(t=null);const s=e[i];s&&this._model.initSubModel(i,s,t||this._getBuiltinMaterial())}}this._model.enabled=!0}_getBuiltinMaterial(){return pw.get("missing-material")}_onMaterialModified(t,e){super._onMaterialModified(t,e),this._spriteFrame&&this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())}_onRebuildPSO(t,e){this._model&&this._model.inited&&(this._model.setSubModelMaterial(t,e),this._onUpdateLocalDescriptorSet())}_onUpdateLocalDescriptorSet(){if(!this._spriteFrame||!this._model||!this._model.inited)return;const t=this._spriteFrame.getGFXTexture(),e=this._spriteFrame.getGFXSampler(),i=this._model.subModels;for(let s=0;s<i.length;s++){const{descriptorSet:r}=i[s];r.bindTexture(12,t),r.bindSampler(12,e),r.update()}}_attachToScene(){if(!this.node.scene||!this._model)return;const t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}_detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},s(qk.prototype,"spriteFrame",[jk],Object.getOwnPropertyDescriptor(qk.prototype,"spriteFrame"),qk.prototype),Xk=Qo(qk.prototype,"_spriteFrame",[va],(function(){return null})),Yk=Qo(qk.prototype,"_mode",[va],(function(){return 0})),Qk=Qo(qk.prototype,"_color",[va],(function(){return _r.WHITE.clone()})),Kk=Qo(qk.prototype,"_flipX",[va],(function(){return!1})),Zk=Qo(qk.prototype,"_flipY",[va],(function(){return!1})),Jk=Qo(qk.prototype,"_size",[va],(function(){return new Qs})),$k=qk))||$k)||$k));const CN=new _R,IN="RICHTEXT_CHILD",EN="RICHTEXT_Image_CHILD",DN=new Qs,AN=new Qs,MN=new Vt((t=>{if(!h.isValid(t.node))return!1;{const e=t.node.getComponent(ML);e&&(e.outlineWidth=0)}return!0}),20),PN=new Vt((t=>h.isValid(t.node)),10);function BN(t){return{node:new JS(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function RN(t,e){let i;t===IN?i=MN._get():t===EN&&(i=PN._get()),i=i||BN(t);let s=i.node;return s||(s=new JS(t)),s.hideFlags|=yn.Flags.DontSave|yn.Flags.HideInHierarchy,s.active=!0,t===EN?(i.comp=s.getComponent(ZF)||s.addComponent(ZF),i.comp.spriteFrame=e,i.comp.type=ZF.Type.SLICED,i.comp.sizeMode=ZF.SizeMode.CUSTOM):(i.comp=s.getComponent(ML)||s.addComponent(ML),i.comp.string=e,i.comp.horizontalAlign=0,i.comp.verticalAlign=0,i.comp.underlineHeight=2),s.setPosition(0,0,0),s._uiProps.uiTransformComp.setAnchorPoint(.5,.5),i.node=s,i.lineCount=0,i.styleIndex=0,i.imageOffset="",i.clickParam="",i.clickHandler="",i}let ON=t("RichText",(tN=oa("cc.RichText"),eN=ha(110),iN=Ga(IL),sN=Ga(EL),rN=Ga(_r),nN=Ga(TB),oN=Ga(AL),aN=Ga(SB),tN(hN=eN((TN=class extends Ag{get string(){return this._string}set string(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}get verticalAlign(){return this._verticalAlign}set verticalAlign(t){this._verticalAlign!==t&&(this._verticalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontColor(){return this._fontColor}set fontColor(t){this._fontColor!==t&&(this._fontColor=t,this._updateTextDefaultColor())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}get font(){return this._font}set font(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}get maxWidth(){return this._maxWidth}set maxWidth(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}get imageAtlas(){return this._imageAtlas}set imageAtlas(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}get handleTouchEvent(){return this._handleTouchEvent}set handleTouchEvent(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}constructor(){super(),this._lineHeight=cN&&cN(),this._string=uN&&uN(),this._horizontalAlign=dN&&dN(),this._verticalAlign=pN&&pN(),this._fontSize=_N&&_N(),this._fontColor=gN&&gN(),this._maxWidth=fN&&fN(),this._fontFamily=mN&&mN(),this._font=yN&&yN(),this._isSystemFontUsed=vN&&vN(),this._userDefinedFont=bN&&bN(),this._cacheMode=wN&&wN(),this._imageAtlas=SN&&SN(),this._handleTouchEvent=xN&&xN(),this._textArray=[],this._segments=[],this._labelSegmentsCache=[],this._linesWidth=[],this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0,this._lineOffsetX=0,this._labelChildrenNum=0,this._updateRichTextStatus=this._updateRichText}onLoad(){this.node.on("layer-changed",this._applyLayer,this),this.node.on("anchor-changed",this._updateRichTextPosition,this)}onEnable(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}onDisable(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}onRestore(){}onDestroy(){for(const t of this._segments)t.node.removeFromParent(),t.type===IN?MN.put(t):t.type===EN&&PN.put(t);this.node.off("anchor-changed",this._updateRichTextPosition,this),this.node.off("layer-changed",this._applyLayer,this)}_addEventListeners(){this.node.on("touch-end",this._onTouchEnded,this)}_removeEventListeners(){this.node.off("touch-end",this._onTouchEnded,this)}_updateLabelSegmentTextAttributes(){this._segments.forEach((t=>{this._applyTextAttribute(t)}))}_createFontLabel(t){return RN(IN,t)}_createImage(t){return RN(EN,t)}_onTTFLoaded(){this._font,this._layoutDirty=!0,this._updateRichText()}splitLongStringApproximatelyIn2048(t,e){const i=[];if(t.length*this.fontSize<=1638.4)return i.push(t),i;if(this._calculateSize(DN,e,t),DN.x<2048)i.push(t);else{const s=t.split("\n");for(let t=0;t<s.length;t++)if(this._calculateSize(DN,e,s[t]),DN.x<2048)i.push(s[t]);else{const r=this.splitLongStringOver2048(s[t],e);i.push(...r)}}return i}splitLongStringOver2048(t,e){const i=[],s=t;let r=0,n=s.length/2,o=s.substring(r,n),a=s.substring(n);const h=this._calculateSize(DN,e,o),l=this._calculateSize(AN,e,a);let c=this._maxWidth;0===this._maxWidth&&(c=2047.9);const u=1*c;for(;h.x>u;){if(n/=2,n<1){n*=2;break}o=o.substring(r,n),a=s.substring(n),this._calculateSize(h,e,o)}let d=1e3,p=1;for(;d&&r<t.length;){for(;d&&h.x<u;){const t=QB(a);t&&t.length>0&&(p=t[0].length),n+=p,o=s.substring(r,n),a=s.substring(n),this._calculateSize(h,e,o),d--}for(;d&&o.length>=2&&h.x>u;)n-=p,o=s.substring(r,n),this._calculateSize(h,e,o),p=1,d--;if(o.length>=2){const t=KB(o);t&&t.length>0&&o!==t[0]&&(n-=t[0].length,o=s.substring(r,n))}if(i.push(o),r=n,n+=o.length,o=s.substring(r,n),a=s.substring(n),this._calculateSize(l,e,a),this._calculateSize(h,e,o),d--,l.x<2048&&h.x<u){i.push(o),r=t.length,n=t.length,o=a,""!==a&&i.push(o);break}}return i}_measureText(t,e){const i=e=>this._calculateSize(DN,t,e).x;return e?i(e):i}_calculateSize(t,e,i){let s;0===this._labelSegmentsCache.length?(s=this._createFontLabel(i),this._labelSegmentsCache.push(s)):(s=this._labelSegmentsCache[0],s.node.getComponent(ML).string=i),s.styleIndex=e,this._applyTextAttribute(s);const r=s.node._uiProps.uiTransformComp.contentSize;return Qs.set(t,r.x,r.y),t}_onTouchEnded(t){const e=this.node.getComponents(Ag);for(const i of this._segments){const s=i.clickHandler,r=i.clickParam;s&&this._containsTouchLocation(i,t.touch.getUILocation())&&(e.forEach((e=>{const i=e[s];e.enabledInHierarchy&&i&&i.call(e,t,r)})),t.propagationStopped=!0)}}_containsTouchLocation(t,e){const i=t.node.getComponent(pO);return!!i&&i.getBoundingBoxToWorld().contains(e)}_resetState(){const t=this.node.children;for(let e=t.length-1;e>=0;e--){const i=t[e];if(i.name===IN||i.name===EN){i.parent=null;const t=BN(i.name);t.node=i,i.name===IN?(t.comp=i.getComponent(ML),MN.put(t)):(t.comp=i.getComponent(ZF),PN.put(t)),this._labelChildrenNum--}}this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}_activateChildren(t){for(let e=this.node.children.length-1;e>=0;e--){const i=this.node.children[e];i.name!==IN&&i.name!==EN||(i.active=t)}}_addLabelSegment(t,e){let i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(t);else{i=this._labelSegmentsCache.pop();const e=i.node.getComponent(ML);e&&(e.string=t)}const s=i.comp;return s.verticalAlign!==this._verticalAlign&&(s.verticalAlign=this._verticalAlign),i.styleIndex=e,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),i.node.layer=this.node.layer,this.node.insertChild(i.node,this._labelChildrenNum++),this._applyTextAttribute(i),this._segments.push(i),i}_updateRichTextWithMaxWidth(t,e,i){let s,r=e;if(this._lineOffsetX>0&&r+this._lineOffsetX>this._maxWidth){let e=0;for(;this._lineOffsetX<=this._maxWidth;){const s=this._getFirstWordLen(t,e,t.length),n=t.substr(e,s),o=this._measureText(i,n);if(!(this._lineOffsetX+o<=this._maxWidth)){if(e>0){const s=t.substr(0,e);this._addLabelSegment(s,i),t=t.substr(e,t.length),r=this._measureText(i,t)}this._updateLineInfo();break}this._lineOffsetX+=o,e+=s}}if(r>this._maxWidth){const e=ZB(t,r,this._maxWidth,this._measureText(i));for(let t=0;t<e.length;++t){const r=e[t];s=this._addLabelSegment(r,i);const n=s.node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=n.width,e.length>1&&t<e.length-1&&this._updateLineInfo()}}else this._lineOffsetX+=r,this._addLabelSegment(t,i)}_isLastComponentCR(t){return t.length-1===t.lastIndexOf("\n")}_updateLineInfo(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}_needsUpdateTextLayout(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(let e=0;e<this._textArray.length;e++){const i=this._textArray[e],s=t[e];if(i.text!==s.text)return!0;{const t=i.style,e=s.style;if(t){if(e){if(!!e.outline!=!!t.outline)return!0;if(t.size!==e.size||t.italic!==e.italic||t.isImage!==e.isImage)return!0;if(t.src!==e.src||t.imageAlign!==e.imageAlign||t.imageHeight!==e.imageHeight||t.imageWidth!==e.imageWidth||t.imageOffset!==e.imageOffset)return!0}else if(t.size||t.italic||t.isImage||t.outline)return!0}else if(e&&(e.size||e.italic||e.isImage||e.outline))return!0}}return!1}_addRichTextImageElement(t){if(!t.style)return;const e=t.style,i=e.src,s=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(s){const t=this._createImage(s);switch(t.comp,e.imageAlign){case"top":t.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":t.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:t.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.imageOffset&&(t.imageOffset=e.imageOffset),t.node.layer=this.node.layer,this.node.insertChild(t.node,this._labelChildrenNum++),this._segments.push(t);const i=s.rect.clone();let r=1,n=i.width,o=i.height;const a=e.imageWidth||0,h=e.imageHeight||0;h>0?(r=h/o,n*=r,o*=r):(r=this._lineHeight/o,n*=r,o*=r),a>0&&(n=a),this._maxWidth>0?(this._lineOffsetX+n>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=n):(this._lineOffsetX+=n,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),t.node._uiProps.uiTransformComp.setContentSize(n,o),t.lineCount=this._lineCount,t.clickHandler="",t.clickParam="";const l=e.event;l&&(t.clickHandler=l.click,t.clickParam=l.param)}else G(4400)}_updateTextDefaultColor(){for(let i=0;i<this._segments.length;++i){var t,e;const s=this._segments[i],r=s.node.getComponent(ML);r&&(null!==(t=this._textArray[s.styleIndex])&&void 0!==t&&null!==(e=t.style)&&void 0!==e&&e.color||(r.color=this._fontColor))}}_updateRichText(){if(!this.enabledInHierarchy)return;const t=CN.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();let e,i=!1;for(let t=0;t<this._textArray.length;++t){const s=this._textArray[t];let r=s.text;if(void 0===r)continue;if(""===r){if(s.style&&s.style.isNewLine){this._updateLineInfo();continue}if(s.style&&s.style.isImage&&this._imageAtlas){this._addRichTextImageElement(s);continue}}r=this.splitLongStringApproximatelyIn2048(r,t).join("\n");const n=r.split("\n");for(let s=0;s<n.length;++s){const o=n[s];if(""!==o)if(i=!1,this._maxWidth>0){const e=this._measureText(t,o);this._updateRichTextWithMaxWidth(o,e,t),n.length>1&&s<n.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(o,t),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),n.length>1&&s<n.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(r)&&s===n.length-1)continue;this._updateLineInfo(),i=!0}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+AB)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}_getFirstWordLen(t,e,i){let s=jB(t,e);if(VB(s)||HB(s))return 1;let r=1;for(let n=e+1;n<i&&(s=jB(t,n),!HB(s)&&!VB(s));++n)r++;return r}_updateRichTextPosition(){let t=0,e=1;const i=this._lineCount,s=this.node._uiProps.uiTransformComp,r=s.anchorX,n=s.anchorY;for(let s=0;s<this._segments.length;++s){const o=this._segments[s],a=o.lineCount;a>e&&(t=0,e=a);let h=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case 0:break;case 1:h-=this._linesWidth[a-1]/2;break;case 2:h-=this._linesWidth[a-1]}const l=o.node.position;if(o.node.setPosition(t+h,this._lineHeight*(i-a)-this._labelHeight*n,l.z),a===e&&(t+=o.node._uiProps.uiTransformComp.width),o.node.getComponent(ZF)){const t=o.node.position.clone(),e=this._lineHeight,i=this._lineHeight*(1+AB);switch(o.node._uiProps.uiTransformComp.anchorY){case 1:t.y+=e+(i-e)/2;break;case.5:t.y+=i/2;break;default:t.y+=(i-e)/2}if(o.imageOffset){const e=o.imageOffset.split(",");if(1===e.length&&e[0]){const i=parseFloat(e[0]);Number.isInteger(i)&&(t.y+=i)}else if(2===e.length){const i=parseFloat(e[0]),s=parseFloat(e[1]);Number.isInteger(i)&&(t.x+=i),Number.isInteger(s)&&(t.y+=s)}}o.node.position=t}const c=o.node.getComponent(ML);if(c&&c.enableOutline){const t=o.node.position.clone();t.y-=c.outlineWidth,o.node.position=t}}}_convertLiteralColorValue(t){const e=t.toUpperCase();return _r[e]?_r[e]:(new _r).fromHEX(t)}_applyTextAttribute(t){const e=t.node.getComponent(ML);if(!e)return;this._resetLabelState(e);const i=t.styleIndex;let s;if(this._textArray[i]&&(s=this._textArray[i].style),s){if(s.color?e.color=this._convertLiteralColorValue(s.color):e.color=this._fontColor,e.isBold=!!s.bold,e.isItalic=!!s.italic,e.isUnderline=!!s.underline,s.outline){let e=t.node.getComponent(ML);e||(e=t.node.addComponent(ML)),e.enableOutline=!0,e.outlineColor=this._convertLiteralColorValue(s.outline.color),e.outlineWidth=s.outline.width}e.fontSize=s.size||this._fontSize,t.clickHandler="",t.clickParam="";const i=s.event;i&&(t.clickHandler=i.click||"",t.clickParam=i.param||"")}e.cacheMode=this._cacheMode,this._font instanceof TB&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0)}_applyLayer(){for(const t of this._segments)t.node.layer=this.node.layer}_resetLabelState(t){t.fontSize=this._fontSize,t.color=this._fontColor,t.isBold=!1,t.isItalic=!1,t.isUnderline=!1}},TN.HorizontalAlign=IL,TN.VerticalAlign=EL,s((lN=TN).prototype,"horizontalAlign",[iN],Object.getOwnPropertyDescriptor(lN.prototype,"horizontalAlign"),lN.prototype),s(lN.prototype,"verticalAlign",[sN],Object.getOwnPropertyDescriptor(lN.prototype,"verticalAlign"),lN.prototype),s(lN.prototype,"fontColor",[rN],Object.getOwnPropertyDescriptor(lN.prototype,"fontColor"),lN.prototype),s(lN.prototype,"font",[nN],Object.getOwnPropertyDescriptor(lN.prototype,"font"),lN.prototype),s(lN.prototype,"cacheMode",[oN],Object.getOwnPropertyDescriptor(lN.prototype,"cacheMode"),lN.prototype),s(lN.prototype,"imageAtlas",[aN],Object.getOwnPropertyDescriptor(lN.prototype,"imageAtlas"),lN.prototype),cN=Qo(lN.prototype,"_lineHeight",[va],(function(){return 40})),uN=Qo(lN.prototype,"_string",[va],(function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"})),dN=Qo(lN.prototype,"_horizontalAlign",[va],(function(){return 0})),pN=Qo(lN.prototype,"_verticalAlign",[va],(function(){return 0})),_N=Qo(lN.prototype,"_fontSize",[va],(function(){return 40})),gN=Qo(lN.prototype,"_fontColor",[va],(function(){return _r.WHITE.clone()})),fN=Qo(lN.prototype,"_maxWidth",[va],(function(){return 0})),mN=Qo(lN.prototype,"_fontFamily",[va],(function(){return"Arial"})),yN=Qo(lN.prototype,"_font",[va],(function(){return null})),vN=Qo(lN.prototype,"_isSystemFontUsed",[va],(function(){return!0})),bN=Qo(lN.prototype,"_userDefinedFont",[va],(function(){return null})),wN=Qo(lN.prototype,"_cacheMode",[va],(function(){return 0})),SN=Qo(lN.prototype,"_imageAtlas",[va],(function(){return null})),xN=Qo(lN.prototype,"_handleTouchEvent",[va],(function(){return!0})),hN=lN))||hN)||hN));var LN;h.RichText=ON;let FN=t("UIMeshRenderer",oa("cc.UIMeshRenderer")(LN=ha(110)(LN=class extends Ag{constructor(){super(),this._modelComponent=null,this._dirtyVersion=-1,this._internalId=-1,this.stencilStage=0,this._renderData=null,this._renderEntity=new DO(1)}get modelComponent(){return this._modelComponent}__preload(){this.node._uiProps.uiComp=this}onEnable(){hP.addRenderer(this),this.markForUpdateRenderData()}onDisable(){hP.removeRenderer(this),this.renderEntity.enabled=this._canRender()}onLoad(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.ModelRenderer"),this._modelComponent?this.renderEntity.setNode(this.node):G(16378,this.node?this.node.name:"")}onDestroy(){this.renderEntity.setNode(null),this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.ModelRenderer"),this._modelComponent&&(this._modelComponent._sceneGetter=null)}_render(t){if(this._modelComponent){const e=this._modelComponent._collectModels();this._modelComponent._detachFromScene();for(let i=0;i<e.length;i++)e[i].enabled&&t.commitModel(this,e[i],this._modelComponent.material);return!0}return!1}fillBuffers(t){this.enabled&&this._render(t)}updateRenderer(){}_uploadRenderData(t){}postUpdateAssembler(t){}update(){this._fitUIRenderQueue()}_fitUIRenderQueue(){if(!this._modelComponent)return;const t=this._modelComponent.sharedMaterials.length;for(let e=0;e<t;e++){const t=this._modelComponent.getMaterialInstance(e);if(null==t)continue;const i=t.passes,s=i.length;for(let e=0;e<s;e++)i[e].setPriority(244),t.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},e)}}markForUpdateRenderData(t){hP.markDirtyRenderer(this)}setNodeDirty(){}setTextureDirty(){}_canRender(){return this.enabled&&null!==this._modelComponent}get renderEntity(){return this._renderEntity}get renderData(){return this._renderData}})||LN)||LN);var zN;h.UIMeshRenderer=FN;let kN=t("LabelOutline",oa("cc.LabelOutline")(zN=ha(110)(zN=aa(ML)(zN=class extends Ag{get color(){return this.node.getComponent(ML).outlineColor}set color(t){this.node.getComponent(ML).outlineColor=t}get width(){return this.node.getComponent(ML).outlineWidth}set width(t){this.node.getComponent(ML).outlineWidth=t}onEnable(){this.node.getComponent(ML).enableOutline=!0}onDisable(){this.node.getComponent(ML).enableOutline=!1}})||zN)||zN)||zN);h.LabelOutline=kN;const NN=Kf.Enum.NONE|Kf.Enum.UI_3D;class UN{constructor(){this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=NN,this._inputAssembler=null,this._descriptorSet=null}get inputAssembler(){return this._inputAssembler}set inputAssembler(t){this._inputAssembler=t}get descriptorSet(){return this._descriptorSet}set descriptorSet(t){this._descriptorSet=t}get visFlags(){return this._visFlags}set visFlags(t){this._visFlags=t}get passes(){return this._passes}get shaders(){return this._shaders}destroy(t){this._passes=[]}clear(){this._inputAssembler=null,this._descriptorSet=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=NN}fillPasses(t,e,i,s){if(t){const r=t.passes;if(!r)return;this._shaders.length=r.length;for(let t=0;t<r.length;t++){this._passes[t]||(this._passes[t]=new vw(h.director.root));const n=r[t],o=this._passes[t];n.update(),e||(e=n.depthStencilState,i=0),o._initPassFromTarget(n,e,i),this._shaders[t]=o.getShaderVariant(s)}}}}var VN,HN,GN,WN,jN,$N;t("UIStaticBatch",oa("cc.UIStaticBatch")(VN=ha(110)((HN=class extends VO{constructor(){super(),this._init=!1,this._bufferAccessor=null,this._dirty=!0,this._uiDrawBatchList=[]}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get drawBatchList(){return this._uiDrawBatchList}postUpdateAssembler(t){}markAsDirty(){}_requireDrawBatch(){const t=new UN;return t.isStatic=!0,this._uiDrawBatchList.push(t),t}_clearData(){if(this._bufferAccessor){this._bufferAccessor.reset();const t=this._getBatcher();for(let e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1}_getBatcher(){return uP.root&&uP.root.batcher2D?uP.root.batcher2D:(G(9301),null)}},s(HN.prototype,"color",[Wa],Object.getOwnPropertyDescriptor(HN.prototype,"color"),HN.prototype),VN=HN))||VN)||VN),t("LabelShadow",oa("cc.LabelShadow")(GN=ha(110)(GN=aa(ML)(GN=class extends Ag{get color(){return this.node.getComponent(ML).shadowColor}set color(t){this.node.getComponent(ML).shadowColor=t}get offset(){return this.node.getComponent(ML).shadowOffset}set offset(t){this.node.getComponent(ML).shadowOffset=t}get blur(){return this.node.getComponent(ML).shadowBlur}set blur(t){this.node.getComponent(ML).shadowBlur=t}onEnable(){this.node.getComponent(ML).enableShadow=!0}onDisable(){this.node.getComponent(ML).enableShadow=!1}})||GN)||GN)||GN),t("UIOpacity",oa("cc.UIOpacity")(WN=ha(110)(WN=la((jN=class t extends Ag{constructor(){super(),this._parentOpacity=1,this._parentOpacityResetFlag=!0,this._opacity=$N&&$N()}get opacity(){return this._opacity}set opacity(t){this._opacity!==t&&(t=fi(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255,this.setEntityLocalOpacityDirtyRecursively(!0))}setEntityLocalOpacityDirtyRecursively(t){}static setEntityLocalOpacityDirtyRecursively(e,i,s,r){if(!e.isValid)return;const n=e.getComponent(t);if(n&&r)return void(n._parentOpacity=s);let o=e._uiProps.uiComp;if(o||(o=e.getComponent(VO)),o&&o.color)return o.renderEntity.colorDirty=i,n?(n._parentOpacity=s,o.renderEntity.localOpacity=s*n.opacity/255):o.renderEntity.localOpacity=s,void(o.node._uiProps.localOpacity=o.renderEntity.localOpacity);n&&(n._parentOpacity=s,s=s*n.opacity/255);const a=e.children;for(let e=0,n=a.length;e<n;++e)t.setEntityLocalOpacityDirtyRecursively(a[e],i||s<1,s,r)}_getParentOpacity(e){if(null==e||!e.isValid)return 1;const i=e._uiProps.uiComp,s=e.getComponent(t);return i&&i.color?1:s?s._parentOpacity*(s._opacity/255):this._getParentOpacity(e.getParent())}_parentChanged(){}_setEntityLocalOpacityRecursively(t){}onEnable(){this.node.on("parent-changed",this._parentChanged,this),this.node._uiProps.localOpacity=this._parentOpacity*this._opacity/255,this._parentOpacityResetFlag?(this._parentChanged(),this._parentOpacityResetFlag=!1):this._setEntityLocalOpacityRecursively(this.node._uiProps.localOpacity)}onDisable(){this.node.off("parent-changed",this._parentChanged,this),this.node._uiProps.localOpacity=1,this._setEntityLocalOpacityRecursively(this.node._uiProps.localOpacity)}},$N=Qo(jN.prototype,"_opacity",[va],(function(){return 255})),WN=jN))||WN)||WN)||WN);class qN{constructor(t,e,i){this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=i}}function XN(t,e,i,s,r){let n=0,o=null;if(r===gU(t,e,i,s)>0)for(n=e;n<i;n+=s)o=pU(n,t[n],t[n+1],o);else for(n=i-s;n>=e;n-=s)o=pU(n,t[n],t[n+1],o);return o&&aU(o,o.next)&&(_U(o),o=o.next),o}function YN(t,e){if(void 0===e&&(e=null),!t)return t;e||(e=t);let i=t,s=!1;do{if(s=!1,i.steiner||!aU(i,i.next)&&0!==oU(i.prev,i,i.next))i=i.next;else{if(_U(i),i=e=i.prev,i===i.next)return null;s=!0}}while(s||i!==e);return e}function QN(t,e,i,s,r,n,o){if(void 0===o&&(o=0),!t)return;!o&&n&&eU(t,s,r,n);let a=t,h=null,l=null;for(;t.prev!==t.next;)if(h=t.prev,l=t.next,n?ZN(t,s,r,n):KN(t))e.push(h.i/i),e.push(t.i/i),e.push(l.i/i),_U(t),t=l.next,a=l.next;else if((t=l)===a){o?1===o?QN(t=JN(t,e,i),e,i,s,r,n,2):2===o&&tU(t,e,i,s,r,n):QN(YN(t),e,i,s,r,n,1);break}}function KN(t){const e=t.prev,i=t,s=t.next;if(oU(e,i,s)>=0)return!1;let r=t.next.next;for(;r!==t.prev;){if(rU(e.x,e.y,i.x,i.y,s.x,s.y,r.x,r.y)&&oU(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function ZN(t,e,i,s){const r=t.prev,n=t,o=t.next;if(oU(r,n,o)>=0)return!1;const a=r.x<n.x?r.x<o.x?r.x:o.x:n.x<o.x?n.x:o.x,h=r.y<n.y?r.y<o.y?r.y:o.y:n.y<o.y?n.y:o.y,l=r.x>n.x?r.x>o.x?r.x:o.x:n.x>o.x?n.x:o.x,c=r.y>n.y?r.y>o.y?r.y:o.y:n.y>o.y?n.y:o.y,u=sU(a,h,e,i,s),d=sU(l,c,e,i,s);let p=t.nextZ;for(;p&&p.z<=d;){if(p!==t.prev&&p!==t.next&&rU(r.x,r.y,n.x,n.y,o.x,o.y,p.x,p.y)&&oU(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(p=t.prevZ;p&&p.z>=u;){if(p!==t.prev&&p!==t.next&&rU(r.x,r.y,n.x,n.y,o.x,o.y,p.x,p.y)&&oU(p.prev,p,p.next)>=0)return!1;p=p.prevZ}return!0}function JN(t,e,i){let s=t;do{const r=s.prev,n=s.next.next;!aU(r,n)&&hU(r,s,s.next,n)&&cU(r,n)&&cU(n,r)&&(e.push(r.i/i),e.push(s.i/i),e.push(n.i/i),_U(s),_U(s.next),s=t=n),s=s.next}while(s!==t);return s}function tU(t,e,i,s,r,n){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&nU(o,t)){let a=dU(o,t);return o=YN(o,o.next),a=YN(a,a.next),QN(o,e,i,s,r,n),void QN(a,e,i,s,r,n)}t=t.next}o=o.next}while(o!==t)}function eU(t,e,i,s){let r=t;do{null===r.z&&(r.z=sU(r.x,r.y,e,i,s)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,iU(r)}function iU(t){let e=0,i=null,s=null,r=null,n=null,o=0,a=0,h=0,l=1;do{for(i=t,t=null,n=null,o=0;i;){for(o++,s=i,a=0,e=0;e<l&&(a++,s=s.nextZ,s);e++);for(h=l;a>0||h>0&&s;)0===a?(r=s,s=s.nextZ,h--):0!==h&&s?i.z<=s.z?(r=i,i=i.nextZ,a--):(r=s,s=s.nextZ,h--):(r=i,i=i.nextZ,a--),n?n.nextZ=r:t=r,r.prevZ=n,n=r;i=s}n.nextZ=null,l*=2}while(o>1);return t}function sU(t,e,i,s,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-s)/r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function rU(t,e,i,s,r,n,o,a){return(r-o)*(e-a)-(t-o)*(n-a)>=0&&(t-o)*(s-a)-(i-o)*(e-a)>=0&&(i-o)*(n-a)-(r-o)*(s-a)>=0}function nU(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!lU(t,e)&&cU(t,e)&&cU(e,t)&&uU(t,e)}function oU(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function aU(t,e){return t.x===e.x&&t.y===e.y}function hU(t,e,i,s){return!!(aU(t,e)&&aU(i,s)||aU(t,s)&&aU(i,e))||oU(t,e,i)>0!=oU(t,e,s)>0&&oU(i,s,t)>0!=oU(i,s,e)>0}function lU(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&hU(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}function cU(t,e){return oU(t.prev,t,t.next)<0?oU(t,e,t.next)>=0&&oU(t,t.prev,e)>=0:oU(t,e,t.prev)<0||oU(t,t.next,e)<0}function uU(t,e){let i=t,s=!1;const r=(t.x+e.x)/2,n=(t.y+e.y)/2;do{i.y>n!=i.next.y>n&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==t);return s}function dU(t,e){const i=new qN(t.i,t.x,t.y),s=new qN(e.i,e.x,e.y),r=t.next,n=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,s.next=i,i.prev=s,n.next=s,s.prev=n,s}function pU(t,e,i,s){const r=new qN(t,e,i);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function _U(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function gU(t,e,i,s){let r=0;for(let n=e,o=i-s;n<i;n+=s)r+=(t[o]-t[n])*(t[n+1]+t[o+1]),o=n;return r}function fU(t,e,i){i=i||3;const s=t.length;let r=XN(t,0,s,i,!0);const n=[];if(!r)return n;let o=0,a=0,h=0,l=0,c=0,u=0,d=0;if(t.length>80*i){o=h=t[0],a=l=t[1];for(let e=i;e<s;e+=i)c=t[e],u=t[e+1],c<o&&(o=c),u<a&&(a=u),c>h&&(h=c),u>l&&(l=u);d=Math.max(h-o,l-a)}return QN(r,n,i,o,a,d),n}const mU=Math.PI,yU=Math.min,vU=Math.max,bU=Math.ceil,wU=Math.acos,SU=Math.cos,xU=Math.sin,TU=Math.atan2;let CU=null,IU=null;const EU=new _r,DU=[];for(let t=0;t<4;t++)DU.push(new Ki);function AU(t,e,i){const s=2*wU(t/(t+i));return vU(2,bU(e/s))}function MU(t,e,i){return t<e?e:t>i?i:t}const PU={useModel:!0,updateRenderData(t){},fillBuffers(t,e){},renderIA(t,e){},getRenderData(t,e){if(!IU)return null;const i=IU.getRenderDataList();let s=i[IU.dataOffset];if(!s)return null;let r=s;const n=r?r.vertexStart+e:0;return(n>65535||3*n>131070)&&(++IU.dataOffset,IU.dataOffset<i.length?s=i[IU.dataOffset]:(s=IU.requestRenderData(),i[IU.dataOffset]=s),r=s),r&&r.vertexCount<n&&r.request(e,3*e),s},stroke(t){_r.copy(EU,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill(t){_r.copy(EU,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end(t){t.markForUpdateRenderData()},_expandStroke(t){const e=.5*t.lineWidth,i=t.lineCap,s=t.lineJoin,r=t.miterLimit;if(IU=t.impl,!IU)return;const n=AU(e,mU,IU.tessTol);this._calculateJoins(IU,e,s,r);const o=IU.paths;let a=0;for(let t=IU.pathOffset,e=IU.pathLength;t<e;t++){const e=o[t],r=e.points.length;a+=1===s?2*(r+e.bevel*(n+2)+1):2*(r+5*e.bevel+1),e.closed||(a+=1===i?2*(2*n+2):12)}const h=CU=this.getRenderData(t,a);if(!h)return;const l=h.vData,c=h.iData;for(let t=IU.pathOffset,r=IU.pathLength;t<r;t++){const r=o[t],a=r.points,u=a.length,d=h.vertexStart;let p,_,g=0,f=0;const m=r.closed;if(m?(p=a[u-1],_=a[0],g=0,f=u):(p=a[0],_=a[1],g=1,f=u-1),_=_||p,!m){const t=new lF(_.x,_.y);t.subtract(p),t.normalize();const s=t.x,r=t.y;0===i?this._buttCapStart(p,s,r,e,0):2===i?this._buttCapStart(p,s,r,e,e):1===i&&this._roundCapStart(p,s,r,e,n)}for(let t=g;t<f;++t)1===s?this._roundJoin(p,_,e,e,n):12&_.flags?this._bevelJoin(p,_,e,e):(this._vSet(_.x+_.dmx*e,_.y+_.dmy*e,1),this._vSet(_.x-_.dmx*e,_.y-_.dmy*e,-1)),p=_,_=a[t+1];if(m){const t=8*d;this._vSet(l[t],l[t+1],1),this._vSet(l[t+8],l[t+8+1],-1)}else{const t=new lF(_.x,_.y);t.subtract(p),t.normalize();const s=t.x,r=t.y;0===i?this._buttCapEnd(_,s,r,e,0):2===i?this._buttCapEnd(_,s,r,e,e):1===i&&this._roundCapEnd(_,s,r,e,n)}let y=h.indexStart;for(let t=d+2,e=h.vertexStart;t<e;t++)c[y++]=t-2,c[y++]=t-1,c[y++]=t;h.indexStart=y}CU=null,IU=null},_expandFill(t){if(IU=t.impl,!IU)return;const e=IU.paths;let i=0;for(let t=IU.pathOffset,s=IU.pathLength;t<s;t++)i+=e[t].points.length;const s=CU=this.getRenderData(t,i);if(!s)return;const r=s,n=r.vData,o=r.iData;for(let t=IU.pathOffset,i=IU.pathLength;t<i;t++){const i=e[t],a=i.points,h=a.length;if(0===h)continue;const l=s.vertexStart;for(let t=0;t<h;++t)this._vSet(a[t].x,a[t].y);let c=s.indexStart;if(i.complex){const t=[];for(let e=l,i=s.vertexStart;e<i;e++){let i=8*e;t.push(n[i++]),t.push(n[i++]),t.push(n[i++])}const e=fU(t,0,3);if(!e||0===e.length)continue;for(let t=0,i=e.length;t<i;t++)o[c++]=e[t]+l}else{const t=l;for(let e=l+2,i=r.vertexStart;e<i;e++)o[c++]=t,o[c++]=e-1,o[c++]=e}r.indexStart=c}CU=null,IU=null},_calculateJoins(t,e,i,s){let r=0;e>0&&(r=1/e);const n=t.paths;for(let e=t.pathOffset,o=t.pathLength;e<o;e++){const t=n[e],o=t.points,a=o.length;let h=o[a-1],l=o[0];t.bevel=0;for(let e=0;e<a;e++){let n=0,a=0,c=0;const u=h.dy,d=-h.dx,p=l.dy,_=-l.dx;if(l.dmx=.5*(u+p),l.dmy=.5*(d+_),n=l.dmx*l.dmx+l.dmy*l.dmy,n>1e-6){let t=1/n;t>600&&(t=600),l.dmx*=t,l.dmy*=t}a=l.dx*h.dy-h.dx*l.dy,a>0&&(l.flags|=2),c=vU(11,yU(h.len,l.len)*r),n*c*c<1&&(l.flags|=8),1&l.flags&&(n*s*s<1||0===i||1===i)&&(l.flags|=4),12&l.flags&&t.bevel++,h=l,l=o[e+1]}}},_flattenPaths(t){const e=t.paths;for(let i=t.pathOffset,s=t.pathLength;i<s;i++){const t=e[i],s=t.points;let r=s[s.length-1],n=s[0];s.length>2&&r.equals(n)&&(t.closed=!0,s.pop(),r=s[s.length-1]);for(let t=0,e=s.length;t<e;t++){const e=new lF(n.x,n.y);e.subtract(r),r.len=e.length(),(e.x||e.y)&&e.normalize(),r.dx=e.x,r.dy=e.y,r=n,n=s[t+1]}}},_chooseBevel(t,e,i,s){const r=i.x,n=i.y;let o=0,a=0,h=0,l=0;return 0!==t?(o=r+e.dy*s,a=n-e.dx*s,h=r+i.dy*s,l=n-i.dx*s):(o=h=r+i.dmx*s,a=l=n+i.dmy*s),[o,a,h,l]},_buttCapStart(t,e,i,s,r){const n=t.x-e*r,o=t.y-i*r,a=i,h=-e;this._vSet(n+a*s,o+h*s,1),this._vSet(n-a*s,o-h*s,-1)},_buttCapEnd(t,e,i,s,r){const n=t.x+e*r,o=t.y+i*r,a=i,h=-e;this._vSet(n+a*s,o+h*s,1),this._vSet(n-a*s,o-h*s,-1)},_roundCapStart(t,e,i,s,r){const n=t.x,o=t.y,a=i,h=-e;for(let t=0;t<r;t++){const l=t/(r-1)*mU,c=SU(l)*s,u=xU(l)*s;this._vSet(n-a*c-e*u,o-h*c-i*u,1),this._vSet(n,o,0)}this._vSet(n+a*s,o+h*s,1),this._vSet(n-a*s,o-h*s,-1)},_roundCapEnd(t,e,i,s,r){const n=t.x,o=t.y,a=i,h=-e;this._vSet(n+a*s,o+h*s,1),this._vSet(n-a*s,o-h*s,-1);for(let t=0;t<r;t++){const l=t/(r-1)*mU,c=SU(l)*s,u=xU(l)*s;this._vSet(n,o,0),this._vSet(n-a*c+e*u,o-h*c+i*u,1)}},_roundJoin(t,e,i,s,r){const n=t.dy,o=-t.dx,a=e.dy,h=-e.dx,l=e.x,c=e.y;if(2&e.flags){const u=this._chooseBevel(8&e.flags,t,e,i),d=u[0],p=u[1],_=u[2],g=u[3],f=TU(-o,-n);let m=TU(-h,-a);m>f&&(m-=2*mU),this._vSet(d,p,1),this._vSet(l-n*s,e.y-o*s,-1);const y=MU(bU((f-m)/mU)*r,2,r);for(let t=0;t<y;t++){const e=f+t/(y-1)*(m-f),i=l+SU(e)*s,r=c+xU(e)*s;this._vSet(l,c,0),this._vSet(i,r,-1)}this._vSet(_,g,1),this._vSet(l-a*s,c-h*s,-1)}else{const u=this._chooseBevel(8&e.flags,t,e,-s),d=u[0],p=u[1],_=u[2],g=u[3],f=TU(o,n);let m=TU(h,a);m<f&&(m+=2*mU),this._vSet(l+n*s,c+o*s,1),this._vSet(d,p,-1);const y=MU(bU((m-f)/mU)*r,2,r);for(let t=0;t<y;t++){const e=f+t/(y-1)*(m-f),s=l+SU(e)*i,r=c+xU(e)*i;this._vSet(s,r,1),this._vSet(l,c,0)}this._vSet(l+a*s,c+h*s,1),this._vSet(_,g,-1)}},_bevelJoin(t,e,i,s){let r=0,n=0,o=0,a=0,h=0,l=0,c=0,u=0;const d=t.dy,p=-t.dx,_=e.dy,g=-e.dx;if(2&e.flags){const r=this._chooseBevel(8&e.flags,t,e,i);h=r[0],l=r[1],c=r[2],u=r[3],this._vSet(h,l,1),this._vSet(e.x-d*s,e.y-p*s,-1),this._vSet(c,u,1),this._vSet(e.x-_*s,e.y-g*s,-1)}else{const h=this._chooseBevel(8&e.flags,t,e,-s);r=h[0],n=h[1],o=h[2],a=h[3],this._vSet(e.x+d*i,e.y+p*i,1),this._vSet(r,n,-1),this._vSet(e.x+_*i,e.y+g*i,1),this._vSet(o,a,-1)}},_vSet(t,e,i){if(void 0===i&&(i=0),!CU)return;const s=CU;let r=8*s.vertexStart;const n=s.vData;n[r++]=t,n[r++]=e,n[r++]=0,_r.toArray(n,EU,r),r+=4,n[r++]=i,s.vertexStart++}},BU=t("graphicsAssembler",{getAssembler:()=>PU});DF.Assembler=BU;const RU=["left","center","right"],OU=2048,LU=BB(),FU=(1/255).toFixed(3);class zU{constructor(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}}class kU{constructor(){this._context=null,this._canvas=null,this._canvasData=null,this._lettersInfo=[],this._tmpRect=new Cr,this._maxFontSize=100,this._fontScale=1,this._canvasData=AR.getInstance().get(),this._canvas=this._canvasData.canvas,this._context=this._canvasData.context}destroy(){AR.getInstance().put(this._canvasData),this._lettersInfo.length=0}processingString(t,e,i,s,r,n){if(t)e.fntConfig?this._fontScale=1:this._fontScale=this._getStyleFontScale(e.originFontSize,e.fontScale),FR.fontScale=this._fontScale,this._setupBMFontOverflowMetrics(i,s),this._updateFontScale(e),this._computeHorizontalKerningForText(e,i,r),this._alignText(e,i,s,r);else{let t=0;for(this._fontScale=this._getStyleFontScale(e.fontSize,e.fontScale),this._updatePaddingRect(e,s),this._calculateLabelFont(e,i,s,r);(s.canvasSize.width>OU||s.canvasSize.height>OU)&&t<=3;){if(t++,t>3)this._fontScale=1;else{const t=Math.max(s.canvasSize.width,s.canvasSize.height),e=OU/t;this._fontScale*=e,this._fontScale=Math.max(1,this._fontScale)}this._updatePaddingRect(e,s),this._calculateLabelFont(e,i,s,r)}}n&&(n=s.parsedString)}generateRenderInfo(t,e,i,s,r,n,o){t?(this._computeAlignmentOffset(e,i,s),this.generateVertexData(t,e,i,s,r,n,o)):(this._updateLabelDimensions(e,i,s),this._updateTexture(e,i,s,r),this.generateVertexData(t,e,i,s,r,n,o))}setCanvasUsed(t,e){this._canvas=t,this._context=e}_getStyleFontScale(t,e){let i=e;return i*t>this._maxFontSize&&t<this._maxFontSize&&(i=this._maxFontSize/t),i<1&&(i=1),i}_calculateLabelFont(t,e,i,s){if(!this._context)return;t.actualFontSize=t.fontSize*this._fontScale;const r=s.split("\n"),n=i.parsedString=r,o=this._getFontDesc(t.actualFontSize,t.fontFamily,t.isBold,t.isItalic);switch(this._context.font=t.fontDesc=o,e.overFlow){case 0:{let s=0,a=0;for(let t=0;t<r.length;++t){const e=GB(this._context,r[t],o);s=s>e?s:e}a=(n.length+AB)*this._getLineHeight(e.lineHeight,t.actualFontSize,t.fontSize);const h=s,l=a;i.canvasSize.width=h+i.canvasPadding.width*this._fontScale,i.canvasSize.height=l+i.canvasPadding.height*this._fontScale,i.nodeContentSize.width=(h+i.contentSizeExtend.width*this._fontScale)/this._fontScale,i.nodeContentSize.height=(l+i.contentSizeExtend.height*this._fontScale)/this._fontScale;break}case 2:this._calculateShrinkFont(r,t,e,i),this._calculateWrapText(r,t,e,i),i.canvasSize.width=i.nodeContentSize.width*this._fontScale,i.canvasSize.height=i.nodeContentSize.height*this._fontScale;break;case 1:this._calculateWrapText(r,t,e,i),i.canvasSize.width=i.nodeContentSize.width*this._fontScale,i.canvasSize.height=i.nodeContentSize.height*this._fontScale;break;case 3:{this._calculateWrapText(r,t,e,i);const s=(i.parsedString.length+AB)*this._getLineHeight(e.lineHeight,t.actualFontSize,t.fontSize);i.canvasSize.width=i.nodeContentSize.width*this._fontScale,i.canvasSize.height=s+i.canvasPadding.height*this._fontScale,i.nodeContentSize.height=(s+i.contentSizeExtend.height*this._fontScale)/this._fontScale;break}}}_getFontDesc(t,e,i,s){let r=`${t.toString()}px `;return r+=e,i&&(r=`bold ${r}`),s&&(r=`italic ${r}`),r}_getLineHeight(t,e,i){let s=t;return s=0===s?e:s*e/i,s}_calculateShrinkFont(t,e,i,s){if(!this._context)return;let r=this._getFontDesc(e.actualFontSize,e.fontFamily,e.isBold,e.isItalic);this._context.font=r;const n=this._calculateParagraphLength(t,this._context,r);let o=0,a=0,h=0,l=e.actualFontSize;if(i.wrapping){const n=s.nodeContentSize.width*this._fontScale,h=s.nodeContentSize.height*this._fontScale;if(n<0||h<0)return;a=h+1;let c=[],u=0,d=0|e.actualFontSize+1,p=0;for(;u<d;){if(p=u+d+1>>1,p<=0){N(4003);break}l=p,r=this._getFontDesc(l,e.fontFamily,e.isBold,e.isItalic),this._context.font=r;const s=this._getLineHeight(i.lineHeight,l,e.fontSize);for(a=0,o=0;o<t.length;++o){const e=GB(this._context,t[o],r);c=ZB(t[o],e,n,this._measureText(this._context,r)),a+=c.length*s}a>h?d=p-1:u=p}0===u?N(4003):(l=u,r=this._getFontDesc(l,e.fontFamily,e.isBold,e.isItalic),this._context.font=r)}else{for(a=t.length*this._getLineHeight(i.lineHeight,l,e.fontSize),o=0;o<t.length;++o)h<n[o]&&(h=n[o]);const c=(s.canvasSize.width-s.canvasPadding.width)*this._fontScale/h,u=s.canvasSize.height*this._fontScale/a;l=e.actualFontSize*Math.min(1,c,u)|0,r=this._getFontDesc(l,e.fontFamily,e.isBold,e.isItalic),this._context.font=r}e.actualFontSize=l,e.fontDesc=r}_calculateWrapText(t,e,i,s){if(!i.wrapping||!this._context)return;let r=[];const n=s.nodeContentSize.width*this._fontScale,o=this._getFontDesc(e.actualFontSize,e.fontFamily,e.isBold,e.isItalic);this._context.font=o;for(let e=0;e<t.length;++e){const i=GB(this._context,t[e],o),s=ZB(t[e],i,n,this._measureText(this._context,o));r=r.concat(s)}s.parsedString=r,e.fontDesc=o}_measureText(t,e){return i=>GB(t,i,e)}_calculateParagraphLength(t,e,i){const s=[];for(const r of t){const t=GB(e,r,i);s.push(t)}return s}_updatePaddingRect(t,e){let i=0,s=0,r=0,n=0,o=0;if(e.contentSizeExtend.width=e.contentSizeExtend.height=0,t.isOutlined&&(o=t.outlineWidth,i=s=r=n=o,e.contentSizeExtend.width=e.contentSizeExtend.height=2*o),t.hasShadow){const e=t.shadowBlur+o,a=t.shadowOffsetX,h=t.shadowOffsetY;r=Math.max(r,-a+e),n=Math.max(n,a+e),i=Math.max(i,h+e),s=Math.max(s,-h+e)}if(t.isItalic){const i=t.fontSize*Math.tan(.20943951);n+=i,e.contentSizeExtend.width+=i}e.canvasPadding.x=r,e.canvasPadding.y=i,e.canvasPadding.width=r+n,e.canvasPadding.height=i+s}_updateLabelDimensions(t,e,i){i.canvasSize.width=Math.min(i.canvasSize.width,OU),i.canvasSize.height=Math.min(i.canvasSize.height,OU),this._canvas.width=i.canvasSize.width,this._canvas.height=i.canvasSize.height,this._context.font=t.fontDesc,this._context.textAlign=RU[e.horizontalAlign],this._context.textBaseline="alphabetic"}_calculateFillTextStartPosition(t,e,i){let s=0;2===e.horizontalAlign?s=i.canvasSize.width-i.canvasPadding.width:1===e.horizontalAlign&&(s=(i.canvasSize.width-i.canvasPadding.width)/2);const r=this._getLineHeight(e.lineHeight,t.actualFontSize,t.fontSize)*(i.parsedString.length-1);let n=t.actualFontSize*(1-AB/2);if(0!==e.verticalAlign){let s=r+i.canvasPadding.height+t.actualFontSize-i.canvasSize.height;2===e.verticalAlign?(s+=AB/2*t.actualFontSize,n-=s):n-=s/2}n+=LU*t.actualFontSize,i.startPosition.set(s+i.canvasPadding.x,n+i.canvasPadding.y)}_updateTexture(t,e,i,s){if(!this._context||!this._canvas)return;this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._context.font=t.fontDesc,this._calculateFillTextStartPosition(t,e,i);const r=this._getLineHeight(e.lineHeight,t.actualFontSize,t.fontSize);this._context.lineJoin="round",t.isOutlined?(this._context.fillStyle=`rgba(${t.outlineColor.r}, ${t.outlineColor.g}, ${t.outlineColor.b}, ${FU})`,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)):(this._context.fillStyle=`rgba(${t.color.r}, ${t.color.g}, ${t.color.b}, ${FU})`,this._context.fillRect(0,0,this._canvas.width,this._canvas.height)),this._context.fillStyle=`rgb(${t.color.r}, ${t.color.g}, ${t.color.b})`;const n=new Qs(i.startPosition.x,i.startPosition.y),o=n.x;let a=0;this._drawTextEffect(n,r,t,e,i);for(let e=0;e<i.parsedString.length;++e)a=n.y+e*r,t.hasShadow&&(this._setupShadow(t),this._context.fillText(i.parsedString[e],o,a)),t.isOutlined&&(this._setupOutline(t),this._context.strokeText(i.parsedString[e],o,a)),t.hasShadow&&!t.isOutlined||this._context.fillText(i.parsedString[e],o,a);t.hasShadow&&(this._context.shadowColor="transparent"),this._uploadTexture(s)}_uploadTexture(t){if(t.texture&&this._canvas){let e;e=t.texture instanceof yB?t.texture.texture:t.texture,0!==this._canvas.width&&0!==this._canvas.height&&(e.getGFXTexture(),e.getGFXSampler(),e.reset({width:this._canvas.width,height:this._canvas.height,mipmapLevel:1}),e.uploadData(this._canvas),e.setWrapMode(2,2),t.texture instanceof yB&&(t.texture.rect=new Cr(0,0,this._canvas.width,this._canvas.height),t.texture._calculateUV()),h.director.root&&h.director.root.batcher2D&&h.director.root.batcher2D._releaseDescriptorSetCache(e.getHash()))}}_drawTextEffect(t,e,i,s,r){if(!i.hasShadow&&!i.isOutlined&&!i.isUnderline)return;const n=r.parsedString.length>1&&i.hasShadow,o=this._measureText(this._context,i.fontDesc);let a=0,h=0;for(let l=0;l<r.parsedString.length;++l)if(a=t.x,h=t.y+l*e,n&&(i.hasShadow&&(this._setupShadow(i),this._context.fillText(r.parsedString[l],a,h)),i.isOutlined&&(this._setupOutline(i),this._context.strokeText(r.parsedString[l],a,h)),i.hasShadow&&!i.isOutlined||this._context.fillText(r.parsedString[l],a,h)),i.isUnderline){const e=o(r.parsedString[l]),n=new Qs;2===s.horizontalAlign?n.x=t.x-e:1===s.horizontalAlign?n.x=t.x-e/2:n.x=t.x,n.y=h+i.actualFontSize/8,this._context.fillRect(n.x,n.y,e,i.underlineHeight*this._fontScale)}n&&(this._context.shadowColor="transparent")}_setupOutline(t){this._context.shadowBlur=0,this._context.shadowOffsetX=0,this._context.shadowOffsetY=0,this._context.strokeStyle=`rgba(${t.outlineColor.r}, ${t.outlineColor.g}, ${t.outlineColor.b}, ${t.outlineColor.a/255})`,this._context.lineWidth=2*t.outlineWidth*this._fontScale}_setupShadow(t){const e=this._fontScale;this._context.shadowColor=`rgba(${t.shadowColor.r}, ${t.shadowColor.g}, ${t.shadowColor.b}, ${t.shadowColor.a/255})`,this._context.shadowBlur=t.shadowBlur*e,this._context.shadowOffsetX=t.shadowOffsetX*e,this._context.shadowOffsetY=-t.shadowOffsetY*e}generateVertexData(t,e,i,s,r,n,o){t?this._updateQuads(e,i,s,r,n,o):(this.updateQuatCount(r),o(e,s,r))}updateQuatCount(t){const e=t.vertexBuffer,i=t.quadCount;if(e.length!==i){for(let t=e.length;t<i;t++)e.push({x:0,y:0,z:0,u:0,v:0,color:_r.WHITE.clone()});e.length=i}}_setupBMFontOverflowMetrics(t,e){let i=e.nodeContentSize.width,s=e.nodeContentSize.height;3===t.overFlow&&(s=0),0===t.overFlow&&(i=0,s=0),t.textWidthTemp=i,t.textHeightTemp=s,t.textDimensions.width=i,t.textDimensions.height=s,t.maxLineWidth=i}_updateFontScale(t){t.bmfontScale=t.actualFontSize/(t.originFontSize*this._fontScale)}_computeHorizontalKerningForText(t,e,i){const s=i,r=s.length;if(!t.fntConfig)return;const n=t.fntConfig.kerningDict,o=e.horizontalKerning;if(!n||0===n.length)return;let a=-1;for(let t=0;t<r;++t){const e=s.charCodeAt(t),i=n[a<<16|65535&e]||0;o[t]=t<r-1?i:0,a=e}}_alignText(t,e,i,s){this._multilineTextWrap(t,e,i,s,this._getFirstWordLen),2===e.overFlow&&(t.fontSize>0&&this._isVerticalClamp(t,e,i,s,this)&&this._shrinkLabelToContentSize(t,e,i,s,this._isVerticalClamp),t.fontSize>0&&this._isHorizontalNeedShrink(e,i)&&this._shrinkLabelToContentSize(t,e,i,s,this._isHorizontalClamp)),this._parsedString(i,s)}_parsedString(t,e){let i=[],s="";for(let t=0,r=0,n=WB(e);t<n;++t){const e=this._lettersInfo[t];e.valid&&(r===e.line?s+=e.char:(i=i.concat(s),r=e.line,s=""))}i=i.concat(s),t.parsedString=i}_multilineTextWrap(t,e,i,s,r){e.linesWidth.length=0;const n=s,o=n.length;let a=0,h=0,l=0,c=0,u=0,d=0,p=0,_=null;for(let i=0;i<o;){let s=jB(n,i);if("\n"===s){e.linesWidth.push(u),u=0,a++,h=0,l-=e.lineHeight*this._getFontScale(t,e)+0,this._recordPlaceholderInfo(i,s),i++;continue}const g=r(t,e,n,i,o);let f=d,m=p,y=u,v=h,b=!1;const w=new Qs;for(let r=0;r<g;++r){const c=i+r;if(s=jB(n,c),"\r"===s){this._recordPlaceholderInfo(c,s);continue}if(_=FR.fontAtlas.getLetterDefinitionForChar(s,FR),!_){this._recordPlaceholderInfo(c,s),null!=t.fntConfig?N(16354,t.fntConfig.atlasName,s):N(16355,t.fontFamily,s);continue}const d=v+_.offsetX*t.bmfontScale-FR.margin;if(e.wrapping&&e.maxLineWidth>0&&h>0&&d+_.w*t.bmfontScale>e.maxLineWidth&&!HB(s)){e.linesWidth.push(u),u=0,a++,h=0,l-=e.lineHeight*this._getFontScale(t,e)+0,b=!0;break}w.x=d,w.y=l-_.offsetY*t.bmfontScale,this._recordLetterInfo(w,s,c,a),c+1<e.horizontalKerning.length&&c<o-1&&(v+=e.horizontalKerning[c+1]*t.bmfontScale),v+=_.xAdvance*t.bmfontScale+e.spacingX,y=w.x+_.w*t.bmfontScale,f<w.y&&(f=w.y),m>w.y-_.h*t.bmfontScale&&(m=w.y-_.h*t.bmfontScale)}b||(h=v,u=y,d<f&&(d=f),p>m&&(p=m),c<u&&(c=u),i+=g)}return e.linesWidth.push(u),e.numberOfLines=a+1,e.textDesiredHeight=e.numberOfLines*e.lineHeight*this._getFontScale(t,e),e.numberOfLines>1&&(e.textDesiredHeight+=0*(e.numberOfLines-1)),i.nodeContentSize.width=e.textWidthTemp,i.nodeContentSize.height=e.textHeightTemp,e.textWidthTemp<=0&&(i.nodeContentSize.width=parseFloat(c.toFixed(2))+2*FR.margin),e.textHeightTemp<=0&&(i.nodeContentSize.height=parseFloat(e.textDesiredHeight.toFixed(2))+2*FR.margin),e.tailoredTopY=i.nodeContentSize.height,e.tailoredBottomY=0,d>0&&(e.tailoredTopY=i.nodeContentSize.height+d),p<-e.textDesiredHeight&&(e.tailoredBottomY=e.textDesiredHeight+p),!0}_recordPlaceholderInfo(t,e){if(t>=this._lettersInfo.length){const t=new zU;this._lettersInfo.push(t)}this._lettersInfo[t].char=e,this._lettersInfo[t].hash=`${$B(e,0)}${FR.hash}`,this._lettersInfo[t].valid=!1}_recordLetterInfo(t,e,i,s){if(i>=this._lettersInfo.length){const t=new zU;this._lettersInfo.push(t)}const r=`${$B(e,0)}${FR.hash}`;this._lettersInfo[i].line=s,this._lettersInfo[i].char=e,this._lettersInfo[i].hash=r,this._lettersInfo[i].valid=FR.fontAtlas.getLetter(r).valid,this._lettersInfo[i].x=t.x,this._lettersInfo[i].y=t.y}_getFirstWordLen(t,e,i,s,r){let n=jB(i,s);if(VB(n)||"\n"===n||HB(n))return 1;let o=1,a=FR.fontAtlas.getLetterDefinitionForChar(n,FR);if(!a)return o;let h=a.xAdvance*t.bmfontScale+e.spacingX,l=0;for(let c=s+1;c<r&&(n=jB(i,c),a=FR.fontAtlas.getLetterDefinitionForChar(n,FR),a);++c){if(l=h+a.offsetX*t.bmfontScale,l+a.w*t.bmfontScale>e.maxLineWidth&&!HB(n)&&e.maxLineWidth>0)return o;if(h+=a.xAdvance*t.bmfontScale+e.spacingX,"\n"===n||HB(n)||VB(n))break;o++}return o}_computeAlignmentOffset(t,e,i){switch(e.linesOffsetX.length=0,e.letterOffsetY=0,e.horizontalAlign){case 0:for(let t=0;t<e.numberOfLines;++t)e.linesOffsetX.push(0);break;case 1:for(let t=0,s=e.linesWidth.length;t<s;t++)e.linesOffsetX.push((i.nodeContentSize.width-e.linesWidth[t])/2);break;case 2:for(let t=0,s=e.linesWidth.length;t<s;t++)e.linesOffsetX.push(i.nodeContentSize.width-e.linesWidth[t])}if(e.letterOffsetY=i.nodeContentSize.height,0!==e.verticalAlign){const s=i.nodeContentSize.height-e.textDesiredHeight+e.lineHeight*this._getFontScale(t,e)-t.originFontSize*this._fontScale*t.bmfontScale;2===e.verticalAlign?e.letterOffsetY-=s:e.letterOffsetY-=s/2}}_getFontScale(t,e){return 2===e.overFlow?t.bmfontScale:1}_isVerticalClamp(t,e,i,s,r){return e.textDesiredHeight>i.nodeContentSize.height}_isHorizontalClamp(t,e,i,s,r){let n=!1;for(let o=0,a=WB(s);o<a;++o){const s=r._lettersInfo[o];if(s.valid){const r=FR.fontAtlas.getLetterDefinitionForChar(s.char,FR);if(!r)continue;const o=s.x+r.w*t.bmfontScale,a=s.line;if(e.textWidthTemp>0)if(e.wrapping){if(e.linesWidth[a]>i.nodeContentSize.width&&(o>i.nodeContentSize.width||o<0)){n=!0;break}}else if(o>i.nodeContentSize.width){n=!0;break}}}return n}_isHorizontalNeedShrink(t,e){let i=0;for(let s=0,r=t.linesWidth.length;s<r;++s)if(i=t.linesWidth[s],i>e.nodeContentSize.width)return!0;return!1}_shrinkLabelToContentSize(t,e,i,s,r){let n=0,o=0|t.actualFontSize,a=0;for(;n<o;){a=n+o+1>>1;const h=a;if(h<=0)break;t.bmfontScale=h/(t.originFontSize*this._fontScale),this._multilineTextWrap(t,e,i,s,this._getFirstWordLen),this._computeAlignmentOffset(t,e,i),r(t,e,i,s,this)?o=a-1:n=a}n>=0&&this._scaleFontSizeDown(t,e,i,s,n)}_scaleFontSizeDown(t,e,i,s,r){let n=!0;r||(r=.1,n=!1),t.actualFontSize=r,n&&(this._updateFontScale(t),this._multilineTextWrap(t,e,i,s,this._getFirstWordLen))}_updateQuads(t,e,i,s,r,n){const o=t.spriteFrame?t.spriteFrame.texture:FR.fontAtlas.getTexture(),a=s.uiTransAnchorX*i.nodeContentSize.width,h=s.uiTransAnchorY*i.nodeContentSize.height;for(let l=0,c=WB(r);l<c;++l){const r=this._lettersInfo[l];if(!r.valid)continue;const c=FR.fontAtlas.getLetter(r.hash);if(!c){G(16353);continue}this._tmpRect.height=c.h,this._tmpRect.width=c.w,this._tmpRect.x=c.u,this._tmpRect.y=c.v;let u=r.y+e.letterOffsetY;if(e.textHeightTemp>0){if(u>e.tailoredTopY){const t=u-e.tailoredTopY;this._tmpRect.y+=t,this._tmpRect.height-=t,u-=t}u-this._tmpRect.height*t.bmfontScale<e.tailoredBottomY&&1===e.overFlow&&(this._tmpRect.height=u<e.tailoredBottomY?0:(u-e.tailoredBottomY)/t.bmfontScale)}const d=r.line,p=r.x+c.w/2*t.bmfontScale+e.linesOffsetX[d];if(e.textWidthTemp>0&&this._isHorizontalClamped(e,i,p,d)&&1===e.overFlow&&(this._tmpRect.width=0),this._tmpRect.height>0&&this._tmpRect.width>0){const l=this._determineRect(t),c=r.x+e.linesOffsetX[r.line],d=s.quadCount;s.quadCount+=4,this.updateQuatCount(s),n(t,i,s,d,o,this._tmpRect,l,c-a,u-h)}}return!0}_isHorizontalClamped(t,e,i,s){const r=t.linesWidth[s],n=i>e.nodeContentSize.width||i<0;return t.wrapping?r>e.nodeContentSize.width&&n:n}_determineRect(t){const e=t.spriteFrame;if(!e)return!1;const i=e.isRotated(),s=e.getOriginalSize(),r=e.getRect(),n=e.getOffset(),o=n.x+(s.width-r.width)/2,a=n.y-(s.height-r.height)/2;if(i){const t=this._tmpRect.x;this._tmpRect.x=r.x+r.height-this._tmpRect.y-this._tmpRect.height-a,this._tmpRect.y=t+r.y-o,this._tmpRect.y<0&&(this._tmpRect.height+=a)}else this._tmpRect.x+=r.x-o,this._tmpRect.y+=r.y+a;return i}}kU.instance=void 0,kU.instance=new kU;const NU=new LR(64,64),UU=new TR(null);let VU=null,HU=null,GU=null,WU=null,jU=null;const $U={updateProcessingData(t,e,i,s,r,n){t.fontSize=r.fontSize,t.actualFontSize=r.fontSize,t.originFontSize=GU?GU.fontSize:r.fontSize,e.horizontalAlign=r.horizontalAlign,e.verticalAlign=r.verticalAlign,e.spacingX=r.spacingX;const o=r.overflow;e.overFlow=o,e.lineHeight=r.lineHeight,i.nodeContentSize.width=n.width,i.nodeContentSize.height=n.height,0===o?(e.wrapping=!1,i.nodeContentSize.width+=2*FR.margin,i.nodeContentSize.height+=2*FR.margin):3===o?(e.wrapping=!0,i.nodeContentSize.height+=2*FR.margin):e.wrapping=r.enableWrapText,s.uiTransAnchorX=n.anchorX,s.uiTransAnchorY=n.anchorY,FR.lineHeight=r.lineHeight,FR.fontSize=r.fontSize,t.spriteFrame=WU,t.fntConfig=GU,t.fontFamily=FR.fontFamily,t.color.set(r.color)},updateRenderData(t){if(t.renderData&&VU!==t){if(t.renderData.vertDirty){VU=t,HU=VU.node._uiProps.uiTransformComp;const e=t.renderData,i=kU.instance,s=t.textStyle,r=t.textLayout,n=t.textLayoutData,o=t.textRenderData;s.fontScale=yP.getScaleX(),this._updateFontFamily(t),this.updateProcessingData(s,r,n,o,t,HU),this._updateLabelInfo(t),s.fontDesc=FR.fontDesc,i.processingString(!0,s,r,n,t.string),o.quadCount=0,i.generateRenderInfo(!0,s,r,n,o,t.string,this.generateVertexData),e.dataLength!==o.quadCount&&(this.resetRenderData(t),e.dataLength=o.quadCount,e.resize(e.dataLength,e.dataLength/2*3));const a=e.data;for(let t=0,e=o.quadCount;t<e;t++)a[t]=o.vertexBuffer[t];const h=e.indexCount;this.createQuadIndices(h),e.chunk.setIndexBuffer(jU),VU.actualFontSize=s.actualFontSize,HU.setContentSize(n.nodeContentSize),this.updateUVs(t),e.vertDirty=!1,VU=null,this._resetProperties()}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},updateUVs(t){const e=t.renderData,i=e.chunk.vb,s=e.vertexCount,r=e.data;let n=3;for(let t=0;t<s;t++){const e=r[t];i[n]=e.u,i[n+1]=e.v,n+=9}},updateColor(t){},resetRenderData(t){const e=t.renderData;e.dataLength=0,e.resize(0,0)},generateVertexData(t,e,i,s,r,n,o,a,h){const l=s,c=t.bmfontScale,u=i.vertexBuffer,d=r.width,p=r.height,_=n.width,g=n.height;let f=0,m=0,y=0,v=0;o?(f=n.x/d,v=(n.x+g)/d,m=(n.y+_)/p,y=n.y/p,u[l].u=f,u[l].v=y,u[l+1].u=f,u[l+1].v=m,u[l+2].u=v,u[l+2].v=y,u[l+3].u=v,u[l+3].v=m):(f=n.x/d,v=(n.x+_)/d,m=(n.y+g)/p,y=n.y/p,u[l].u=f,u[l].v=m,u[l+1].u=v,u[l+1].v=m,u[l+2].u=f,u[l+2].v=y,u[l+3].u=v,u[l+3].v=y),u[l].x=a,u[l].y=h-g*c,u[l+1].x=a+_*c,u[l+1].y=h-g*c,u[l+2].x=a,u[l+2].y=h,u[l+3].x=a+_*c,u[l+3].y=h},_updateFontFamily(t){const e=t.font;WU=e.spriteFrame,GU=e.fntConfig,FR.fontAtlas=e.fontDefDictionary,FR.fontAtlas||(2===t.cacheMode?FR.fontAtlas=NU:FR.fontAtlas=UU),IP.packToDynamicAtlas(t,WU)},_updateLabelInfo(t){FR.hash="",FR.margin=0},_resetProperties(){GU=null,WU=null,FR.hash="",FR.margin=0},createQuadIndices(t){if(t%6!=0)return void j(16308);const e=t/6;jU=new Uint16Array(t);let i=0;for(let t=0;t<e;t++)jU[i++]=0+4*t,jU[i++]=1+4*t,jU[i++]=2+4*t,jU[i++]=1+4*t,jU[i++]=3+4*t,jU[i++]=2+4*t}},qU=new _r(255,255,255,255),XU={createData(t){const e=t.requestRenderData();return e.resize(0,0),e},fillBuffers(t,e){const i=t.node;qU.set(t.color),qU.a=255*i._uiProps.opacity,r_(i,0,t.renderData,qU)},appendQuad(t,e,i,s,r,n,o){const a=t.renderData;if(!a)return;const h=a.dataLength;a.dataLength+=4,a.resize(a.dataLength,a.dataLength/2*3);const l=a.data,c=e.width,u=e.height,d=i.width,p=i.height;let _=0,g=0,f=0,m=0;s?(_=i.x/c,m=(i.x+p)/c,g=(i.y+d)/u,f=i.y/u,l[h].u=_,l[h].v=f,l[h+1].u=_,l[h+1].v=g,l[h+2].u=m,l[h+2].v=f,l[h+3].u=m,l[h+3].v=g):(_=i.x/c,m=(i.x+d)/c,g=(i.y+p)/u,f=i.y/u,l[h].u=_,l[h].v=g,l[h+1].u=m,l[h+1].v=g,l[h+2].u=_,l[h+2].v=f,l[h+3].u=m,l[h+3].v=f),l[h].x=r,l[h].y=n-p*o,l[h+1].x=r+d*o,l[h+1].y=n-p*o,l[h+2].x=r,l[h+2].y=n,l[h+3].x=r+d*o,l[h+3].y=n}};St(XU,$U);let YU=null;const QU=xt($U,{getAssemblerData:()=>(YU||(YU=new LR(1024,1024)),YU.getTexture()),_updateFontFamily(t){FR.fontAtlas=YU,FR.fontFamily=this._getFontFamily(t),t.enableOutline&&t.outlineWidth>0?(FR.isOutlined=!0,FR.margin=t.outlineWidth,FR.out=t.outlineColor.clone(),FR.out.a=t.outlineColor.a*t.color.a/255):(FR.isOutlined=!1,FR.margin=0)},_getFontFamily(t){let e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo(t){FR.fontDesc=this._getFontDesc(),FR.color=t.color,FR.hash=zR(FR)},_getFontDesc(){let t=`${FR.fontSize.toString()}px `;return t+=FR.fontFamily,t}}),KU=new _r(255,255,255,255),ZU={createData(t){const e=t.requestRenderData();return e.resize(0,0),e},fillBuffers(t,e){if(!t.renderData)return;const i=t.node;KU.a=255*i._uiProps.opacity,r_(i,0,t.renderData,KU)},updateColor(t){}};St(ZU,QU),ML.Overflow;const JU={updateProcessingData(t,e,i,s,r,n){t.isSystemFontUsed=r.useSystemFont,t.fontSize=r.fontSize,i.nodeContentSize.width=i.canvasSize.width=n.width,i.nodeContentSize.height=i.canvasSize.height=n.height,e.lineHeight=r.lineHeight,e.overFlow=r.overflow,0===r.overflow?e.wrapping=!1:3===r.overflow?e.wrapping=!0:e.wrapping=r.enableWrapText,t.isBold=r.isBold,t.isItalic=r.isItalic,t.isUnderline=r.isUnderline,t.underlineHeight=r.underlineHeight,r.enableOutline&&r.outlineWidth>0?(t.isOutlined=!0,t.outlineColor.set(r.outlineColor),t.outlineWidth=r.outlineWidth):t.isOutlined=!1,r.enableShadow&&(r.shadowBlur>0||!gi(r.shadowOffset.x,0)||!gi(r.shadowOffset.y,0))?(t.hasShadow=!0,t.shadowColor.set(r.shadowColor),t.shadowBlur=r.shadowBlur,t.shadowOffsetX=r.shadowOffset.x,t.shadowOffsetY=r.shadowOffset.y):t.hasShadow=!1,t.color.set(r.color),s.texture=r.spriteFrame,s.uiTransAnchorX=n.anchorX,s.uiTransAnchorY=n.anchorY,e.horizontalAlign=r.horizontalAlign,e.verticalAlign=r.verticalAlign},getAssemblerData(){const t=ML._canvasPool.get();return t.canvas.width=t.canvas.height=1,t},resetAssemblerData(t){t&&ML._canvasPool.put(t)},updateRenderData(t){if(t.renderData){if(t.renderData.vertDirty){const e=t.node._uiProps.uiTransformComp,i=kU.instance,s=t.textStyle,r=t.textLayout,n=t.textLayoutData,o=t.textRenderData;s.fontScale=yP.getScaleX(),this.updateProcessingData(s,r,n,o,t,e),i.setCanvasUsed(t.assemblerData.canvas,t.assemblerData.context),s.fontFamily=this._updateFontFamily(t),this._resetDynamicAtlas(t),i.processingString(!1,s,r,n,t.string),i.generateRenderInfo(!1,s,r,n,o,t.string,this.generateVertexData);const a=t.renderData;a.textureDirty=!0,this._calDynamicAtlas(t,n),t.actualFontSize=s.actualFontSize,e.setContentSize(n.nodeContentSize);const h=a.data;h[0]=o.vertexBuffer[0],h[1]=o.vertexBuffer[1],h[2]=o.vertexBuffer[2],h[3]=o.vertexBuffer[3],this.updateUVs(t),t.renderData.vertDirty=!1,t.contentWidth=n.nodeContentSize.width}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},generateVertexData(t,e,i){const s=i.vertexBuffer,r=e.nodeContentSize.width,n=e.nodeContentSize.height,o=i.uiTransAnchorX*r,a=i.uiTransAnchorY*n;s[0].x=-o,s[0].y=-a,s[1].x=r-o,s[1].y=-a,s[2].x=-o,s[2].y=n-a,s[3].x=r-o,s[3].y=n-a},updateVertexData(t){},updateUVs(t){},_updateFontFamily(t){let e="";return e=t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial",e},_calDynamicAtlas(t,e){if(1!==t.cacheMode||e.canvasSize.width<=0||e.canvasSize.height<=0)return;const i=t.ttfSpriteFrame;IP.packToDynamicAtlas(t,i)},_resetDynamicAtlas(t){if(1!==t.cacheMode)return;const e=t.ttfSpriteFrame;IP.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()}},tV=_r.WHITE.clone(),eV=Uint16Array.from([0,1,2,1,3,2]),iV={createData(t){const e=t.requestRenderData();e.dataLength=4,e.resize(4,6),t.textRenderData.quadCount=4;const i=e.chunk.vb;i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;let s=5;for(let t=0;t<4;t++)_r.toArray(i,tV,s),s+=9;return e.chunk.setIndexBuffer(eV),e},fillBuffers(t,e){const i=t.renderData,s=i.chunk,r=i.data,n=t.node,o=s.vb,a=n.worldMatrix,h=i.floatStride;let l=0;const c=r.length;for(let t=0;t<c;t++){const e=r[t],i=e.x,s=e.y;let n=a.m03*i+a.m07*s+a.m15;n=n?1/n:1,l=t*h,o[l+0]=(a.m00*i+a.m04*s+a.m12)*n,o[l+1]=(a.m01*i+a.m05*s+a.m13)*n,o[l+2]=(a.m02*i+a.m06*s+a.m14)*n}const u=s.vertexOffset,d=s.meshBuffer,p=s.meshBuffer.iData;let _=d.indexOffset;p[_++]=u,p[_++]=u+1,p[_++]=u+2,p[_++]=u+2,p[_++]=u+1,p[_++]=u+3,d.indexOffset+=6},updateVertexData(t){const e=t.renderData;if(!e)return;const i=t.node._uiProps.uiTransformComp,s=i.width,r=i.height,n=i.anchorX*s,o=i.anchorY*r,a=e.data;a[0].x=-n,a[0].y=-o,a[1].x=s-n,a[1].y=-o,a[2].x=-n,a[2].y=r-o,a[3].x=s-n,a[3].y=r-o},updateUVs(t){const e=t.renderData;if(!e||!t.ttfSpriteFrame)return;const i=e.chunk.vb,s=t.ttfSpriteFrame.uv;i[3]=s[0],i[4]=s[1],i[12]=s[2],i[13]=s[3],i[21]=s[4],i[22]=s[5],i[30]=s[6],i[31]=s[7]},updateColor(t){}};St(iV,JU);const sV=t("labelAssembler",{getAssembler(t){let e=iV;return t.font instanceof CR?e=XU:2===t.cacheMode&&(e=ZU),e}});ML.Assembler=sV,ZF.FillType;const rV=new Rs,nV=Uint16Array.from([0,1,2,1,3,2]),oV={updateRenderData(t){const e=t.spriteFrame;IP.packToDynamicAtlas(t,e);const i=t.renderData;if(i&&e){if(!i.vertDirty)return;let s=t.fillStart,r=t.fillRange;r<0&&(s+=r,r=-r),r=s+r,s=s>1?1:s,s=s<0?0:s,r=r>1?1:r,r=r<0?0:r,r-=s,r=r<0?0:r;let n=s+r;n=n>1?1:n,this.updateUVs(t,s,n),this.updateVertexData(t,s,n),i.updateRenderData(t,e)}},updateUVs(t,e,i){const s=t.spriteFrame,r=t.renderData.chunk.vb,n=s.width,o=s.height,a=s.rect;let h=0,l=0,c=0,u=0,d=0,p=0,_=0,g=0,f=0,m=0,y=0,v=0;switch(s.isRotated()?(h=a.x/n,l=(a.y+a.width)/o,c=(a.x+a.height)/n,u=a.y/o,d=_=h,f=y=c,g=v=l,p=m=u):(h=a.x/n,l=(a.y+a.height)/o,c=(a.x+a.width)/n,u=a.y/o,d=f=h,_=y=c,p=g=l,m=v=u),t.fillType){case 0:r[3]=d+(_-d)*e,r[4]=p+(g-p)*e,r[12]=d+(_-d)*i,r[13]=p+(g-p)*i,r[21]=f+(y-f)*e,r[22]=m+(v-m)*e,r[30]=f+(y-f)*i,r[31]=m+(v-m)*i;break;case 1:r[3]=d+(f-d)*e,r[4]=p+(m-p)*e,r[12]=_+(y-_)*e,r[13]=g+(v-g)*e,r[21]=d+(f-d)*i,r[22]=p+(m-p)*i,r[30]=_+(y-_)*i,r[31]=g+(v-g)*i;break;default:j(2626)}},updateVertexData(t,e,i){const s=t.renderData.data,r=t.node._uiProps.uiTransformComp,n=r.width,o=r.height,a=r.anchorX*n,h=r.anchorY*o;let l=-a,c=-h,u=n-a,d=o-h,p=0,_=0;switch(t.fillType){case 0:p=l+(u-l)*e,_=l+(u-l)*i,l=p,u=_;break;case 1:p=c+(d-c)*e,_=c+(d-c)*i,c=p,d=_;break;default:j(2626)}s[0].x=l,s[0].y=c,s[1].x=u,s[1].y=c,s[2].x=l,s[2].y=d,s[3].x=u,s[3].y=d},createData(t){const e=t.requestRenderData();e.dataLength=4,e.resize(4,6),e.chunk.setIndexBuffer(nV);const i=e.data;for(const t of i)t.z=0;return e},updateWorldVertexData(t,e){t.node.getWorldMatrix(rV);const i=t.renderData.floatStride,s=t.renderData.data,r=e.vb;let n=0;for(let t=0;t<4;t++){const e=s[t],o=e.x,a=e.y;let h=rV.m03*o+rV.m07*a+rV.m15;h=h?1/h:1,n=t*i,r[n]=(rV.m00*o+rV.m04*a+rV.m12)*h,r[n+1]=(rV.m01*o+rV.m05*a+rV.m13)*h,r[n+2]=(rV.m02*o+rV.m06*a+rV.m14)*h}},fillBuffers(t,e){const i=t.renderData,s=i.chunk;(t._flagChangedVersion!==t.node.flagChangedVersion||i.vertDirty)&&(this.updateWorldVertexData(t,s),i.vertDirty=!1,t._flagChangedVersion=t.node.flagChangedVersion),s.bufferId;const r=s.vertexOffset,n=s.meshBuffer,o=s.meshBuffer.iData;let a=n.indexOffset;o[a++]=r,o[a++]=r+1,o[a++]=r+2,o[a++]=r+2,o[a++]=r+1,o[a++]=r+3,n.indexOffset+=6},updateColor(t){const e=t.renderData,i=e.chunk.vb,s=e.floatStride;let r=5;const n=t.color,o=n.r/255,a=n.g/255,h=n.b/255,l=t.node._uiProps.opacity;for(let t=0;t<4;t++)i[r]=o,i[r+1]=a,i[r+2]=h,i[r+3]=l,r+=s}},aV=2*Math.PI,hV=1e-6,lV=new Rs,cV=[new Qs,new Qs,new Qs,new Qs],uV=new Array(4),dV=new Array(8),pV=[new Qs,new Qs,new Qs,new Qs],_V=[new Qs,new Qs,new Qs,new Qs],gV=new Qs,fV=[new Qs,new Qs,new Qs,new Qs];let mV=null;function yV(t,e,i,s,r,n,o){let a=Math.sin(n);a=Math.abs(a)>hV?a:0;let h=Math.cos(n);h=Math.abs(h)>hV?h:0;let l=0,c=0;if(0!==h){if(l=a/h,(t-r.x)*h>0){const e=r.y+l*(t-r.x);o[0].x=t,o[0].y=e}if((e-r.x)*h>0){const t=r.y+l*(e-r.x);o[2].x=e,o[2].y=t}}if(0!==a){if(c=h/a,(s-r.y)*a>0){const t=r.x+c*(s-r.y);o[3].x=t,o[3].y=s}if((i-r.y)*a>0){const t=r.x+c*(i-r.y);o[1].x=t,o[1].y=i}}}function vV(t){const e=t.node._uiProps.uiTransformComp,i=e.width,s=e.height,r=e.anchorX*i,n=e.anchorY*s,o=-r,a=-n,h=i-r,l=s-n,c=uV;c[0]=o,c[1]=a,c[2]=h,c[3]=l;const u=t.fillCenter,d=gV.x=Math.min(Math.max(0,u.x),1)*(h-o)+o,p=gV.y=Math.min(Math.max(0,u.y),1)*(l-a)+a;cV[0].x=cV[3].x=o,cV[1].x=cV[2].x=h,cV[0].y=cV[1].y=a,cV[2].y=cV[3].y=l;for(const t of fV)Qs.set(t,0,0);d!==c[0]&&Qs.set(fV[0],3,0),d!==c[2]&&Qs.set(fV[2],1,2),p!==c[1]&&Qs.set(fV[1],0,1),p!==c[3]&&Qs.set(fV[3],2,3)}function bV(t){const e=t.width,i=t.height,s=t.getRect();let r=0,n=0,o=0,a=0;const h=dV;t.isRotated()?(r=s.x/e,n=(s.x+s.height)/e,o=s.y/i,a=(s.y+s.width)/i,h[0]=h[2]=r,h[4]=h[6]=n,h[3]=h[7]=a,h[1]=h[5]=o):(r=s.x/e,n=(s.x+s.width)/e,o=s.y/i,a=(s.y+s.height)/i,h[0]=h[4]=r,h[2]=h[6]=n,h[1]=h[3]=a,h[5]=h[7]=o)}function wV(t,e){const i=e.x-t.x,s=e.y-t.y;if(0===i&&0===s)return 0;if(0===i)return s>0?.5*Math.PI:1.5*Math.PI;{let t=Math.atan(s/i);return i<0&&(t+=Math.PI),t}}function SV(t,e,i,s,r){const n=uV,o=n[0],a=n[1],h=n[2],l=n[3];t[e].x=i.x,t[e].y=i.y,t[e+1].x=s.x,t[e+1].y=s.y,t[e+2].x=r.x,t[e+2].y=r.y;let c=0,u=0;c=(i.x-o)/(h-o),u=(i.y-a)/(l-a),xV(c,u,t,e),c=(s.x-o)/(h-o),u=(s.y-a)/(l-a),xV(c,u,t,e+1),c=(r.x-o)/(h-o),u=(r.y-a)/(l-a),xV(c,u,t,e+2)}function xV(t,e,i,s){const r=dV,n=r[0]+(r[2]-r[0])*t,o=r[4]+(r[6]-r[4])*t,a=r[1]+(r[3]-r[1])*t,h=r[5]+(r[7]-r[5])*t,l=i[s];l.u=n+(o-n)*e,l.v=a+(h-a)*e}const TV={useModel:!1,createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.spriteFrame;IP.packToDynamicAtlas(t,e),this.updateUVs(t);const i=t.renderData;if(i&&e){if(!i.vertDirty)return;const s=i.data;let r=t.fillStart,n=t.fillRange;for(n<0&&(r+=n,n=-n);r>=1;)r-=1;for(;r<0;)r+=1;r*=aV,n*=aV;const o=r+n;vV(t),bV(e),yV(uV[0],uV[2],uV[1],uV[3],gV,r,pV),yV(uV[0],uV[2],uV[1],uV[3],gV,r+n,_V);let a=0;for(let t=0;t<4;++t){const e=fV[t];if(!e)continue;if(n>=aV){i.dataLength=a+3,SV(s,a,gV,cV[e.x],cV[e.y]),a+=3;continue}let h=wV(gV,cV[e.x]),l=wV(gV,cV[e.y]);l<h&&(l+=aV),h-=aV,l-=aV;for(let n=0;n<3;++n)h>=o||(h>=r?(i.dataLength=a+3,SV(s,a,gV,cV[e.x],l>=o?_V[t]:cV[e.y]),a+=3):l>r&&(l<=o?(i.dataLength=a+3,SV(s,a,gV,pV[t],cV[e.y]),a+=3):(i.dataLength=a+3,SV(s,a,gV,pV[t],_V[t]),a+=3))),h+=aV,l+=aV}0===a&&(i.dataLength=0),i.resize(a,a),i.updateRenderData(t,e)}},createQuadIndices(t){mV=null,mV=new Uint16Array(t);let e=0;for(let i=0;i<t;i++)mV[e++]=i},fillBuffers(t,e){const i=t.node,s=t.renderData,r=s.chunk;(t._flagChangedVersion!==i.flagChangedVersion||s.vertDirty)&&(this.updateWorldVertexAndUVData(t,r),s.vertDirty=!1,t._flagChangedVersion=i.flagChangedVersion),this.updateColorLate(t),r.bufferId;const n=r.vertexOffset,o=r.meshBuffer,a=r.meshBuffer.iData,h=o.indexOffset;for(let t=0;t<s.indexCount;t++)a[h+t]=n+t;o.indexOffset+=s.indexCount,o.setDirty()},updateWorldUVData(t,e){const i=t.renderData,s=i.floatStride,r=i.data,n=i.chunk.vb;for(let t=0;t<r.length;t++){const e=t*s;n[e+3]=r[t].u,n[e+4]=r[t].v}},updateWorldVertexAndUVData(t,e){t.node.getWorldMatrix(lV);const i=t.renderData,s=i.floatStride,r=t.renderData.data,n=e.vb,o=i.vertexCount;let a=0;for(let t=0;t<o;t++){const e=r[t],i=e.x,o=e.y;let h=lV.m03*i+lV.m07*o+lV.m15;h=h?1/h:1,n[a+0]=(lV.m00*i+lV.m04*o+lV.m12)*h,n[a+1]=(lV.m01*i+lV.m05*o+lV.m13)*h,n[a+2]=(lV.m02*i+lV.m06*o+lV.m14)*h,n[a+3]=e.u,n[a+4]=e.v,a+=s}},updateUVs(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},updateColorLate(t){const e=t.renderData,i=e.chunk.vb,s=e.floatStride,r=e.vertexCount;let n=5;const o=t.color,a=o.r/255,h=o.g/255,l=o.b/255,c=t.node._uiProps.opacity;for(let t=0;t<r;t++)i[n]=a,i[n+1]=h,i[n+2]=l,i[n+3]=c,n+=s},updateColor(t){}},CV=Uint16Array.from([0,1,2,1,3,2]),IV={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.resize(4,6),e.chunk.setIndexBuffer(CV),e},updateRenderData(t){const e=t.spriteFrame;IP.packToDynamicAtlas(t,e),this.updateUVs(t);const i=t.renderData;i&&e&&(i.vertDirty&&this.updateVertexData(t),i.updateRenderData(t,e))},updateWorldVerts(t,e){const i=t.renderData,s=e.vb,r=i.data,n=t.node.worldMatrix,o=n.m00,a=n.m01,h=n.m02,l=n.m03,c=n.m04,u=n.m05,d=n.m06,p=n.m07,_=n.m12,g=n.m13,f=n.m14,m=n.m15,y=i.floatStride;let v=0;const b=r.length;for(let t=0;t<b;++t){const e=r[t],i=e.x,n=e.y;let b=l*i+p*n+m;b=b?1/b:1,v=t*y,s[v+0]=(o*i+c*n+_)*b,s[v+1]=(a*i+u*n+g)*b,s[v+2]=(h*i+d*n+f)*b}},fillBuffers(t,e){if(null===t)return;const i=t.renderData,s=i.chunk;(t._flagChangedVersion!==t.node.flagChangedVersion||i.vertDirty)&&(this.updateWorldVerts(t,s),i.vertDirty=!1,t._flagChangedVersion=t.node.flagChangedVersion);const r=s.vertexOffset,n=s.meshBuffer,o=s.meshBuffer.iData;let a=n.indexOffset;const h=r;o[a++]=h,o[a++]=h+1,o[a++]=h+2,o[a++]=h+1,o[a++]=h+3,o[a++]=h+2,n.indexOffset+=6},updateVertexData(t){const e=t.renderData;if(!e)return;const i=t.node._uiProps.uiTransformComp,s=e.data,r=i.width,n=i.height,o=i.anchorX*r,a=i.anchorY*n;let h=0,l=0,c=0,u=0;if(t.trim)h=-o,l=-a,c=r-o,u=n-a;else{const e=t.spriteFrame,i=e.originalSize,s=r/i.width,d=n/i.height,p=e.trimmedBorder;h=p.x*s-o,l=p.z*d-a,c=r+p.y*s-o,u=n+p.w*d-a}s[0].x=h,s[0].y=l,s[1].x=c,s[1].y=l,s[2].x=h,s[2].y=u,s[3].x=c,s[3].y=u,e.vertDirty=!0},updateUVs(t){if(!t.spriteFrame)return;const e=t.renderData.chunk.vb,i=t.spriteFrame.uv;e[3]=i[0],e[4]=i[1],e[12]=i[2],e[13]=i[3],e[21]=i[4],e[22]=i[5],e[30]=i[6],e[31]=i[7]},updateColor(t){const e=t.renderData,i=e.chunk.vb;let s=5;const r=t.color,n=r.r/255,o=r.g/255,a=r.b/255,h=r.a/255;for(let t=0;t<4;t++,s+=e.floatStride)i[s]=n,i[s+1]=o,i[s+2]=a,i[s+3]=h}},EV=[];for(let t=0;t<4;t++)EV.push({x:0,y:0,z:0,u:0,v:0,color:new _r});const DV={createData(t){const e=t.requestRenderData();return e.dataLength=16,e.resize(16,54),this.QUAD_INDICES=new Uint16Array(54),this.createQuadIndices(4,4),e.chunk.setIndexBuffer(this.QUAD_INDICES),e},createQuadIndices(t,e){let i=0;for(let s=0;s<t-1;s++)for(let t=0;t<e-1;t++){const r=s*e+t;this.QUAD_INDICES[i++]=r,this.QUAD_INDICES[i++]=r+1,this.QUAD_INDICES[i++]=r+e,this.QUAD_INDICES[i++]=r+1,this.QUAD_INDICES[i++]=r+1+e,this.QUAD_INDICES[i++]=r+e}},updateRenderData(t){const e=t.spriteFrame;IP.packToDynamicAtlas(t,e),this.updateUVs(t);const i=t.renderData;i&&e&&(i.vertDirty&&this.updateVertexData(t),i.updateRenderData(t,e))},updateVertexData(t){const e=t.renderData,i=e.data,s=t.node._uiProps.uiTransformComp,r=s.width,n=s.height,o=s.anchorX*r,a=s.anchorY*n,h=t.spriteFrame,l=h.insetLeft,c=h.insetRight,u=h.insetTop,d=h.insetBottom;let p=r-l-c,_=n-u-d,g=r/(l+c),f=n/(u+d);g=Number.isNaN(g)||g>1?1:g,f=Number.isNaN(f)||f>1?1:f,p=p<0?0:p,_=_<0?0:_,EV[0].x=-o,EV[0].y=-a,EV[1].x=l*g-o,EV[1].y=d*f-a,EV[2].x=EV[1].x+p,EV[2].y=EV[1].y+_,EV[3].x=r-o,EV[3].y=n-a;for(let t=0;t<4;t++)for(let s=0;s<4;s++){const r=4*t+s;r<e.dataLength&&t<EV.length&&s<EV.length&&(i[r].x=EV[s].x,i[r].y=EV[t].y)}},fillBuffers(t,e){const i=t.renderData,s=i.chunk;(t._flagChangedVersion!==t.node.flagChangedVersion||i.vertDirty)&&(this.updateWorldVertexData(t,s),i.vertDirty=!1,t._flagChangedVersion=t.node.flagChangedVersion),s.bufferId;const r=s.vertexOffset,n=s.meshBuffer,o=s.meshBuffer.iData;let a=n.indexOffset;for(let t=0;t<3;++t)for(let e=0;e<3;++e){const i=r+4*t+e;o[a++]=i,o[a++]=i+1,o[a++]=i+4,o[a++]=i+1,o[a++]=i+5,o[a++]=i+4}n.indexOffset=a},updateWorldVertexData(t,e){const i=t.renderData,s=i.floatStride,r=i.data,n=e.vb,o=t.node.worldMatrix,a=o.m00,h=o.m01,l=o.m02,c=o.m03,u=o.m04,d=o.m05,p=o.m06,_=o.m07,g=o.m12,f=o.m13,m=o.m14,y=o.m15;let v=0;for(let t=0;t<4;++t){const e=r[4*t];for(let i=0;i<4;++i){const o=r[i].x,b=e.y;let w=c*o+_*b+y;w=w?1/w:1,v=(4*t+i)*s,n[v+0]=(a*o+u*b+g)*w,n[v+1]=(h*o+d*b+f)*w,n[v+2]=(l*o+p*b+m)*w}}},updateUVs(t){if(!t.spriteFrame)return;const e=t.renderData,i=e.chunk.vb,s=e.floatStride,r=t.spriteFrame.uvSliced;let n=3;for(let t=0;t<16;t++)i[n]=r[t].u,i[n+1]=r[t].v,n+=s},updateColor(t){const e=t.renderData,i=e.chunk.vb,s=e.floatStride;let r=5;const n=t.color,o=n.r/255,a=n.g/255,h=n.b/255,l=t.node._uiProps.opacity;for(let t=0;t<16;t++)i[r]=o,i[r+1]=a,i[r+2]=h,i[r+3]=l,r+=s}},AV=new Rs;let MV,PV,BV,RV,OV,LV,FV,zV=0;const kV=[];let NV=null;function UV(t){return t&&(t.insetTop>0||t.insetBottom>0||t.insetLeft>0||t.insetRight>0)?2:0}const VV={createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.renderData,i=t.spriteFrame;if(!i||!e)return;if(!e.vertDirty)return;const s=t.node._uiProps.uiTransformComp,r=Math.abs(s.width),n=Math.abs(s.height),o=i.getRect(),a=i.insetLeft,h=i.insetRight,l=o.width-a-h,c=i.insetTop,u=i.insetBottom,d=o.height-c-u;let p=r-a-h,_=n-c-u;p=p>0?p:0,_=_>0?_:0;const g=0===l?p:p/l,f=0===d?_:_/d,m=UV(i),y=Math.ceil(f+m),v=Math.ceil(g+m);e.dataLength=4*y*v,this.updateVerts(t,p,_,y,v),e.vertexCount!==y*v*4&&(t.renderEntity.colorDirty=!0),e.resize(y*v*4,y*v*6),e.updateRenderData(t,i)},createQuadIndices(t){if(t%6!=0)return void j(16308);const e=t/6;NV=new Uint16Array(t);let i=0;for(let t=0;t<e;t++)NV[i++]=0+4*t,NV[i++]=1+4*t,NV[i++]=2+4*t,NV[i++]=1+4*t,NV[i++]=3+4*t,NV[i++]=2+4*t},updateUVs(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},fillBuffers(t,e){const i=t.node,s=t.renderData,r=s.chunk;if(null===r)return;(t._flagChangedVersion!==i.flagChangedVersion||s.vertDirty)&&(this.updateWorldVertexAndUVData(t,r),s.vertDirty=!1,t._flagChangedVersion=i.flagChangedVersion),this.updateColorLate(t),r.bufferId;let n=r.vertexOffset;const o=r.meshBuffer,a=r.meshBuffer.iData;let h=o.indexOffset;for(let t=0;t<s.indexCount;t+=6)a[h++]=n,a[h++]=n+1,a[h++]=n+2,a[h++]=n+1,a[h++]=n+3,a[h++]=n+2,n+=4,o.indexOffset+=6;o.setDirty()},updateWorldUVData(t){const e=t.renderData,i=e.floatStride,s=e.data,r=e.chunk.vb;for(let t=0;t<s.length;t++){const e=t*i;r[e+3]=s[t].u,r[e+4]=s[t].v}},updateWorldVertexAndUVData(t,e){t.node.getWorldMatrix(AV);const i=t.renderData,s=i.floatStride,r=i.data,n=e.vb,o=r.length;for(let t=0;t<o;t++){const e=r[t].x,i=r[t].y,o=r[t].z;let a=AV.m03*e+AV.m07*i+AV.m11*o+AV.m15;a=a?1/a:1;const h=t*s;n[h]=(AV.m00*e+AV.m04*i+AV.m08*o+AV.m12)*a,n[h+1]=(AV.m01*e+AV.m05*i+AV.m09*o+AV.m13)*a,n[h+2]=(AV.m02*e+AV.m06*i+AV.m10*o+AV.m14)*a}this.updateWorldUVData(t)},updateVerts(t,e,i,s,r){const n=t.node._uiProps.uiTransformComp,o=t.renderData.data,a=t.spriteFrame,h=a.rect,l=Math.abs(n.width),c=Math.abs(n.height),u=n.anchorX*l,d=n.anchorY*c,p=a.insetLeft,_=a.insetRight,g=h.width-p-_,f=a.insetTop,m=a.insetBottom,y=h.height-f-m,v=n.width/(p+_)>1?1:n.width/(p+_),b=n.height/(f+m)>1?1:n.height/(f+m);let w=0,S=0;w=g>0?Math.floor(1e3*e)/1e3%g==0?g:e%g:e,S=y>0?Math.floor(1e3*i)/1e3%y==0?y:i%y:i,kV.length=0,zV=Math.max(s+1,r+1);for(let t=0;t<zV;t++)kV.push({x:0,y:0,z:0,u:0,v:0,color:new _r});const x=UV(a);if(0===x)for(let t=0;t<zV;t++)kV[t].x=t>=r?l-u:t*g-u,kV[t].y=t>=s?c-d:t*y-d;else for(let t=0;t<zV;t++)0===t?kV[t].x=-u:1===t?kV[t].x=p*v-u:t>1&&t<r-1?kV[t].x=g>0?p*v-u+g*(t-1):p+e-u:t===r-1?kV[t].x=p*v-u+w+g*(t-2):t>=r&&(kV[t].x=Math.min(p+e+_,l)-u),0===t?kV[t].y=-d:1===t?kV[t].y=m*b-d:t>1&&t<s-1?kV[t].y=y>0?m*b-d+y*(t-1):m+i-d:t===s-1?kV[t].y=m*b-d+S+y*(t-2):t>=s&&(kV[t].y=Math.min(m+i+f,c)-d);let T=0,C=0,I=0,E=0;for(let t=0;t<s;++t){I=kV[t].y,E=kV[t+1].y;for(let e=0;e<r;++e){T=kV[e].x,C=kV[e+1].x;const i=4*(t*r+e);o[i].x=T,o[i].y=I,o[i+1].x=C,o[i+1].y=I,o[i+2].x=T,o[i+2].y=E,o[i+3].x=C,o[i+3].y=E}}const D=a.rotated;a.uv;const A=a.uvSliced;MV=A[0],PV=A[1],BV=A[2],RV=A[3],OV=A[4],LV=A[8],FV=A[12];let M=0,P=0;const B=0===g?e:e/g,R=0===y?i:i/y,O=[],L=[];for(let t=0;t<s;++t){P=i>y?i>=(x>0?t:t+1)*y?1:R%1:R;for(let i=0;i<r;++i){M=e>g?e>=(x>0?i:i+1)*g?1:B%1:B,D?(0===x?(O[0]=OV.u,O[1]=OV.u,O[2]=OV.u+(LV.u-OV.u)*P,L[0]=PV.v,L[1]=PV.v+(BV.v-PV.v)*M,L[2]=PV.v):(0===t?(O[0]=MV.u,O[1]=MV.u,O[2]=OV.u):t<s-1?(O[0]=OV.u,O[1]=OV.u,O[2]=OV.u+(LV.u-OV.u)*P):t===s-1&&(O[0]=LV.u,O[1]=LV.u,O[2]=FV.u),0===i?(L[0]=MV.v,L[1]=PV.v,L[2]=MV.v):i<r-1?(L[0]=PV.v,L[1]=PV.v+(BV.v-PV.v)*M,L[2]=PV.v):i===r-1&&(L[0]=BV.v,L[1]=RV.v,L[2]=BV.v)),O[3]=O[2],L[3]=L[1]):(0===x?(O[0]=PV.u,O[1]=PV.u+(BV.u-PV.u)*M,O[2]=PV.u,L[0]=OV.v,L[1]=OV.v,L[2]=OV.v+(LV.v-OV.v)*P):(0===i?(O[0]=MV.u,O[1]=PV.u,O[2]=MV.u):i<r-1?(O[0]=PV.u,O[1]=PV.u+(BV.u-PV.u)*M,O[2]=PV.u):i===r-1&&(O[0]=BV.u,O[1]=RV.u,O[2]=BV.u),0===t?(L[0]=MV.v,L[1]=MV.v,L[2]=OV.v):t<s-1?(L[0]=OV.v,L[1]=OV.v,L[2]=OV.v+(LV.v-OV.v)*P):t===s-1&&(L[0]=LV.v,L[1]=LV.v,L[2]=FV.v)),O[3]=O[1],L[3]=L[2]);const n=4*(t*r+i);o[n].u=O[0],o[n].v=L[0],o[n+1].u=O[1],o[n+1].v=L[1],o[n+2].u=O[2],o[n+2].v=L[2],o[n+3].u=O[3],o[n+3].v=L[3]}}},updateColorLate(t){const e=t.renderData,i=e.chunk.vb,s=e.floatStride,r=e.vertexCount;let n=5;const o=t.color,a=o.r/255,h=o.g/255,l=o.b/255,c=t.node._uiProps.opacity;for(let t=0;t<r;t++)i[n]=a,i[n+1]=h,i[n+2]=l,i[n+3]=c,n+=s},updateColor(t){}};ZF.Type,ZF.FillType;const HV=t("spriteAssembler",{getAssembler(t){let e=IV;const i=t;switch(i.type){case 1:e=DV;break;case 2:e=VV;break;case 3:e=2===i.fillType?TV:oV}return e}});ZF.Assembler=HV;class GV{constructor(){this._maskStack=[],this._stencilPattern={stencilTest:!0,func:7,stencilMask:65535,writeMask:65535,failOp:1,zFailOp:1,passOp:1,ref:1},this._stage=0,this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}get stage(){return this._stage}set stage(t){this._stage=t}get pattern(){return this._stencilPattern}pushMask(t){this._maskStack.push(t)}clear(t){return 2!==t.stencilStage?5:1}enableMask(){this.stage=3}exitMask(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=0:this.stage=3)}getWriteMask(){return 1<<this._maskStack.length-1}getExitWriteMask(){return 1<<this._maskStack.length}getStencilRef(){let t=0;for(let e=0;e<this._maskStack.length;++e)t+=1<<e;return t}getMaskStackSize(){return this._maskStack.length}reset(){this._maskStack.length=0,this.stage=0}destroy(){this.stencilStateMap.forEach((t=>{t.destroy()})),this.stencilStateMap.clear()}getStencilStage(t,e){let i=0,s=!1,r=!1,n=1,o=this.stencilStateMap;if(e&&e.passes[0]){const a=e.passes[0].depthStencilState;let h=0,l=0;a.depthTest&&(h=1),a.depthWrite&&(l=1),i=h|l<<1|a.depthFunc<<2|t<<6|this._maskStack.length<<9,s=a.depthTest,r=a.depthWrite,n=a.depthFunc,o=this.stencilStateMapWithDepth}else i=t<<16|this._maskStack.length;if(o&&o.has(i))return o.get(i);this.setStateFromStage(t);const a=new Up(s,r,n,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return o.set(i,a),a}getStencilHash(t){return t<<8|this._maskStack.length}setStateFromStage(t){const e=this._stencilPattern;0===t?(e.stencilTest=!1,e.func=7,e.failOp=1,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,3===t?(e.func=2,e.failOp=1,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):1===t?(e.func=0,e.failOp=0,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):5===t||2===t?(e.func=0,e.failOp=2,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):6===t&&(e.func=0,e.failOp=0,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))}}t("StencilManager",GV),GV.sharedManager=null,GV.sharedManager=new GV;const WV=["mouse-down","mouse-move","mouse-up","mouse-wheel","mouse-leave-window","mouse-enter-window"],jV=["touch-start","touch-move","touch-end","touch-cancel"];new class{constructor(){this.priority=1,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],ZD._registerEventDispatcher(this),lM.callbacksInvoker.on(0,this.addPointerEventProcessor,this),lM.callbacksInvoker.on(1,this.removePointerEventProcessor,this),lM.callbacksInvoker.on(2,this._markListDirty,this)}onThrowException(){this._inDispatchCount=0}dispatchEvent(t){const e=t.type;return jV.includes(e)?this.dispatchEventTouch(t):!WV.includes(e)||this.dispatchEventMouse(t)}addPointerEventProcessor(t){0===this._inDispatchCount?this._pointerEventProcessorList.includes(t)||(this._pointerEventProcessorList.push(t),this._isListDirty=!0):this._processorListToAdd.includes(t)||this._processorListToAdd.push(t),jt(this._processorListToRemove,t)}removePointerEventProcessor(t){0===this._inDispatchCount?(jt(this._pointerEventProcessorList,t),this._isListDirty=!0):this._processorListToRemove.includes(t)||this._processorListToRemove.push(t),jt(this._processorListToAdd,t)}dispatchEventMouse(t){this._inDispatchCount++,this._sortPointerEventProcessorList();const e=this._pointerEventProcessorList,i=e.length;let s=!0;for(let r=0;r<i;++r){const i=e[r];if(i.isEnabled&&i.shouldHandleEventMouse&&i._handleEventMouse(t)){if(s=!1,!t.preventSwallow)break;t.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),s}dispatchEventTouch(t){this._inDispatchCount++,this._sortPointerEventProcessorList();const e=this._pointerEventProcessorList,i=e.length,s=t.touch;let r=!0;for(let n=0;n<i;++n){const i=e[n];if(i.isEnabled&&i.shouldHandleEventTouch)if("touch-start"===t.type){if(i._handleEventTouch(t)){if(i.isEnabled)i.claimedTouchIdList.push(s.getID());else{const e=new oD([t.touch],!0,"touch-cancel");e.touch=t.touch,i.dispatchEvent(e),i.claimedTouchIdList.length=0}if(r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}else if(i.claimedTouchIdList.length>0){const e=i.claimedTouchIdList.indexOf(s.getID());if(-1!==e){if(i._handleEventTouch(t),"touch-end"!==t.type&&"touch-cancel"!==t.type||(Gt(i.claimedTouchIdList,e),t.preventSwallow||this._removeClaimedTouch(n+1,s.getID())),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r}_removeClaimedTouch(t,e){const i=this._pointerEventProcessorList,s=i.length;for(let r=t;r<s;++r){const t=i[r],s=t.claimedTouchIdList.indexOf(e);-1!==s&&Gt(t.claimedTouchIdList,s)}}_updatePointerEventProcessorList(){const t=this._processorListToAdd,e=t.length;for(let i=0;i<e;++i)this.addPointerEventProcessor(t[i]);t.length=0;const i=this._processorListToRemove,s=i.length;for(let t=0;t<s;++t)this.removePointerEventProcessor(i[t]);i.length=0}_sortPointerEventProcessorList(){if(!this._isListDirty)return;const t=this._pointerEventProcessorList,e=t.length;for(let i=0;i<e;++i){const e=t[i],s=e.node;if(s._uiProps){const t=s._uiProps.uiTransformComp;e.cachedCameraPriority=t.cameraPriority}}t.sort(this._sortByPriority),this._isListDirty=!1}_sortByPriority(t,e){const i=t.node,s=e.node;if(!(e&&s&&s.activeInHierarchy&&s._uiProps.uiTransformComp))return-1;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return 1;if(t.cachedCameraPriority!==e.cachedCameraPriority)return e.cachedCameraPriority-t.cachedCameraPriority;let r=i,n=s,o=!1;for(;(null===(a=r.parent)||void 0===a?void 0:a.uuid)!==(null===(h=n.parent)||void 0===h?void 0:h.uuid);){var a,h,l,c,u,d;r=null===(null===(l=r)||void 0===l||null===(c=l.parent)||void 0===c?void 0:c.parent)?(o=!0)&&s:r&&r.parent,n=null===(null===(u=n)||void 0===u||null===(d=u.parent)||void 0===d?void 0:d.parent)?(o=!0)&&i:n&&n.parent}if(r.uuid===n.uuid){if(r.uuid===s.uuid)return-1;if(r.uuid===i.uuid)return 1}const p=r?r.getSiblingIndex():0,_=n?n.getSiblingIndex():0;return o?p-_:_-p}_markListDirty(){this._isListDirty=!0}};const $V=new np(null),qV=new Rs;class XV{get descriptorSet(){return this._descriptorSet}constructor(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;const t=e_.gfxDevice;this._localData=new Float32Array(56),this._localBuffer=t.createBuffer(new Ed(18,3,224,224))}initialize(t){const e=e_.gfxDevice;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,$V.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet($V),this._descriptorSet.bindBuffer(Bm.BINDING,this._localBuffer),this._descriptorSet.bindTexture(12,t.texture),this._descriptorSet.bindSampler(12,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0}updateTransform(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())}equals(t,e,i){return this._transform===t&&this._textureHash===e&&this._samplerHash===i}reset(){this._transform=null,this._textureHash=0,this._samplerHash=0}destroy(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null}isValid(){return this._transform&&this._transform.isValid}uploadLocalData(){const t=this._transform;if((t.hasChangedFlags||t.isTransformDirty())&&(t.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){const e=t.worldMatrix;Rs.toArray(this._localData,e,0),Rs.invert(qV,e),Rs.transpose(qV,qV);{const t=Rs.determinant(qV),e=1/Math.sqrt(t);Rs.multiplyScalar(qV,qV,e)}Rs.toArray(this._localData,qV,16),this._localBuffer.update(this._localData),this._transformUpdate=!1}}}class YV{constructor(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=new rn((()=>new XV),16,(t=>t.destroy()))}getDescriptorSet(t){if(h.director.root,t.useLocalData){const e=this._localDescriptorSetCache;for(let i=0,s=e.length;i<s;i++){const s=e[i];if(s.equals(t.useLocalData,t.textureHash,t.samplerHash))return s.descriptorSet}const i=this._localCachePool.alloc();return i.initialize(t),this._localDescriptorSetCache.push(i),i.descriptorSet}{const e=t.textureHash^t.samplerHash;if(this._descriptorSetCache.has(e))return this._descriptorSetCache.get(e);{$V.layout=t.passes[0].localSetLayout;const i=e_.gfxDevice.createDescriptorSet($V),s=12;return i.bindTexture(s,t.texture),i.bindSampler(s,t.sampler),i.update(),this._descriptorSetCache.set(e,i),this._dsCacheHashByTexture.set(t.textureHash,e),i}}}update(){const t=this._localDescriptorSetCache,e=t.length;if(0===e)return;const i=[];for(let s=0;s<e;s++){const e=t[s];if(e.isValid())e.uploadLocalData();else{e.reset();const s=t.indexOf(e);i.push(s)}}for(let e=i.length-1;e>=0;e--){const s=i[e],r=t[s];t.splice(s,1),this._localCachePool.free(r)}}reset(){const t=this._localDescriptorSetCache,e=t.length;for(let i=0;i<e;i++){const e=t[i];this._localCachePool.free(e)}this._localDescriptorSetCache.length=0}releaseDescriptorSetCache(t){const e=this._dsCacheHashByTexture.get(t);e&&this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).destroy(),this._descriptorSetCache.delete(e),this._dsCacheHashByTexture.delete(t))}destroy(){for(const t of this._descriptorSetCache.values())t.destroy();this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()}}h.internal.Batcher2D=class{get nativeObj(){return this._nativeObj}get currBufferAccessor(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}get batches(){return this._batches}set currStaticRoot(t){this._currStaticRoot=t}set currIsStatic(t){this._currIsStatic=t}constructor(t){this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new Lw,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._currIsMiddleware=!1,this._middlewareEnableBatch=!1,this._middlewareBuffer=null,this._middlewareIndexStart=0,this._middlewareIndexCount=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new YV,this._meshDataArray=[],this._maskClearModel=null,this._maskClearMtl=null,this._maskModelMesh=null,this._root=t,this.device=t.device,this._batches=new on(64),this._drawBatchPool=new rn((()=>new UN),128,(t=>t.destroy(this)))}initialize(){return!0}destroy(){for(let t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy();for(const t of this._bufferAccessors.values())t.destroy();this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),GV.sharedManager.destroy(),this._maskClearModel&&this._maskModelMesh&&(h.director.root.destroyModel(this._maskClearModel),this._maskModelMesh.destroy()),this._maskClearMtl&&this._maskClearMtl.destroy()}syncRootNodesToNative(){}addScreen(t){this._screens.push(t),this._screens.sort(this._screenSort)}removeScreen(t){const e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)}sortScreens(){this._screens.sort(this._screenSort)}getFirstRenderCamera(t){if(t.scene&&t.scene.renderScene){const e=t.scene.renderScene.cameras;for(let i=0;i<e.length;i++){const s=e[i];if(s.visibility&t.layer)return s}}return null}update(){const t=this._screens;let e=0;for(let i=0;i<t.length;++i){const s=t[i],r=s._getRenderScene();if(!s.enabledInHierarchy||!r)continue;this._opacityDirty=0,this._pOpacity=1,this.walk(s.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();let n=0;if(this._batches.length>e)for(;e<this._batches.length;++e){const t=this._batches.array[e];if(t.model){const e=t.model.subModels;for(let t=0;t<e.length;t++)e[t].priority=n++}else t.descriptorSet=this._descriptorSetCache.getDescriptorSet(t);r.addBatch(t)}}}uploadBuffers(){if(this._batches.length>0){const t=this._meshDataArray.length;for(let e=0;e<t;e++)this._meshDataArray[e].uploadBuffers();for(const t of this._bufferAccessors.values())t.uploadBuffers(),t.reset();this._descriptorSetCache.update()}}reset(){{for(let t=0;t<this._batches.length;++t){const e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}for(const t of this._bufferAccessors.values())t.reset();const t=this._meshDataArray.length;for(let e=0;e<t;e++)this._meshDataArray[e].freeIAPool();this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),GV.sharedManager.reset()}}switchBufferAccessor(t){void 0===t&&(t=UR);const e=t===UR?36:WR(t);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==e){let i=this._bufferAccessors.get(e);i||(i=new YR(this.device,t),this._bufferAccessors.set(e,i)),this._staticVBBuffer=i,this._currBID=-1}return this._staticVBBuffer}registerBufferAccessor(t,e){this._bufferAccessors.set(t,e)}updateBuffer(t,e){const i=this.switchBufferAccessor(t);this._currBID!==e&&(this._currBID=e,this._indexStart=i.getMeshBuffer(e).indexOffset)}commitComp(t,e,i,s,r){let n,o=0,a=-1;if(e&&e.chunk){if(!e.isValid())return;o=e.dataHash,n=e.material,a=e.chunk.bufferId}2===t.stencilStage||6===t.stencilStage?this._insertMaskBatch(t):t.stencilStage=GV.sharedManager.stage;const h=t.stencilStage;this._currHash===o&&0!==o&&this._currMaterial===n&&this._currDepthStencilStateStage===h||(this.autoMergeBatches(this._currComponent),e&&!e._isMeshBuffer&&this.updateBuffer(e.vertexFormat,a),this._currRenderData=e,this._currHash=e?e.dataHash:0,this._currComponent=t,this._currTransform=r,this._currMaterial=t.getRenderMaterial(0),this._currDepthStencilStateStage=h,this._currLayer=t.node.layer,i?(this._currTexture=i.getGFXTexture(),this._currSampler=i.getGFXSampler(),this._currTextureHash=i.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),s.fillBuffers(t,this)}commitIA(t,e,i,s,r){this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());let n=null,o=0;t&&(t.stencilStage=GV.sharedManager.stage,n=null!==t.customMaterial?GV.sharedManager.getStencilStage(t.stencilStage,s):GV.sharedManager.getStencilStage(t.stencilStage),o=GV.sharedManager.getStencilHash(t.stencilStage));const a=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();a.visFlags=t.node.layer,a.inputAssembler=e,a.useLocalData=r||null,i&&(a.texture=i.getGFXTexture(),a.sampler=i.getGFXSampler(),a.textureHash=i.getHash(),a.samplerHash=a.sampler.hash),a.fillPasses(s||null,n,o,null),this._batches.push(a)}commitMiddleware(t,e,i,s,r,n,o){const a=r.getGFXTexture();o&&this._middlewareEnableBatch&&this._middlewareBuffer===e&&this._currTexture===a&&this._currMaterial.hash===n.hash&&this._middlewareIndexStart+this._middlewareIndexCount===i&&this._currLayer===t.node.layer?this._middlewareIndexCount+=s:(this.autoMergeBatches(this._currComponent),this.resetRenderStates(),this._currComponent=t,this._currTexture=a,this._currSampler=r.getGFXSampler(),this._currTextureHash=r.getHash(),this._currLayer=t.node.layer,this._currSamplerHash=this._currSampler.hash,this._currHash=0,this._currTransform=o?null:t.node,this._middlewareEnableBatch=o,this._middlewareBuffer=e,this._currMaterial=n,this._middlewareIndexStart=i,this._middlewareIndexCount=s),this._currIsMiddleware=!0}commitModel(t,e,i){this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());let s=null,r=0;i&&(2===t.stencilStage||6===t.stencilStage?this._insertMaskBatch(t):t.stencilStage=GV.sharedManager.stage,s=GV.sharedManager.getStencilStage(t.stencilStage,i),r=GV.sharedManager.getStencilHash(t.stencilStage));const n=h.director.getTotalFrames();e&&(e.updateTransform(n),e.updateUBOs(n));for(let n=0;n<e.subModels.length;n++){const o=this._drawBatchPool.alloc(),a=e.subModels[n];o.visFlags=t.node.layer,o.model=e,o.texture=null,o.sampler=null,o.useLocalData=null,s||(s=null),o.fillPasses(i,s,r,a.patches),o.inputAssembler=a.inputAssembler,o.model.visFlags=o.visFlags,o.descriptorSet=a.descriptorSet,this._batches.push(o)}}setupStaticBatch(t,e){this.finishMergeBatches(),this._staticVBBuffer=e,this.currStaticRoot=t}endStaticBatch(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()}commitStaticBatch(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()}autoMergeBatches(t){if(this._currIsMiddleware)return void this.mergeBatchesForMiddleware(t);const e=this._currMaterial;if(!e)return;let i;const s=this._currRenderData,r=this._staticVBBuffer;if(s&&s._isMeshBuffer)i=s.requestIA(this.device),-1===this._meshDataArray.indexOf(s)&&this._meshDataArray.push(s);else if(r){const t=this._currBID,e=r.getMeshBuffer(t);if(!e)return;const s=e.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,e.indexOffset,e.setDirty(),i=e.requireFreeIA(this.device),i.firstIndex=this._indexStart,i.indexCount=s,this._indexStart=e.indexOffset}if(this._currBID=-1,!i||!this._currTexture)return;let n=null,o=0;t&&(n=null!==t.customMaterial?GV.sharedManager.getStencilStage(t.stencilStage,e):GV.sharedManager.getStencilStage(t.stencilStage),o=GV.sharedManager.getStencilHash(t.stencilStage));const a=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();a.visFlags=this._currLayer,a.texture=this._currTexture,a.sampler=this._currSampler,a.inputAssembler=i,a.useLocalData=this._currTransform,a.textureHash=this._currTextureHash,a.samplerHash=this._currSamplerHash,a.fillPasses(e,n,o,null),this._batches.push(a)}mergeBatchesForMiddleware(t){let e=null,i=0;t.stencilStage=GV.sharedManager.stage,e=null!==t.customMaterial?GV.sharedManager.getStencilStage(t.stencilStage,this._currMaterial):GV.sharedManager.getStencilStage(t.stencilStage),i=GV.sharedManager.getStencilHash(t.stencilStage);const s=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();s.visFlags=t.node.layer;const r=this._middlewareBuffer.requireFreeIA(this.device);r.firstIndex=this._middlewareIndexStart,r.indexCount=this._middlewareIndexCount,s.inputAssembler=r,s.useLocalData=this._currTransform,s.texture=this._currTexture,s.sampler=this._currSampler,s.textureHash=this._currTextureHash,s.samplerHash=this._currSamplerHash,s.fillPasses(this._currMaterial||null,e,i,null),this._batches.push(s),this._currIsMiddleware=!1,this._middlewareBuffer=null}forceMergeBatches(t,e,i){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=i.node.layer,this.autoMergeBatches(i)}resetRenderStates(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}finishMergeBatches(){this.autoMergeBatches(),this.resetRenderStates()}flushMaterial(t){this._currMaterial=t}walk(t,e){if(void 0===e&&(e=0),!t.activeInHierarchy)return;const i=t.children,s=t._uiProps,r=s.uiComp,n=this._pOpacity;let o=n;const a=r&&r.color?r.color.a/255:1;if(this._pOpacity=o*=a*s.localOpacity,s.setOpacity(o),!gi(o,0,pi)){if(s.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.fillBuffers(this),this._opacityDirty&&r&&!r.useVertexOpacity&&r.renderData&&r.renderData.vertexCount>0){n_(r.renderData,o);const t=r.renderData.getMeshBuffer();t&&t.setDirty()}if(i.length>0&&!t._static)for(let t=0;t<i.length;++t){const s=i[t];this.walk(s,e)}s.colorDirty&&(this._opacityDirty--,s.colorDirty=!1)}this._pOpacity=n,r&&r.enabledInHierarchy&&(r.postUpdateAssembler(this),(2===r.stencilStage||6===r.stencilStage)&&GV.sharedManager.getMaskStackSize()>0&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates(),GV.sharedManager.exitMask())),e+=1}_screenSort(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()}_releaseDescriptorSetCache(t,e){this._descriptorSetCache.releaseDescriptorSetCache(t)}_createClearModel(){if(!this._maskClearModel){this._maskClearMtl=pw.get("default-clear-stencil"),this._maskClearModel=h.director.root.createModel(CA);const t=WR(kR),e=e_.gfxDevice,i=e.createBuffer(new Ed(10,1,4*t,t)),s=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(s);const r=e.createBuffer(new Ed(6,1,12,2)),n=new Uint16Array([0,1,2,2,1,3]);r.update(n),this._maskModelMesh=new _S([i],kR,7,r),this._maskModelMesh.subMeshIdx=0,this._maskClearModel.initSubModel(0,this._maskModelMesh,this._maskClearMtl)}}_insertMaskBatch(t){this.autoMergeBatches(this._currComponent),this.resetRenderStates(),this._createClearModel(),this._maskClearModel.node=this._maskClearModel.transform=t.node;const e=GV.sharedManager;e.pushMask(1);const i=e.clear(t);let s=null,r=0;const n=this._maskClearMtl;n&&(s=e.getStencilStage(i,n),r=e.getStencilHash(i));const o=this._maskClearModel,a=h.director.getTotalFrames();o&&(o.updateTransform(a),o.updateUBOs(a));for(let e=0;e<o.subModels.length;e++){const i=this._drawBatchPool.alloc(),a=o.subModels[e];i.visFlags=t.node.layer,i.model=o,i.texture=null,i.sampler=null,i.useLocalData=null,s||(s=null),i.fillPasses(n,s,r,a.patches),i.inputAssembler=a.inputAssembler,i.model.visFlags=i.visFlags,i.descriptorSet=a.descriptorSet,this._batches.push(i)}e.enableMask()}syncMeshBuffersToNative(t,e){}},h.UI={MeshBuffer:jR,spriteAssembler:HV,graphicsAssembler:BU,labelAssembler:sV,RenderData:ZR,MeshRenderData:JR},TP.on(xP.EVENT_POST_SUBSYSTEM_INIT,(()=>{QV.init()}));class QV{static getSortingPriority(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),(t+32768<<16|e+32768)>>>0}static getLayerIndex(t){void 0===t&&(t=0);let e=0;return this.indexMap.has(t)?e=this.indexMap.get(t):j(2105),e}static getLayerIndexByName(t){const e=this.getLayerByName(t);return this.getLayerIndex(e)}static getLayerName(t){void 0===t&&(t=0);let e="";return this.nameMap.has(t)?e=this.nameMap.get(t):j(2105),e}static getLayerByName(t){const e=this.nameMap.size,i=this.nameMap.keys();let s=0;for(let r=0;r<e;r++)if(s=i.next().value,this.nameMap.get(s)===t)return s;return j(2106),0}static isLayerValid(t){return!!this.indexMap.has(t)||(j(2105),!1)}static getBuiltinLayers(){return[{id:0,name:"default",value:0}]}static init(){let t=ae.querySettings("engine","sortingLayers");t&&0!==t.length||(t=this.getBuiltinLayers()),QV.resetState();for(let e=0;e<t.length;e++){const i=t[e];QV.setLayer(i.id,i.name,i.value),QV.Enum[i.name]=i.id}te.update(QV.Enum),te.sortList(QV.Enum,((t,e)=>QV.getLayerIndex(t.value)-QV.getLayerIndex(e.value)))}static setLayer(t,e,i){this.nameMap.set(t,e),this.indexMap.set(t,i)}static resetState(){const t=Object.keys(QV.Enum);for(let e=0;e<t.length;e++)delete QV.Enum[QV.Enum[t[e]]],delete QV.Enum[t[e]];QV.indexMap.clear(),QV.nameMap.clear()}}var KV,ZV,JV,tH,eH,iH;t("SortingLayers",QV),QV.nameMap=new Map,QV.indexMap=new Map,QV.Enum=te({default:0}),t("Sorting",(KV=oa("cc.Sorting"),ZV=Ga(QV.Enum),KV(JV=la((s((tH=class extends Ag{constructor(){super(),this._sortingLayer=eH&&eH(),this._sortingOrder=iH&&iH(),this._modelRenderer=null}get sortingLayer(){return this._sortingLayer}set sortingLayer(t){t!==this._sortingLayer&&QV.isLayerValid(t)&&(this._sortingLayer=t,this._updateSortingPriority())}get sortingOrder(){return this._sortingOrder}set sortingOrder(t){t!==this._sortingOrder&&(this._sortingOrder=fi(t,-32768,32767),this._updateSortingPriority())}__preload(){this._modelRenderer=this.getComponent("cc.ModelRenderer"),this._modelRenderer||G(16301,this.node.name),this._updateSortingPriority()}_updateSortingPriority(){const t=QV.getLayerIndex(this._sortingLayer),e=QV.getSortingPriority(t,this._sortingOrder);this._modelRenderer&&this._modelRenderer.isValid&&(this._modelRenderer.priority=e)}}).prototype,"sortingLayer",[ZV],Object.getOwnPropertyDescriptor(tH.prototype,"sortingLayer"),tH.prototype),eH=Qo(tH.prototype,"_sortingLayer",[va],(function(){return QV.Enum.default})),iH=Qo(tH.prototype,"_sortingOrder",[va],(function(){return 0})),JV=tH))||JV)||JV));class sH extends CA{constructor(){super(),this._morphRenderingInstance=null,this._usedMaterials=new Set}getMacroPatches(t){const e=super.getMacroPatches(t);if(this._morphRenderingInstance){const i=this._morphRenderingInstance.requiredPatches(t);if(i)return i.concat(null!=e?e:[])}return e}initSubModel(t,e,i){return super.initSubModel(t,e,this._launderMaterial(i))}destroy(){super.destroy(),this._morphRenderingInstance=null}setSubModelMaterial(t,e){return super.setSubModelMaterial(t,this._launderMaterial(e))}setMorphRendering(t){this._morphRenderingInstance=t}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,e)}_launderMaterial(t){return t}}const rH=t("ReflectionProbeType",{NONE:0,BAKED_CUBEMAP:1,PLANAR_REFLECTION:2,BLEND_PROBES:3,BLEND_PROBES_AND_SKYBOX:4});var nH,oH,aH,hH,lH,cH,uH,dH,pH,_H,gH,fH,mH,yH,vH,bH,wH,SH,xH,TH,CH,IH,EH,DH,AH,MH,PH,BH,RH,OH,LH,FH,zH,kH,NH,UH,VH,HH,GH,WH,jH,$H;const{ccclass:qH,help:XH,executeInEditMode:YH,executionOrder:QH,menu:KH,visible:ZH,type:JH,formerlySerializedAs:tG,serializable:eG,editable:iG,disallowAnimation:sG}=Ja;let rG=_w("specular-pass");function nG(t){const e=t.passes,i=h.rendering;Gy()&&(rG=i.getPhaseID(i.getPassID("specular-pass"),"default"));for(let t=0;t<e.length;t++)if((!i||!i.enableEffectImport)&&e[t].phase===rG||Gy()&&e[t].phaseID===rG)return t;return-1}const oG=te({OFF:0,ON:1}),aG=te({OFF:0,ON:1});let hG=(nH=qH("cc.ModelBakeSettings"),oH=tG("_recieveShadow"),aH=JH(Me),hH=JH(Be),lH=JH(Be),cH=JH(te(rH)),uH=JH(Be),nH(((TH=class extends An{constructor(){super(),this.texture=_H&&_H(),this.uvParam=gH&&gH(),this._bakeable=fH&&fH(),this._castShadow=mH&&mH(),this._receiveShadow=yH&&yH(),this._lightmapSize=vH&&vH(),this._useLightProbe=bH&&bH(),this._bakeToLightProbe=wH&&wH(),this._reflectionProbeType=SH&&SH(),this._bakeToReflectionProbe=xH&&xH(),this.probeCubemap=null,this.probeBlendCubemap=null,this.probePlanarmap=null}get bakeable(){return this._bakeable}set bakeable(t){this._bakeable=t}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}get receiveShadow(){return this._receiveShadow}set receiveShadow(t){this._receiveShadow=t}get lightmapSize(){return this._lightmapSize}set lightmapSize(t){this._lightmapSize=t}get useLightProbe(){return this._useLightProbe}set useLightProbe(t){this._useLightProbe=t,this.emit("use_light_probe_changed")}get bakeToLightProbe(){return this._bakeToLightProbe}set bakeToLightProbe(t){this._bakeToLightProbe=t}get reflectionProbe(){return this._reflectionProbeType}set reflectionProbe(t){this._reflectionProbeType=t,this.emit("reflection_probe_changed")}get bakeToReflectionProbe(){return this._bakeToReflectionProbe}set bakeToReflectionProbe(t){this._bakeToReflectionProbe=t,this.emit("bake_to_reflection_probe_changed")}}).USE_LIGHT_PROBE_CHANGED="use_light_probe_changed",TH.REFLECTION_PROBE_CHANGED="reflection_probe_changed",TH.BAKE_TO_REFLECTION_PROBE_CHANGED="bake_to_reflection_probe_changed",_H=Qo((pH=TH).prototype,"texture",[eG],(function(){return null})),gH=Qo(pH.prototype,"uvParam",[eG],(function(){return new cr})),fH=Qo(pH.prototype,"_bakeable",[eG],(function(){return!1})),mH=Qo(pH.prototype,"_castShadow",[eG],(function(){return!1})),yH=Qo(pH.prototype,"_receiveShadow",[oH],(function(){return!1})),vH=Qo(pH.prototype,"_lightmapSize",[eG],(function(){return 64})),bH=Qo(pH.prototype,"_useLightProbe",[eG],(function(){return!1})),wH=Qo(pH.prototype,"_bakeToLightProbe",[eG],(function(){return!0})),SH=Qo(pH.prototype,"_reflectionProbeType",[eG],(function(){return 0})),xH=Qo(pH.prototype,"_bakeToReflectionProbe",[eG],(function(){return!0})),s(pH.prototype,"lightmapSize",[aH],Object.getOwnPropertyDescriptor(pH.prototype,"lightmapSize"),pH.prototype),s(pH.prototype,"useLightProbe",[hH],Object.getOwnPropertyDescriptor(pH.prototype,"useLightProbe"),pH.prototype),s(pH.prototype,"bakeToLightProbe",[lH],Object.getOwnPropertyDescriptor(pH.prototype,"bakeToLightProbe"),pH.prototype),s(pH.prototype,"reflectionProbe",[cH],Object.getOwnPropertyDescriptor(pH.prototype,"reflectionProbe"),pH.prototype),s(pH.prototype,"bakeToReflectionProbe",[uH],Object.getOwnPropertyDescriptor(pH.prototype,"bakeToReflectionProbe"),pH.prototype),dH=pH))||dH),lG=t("MeshRenderer",(CH=qH("cc.MeshRenderer"),IH=QH(100),EH=JH(Pe),DH=JH(Pe),AH=JH(oG),MH=JH(aG),PH=JH(ZP),BH=JH(Be),CH(RH=IH(($H=class extends Rk{get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t,this._updateShadowBias(),this._onUpdateLocalShadowBiasAndProbeId()}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t,this._updateShadowNormalBias(),this._onUpdateLocalShadowBiasAndProbeId()}get shadowCastingMode(){return this._shadowCastingMode}set shadowCastingMode(t){this._shadowCastingMode=t,this._updateCastShadow()}get shadowCastingModeForInspector(){return this.shadowCastingMode===oG.ON}set shadowCastingModeForInspector(t){this.shadowCastingMode=!0===t?oG.ON:oG.OFF}onUpdateReceiveDirLight(t,e){void 0===e&&(e=!1),this._model&&(e?this._model.receiveDirLight=!1:this.node&&(t&this.node.layer)===this.node.layer||t&this._model.visFlags?this._model.receiveDirLight=!0:this._model.receiveDirLight=!1)}get receiveShadow(){return this._shadowReceivingMode}set receiveShadow(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}get receiveShadowForInspector(){return this._shadowReceivingMode===aG.ON}set receiveShadowForInspector(t){this._shadowReceivingMode=!0===t?aG.ON:aG.OFF,this._updateReceiveShadow()}get mesh(){return this._mesh}set mesh(t){const e=this._mesh,i=this._mesh=t;null==i||i.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateUseLightProbe(),this._updateUseReflectionProbe(),this._updateReceiveDirLight()}get model(){return this._model}get enableMorph(){return this._enableMorph}set enableMorph(t){this._enableMorph=t}get isGlobalStandardSkinObject(){return this._enabledGlobalStandardSkinObject}set isGlobalStandardSkinObject(t){h.director.root.pipeline.pipelineSceneData.standardSkinMeshRenderer=t?this:null,this._enabledGlobalStandardSkinObject=t}clearGlobalStandardSkinObjectFlag(){this._enabledGlobalStandardSkinObject=!1}constructor(){super(),this.bakeSettings=LH&&LH(),this._mesh=FH&&FH(),this._shadowCastingMode=zH&&zH(),this._shadowReceivingMode=kH&&kH(),this._shadowBias=NH&&NH(),this._shadowNormalBias=UH&&UH(),this._reflectionProbeId=VH&&VH(),this._reflectionProbeBlendId=HH&&HH(),this._reflectionProbeBlendWeight=GH&&GH(),this._enabledGlobalStandardSkinObject=WH&&WH(),this._reflectionProbeDataMap=null,this._subMeshShapesWeights=[],this._modelType=CA,this._model=null,this._morphInstance=null,this._enableMorph=jH&&jH(),ae.querySettings("rendering","highQualityMode")&&(this._shadowCastingMode=oG.ON,this.bakeSettings.castShadow=!0,this.bakeSettings.receiveShadow=!0)}onLoad(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._updateUseLightProbe(),this._updateBakeToReflectionProbe(),this._updateUseReflectionProbe(),this._updateReceiveDirLight(),this._updateStandardSkin()}onRestore(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._updateUseLightProbe(),this._updateBakeToReflectionProbe(),this._updateUseReflectionProbe(),this._updateReceiveDirLight(),this._updateStandardSkin()}onEnable(){super.onEnable(),this.node.on("mobility-changed",this.onMobilityChanged,this),this.node.on("light-probe-baking-changed",this.onLightProbeBakingChanged,this),this.bakeSettings.on("use_light_probe_changed",this.onUseLightProbeChanged,this),this.bakeSettings.on("reflection_probe_changed",this.onReflectionProbeChanged,this),this.bakeSettings.on("bake_to_reflection_probe_changed",this.onBakeToReflectionProbeChanged,this),this._model||this._updateModels(),this._model.onGlobalPipelineStateChanged(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._updateBakeToReflectionProbe(),this._updateUseReflectionProbe(),this._onUpdateLocalShadowBiasAndProbeId(),this._updateUseLightProbe(),this._updateReceiveDirLight(),this._onUpdateReflectionProbeDataMap(),this._onUpdateLocalReflectionProbeData(),this._updateStandardSkin(),this._attachToScene()}onDisable(){this._model&&this._detachFromScene(),this.node.off("mobility-changed",this.onMobilityChanged,this),this.node.off("light-probe-baking-changed",this.onLightProbeBakingChanged,this),this.bakeSettings.off("use_light_probe_changed",this.onUseLightProbeChanged,this),this.bakeSettings.off("reflection_probe_changed",this.onReflectionProbeChanged,this),this.bakeSettings.off("bake_to_reflection_probe_changed",this.onBakeToReflectionProbeChanged,this)}onDestroy(){this._model&&(h.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}onGeometryChanged(){if(this._model&&this._mesh){const t=this._mesh.struct;this._model.createBoundingShape(t.minPosition,t.maxPosition),this._model.updateWorldBound(),this._model.onGeometryChanged()}}getWeight(t,e){const{_subMeshShapesWeights:i}=this;i.length;const s=this._subMeshShapesWeights[t];return s.length,s[e]}setWeights(t,e){const{_subMeshShapesWeights:i}=this;e>=i.length||i[e].length===t.length&&(i[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))}setWeight(t,e,i){const{_subMeshShapesWeights:s}=this;if(e>=s.length)return;const r=s[e];i>=r.length||(r[i]=t,this._uploadSubMeshShapesWeights(e))}setInstancedAttribute(t,e){if(this.model){const i=this.model.subModels;for(let s=0;s<i.length;s++){const r=i[s],{attributes:n,views:o}=r.instancedAttributeBlock;for(let i=0;i<n.length;i++)if(n[i].name===t){o[i].set(e);break}}}}_updateLightmap(t,e,i,s,r){this.bakeSettings.texture=t,this.bakeSettings.uvParam.x=e,this.bakeSettings.uvParam.y=i,this.bakeSettings.uvParam.z=s,this.bakeSettings.uvParam.w=r,this._onUpdateLightingmap(),this._updateReceiveDirLight()}updateProbeCubemap(t){this.bakeSettings.probeCubemap&&this.bakeSettings.probeCubemap===t||(this.bakeSettings.probeCubemap=t,null!==this.model&&this.model.updateReflectionProbeCubemap(this.bakeSettings.probeCubemap))}updateProbeBlendCubemap(t){this.bakeSettings.probeBlendCubemap&&this.bakeSettings.probeBlendCubemap===t||(this.bakeSettings.probeBlendCubemap=t,null!==this.model&&this.model.updateReflectionProbeBlendCubemap(this.bakeSettings.probeBlendCubemap))}updateProbePlanarMap(t){this.bakeSettings.probePlanarmap!==t&&(this.bakeSettings.probePlanarmap=t,null!==this.model&&this.model.updateReflectionProbePlanarMap(this.bakeSettings.probePlanarmap))}updateReflectionProbeDataMap(t){this._reflectionProbeDataMap=t,null!==this.model&&this.model.updateReflectionProbeDataMap(t)}updateReflectionProbeId(t){this._reflectionProbeId=t,this.model&&(this.model.reflectionProbeId=t),this._onUpdateLocalShadowBiasAndProbeId()}updateReflectionProbeBlendId(t){this._reflectionProbeBlendId=t,this.model&&(this.model.reflectionProbeBlendId=t),this._onUpdateLocalShadowBiasAndProbeId()}updateReflectionProbeBlendWeight(t){this._reflectionProbeBlendWeight=t,this.model&&(this.model.reflectionProbeBlendWeight=t),this._onUpdateLocalReflectionProbeData()}_updateReflectionProbeTexture(){if(!this.model)return;const t=this.bakeSettings,e=t.reflectionProbe,i=t.probeBlendCubemap,s=t.probePlanarmap,r=t.probeCubemap;1===e?(this.model.updateReflectionProbeCubemap(r),this.model.updateReflectionProbePlanarMap(null),this.model.updateReflectionProbeBlendCubemap(null)):3===e||4===e?(this.model.updateReflectionProbeCubemap(r),this.model.updateReflectionProbeBlendCubemap(i),this.model.updateReflectionProbePlanarMap(null)):2===e?(this.model.updateReflectionProbePlanarMap(s),this.model.updateReflectionProbeCubemap(null),this.model.updateReflectionProbeBlendCubemap(null)):(this.model.updateReflectionProbeCubemap(null),this.model.updateReflectionProbePlanarMap(null),this.model.updateReflectionProbeBlendCubemap(null))}_updateModels(){if(!this.enabledInHierarchy)return;const t=this._model;if(t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model){if(this._mesh){const t=this._mesh.struct;this._model.createBoundingShape(t.minPosition,t.maxPosition),this._model.updateWorldBound()}this._model.initLightingmap(this.bakeSettings.texture,this.bakeSettings.uvParam),this._updateUseLightProbe(),this._updateUseReflectionProbeType(),this._updateModelParams(),this._onUpdateLightingmap(),this._onUpdateLocalShadowBiasAndProbeId(),this._updateUseReflectionProbe(),this._updateReceiveDirLight(),this._onUpdateReflectionProbeDataMap(),this._onUpdateLocalReflectionProbeData()}}_updateReceiveDirLight(){if(!this._model)return;const t=this.node.scene;if(!t||!t.renderScene)return;const e=t.renderScene.mainLight;if(!e)return;const i=e.visibility;if(e.node)if(e.node.mobility===yS.Static){let t=!1;this.bakeSettings.texture&&!this.node.scene.globals.disableLightmap&&(t=!0),this.node.scene.globals.lightProbeInfo.data&&this.node.scene.globals.lightProbeInfo.data.hasCoefficients()&&this._model.useLightProbe&&(t=!0),this.onUpdateReceiveDirLight(i,t)}else this.onUpdateReceiveDirLight(i)}_createModel(){const t=this._morphInstance&&this._modelType===CA?sH:this._modelType,e=this._model=h.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(e),this._morphInstance&&e instanceof sH&&e.setMorphRendering(this._morphInstance)}_attachToScene(){if(!this.node.scene||!this._model)return;const t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}_detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}_updateModelParams(){if(!this._mesh||!this._model)return;this.node.hasChangedFlags|=1,this._model.transform.hasChangedFlags|=1,this._model.isDynamicBatching=this._isBatchingEnabled();const t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(let i=0;i<t;++i){let t=this.getRenderMaterial(i);t&&!t.isValid&&(t=null);const s=e[i];s&&this._model.initSubModel(i,s,t||this._getBuiltinMaterial())}this._model.enabled=!0}_onUpdateLightingmap(){null!==this.model&&this.model.updateLightingmap(this.bakeSettings.texture,this.bakeSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.bakeSettings.uvParam.x,this.bakeSettings.uvParam.y,this.bakeSettings.uvParam.z,this.bakeSettings.uvParam.w])}_onUpdateLocalShadowBiasAndProbeId(){null!==this.model&&(this.model.updateLocalShadowBias(),this.model.updateReflectionProbeId()),this.setInstancedAttribute("a_localShadowBiasAndProbeId",[this._shadowBias,this._shadowNormalBias,this._reflectionProbeId,this._reflectionProbeBlendId])}_onUpdateLocalReflectionProbeData(){1!==this.bakeSettings.reflectionProbe&&3!==this.bakeSettings.reflectionProbe&&4!==this.bakeSettings.reflectionProbe||(null!==this.model&&this.model.updateReflectionProbeId(),this.setInstancedAttribute("a_reflectionProbeData",[this._reflectionProbeBlendWeight,0,0,0]))}_onUpdateReflectionProbeDataMap(){null!==this.model&&this.model.updateReflectionProbeDataMap(this._reflectionProbeDataMap)}_onMaterialModified(t,e){this._model&&this._model.inited&&(this._onRebuildPSO(t,e||this._getBuiltinMaterial()),this._updateStandardSkin())}_onRebuildPSO(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap(),this._onUpdateLocalShadowBiasAndProbeId(),this._updateReflectionProbeTexture(),this._onUpdateReflectionProbeDataMap(),this._onUpdateLocalReflectionProbeData())}_onMeshChanged(t){}_clearMaterials(){if(!this._model)return;const t=this._model.subModels;for(let e=0;e<t.length;++e)this._onMaterialModified(e,null)}_getBuiltinMaterial(){return pw.get("missing-material")}_onVisibilityChange(t){this._model&&(this._model.visFlags=t)}_updateShadowBias(){this._model&&(this._model.shadowBias=this._shadowBias)}_updateShadowNormalBias(){this._model&&(this._model.shadowNormalBias=this._shadowNormalBias)}_updateCastShadow(){this._model&&(this._shadowCastingMode===oG.OFF?this._model.castShadow=!1:(this._shadowCastingMode,oG.ON,this._shadowCastingMode,this._model.castShadow=!0))}_updateReceiveShadow(){this._model&&(this._shadowReceivingMode===aG.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}onMobilityChanged(){this._updateUseLightProbe(),this._updateReceiveDirLight()}onLightProbeBakingChanged(){this._updateReceiveDirLight()}onUseLightProbeChanged(){this._updateUseLightProbe()}onReflectionProbeChanged(){this._updateUseReflectionProbe(),this._onUpdateLocalShadowBiasAndProbeId();const t=h.internal.reflectionProbeManager,e=this._model;1===this.bakeSettings.reflectionProbe||3===this.bakeSettings.reflectionProbe||4===this.bakeSettings.reflectionProbe?(t.selectReflectionProbe(e),t.getUsedReflectionProbe(e,!1)||G(16302)):2===this.bakeSettings.reflectionProbe&&(t.selectPlanarReflectionProbe(e),t.getUsedReflectionProbe(e,!0)||G(16302))}onBakeToReflectionProbeChanged(){this._updateBakeToReflectionProbe()}_updateUseLightProbe(){if(!this._model)return;const t=this.node;this._mesh&&t&&t.mobility===yS.Movable&&this.bakeSettings.useLightProbe?this._model.useLightProbe=!0:this._model.useLightProbe=!1}_isBatchingEnabled(){for(let t=0;t<this._materials.length;++t){const e=this._materials[t];if(e)for(let t=0;t<e.passes.length;++t)if(e.passes[t].batchingScheme)return!0}return!1}_updateUseReflectionProbe(){this._model&&(this._model.reflectionProbeType=this.bakeSettings.reflectionProbe,this._updateReflectionProbeTexture())}_updateUseReflectionProbeType(){this._model&&(this._model.reflectionProbeType=this.bakeSettings.reflectionProbe)}_updateBakeToReflectionProbe(){this._model&&(this._model.bakeToReflectionProbe=this.bakeSettings.bakeToReflectionProbe)}_watchMorphInMesh(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),!this._enableMorph)return;if(!this._mesh||!this._mesh.struct.morph||!this._mesh.morphRendering)return;this._morphInstance=this._mesh.morphRendering.createInstance();const t=this._mesh.struct.primitives.length;for(let e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof sH&&this._model.setMorphRendering(this._morphInstance)}_initSubMeshShapesWeights(){const{_mesh:t}=this;if(this._subMeshShapesWeights.length=0,!t)return;const e=t.struct.morph;if(!e)return;const i=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((t=>t?t.weights?t.weights.slice(0):i?(i.length,t.targets.length,i.slice(0)):new Array(t.targets.length).fill(0):[]))}_validateShapeWeights(){const{_mesh:t,_subMeshShapesWeights:e}=this;if(!t||!t.struct.morph)return 0===e.length;const{morph:i}=t.struct;return i.subMeshMorphs.length===e.length&&e.every(((t,e)=>{var s,r;let{length:n}=t;return(null!==(s=null===(r=i.subMeshMorphs[e])||void 0===r?void 0:r.targets.length)&&void 0!==s?s:0)===n}))}_uploadSubMeshShapesWeights(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])}_updateStandardSkin(){const t=h.director.root.pipeline.pipelineSceneData;if(this._enabledGlobalStandardSkinObject&&(t.standardSkinMeshRenderer=this,t.standardSkinModel=this.model),!t.skinMaterialModel&&this._model){const e=this._model.subModels;for(let i=0;i<e.length;i++)if(!(nG(e[i])<0))return void(t.skinMaterialModel=this._model)}}},$H.ShadowCastingMode=oG,$H.ShadowReceivingMode=aG,LH=Qo((OH=$H).prototype,"bakeSettings",[eG],(function(){return new hG})),FH=Qo(OH.prototype,"_mesh",[eG],(function(){return null})),zH=Qo(OH.prototype,"_shadowCastingMode",[eG],(function(){return oG.OFF})),kH=Qo(OH.prototype,"_shadowReceivingMode",[eG],(function(){return aG.ON})),NH=Qo(OH.prototype,"_shadowBias",[eG],(function(){return 0})),UH=Qo(OH.prototype,"_shadowNormalBias",[eG],(function(){return 0})),VH=Qo(OH.prototype,"_reflectionProbeId",[eG],(function(){return-1})),HH=Qo(OH.prototype,"_reflectionProbeBlendId",[eG],(function(){return-1})),GH=Qo(OH.prototype,"_reflectionProbeBlendWeight",[eG],(function(){return 0})),WH=Qo(OH.prototype,"_enabledGlobalStandardSkinObject",[eG],(function(){return!1})),s(OH.prototype,"shadowBias",[EH],Object.getOwnPropertyDescriptor(OH.prototype,"shadowBias"),OH.prototype),s(OH.prototype,"shadowNormalBias",[DH],Object.getOwnPropertyDescriptor(OH.prototype,"shadowNormalBias"),OH.prototype),s(OH.prototype,"shadowCastingMode",[AH],Object.getOwnPropertyDescriptor(OH.prototype,"shadowCastingMode"),OH.prototype),s(OH.prototype,"receiveShadow",[MH],Object.getOwnPropertyDescriptor(OH.prototype,"receiveShadow"),OH.prototype),s(OH.prototype,"mesh",[PH],Object.getOwnPropertyDescriptor(OH.prototype,"mesh"),OH.prototype),s(OH.prototype,"isGlobalStandardSkinObject",[BH],Object.getOwnPropertyDescriptor(OH.prototype,"isGlobalStandardSkinObject"),OH.prototype),jH=Qo(OH.prototype,"_enableMorph",[eG],(function(){return!0})),RH=OH))||RH)||RH));function cG(t,e){const i=t.sharedMaterials.length;if(i!==e.sharedMaterials.length)return!1;for(let s=0;s<i;s++)if(t.getRenderMaterial(s)!==e.getRenderMaterial(s))return!1;return!0}var uG,dG,pG,_G,gG,fG,mG,yG;t("BatchingUtility",class{static batchStaticModel(t,e){const i=t.getComponentsInChildren(lG);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(let t=1;t<i.length;t++){if(!i[0].mesh.validateMergingMesh(i[t].mesh))return console.error(`the meshes of ${i[0].node.name} and ${i[t].node.name} can't be merged`),!1;if(!cG(i[0],i[t]))return console.error(`the materials of ${i[0].node.name} and ${i[t].node.name} can't be merged`),!1}const s=new ZP,r=new Rs,n=new Rs;t.getWorldMatrix(n),Rs.invert(n,n);for(let t=0;t<i.length;t++){const e=i[t];e.node.getWorldMatrix(r),Rs.multiply(r,n,r),s.merge(i[t].mesh,r),e.enabled=!1}const o=e.addComponent(lG);return o.mesh=s,o.sharedMaterials=i[0].sharedMaterials,!0}static unbatchStaticModel(t,e){const i=t.getComponentsInChildren(lG);for(let t=0;t<i.length;t++)i[t].enabled=!0;const s=e.getComponent(lG);return s&&(s.mesh&&s.mesh.destroyRenderingMesh(),s.destroy()),!0}});let vG=t("Skeleton",(uG=oa("cc.Skeleton"),dG=Ga([Re]),pG=Ga([Rs]),uG((gG=class extends F_{constructor(){super(),this._joints=fG&&fG(),this._bindposes=mG&&mG(),this._hash=yG&&yG(),this._invBindposes=null}get joints(){return this._joints}set joints(t){this._joints=t}get bindposes(){return this._bindposes}set bindposes(t){this._bindposes=t}get inverseBindposes(){if(!this._invBindposes){this._invBindposes=[];for(let t=0;t<this._bindposes.length;t++){const e=new Rs;Rs.invert(e,this._bindposes[t]),this._invBindposes.push(e)}}return this._invBindposes}get hash(){if(!this._hash){let t="";for(let e=0;e<this._bindposes.length;e++){const i=this._bindposes[e];t+=`${i.m00.toPrecision(2)} ${i.m01.toPrecision(2)} ${i.m02.toPrecision(2)} ${i.m03.toPrecision(2)} ${i.m04.toPrecision(2)} ${i.m05.toPrecision(2)} ${i.m06.toPrecision(2)} ${i.m07.toPrecision(2)} ${i.m08.toPrecision(2)} ${i.m09.toPrecision(2)} ${i.m10.toPrecision(2)} ${i.m11.toPrecision(2)} ${i.m12.toPrecision(2)} ${i.m13.toPrecision(2)} ${i.m14.toPrecision(2)} ${i.m15.toPrecision(2)}\n`}this._hash=du(t,666)}return this._hash}destroy(){var t,e;return null===(t=h.director.root)||void 0===t||null===(e=t.dataPoolManager)||void 0===e||e.releaseSkeleton(this),super.destroy()}validate(){return this.joints.length>0&&this.bindposes.length>0}},fG=Qo(gG.prototype,"_joints",[dG],(function(){return[]})),mG=Qo(gG.prototype,"_bindposes",[pG],(function(){return[]})),yG=Qo(gG.prototype,"_hash",[va],(function(){return 0})),_G=gG))||_G));var bG,wG,SG,xG,TG,CG,IG,EG,DG,AG,MG,PG,BG,RG,OG,LG;h.Skeleton=vG;const FG=new Ki,zG=te({LUMINOUS_FLUX:0,LUMINANCE:1});let kG=oa("cc.StaticLightSettings")((wG=class{constructor(){this._baked=SG&&SG(),this._editorOnly=xG&&xG(),this._castShadow=TG&&TG()}get editorOnly(){return this._editorOnly}set editorOnly(t){this._editorOnly=t}get baked(){return this._baked}set baked(t){this._baked=t}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}},SG=Qo(wG.prototype,"_baked",[va],(function(){return!1})),xG=Qo(wG.prototype,"_editorOnly",[va],(function(){return!1})),TG=Qo(wG.prototype,"_castShadow",[va],(function(){return!1})),bG=wG))||bG,NG=t("Light",(CG=oa("cc.Light"),IG=Ga(kG),EG=Ga(Kf.BitMask),CG(((LG=class extends Ag{get color(){return this._color}set color(t){this._color=t.clone(),this._light&&(FG.x=t.r/255,FG.y=t.g/255,FG.z=t.b/255,this._light.color=FG)}get useColorTemperature(){return this._useColorTemperature}set useColorTemperature(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}get colorTemperature(){return this._colorTemperature}set colorTemperature(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}get staticSettings(){return this._staticSettings}set staticSettings(t){this._staticSettings=t}get type(){return this._type}get baked(){return this.staticSettings.baked}set baked(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}set visibility(t){this._visibility=t,this._light&&(this._light.visibility=t),this._onUpdateReceiveDirLight()}get visibility(){return this._visibility}constructor(){super(),this._color=MG&&MG(),this._useColorTemperature=PG&&PG(),this._colorTemperature=BG&&BG(),this._staticSettings=RG&&RG(),this._visibility=OG&&OG(),this._type=5,this._lightType=void 0,this._light=null,this._lightType=AA}onLoad(){this._createLight()}onEnable(){this._attachToScene()}onDisable(){this._detachFromScene()}onDestroy(){this._destroyLight()}_createLight(){this._light||(this._light=h.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked,this._light.visibility=this.visibility}_destroyLight(){this._light&&(h.director.root.recycleLight(this._light),this._light=null)}_attachToScene(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){const t=this._getRenderScene();switch(this._type){case 0:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case 1:t.addSphereLight(this._light);break;case 2:t.addSpotLight(this._light);break;case 3:t.addPointLight(this._light);break;case 4:t.addRangedDirLight(this._light)}}}_detachFromScene(){if(this._light&&this._light.scene){const t=this._light.scene;switch(this._type){case 0:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case 1:t.removeSphereLight(this._light);break;case 2:t.removeSpotLight(this._light);break;case 3:t.removePointLight(this._light);break;case 4:t.removeRangedDirLight(this._light)}}}_onUpdateReceiveDirLight(){}}).Type=EA,LG.PhotometricTerm=zG,MG=Qo((AG=LG).prototype,"_color",[va],(function(){return _r.WHITE.clone()})),PG=Qo(AG.prototype,"_useColorTemperature",[va],(function(){return!1})),BG=Qo(AG.prototype,"_colorTemperature",[va],(function(){return 6550})),RG=Qo(AG.prototype,"_staticSettings",[va],(function(){return new kG})),OG=Qo(AG.prototype,"_visibility",[va],(function(){return Fy})),s(AG.prototype,"staticSettings",[IG],Object.getOwnPropertyDescriptor(AG.prototype,"staticSettings"),AG.prototype),s(AG.prototype,"visibility",[EG],Object.getOwnPropertyDescriptor(AG.prototype,"visibility"),AG.prototype),DG=AG))||DG));var UG,VG,HG,GG,WG,jG,$G,qG,XG,YG,QG,KG,ZG,JG,tW,eW,iW,sW,rW,nW,oW,aW,hW,lW,cW,uW,dW,pW,_W,gW,fW,mW,yW,vW,bW,wW,SW,xW,TW,CW,IW,EW,DW,AW,MW,PW,BW,RW,OW,LW,FW,zW,kW,NW,UW,VW,HW,GW,WW,jW;const{ccclass:$W,menu:qW,executeInEditMode:XW,property:YW,serializable:QW,formerlySerializedAs:KW,tooltip:ZW,help:JW,visible:tj,type:ej,editable:ij,slide:sj,range:rj}=Ja;var nj,oj,aj,hj,lj,cj,uj,dj,pj,_j,gj,fj,mj,yj,vj,bj,wj,Sj,xj,Tj,Cj,Ij,Ej,Dj,Aj,Mj,Pj,Bj,Rj,Oj,Lj,Fj,zj,kj,Nj,Uj,Vj,Hj,Gj;t("DirectionalLight",(UG=$W("cc.DirectionalLight"),VG=KW("_illuminance"),HG=ej(Me),GG=YW({group:{name:"DynamicShadowSettings",displayOrder:1}}),WG=ej(Be),jG=YW({group:{name:"DynamicShadowSettings",displayOrder:5}}),$G=ej(Qw),qG=YW({group:{name:"DynamicShadowSettings",displayOrder:6}}),XG=ej(Pe),YG=YW({group:{name:"DynamicShadowSettings",displayOrder:7}}),QG=ej(Pe),KG=YW({group:{name:"DynamicShadowSettings",displayOrder:8}}),ZG=ej(Pe),JG=YW({group:{name:"DynamicShadowSettings",displayOrder:9}}),tW=ej(Pe),eW=YW({group:{name:"DynamicShadowSettings",displayOrder:22}}),iW=ej(Pe),sW=YW({group:{name:"DynamicShadowSettings",displayOrder:10}}),rW=ej(Kw),nW=YW({group:{name:"DynamicShadowSettings",displayOrder:11}}),oW=ej(Be),aW=YW({group:{name:"DynamicShadowSettings",displayOrder:12}}),hW=ej(Pe),lW=YW({group:{name:"DynamicShadowSettings",displayOrder:13}}),cW=ej(Zw),uW=YW({group:{name:"DynamicShadowSettings",displayOrder:14}}),dW=ej(Be),pW=YW({group:{name:"DynamicShadowSettings",displayOrder:15}}),_W=ej(Pe),gW=YW({group:{name:"DynamicShadowSettings",displayOrder:16}}),fW=ej(Pe),mW=YW({group:{name:"DynamicShadowSettings",displayOrder:17}}),yW=ej(Pe),vW=YW({group:{name:"DynamicShadowSettings",displayOrder:19}}),bW=ej(Be),wW=YW({group:{name:"DynamicShadowSettings",displayOrder:20}}),SW=ej(Be),xW=YW({group:{name:"DynamicShadowSettings",displayOrder:21}}),TW=ej(Pe),UG((IW=class extends NG{get illuminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR}set illuminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=t,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=t,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(t){this._shadowEnabled=t,this._light&&(this._light.shadowEnabled=this._shadowEnabled)}get shadowPcf(){return this._shadowPcf}set shadowPcf(t){this._shadowPcf=t,this._light&&(this._light.shadowPcf=this._shadowPcf)}get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t,this._light&&(this._light.shadowBias=this._shadowBias)}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t,this._light&&(this._light.shadowNormalBias=this._shadowNormalBias)}get shadowSaturation(){return this._shadowSaturation}set shadowSaturation(t){this._shadowSaturation=fi(t,0,1),this._light&&(this._light.shadowSaturation=this._shadowSaturation)}get shadowDistance(){return this._shadowDistance}set shadowDistance(t){this._shadowDistance=Math.min(t,tS.MAX_FAR),this._shadowDistance/.1<10&&G(15003,this._shadowDistance),this._light&&(this._light.shadowDistance=this._shadowDistance,this._light.csmNeedUpdate=!0)}get shadowInvisibleOcclusionRange(){return this._shadowInvisibleOcclusionRange}set shadowInvisibleOcclusionRange(t){this._shadowInvisibleOcclusionRange=Math.min(t,tS.MAX_FAR),this._light&&(this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange)}get csmLevel(){return this._csmLevel}set csmLevel(t){this._csmLevel=t,this._light&&(this._light.csmLevel=this._csmLevel,this._light.csmNeedUpdate=!0)}get enableCSM(){return this._csmLevel>Kw.LEVEL_1}set enableCSM(t){this._csmLevel=t?Kw.LEVEL_4:Kw.LEVEL_1,this._light&&(this._light.csmLevel=this._csmLevel,this._light.csmNeedUpdate=!0)}get csmLayerLambda(){return this._csmLayerLambda}set csmLayerLambda(t){this._csmLayerLambda=t,this._light&&(this._light.csmLayerLambda=this._csmLayerLambda,this._light.csmNeedUpdate=!0)}get csmOptimizationMode(){return this._csmOptimizationMode}set csmOptimizationMode(t){this._csmOptimizationMode=t,this._light&&(this._light.csmOptimizationMode=this._csmOptimizationMode)}get shadowFixedArea(){return this._shadowFixedArea}set shadowFixedArea(t){this._shadowFixedArea=t,this._light&&(this._light.shadowFixedArea=this._shadowFixedArea)}get shadowNear(){return this._shadowNear}set shadowNear(t){this._shadowNear=t,this._light&&(this._light.shadowNear=this._shadowNear)}get shadowFar(){return this._shadowFar}set shadowFar(t){this._shadowFar=Math.min(t,tS.MAX_FAR),this._light&&(this._light.shadowFar=this._shadowFar)}get shadowOrthoSize(){return this._shadowOrthoSize}set shadowOrthoSize(t){this._shadowOrthoSize=t,this._light&&(this._light.shadowOrthoSize=this._shadowOrthoSize)}get csmAdvancedOptions(){return this._csmAdvancedOptions}set csmAdvancedOptions(t){this._csmAdvancedOptions=t}get csmLayersTransition(){return this._csmLayersTransition}set csmLayersTransition(t){this._csmLayersTransition=t,this._light&&(this._light.csmLayersTransition=t)}get csmTransitionRange(){return this._csmTransitionRange}set csmTransitionRange(t){this._csmTransitionRange=t,this._light&&(this._light.csmTransitionRange=t)}constructor(){super(),this._illuminanceHDR=EW&&EW(),this._illuminanceLDR=DW&&DW(),this._shadowEnabled=AW&&AW(),this._shadowPcf=MW&&MW(),this._shadowBias=PW&&PW(),this._shadowNormalBias=BW&&BW(),this._shadowSaturation=RW&&RW(),this._shadowDistance=OW&&OW(),this._shadowInvisibleOcclusionRange=LW&&LW(),this._csmLevel=FW&&FW(),this._csmLayerLambda=zW&&zW(),this._csmOptimizationMode=kW&&kW(),this._csmAdvancedOptions=NW&&NW(),this._csmLayersTransition=UW&&UW(),this._csmTransitionRange=VW&&VW(),this._shadowFixedArea=HW&&HW(),this._shadowNear=GW&&GW(),this._shadowFar=WW&&WW(),this._shadowOrthoSize=jW&&jW(),this._lightType=BA,ae.querySettings("rendering","highQualityMode")&&(this._shadowPcf=Qw.SOFT_2X,this._shadowDistance=50,this.enableCSM=!0,this.staticSettings.castShadow=!0)}_createLight(){if(super._createLight(),this._type=0,this._light){const t=this._light;t.illuminanceHDR=this._illuminanceHDR,t.illuminanceLDR=this._illuminanceLDR,t.shadowEnabled=this._shadowEnabled,t.shadowPcf=this._shadowPcf,t.shadowBias=this._shadowBias,t.shadowNormalBias=this._shadowNormalBias,t.shadowSaturation=this._shadowSaturation,t.shadowDistance=this._shadowDistance,t.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange,t.shadowFixedArea=this._shadowFixedArea,t.shadowNear=this._shadowNear,t.shadowFar=this._shadowFar,t.shadowOrthoSize=this._shadowOrthoSize,t.csmLevel=this._csmLevel,t.csmLayerLambda=this._csmLayerLambda,t.csmOptimizationMode=this._csmOptimizationMode,t.csmLayersTransition=this._csmLayersTransition,t.csmTransitionRange=this._csmTransitionRange}}_onUpdateReceiveDirLight(){if(!this._light)return;super._onUpdateReceiveDirLight();const t=this.node.scene;if(!t||!t.renderScene)return;if(t.renderScene.mainLight!==this._light)return;const e=t.renderScene.models;for(let t=0;t<e.length;t++){const i=e[t];if(!i.node)continue;const s=i.node.getComponent(lG);s&&s.onUpdateReceiveDirLight(this._visibility)}}},EW=Qo(IW.prototype,"_illuminanceHDR",[YW,VG],(function(){return 65e3})),DW=Qo(IW.prototype,"_illuminanceLDR",[QW],(function(){return 65e3*_A.standardExposureValue})),AW=Qo(IW.prototype,"_shadowEnabled",[QW],(function(){return!1})),MW=Qo(IW.prototype,"_shadowPcf",[QW],(function(){return Qw.HARD})),PW=Qo(IW.prototype,"_shadowBias",[QW],(function(){return 1e-5})),BW=Qo(IW.prototype,"_shadowNormalBias",[QW],(function(){return 0})),RW=Qo(IW.prototype,"_shadowSaturation",[QW],(function(){return 1})),OW=Qo(IW.prototype,"_shadowDistance",[QW],(function(){return 50})),LW=Qo(IW.prototype,"_shadowInvisibleOcclusionRange",[QW],(function(){return 200})),FW=Qo(IW.prototype,"_csmLevel",[QW],(function(){return Kw.LEVEL_4})),zW=Qo(IW.prototype,"_csmLayerLambda",[QW],(function(){return.75})),kW=Qo(IW.prototype,"_csmOptimizationMode",[QW],(function(){return Zw.RemoveDuplicates})),NW=Qo(IW.prototype,"_csmAdvancedOptions",[QW],(function(){return!1})),UW=Qo(IW.prototype,"_csmLayersTransition",[QW],(function(){return!1})),VW=Qo(IW.prototype,"_csmTransitionRange",[QW],(function(){return.05})),HW=Qo(IW.prototype,"_shadowFixedArea",[QW],(function(){return!1})),GW=Qo(IW.prototype,"_shadowNear",[QW],(function(){return.1})),WW=Qo(IW.prototype,"_shadowFar",[QW],(function(){return 10})),jW=Qo(IW.prototype,"_shadowOrthoSize",[QW],(function(){return 5})),s(IW.prototype,"illuminance",[HG],Object.getOwnPropertyDescriptor(IW.prototype,"illuminance"),IW.prototype),s(IW.prototype,"shadowEnabled",[GG,WG],Object.getOwnPropertyDescriptor(IW.prototype,"shadowEnabled"),IW.prototype),s(IW.prototype,"shadowPcf",[jG,$G],Object.getOwnPropertyDescriptor(IW.prototype,"shadowPcf"),IW.prototype),s(IW.prototype,"shadowBias",[qG,XG],Object.getOwnPropertyDescriptor(IW.prototype,"shadowBias"),IW.prototype),s(IW.prototype,"shadowNormalBias",[YG,QG],Object.getOwnPropertyDescriptor(IW.prototype,"shadowNormalBias"),IW.prototype),s(IW.prototype,"shadowSaturation",[KG,ZG],Object.getOwnPropertyDescriptor(IW.prototype,"shadowSaturation"),IW.prototype),s(IW.prototype,"shadowDistance",[JG,tW],Object.getOwnPropertyDescriptor(IW.prototype,"shadowDistance"),IW.prototype),s(IW.prototype,"shadowInvisibleOcclusionRange",[eW,iW],Object.getOwnPropertyDescriptor(IW.prototype,"shadowInvisibleOcclusionRange"),IW.prototype),s(IW.prototype,"csmLevel",[sW,rW],Object.getOwnPropertyDescriptor(IW.prototype,"csmLevel"),IW.prototype),s(IW.prototype,"enableCSM",[nW,oW],Object.getOwnPropertyDescriptor(IW.prototype,"enableCSM"),IW.prototype),s(IW.prototype,"csmLayerLambda",[aW,hW],Object.getOwnPropertyDescriptor(IW.prototype,"csmLayerLambda"),IW.prototype),s(IW.prototype,"csmOptimizationMode",[lW,cW],Object.getOwnPropertyDescriptor(IW.prototype,"csmOptimizationMode"),IW.prototype),s(IW.prototype,"shadowFixedArea",[uW,dW],Object.getOwnPropertyDescriptor(IW.prototype,"shadowFixedArea"),IW.prototype),s(IW.prototype,"shadowNear",[pW,_W],Object.getOwnPropertyDescriptor(IW.prototype,"shadowNear"),IW.prototype),s(IW.prototype,"shadowFar",[gW,fW],Object.getOwnPropertyDescriptor(IW.prototype,"shadowFar"),IW.prototype),s(IW.prototype,"shadowOrthoSize",[mW,yW],Object.getOwnPropertyDescriptor(IW.prototype,"shadowOrthoSize"),IW.prototype),s(IW.prototype,"csmAdvancedOptions",[vW,bW],Object.getOwnPropertyDescriptor(IW.prototype,"csmAdvancedOptions"),IW.prototype),s(IW.prototype,"csmLayersTransition",[wW,SW],Object.getOwnPropertyDescriptor(IW.prototype,"csmLayersTransition"),IW.prototype),s(IW.prototype,"csmTransitionRange",[xW,TW],Object.getOwnPropertyDescriptor(IW.prototype,"csmTransitionRange"),IW.prototype),CW=IW))||CW)),t("SphereLight",(nj=oa("cc.SphereLight"),oj=ba("_luminance"),aj=Ga(Me),hj=Ga(Me),lj=Ga(zG),cj=Ga(Pe),uj=Ga(Pe),nj((pj=class extends NG{get luminousFlux(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*DA(this._size):this._luminanceLDR}set luminousFlux(t){let e=0;h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/DA(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}get luminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR}set luminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}get term(){return this._term}set term(t){this._term=t}get size(){return this._size}set size(t){this._size=t,this._light&&(this._light.size=t)}get range(){return this._range}set range(t){this._range=t,this._light&&(this._light.range=t)}constructor(){super(),this._size=_j&&_j(),this._luminanceHDR=gj&&gj(),this._luminanceLDR=fj&&fj(),this._term=mj&&mj(),this._range=yj&&yj(),this._lightType=RA}_createLight(){super._createLight(),this._type=1,this.size=this._size,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)}},_j=Qo(pj.prototype,"_size",[va],(function(){return.15})),gj=Qo(pj.prototype,"_luminanceHDR",[va,oj],(function(){return 1700/DA(.15)})),fj=Qo(pj.prototype,"_luminanceLDR",[va],(function(){return 1700/DA(.15)*_A.standardExposureValue*_A.standardLightMeterScale})),mj=Qo(pj.prototype,"_term",[va],(function(){return zG.LUMINOUS_FLUX})),yj=Qo(pj.prototype,"_range",[va],(function(){return 1})),s(pj.prototype,"luminousFlux",[aj],Object.getOwnPropertyDescriptor(pj.prototype,"luminousFlux"),pj.prototype),s(pj.prototype,"luminance",[hj],Object.getOwnPropertyDescriptor(pj.prototype,"luminance"),pj.prototype),s(pj.prototype,"term",[lj],Object.getOwnPropertyDescriptor(pj.prototype,"term"),pj.prototype),s(pj.prototype,"size",[cj],Object.getOwnPropertyDescriptor(pj.prototype,"size"),pj.prototype),s(pj.prototype,"range",[uj],Object.getOwnPropertyDescriptor(pj.prototype,"range"),pj.prototype),dj=pj))||dj));const{ccclass:Wj,range:jj,slide:$j,type:qj,editable:Xj,displayOrder:Yj,help:Qj,executeInEditMode:Kj,menu:Zj,tooltip:Jj,serializable:t$,formerlySerializedAs:e$,visible:i$,property:s$}=Ja;var r$,n$,o$,a$,h$,l$,c$,u$,d$,p$,_$,g$,f$,m$,y$,v$,b$,w$,S$;t("SpotLight",(vj=Wj("cc.SpotLight"),bj=e$("_luminance"),wj=qj(zG),Sj=qj(Pe),xj=s$({group:{name:"DynamicShadowSettings",displayOrder:1}}),Tj=qj(Be),Cj=s$({group:{name:"DynamicShadowSettings",displayOrder:2}}),Ij=qj(Qw),Ej=s$({group:{name:"DynamicShadowSettings",displayOrder:3}}),Dj=qj(Pe),Aj=s$({group:{name:"DynamicShadowSettings",displayOrder:4}}),Mj=qj(Pe),vj((Bj=class extends NG{get luminousFlux(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*DA(this._size):this._luminanceLDR}set luminousFlux(t){let e=0;h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/DA(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}get luminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR}set luminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}get term(){return this._term}set term(t){this._term=t}get size(){return this._size}set size(t){this._size=t,this._light&&(this._light.size=t)}get range(){return this._range}set range(t){this._range=t,this._light&&(this._light.range=t)}get spotAngle(){return this._spotAngle}set spotAngle(t){this._spotAngle=t,this._light&&(this._light.spotAngle=vi(t))}get angleAttenuationStrength(){return this._angleAttenuationStrength}set angleAttenuationStrength(t){this._angleAttenuationStrength=t,this._light&&(this._light.angleAttenuationStrength=t)}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(t){this._shadowEnabled=t,this._light&&(this._light.shadowEnabled=t)}get shadowPcf(){return this._shadowPcf}set shadowPcf(t){this._shadowPcf=t,this._light&&(this._light.shadowPcf=t)}get shadowBias(){return this._shadowBias}set shadowBias(t){this._shadowBias=t,this._light&&(this._light.shadowBias=t)}get shadowNormalBias(){return this._shadowNormalBias}set shadowNormalBias(t){this._shadowNormalBias=t,this._light&&(this._light.shadowNormalBias=t)}constructor(){super(),this._size=Rj&&Rj(),this._luminanceHDR=Oj&&Oj(),this._luminanceLDR=Lj&&Lj(),this._term=Fj&&Fj(),this._range=zj&&zj(),this._spotAngle=kj&&kj(),this._angleAttenuationStrength=Nj&&Nj(),this._shadowEnabled=Uj&&Uj(),this._shadowPcf=Vj&&Vj(),this._shadowBias=Hj&&Hj(),this._shadowNormalBias=Gj&&Gj(),this._lightType=UA}_createLight(){if(super._createLight(),this._type=2,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,this.angleAttenuationStrength=this._angleAttenuationStrength,this._light){const t=this._light;t.luminanceHDR=this._luminanceHDR,t.luminanceLDR=this._luminanceLDR,t.shadowEnabled=this._shadowEnabled,t.shadowPcf=this._shadowPcf,t.shadowBias=this._shadowBias,t.shadowNormalBias=this._shadowNormalBias}}},Rj=Qo(Bj.prototype,"_size",[t$],(function(){return.15})),Oj=Qo(Bj.prototype,"_luminanceHDR",[t$,bj],(function(){return 1700/DA(.15)})),Lj=Qo(Bj.prototype,"_luminanceLDR",[t$],(function(){return 1700/DA(.15)*_A.standardExposureValue*_A.standardLightMeterScale})),Fj=Qo(Bj.prototype,"_term",[t$],(function(){return zG.LUMINOUS_FLUX})),zj=Qo(Bj.prototype,"_range",[t$],(function(){return 1})),kj=Qo(Bj.prototype,"_spotAngle",[t$],(function(){return 60})),Nj=Qo(Bj.prototype,"_angleAttenuationStrength",[t$],(function(){return 0})),Uj=Qo(Bj.prototype,"_shadowEnabled",[t$],(function(){return!1})),Vj=Qo(Bj.prototype,"_shadowPcf",[t$],(function(){return Qw.HARD})),Hj=Qo(Bj.prototype,"_shadowBias",[t$],(function(){return 1e-5})),Gj=Qo(Bj.prototype,"_shadowNormalBias",[t$],(function(){return 0})),s(Bj.prototype,"term",[wj],Object.getOwnPropertyDescriptor(Bj.prototype,"term"),Bj.prototype),s(Bj.prototype,"size",[Sj],Object.getOwnPropertyDescriptor(Bj.prototype,"size"),Bj.prototype),s(Bj.prototype,"shadowEnabled",[xj,Tj],Object.getOwnPropertyDescriptor(Bj.prototype,"shadowEnabled"),Bj.prototype),s(Bj.prototype,"shadowPcf",[Cj,Ij],Object.getOwnPropertyDescriptor(Bj.prototype,"shadowPcf"),Bj.prototype),s(Bj.prototype,"shadowBias",[Ej,Dj],Object.getOwnPropertyDescriptor(Bj.prototype,"shadowBias"),Bj.prototype),s(Bj.prototype,"shadowNormalBias",[Aj,Mj],Object.getOwnPropertyDescriptor(Bj.prototype,"shadowNormalBias"),Bj.prototype),Pj=Bj))||Pj)),t("PointLight",(r$=oa("cc.PointLight"),n$=ba("_luminance"),o$=Ga(Me),a$=Ga(Me),h$=Ga(zG),l$=Ga(Pe),r$((u$=class extends NG{get luminousFlux(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*DA(1):this._luminanceLDR}set luminousFlux(t){let e=0;h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/DA(1),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}get luminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR}set luminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}get term(){return this._term}set term(t){this._term=t}get range(){return this._range}set range(t){this._range=t,this._light&&(this._light.range=t)}constructor(){super(),this._luminanceHDR=d$&&d$(),this._luminanceLDR=p$&&p$(),this._term=_$&&_$(),this._range=g$&&g$(),this._lightType=VA}_createLight(){super._createLight(),this._type=3,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)}},d$=Qo(u$.prototype,"_luminanceHDR",[va,n$],(function(){return 1700/DA(.15)})),p$=Qo(u$.prototype,"_luminanceLDR",[va],(function(){return 1700/DA(.15)*_A.standardExposureValue*_A.standardLightMeterScale})),_$=Qo(u$.prototype,"_term",[va],(function(){return zG.LUMINOUS_FLUX})),g$=Qo(u$.prototype,"_range",[va],(function(){return 1})),s(u$.prototype,"luminousFlux",[o$],Object.getOwnPropertyDescriptor(u$.prototype,"luminousFlux"),u$.prototype),s(u$.prototype,"luminance",[a$],Object.getOwnPropertyDescriptor(u$.prototype,"luminance"),u$.prototype),s(u$.prototype,"term",[h$],Object.getOwnPropertyDescriptor(u$.prototype,"term"),u$.prototype),s(u$.prototype,"range",[l$],Object.getOwnPropertyDescriptor(u$.prototype,"range"),u$.prototype),c$=u$))||c$)),t("RangedDirectionalLight",(f$=oa("cc.RangedDirectionalLight"),m$=ba("_illuminance"),y$=Ga(Me),f$((b$=class extends NG{get illuminance(){return h.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR}set illuminance(t){h.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=t,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=t,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}constructor(){super(),this._illuminanceHDR=w$&&w$(),this._illuminanceLDR=S$&&S$(),this._lightType=GA}_createLight(){super._createLight(),this._type=4,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)}},w$=Qo(b$.prototype,"_illuminanceHDR",[ca,m$],(function(){return 65e3})),S$=Qo(b$.prototype,"_illuminanceLDR",[va],(function(){return 65e3*_A.standardExposureValue})),s(b$.prototype,"illuminance",[y$],Object.getOwnPropertyDescriptor(b$.prototype,"illuminance"),b$.prototype),v$=b$))||v$));const x$=Symbol("BakeNodeCurves");class T${static getOrExtract(t){let e=T$.pool.get(t);if(!e||e.samples!==t.sample){e&&h.director.root.dataPoolManager.releaseAnimationClip(t);const i=Math.ceil(t.sample*t.duration)+1,s=t.sample;e=t[x$](0,s,i),T$.pool.set(t,e)}return e}static destroy(t){T$.pool.delete(t)}}t("SkelAnimDataHub",T$),T$.pool=new Map;const C$=new Rs;function I$(t,e,i){for(Rs.identity(i);t!==e;)Rs.fromRTS(C$,t.rotation,t.position,t.scale),Rs.multiply(i,C$,i),t=t.parent;return i}const E$=new Od(1,1,0,2,2,2),D$=function(t,e,i){t[e+0]=i.m00,t[e+1]=i.m01,t[e+2]=i.m02,t[e+3]=i.m12,t[e+4]=i.m04,t[e+5]=i.m05,t[e+6]=i.m06,t[e+7]=i.m13,t[e+8]=i.m08,t[e+9]=i.m09,t[e+10]=i.m10,t[e+11]=i.m14};function A$(t){return 2&t.getFormatFeatures(44)?44:35}function M$(t,e){const i=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*i,t)/12)}new ys,new ys,new Ki,new ys,new Ki;const P$=new Ki,B$=new Ki,R$=new Ki,O$=new Ki,L$=new Rs,F$=new Rs,z$=new Qn,k$=Number.MAX_SAFE_INTEGER;class N${get pixelsPerJoint(){return this._pixelsPerJoint}constructor(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;const e=A$(this._device);this._formatSize=mp[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new FL(t),this._pool.initialize({format:e,roundUpFn:M$}),this._customPool=new FL(t),this._customPool.initialize({format:e,roundUpFn:M$})}clear(){this._pool.destroy(),this._textureBuffers.clear()}registerCustomTextureLayouts(t){for(let e=0;e<t.length;e++){const i=t[e];let s=i.textureLength;2&this._device.getFormatFeatures(44)||(s*=2);const r=this._customPool.createChunk(s);for(let t=0;t<i.contents.length;t++){const e=i.contents[t],{skeleton:s}=e;this._chunkIdxMap.set(s,r);for(let t=0;t<e.clips.length;t++){const i=e.clips[t];this._chunkIdxMap.set(s^i,r)}}}}getDefaultPoseTexture(t,e,i){const s=0^t.hash;let r=this._textureBuffers.get(s)||null;if(r&&r.bounds.has(e.hash))return r.refCount++,r;const{joints:n,bindposes:o}=t;let a=null,h=!1;const l=n.length;if(r)r.refCount++;else{const e=12*l,i=this._chunkIdxMap.get(s),n=void 0!==i?this._customPool.alloc(4*e,i):this._pool.alloc(4*e);if(!n)return r;r={pixelOffset:n.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:n},a=new Float32Array(e),h=!0}Ki.set(R$,k$,k$,k$),Ki.set(O$,-k$,-k$,-k$);const c=e.getBoneSpaceBounds(t);for(let e=0,s=0;e<l;e++,s+=12){const r=i.getChildByPath(n[e]),l=r?I$(r,i,L$):t.inverseBindposes[e],u=c[e];u&&(Qn.transform(z$,u,l),z$.getBoundary(P$,B$),Ki.min(R$,R$,P$),Ki.max(O$,O$,B$)),h&&(r&&Rs.multiply(l,l,o[e]),D$(a,s,r?l:Rs.IDENTITY))}const u=[new Qn];return r.bounds.set(e.hash,u),Qn.fromPoints(u[0],R$,O$),h&&(this._pool.update(r.handle,a.buffer),this._textureBuffers.set(s,r)),r}getSequencePoseTexture(t,e,i,s){const r=t.hash^e.hash;let n=this._textureBuffers.get(r)||null;if(n&&n.bounds.has(i.hash))return n.refCount++,n;const{joints:o,bindposes:a}=t,h=T$.getOrExtract(e),{frames:l}=h;let c=null,u=!1;const d=o.length;if(n)n.refCount++;else{const i=12*d*l,o=this._chunkIdxMap.get(r),a=void 0!==o?this._customPool.alloc(4*i,o):this._pool.alloc(4*i);if(!a)return null;const h=this._createAnimInfos(t,e,s);n={pixelOffset:a.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:a,animInfos:h},c=new Float32Array(i),u=!0}const p=i.getBoneSpaceBounds(t),_=[];n.bounds.set(i.hash,_);for(let t=0;t<l;t++)_.push(new Qn(k$,k$,k$,-k$,-k$,-k$));for(let e=0,i=0;e<l;e++){const s=_[e];for(let r=0;r<d;r++,i+=12){const{curveData:o,downstream:h,bindposeIdx:l,bindposeCorrection:d}=n.animInfos[r];let _,g=!0;o&&h?_=Rs.multiply(L$,o[e],h):o?_=o[e]:h?_=h:(_=t.inverseBindposes[l],g=!1);const f=p[r];if(f){const t=d?Rs.multiply(F$,_,d):_;Qn.transform(z$,f,t),z$.getBoundary(P$,B$),Ki.min(s.center,s.center,P$),Ki.max(s.halfExtents,s.halfExtents,B$)}u&&(g&&Rs.multiply(L$,_,a[l]),D$(c,i,g?L$:Rs.IDENTITY))}Qn.fromPoints(s,s.center,s.halfExtents)}return u&&(this._pool.update(n.handle,c.buffer),this._textureBuffers.set(r,n)),n}releaseHandle(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){const e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}}releaseSkeleton(t){const e=this._textureBuffers.values();let i=e.next();for(;!i.done;){const s=i.value;s.skeletonHash===t.hash&&(s.readyToBeDeleted=!0,s.refCount?this._textureBuffers.delete(s.skeletonHash^s.clipHash):this.releaseHandle(s)),i=e.next()}}releaseAnimationClip(t){const e=this._textureBuffers.values();let i=e.next();for(;!i.done;){const s=i.value;s.clipHash===t.hash&&(s.readyToBeDeleted=!0,s.refCount?this._textureBuffers.delete(s.skeletonHash^s.clipHash):this.releaseHandle(s)),i=e.next()}}_createAnimInfos(t,e,i){const s=[],{joints:r,bindposes:n}=t,o=r.length,a=T$.getOrExtract(e);for(let e=0;e<o;e++){let h,l,c=r[e],u=a.joints[c],d=i.getChildByPath(c);for(;!u;){const t=c.lastIndexOf("/");if(c=c.substring(0,t),u=a.joints[c],d?(h||(h=new Rs),Rs.fromRTS(L$,d.rotation,d.position,d.scale),Rs.multiply(h,L$,h),d=d.parent):l=c,t<0)break}let p,_=e;if(void 0!==l&&u){_=e-1;for(let i=0;i<o;i++)if(r[i]===l){_=i,p=new Rs,Rs.multiply(p,n[i],t.inverseBindposes[e]);break}}s.push({curveData:u&&u.transforms,downstream:h,bindposeIdx:_,bindposeCorrection:p})}return s}}class U${constructor(t){this._pool=new Map,this._device=void 0,this._device=t}getData(t){void 0===t&&(t="-1");const e=this._pool.get(t);if(e)return e;const i=this._device.createBuffer(new Ed(18,3,Um.SIZE,Um.SIZE)),s=new Float32Array([0,0,0,0]);i.update(s);const r={buffer:i,data:s,dirty:!1,dirtyForJSB:new Uint8Array([0]),currentClip:null};return this._pool.set(t,r),r}destroy(t){const e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))}switchClip(t,e){return t.currentClip=e,t.data[0]=0,t.buffer.update(t.data),t.dirty=!1,t}clear(){for(const t of this._pool.values())t.buffer.destroy();this._pool.clear()}}const V$=[],H$=new Map;function G$(t,e){let i=0,s=Rs.IDENTITY;for(;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){s=t.world,t.stamp=e;break}t.stamp=e,V$[i++]=t,t=t.parent}for(;i>0;){t=V$[--i],V$[i]=null;const e=t.node;Rs.fromRTS(t.local,e.rotation,e.position,e.scale),s=Rs.multiply(t.world,s,t.local)}return s}function W$(t,e){let i,s=null,r=0;for(;t!==e;){const e=t.uuid;if(H$.has(e)){s=H$.get(e);break}s={node:t,local:new Rs,world:new Rs,stamp:-1,parent:null},H$.set(e,s),V$[r++]=s,t=t.parent,s=null}for(;r>0;)i=V$[--r],V$[r]=null,i.parent=s,s=i;return s}function j$(t){let e=H$.get(t.uuid)||null;for(;e;)H$.delete(e.node.uuid),e=e.parent}const $$=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_REAL_TIME_JOINT_TEXTURE",value:!1}],q$=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_REAL_TIME_JOINT_TEXTURE",value:!0}];function X$(t,e,i,s){for(let r=0;r<i.length;r++){const n=i[r];let o=-1;for(let t=0;t<n.length;t++)if(n[t]===s){o=t;break}o>=0&&(e.push(r),t.push(o))}}const Y$=new Ki,Q$=new Ki,K$=new Ki,Z$=new Ki,J$=new Rs,tq=new Qn;class eq{constructor(){this._format=44,this._textures=[],this._buffers=[]}}eq.WIDTH=256,eq.HEIGHT=3;class iq extends sH{constructor(){super(),this._buffers=[],this._dataArray=[],this._joints=[],this._bufferIndices=null,this._realTimeJointTexture=new eq,this._realTimeTextureMode=!1,this.type=1}destroy(){if(this.bindSkeleton(),this._buffers.length){for(let t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}this._dataArray.length=0,this._realTimeJointTexture._textures.forEach((t=>{t.destroy()})),this._realTimeJointTexture._textures.length=0,this._realTimeJointTexture._buffers.length=0,super.destroy()}uploadAnimation(){}bindSkeleton(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null);for(let t=0;t<this._joints.length;t++)j$(this._joints[t].target);if(this._bufferIndices=null,this._joints.length=0,!t||!e||!i)return;this._realTimeTextureMode=!1,Hm.JOINT_UNIFORM_CAPACITY<t.joints.length&&(this._realTimeTextureMode=!0),this.transform=e;const s=i.getBoneSpaceBounds(t),r=i.struct.jointMaps;this._ensureEnoughBuffers(r&&r.length||1),this._bufferIndices=i.jointBufferIndices,this._initRealTimeJointTexture();for(let i=0;i<t.joints.length;i++){const n=s[i],o=e.getChildByPath(t.joints[i]);if(!n||!o)continue;const a=W$(o,e),h=t.bindposes[i],l=[],c=[];r?X$(l,c,r,i):(l.push(i),c.push(0)),this._joints.push({indices:l,buffers:c,bound:n,target:o,bindpose:h,transform:a})}}updateTransform(t){const e=this.transform;(e.hasChangedFlags||e.isTransformDirty())&&(e.updateWorldTransform(),this._localDataUpdated=!0),Ki.set(Y$,1/0,1/0,1/0),Ki.set(Q$,-1/0,-1/0,-1/0);for(let e=0;e<this._joints.length;e++){const{bound:i,transform:s}=this._joints[e],r=G$(s,t);Qn.transform(tq,i,r),tq.getBoundary(K$,Z$),Ki.min(Y$,Y$,K$),Ki.max(Q$,Q$,Z$)}const i=this._worldBounds;this._modelBounds&&i&&(Qn.fromPoints(this._modelBounds,Y$,Q$),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))}updateUBOs(t){super.updateUBOs(t);for(let t=0;t<this._joints.length;t++){const{indices:e,buffers:i,transform:s,bindpose:r}=this._joints[t];Rs.multiply(J$,s.world,r);for(let t=0;t<i.length;t++)D$(this._dataArray[i[t]],12*e[t],J$)}if(this._realTimeTextureMode)this._updateRealTimeJointTextureBuffer();else for(let t=0;t<this._buffers.length;t++)this._buffers[t].update(this._dataArray[t]);return!0}initSubModel(t,e,i){const s=e.vertexBuffers,r=e.iaInfo;r.vertexBuffers=e.jointMappedBuffers,super.initSubModel(t,e,i),r.vertexBuffers=s}getMacroPatches(t){const e=super.getMacroPatches(t);let i=$$;return this._realTimeTextureMode&&(i=q$),e?i.concat(e):i}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e);const i=this._bufferIndices[t];if(this._realTimeTextureMode)this._bindRealTimeJointTexture(i,e);else{const t=this._buffers[i];t&&e.bindBuffer(Hm.BINDING,t)}}_updateInstancedAttributes(t,e){0!==e.passes[0].batchingScheme&&G(3936,this.node.getPathInHierarchy()),super._updateInstancedAttributes(t,e)}_ensureEnoughBuffers(t){if(this._buffers.length){for(let t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}if(this._dataArray.length&&(this._dataArray.length=0),this._realTimeTextureMode)for(let e=0;e<t;e++){const t=eq.WIDTH;this._dataArray[e]=new Float32Array(12*t)}else for(let e=0;e<t;e++){this._buffers[e]=this._device.createBuffer(new Ed(18,3,Hm.SIZE,Hm.SIZE));const t=Hm.JOINT_UNIFORM_CAPACITY;this._dataArray[e]=new Float32Array(12*t)}}_initRealTimeJointTexture(){if(this._realTimeJointTexture._textures.length&&(this._realTimeJointTexture._textures.forEach((t=>{t.destroy()})),this._realTimeJointTexture._textures.length=0),this._realTimeJointTexture._buffers.length=0,!this._realTimeTextureMode)return;const t=uP.root.device;let e=eq.WIDTH;const i=eq.HEIGHT;!(2&t.getFormatFeatures(44))&&(this._realTimeJointTexture._format=35,e=4*eq.WIDTH);const s=this._realTimeJointTexture._textures,r=this._realTimeJointTexture._buffers,n=this._realTimeJointTexture._format;for(let t=0;t<this._dataArray.length;t++){r[t]=new Float32Array(4*eq.HEIGHT*eq.WIDTH);const o=r[t],a=44===n?o:new Uint8Array(o.buffer),h=new j_({width:e,height:i,_data:a,_compressed:!1,format:n}),l=new qf;l.setFilters(1,1),l.setMipFilter(0),l.setWrapMode(2,2,2),l.image=h,s[t]=l}}_bindRealTimeJointTexture(t,e){if(!this._realTimeTextureMode)return;const i=this._realTimeJointTexture._textures[t];if(i){const t=i.getGFXTexture(),s=i.getGFXSampler();e.bindTexture(7,t),e.bindSampler(7,s)}}_updateRealTimeJointTextureBuffer(){if(!this._realTimeTextureMode)return;const t=this._realTimeJointTexture._textures,e=this._realTimeJointTexture._buffers;for(let i=0;i<t.length;i++){const s=e[i],r=this._dataArray[i],n=r.length/12;let o=0,a=0;for(let t=0;t<n;t++)a=4*t,s[a++]=r[o++],s[a++]=r[o++],s[a++]=r[o++],s[a++]=r[o++],a=4*(t+eq.WIDTH),s[a++]=r[o++],s[a++]=r[o++],s[a++]=r[o++],s[a++]=r[o++],a=4*(t+2*eq.WIDTH),s[a++]=r[o++],s[a++]=r[o++],s[a++]=r[o++],s[a++]=r[o++];const h=44===this._realTimeJointTexture._format?s:new Uint8Array(s.buffer);t[i].uploadData(h)}}}const sq=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}];class rq extends sH{constructor(){super(),this.uploadedAnim=void 0,this._jointsMedium=void 0,this._skeleton=null,this._mesh=null,this._dataPoolManager=void 0,this._instAnimInfoIdx=-1,this.type=2,this._dataPoolManager=h.director.root.dataPoolManager;const t=new Float32Array(4),e=this._dataPoolManager.jointAnimationInfo.getData();this._jointsMedium={buffer:null,jointTextureInfo:t,animInfo:e,texture:null,boundsInfo:null}}destroy(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),super.destroy()}bindSkeleton(t,e,i){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),this._skeleton=t,this._mesh=i,!t||!e||!i)return;this.transform=e;const s=this._dataPoolManager;this._jointsMedium.animInfo=s.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new Ed(18,1,Nm.SIZE,Nm.SIZE)))}updateTransform(t){if(super.updateTransform(t),!this.uploadedAnim)return;const{animInfo:e,boundsInfo:i}=this._jointsMedium,s=i[e.data[0]],r=this._worldBounds;if(r&&s){const t=this.transform;s.transform(t._mat,t._pos,t._rot,t._scale,r)}}updateUBOs(t){super.updateUBOs(t);const e=this._jointsMedium.animInfo;let i=!1;const s=this._instAnimInfoIdx;for(let t=0;t<this._subModels.length;t++){const r=this._subModels[t];s>=0?r.instancedAttributeBlock.views[s][0]=e.data[0]:i=!0}return i&&e.dirty&&(e.buffer.update(e.data),e.dirty=!1),!0}getMacroPatches(t){const e=super.getMacroPatches(t);return e?e.concat(sq):sq}uploadAnimation(t){if(!this._skeleton||!this._mesh||this.uploadedAnim===t)return;this.uploadedAnim=t;const e=this._dataPoolManager;let i=null;t?(i=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._modelBounds=null):(i=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._modelBounds=i&&i.bounds.get(this._mesh.hash)[0]),this._applyJointTexture(i)}_applyJointTexture(t){void 0===t&&(t=null);const e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,!t)return;const{buffer:i,jointTextureInfo:s}=this._jointsMedium;s[0]=t.handle.texture.width,s[1]=this._skeleton.joints.length,s[2]=t.pixelOffset+.1,s[3]=1/s[0],this.updateInstancedJointTextureInfo(),i&&i.update(s);const r=t.handle.texture;for(let t=0;t<this._subModels.length;++t)this._subModels[t].descriptorSet.bindTexture(7,r)}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e);const{buffer:i,texture:s,animInfo:r}=this._jointsMedium;if(e.bindBuffer(Nm.BINDING,i),e.bindBuffer(Um.BINDING,r.buffer),s){const t=this._device.getSampler(E$);e.bindTexture(7,s.handle.texture),e.bindSampler(7,t)}}_updateInstancedAttributes(t,e){super._updateInstancedAttributes(t,e),this._instAnimInfoIdx=e.getInstancedAttributeIndex(Vm),this.updateInstancedJointTextureInfo()}updateInstancedJointTextureInfo(){const{jointTextureInfo:t,animInfo:e}=this._jointsMedium,i=this._instAnimInfoIdx;for(let s=0;s<this._subModels.length;s++){const r=this._subModels[s].instancedAttributeBlock.views;if(i>=0&&r.length>0){const s=r[i];s[0]=e.data[0],s[1]=t[1],s[2]=t[2]}}}}var nq,oq,aq,hq,lq,cq,uq,dq,pq,_q;let gq=t("SkinnedMeshRenderer",(nq=oa("cc.SkinnedMeshRenderer"),oq=ha(100),aq=Ga(vG),hq=Ga(JS),lq=Ga(vG),cq=Ga(JS),nq(uq=oq((dq=class extends lG{get skeleton(){return this._skeleton}set skeleton(t){t!==this._skeleton&&(this._skeleton=t,this._update())}get skinningRoot(){return this._skinningRoot}set skinningRoot(t){t!==this._skinningRoot&&(this._skinningRoot=t,this._tryBindAnimation(),this._update())}get model(){return this._model}constructor(){super(),this._skeleton=pq&&pq(),this._skinningRoot=_q&&_q(),this._clip=null,this.associatedAnimation=null,this._modelType=rq}onLoad(){super.onLoad(),this._tryBindAnimation()}onDestroy(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),super.onDestroy()}uploadAnimation(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)}setUseBakedAnimation(t,e){void 0===t&&(t=!0),void 0===e&&(e=!1);const i=t?rq:iq;(e||this._modelType!==i)&&(this._modelType=i,this._model&&(h.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateUseLightProbe(),this.enabledInHierarchy&&this._attachToScene()))}setSharedMaterial(t,e){super.setSharedMaterial(t,e),this._modelType===iq&&this.getMaterialInstance(e)}_updateModelParams(){this._update(),super._updateModelParams()}_tryBindAnimation(){const{_skinningRoot:t}=this;if(!t)return;let e=!1;for(let i=this.node;i;i=i.parent)if(i===t){e=!0;break}if(!e)return;const i=t.getComponent("cc.SkeletalAnimation");i&&i.enabledInHierarchy?i.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}_update(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))}},pq=Qo(dq.prototype,"_skeleton",[aq],(function(){return null})),_q=Qo(dq.prototype,"_skinningRoot",[hq],(function(){return null})),s(dq.prototype,"skeleton",[lq],Object.getOwnPropertyDescriptor(dq.prototype,"skeleton"),dq.prototype),s(dq.prototype,"skinningRoot",[cq],Object.getOwnPropertyDescriptor(dq.prototype,"skinningRoot"),dq.prototype),uq=dq))||uq)||uq));var fq,mq,yq,vq,bq,wq,Sq,xq,Tq,Cq,Iq,Eq,Dq,Aq,Mq,Pq,Bq,Rq,Oq,Lq,Fq,zq;const kq=new Wd("a_batch_id",11),Nq=new Wd("a_batch_uv",21),Uq=mp[kq.format].size+mp[Nq.format].size;let Vq=t("SkinnedMeshUnit",(fq=oa("cc.SkinnedMeshUnit"),mq=Ga(ZP),yq=Ga(vG),vq=Ga(Lw),bq=Ga(gq),fq((Sq=class{constructor(){this.mesh=xq&&xq(),this.skeleton=Tq&&Tq(),this.material=Cq&&Cq(),this._localTransform=Iq&&Iq(),this._offset=Eq&&Eq(),this._size=Dq&&Dq()}set offset(t){Qs.copy(this._offset,t)}get offset(){return this._offset}set size(t){Qs.copy(this._size,t)}get size(){return this._size}set copyFrom(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getSharedMaterial(0),t.skinningRoot&&I$(t.node,t.skinningRoot,this._localTransform))}get copyFrom(){return null}},xq=Qo(Sq.prototype,"mesh",[mq],(function(){return null})),Tq=Qo(Sq.prototype,"skeleton",[yq],(function(){return null})),Cq=Qo(Sq.prototype,"material",[vq],(function(){return null})),Iq=Qo(Sq.prototype,"_localTransform",[va],(function(){return new Rs})),Eq=Qo(Sq.prototype,"_offset",[va],(function(){return new Qs(0,0)})),Dq=Qo(Sq.prototype,"_size",[va],(function(){return new Qs(1,1)})),s(Sq.prototype,"copyFrom",[bq],Object.getOwnPropertyDescriptor(Sq.prototype,"copyFrom"),Sq.prototype),wq=Sq))||wq));const Hq=new Rs;new Rs;const Gq=new Ki;var Wq,jq,$q,qq,Xq,Yq,Qq,Kq,Zq,Jq,tX,eX,iX,sX,rX,nX,oX;t("SkinnedMeshBatchRenderer",(Aq=oa("cc.SkinnedMeshBatchRenderer"),Mq=ha(100),Pq=Ga([Re]),Bq=Ga([Vq]),Aq(Rq=Mq((Oq=class extends gq{constructor(){super(),this.atlasSize=Lq&&Lq(),this.batchableTextureNames=Fq&&Fq(),this.units=zq&&zq(),this._textures={},this._batchMaterial=null}get mesh(){return super.mesh}set mesh(t){super.mesh=t}get skeleton(){return super.skeleton}set skeleton(t){super.skeleton=t}onLoad(){super.onLoad(),this.cook()}onDestroy(){for(const t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),super.onDestroy()}_onMaterialModified(t,e){this.cookMaterials(),super._onMaterialModified(t,this.getMaterialInstance(t))}cook(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}cookMaterials(){this._batchMaterial||(this._batchMaterial=this.getSharedMaterial(0));const t=this.getMaterialInstance(0);if(!t||!this._batchMaterial||!this._batchMaterial.effectAsset)return void P("incomplete batch material!");t.copy(this._batchMaterial),this.resizeAtlases();const e=t.effectAsset.techniques[t.technique];for(let i=0;i<e.passes.length;i++){const s=e.passes[i];if(s.properties)for(const e in s.properties)if(s.properties[e].type>=26){let s=null;this.batchableTextureNames.find((t=>t===e))?(s=this._textures[e],s||(s=this.createTexture(e)),this.cookTextures(s,e,i)):this.units.some((t=>s=t.material&&t.material.getProperty(e,i))),s&&t.setProperty(e,s,i)}else{const s=[];for(let t=0;t<this.units.length;t++){const r=this.units[t];r.material&&s.push(r.material.getProperty(e.slice(0,-3),i))}t.setProperty(e,s,i)}}}cookSkeletons(){if(!this._skinningRoot)return void P("no skinning root specified!");const t=[],e=[];for(let i=0;i<this.units.length;i++){const s=this.units[i];if(!s||!s.skeleton)continue;const r=s.skeleton;Rs.invert(Hq,s._localTransform);for(let i=0;i<r.joints.length;i++){const s=r.joints[i];t.findIndex((t=>t===s))>=0||(t.push(s),e.push(Rs.multiply(new Rs,r.bindposes[i]||Rs.IDENTITY,Hq)))}}const i=Array.from(Array(t.length).keys()).sort(((e,i)=>t[e]>t[i]?1:t[e]<t[i]?-1:0)),s=new vG;s.joints=t.map(((t,e,s)=>s[i[e]])),s.bindposes=e.map(((t,e,s)=>s[i[e]])),this._skeleton&&this._skeleton.destroy(),this.skeleton=s}cookMeshes(){let t=!1;for(let e=0;e<this.units.length;e++)if(this.units[e].mesh){t=!0;break}if(!t||!this._skinningRoot)return;this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new ZP;let e=0,i=0,s=0,r=0,n=0,o=0,a=0,h=0,l=0,c=0;const u=new Array(this.units.length),d=this.units.length;for(let t=0;t<d;t++){const e=this.units[t];e&&e.skeleton&&(u[t]=e.skeleton.joints.map((t=>this._skeleton.joints.findIndex((e=>t===e)))))}for(let t=0;t<d;t++){const d=this.units[t];if(!d||!d.mesh||!d.mesh.data)continue;const p=this._createUnitMesh(t,d.mesh),_=new DataView(p.data.buffer);Rs.invert(Hq,d._localTransform),Rs.transpose(Hq,Hq);const{offset:g}=d,{size:f}=d;for(let m=0;m<p.struct.vertexBundles.length;m++){const y=p.struct.vertexBundles[m];e=y.view.offset,i=0;for(let t=0;t<y.attributes.length;t++){const s=y.attributes[t];if("a_position"===s.name){i=s.format;break}e+=mp[s.format].size}if(i){const t=uS(_,i,e,y.view.length,y.view.stride);for(let e=0;e<t.length;e+=3)Ki.fromArray(Gq,t,e),Ki.transformMat4(Gq,Gq,d._localTransform),Ki.toArray(t,Gq,e);cS(_,t,i,e,y.view.stride)}s=y.view.offset,r=0;for(let t=0;t<y.attributes.length;t++){const e=y.attributes[t];if("a_normal"===e.name){r=e.format;break}s+=mp[e.format].size}if(r){const t=uS(_,r,s,y.view.length,y.view.stride);for(let e=0;e<t.length;e+=3)Ki.fromArray(Gq,t,e),Ki.transformMat4Normal(Gq,Gq,Hq),Ki.toArray(t,Gq,e);cS(_,t,r,s,y.view.stride)}n=y.view.offset,o=0;for(let t=0;t<y.attributes.length;t++){const e=y.attributes[t];if("a_tangent"===e.name){o=e.format;break}n+=mp[e.format].size}if(o){const t=uS(_,o,n,y.view.length,y.view.stride);for(let e=0;e<t.length;e+=3)Ki.fromArray(Gq,t,e),Ki.transformMat4Normal(Gq,Gq,Hq),Ki.toArray(t,Gq,e);cS(_,t,o,n,y.view.stride)}a=y.view.offset,h=0;for(let t=0;t<y.attributes.length;t++){const e=y.attributes[t];if("a_batch_uv"===e.name){h=e.format;break}a+=mp[e.format].size}h&&dS(_,((t,e)=>{var i;const s=0===e?"x":"y";return(t=(i=t)-Math.floor(i))*f[s]+g[s]}),h,a,y.view.length,y.view.stride,_);const v=u[t];if(v){l=y.view.offset,c=0;for(let t=0;t<y.attributes.length;t++){const e=y.attributes[t];if("a_joints"===e.name){c=e.format;break}l+=mp[e.format].size}c&&dS(_,(t=>v[t]),c,l,y.view.length,y.view.stride,_)}}this._mesh.merge(p)}this._onMeshChanged(this._mesh),this._updateModels()}cookTextures(t,e,i){const s=[],r=[],n=[],o=[];for(let t=0;t<this.units.length;t++){const a=this.units[t];if(!a.material)continue;const h=a.material.getProperty(e,i);if(h&&h.image&&h.image.data){const t=new bd;t.texOffset.x=a.offset.x*this.atlasSize,t.texOffset.y=a.offset.y*this.atlasSize,t.texExtent.width=a.size.x*this.atlasSize,t.texExtent.height=a.size.y*this.atlasSize;const{data:e}=h.image;ArrayBuffer.isView(e)?(n.push(e),o.push(t)):(s.push(e),r.push(t))}}const a=t.getGFXTexture(),{device:l}=h.director.root;n.length>0&&l.copyBuffersToTexture(n,a,o),s.length>0&&l.copyTexImagesToTexture(s,a,r)}createTexture(t){const e=new qf;return e.setFilters(2,2),e.setMipFilter(1),e.reset({width:this.atlasSize,height:this.atlasSize,format:35}),this._textures[t]=e,e}resizeAtlases(){for(const t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:35})}_createUnitMesh(t,e){const i=JSON.parse(JSON.stringify(e.struct)),s={};for(let t=0;t<e.struct.primitives.length;t++){const r=e.struct.primitives[t];let n=0,o=0,a=0;for(;a<r.vertexBundelIndices.length;a++){const t=e.struct.vertexBundles[r.vertexBundelIndices[a]];n=t.view.offset,o=0;for(let e=0;e<t.attributes.length;e++){const i=t.attributes[e];if("a_texCoord"===i.name){o=i.format;break}n+=mp[i.format].size}if(o)break}if(void 0!==s[a])continue;s[a]=[o,n];const h=i.vertexBundles[a];h.attributes.push(kq),h.attributes.push(Nq),h.view.offset=0,h.view.length+=h.view.count*Uq,h.view.stride+=Uq}let r=0;for(let t=0;t<i.vertexBundles.length;t++)r+=i.vertexBundles[t].view.length;for(let t=0;t<i.primitives.length;t++){const e=i.primitives[t];e.indexView&&(e.indexView.offset=r,r+=e.indexView.length)}const n=new Uint8Array(r),o=e.data,a=new DataView(n.buffer),l=new DataView(o.buffer),{isLittleEndian:c}=h.sys;for(const r in s){const h=i.vertexBundles[r],u=e.struct.vertexBundles[r],[d,p]=s[r],_=uS(l,d,p,u.view.length,u.view.stride),g=u.view,f=h.view,m=g.stride,y=f.stride;let v=g.offset,b=f.offset;for(let e=0;e<f.count;e++){const i=o.subarray(v,v+m);n.set(i,b),a.setFloat32(b+m,t),a.setFloat32(b+m+4,_[2*e],c),a.setFloat32(b+m+8,_[2*e+1],c),b+=y,v+=m}}for(let t=0;t<i.primitives.length;t++){const s=e.struct.primitives[t],r=i.primitives[t];if(s.indexView&&r.indexView){const t=s.indexView.stride,e=r.indexView.stride;let i=s.indexView.offset,a=r.indexView.offset;for(let s=0;s<r.indexView.count;s++){const s=o.subarray(i,i+t);n.set(s,a),a+=e,i+=t}}}const u=new ZP;return u.reset({struct:i,data:n}),u}},Lq=Qo(Oq.prototype,"atlasSize",[va],(function(){return 1024})),Fq=Qo(Oq.prototype,"batchableTextureNames",[Pq,va],(function(){return[]})),zq=Qo(Oq.prototype,"units",[Bq,va],(function(){return[]})),s(Oq.prototype,"mesh",[Wa],Object.getOwnPropertyDescriptor(Oq.prototype,"mesh"),Oq.prototype),s(Oq.prototype,"skeleton",[Wa],Object.getOwnPropertyDescriptor(Oq.prototype,"skeleton"),Oq.prototype),Rq=Oq))||Rq)||Rq));const aX=[.25,.125,.01];let hX=t("LOD",(Wq=oa("cc.LOD"),jq=Ga([lG]),$q=Ga(Pe),qq=Ga([lG]),Xq=Ga([Me]),Wq((Qq=class{constructor(){this._screenUsagePercentage=Kq&&Kq(),this._renderers=Zq&&Zq(),this._LODData=new XA,this._modelAddedCallback=void 0,this._LODData.screenUsagePercentage=this._screenUsagePercentage,this._modelAddedCallback=null}get screenUsagePercentage(){return this._screenUsagePercentage}set screenUsagePercentage(t){this._screenUsagePercentage=t,this._LODData.screenUsagePercentage=t}get renderers(){return this._renderers}set renderers(t){if(t===this._renderers)return;let e=!1;this._renderers.length=0,this._LODData.clearModels();for(let s=0;s<t.length;s++){var i;this._renderers[s]=t[s];const r=null===(i=t[s])||void 0===i?void 0:i.model;r&&(e=!0,this._LODData.addModel(r))}this._modelAddedCallback&&e&&this._modelAddedCallback()}get triangleCount(){const t=[];return this._renderers.forEach((e=>{let i=0;if(e&&e.mesh){const t=e.mesh.struct.primitives;null==t||t.forEach((t=>{t&&t.indexView&&(i+=t.indexView.count)}))}t.push(i/3)})),t}get rendererCount(){return this._renderers.length}get lodData(){return this._LODData}set modelAddedCallback(t){this._modelAddedCallback=t}insertRenderer(t,e){(t<0||t>this._renderers.length)&&(t=this._renderers.length),this._renderers.splice(t,0,e);let i=!1;return e.model&&(i=!0,this._LODData.addModel(e.model)),this._modelAddedCallback&&i&&this._modelAddedCallback(),e}deleteRenderer(t){var e;const i=this._renderers.splice(t,1),s=i.length>0?null===(e=i[0])||void 0===e?void 0:e.model:null;return s&&this._LODData.eraseModel(s),i[0]}getRenderer(t){return this._renderers[t]||null}setRenderer(t,e){t<0||t>=this.rendererCount?B("setRenderer to LOD error, index out of range"):(this.deleteRenderer(t),this.insertRenderer(t,e))}},Kq=Qo(Qq.prototype,"_screenUsagePercentage",[va],(function(){return 1})),Zq=Qo(Qq.prototype,"_renderers",[jq,va],(function(){return[]})),s(Qq.prototype,"screenUsagePercentage",[$q],Object.getOwnPropertyDescriptor(Qq.prototype,"screenUsagePercentage"),Qq.prototype),s(Qq.prototype,"renderers",[qq],Object.getOwnPropertyDescriptor(Qq.prototype,"renderers"),Qq.prototype),s(Qq.prototype,"triangleCount",[Xq],Object.getOwnPropertyDescriptor(Qq.prototype,"triangleCount"),Qq.prototype),Yq=Qq))||Yq));t("LODGroup",(Jq=oa("cc.LODGroup"),tX=Ga(Pe),eX=Ga([hX]),Jq((sX=class extends Ag{constructor(){super(),this._localBoundaryCenter=rX&&rX(),this._objectSize=nX&&nX(),this._LODs=oX&&oX(),this._lodGroup=new YA,this._eventRegistered=!1,this._forceUsedLevels=[]}set localBoundaryCenter(t){this._localBoundaryCenter.set(t),this._lodGroup.localBoundaryCenter=t}get localBoundaryCenter(){return this._localBoundaryCenter.clone()}get lodCount(){return this._LODs.length}set objectSize(t){this._objectSize=t,this._lodGroup.objectSize=t}get objectSize(){return this._objectSize}get LODs(){return this._LODs}set LODs(t){t!==this._LODs?(this._LODs.length=0,this.lodGroup.clearLODs(),t.forEach(((t,e)=>{this.lodGroup.insertLOD(e,t.lodData),this._LODs[e]=t,t.modelAddedCallback=this.onLodModelAddedCallback.bind(this)})),this._updateDataToScene()):this._updateDataToScene()}get lodGroup(){return this._lodGroup}onLodModelAddedCallback(){0===this.objectSize&&this.recalculateBounds()}insertLOD(t,e,i){if((t<0||t>this.lodCount)&&(t=this.lodCount),i||(i=new hX),i.modelAddedCallback=this.onLodModelAddedCallback.bind(this),!e){const i=this.getLOD(t-1),s=this.getLOD(t);if(i&&s)e=(i.screenUsagePercentage+s.screenUsagePercentage)/2;else if(i&&!s)(e=i.screenUsagePercentage/2)>.01&&(e=.01);else if(s&&!i){e=s.screenUsagePercentage;const i=this.getLOD(t+1);s.screenUsagePercentage=(e+(i?i.screenUsagePercentage:0))/2}else e=aX[0]}return i.screenUsagePercentage=e,this._LODs.splice(t,0,i),this._lodGroup.insertLOD(t,i.lodData),this._updateDataToScene(),this.node&&this._emitChangeNode(this.node),i}eraseLOD(t){if(t<0||t>=this.lodCount)return P("eraseLOD error, index out of range"),null;const e=this._LODs[t];return e?(this._LODs.splice(t,1),this._lodGroup.eraseLOD(t),this._updateDataToScene(),this._emitChangeNode(this.node),e):(P("eraseLOD error, LOD not exist at specified index."),null)}getLOD(t){return t<0||t>=this.lodCount?(P("getLOD error, index out of range"),null):this._LODs[t]}setLOD(t,e){t<0||t>=this.lodCount?P("setLOD error, index out of range"):(this._LODs[t]=e,e.modelAddedCallback=this.onLodModelAddedCallback.bind(this),this.lodGroup.updateLOD(t,e.lodData),this._updateDataToScene())}recalculateBounds(){const t=new Ki,e=new Ki;let i=null,s=new Ki;for(let o=0;o<this.lodCount;++o){const a=this.getLOD(o);if(a)for(let o=0;o<a.rendererCount;++o){var r,n;const h=a.getRenderer(o);if(!h)continue;null===(r=h.model)||void 0===r||r.updateWorldBound();let l=null===(n=h.model)||void 0===n?void 0:n.worldBounds;l&&(l.getBoundary(t,e),i?(Ki.min(i,i,t),Ki.max(s,s,e)):(i=t.clone(),s=e.clone()))}}if(i){const t=i,e=new Ki(.5*(s.x+t.x),.5*(s.y+t.y),.5*(s.z+t.z)),r=new Ki(.5*(s.x-t.x),.5*(s.y-t.y),.5*(s.z-t.z)),[n,o]=function(t,e,i){let s,r;const n=new Array(new Ki(t.x-e.x,t.y-e.y,t.z-e.z),new Ki(t.x-e.x,t.y+e.y,t.z-e.z),new Ki(t.x+e.x,t.y+e.y,t.z-e.z),new Ki(t.x+e.x,t.y-e.y,t.z-e.z),new Ki(t.x-e.x,t.y-e.y,t.z+e.z),new Ki(t.x-e.x,t.y+e.y,t.z+e.z),new Ki(t.x+e.x,t.y+e.y,t.z+e.z),new Ki(t.x+e.x,t.y-e.y,t.z+e.z));s=n[0].transformMat4(i),r=s.clone();for(let t=1;t<8;++t){const e=n[t].transformMat4(i);s=Ki.min(s,s,e),r=Ki.max(r,r,e)}return[s,r]}(e,r,this.node.worldMatrix.clone().invert());e.set(.5*(o.x+n.x),.5*(o.y+n.y),.5*(o.z+n.z)),r.set(.5*(o.x-n.x),.5*(o.y-n.y),.5*(o.z-n.z)),this.localBoundaryCenter=e,this.objectSize=2*Math.max(r.x,r.y,r.z)}else this.localBoundaryCenter=new Ki(0,0,0),this.objectSize=0;this._emitChangeNode(this.node)}resetObjectSize(){if(1===this.objectSize)return;0===this.objectSize&&(this.objectSize=1);const t=1/this.objectSize;this.objectSize=1;for(let e=0;e<this.lodCount;++e){const i=this.getLOD(e);i&&(i.screenUsagePercentage*=t)}this._emitChangeNode(this.node)}forceLOD(t){this._forceUsedLevels=t<0?[]:[t],this.lodGroup.lockLODLevels(this._forceUsedLevels)}forceLODs(t){}onLoad(){this._lodGroup.node=this.node,this._lodGroup.objectSize=this._objectSize,this._lodGroup.localBoundaryCenter=this._localBoundaryCenter,this._eventRegistered||(this.node.on("component-removed",this._onRemove,this),this._eventRegistered=!0),this._constructLOD()}_onRemove(t){t===this&&this.onDisable()}_constructLOD(){if(this.lodCount<1){const t=aX.length;for(let e=0;e<t;e++)this.insertLOD(e,aX[e])}}onRestore(){this._constructLOD(),this.enabledInHierarchy&&this._attachToScene()}onEnable(){this._attachToScene(),0===this.objectSize&&this.recalculateBounds(),this.lodGroup.lockLODLevels(this._forceUsedLevels),this.lodCount>0&&this._lodGroup.lodCount<1&&this._LODs.forEach(((t,e)=>{t.lodData.screenUsagePercentage=t.screenUsagePercentage;const i=t.renderers;if(null!==i&&i.length>0)for(let e=0;e<i.length;e++){const s=t.lodData,r=i[e];s&&r&&r.model&&s.addModel(r.model)}this._lodGroup.insertLOD(e,t.lodData)}))}onDisable(){this._detachFromScene(),this.lodGroup.lockLODLevels([])}_attachToScene(){if(this.node&&this.node.scene){const t=this._getRenderScene();this._lodGroup.scene&&this._detachFromScene(),t.addLODGroup(this._lodGroup)}}_detachFromScene(){this._lodGroup.scene&&this._lodGroup.scene.removeLODGroup(this._lodGroup)}_emitChangeNode(t){}_updateDataToScene(){this._detachFromScene(),this._attachToScene()}},rX=Qo(sX.prototype,"_localBoundaryCenter",[va],(function(){return new Ki(0,0,0)})),nX=Qo(sX.prototype,"_objectSize",[va],(function(){return 0})),oX=Qo(sX.prototype,"_LODs",[va],(function(){return[]})),s(sX.prototype,"objectSize",[tX],Object.getOwnPropertyDescriptor(sX.prototype,"objectSize"),sX.prototype),s(sX.prototype,"LODs",[eX],Object.getOwnPropertyDescriptor(sX.prototype,"LODs"),sX.prototype),iX=sX))||iX));const lX=Kf.makeMaskExclude([Kf.BitMask.UI_2D,Kf.BitMask.UI_3D,Kf.BitMask.GIZMOS,Kf.BitMask.EDITOR,Kf.BitMask.SCENE_GIZMO,Kf.BitMask.PROFILER,Kf.Enum.IGNORE_RAYCAST]);class cX{constructor(){this._probes=[],this._useCubeModels=new Map,this._usePlanarModels=new Map,this._updateForRuntime=!0,this._dataTexture=null,this._registeredEvent=!1}set updateForRuntime(t){this._updateForRuntime=t}get updateForRuntime(){return this._updateForRuntime}registerEvent(){this._registeredEvent||(h.director.on(h.DirectorEvent.BEFORE_UPDATE,this.onUpdateProbes,this),this._registeredEvent=!0)}onUpdateProbes(){if(0===this._probes.length)return;const t=h.director.getScene();if(!t||!t.renderScene)return;const e=t.renderScene.models;for(let t=0;t<e.length;t++){const i=e[t];i.node&&i.node.layer&lX&&(1===i.reflectionProbeType||this._isUsedBlending(i)?this.selectReflectionProbe(i):2===i.reflectionProbeType&&this.selectPlanarReflectionProbe(i))}}filterModelsForPlanarReflection(){if(0===this._probes.length)return;const t=h.director.getScene();if(!t||!t.renderScene)return;const e=t.renderScene.models;for(let t=0;t<e.length;t++){const i=e[t];i.node&&i.node.layer&lX&&2===i.reflectionProbeType&&this.selectPlanarReflectionProbe(i)}}clearPlanarReflectionMap(t){for(const e of this._usePlanarModels.entries())e[1]===t&&this._updatePlanarMapOfModel(e[0],null,null)}register(t){-1===this._probes.indexOf(t)&&(this._probes.push(t),this.updateProbeData())}unregister(t){for(let e=0;e<this._probes.length;e++)if(this._probes[e]===t){const t=this._probes.splice(e,1);t[0]&&this._removeDependentModels(t[0]);break}this.updateProbeData()}exists(t){if(0===this._probes.length)return!1;for(let e=0;e<this._probes.length;e++)if(this._probes[e].getProbeId()===t)return!0;return!1}getNewReflectionProbeId(){let t=0;for(;;){if(!this.exists(t))return t;t++}}getProbes(){return this._probes}getProbeById(t){for(let e=0;e<this._probes.length;e++)if(this._probes[e].getProbeId()===t)return this._probes[e];return null}clearAll(){this._probes=[]}getProbeByCamera(t){for(let e=0;e<this._probes.length;e++)if(this._probes[e].camera===t)return this._probes[e];return null}updateBakedCubemap(t){const e=this._getModelsByProbe(t);if(t.cubemap){for(let i=0;i<e.length;i++){const s=e[i];this._updateCubemapOfModel(s,t)}if(t.needRefresh=!1,0===e.length)for(const e of this._useCubeModels.entries())e[0].reflectionProbeBlendId===t.getProbeId()&&this._updateBlendCubemap(e[0],t)}}updatePlanarMap(t,e){if(!t.node||!t.node.scene)return;const i=this._getModelsByProbe(t);for(let s=0;s<i.length;s++)this._updatePlanarMapOfModel(i[s],e,t);if(t.previewPlane){const i=t.previewPlane.getComponent(lG);i&&i.updateProbePlanarMap(e)}}selectPlanarReflectionProbe(t){if(t.node&&t.worldBounds&&2===t.reflectionProbeType){for(let e=0;e<this._probes.length;e++){const i=this._probes[e];1===i.probeType&&t.node.layer&lX&&(t.updateWorldBound(),ko.aabbWithAABB(t.worldBounds,i.boundingBox)?this._usePlanarModels.set(t,i):this._usePlanarModels.has(t)&&this._usePlanarModels.get(t)===i&&(this._usePlanarModels.delete(t),this._updatePlanarMapOfModel(t,null,null)))}for(let t=0;t<this._probes.length;t++)1===this._probes[t].probeType&&(this._probes[t].realtimePlanarTexture?this.updatePlanarMap(this._probes[t],this._probes[t].realtimePlanarTexture.getGFXTexture()):this.updatePlanarMap(this._probes[t],null))}}selectReflectionProbe(t){if(t.node&&t.worldBounds&&t.node.layer&lX){t.updateWorldBound();const e=this._getNearestProbe(t);e?this._useCubeModels.has(t)?(this._useCubeModels.get(t)!==e&&this._useCubeModels.set(t,e),e.needRefresh=!0):(this._useCubeModels.set(t,e),e.needRefresh=!0):(this._updateCubemapOfModel(t,null),this._useCubeModels.delete(t))}for(let e=0;e<this._probes.length;e++)(this._probes[e].needRefresh&&0===this._probes[e].probeType||this._isUsedBlending(t))&&this.updateBakedCubemap(this._probes[e])}updatePreviewSphere(t){if(!t||!t.previewSphere)return;const e=t.previewSphere.getComponent(lG);e&&(e.updateProbeCubemap(t.cubemap),e.updateReflectionProbeId(t.getProbeId()))}updatePreviewPlane(t){t&&t.previewPlane&&t.previewPlane.getComponent(lG)&&t.realtimePlanarTexture&&this.updatePlanarMap(t,t.realtimePlanarTexture.getGFXTexture())}updateProbeData(){if(0===this._probes.length)return;const t=this.getMaxProbeId(),e=t+1;this._dataTexture&&this._dataTexture.destroy();const i=new Float32Array(12*e);let s=0;for(let e=0;e<=t;e++){const t=this.getProbeById(e);if(t){if(0===t.probeType){i[s]=t.node.worldPosition.x,i[s+1]=t.node.worldPosition.y,i[s+2]=t.node.worldPosition.z,i[s+3]=0,i[s+4]=t.size.x,i[s+5]=t.size.y,i[s+6]=t.size.z,i[s+7]=0;const e=t.isRGBE()?1e3:0;i[s+8]=t.cubemap?t.cubemap.mipmapLevel+e:1+e}else i[s]=t.node.up.x,i[s+1]=t.node.up.y,i[s+2]=t.node.up.z,i[s+3]=1,i[s+4]=1,i[s+5]=1,i[s+6]=0,i[s+7]=0,i[s+8]=1;s+=12}else s+=12}const r=new Uint8Array(i.buffer),n=new j_({_data:r,_compressed:!1,width:12,height:e,format:35});this._dataTexture=new qf,this._dataTexture.setFilters(0,0),this._dataTexture.setMipFilter(0),this._dataTexture.setWrapMode(2,2,2),this._dataTexture.image=n,this._dataTexture.uploadData(r);for(let t=0;t<this._probes.length;t++){const e=this._probes[t],i=this._getModelsByProbe(e);for(let t=0;t<i.length;t++){const e=i[t].node.getComponent(lG);e&&e.updateReflectionProbeDataMap(this._dataTexture)}}}getMaxProbeId(){return 0===this._probes.length?-1:1===this._probes.length?this._probes[0].getProbeId():(this._probes.sort(((t,e)=>t.getProbeId()-e.getProbeId())),this._probes[this._probes.length-1].getProbeId())}getUsedReflectionProbe(t,e){if(e){if(this._usePlanarModels.has(t))return this._usePlanarModels.get(t)}else if(this._useCubeModels.has(t))return this._useCubeModels.get(t);return null}setReflectionProbe(t,e,i){void 0===i&&(i=null),e&&(this._useCubeModels.set(t,e),this._updateCubemapOfModel(t,e),i&&this._updateBlendProbeInfo(t,e,i))}updateProbeOfModels(){if(0===this._probes.length)return;const t=h.director.getScene();if(!t||!t.renderScene)return;const e=t.renderScene.models;for(let t=0;t<e.length;t++){const i=e[t];i.node&&i.node.layer&lX&&(1===i.reflectionProbeType||2===i.reflectionProbeType||this._isUsedBlending(i))&&i.updateReflectionProbeId()}}_getNearestProbe(t){if(!t.node||!t.worldBounds||0===this._probes.length)return null;let e=null,i=1/0;for(const s of this._probes){if(0!==s.probeType||!s.validate()||!ko.aabbWithAABB(t.worldBounds,s.boundingBox))continue;const r=Ki.distance(t.node.worldPosition,s.node.worldPosition);r<i&&(i=r,e=s)}return e}_getBlendProbe(t){if(!t||!t.node||!t.worldBounds||this._probes.length<2)return null;const e=[];for(let i=0;i<this._probes.length;i++)0===this._probes[i].probeType&&this._probes[i].validate()&&ko.aabbWithAABB(t.worldBounds,this._probes[i].boundingBox)&&e.push(this._probes[i]);return e.sort(((e,i)=>Ki.distance(t.node.worldPosition,e.node.worldPosition)-Ki.distance(t.node.worldPosition,i.node.worldPosition))),e.length>1?e[1]:null}_getModelsByProbe(t){const e=[];let i=this._useCubeModels;1===t.probeType&&(i=this._usePlanarModels);for(const s of i.entries())s[1]===t&&e.push(s[0]);return e}_removeDependentModels(t){for(const e of this._useCubeModels.keys()){const i=this._useCubeModels.get(e);void 0!==i&&i===t&&(this._useCubeModels.delete(e),this.selectReflectionProbe(e))}for(const e of this._usePlanarModels.keys()){const i=this._usePlanarModels.get(e);void 0!==i&&i===t&&(this._usePlanarModels.delete(e),this.selectPlanarReflectionProbe(e))}}_updateCubemapOfModel(t,e){const i=t.node;if(!i)return;const s=i.getComponent(lG);if(s&&(s.updateProbeCubemap(e?e.cubemap:null),s.updateReflectionProbeId(e&&e.cubemap?e.getProbeId():-1),e&&(s.updateReflectionProbeDataMap(this._dataTexture),this._isUsedBlending(t)))){const i=this._getBlendProbe(t);this._updateBlendProbeInfo(t,e,i)}}_updatePlanarMapOfModel(t,e,i){const s=t.node.getComponent(lG);s&&(s.updateProbePlanarMap(e),i?(s.updateReflectionProbeId(i.getProbeId()),s.updateReflectionProbeDataMap(this._dataTexture)):s.updateReflectionProbeId(-1))}_isUsedBlending(t){return 3===t.reflectionProbeType||4===t.reflectionProbeType}_updateBlendProbeInfo(t,e,i){const s=t.node;if(!s)return;const r=s.getComponent(lG);r&&(i?(r.updateReflectionProbeBlendId(i.getProbeId()),r.updateProbeBlendCubemap(i.cubemap),r.updateReflectionProbeBlendWeight(this._calculateBlendWeight(t,e,i))):(r.updateReflectionProbeBlendId(-1),4===t.reflectionProbeType&&r.updateReflectionProbeBlendWeight(this._calculateBlendWeight(t,e,i))))}_updateBlendCubemap(t,e){const i=t.node;if(!i)return;if(!this._isUsedBlending(t))return;const s=i.getComponent(lG);s&&s.updateProbeBlendCubemap(e.cubemap)}_calculateBlendWeight(t,e,i){if(i){const s=Ki.distance(t.node.worldPosition,e.node.worldPosition),r=Ki.distance(t.node.worldPosition,i.node.worldPosition);return 1-r/(s+r)}return 3===t.reflectionProbeType?0:4===t.reflectionProbeType?this._calculateBlendOfSkybox(t.worldBounds,e.boundingBox):0}_calculateBlendOfSkybox(t,e){if(!t)return 1;const i=new Ki,s=new Ki,r=new Ki,n=new Ki;if(Ki.subtract(i,t.center,t.halfExtents),Ki.add(s,t.center,t.halfExtents),Ki.subtract(r,e.center,e.halfExtents),Ki.add(n,e.center,e.halfExtents),i.x<=n.x&&s.x>=r.x&&i.y<=n.y&&s.y>=r.y&&i.z<=n.z&&s.z>=r.z){const e=new Ki;Ki.multiplyScalar(e,t.halfExtents,2);const o=i.x+e.x<=n.x&&s.x+e.x>=r.x,a=i.x-e.x<=n.x&&s.x-e.x>=r.x,h=i.y+e.y<=n.y&&s.y+e.y>=r.y,l=i.y-e.y<=n.y&&s.y-e.y>=r.y,c=i.z+e.z<=n.z&&s.z+e.z>=r.z,u=i.z-e.z<=n.z&&s.z-e.z>=r.z,d=[];if(!o){const t=s.x-n.x;d.push(t/e.x)}if(!a){const t=Math.abs(i.x-r.x);d.push(t/e.x)}if(!h){const t=s.y-n.y;d.push(t/e.y)}if(!l){const t=Math.abs(i.y-r.y);d.push(t/e.y)}if(!c){const t=s.z-n.z;d.push(t/e.z)}if(!u){const t=Math.abs(i.z-r.z);d.push(t/e.z)}return d.length>0?(d.sort(((t,e)=>e-t)),d[0]):0}return 1}}function uX(t){return void 0===(t=t||{}).includeNormal&&(t.includeNormal=!0),void 0===t.includeUV&&(t.includeUV=!0),t}t("ReflectionProbeManager",cX),cX.probeManager=void 0,cX.probeManager=new cX,h.internal.reflectionProbeManager=cX.probeManager;const dX=new Ki,pX=new Ki,_X=new Ki,gX=new Ki,fX=new Ki,mX=new Ki,yX=new Ki,vX=new Ki,bX=new Ki,wX=new Ki,SX=new Ki,xX=new Ki,TX=new Ki(0,0,0),CX=new Ki(0,0,0);function IX(t,e,i,s){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===i&&(i=2),void 0===s&&(s={});const r=.5*i,n=s.radialSegments||32,o=s.heightSegments||1,a=void 0===s.capped||s.capped,h=s.arc||2*Math.PI;let l=0;a&&(t>0&&l++,e>0&&l++);let c=(n+1)*(o+1);a&&(c+=(n+1)*l+n*l);let u=n*o*6;a&&(u+=n*l*3);const d=new Array(u),p=new Array(3*c),_=new Array(3*c),g=new Array(2*c),f=Math.max(t,e),m=new Ki(-f,-r,-f),y=new Ki(f,r,f),v=Math.sqrt(f*f+r*r);let b=0,w=0;return function(){const s=[],a=t-e,l=a*a/i*Math.sign(a);for(let t=0;t<=o;t++){const c=[],u=t/o,d=u*a+e;for(let t=0;t<=n;++t){const e=t/n,s=e*h,o=Math.sin(s),a=Math.cos(s);p[3*b]=d*o,p[3*b+1]=u*i-r,p[3*b+2]=d*a,Ki.normalize(TX,Ki.set(CX,o,-l,a)),_[3*b]=TX.x,_[3*b+1]=TX.y,_[3*b+2]=TX.z,g[2*b]=2*(1-e)%1,g[2*b+1]=u,c.push(b),++b}s.push(c)}for(let t=0;t<o;++t)for(let e=0;e<n;++e){const i=s[t][e],r=s[t+1][e],n=s[t+1][e+1],o=s[t][e+1];d[w]=i,++w,d[w]=o,++w,d[w]=r,++w,d[w]=o,++w,d[w]=n,++w,d[w]=r,++w}}(),a&&(e>0&&S(!1),t>0&&S(!0)),{positions:p,normals:_,uvs:g,indices:d,minPos:m,maxPos:y,boundingRadius:v};function S(i){const s=i?t:e,o=i?1:-1,a=b;for(let t=1;t<=n;++t)p[3*b]=0,p[3*b+1]=r*o,p[3*b+2]=0,_[3*b]=0,_[3*b+1]=o,_[3*b+2]=0,g[2*b]=.5,g[2*b+1]=.5,++b;const l=b;for(let t=0;t<=n;++t){const e=t/n*h,i=Math.cos(e),a=Math.sin(e);p[3*b]=s*a,p[3*b+1]=r*o,p[3*b+2]=s*i,_[3*b]=0,_[3*b+1]=o,_[3*b+2]=0,g[2*b]=.5-.5*a*o,g[2*b+1]=.5+.5*i,++b}for(let t=0;t<n;++t){const e=a+t,s=l+t;i?(d[w]=s+1,++w,d[w]=e,++w,d[w]=s,++w):(d[w]=e,++w,d[w]=s+1,++w,d[w]=s,++w)}}}function EX(t){return(t=uX(t)).width=t.width||10,t.length=t.length||10,t.widthSegments=t.widthSegments||10,t.lengthSegments=t.lengthSegments||10,t}const DX=new Ki(0,0,0),AX=new Ki(0,0,0),MX=new Ki(0,0,0),PX=new Ki(0,0,0),BX=new Ki(0,0,0),RX=new Ki(0,0,0),OX=new Ki(0,0,0),LX=new Ki(0,0,0),FX=new Ki(0,0,0);function zX(t){return(t=uX(t)).segments=64,t}var kX=Object.freeze({__proto__:null,applyDefaultGeometryOptions:uX,box:function(t){const e=(t=t||{}).widthSegments||1,i=t.heightSegments||1,s=t.lengthSegments||1,r=(t.width||1)/2,n=(t.height||1)/2,o=(t.length||1)/2,a=[Ki.set(fX,-r,-n,o),Ki.set(mX,r,-n,o),Ki.set(yX,r,n,o),Ki.set(vX,-r,n,o),Ki.set(bX,r,-n,-o),Ki.set(wX,-r,-n,-o),Ki.set(SX,-r,n,-o),Ki.set(xX,r,n,-o)],h=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],c=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],u=[],d=[],p=[],_=[],g=[],f=new Ki(-r,-n,-o),m=new Ki(r,n,o),y=Math.sqrt(r*r+n*n+o*o);function v(t,e,i){let s,r,n,o;const f=u.length/3,m=h[t],y=l[t],v=c[t];for(o=0;o<=i;o++)for(n=0;n<=e;n++)if(s=n/e,r=o/i,Ki.lerp(dX,a[m[0]],a[m[1]],s),Ki.lerp(pX,a[m[0]],a[m[2]],r),Ki.subtract(_X,pX,a[m[0]]),Ki.add(gX,dX,_X),u.push(gX.x,gX.y,gX.z),d.push(y[0],y[1],y[2]),p.push(s,r),_.push(v[0],v[1],v[2],v[3]),n<e&&o<i){const t=e+1,i=n+o*t,s=n+(o+1)*t,r=n+1+(o+1)*t,a=n+1+o*t;g.push(f+i,f+a,f+s),g.push(f+s,f+a,f+r)}}return v(0,e,i),v(4,s,i),v(1,e,i),v(5,s,i),v(3,e,s),v(2,e,s),{positions:u,normals:d,uvs:p,tangents:_,indices:g,minPos:f,maxPos:m,boundingRadius:y}},capsule:function(t,e,i,s){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===i&&(i=2),void 0===s&&(s={});const r=i-t-e,n=s.sides||32,o=s.heightSegments||32,a=e/i,h=r/i,l=t/i,c=Math.floor(o*a),u=Math.floor(o*l),d=Math.floor(o*h),p=r+e-i/2,_=e-i/2,g=e-i/2,f=s.arc||2*Math.PI,m=[],y=[],v=[],b=[],w=Math.max(t,e),S=new Ki(-w,-i/2,-w),x=new Ki(w,i/2,w),T=i/2;let C=0;const I=[];return function(){for(let t=0;t<=c;++t){const i=t*Math.PI/c/2,s=Math.sin(i),r=-Math.cos(i);for(let i=0;i<=n;++i){const a=2*i*Math.PI/n-Math.PI/2,h=Math.sin(a)*s,l=r,u=Math.cos(a)*s,d=i/n,p=t/o;if(m.push(h*e,l*e+g,u*e),y.push(h,l,u),v.push(d,p),t<c&&i<n){const e=n+1,s=e*t+i,r=e*(t+1)+i,o=e*(t+1)+i+1,a=e*t+i+1;b.push(s,a,r),b.push(a,o,r)}++C}}}(),function(){const i=(t-e)/r;for(let s=0;s<=d;s++){const o=[],l=s/d,c=l*(t-e)+e;for(let t=0;t<=n;++t){const e=t/n,s=l*h+a,u=e*f-f/4,d=Math.sin(u),p=Math.cos(u);m.push(c*d),m.push(l*r+_),m.push(c*p),Ki.normalize(LX,Ki.set(FX,d,-i,p)),y.push(LX.x),y.push(LX.y),y.push(LX.z),v.push(e,s),o.push(C),++C}I.push(o)}for(let t=0;t<d;++t)for(let e=0;e<n;++e){const i=I[t][e],s=I[t+1][e],r=I[t+1][e+1],n=I[t][e+1];b.push(i),b.push(n),b.push(s),b.push(n),b.push(r),b.push(s)}}(),function(){for(let e=0;e<=u;++e){const i=e*Math.PI/u/2+Math.PI/2,s=Math.sin(i),r=-Math.cos(i);for(let i=0;i<=n;++i){const a=2*i*Math.PI/n-Math.PI/2,h=Math.sin(a)*s,c=r,_=Math.cos(a)*s,g=i/n,f=e/o+(1-l);if(m.push(h*t,c*t+p,_*t),y.push(h,c,_),v.push(g,f),e<u&&i<n){const t=n+1,s=t*e+i+I[d][n]+1,r=t*(e+1)+i+I[d][n]+1,o=t*(e+1)+i+1+I[d][n]+1,a=t*e+i+1+I[d][n]+1;b.push(s,a,r),b.push(a,o,r)}}}}(),{positions:m,normals:y,uvs:v,indices:b,minPos:S,maxPos:x,boundingRadius:T}},circle:function(t){const e=zX(t).segments,i=new Array(3*(e+1));i[0]=0,i[1]=0,i[2]=0;const s=new Array(1+2*e);s[0]=0;const r=2*Math.PI/e;for(let t=0;t<e;++t){const e=r*t,n=Math.cos(e),o=Math.sin(e),a=3*(t+1);i[a+0]=n,i[a+1]=o,i[a+2]=0;const h=2*t;s[1+h]=t+1,s[1+(h+1)]=t+2}return e>0&&(s[s.length-1]=1),{positions:i,indices:s,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:9}},cone:function(t,e,i){return void 0===t&&(t=.5),void 0===e&&(e=1),void 0===i&&(i={}),IX(0,t,e,i)},cylinder:IX,invWinding:function(t){const e=[];for(let i=0;i<t.length;i+=3)e.push(t[i],t[i+2],t[i+1]);return e},normals:function(t,e,i){void 0===i&&(i=1);const s=new Array(2*t.length);for(let r=0;r<t.length/3;++r){const n=3*r,o=6*r;s[o+0]=t[n+0],s[o+1]=t[n+1],s[o+2]=t[n+2],s[o+3]=t[n+0]+e[n+0]*i,s[o+4]=t[n+1]+e[n+1]*i,s[o+5]=t[n+2]+e[n+2]*i}return s},plane:function(t){const e=EX(t),{width:i,length:s,widthSegments:r,lengthSegments:n}=e,o=.5*i,a=.5*s,h=[],l=[],c=[],u=new Ki(-o,0,-a),d=new Ki(o,0,a),p=Math.sqrt(i*i+s*s);Ki.set(BX,-o,0,a),Ki.set(RX,o,0,a),Ki.set(OX,-o,0,-a);for(let t=0;t<=n;t++)for(let i=0;i<=r;i++){const s=i/r,o=t/n;if(Ki.lerp(DX,BX,RX,s),Ki.lerp(AX,BX,OX,o),Ki.subtract(MX,AX,BX),Ki.add(PX,DX,MX),h.push(PX.x,PX.y,PX.z),e.includeUV&&l.push(s,o),i<r&&t<n){const e=r+1,s=i+t*e,n=i+(t+1)*e,o=i+1+(t+1)*e,a=i+1+t*e;c.push(s,a,n),c.push(a,o,n)}}const _={positions:h,indices:c,minPos:u,maxPos:d,boundingRadius:p};if(e.includeNormal){const t=(n+1)*(r+1),e=new Array(3*t);_.normals=e;for(let i=0;i<t;++i)e[3*i+0]=0,e[3*i+1]=1,e[3*i+2]=0}return e.includeUV&&(_.uvs=l),_},quad:function(t){const e=uX(t),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==e.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==e.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},scale:function(t,e){var i,s,r;const n=null!==(i=e.x)&&void 0!==i?i:1,o=null!==(s=e.y)&&void 0!==s?s:1,a=null!==(r=e.z)&&void 0!==r?r:1,h=Math.floor(t.positions.length/3);for(let e=0;e<h;++e){const i=3*e,s=3*e+1,r=3*e+2;t.positions[i]*=n,t.positions[s]*=o,t.positions[r]*=a}const{minPos:l,maxPos:c}=t;if(l&&(l.x*=n,l.y*=o,l.z*=a),c&&(c.x*=n,c.y*=o,c.z*=a),l&&c){if(n<0){const t=l.x;l.x=c.x,c.x=t}if(o<0){const t=l.y;l.y=c.y,c.y=t}if(a<0){const t=l.z;l.z=c.z,c.z=t}}return void 0!==t.boundingRadius&&(t.boundingRadius*=Math.max(Math.max(Math.abs(n),Math.abs(o)),Math.abs(a))),t},sphere:function(t,e){void 0===t&&(t=.5),void 0===e&&(e={});const i=void 0!==e.segments?e.segments:32,s=[],r=[],n=[],o=[],a=new Ki(-t,-t,-t),h=new Ki(t,t,t),l=t;for(let e=0;e<=i;++e){const a=e*Math.PI/i,h=Math.sin(a),l=-Math.cos(a);for(let a=0;a<=i;++a){const c=2*a*Math.PI/i-Math.PI/2,u=Math.sin(c)*h,d=l,p=Math.cos(c)*h,_=a/i,g=e/i;if(s.push(u*t,d*t,p*t),r.push(u,d,p),n.push(_,g),e<i&&a<i){const t=i+1,s=t*e+a,r=t*(e+1)+a,n=t*(e+1)+a+1,h=t*e+a+1;o.push(s,h,r),o.push(h,n,r)}}}return{positions:s,indices:o,normals:r,uvs:n,minPos:a,maxPos:h,boundingRadius:l}},toWavefrontOBJ:function(t,e){if(void 0===e&&(e=1),!t.indices||!t.uvs||!t.normals||void 0!==t.primitiveMode&&7!==t.primitiveMode)return"";const i=t.positions,s=t.uvs,r=t.normals,n=t.indices,o=t=>`${n[t]+1}/${n[t]+1}/${n[t]+1}`;let a="";for(let t=0;t<i.length;t+=3)a+=`v ${i[t]*e} ${i[t+1]*e} ${i[t+2]*e}\n`;for(let t=0;t<s.length;t+=2)a+=`vt ${s[t]} ${s[t+1]}\n`;for(let t=0;t<r.length;t+=3)a+=`vn ${r[t]} ${r[t+1]} ${r[t+2]}\n`;for(let t=0;t<n.length;t+=3)a+=`f ${o(t)} ${o(t+1)} ${o(t+2)}\n`;return a},torus:function(t,e,i){void 0===t&&(t=.4),void 0===e&&(e=.1),void 0===i&&(i={});const s=i.radialSegments||32,r=i.tubularSegments||32,n=i.arc||2*Math.PI,o=[],a=[],h=[],l=[],c=new Ki(-t-e,-e,-t-e),u=new Ki(t+e,e,t+e),d=t+e;for(let i=0;i<=s;i++)for(let c=0;c<=r;c++){const u=c/r,d=i/s,p=u*n,_=d*Math.PI*2,g=(t+e*Math.cos(_))*Math.sin(p),f=e*Math.sin(_),m=(t+e*Math.cos(_))*Math.cos(p),y=Math.sin(p)*Math.cos(_),v=Math.sin(_),b=Math.cos(p)*Math.cos(_);if(o.push(g,f,m),a.push(y,v,b),h.push(u,d),c<r&&i<s){const t=r+1,e=t*i+c,s=t*(i+1)+c,n=t*(i+1)+c+1,o=t*i+c+1;l.push(e,o,s),l.push(o,n,s)}}return{positions:o,normals:a,uvs:h,indices:l,minPos:c,maxPos:u,boundingRadius:d}},translate:function(t,e){const i=e.x||0,s=e.y||0,r=e.z||0,n=Math.floor(t.positions.length/3);for(let e=0;e<n;++e){const n=3*e,o=3*e+1,a=3*e+2;t.positions[n]+=i,t.positions[o]+=s,t.positions[a]+=r}return t.minPos&&(t.minPos.x+=i,t.minPos.y+=s,t.minPos.z+=r),t.maxPos&&(t.maxPos.x+=i,t.maxPos.y+=s,t.maxPos.z+=r),t},wireframe:function(t){const e=[[0,1],[1,2],[2,0]],i=[],s={};for(let r=0;r<t.length;r+=3)for(let n=0;n<3;++n){const o=t[r+e[n][0]],a=t[r+e[n][1]],h=o>a?a<<16|o:o<<16|a;void 0===s[h]&&(s[h]=0,i.push(o,a))}return i},wireframed:function(t){const{indices:e}=t;if(!e)return t;if(t.primitiveMode&&7!==t.primitiveMode)return t;const i=[[0,1],[1,2],[2,0]],s=[],r={};for(let t=0;t<e.length;t+=3)for(let n=0;n<3;++n){const o=e[t+i[n][0]],a=e[t+i[n][1]],h=o>a?a<<16|o:o<<16|a;void 0===r[h]&&(r[h]=0,s.push(o,a))}return t.indices=s,t.primitiveMode=1,t}});t("primitives",kX);const NX=new Ki;function UX(t){return t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z),t}var VX,HX,GX,WX,jX,$X,qX,XX,YX,QX,KX,ZX,JX,tY,eY,iY,sY,rY,nY,oY,aY,hY,lY,cY=Object.freeze({__proto__:null,CharacterTriggerEventObject:{type:"onControllerTriggerEnter",collider:null,characterController:null,impl:null},CollisionEventObject:{type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},TriggerEventObject:{type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},VEC3_0:NX,absolute:UX,cylinder:IX,getWrap:function(t){return t.__cc_wrapper__},maxComponent:function(t){return Math.max(t.x,Math.max(t.y,t.z))},setWrap:function(t,e){t.__cc_wrapper__=e},shrinkPositions:function(t){const e=[],i={};if(t.length>=3){e[0]=t[0],e[1]=t[1],e[2]=t[2];const s=t.length;for(let r=3;r<s;r+=3){const s=t[r],n=t[r+1],o=t[r+2],a=String(s)+String(n)+String(o),h=du(a,666);i[h]!==a&&(i[h]=a,e.push(s),e.push(n),e.push(o))}}return e}});t("ReflectionProbe",(VX=oa("cc.ReflectionProbe"),HX=Ga(Ki),GX=Ga(te(jA)),WX=Ga(te({Low_256x256:256,Medium_512x512:512,High_768x768:768})),jX=Ga(te(WA)),$X=Ga(_r),qX=Ga(Kf.BitMask),XX=Ga(uk),YX=Ga(Be),QX=Ga(Uv),VX((lY=class t extends Ag{constructor(){super(),this._lastSize=new Ki,this._resolution=JX&&JX(),this._clearFlag=tY&&tY(),this._backgroundColor=eY&&eY(),this._visibility=iY&&iY(),this._probeType=sY&&sY(),this._cubemap=rY&&rY(),this._size=nY&&nY(),this._sourceCamera=oY&&oY(),this._probeId=aY&&aY(),this._fastBake=hY&&hY(),this._probe=null,this._previewSphere=null,this._previewPlane=null,this._sourceCameraPos=new Ki(0,0,0),this._position=new Ki(0,0,0)}set size(t){this._size.set(t),UX(this._size),this.probe.size=this._size,this.probe&&(this.probe.updateBoundingBox(),cX.probeManager.onUpdateProbes(),cX.probeManager.updateProbeData(),cX.probeManager.updateProbeOfModels())}get size(){return this._size}set probeType(e){if(this.probe.probeType=e,e!==this._probeType){const i=this._size.clone(),s=Ki.equals(this._lastSize,Ki.ZERO);this._probeType=e,0===this._probeType?(s&&this._size.set(t.DEFAULT_CUBE_SIZE),this.probe.switchProbeType(e,null),cX.probeManager.clearPlanarReflectionMap(this.probe)):(s&&this._size.set(t.DEFAULT_PLANER_SIZE),this._sourceCamera?this.probe.switchProbeType(e,this._sourceCamera.camera):P("the reflection camera is invalid, please set the reflection camera")),s||this._size.set(this._lastSize),this._lastSize.set(i),this.size=this._size}}get probeType(){return this._probeType}set resolution(t){this._resolution=t,this.probe.resolution=t}get resolution(){return this._resolution}set clearFlag(t){this._clearFlag=t,this.probe.clearFlag=this._clearFlag}get clearFlag(){return this._clearFlag}set backgroundColor(t){this._backgroundColor=t,this.probe.backgroundColor=this._backgroundColor}get backgroundColor(){return this._backgroundColor}get visibility(){return this._visibility}set visibility(t){this._visibility=t,this.probe.visibility=this._visibility}set sourceCamera(t){this._sourceCamera=t,t&&(this.visibility=t.visibility,this.clearFlag=t.clearFlags,this.backgroundColor=t.clearColor,1===this.probeType&&this.probe.switchProbeType(this.probeType,t.camera))}get sourceCamera(){return this._sourceCamera}get fastBake(){return this._fastBake}set fastBake(t){this._fastBake=t}set cubemap(t){this._cubemap=t,this.probe.cubemap=t,cX.probeManager.onUpdateProbes()}get cubemap(){return this._cubemap}get probe(){return this._probe}set previewSphere(t){this._previewSphere=t,this.probe&&(this.probe.previewSphere=t,this._previewSphere&&cX.probeManager.updatePreviewSphere(this.probe))}get previewSphere(){return this._previewSphere}set previewPlane(t){this._previewPlane=t,this.probe&&(this.probe.previewPlane=t,this._previewPlane&&cX.probeManager.updatePreviewPlane(this.probe))}get previewPlane(){return this._previewPlane}onLoad(){this._createProbe()}onEnable(){if(this._probe){const t=cX.probeManager.getProbeById(this._probeId);null!==t&&t!==this._probe&&(this._probeId=cX.probeManager.getNewReflectionProbeId(),this._probe.updateProbeId(this._probeId)),cX.probeManager.register(this._probe),cX.probeManager.onUpdateProbes(),this._probe.enable()}}onDisable(){this._probe&&(cX.probeManager.unregister(this._probe),this._probe.disable())}start(){this._sourceCamera&&1===this.probeType&&(this.probe.renderPlanarReflection(this.sourceCamera.camera),cX.probeManager.filterModelsForPlanarReflection()),cX.probeManager.updateProbeData(),this._position=this.node.getWorldPosition().clone()}onDestroy(){this.probe&&this.probe.destroy()}update(t){if(this.probe){1===this.probeType&&this.sourceCamera&&(7&this.sourceCamera.node.hasChangedFlags||!this._sourceCameraPos.equals(this.sourceCamera.node.getWorldPosition()))&&(this._sourceCameraPos=this.sourceCamera.node.getWorldPosition(),this.probe.renderPlanarReflection(this.sourceCamera.camera)),1&this.node.hasChangedFlags&&(this.probe.updateBoundingBox(),cX.probeManager.onUpdateProbes(),cX.probeManager.updateProbeData());{const t=this.node.getWorldPosition();this._position.equals(t)||(this._position=t,this.probe.updateBoundingBox(),cX.probeManager.updateProbeData(),cX.probeManager.updateProbeOfModels())}}}clearBakedCubemap(){this.cubemap=null,cX.probeManager.updateBakedCubemap(this.probe),cX.probeManager.updatePreviewSphere(this.probe)}_createProbe(){if((-1===this._probeId||cX.probeManager.exists(this._probeId))&&(this._probeId=cX.probeManager.getNewReflectionProbeId()),this._probe=new qA(this._probeId),this._probe){const t=new JS("ReflectionProbeCamera");t.hideFlags|=yn.Flags.DontSave|yn.Flags.HideInHierarchy,this.node.scene.addChild(t),this._probe.initialize(this.node,t),this.enabled&&cX.probeManager.register(this._probe),this._probe.resolution=this._resolution,this._probe.clearFlag=this._clearFlag,this._probe.backgroundColor=this._backgroundColor,this._probe.visibility=this._visibility,this._probe.probeType=this._probeType,this._probe.size=this._size,this._probe.cubemap=this._cubemap}}},lY.DEFAULT_CUBE_SIZE=new Ki(1,1,1),lY.DEFAULT_PLANER_SIZE=new Ki(5,.5,5),JX=Qo((ZX=lY).prototype,"_resolution",[va],(function(){return 256})),tY=Qo(ZX.prototype,"_clearFlag",[va],(function(){return 14})),eY=Qo(ZX.prototype,"_backgroundColor",[va],(function(){return new _r(0,0,0,255)})),iY=Qo(ZX.prototype,"_visibility",[va],(function(){return Fy})),sY=Qo(ZX.prototype,"_probeType",[va],(function(){return 0})),rY=Qo(ZX.prototype,"_cubemap",[va],(function(){return null})),nY=Qo(ZX.prototype,"_size",[va],(function(){return new Ki(1,1,1)})),oY=Qo(ZX.prototype,"_sourceCamera",[va],(function(){return null})),aY=Qo(ZX.prototype,"_probeId",[va],(function(){return-1})),hY=Qo(ZX.prototype,"_fastBake",[va],(function(){return!1})),s(ZX.prototype,"size",[HX],Object.getOwnPropertyDescriptor(ZX.prototype,"size"),ZX.prototype),s(ZX.prototype,"probeType",[GX],Object.getOwnPropertyDescriptor(ZX.prototype,"probeType"),ZX.prototype),s(ZX.prototype,"resolution",[WX],Object.getOwnPropertyDescriptor(ZX.prototype,"resolution"),ZX.prototype),s(ZX.prototype,"clearFlag",[jX],Object.getOwnPropertyDescriptor(ZX.prototype,"clearFlag"),ZX.prototype),s(ZX.prototype,"backgroundColor",[$X],Object.getOwnPropertyDescriptor(ZX.prototype,"backgroundColor"),ZX.prototype),s(ZX.prototype,"visibility",[qX],Object.getOwnPropertyDescriptor(ZX.prototype,"visibility"),ZX.prototype),s(ZX.prototype,"sourceCamera",[XX],Object.getOwnPropertyDescriptor(ZX.prototype,"sourceCamera"),ZX.prototype),s(ZX.prototype,"fastBake",[YX],Object.getOwnPropertyDescriptor(ZX.prototype,"fastBake"),ZX.prototype),s(ZX.prototype,"cubemap",[QX],Object.getOwnPropertyDescriptor(ZX.prototype,"cubemap"),ZX.prototype),KX=ZX))||KX)),l.utils=_B;const uY="cc.animation.",dY=Symbol("CreateEval");var pY,_Y,gY,fY,mY;oa(`${uY}EmbeddedPlayer`)((pY=class extends ja{constructor(){super(...arguments),this.begin=_Y&&_Y(),this.end=gY&&gY(),this.reconciledSpeed=fY&&fY(),this.playable=mY&&mY()}},_Y=Qo(pY.prototype,"begin",[va],(function(){return 0})),gY=Qo(pY.prototype,"end",[va],(function(){return 0})),fY=Qo(pY.prototype,"reconciledSpeed",[va],(function(){return!1})),mY=Qo(pY.prototype,"playable",[va],(function(){return null})),pY));class yY{}class vY{constructor(t){this._randomAccess=t}get randomAccess(){return this._randomAccess}setTime(t){}}class bY{constructor(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isMotionless(){return!this.isPlaying||this.isPaused}play(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(Y(3912)):(this._isPlaying=!0,this.onPlay())}stop(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}pause(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}resume(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}step(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}update(t){}onPlay(){}onPause(){}onResume(){}onStop(){}onError(t){}}const wY={Default:0,Normal:1,Reverse:36,Loop:2,LoopReverse:38,PingPong:22,PingPongReverse:54};se(wY);class SY{constructor(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}set(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex}}class xY{constructor(t){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}destroy(){for(let t=0;t<this._blendStateWriters.length;++t)this._pose.destroyWriter(this._blendStateWriters[t]);this._blendStateWriters.length=0}createPoseWriter(t,e,i){const s=this._pose.createWriter(t,e,this,i);return this._blendStateWriters.push(s),s}}function TY(){return h.director.getAnimationManager()}const CY={PLAY:"play",STOP:"stop",PAUSE:"pause",RESUME:"resume",LASTFRAME:"lastframe",FINISHED:"finished"};se(CY);class IY extends bY{get clip(){return this._clip}get name(){return this._name}get length(){return this.duration}get wrapMode(){return this._wrapMode}set wrapMode(t){var e;this._wrapMode=t,this.time=0,this.repeatCount=2&t?1/0:1,null===(e=this._clipEventEval)||void 0===e||e.setWrapMode(t)}get repeatCount(){return this._repeatCount}set repeatCount(t){this._repeatCount=t;const e=4&this._wrapMode,i=!(36&~this.wrapMode);this._useSimpleProcess=t===1/0&&!e&&!i}get delay(){return this._delay}set delay(t){this._delayTime=this._delay=t}get playbackRange(){return this._playbackRange}set playbackRange(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}get speed(){return this._speed}set speed(t){var e;this._speed=t,null===(e=this._clipEmbeddedPlayerEval)||void 0===e||e.notifyHostSpeedChanged(t)}get current(){return this.getWrappedInfo(this.time).time}get ratio(){return 0===this.duration?0:this.current/this.duration}get weight(){return this._weight}set weight(t){this._weight=t,this._poseOutput&&(this._poseOutput.weight=t)}constructor(t,e){void 0===e&&(e=""),super(),this.duration=1,this.time=0,this.frameRate=0,this._targetNode=null,this._curveLoaded=!1,this._clip=void 0,this._speed=1,this._useSimpleProcess=!1,this._target=null,this._wrapMode=1,this._repeatCount=1,this._delay=0,this._delayTime=0,this._currentFramePlayed=!1,this._name=void 0,this._lastIterations=NaN,this._lastWrapInfo=null,this._wrappedInfo=new SY,this._allowLastFrame=!1,this._blendStateWriterHost={weight:0},this._playbackDuration=0,this._invDuration=1,this._poseOutput=null,this._weight=1,this._clipEval=void 0,this._clipEventEval=void 0,this._clipEmbeddedPlayerEval=void 0,this._doNotCreateEval=!1,this._clip=t,this._name=e||t&&t.name,this._playbackRange={min:0,max:t.duration},this._playbackDuration=t.duration,t.duration||O(`Clip ${t.name} has zero duration.`)}get curveLoaded(){return this._curveLoaded}initialize(t,e,i){if(this._curveLoaded)return;this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._clipEventEval&&(this._clipEventEval=void 0),this._clipEmbeddedPlayerEval&&(this._clipEmbeddedPlayerEval.destroy(),this._clipEmbeddedPlayerEval=void 0),this._targetNode=t;const s=this._clip;if(this.duration=s.duration,this._invDuration=1/this.duration,this._speed=s.speed,this.wrapMode=s.wrapMode,this.frameRate=s.sample,this._playbackRange.min=0,this._playbackRange.max=s.duration,this._playbackDuration=s.duration,2&~this.wrapMode?this.repeatCount=1:this.repeatCount=1/0,!this._doNotCreateEval){var r,n,o;const a=null!==(r=null!=e?e:null===(n=TY())||void 0===n?void 0:n.blendState)&&void 0!==r?r:null;a&&(this._poseOutput=new xY(a)),this._clipEval=s.createEvaluator({target:t,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0,mask:i})}s.containsAnyEvent()&&(this._clipEventEval=s.createEventEvaluator(this._targetNode)),s.containsAnyEmbeddedPlayer()&&(this._clipEmbeddedPlayerEval=s.createEmbeddedPlayerEvaluator(this._targetNode),this._clipEmbeddedPlayerEval.notifyHostSpeedChanged(this._speed))}destroy(){this.isMotionless||TY().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0}emit(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];TY().pushDelayEvent(this._emit,this,e)}on(t,e,i){return this._target&&this._target.isValid?this._target.on(t,e,i):null}once(t,e,i){return this._target&&this._target.isValid?this._target.once(t,e,i):null}off(t,e,i){this._target&&this._target.isValid&&this._target.off(t,e,i)}allowLastFrameEvent(t){this._allowLastFrame=t}_setEventTarget(t){this._target=t}setTime(t){this._currentFramePlayed=!1,this.time=t||0;{var e;const i=this.getWrappedInfo(t,this._wrappedInfo);null===(e=this._clipEventEval)||void 0===e||e.ignore(i.ratio,i.direction)}}update(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this._speed:this._currentFramePlayed=!0,this._process())}sample(){const t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.time),this._sampleEvents(t),this._sampleEmbeddedPlayers(t),t}onPlay(){var t;this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit("play",this),null===(t=this._clipEmbeddedPlayerEval)||void 0===t||t.notifyHostPlay(this.current)}onStop(){var t;this.isPaused||this._onPauseOrStop(),this.emit("stop",this),null===(t=this._clipEmbeddedPlayerEval)||void 0===t||t.notifyHostStop()}onResume(){var t;this._onReplayOrResume(),this.emit("resume",this),null===(t=this._clipEmbeddedPlayerEval)||void 0===t||t.notifyHostPlay(this.current)}onPause(){var t;this._onPauseOrStop(),this.emit("pause",this),null===(t=this._clipEmbeddedPlayerEval)||void 0===t||t.notifyHostPause(this.current)}_sampleCurves(t){const{_poseOutput:e,_clipEval:i}=this;e&&(e.weight=this.weight),i&&i.evaluate(t)}_process(){this._useSimpleProcess?this.simpleProcess():this.process()}process(){const t=this.sample();if(this._allowLastFrame){let e;e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new SY(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit("lastframe",this),e.set(t)}t.stopped&&(this.stop(),this.emit("finished",this))}simpleProcess(){const t=this._playbackRange.min,e=this._playbackDuration;let i=0,s=0;if(0!==e&&(i=this.time%e,i<0&&(i+=e),s=(t+i)*this._invDuration),this._sampleCurves(t+i),this._clipEventEval||this._clipEmbeddedPlayerEval){const t=this.getWrappedInfo(this.time,this._wrappedInfo);this._sampleEvents(t),this._sampleEmbeddedPlayers(t)}this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=s),(this.time>0&&this._lastIterations>s||this.time<0&&this._lastIterations<s)&&this.emit("lastframe",this),this._lastIterations=s)}_needReverse(t){const e=this.wrapMode;let i=!1;return 22&~e||(t-(0|t)==0&&t>0&&(t-=1),1&t&&(i=!i)),36&~e||(i=!i),i}getWrappedInfo(t,e){e=e||new SY;const{_playbackRange:{min:i},_playbackDuration:s}=this,r=this.repeatCount;if(0===s)return e.time=0,e.ratio=0,e.direction=1,e.stopped=!!Number.isFinite(r),e.iterations=0,e;let n=!1,o=(t-=i)>0?t/s:-t/s;if(o>=r){o=r,n=!0;let e=r-(0|r);0===e&&(e=1),t=e*s*(t>0?1:-1)}if(t>s){const e=t%s;t=0===e?s:e}else t<0&&0!=(t%=s)&&(t+=s);let a=!1;const h=4&this._wrapMode;h&&(a=this._needReverse(o));let l=a?-1:1;return this.speed<0&&(l*=-1),h&&a&&(t=s-t),e.time=i+t,e.ratio=e.time/this.duration,e.direction=l,e.stopped=n,e.iterations=o,e}_getPlaybackStart(){return this._playbackRange.min}_sampleEvents(t){var e;null===(e=this._clipEventEval)||void 0===e||e.sample(t.ratio,t.direction,t.iterations)}_sampleEmbeddedPlayers(t){var e;null===(e=this._clipEmbeddedPlayerEval)||void 0===e||e.evaluate(t.time,Math.trunc(t.iterations))}_emit(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)}_onReplayOrResume(){TY().addAnimation(this)}_onPauseOrStop(){TY().removeAnimation(this)}}var EY,DY,AY,MY,PY,BY,RY,OY,LY,FY,zY;t("AnimationState",IY),h.AnimationState=IY,oa(`${uY}EmbeddedAnimationClipPlayable`)((EY=class extends yY{constructor(){super(...arguments),this.path=DY&&DY(),this.clip=AY&&AY()}instantiate(t){const{clip:e,path:i}=this;if(!e)return null;const s=t.getChildByPath(i);if(!s)return j(3938,i,t.getPathInHierarchy(),e.name),null;const r=new IY(e);return r.initialize(s),new kY(r)}},DY=Qo(EY.prototype,"path",[va],(function(){return""})),AY=Qo(EY.prototype,"clip",[va],(function(){return null})),EY));class kY extends vY{constructor(t){super(!0),this._animationState=void 0,this._animationState=t}destroy(){this._animationState.destroy()}play(){this._animationState.play()}pause(){this._animationState.pause()}stop(){this._animationState.stop()}setSpeed(t){this._animationState.speed=t}setTime(t){this._animationState.time=t}}oa(`${uY}EmbeddedParticleSystemPlayable`)((MY=class extends yY{constructor(){super(...arguments),this.path=PY&&PY()}instantiate(t){const e=t.getChildByPath(this.path);if(!e)return P(`Hierarchy path ${this.path} does not exists.`),null;const i=kt("cc.ParticleSystem");if(!i)return P("Particle system is required for embedded particle system player."),null;const s=e.getComponent(i);return s?new NY(s):(P(`${this.path} does not includes a particle system component.`),null)}},PY=Qo(MY.prototype,"path",[va],(function(){return""})),MY));class NY extends vY{constructor(t){super(!1),this._particleSystem=void 0,this._particleSystem=t}destroy(){}play(){this._particleSystem.play()}pause(){this._particleSystem.stopEmitting()}stop(){this._particleSystem.stopEmitting()}setSpeed(t){this._particleSystem.simulationSpeed=t}}function UY(t){return"string"==typeof t||"number"==typeof t}let VY=oa("cc.animation.HierarchyPath")((RY=class{constructor(t){this.path=OY&&OY(),this.path=t||""}get(t){if(!(t instanceof JS))return G(3925),null;return t.getChildByPath(this.path)||(G(3926,t.name,this.path),null)}},OY=Qo(RY.prototype,"path",[va],(function(){return""})),BY=RY))||BY,HY=oa("cc.animation.ComponentPath")((FY=class{constructor(t){this.component=zY&&zY(),this.component=t||""}get(t){if(!(t instanceof JS))return G(3927),null;return t.getComponent(this.component)||(G(3928,t.name,this.component),null)}},zY=Qo(FY.prototype,"component",[va],(function(){return""})),LY=FY))||LY;var GY,WY,jY,$Y,qY,XY,YY,QY,KY,ZY,JY,tQ,eQ,iQ,sQ,rQ,nQ;const oQ=Symbol("NormalizedFollow"),aQ=Symbol("ConvertAsTrsPath"),hQ=Symbol("TrackBinding");let lQ=oa(`${uY}TrackPath`)((WY=class t{constructor(){this._paths=jY&&jY()}get length(){return this._paths.length}toProperty(t){return this._paths.push(t),this}toElement(t){return this._paths.push(t),this}toHierarchy(t){return this._paths.push(new VY(t)),this}toComponent(t){const e=new HY("string"==typeof t?t:pt(t));return this._paths.push(e),this}toCustomized(t){return this._paths.push(t),this}append(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=this._paths.concat(...e.map((t=>t._paths)));return this._paths=s,this}isPropertyAt(t){return"string"==typeof this._paths[t]}parsePropertyAt(t){return this._paths[t]}isElementAt(t){return"number"==typeof this._paths[t]}parseElementAt(t){return this._paths[t]}isHierarchyAt(t){return this._paths[t]instanceof VY}parseHierarchyAt(t){return this.isHierarchyAt(t),this._paths[t].path}isComponentAt(t){return this._paths[t]instanceof HY}parseComponentAt(t){return this.isComponentAt(t),this._paths[t].component}slice(e,i){const s=new t;return s._paths=this._paths.slice(e,i),s}trace(t,e,i){var s,r;return null!==(s=e)&&void 0!==s||(e=0),null!==(r=i)&&void 0!==r||(i=this._paths.length),this[oQ](t,e,i)}[aQ](){const{_paths:t}=this,e=t.length;let i,s=0,r="";for(;s<e;++s){const e=t[s];if(!(e instanceof VY))break;e.path&&(r?r+=`/${e.path}`:r=e.path)}if(s===e)return null;if(s!==e-1)return null;switch(t[s]){case"position":case"scale":case"rotation":case"eulerAngles":i=t[s];break;default:return null}return{node:r,property:i}}[oQ](t,e,i){const{_paths:s}=this;let r=t;for(let t=e;t<i;++t){const e=s[t];if(UY(e)){if(!(e in r))return G(3929,e),null;r=r[e]}else r=e.get(r);if(null===r)break}return r}},jY=Qo(WY.prototype,"_paths",[va],(function(){return[]})),GY=WY))||GY,cQ=oa(`${uY}TrackBinding`)($Y=xa((QY=class t{constructor(){this.path=XY&&XY(),this.proxy=YY&&YY()}parseTrsPath(){return this.proxy?null:this.path[aQ]()}createRuntimeBinding(e,i,s){const{path:r,proxy:n}=this,o=r.length,a=o-1;if(0===o||!r.isPropertyAt(a)&&!r.isElementAt(a)||n){if(n){const t=r[oQ](e,0,o);if(null===t)return null;const i=n.forTarget(t);if(!i)return null;const s={setValue:t=>{i.set(t)}},a=i.get;return a&&(s.getValue=()=>a.call(i)),s}return j(3921),null}{const n=r.isPropertyAt(a)?r.parsePropertyAt(a):r.parseElementAt(a),h=r[oQ](e,0,o-1);if(null===h)return null;if(i&&h instanceof JS&&uQ(n))return i.createPoseWriter(h,n,s);let l,c;{let e=t._animationFunctions.get(h.constructor);e||(e=new Map,t._animationFunctions.set(h.constructor,e));let i=e.get(n);i||(i={setValue:Function("value",`this.target.${n} = value;`),getValue:Function(`return this.target.${n};`)},e.set(n,i)),l=i.setValue,c=i.getValue}return{target:h,setValue:l,getValue:c}}}isMaskedOff(t){const e=this.parseTrsPath();if(!e)return!1;const i=t.joints[Symbol.iterator]();for(let t=i.next();!t.done;t=i.next()){const{value:i}=t;if(i.path===e.node)return!i.enabled}return!1}},QY._animationFunctions=new WeakMap,XY=Qo((qY=QY).prototype,"path",[va],(function(){return new lQ})),YY=Qo(qY.prototype,"proxy",[va],null),$Y=qY))||$Y)||$Y;function uQ(t){return"position"===t||"rotation"===t||"scale"===t||"eulerAngles"===t}let dQ=oa(`${uY}Track`)((ZY=class{constructor(){this._binding=JY&&JY()}get path(){return this._binding.path}set path(t){this._binding.path=t}get proxy(){return this._binding.proxy}set proxy(t){this._binding.proxy=t}get[hQ](){return this._binding}channels(){return[]}range(){const t={min:1/0,max:-1/0};for(const e of this.channels())t.min=Math.min(t.min,e.curve.rangeMin),t.max=Math.max(t.max,e.curve.rangeMax);return t}},JY=Qo(ZY.prototype,"_binding",[va],(function(){return new cQ})),KY=ZY))||KY,pQ=oa(`${uY}Channel`)((eQ=class{constructor(t){this.name="",this._curve=iQ&&iQ(),this._curve=t}get curve(){return this._curve}},iQ=Qo(eQ.prototype,"_curve",[va],null),tQ=eQ))||tQ,_Q=oa(`${uY}SingleChannelTrack`)((rQ=class extends dQ{constructor(){super(),this._channel=nQ&&nQ(),this._channel=new pQ(this.createCurve())}get channel(){return this._channel}channels(){return[this._channel]}createCurve(){throw new Error("Not impl")}[dY](){const{curve:t}=this._channel;return new gQ(t)}},nQ=Qo(rQ.prototype,"_channel",[va],null),sQ=rQ))||sQ;class gQ{constructor(t){this._curve=t}get requiresDefault(){return!1}evaluate(t){return this._curve.evaluate(t)}}var fQ,mQ;const{ccclass:yQ,serializable:vQ}=Ja;yQ(`${uY}RealArrayTrack`)((fQ=class extends dQ{constructor(){super(...arguments),this._channels=mQ&&mQ()}get elementCount(){return this._channels.length}set elementCount(t){const{_channels:e}=this,i=e.length;t<i?this._channels.splice(t):t>i&&this._channels.push(...Array.from({length:t-i},(()=>new pQ(new nl))))}channels(){return this._channels}[dY](){return new bQ(this._channels.map((t=>{let{curve:e}=t;return e})))}},mQ=Qo(fQ.prototype,"_channels",[vQ],(function(){return[]})),fQ));class bQ{constructor(t){this._curves=t,this._result=new Array(t.length).fill(0)}get requiresDefault(){return!1}evaluate(t){const{_result:e}=this,i=e.length;for(let s=0;s<i;++s)e[s]=this._curves[s].evaluate(t);return this._result}}var wQ,SQ,xQ,TQ,CQ;let IQ=oa("cc.animation.UniformProxyFactory")((SQ=class{constructor(t,e){this.passIndex=xQ&&xQ(),this.uniformName=TQ&&TQ(),i(this,"channelIndex",CQ,this),this.passIndex=e||0,this.uniformName=t||""}forTarget(t){if(!(t instanceof Lw))return void G(3940,t);const{passIndex:e,uniformName:i,channelIndex:s}=this;if(e<0||e>=t.passes.length)return void G(3941,t.name,e);const r=t.passes[e],n=r.getHandle(i);if(n){if(vw.getTypeFromHandle(n)<26){const o=void 0===s?n:r.getHandle(i,s,13);return o?EQ(r,i)?{set:t=>{r.setUniformArray(o,t)}}:{set:t=>{r.setUniform(o,t)}}:void G(3943,t.name,e,i,s)}{const t=vw.getBindingFromHandle(n),e=r.properties[i],s=e&&e.value?`${e.value}${rv(e.type)}`:sv(e.type);let o=pw.get(s);return o||(P(`Illegal texture default value: ${s}.`),o=pw.get("default-texture")),{set:e=>{e||(e=o);const i=e.getGFXTexture();i&&i.width&&i.height&&(r.bindTexture(t,i),e instanceof rg&&r.bindSampler(t,e_.gfxDevice.getSampler(e.getSamplerInfo())))}}}}G(3942,t.name,e,i)}},xQ=Qo(SQ.prototype,"passIndex",[va],(function(){return 0})),TQ=Qo(SQ.prototype,"uniformName",[va],(function(){return""})),CQ=s(SQ.prototype,"channelIndex",[Ua],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),wQ=SQ))||wQ;function EQ(t,e){for(const i of t.shaderInfo.blocks)for(const t of i.members)if(t.name===e)return t.count>1;return!1}var DQ,AQ,MQ,PQ,BQ,RQ,OQ,LQ;let FQ=oa("cc.animation.MorphWeightValueProxy")((AQ=class{constructor(){this.subMeshIndex=MQ&&MQ(),this.shapeIndex=PQ&&PQ()}forTarget(t){return{set:e=>{t.setWeight(e,this.subMeshIndex,this.shapeIndex)}}}},MQ=Qo(AQ.prototype,"subMeshIndex",[va],(function(){return 0})),PQ=Qo(AQ.prototype,"shapeIndex",[va],(function(){return 0})),DQ=AQ))||DQ,zQ=oa("cc.animation.MorphWeightsValueProxy")((RQ=class{constructor(){this.subMeshIndex=OQ&&OQ()}forTarget(t){return{set:e=>{t.setWeights(e,this.subMeshIndex)}}}},OQ=Qo(RQ.prototype,"subMeshIndex",[va],(function(){return 0})),BQ=RQ))||BQ,kQ=oa("cc.animation.MorphWeightsAllValueProxy")(LQ=class{forTarget(t){return{set:e=>{var i,s;const r=null!==(i=null===(s=t.mesh)||void 0===s?void 0:s.struct.primitives.length)&&void 0!==i?i:0;for(let i=0;i<r;++i)t.setWeights(e,i)}}}})||LQ;var NQ,UQ,VQ,HQ,GQ;function WQ(t,e,i,s){var r,n,o,a,h;let l=new e,c=new e,u=new e,d=oa(t)((n=class{constructor(t,i,s){this.dataPoint=o&&o(),this.inTangent=a&&a(),this.outTangent=h&&h(),this.dataPoint=t||new e,this.inTangent=i||new e,this.outTangent=s||new e}lerp(t,e,r){const n=this.dataPoint,o=t.dataPoint;c=i(c,this.inTangent,r),u=i(u,t.outTangent,r);const a=e*e*e,h=e*e,d=a-2*h+e,p=-2*a+3*h,_=a-h;return l=i(l,n,2*a-3*h+1),l=s(l,l,c,d),l=s(l,l,o,p),l=s(l,l,u,_),l}getNoLerp(){return this.dataPoint}},o=Qo(n.prototype,"dataPoint",[va],(function(){return new e})),a=Qo(n.prototype,"inTangent",[va],(function(){return new e})),h=Qo(n.prototype,"outTangent",[va],(function(){return new e})),r=n))||r;if(e===ys){const t=d.prototype.lerp;d.prototype.lerp=function(e,i,s){const r=t.call(this,e,i,s);return ys.normalize(r,r),r}}return d}const jQ=WQ("cc.CubicSplineVec2Value",Qs,Qs.multiplyScalar,Qs.scaleAndAdd),$Q=WQ("cc.CubicSplineVec3Value",Ki,Ki.multiplyScalar,Ki.scaleAndAdd),qQ=WQ("cc.CubicSplineVec4Value",cr,cr.multiplyScalar,cr.scaleAndAdd),XQ=WQ("cc.CubicSplineQuatValue",ys,ys.multiplyScalar,ys.scaleAndAdd);let YQ=oa("cc.CubicSplineNumberValue")((UQ=class{constructor(t,e,i){this.dataPoint=VQ&&VQ(),this.inTangent=HQ&&HQ(),this.outTangent=GQ&&GQ(),this.dataPoint=t,this.inTangent=e,this.outTangent=i}lerp(t,e,i){const s=this.dataPoint,r=t.dataPoint,n=e*e*e,o=e*e;return s*(2*n-3*o+1)+this.outTangent*i*(n-2*o+e)+r*(-2*n+3*o)+t.inTangent*i*(n-o)}getNoLerp(){return this.dataPoint}},VQ=Qo(UQ.prototype,"dataPoint",[va],(function(){return 0})),HQ=Qo(UQ.prototype,"inTangent",[va],(function(){return 0})),GQ=Qo(UQ.prototype,"outTangent",[va],(function(){return 0})),NQ=UQ))||NQ;var QQ;let KQ=oa(`${uY}RealTrack`)(QQ=class extends _Q{createCurve(){return new nl}})||QQ;function ZQ(t){return 0===t.keyFramesCount?void 0:t}var JQ,tK,eK,iK;const sK=["X","Y","Z","W"];let rK=oa(`${uY}VectorTrack`)((tK=class extends dQ{constructor(){super(),this._channels=eK&&eK(),this._nComponents=iK&&iK(),this._channels=new Array(4);for(let t=0;t<this._channels.length;++t){const e=new pQ(new nl);e.name=sK[t],this._channels[t]=e}}get componentsCount(){return this._nComponents}set componentsCount(t){this._nComponents=t}channels(){return this._channels}[dY](){switch(this._nComponents){default:case 2:return new nK(ZQ(this._channels[0].curve),ZQ(this._channels[1].curve));case 3:return new oK(ZQ(this._channels[0].curve),ZQ(this._channels[1].curve),ZQ(this._channels[2].curve));case 4:return new aK(ZQ(this._channels[0].curve),ZQ(this._channels[1].curve),ZQ(this._channels[2].curve),ZQ(this._channels[3].curve))}}},eK=Qo(tK.prototype,"_channels",[va],null),iK=Qo(tK.prototype,"_nComponents",[va],(function(){return 4})),JQ=tK))||JQ;class nK{constructor(t,e){this._result=new Qs,this._x=t,this._y=e}get requiresDefault(){return!this._x||!this._y}evaluate(t,e){return e&&Qs.copy(this._result,e),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._result}}class oK{constructor(t,e,i){this._result=new Ki,this._x=t,this._y=e,this._z=i}get requiresDefault(){return!this._x||!this._y||!this._z}evaluate(t,e){const{_x:i,_y:s,_z:r,_result:n}=this;return e&&Ki.copy(n,e),i&&(n.x=i.evaluate(t)),s&&(n.y=s.evaluate(t)),r&&(n.z=r.evaluate(t)),n}}class aK{constructor(t,e,i,s){this._result=new cr,this._x=t,this._y=e,this._z=i,this._w=s}get requiresDefault(){return!(this._x&&this._y&&this._z&&this._w)}evaluate(t,e){return e&&cr.copy(this._result,e),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._w&&(this._result.w=this._w.evaluate(t)),this._result}}var hK;let lK=oa(`${uY}QuatTrack`)(hK=class extends _Q{createCurve(){return new tc}[dY](){return new cK(this.channels()[0].curve)}})||hK;class cK{constructor(t){this._result=new ys,this._curve=t}get requiresDefault(){return!1}evaluate(t){return this._curve.evaluate(t,this._result),this._result}}var uK,dK,pK;const _K=["Red","Green","Blue","Alpha"];let gK=oa(`${uY}ColorTrack`)((dK=class extends dQ{constructor(){super(),this._channels=pK&&pK(),this._channels=new Array(4);for(let t=0;t<this._channels.length;++t){const e=new pQ(new nl);e.name=_K[t],this._channels[t]=e}}channels(){return this._channels}[dY](){return new fK(ZQ(this._channels[0].curve),ZQ(this._channels[1].curve),ZQ(this._channels[2].curve),ZQ(this._channels[3].curve))}},pK=Qo(dK.prototype,"_channels",[va],null),uK=dK))||uK;class fK{constructor(t,e,i,s){this._result=new _r,this._x=t,this._y=e,this._z=i,this._w=s}get requiresDefault(){return!(this._x&&this._y&&this._z&&this._w)}evaluate(t,e){return e&&_r.copy(this._result,e),this._x&&(this._result.r=this._x.evaluate(t)),this._y&&(this._result.g=this._y.evaluate(t)),this._z&&(this._result.b=this._z.evaluate(t)),this._w&&(this._result.a=this._w.evaluate(t)),this._result}}var mK,yK,vK;const bK=["Width","Height"];let wK=oa(`${uY}SizeTrack`)((yK=class extends dQ{constructor(){super(),this._channels=vK&&vK(),this._channels=new Array(2);for(let t=0;t<this._channels.length;++t){const e=new pQ(new nl);e.name=bK[t],this._channels[t]=e}}channels(){return this._channels}[dY](){return new SK(ZQ(this._channels[0].curve),ZQ(this._channels[1].curve))}},vK=Qo(yK.prototype,"_channels",[va],null),mK=yK))||mK;class SK{constructor(t,e){this._result=new br,this._width=t,this._height=e}get requiresDefault(){return!this._width||!this._height}evaluate(t,e){return e&&(this._result.x=e.x,this._result.y=e.y),this._width&&(this._result.width=this._width.evaluate(t)),this._height&&(this._result.height=this._height.evaluate(t)),this._result}}var xK;let TK=oa(`${uY}ObjectTrack`)(xK=class extends _Q{createCurve(){return new cc}})||xK;const CK=Symbol("[[Owner]]");function IK(t){t[CK]}const EK=Symbol("CreateInstance");class DK{constructor(t){this._refs=[],this.type=t}bind(t,e){for(var i=arguments.length,s=new Array(i>2?i-2:0),r=2;r<i;r++)s[r-2]=arguments[r];return this._refs.push({fn:t,thisArg:e,args:s}),this.getValue()}get value(){return this.getValue()}set value(t){this.setValue(t);for(const{fn:e,thisArg:i,args:s}of this._refs)e.call(i,t,...s)}}var AK,MK,PK,BK;let RK=oa("cc.animation.PlainVariable")((MK=class{constructor(t){if(this._type=PK&&PK(),this._value=BK&&BK(),void 0!==t)switch(this._type=t,t){default:break;case 0:case 3:this._value=0;break;case 1:this._value=!1}}get type(){return this._type}get value(){return this._value}set value(t){this._value=t}[EK](){return new OK(this._type,this._value)}},PK=Qo(MK.prototype,"_type",[va],(function(){return 0})),BK=Qo(MK.prototype,"_value",[va],(function(){return 0})),AK=MK))||AK;class OK extends DK{constructor(t,e){super(t),this._value=void 0,this._value=e}getValue(){return this._value}setValue(t){this._value=t}}var LK,FK,zK;let kK=oa("cc.animation.TriggerVariable")((FK=class{constructor(){this._flags=zK&&zK()}get type(){return 2}get value(){return!!(1&this._flags)}set value(t){t?this._flags|=1:this._flags&=-2}get resetMode(){return(6&this._flags)>>1}set resetMode(t){this._flags&=-7,this._flags|=t<<1}[EK](){return new NK(this.value,this.resetMode)}},zK=Qo(FK.prototype,"_flags",[va],(function(){return 0})),LK=FK))||LK;class NK extends DK{constructor(t,e){super(2),this.resetMode=0,this._value=void 0,this.resetMode=e,this._value=t}getValue(){return this._value}setValue(t){this._value=t}}var UK,VK,HK;let GK=oa("cc.animation.Vec3Variable")((VK=class{constructor(){this._value=HK&&HK()}get type(){return 4}get value(){return this._value}set value(t){Ki.copy(this._value,t)}[EK](){return new WK(this.value)}},HK=Qo(VK.prototype,"_value",[va],(function(){return new Ki})),UK=VK))||UK;class WK extends DK{constructor(t){super(4),this._value=new Ki,Ki.copy(this._value,t)}getValue(){return this._value}setValue(t){Ki.copy(this._value,t)}}var jK,$K,qK;let XK=oa("cc.animation.QuatVariable")(($K=class{constructor(){this._value=qK&&qK()}get type(){return 5}get value(){return this._value}set value(t){ys.copy(this._value,t)}[EK](){return new YK(this._value)}},qK=Qo($K.prototype,"_value",[va],(function(){return new ys})),jK=$K))||jK;class YK extends DK{constructor(t){super(5),this._value=new ys,ys.copy(this._value,t)}getValue(){return this._value}setValue(t){ys.copy(this._value,t)}}function QK(t,e){let i;switch(t){case 0:case 3:case 1:i=new RK(t);break;case 2:i=new kK;break;case 4:i=new GK;break;case 5:i=new XK;break;default:throw new Error(`Unknown variable type ${t}`)}return void 0!==e&&(i.value=e),i}class KK extends Error{constructor(t){super(`${t} transition is invalid`),this.name="TransitionRejectError"}}class ZK extends Error{constructor(t){super(`Graph variable ${t} is not defined`)}}class JK extends Error{constructor(t,e,i){super(`Expect graph variable ${t} to have type '${e}' instead of received '${null!=i?i:typeof i}'`)}}const tZ=yn.Flags.Destroyed,eZ=yn.Flags.PersistentMask,iZ=[];function sZ(t){return"function"==typeof t._instantiate}function rZ(t){let e;if(vn(t)){if(sZ(t))return h.game._isCloning=!0,e=t._instantiate(null,!0),h.game._isCloning=!1,e;if(t instanceof h.Asset)throw new TypeError(Y(6903))}return h.game._isCloning=!0,e=nZ(t),h.game._isCloning=!1,e}function nZ(t,e){let i;i=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),aZ(t,i,e);for(let t=0,e=iZ.length;t<e;++t)iZ[t]._iN$t=null;return iZ.length=0,i}function oZ(t,e,i,s){const r=t.__values__;for(let t=0;t<r.length;t++){const n=r[t],o=e[n];if("object"==typeof o&&o){const t=i[n];t instanceof re&&t.constructor===o.constructor?t.set(o):i[n]=o._iN$t||hZ(o,s)}else i[n]=o}}function aZ(t,e,i){ht(t,"_iN$t",e,!0),iZ.push(t);const s=t.constructor;if(ni(s))oZ(s,t,e,i);else for(const s in t){if(!t.hasOwnProperty(s)||95===s.charCodeAt(0)&&95===s.charCodeAt(1)&&"__type__"!==s&&"__prefab"!==s)continue;const r=t[s];if("object"==typeof r&&r){if(r===e)continue;e[s]=r._iN$t||hZ(r,i)}else e[s]=r}vn(t)&&(e._objFlags&=eZ)}function hZ(t,e){if(t instanceof re)return t.clone();if(t instanceof h.Asset)return t;let i;if(ArrayBuffer.isView(t)){const e=t.length;i=new t.constructor(e),t._iN$t=i,iZ.push(t);for(let s=0;s<e;++s)i[s]=t[s];return i}if(Array.isArray(t)){const s=t.length;i=new Array(s),t._iN$t=i,iZ.push(t);for(let r=0;r<s;++r){const s=t[r];i[r]="object"==typeof s&&s?s._iN$t||hZ(s,e):s}return i}if(t._objFlags&tZ)return null;const s=t.constructor;if(ni(s)){if(e)if(e instanceof Ag){if(t instanceof JS||t instanceof Ag)return t}else if(e instanceof JS)if(t instanceof JS){if(!t.isChildOf(e))return t}else if(t instanceof Ag&&t.node&&!t.node.isChildOf(e))return t;i=new s}else if(s===Object)i={};else{if(s)return t;i=Object.create(null)}return aZ(t,i,e),i}function lZ(t){const e=t[an];if("object"==typeof e&&e){var i;const s=e;return null===(i=s.clone)||void 0===i?void 0:i.call(s,t)}}var cZ,uZ,dZ,pZ,_Z,gZ;rZ._clone=nZ,h.instantiate=rZ;const fZ=Symbol("[[Outgoing transitions]]"),mZ=Symbol("[[Incoming transitions]]"),{ccclass:yZ,serializable:vZ}=Ja;let bZ=yZ("cc.animation.State")((uZ=class extends ja{constructor(){super(),this.name=dZ&&dZ(),this[fZ]=[],this[mZ]=[]}copyTo(t){t.name=this.name,t[an]=lZ(this)}},dZ=Qo(uZ.prototype,"name",[vZ],(function(){return""})),cZ=uZ))||cZ,wZ=yZ(`${uY}InteractiveState`)((_Z=class extends bZ{constructor(){super(...arguments),this._components=gZ&&gZ()}get components(){return this._components}addComponent(t){const e=new t;return this._components.push(e),e}removeComponent(t){jt(this._components,t)}instantiateComponents(){return this._components.map((t=>rZ(t)))}copyTo(t){super.copyTo(t),t._components=this.instantiateComponents()}},gZ=Qo(_Z.prototype,"_components",[vZ],(function(){return[]})),pZ=_Z))||pZ;function SZ(t,e,i){const s=t.components,r=s.length;for(let t=0;t<r;++t){const r=s[t],n=r[e];"function"==typeof n&&n.apply(r,i)}}var xZ,TZ,CZ;let IZ=oa(`${uY}AnimationGraphEventBinding`)((TZ=class{constructor(){this.methodName=CZ&&CZ()}get isBound(){return!!this.methodName}emit(t){this.methodName&&SZ(t,this.methodName,[])}copyTo(t){return t.methodName=this.methodName,this}},CZ=Qo(TZ.prototype,"methodName",[va],(function(){return""})),xZ=TZ))||xZ;var EZ,DZ,AZ,MZ,PZ,BZ,RZ,OZ;let LZ=oa("cc.animation.Motion")((DZ=class extends wZ{constructor(){super(...arguments),this.motion=AZ&&AZ(),this.speed=MZ&&MZ(),this.speedMultiplier=PZ&&PZ(),this.speedMultiplierEnabled=BZ&&BZ(),this.transitionInEventBinding=RZ&&RZ(),this.transitionOutEventBinding=OZ&&OZ()}__callOnAfterDeserializeRecursive(){var t;null===(t=this.motion)||void 0===t||t.__callOnAfterDeserializeRecursive()}copyTo(t){var e,i;return super.copyTo(t),t.motion=null!==(e=null===(i=this.motion)||void 0===i?void 0:i.clone())&&void 0!==e?e:null,t.speed=this.speed,t.speedMultiplier=this.speedMultiplier,t.speedMultiplierEnabled=this.speedMultiplierEnabled,this.transitionInEventBinding.copyTo(t.transitionInEventBinding),this.transitionOutEventBinding.copyTo(t.transitionOutEventBinding),this}},AZ=Qo(DZ.prototype,"motion",[va],(function(){return null})),MZ=Qo(DZ.prototype,"speed",[va],(function(){return 1})),PZ=Qo(DZ.prototype,"speedMultiplier",[va],(function(){return""})),BZ=Qo(DZ.prototype,"speedMultiplierEnabled",[va],(function(){return!1})),RZ=Qo(DZ.prototype,"transitionInEventBinding",[va],(function(){return new IZ})),OZ=Qo(DZ.prototype,"transitionOutEventBinding",[va],(function(){return new IZ})),EZ=DZ))||EZ;const FZ=Symbol("[[OnAfterDeserialized]]");var zZ;let kZ=oa(`${uY}AnimationGraphLike`)(zZ=class extends F_{})||zZ;function NZ(t,e,i){const{propertyIsEnumerable:s}=Object.prototype;if(!s.call(t,e))return t;if(i in t)return t;const r={};return"symbol"==typeof e?(Object.entries(t).forEach((t=>{let[e,i]=t;r[e]=i})),Object.getOwnPropertySymbols(t).forEach((n=>{s.call(t,n)&&(r[n===e?i:n]=t[n])}))):(Object.entries(t).forEach((t=>{let[s,n]=t;r[s===e?i:s]=n})),Object.getOwnPropertySymbols(t).forEach((e=>{s.call(t,e)&&(r[e]=t[e])}))),r}const UZ=(()=>{let t=!1;try{class e{static[Symbol.hasInstance](t){return Array.isArray(t)}}t=[]instanceof e}catch{t=!1}return t?t=>{function e(){throw new Error("This function can not be called as a constructor.")}return Object.defineProperty(e,Symbol.hasInstance,{value:e=>e instanceof t}),e}:t=>t})();var VZ,HZ,GZ,WZ,jZ,$Z,qZ,XZ;let YZ=oa(`${uY}PoseGraphNodeShell`)((HZ=class extends ja{constructor(){super(...arguments),this._bindings=GZ&&GZ()}getBindings(){return this._bindings}addBinding(t,e,i){this._emplaceBinding(new KZ(t,e,i))}deleteBinding(t){const e=this._findBindingIndex(t);e>=0&&this._bindings.splice(e,1)}moveArrayElementBindingForward(t,e,i){const{_bindings:s}=this,r=[];for(let i=0;i<s.length;++i){const n=s[i],[o,a=-1]=n.inputPath;o===t&&a>=e&&(r.push(n),s.splice(i,1))}for(const t of r){const[e,s=-1]=t.inputPath;this.addBinding([e,s+(i?-1:1)],t.producer,t.outputIndex)}}deleteBindingTo(t){const{_bindings:e}=this;for(let i=0;i<e.length;++i)e[i].producer===t&&e.splice(i,1)}findBinding(t){const e=this._findBindingIndex(t);return e>=0?this._bindings[e]:void 0}_findBindingIndex(t){return this._bindings.findIndex((e=>QZ(e.inputPath,t)))}_emplaceBinding(t){const e=this._bindings.findIndex((e=>QZ(e.inputPath,t.inputPath)));e>=0?this._bindings[e]=t:this._bindings.push(t)}},GZ=Qo(HZ.prototype,"_bindings",[va],(function(){return[]})),VZ=HZ))||VZ;function QZ(t,e){const[i,s]=t,[r,n]=e;return i===r&&s===n}let KZ=oa(`${uY}PoseGraphNodeInputBinding`)((jZ=class{constructor(t,e,i){this._inputPath=$Z&&$Z(),this._producer=qZ&&qZ(),this._outputIndex=XZ&&XZ(),this._inputPath=t,this._producer=e,void 0!==i&&(this._outputIndex=i)}get inputPath(){return this._inputPath}get producer(){return this._producer}get outputIndex(){return this._outputIndex}},$Z=Qo(jZ.prototype,"_inputPath",[va],null),qZ=Qo(jZ.prototype,"_producer",[va],null),XZ=Qo(jZ.prototype,"_outputIndex",[va],(function(){return 0})),WZ=jZ))||WZ;class ZZ extends Error{constructor(t){super(`Can not add the specified ${t.toString()} since it has already been added into another graph.`)}}class JZ extends Error{constructor(t){super(`Can not perform specified operation on ${t.toString()} since it has not been added in to graph.`)}}class tJ extends ja{}const eJ=new WeakMap;function iJ(t){const e=eJ.get(t);if(e)return e;{const e={};return eJ.set(t,e),e}}function sJ(t){return e=>{if(!It(e,tJ)&&(B("This kind of decorator should only be applied to pose graph node classes."),1))return;const i=iJ(e);t(i)}}const rJ=t=>sJ((e=>{var i;Object.assign(null!==(i=e.appearance)&&void 0!==i?i:e.appearance={},t)}));function nJ(t,e,i,s){const r=t.getShell(e);if(!r)throw new JZ(e);const[n,o=-1]=i,a=e[n];Array.isArray(a)&&(a.splice(o,0,s),r.moveArrayElementBindingForward(n,o+1,!1))}function oJ(t,e,i){const s=t.getShell(e);if(!s)throw new JZ(e);const[r,n=-1]=i,o=e[r];Array.isArray(o)&&(n<0||n>=o.length||(s.deleteBinding(i),o.splice(n,1),s.moveArrayElementBindingForward(r,n+1,!0)))}function aJ(t){switch(t){default:case 0:case 1:return 0;case 2:return!1;case 5:return null;case 3:return new Ki;case 4:return new ys}}const hJ=new class{constructor(){this._classInputMap=new WeakMap}setPropertyNodeInputRecord(t,e,i){let s=this._classInputMap.get(t);s||(s={properties:{}},this._classInputMap.set(t,s));const{arraySyncGroup:r,...n}=i,o=n,a=i.arraySyncGroup;if(a){var h,l;s.arraySyncGroups||(s.arraySyncGroups={});const t=null!==(l=(h=s.arraySyncGroups)[a])&&void 0!==l?l:h[a]={members:[]};t.members.includes(e)||t.members.push(e),o.arraySyncGroup=t}s.properties[e]=Object.freeze(o)}getInputKeys(t){const e=[],i=s=>{if(!s)return;i(Ct(s));const r=this._classInputMap.get(s);if(r)for(const[i]of Object.entries(r.properties)){if(e.findIndex((t=>{let[e]=t;return i===e}))>=0)continue;const s=t[i];if(Array.isArray(s))for(let t=0;t<s.length;++t)e.push([i,t]);else e.push([i])}};return i(t.constructor),e}isPoseInput(t,e){const[i]=e,s=this._getPropertyNodeInputRecord(t.constructor,i);return!!s&&5===s.type}getInputMetadata(t,e){const[i,s=-1]=e,r=this._getPropertyNodeInputRecord(t.constructor,i);if(!r)return;const n=t[i];if(Array.isArray(n)){if(s<0||s>=n.length)return;{var o,a;const e=null!==(o=null===(a=r.getArrayElementDisplayName)||void 0===a?void 0:a.call(t,s))&&void 0!==o?o:r.displayName;return{type:r.type,displayName:e,deletable:!(r.arraySyncGroup&&r.arraySyncGroupFollower),insertPoint:!0}}}return{type:r.type,displayName:r.displayName}}hasInput(t,e){const[i,s=-1]=e;if(!this._getPropertyNodeInputRecord(t.constructor,i))return!1;const r=t[i];return!Array.isArray(r)||!(s<0||s>=r.length)}getInputInsertInfos(t){const e={};for(let i=t.constructor;i;i=Ct(i)){const s=this._classInputMap.get(i);if(s)for(const i in s.properties){const r=s.properties[i],n=t[i];if(Array.isArray(n)){if(r.arraySyncGroup&&r.arraySyncGroupFollower)continue;e[i]={displayName:i}}}}return e}deleteInput(t,e,i){const[s,r=-1]=i,n=this._getPropertyNodeInputRecord(e.constructor,s);if(!n)return;const o=e[s];if(Array.isArray(o)&&!(r<0||r>=o.length)){{const{arraySyncGroup:i}=n;if(i)return void this._deleteInputInArraySyncGroup(t,e,i,o.length,r)}oJ(t,e,i)}}insertInput(t,e,i){const s=i,r=this._getPropertyNodeInputRecord(e.constructor,s);if(!r)return;const n=e[s];if(!Array.isArray(n))return;const o=n.length;{const{arraySyncGroup:i}=r;if(i)return void this._insertInputInArraySyncGroup(t,e,i,n.length,o)}nJ(t,e,[s,o],aJ(r.type))}_getPropertyNodeInputRecord(t,e){if(!t)return;const i=this._classInputMap.get(t);if(i){const t=i.properties[e];if(t)return t}return this._getPropertyNodeInputRecord(Ct(t),e)}_insertInputInArraySyncGroup(t,e,i,s,r){for(let n=0;n<i.members.length;++n){const o=i.members[n],a=this._getPropertyNodeInputRecord(e.constructor,o),h=e[o];Array.isArray(h)&&h.length===s&&nJ(t,e,[o,r],aJ(a.type))}}_deleteInputInArraySyncGroup(t,e,i,s,r){for(let n=0;n<i.members.length;++n){const o=i.members[n];this._getPropertyNodeInputRecord(e.constructor,o);const a=e[o];Array.isArray(a)&&a.length===s&&oJ(t,e,[o,r])}}};var lJ;se({NO:0,LOCAL:1,COMPONENT:2});let cJ=oa(`${uY}PoseNode`)(lJ=class extends tJ{constructor(){super(...arguments),this._dependencyEvaluation=void 0}update(t){var e;null===(e=this._dependencyEvaluation)||void 0===e||e.evaluate(),this.doUpdate(t)}evaluate(t,e){const i=this.doEvaluate(t),s=i._poseTransformSpace;switch(e){default:case 0:break;case 1:1===s&&t._poseTransformsSpaceComponentToLocal(i),i._poseTransformSpace;break;case 2:0===s&&t._poseTransformsSpaceLocalToComponent(i),i._poseTransformSpace}return i}static evaluateDefaultPose(t,e){switch(e){default:case 0:case 1:return t.pushDefaultedPose();case 2:return t.pushDefaultedPoseInComponentSpace()}}_setDependencyEvaluation(t){this._dependencyEvaluation=t}_forceEvaluateEvaluation(){var t;null===(t=this._dependencyEvaluation)||void 0===t||t.evaluate()}})||lJ;class uJ extends tJ{constructor(t){super(),this._outputTypes=[],this._outputTypes=t}get outputCount(){return this._outputTypes.length}getOutputType(t){return this._outputTypes[t]}link(t){}}function dJ(t){return(e,i)=>{const s=e.constructor;5!==t.type||It(s,cJ)?It(s,cJ)||It(s,uJ)?pJ(t)(e,i):B("@input can be only applied to fields of subclasses of PoseNode or PureValueNode."):B("@input specifying pose input can be only applied to fields of subclasses of PoseNode.")}}function pJ(t){return(e,i)=>{if("string"!=typeof i)return void B("@input can be only applied to string-named fields.");const s=e.constructor;hJ.setPropertyNodeInputRecord(s,i,t),ga(e,i).__internalFlags|=3}}var _J,gJ,fJ,mJ,yJ,vJ;let bJ=(_J=oa(`${uY}PoseGraphOutputNode`),gJ=rJ({themeColor:"#CD3A58",inline:!0}),fJ=pJ({type:5}),_J(mJ=gJ((yJ=class extends tJ{constructor(){super(...arguments),i(this,"pose",vJ,this)}},vJ=s(yJ.prototype,"pose",[va,fJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mJ=yJ))||mJ)||mJ);var wJ,SJ,xJ,TJ,CJ,IJ;let EJ=oa(`${uY}PoseGraph`)((SJ=class extends ja{constructor(){super(),this._outputNode=xJ&&xJ(),this._nodes=TJ&&TJ(),this._shells=CJ&&CJ(),this._shellMap=IJ&&IJ(),this.addNode(this._outputNode)}get outputNode(){return this._outputNode}__callOnAfterDeserializeRecursive(){this._nodes.length,this._shells.length;for(let e=0;e<this._nodes.length;++e){var t;const i=this._nodes[e],s=this._shells[e];this._shellMap.set(i,s),null===(t=i.__callOnAfterDeserializeRecursive)||void 0===t||t.call(i)}}nodes(){return this._nodes.values()}addNode(t){if(this._shellMap.has(t))throw new ZZ(t);const e=new YZ;return this._shells.push(e),this._nodes.push(t),this._shellMap.set(t,e),t}removeNode(t){if(t===this._outputNode)return void B("Can not remove the output node.");const e=this._nodes.indexOf(t);if(!(e<0)){this._shellMap.has(t);for(const e of this._shells)e.deleteBindingTo(t);Gt(this._shells,e),Gt(this._nodes,e),this._shellMap.delete(t)}}getShell(t){return this._shellMap.get(t)}},xJ=Qo(SJ.prototype,"_outputNode",[va],(function(){return new bJ})),TJ=Qo(SJ.prototype,"_nodes",[va],(function(){return[]})),CJ=Qo(SJ.prototype,"_shells",[va],(function(){return[]})),IJ=Qo(SJ.prototype,"_shellMap",[va],(function(){return new Map})),wJ=SJ))||wJ;var DJ,AJ,MJ,PJ,BJ,RJ,OJ,LJ,FJ,zJ,kJ,NJ,UJ,VJ,HJ,GJ,WJ,jJ,$J,qJ,XJ,YJ,QJ,KJ,ZJ,JJ,t0,e0,i0,s0,r0,n0,o0,a0,h0,l0,c0,u0,d0,p0,_0,g0,f0,m0,y0,v0,b0,w0,S0,x0,T0,C0,I0,E0;let D0=oa(`${uY}Transition`)((AJ=class extends ja{constructor(t,e,i){super(),this.from=MJ&&MJ(),this.to=PJ&&PJ(),this.conditions=BJ&&BJ(),this[CK]=void 0,this.from=t,this.to=e,i&&(this.conditions=i)}copyTo(t){t.conditions=this.conditions.map((t=>t.clone()))}},MJ=Qo(AJ.prototype,"from",[va],null),PJ=Qo(AJ.prototype,"to",[va],null),BJ=Qo(AJ.prototype,"conditions",[va],(function(){return[]})),DJ=AJ))||DJ,A0=oa(`${uY}DurationalTransition`)((OJ=class extends D0{constructor(){super(...arguments),this.destinationStart=LJ&&LJ(),this.relativeDestinationStart=FJ&&FJ(),this.startEventBinding=zJ&&zJ(),this.endEventBinding=kJ&&kJ(),this[CK]=void 0}copyTo(t){super.copyTo(t),t.destinationStart=this.destinationStart,t.relativeDestinationStart=this.relativeDestinationStart,this.startEventBinding.copyTo(t.startEventBinding),this.endEventBinding.copyTo(t.endEventBinding)}},LJ=Qo(OJ.prototype,"destinationStart",[va],(function(){return 0})),FJ=Qo(OJ.prototype,"relativeDestinationStart",[va],(function(){return!1})),zJ=Qo(OJ.prototype,"startEventBinding",[va],(function(){return new IZ})),kJ=Qo(OJ.prototype,"endEventBinding",[va],(function(){return new IZ})),RJ=OJ))||RJ,M0=oa(`${uY}AnimationTransition`)((UJ=class extends A0{constructor(){super(...arguments),this.duration=VJ&&VJ(),this.relativeDuration=HJ&&HJ(),this.exitConditionEnabled=GJ&&GJ(),this._exitCondition=WJ&&WJ()}get exitCondition(){return this._exitCondition}set exitCondition(t){this._exitCondition=t}copyTo(t){super.copyTo(t),t.duration=this.duration,t.relativeDuration=this.relativeDuration,t.exitConditionEnabled=this.exitConditionEnabled,t.exitCondition=this.exitCondition}},VJ=Qo(UJ.prototype,"duration",[va],(function(){return.3})),HJ=Qo(UJ.prototype,"relativeDuration",[va],(function(){return!1})),GJ=Qo(UJ.prototype,"exitConditionEnabled",[va],(function(){return!0})),WJ=Qo(UJ.prototype,"_exitCondition",[va],(function(){return 1})),NJ=UJ))||NJ;function P0(t){return t instanceof M0}let B0=oa(`${uY}EmptyState`)(jJ=class extends bZ{})||jJ,R0=oa(`${uY}EmptyStateTransition`)((qJ=class extends A0{constructor(){super(...arguments),this.duration=XJ&&XJ()}copyTo(t){super.copyTo(t),t.duration=this.duration}},XJ=Qo(qJ.prototype,"duration",[va],(function(){return.3})),$J=qJ))||$J,O0=oa(`${uY}ProceduralPoseState`)((QJ=class extends bZ{constructor(){super(...arguments),this.graph=KJ&&KJ(),this.transitionInEventBinding=ZJ&&ZJ(),this.transitionOutEventBinding=JJ&&JJ()}__callOnAfterDeserializeRecursive(){this.graph.__callOnAfterDeserializeRecursive()}copyTo(t){return super.copyTo(t),this.transitionInEventBinding.copyTo(t.transitionInEventBinding),this.transitionOutEventBinding.copyTo(t.transitionOutEventBinding),this}},KJ=Qo(QJ.prototype,"graph",[va],(function(){return new EJ})),ZJ=Qo(QJ.prototype,"transitionInEventBinding",[va],(function(){return new IZ})),JJ=Qo(QJ.prototype,"transitionOutEventBinding",[va],(function(){return new IZ})),YJ=QJ))||YJ;const L0=UZ(O0);let F0=oa(`${uY}ProceduralPoseTransition`)((e0=class extends A0{constructor(){super(...arguments),this.duration=i0&&i0()}copyTo(t){super.copyTo(t),t.duration=this.duration}},i0=Qo(e0.prototype,"duration",[va],(function(){return.3})),t0=e0))||t0;const z0=UZ(F0);let k0=oa("cc.animation.StateMachine")((r0=class t extends ja{__callOnAfterDeserializeRecursive(){this[FZ]();const t=this._states.length;for(let e=0;e<t;++e){const t=this._states[e];t instanceof N0?t.stateMachine.__callOnAfterDeserializeRecursive():(t instanceof O0||t instanceof LZ)&&t.__callOnAfterDeserializeRecursive()}}constructor(t){super(),this._states=n0&&n0(),this._transitions=o0&&o0(),this._entryState=a0&&a0(),this._exitState=h0&&h0(),this._anyState=l0&&l0(),this._allowEmptyStates=!0,this._allowEmptyStates=null!=t&&t,this._entryState=this._addState(new bZ),this._entryState.name="Entry",this._exitState=this._addState(new bZ),this._exitState.name="Exit",this._anyState=this._addState(new bZ),this._anyState.name="Any"}[FZ](){this._states.forEach((()=>{})),this._transitions.forEach((t=>{t.from[fZ].push(t),t.to[mZ].push(t)}))}get allowEmptyStates(){return this._allowEmptyStates}get entryState(){return this._entryState}get exitState(){return this._exitState}get anyState(){return this._anyState}states(){return this._states}transitions(){return this._transitions}getTransitionsBetween(t,e){return IK(t),IK(e),t[fZ].filter((t=>t.to===e))}getOutgoings(t){return IK(t),t[fZ]}getIncomings(t){return IK(t),t[mZ]}addMotion(){return this._addState(new LZ)}addSubStateMachine(){return this._addState(new N0(this._allowEmptyStates))}addEmpty(){if(!this._allowEmptyStates)throw new Error("Empty states are now allowed in this state machine.");return this._addState(new B0)}addProceduralPoseState(){return this._addState(new O0)}remove(t){IK(t),t!==this.entryState&&t!==this.exitState&&t!==this.anyState&&(this.eraseTransitionsIncludes(t),jt(this._states,t))}connect(t,e,i){if(IK(t),IK(e),e===this.entryState)throw new KK("to-entry");if(e===this.anyState)throw new KK("to-any");if(t===this.exitState)throw new KK("from-exit");const s=t instanceof LZ||t===this._anyState?new M0(t,e,i):t instanceof B0?new R0(t,e,i):t instanceof O0?new F0(t,e,i):new D0(t,e,i);return this._transitions.push(s),t[fZ].push(s),e[mZ].push(s),s}disconnect(t,e){IK(t),IK(e);const i=t[fZ],s=e[mZ],r=this._transitions,n=i.filter((t=>t.to===e)),o=n.length;for(let t=0;t<o;++t){const e=n[t];jt(i,e),jt(r,e),qt(s,(t=>t===e))}}removeTransition(t){jt(this._transitions,t),qt(t.from[fZ],(e=>e===t)),qt(t.to[mZ],(e=>e===t))}eraseOutgoings(t){IK(t);const e=t[fZ];for(let t=0;t<e.length;++t){const i=e[t],s=i.to;jt(this._transitions,i),qt(s[mZ],(t=>t===i))}e.length=0}eraseIncomings(t){IK(t);const e=t[mZ];for(let t=0;t<e.length;++t){const i=e[t],s=i.from;jt(this._transitions,i),qt(s[fZ],(t=>t===i))}e.length=0}eraseTransitionsIncludes(t){this.eraseIncomings(t),this.eraseOutgoings(t)}adjustTransitionPriority(t,e){const{from:i}=t;if(0===e)return;const s=i[fZ],r=s.indexOf(t),n=fi(r+e,0,s.length-1);{const{_transitions:e}=this;let i=e.indexOf(t);if(n>r)for(let t=r+1;t<=n;++t){const r=s[t],n=e.indexOf(r);e[i]=r,i=n}else if(r>n)for(let t=r-1;t>=n;--t){const r=s[t],n=e.indexOf(r);e[i]=r,i=n}e[i]=t}_u(s,r,n)}copyTo(t){const e=t._states.filter((e=>{switch(e){case t._entryState:case t._exitState:case t._anyState:return!0;default:return!1}}));for(const i of e)t.remove(i);const i=new Map;for(const e of this._states)switch(e){case this._entryState:i.set(e,t._entryState);break;case this._exitState:i.set(e,t._exitState);break;case this._anyState:i.set(e,t._anyState);break;default:if(e instanceof LZ||e instanceof N0||e instanceof B0||e instanceof O0){if(e instanceof B0&&!t._allowEmptyStates)continue;const s=rZ(e);t._addState(s),i.set(e,s)}}for(const e of this._transitions){if(!t._allowEmptyStates&&(e.from instanceof B0||e.to instanceof B0))continue;const s=i.get(e.from),r=i.get(e.to),n=t.connect(s,r);n.conditions=e.conditions.map((t=>t.clone())),e.copyTo(n)}}clone(){const e=new t(this._allowEmptyStates);return this.copyTo(e),e}_addState(t){return this._states.push(t),t}},n0=Qo(r0.prototype,"_states",[va],(function(){return[]})),o0=Qo(r0.prototype,"_transitions",[va],(function(){return[]})),a0=Qo(r0.prototype,"_entryState",[va],null),h0=Qo(r0.prototype,"_exitState",[va],null),l0=Qo(r0.prototype,"_anyState",[va],null),s0=r0))||s0,N0=oa("cc.animation.SubStateMachine")((u0=class extends wZ{constructor(t){super(),this._stateMachine=d0&&d0(),this._stateMachine=new k0(t)}get stateMachine(){return this._stateMachine}copyTo(t){super.copyTo(t),this._stateMachine.copyTo(t._stateMachine)}},d0=Qo(u0.prototype,"_stateMachine",[va],null),c0=u0))||c0,U0=oa(`${uY}PoseGraphStash`)((_0=class extends ja{constructor(){super(...arguments),this.graph=g0&&g0()}},g0=Qo(_0.prototype,"graph",[va],(function(){return new EJ})),p0=_0))||p0,V0=oa("cc.animation.Layer")((m0=class{__callOnAfterDeserializeRecursive(){this.stateMachine._allowEmptyStates=!0,this.stateMachine.__callOnAfterDeserializeRecursive();for(const t in this._stashes)this._stashes[t].graph.__callOnAfterDeserializeRecursive()}stashes(){return Object.entries(this._stashes)}getStash(t){return this._stashes[t]}addStash(t){return this._stashes[t]=new U0}removeStash(t){delete this._stashes[t]}renameStash(t,e){this._stashes=NZ(this._stashes,t,e)}constructor(){this[CK]=void 0,this._stateMachine=y0&&y0(),this.name=v0&&v0(),this.weight=b0&&b0(),this.mask=w0&&w0(),this.additive=S0&&S0(),this._stashes=x0&&x0(),this._stateMachine=new k0(!0)}get stateMachine(){return this._stateMachine}},y0=Qo(m0.prototype,"_stateMachine",[va],null),v0=Qo(m0.prototype,"name",[va],(function(){return""})),b0=Qo(m0.prototype,"weight",[va],(function(){return 1})),w0=Qo(m0.prototype,"mask",[va],(function(){return null})),S0=Qo(m0.prototype,"additive",[va],(function(){return!1})),x0=Qo(m0.prototype,"_stashes",[va],(function(){return{}})),f0=m0))||f0,H0=oa("cc.animation.AnimationGraph")((C0=class extends kZ{constructor(){super(),this._layers=I0&&I0(),this._variables=E0&&E0()}onLoaded(){const{_layers:t}=this,e=t.length;for(let i=0;i<e;++i)t[i].__callOnAfterDeserializeRecursive()}get layers(){return this._layers}get variables(){return Object.entries(this._variables)}addLayer(){const t=new V0;return this._layers.push(t),t}removeLayer(t){Gt(this._layers,t)}moveLayer(t,e){_u(this._layers,t,e)}addVariable(t,e,i){const s=QK(e,i);return this._variables[t]=s,s}removeVariable(t){delete this._variables[t]}getVariable(t){return this._variables[t]}renameVariable(t,e){this._variables=NZ(this._variables,t,e)}},I0=Qo(C0.prototype,"_layers",[va],(function(){return[]})),E0=Qo(C0.prototype,"_variables",[va],(function(){return{}})),T0=C0))||T0;const G0=Symbol("[[createEval]]");var W0;let j0=oa(`${uY}MotionBase`)(W0=class extends ja{__callOnAfterDeserializeRecursive(){}})||W0;class $0{constructor(t){let e,i;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;let s=!0;for(let r=1,n=t.length;r<n;r++)if(e=t[r]-t[r-1],1===r)i=e;else if(Math.abs(e-i)>1e-6){s=!1;break}this._findRatio=s?Q0:Go}sample(t){return this._findRatio(this.ratios,t)}}t("RatioSampler",$0),h.RatioSampler=$0;class q0{static Bezier(t){return t}constructor(t,e){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=e,this._values=t.values;const i=t=>"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?q0.Linear:q0.Bezier(t):q0.Linear;if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(const e of Object.keys(t.easingMethods))this.types[e]=i(t.easingMethods[e])}else this.type=null;const s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=K0(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}hasLerp(){return!!this._lerp}valueAt(t){if(void 0===this._array){const e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(let e=0;e<this._array.length;++e)this._array[e]=this._values[this._array.length*t+e];return this._array}valueBetween(t,e,i,s,r){if(this._lerp){const n=this.types?this.types[e]:this.type,o=r-i;let a=(t-i)/o;if(n&&(a=Y0(a,n)),void 0===this._array){const t=this._values[e],i=this._values[s];return this._lerp(t,i,a,o*this._duration)}for(let t=0;t<this._array.length;++t){const i=this._values[this._array.length*e+t],r=this._values[this._array.length*s+t];this._array[t]=this._lerp(i,r,a,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(let t=0;t<this._array.length;++t)this._array[t]=this._values[this._array.length*e+t];return this._array}empty(){return 0===this._values.length}constant(){return 1===this._values.length}}function X0(t,e,i){let s=e.sample(i);if(s<0)if(s=~s,s<=0)s=0;else{if(!(s>=e.ratios.length))return t.valueBetween(i,s-1,e.ratios[s-1],s,e.ratios[s]);s=e.ratios.length-1}return t.valueAt(s)}function Y0(t,e){if("string"==typeof e){const i=Kh[e];i?t=i(t):j(3906,e)}else Array.isArray(e)&&(t=Hl(e,t));return t}function Q0(t,e){const i=t.length-1;if(0===i)return 0;const s=t[0];if(e<s)return 0;const r=t[i];if(e>r)return i;const n=(e=(e-s)/(r-s))/(1/i),o=0|n,a=1e-6;return n-o<a?o:o+1-n<a?o+1:~(o+1)}t("AnimCurve",q0),q0.Linear=null,h.AnimCurve=q0,t("EventInfo",class{constructor(){this.events=[]}add(t,e){this.events.push({func:t||"",params:e||[]})}}),h.sampleAnimationCurve=X0;const K0=(()=>{function t(t){const e=new t;return(i,s,r)=>(t.lerp(e,i,s,r),e)}function e(t,e,i,s){return t.lerp(e,i,s)}function i(){const t=new ys;return(e,i,s)=>ys.slerp(t,e,i,s)}return s=>{if(null!==s){if("number"==typeof s)return yi;if("object"==typeof s&&s.constructor){if(s instanceof ys)return i();if(s instanceof re)return t(s.constructor);if(s.constructor===Number)return yi;if("function"==typeof s.lerp)return e}}}})();var Z0,J0,t1,e1,i1,s1;let r1=oa(`${uY}UntypedTrackChannel`)((J0=class extends pQ{constructor(){super(new nl),this.property=t1&&t1()}},t1=Qo(J0.prototype,"property",[va],(function(){return""})),Z0=J0))||Z0,n1=oa(`${uY}UntypedTrack`)((i1=class extends dQ{constructor(){super(...arguments),this._channels=s1&&s1()}channels(){return this._channels}[dY](){throw new Error("UntypedTrack should be handled specially. Please file an issue.")}createLegacyEval(t){const e=t=>{var e;return null===(e=this._channels.find((e=>e.property===t)))||void 0===e?void 0:e.curve};switch(!0){default:throw new Error(Y(3931));case t instanceof Qs:return new nK(e("x"),e("y"));case t instanceof Ki:return new oK(e("x"),e("y"),e("z"));case t instanceof cr:return new aK(e("x"),e("y"),e("z"),e("w"));case t instanceof _r:return new fK(e("r"),e("g"),e("b"),e("a"));case t instanceof br:return new SK(e("width"),e("height"))}}addChannel(t){const e=new r1;return e.property=t,this._channels.push(e),e}upgrade(t){const e=(t,e)=>{const i=this.channels().find((e=>e.property===t));i&&(e.name=i.name,e.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=t(this.path,this.proxy);switch(i){default:case"size":break;case"vec2":case"vec3":case"vec4":{const t=new rK;t.path=this.path,t.proxy=this.proxy,t.componentsCount="vec2"===i?2:"vec3"===i?3:4;const[s,r,n,o]=t.channels();switch(i){case"vec4":e("w",o);case"vec3":e("z",n);default:e("x",s),e("y",r)}return t}case"color":{const t=new gK,[i,s,r,n]=t.channels();return e("r",i),e("g",s),e("b",r),e("a",n),e("x",i),e("y",s),e("z",r),e("w",n),t}}return null}},s1=Qo(i1.prototype,"_channels",[va],(function(){return[]})),e1=i1))||e1;class o1{constructor(t){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}get keys(){return this._keys}set keys(t){this._keys=t}get curves(){return this._curves}set curves(t){this._curves=t,delete this._runtimeCurves}get commonTargets(){return this._commonTargets}set commonTargets(t){this._commonTargets=t}get data(){return this._data}getPropertyCurves(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}toTracks(){const t=[],{keys:e,curves:i,commonTargets:s}=this,r=(t,e,i)=>{const s=new lQ;for(const t of e)"string"==typeof t?s.toProperty(t):"number"==typeof t?s.toElement(t):t instanceof VY?s.toHierarchy(t.path):t instanceof HY?s.toComponent(t.component):s.toCustomized(t);t.path=s,t.proxy=i},n=s.map((e=>{const i=new n1;return r(i,e.modifiers,e.valueAdapter),t.push(i),i}));for(const s of i){var o;const i=s.data,a=i.values;if(0===a.length)continue;const h=i.keys<0?[0]:e[i.keys],l=a[0],c=null===(o=i.interpolate)||void 0===o||o;i._arrayLength;const u=new h1(i,h.length),d=t=>{r(t,s.modifiers,s.valueAdapter)};let p;if("number"==typeof s.commonTarget){if(!a.every((t=>"number"==typeof t))){G(3932);continue}if(s.valueAdapter||1!==s.modifiers.length||"string"!=typeof s.modifiers[0]){G(3933);continue}const t=s.modifiers[0],e=n[s.commonTarget],{curve:i}=e.addChannel(t);p=i}const _=()=>{if("number"==typeof l){if(!a.every((t=>"number"==typeof t)))return void G(3934);let e;if(p)e=p;else{const i=new KQ;d(i),t.push(i),e=i.channel.curve}const i=c?0:1;return e.assignSorted(h,a.map((t=>({value:t,interpolationMode:i})))),void u.convert(e)}if("object"==typeof l)switch(!0){default:break;case a1(a,Qs):case a1(a,Ki):case a1(a,cr):{const e=l instanceof Qs?2:l instanceof Ki?3:4,i=new rK;d(i),i.componentsCount=e;const[{curve:s},{curve:r},{curve:n},{curve:o}]=i.channels(),p=c?0:1,_=t=>({value:t,interpolationMode:p});switch(e){case 4:o.assignSorted(h,a.map((t=>_(t.w)))),u.convert(o);case 3:n.assignSorted(h,a.map((t=>_(t.z)))),u.convert(n);default:s.assignSorted(h,a.map((t=>_(t.x)))),u.convert(s),r.assignSorted(h,a.map((t=>_(t.y)))),u.convert(r)}return void t.push(i)}case a1(a,ys):{const e=new lK;d(e);const i=c?0:1;return e.channel.curve.assignSorted(h,a.map((t=>({value:ys.clone(t),interpolationMode:i})))),u.convertQuatCurve(e.channel.curve),void t.push(e)}case a1(a,_r):{const e=new gK;d(e);const[{curve:i},{curve:s},{curve:r},{curve:n}]=e.channels(),o=c?0:1,l=t=>({value:t,interpolationMode:o});return i.assignSorted(h,a.map((t=>l(t.r)))),u.convert(i),s.assignSorted(h,a.map((t=>l(t.g)))),u.convert(s),r.assignSorted(h,a.map((t=>l(t.b)))),u.convert(r),n.assignSorted(h,a.map((t=>l(t.a)))),u.convert(n),void t.push(e)}case a1(a,br):{const e=new wK;d(e);const[{curve:i},{curve:s}]=e.channels(),r=c?0:1,n=t=>({value:t,interpolationMode:r});return i.assignSorted(h,a.map((t=>n(t.width)))),u.convert(i),s.assignSorted(h,a.map((t=>n(t.height)))),u.convert(s),void t.push(e)}case a1(a,YQ):{u.nil;const e=new KQ;d(e);const i=c?2:1;return e.channel.curve.assignSorted(h,a.map((t=>({value:t.dataPoint,leftTangent:t.inTangent,rightTangent:t.outTangent,interpolationMode:i})))),void t.push(e)}case a1(a,jQ):case a1(a,$Q):case a1(a,qQ):{u.nil;const e=l instanceof jQ?2:l instanceof $Q?3:4,i=new rK;d(i),i.componentsCount=e;const[s,r,n,o]=i.channels(),p=c?0:1,_=(t,e,i)=>({value:t,leftTangent:e,rightTangent:i,interpolationMode:p});switch(e){case 4:o.curve.assignSorted(h,a.map((t=>_(t.dataPoint.w,t.inTangent.w,t.outTangent.w))));case 3:n.curve.assignSorted(h,a.map((t=>_(t.dataPoint.z,t.inTangent.z,t.outTangent.z))));default:s.curve.assignSorted(h,a.map((t=>_(t.dataPoint.y,t.inTangent.y,t.outTangent.y)))),r.curve.assignSorted(h,a.map((t=>_(t.dataPoint.x,t.inTangent.x,t.outTangent.x))))}return void t.push(i)}case a.every((t=>t instanceof XQ)):G(3935)}const e=new TK;d(e),e.channel.curve.assignSorted(h,a),t.push(e)};_()}return t}_createPropertyCurves(){this._ratioSamplers=this._keys.map((t=>new $0(t.map((t=>t/this._duration))))),this._runtimeCurves=this._curves.map((t=>({curve:new q0(t.data,this._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:this._ratioSamplers[t.data.keys],commonTarget:t.commonTarget})))}}function a1(t,e){return t.every((t=>t instanceof e))}class h1{constructor(t,e){this._easingMethods=void 0;const{easingMethods:i}=t;Array.isArray(i)?0===i.length&&0!==e?this._easingMethods=new Array(e).fill(null):this._easingMethods=i:this._easingMethods=void 0===i?new Array(e).fill(t.easingMethod):Array.from({length:e},((t,e)=>{var s;return null!==(s=i[e])&&void 0!==s?s:null}))}get nil(){return!this._easingMethods||this._easingMethods.every((t=>null==t))}convert(t){const{_easingMethods:e}=this;if(!e)return;const i=t.keyFramesCount;if(t.keyFramesCount<2)return;Array.isArray(e)&&e.length;const s=i-1;for(let i=0;i<s;++i){const s=e[i];s&&(Array.isArray(s)?d1(s,t.getKeyframeTime(i),t.getKeyframeValue(i),t.getKeyframeTime(i+1),t.getKeyframeValue(i+1)):l1(s,t,i))}}convertQuatCurve(t){const{_easingMethods:e}=this;if(!e)return;const i=t.keyFramesCount;if(t.keyFramesCount<2)return;Array.isArray(e)&&e.length;const s=i-1;for(let i=0;i<s;++i){const s=e[i];s&&(Array.isArray(s)?t.getKeyframeValue(i).easingMethod=s.slice():c1(s,t,i))}}}function l1(t,e,i){e.keyFramesCount;const s=e.getKeyframeValue(i),r=u1[t];1===r?s.interpolationMode=1:(s.interpolationMode=0,s.easingMethod=r)}function c1(t,e,i){e.keyFramesCount;const s=e.getKeyframeValue(i),r=u1[t];s.easingMethod=r}const u1={constant:1,linear:0,quadIn:2,quadOut:3,quadInOut:4,quadOutIn:5,cubicIn:6,cubicOut:7,cubicInOut:8,cubicOutIn:9,quartIn:10,quartOut:11,quartInOut:12,quartOutIn:13,quintIn:14,quintOut:15,quintInOut:16,quintOutIn:17,sineIn:18,sineOut:19,sineInOut:20,sineOutIn:21,expoIn:22,expoOut:23,expoInOut:24,expoOutIn:25,circIn:26,circOut:27,circInOut:28,circOutIn:29,elasticIn:30,elasticOut:31,elasticInOut:32,elasticOutIn:33,backIn:34,backOut:35,backInOut:36,backOutIn:37,bounceIn:38,bounceOut:39,bounceInOut:40,bounceOutIn:41,smooth:42,fade:43};function d1(t,e,i,s,r){const[n,o,a,h]=t,{value:l}=i,{value:c}=r,u=3*(s-e),d=3*(c-l),p=n*u,_=o*d,g=(1-a)*u,f=(1-h)*d,m=1/3,y=_/p,v=Math.sqrt(p*p+_*_)*m,b=f/g,w=Math.sqrt(g*g+f*f)*m;var S;i.interpolationMode=2,i.tangentWeightMode=0===(S=i.tangentWeightMode)?2:1===S?3:S,i.rightTangent=y,i.rightTangentWeight=v,r.tangentWeightMode=p1(r.tangentWeightMode),r.leftTangent=b,r.leftTangentWeight=w}function p1(t){return 0===t?1:2===t?3:t}var _1,g1,f1,m1,y1,v1,b1,w1,S1,x1,T1,C1,I1,E1,D1,A1,M1,P1,B1,R1,O1,L1,F1,z1;const{ccclass:k1,serializable:N1}=Ja;function U1(){throw new Error("split() only valid in Editor.")}k1(`${uY}ExoticAnimation`)((_1=class{constructor(){this._nodeAnimations=g1&&g1()}createEvaluator(t){return new X1(this._nodeAnimations,t)}createEvaluatorForAnimationGraph(t){return new K1(this._nodeAnimations,t)}addNodeAnimation(t){const e=new V1(t);return this._nodeAnimations.push(e),e}collectAnimatedJoints(){return Array.from(new Set(this._nodeAnimations.map((t=>{let{path:e}=t;return e}))))}split(t,e){return U1()}toHashString(){return this._nodeAnimations.map((t=>t.toHashString())).join("\n")}},g1=Qo(_1.prototype,"_nodeAnimations",[N1],(function(){return[]})),_1));let V1=k1(`${uY}ExoticNodeAnimation`)((m1=class{constructor(t){this._path=y1&&y1(),this._position=v1&&v1(),this._rotation=b1&&b1(),this._scale=w1&&w1(),this._path=t}createPosition(t,e){this._position=new q1(t,new j1(e))}createRotation(t,e){this._rotation=new q1(t,new $1(e))}createScale(t,e){this._scale=new q1(t,new j1(e))}createEvaluator(t){return new Y1(this._path,this._position,this._rotation,this._scale,t)}createEvaluatorForAnimationGraph(t){const e=t.bindTransform(this._path);return e?new Z1(e,this._position,this._rotation,this._scale):null}split(t,e,i){return U1()}get path(){return this._path}toHashString(){var t,e,i,s,r,n;return`${this._path}\n${null!==(t=null===(e=this._position)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:""}${null!==(i=null===(s=this._scale)||void 0===s?void 0:s.toHashString())&&void 0!==i?i:""}${null!==(r=null===(n=this._rotation)||void 0===n?void 0:n.toHashString())&&void 0!==r?r:""}`}},y1=Qo(m1.prototype,"_path",[N1],(function(){return""})),v1=Qo(m1.prototype,"_position",[N1],(function(){return null})),b1=Qo(m1.prototype,"_rotation",[N1],(function(){return null})),w1=Qo(m1.prototype,"_scale",[N1],(function(){return null})),f1=m1))||f1;function H1(t){return t.toPrecision(2)}function G1(t){return t.map((t=>Number.parseFloat(H1(t)))).join(" ")}let W1=k1(`${uY}ExoticVectorLikeTrackValues`)((x1=class{constructor(t){this._values=T1&&T1(),this._isQuantized=C1&&C1(),this._values=t}get precision(){return this._isQuantized?this._values.originalPrecision:e2(this._values)}quantize(t){this._isQuantized,this._values=s2(this._values,t),this._isQuantized=!0}toHashString(){const{_isQuantized:t,_values:e}=this;return`${t} ${t?e.toHashString():G1(e)}`}},T1=Qo(x1.prototype,"_values",[N1],null),C1=Qo(x1.prototype,"_isQuantized",[N1],(function(){return!1})),S1=x1))||S1,j1=k1(`${uY}ExoticVec3TrackValues`)(I1=class t extends W1{static imitate(e,i){const s=new t(e);return i._isQuantized&&s.quantize(i._values.quantizationType),s}get(t,e){const{_values:i,_isQuantized:s}=this;s?o2(i,t,e):Ki.fromArray(e,i,3*t)}lerp(t,e,i,s,r,n){const{_values:o,_isQuantized:a}=this;a?(o2(o,t,s),o2(o,e,r)):(Ki.fromArray(s,o,3*t),Ki.fromArray(r,o,3*e)),Ki.lerp(n,s,r,i)}})||I1,$1=k1(`${uY}ExoticQuatTrackValues`)(E1=class t extends W1{static imitate(e,i){const s=new t(e);return i._isQuantized&&s.quantize(i._values.quantizationType),s}get(t,e){const{_values:i,_isQuantized:s}=this;s?a2(i,t,e):ys.fromArray(e,i,4*t)}lerp(t,e,i,s,r,n){const{_values:o,_isQuantized:a}=this;a?(a2(o,t,s),a2(o,e,r)):(ys.fromArray(s,o,4*t),ys.fromArray(r,o,4*e)),ys.slerp(n,s,r,i)}})||E1,q1=k1(`${uY}ExoticTrack`)((A1=class{constructor(t,e){this.times=M1&&M1(),this.values=P1&&P1(),this.times=t,this.values=e}toHashString(){const{times:t,values:e}=this;return`times: ${G1(t)}; values: ${e.toHashString()}`}},M1=Qo(A1.prototype,"times",[N1],null),P1=Qo(A1.prototype,"values",[N1],null),D1=A1))||D1;class X1{constructor(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((t=>t.createEvaluator(e)))}evaluate(t){this._nodeEvaluations.forEach((e=>{e.evaluate(t)}))}}class Y1{constructor(t,e,i,s,r){this._position=null,this._rotation=null,this._scale=null,e&&(this._position=n2(e.times,e.values,Ki,t,"position",r)),i&&(this._rotation=n2(i.times,i.values,ys,t,"rotation",r)),s&&(this._scale=n2(s.times,s.values,Ki,t,"scale",r))}evaluate(t){if(this._position){const e=this._position.evaluator.evaluate(t);this._position.runtimeBinding.setValue(e)}if(this._rotation){const e=this._rotation.evaluator.evaluate(t);this._rotation.runtimeBinding.setValue(e)}if(this._scale){const e=this._scale.evaluator.evaluate(t);this._scale.runtimeBinding.setValue(e)}}}class Q1{constructor(t,e,i){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=e,this._prevValue=new i,this._nextValue=new i,this._resultValue=new i}evaluate(t){const{_times:e,_values:i,_resultValue:s}=this;if(0===e.length)return s;const r=J1(e,t,this._inputSampleResultCache);return r.just?i.get(r.index,s):i.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,s),s}}class K1{constructor(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((t=>t.createEvaluatorForAnimationGraph(e))).filter((t=>!!t))}destroy(){const{_nodeEvaluations:t}=this,e=t.length;for(let i=0;i<e;++i)t[i].destroy()}evaluate(t,e){const{_nodeEvaluations:i}=this,s=i.length;for(let r=0;r<s;++r)i[r].evaluate(t,e)}}class Z1{constructor(t,e,i,s){this._position=null,this._rotation=null,this._scale=null,this._transformHandle=void 0,this._transformHandle=t,e&&(this._position=new Q1(e.times,e.values,Ki)),i&&(this._rotation=new Q1(i.times,i.values,ys)),s&&(this._scale=new Q1(s.times,s.values,Ki))}destroy(){this._transformHandle.destroy()}evaluate(t,e){const{_transformHandle:{index:i},_position:s,_rotation:r,_scale:n}=this,{transforms:o}=e;if(s){const e=s.evaluate(t);o.setPosition(i,e)}if(r){const e=r.evaluate(t);o.setRotation(i,e)}if(n){const e=n.evaluate(t);o.setScale(i,e)}}}function J1(t,e,i){const s=t.length,r=t[0],n=t[s-1];if(e<r)i.just=!0,i.index=0;else if(e>n)i.just=!0,i.index=s-1;else{const s=Go(t,e);if(s>=0)i.just=!0,i.index=s;else{const r=~s,n=r-1,o=t[n],a=t[r],h=(e-t[n])/(a-o);i.just=!1,i.index=n,i.nextIndex=r,i.ratio=h}}return i}const t2={uint8:Uint8Array,uint16:Uint16Array};function e2(t){switch(t.BYTES_PER_ELEMENT){default:case 4:return 0;case 8:return 1}}let i2=k1(`${uY}QuantizedFloatArray`)((R1=class{get quantizationType(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}constructor(t,e,i,s){void 0===s&&(s=0),this.originalPrecision=O1&&O1(),this.min=L1&&L1(),this.extent=F1&&F1(),this.values=z1&&z1(),this.originalPrecision=t,this.values=e,this.extent=i,this.min=s}toHashString(){const{originalPrecision:t,min:e,extent:i,values:s}=this;return`${t} ${H1(e)} ${H1(i)} ${s.join(" ")}`}},O1=Qo(R1.prototype,"originalPrecision",[N1],null),L1=Qo(R1.prototype,"min",[N1],null),F1=Qo(R1.prototype,"extent",[N1],null),z1=Qo(R1.prototype,"values",[N1],null),B1=R1))||B1;function s2(t,e){const i=t2[e],s=1<<i.BYTES_PER_ELEMENT;let r=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;t.forEach((t=>{r=Math.min(t,r),n=Math.max(t,n)}));const o=n-r,a=i.from(t,(t=>(t-r)/o*s));return new i2(e2(t),a,o,r)}function r2(t,e){return t.values[e]/(1<<t.values.BYTES_PER_ELEMENT)*t.extent+t.min}function n2(t,e,i,s,r,n){const o=new cQ;o.path=(new lQ).toHierarchy(s).toProperty(r);const a=n(o);return a?{runtimeBinding:a,evaluator:new Q1(t,e,i)}:null}function o2(t,e,i){Ki.set(i,r2(t,3*e+0),r2(t,3*e+1),r2(t,3*e+2))}function a2(t,e,i){ys.set(i,r2(t,4*e+0),r2(t,4*e+1),r2(t,4*e+2),r2(t,4*e+3))}var h2,l2,c2,u2;let d2=oa(`${uY}AuxiliaryCurveEntry`)((l2=class{constructor(){this.name=c2&&c2(),this.curve=u2&&u2()}},c2=Qo(l2.prototype,"name",[va],(function(){return""})),u2=Qo(l2.prototype,"curve",[va],(function(){return new nl})),h2=l2))||h2;var p2,_2,g2,f2,m2,y2,v2,b2,w2,S2,x2,T2,C2,I2,E2,D2,A2,M2,P2;const B2=Symbol("SearchForRootBonePath"),R2=Symbol("ExoticAnimation"),O2=Symbol("[[EmbeddedPlayerCount]]"),L2=Symbol("[[GetEmbeddedPlayers]]"),F2=Symbol("[[AddEmbeddedPlayer]]"),z2=Symbol("[[RemoveEmbeddedPlayer]]"),k2=Symbol("[[ClearEmbeddedPlayers]]"),N2=Symbol("[[Additive Settings]]");let U2=t("AnimationClip",oa("cc.AnimationClip")((E2=class t extends F_{constructor(){super(...arguments),this.sample=g2&&g2(),this.speed=f2&&f2(),this.wrapMode=m2&&m2(),this.enableTrsBlending=y2&&y2(),this._duration=v2&&v2(),this._hash=b2&&b2(),this.frameRate=0,this._tracks=w2&&w2(),this._exoticAnimation=S2&&S2(),this._legacyData=void 0,this._legacyDataDirty=!1,this._events=x2&&x2(),this._embeddedPlayers=T2&&T2(),this._additiveSettings=C2&&C2(),this._auxiliaryCurveEntries=I2&&I2(),this._runtimeEvents={ratios:[],eventGroups:[]}}static createWithSpriteFrames(e,i){const s=new t;s.sample=i||s.sample,s.duration=e.length/s.sample;const r=1/s.sample,n=new TK;return n.path=(new lQ).toComponent("cc.Sprite").toProperty("spriteFrame"),n.channels()[0].curve.assignSorted(e.map(((t,e)=>[r*e,t]))),s.addTrack(n),s}get duration(){return this._duration}set duration(t){this._duration=t}get tracksCount(){return this._tracks.length}get tracks(){return this._tracks}get hash(){var t,e;if(this._hash)return this._hash;const i=`Exotic:${null!==(t=null===(e=this._exoticAnimation)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:""}`;return this._hash=du(i,666)}get events(){return this._events}set events(t){this._events=t;const e=[],i=[],s=this.events.sort(((t,e)=>t.frame-e.frame)),r=s.length;for(let t=0;t<r;++t){const r=s[t],n=r.frame/this._duration;let o=e.findIndex((t=>t===n));o<0&&(o=e.length,e.push(n),i.push({events:[]})),i[o].events.push({functionName:r.func,parameters:r.params})}this._runtimeEvents={ratios:e,eventGroups:i}}get[R2](){return this._exoticAnimation}set[R2](t){this._exoticAnimation=t}get isAdditive_experimental(){return this._additiveSettings.enabled}get[N2](){return this._additiveSettings}onLoaded(){this.frameRate=this.sample,this.events=this._events}range(){const t={min:1/0,max:-1/0},{_tracks:e}=this,i=e.length;for(let s=0;s<i;++s){const i=e[s].range();t.min=Math.min(t.min,i.min),t.max=Math.max(t.max,i.max)}return t}getTrack(t){return this._tracks[t]}addTrack(t){const e=this._tracks.length;return this._tracks.push(t),e}removeTrack(t){this._tracks.splice(t,1)}clearTracks(){this._tracks.length=0}containsAnyEvent(){return 0!==this._events.length}createEventEvaluator(t){return new K2(t,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)}containsAnyEmbeddedPlayer(){return 0!==this._embeddedPlayers.length}createEmbeddedPlayerEvaluator(t){return new G2(this._embeddedPlayers,t)}createEvaluator(t){const{target:e}=t;return this._createEvalWithBinder(e,(i=>{if(t.mask&&i.isMaskedOff(t.mask))return;const s=i.createRuntimeBinding(e,this.enableTrsBlending?t.pose:void 0,!1);return null!=s?s:void 0}),t.rootMotion)}destroy(){var t;const e=null===(t=h.director.root)||void 0===t?void 0:t.dataPoolManager;return e&&e.releaseAnimationClip(this),T$.destroy(this),super.destroy()}[x$](t,e,i){const s=1/e,r=this._collectAnimatedJoints(),n=r.length,o={};for(let t=0;t<n;++t)o[r[t]]={transforms:Array.from({length:i},(()=>new Rs))};const a=r.reduce(((t,e)=>(t[e]=new $2,t)),{});for(const t in a){const e=a[t],i=t.lastIndexOf("/");if(i>=0){const s=t.substring(0,i),r=a[s];r&&(e.parent=r)}}const h=this._createEvalWithBinder(void 0,(t=>{const e=t.parseTrsPath();if(!e)return;const i=a[e.node];return i?Q2(i,e.property):void 0}),void 0);for(let e=0;e<i;++e){const i=t+s*e;h.evaluate(i);for(let t=0;t<n;++t){const i=r[t];Rs.copy(o[i].transforms[e],a[i].globalTransform)}for(let t=0;t<n;++t){const e=r[t];a[e].invalidate()}}return{samples:e,frames:i,joints:o}}upgradeUntypedTracks(t){const e=[],i=[],{_tracks:s}=this,r=s.length;for(let n=0;n<r;++n){const r=s[n];if(!(r instanceof n1))continue;const o=r.upgrade(t);o&&(e.push(o),i.push(r))}const n=i.length;for(let t=0;t<n;++t)jt(s,i[t]);s.push(...e)}[B2](){return this._searchForRootBonePath()}get keys(){return this._getLegacyData().keys}set keys(t){this._legacyDataDirty=!0,this._getLegacyData().keys=t}get curves(){return this._legacyDataDirty=!0,this._getLegacyData().curves}set curves(t){this._getLegacyData().curves=t}get commonTargets(){return this._getLegacyData().commonTargets}set commonTargets(t){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=t}get data(){return this._getLegacyData().data}getPropertyCurves(){return this._getLegacyData().getPropertyCurves()}get eventGroups(){return this._runtimeEvents.eventGroups}updateEventDatas(){this.events=this._events}hasEvents(){return 0!==this.events.length}syncLegacyData(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)}get[O2](){return this._embeddedPlayers.length}[L2](){return this._embeddedPlayers}[F2](t){this._embeddedPlayers.push(t)}[z2](t){const e=this._embeddedPlayers.indexOf(t);e>=0&&this._embeddedPlayers.splice(e,1)}[k2](){this._embeddedPlayers.length=0}get auxiliaryCurveCount_experimental(){return this._auxiliaryCurveEntries.length}getAuxiliaryCurveNames_experimental(){return this._auxiliaryCurveEntries.map((t=>t.name))}hasAuxiliaryCurve_experimental(t){return!!this._findAuxiliaryCurveEntry(t)}addAuxiliaryCurve_experimental(t){let e=this._findAuxiliaryCurveEntry(t);return e||(e=new d2,e.name=t,this._auxiliaryCurveEntries.push(e)),e.curve}getAuxiliaryCurve_experimental(t){return this._findAuxiliaryCurveEntry(t).curve}renameAuxiliaryCurve_experimental(t,e){const i=this._findAuxiliaryCurveEntry(t);i&&(i.name=e)}removeAuxiliaryCurve_experimental(t){qt(this._auxiliaryCurveEntries,(e=>e.name===t))}_trySyncLegacyData(){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData())}_createEvalWithBinder(t,e,i){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());const s=[];let r;i&&(r=this._createRootMotionEvaluation(t,i,s));const n=[];let o;const{_tracks:a}=this,h=a.length;for(let t=0;t<h;++t){const i=a[t];if(s.includes(i))continue;if(Array.from(i.channels()).every((t=>{let{curve:e}=t;return 0===e.keyFramesCount})))continue;const r=e(i[hQ]);if(!r)continue;let o;if(i instanceof n1){if(!r.getValue){j(3930);continue}const t=r.getValue();o=i.createLegacyEval(t)}else o=i[dY]();n.push(new H2(r,o))}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(e)),new W2(n,o,r)}_createRootMotionEvaluation(t,e,i){if(!(t instanceof JS))return void j(3920);const s=this._searchForRootBonePath();if(!s)return void G(3923);const r=t.getChildByPath(s);if(!r)return void G(3924);const n=new j2,o=[],{_tracks:a}=this,h=a.length;for(let t=0;t<h;++t){const e=a[t],{[hQ]:r}=e,h=r.parseTrsPath();if(!h)continue;if(h.node!==s)continue;i.push(e);const l=Q2(n,h.property);if(!l)continue;const c=e[dY]();o.push(new H2(l,c))}return new X2(r,this._duration,n,o)}_searchForRootBonePath(){const t=this._tracks.map((t=>{const e=t[hQ].parseTrsPath();if(e){const t=e.node;return{path:t,rank:t.split("/").length}}return{path:"",rank:0}}));t.sort(((t,e)=>t.rank-e.rank));const e=t.findIndex((t=>0!==t.rank));if(e<0)return"";const i=t.length,s=t[e];let r=!0;for(let n=e+1;n<i;++n){const e=t[n];if(e.rank!==s.rank)break;if(e.path!==s.path){r=!1;break}}return r?s.path:""}_getLegacyData(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData}_toLegacy(){const t=new o1(this._duration);return t.keys=[],t.curves=[],t.commonTargets=[],t}_fromLegacy(t){const e=t.toTracks(),i=e.length;for(let t=0;t<i;++t)this.addTrack(e[t])}_collectAnimatedJoints(){const t=new Set,{_tracks:e}=this,i=e.length;for(let s=0;s<i;++s){const i=e[s][hQ].parseTrsPath();i&&t.add(i.node)}if(this._exoticAnimation){const e=this._exoticAnimation.collectAnimatedJoints(),i=e.length;for(let s=0;s<i;++s)t.add(e[s])}return Array.from(t)}_findAuxiliaryCurveEntry(t){return this._auxiliaryCurveEntries.find((e=>e.name===t))}},E2.WrapMode=wY,g2=Qo((_2=E2).prototype,"sample",[va],(function(){return 60})),f2=Qo(_2.prototype,"speed",[va],(function(){return 1})),m2=Qo(_2.prototype,"wrapMode",[va],(function(){return 1})),y2=Qo(_2.prototype,"enableTrsBlending",[va],(function(){return!1})),v2=Qo(_2.prototype,"_duration",[va],(function(){return 0})),b2=Qo(_2.prototype,"_hash",[va],(function(){return 0})),w2=Qo(_2.prototype,"_tracks",[va],(function(){return[]})),S2=Qo(_2.prototype,"_exoticAnimation",[va],(function(){return null})),x2=Qo(_2.prototype,"_events",[va],(function(){return[]})),T2=Qo(_2.prototype,"_embeddedPlayers",[va],(function(){return[]})),C2=Qo(_2.prototype,"_additiveSettings",[va],(function(){return new V2})),I2=Qo(_2.prototype,"_auxiliaryCurveEntries",[va],(function(){return[]})),p2=_2))||p2),V2=oa("cc.AnimationClipAdditiveSettings")((A2=class{constructor(){this.enabled=M2&&M2(),this.refClip=P2&&P2()}},M2=Qo(A2.prototype,"enabled",[va],(function(){return!1})),P2=Qo(A2.prototype,"refClip",[va],(function(){return null})),D2=A2))||D2;h.AnimationClip=U2;class H2{constructor(t,e){this._binding=void 0,this._trackEval=void 0,this._shouldEvaluateDefault=!0,this._binding=t,this._trackEval=e,this._shouldEvaluateDefault=!!t.getValue&&e.requiresDefault}evaluate(t){const{_binding:e,_trackEval:i}=this,s=this._shouldEvaluateDefault?e.getValue():void 0,r=i.evaluate(t,s);e.setValue(r)}}class G2{constructor(t,e){this._embeddedPlayers=t,this._embeddedPlayerEvaluationInfos=t.map((t=>{const{playable:i}=t;if(!i)return null;const s=i.instantiate(e);return s?{instantiatedPlayer:s,entered:!1,hostPauseTime:0,lastIterations:0}:null}))}destroy(){const{_embeddedPlayerEvaluationInfos:t}=this,e=t.length;for(let s=0;s<e;++s){var i;null===(i=t[s])||void 0===i||i.instantiatedPlayer.destroy()}this._embeddedPlayerEvaluationInfos.length=0}evaluate(t,e){const{_embeddedPlayers:i,_embeddedPlayerEvaluationInfos:s}=this,r=i.length;for(let n=0;n<r;++n){const r=s[n];if(!r)continue;const{entered:o,instantiatedPlayer:a,lastIterations:h}=r,{begin:l,end:c}=i[n];if(t>=l&&t<=c?o?e!==h&&(a.stop(),a.play(),r.entered=!0):(a.play(),r.entered=!0):o&&(a.stop(),r.entered=!1),r.lastIterations=e,r.entered){const e=t-l;r.instantiatedPlayer.setTime(e)}}}notifyHostSpeedChanged(t){const{_embeddedPlayers:e,_embeddedPlayerEvaluationInfos:i}=this,s=e.length;for(let r=0;r<s;++r){const s=i[r];if(!s)continue;const{instantiatedPlayer:n}=s,{reconciledSpeed:o}=e[r];o&&n.setSpeed(t)}}notifyHostPlay(t){const{_embeddedPlayers:e,_embeddedPlayerEvaluationInfos:i}=this,s=e.length;for(let r=0;r<s;++r){const s=i[r];if(!s)continue;const{begin:n,end:o}=e[r],{instantiatedPlayer:a,entered:h}=s;if(h){const{hostPauseTime:e}=s;if(a.randomAccess||gi(e,t,1e-5)){const e=fi(t,n,o);a.play(),a.setTime(e-n)}else a.stop()}}}notifyHostPause(t){const{_embeddedPlayers:e,_embeddedPlayerEvaluationInfos:i}=this,s=e.length;for(let e=0;e<s;++e){const s=i[e];if(!s)continue;const{instantiatedPlayer:r,entered:n}=s;n&&(r.pause(),s.hostPauseTime=t)}}notifyHostStop(){const{_embeddedPlayers:t,_embeddedPlayerEvaluationInfos:e}=this,i=t.length;for(let t=0;t<i;++t){const i=e[t];if(!i)continue;const{instantiatedPlayer:s,entered:r}=i;r&&(i.entered=!1,s.stop())}}}class W2{constructor(t,e,i){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=e,this._rootMotionEvaluation=i}evaluate(t){const{_trackEvalStatues:e,_exoticAnimationEvaluator:i}=this,s=e.length;for(let i=0;i<s;++i)e[i].evaluate(t);i&&i.evaluate(t)}evaluateRootMotion(t,e){const{_rootMotionEvaluation:i}=this;i&&i.evaluate(t,e)}}class j2{constructor(){this.position=new Ki,this.scale=new Ki(1,1,1),this.rotation=new ys,this.eulerAngles=new Ki}getTransform(t){Rs.fromRTS(t,this.rotation,this.position,this.scale)}}class $2 extends j2{constructor(){super(...arguments),this.parent=null,this._dirty=!0,this._transform=new Rs}get globalTransform(){const t=this._transform;return this._dirty&&(this._dirty=!1,Rs.fromRTS(t,this.rotation,this.position,this.scale),this.parent&&Rs.multiply(t,this.parent.globalTransform,t)),this._transform}invalidate(){this._dirty=!0}}const q2=new Rs;class X2{constructor(t,e,i,s){this._initialTransformCache=new Rs,this._clipEndTransformCache=new Rs,this._startTransformCache=new Rs,this._endTransformCache=new Rs,this._motionTransformCache=new Rs,this._translationMotionCache=new Ki,this._rotationMotionCache=new ys,this._scaleMotionCache=new Ki,this._rootBone=t,this._duration=e,this._boneTransform=i,this._trackEvalStatuses=s}evaluate(t,e){const i=this._calcMotionTransform(t,e,this._motionTransformCache),{_translationMotionCache:s,_rotationMotionCache:r,_scaleMotionCache:n,_rootBone:o}=this;Rs.toRTS(i,r,s,n),Ki.add(s,s,o.position),o.setPosition(s),ys.multiply(r,r,o.rotation),o.setRotation(r),Ki.multiply(n,n,o.scale),o.setScale(n)}_calcMotionTransform(t,e,i){const{_duration:s}=this,r=s-t,n=this._evaluateAt(t,this._startTransformCache);if(e<r){const s=this._evaluateAt(t+e,this._endTransformCache);Y2(i,n,s)}else{Rs.identity(i);const t=(t,e)=>{Y2(q2,t,e),Rs.multiply(i,i,q2)},o=e-r,a=Math.floor(o/s),h=o-a*s,l=this._evaluateAt(0,this._initialTransformCache),c=this._evaluateAt(s,this._clipEndTransformCache),u=this._evaluateAt(h,this._endTransformCache);t(n,c),Y2(q2,l,c);for(let t=0;t<a;++t)Rs.multiply(i,i,q2);t(l,u)}return i}_evaluateAt(t,e){const{_trackEvalStatuses:i}=this,s=i.length;for(let e=0;e<s;++e)i[e].evaluate(t);return this._boneTransform.getTransform(e),e}}function Y2(t,e,i){Rs.invert(t,e),Rs.multiply(t,i,t)}function Q2(t,e){switch(e){default:return;case"position":return{setValue(e){Ki.copy(t.position,e)}};case"rotation":return{setValue(e){ys.copy(t.rotation,e)}};case"scale":return{setValue(e){Ki.copy(t.scale,e)}};case"eulerAngles":return{setValue(e){Ki.copy(t.eulerAngles,e)}}}}class K2{constructor(t,e,i,s){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=e,this._eventGroups=i,this._wrapMode=s}setWrapMode(t){this._wrapMode=t}ignore(t,e){this._ignoreIndex=-1,this._sampled=!1;let i=J2(t,this._ratios);i<0&&(i=~i-1,e<0&&(i+=1),this._ignoreIndex=i)}reset(){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1}sample(t,e,i){if(0===this._eventGroups.length)return;const s=this._eventGroups.length;let r=J2(t,this._ratios);if(r<0&&(r=~r-1,e<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=i,void(this._lastDirection=e);const n=this._wrapMode,o=Z2(i);let a=Z2(this._lastIterations),h=this._lastFrameIndex;const l=this._lastDirection,c=-1!==a&&o!==a;if(h===r&&c&&1===s)this._doFire(0,!1);else if(h!==r||c){e=l;do{if(h!==r){if(-1===e&&0===h&&r>0?(22&~n?h=s:e*=-1,a++):1===e&&h===s-1&&r<s-1&&(22&~n?h=-1:e*=-1,a++),h===r)break;if(a>o)break}h+=e,this._doFire(h,!0)}while(h!==r&&h>-1&&h<s)}this._lastFrameIndex=r,this._lastIterations=i,this._lastDirection=e}_doFire(t,e){e?TY().pushDelayEvent(this._checkAndFire,this,[t]):this._checkAndFire(t)}_checkAndFire(t){if(!this._targetNode||!this._targetNode.isValid)return;const{_eventGroups:e}=this;if(t<0||t>=e.length||this._ignoreIndex===t)return;const i=e[t],s=i.events.length;for(let t=0;t<s;++t){const e=i.events[t];SZ(this._targetNode,e.functionName,e.parameters)}}}function Z2(t){return t-(0|t)==0&&(t-=1),0|t}function J2(t,e){return Go(e,t)}function t3(t,e,i,s,r,n){if(0===e)return n.time=0,n.ratio=0,n.direction=1,n.stopped=!!Number.isFinite(s),n.iterations=0,n;let o=!1,a=t>0?t/e:-t/e;if(a>=s){a=s,o=!0;let i=s-(0|s);0===i&&(i=1),t=i*e*(t>0?1:-1)}if(t>e){const i=t%e;t=0===i?e:i}else t<0&&0!=(t%=e)&&(t+=e);let h=!1;const l=4&i;l&&(h=e3(i,a));let c=h?-1:1;return l&&h&&(t=e-t),n.time=t,n.ratio=n.time/e,n.direction=c,n.stopped=o,n.iterations=a,n}function e3(t,e){let i=!1;return 22&~t||(e-(0|e)==0&&e>0&&(e-=1),1&e&&(i=!i)),36&~t||(i=!i),i}var i3;const s3=new Ki,r3=new Ki,n3=new ys;new ys;class o3{constructor(){this._position=new Ki,this._rotation=new ys,this._scale=Ki.clone(Ki.ONE)}get position(){return this._position}set position(t){Ki.copy(this._position,t)}get rotation(){return this._rotation}set rotation(t){ys.copy(this._rotation,t)}get scale(){return this._scale}set scale(t){Ki.copy(this._scale,t)}static clone(t){const e=new o3;return o3.copy(e,t),e}static setIdentity(t){return Ki.copy(t._position,Ki.ZERO),ys.copy(t._rotation,ys.IDENTITY),Ki.copy(t._scale,Ki.ONE),t}static copy(t,e){return Ki.copy(t._position,e._position),ys.copy(t._rotation,e._rotation),Ki.copy(t._scale,e._scale),t}static equals(t,e,i){return Ki.equals(t._position,e._position,i)&&ys.equals(t._rotation,e._rotation,i)&&Ki.equals(t._scale,e._scale,i)}static strictEquals(t,e){return Ki.strictEquals(t._position,e._position)&&ys.strictEquals(t._rotation,e._rotation)&&Ki.strictEquals(t._scale,e._scale)}static lerp(t,e,i,s){return 0===s?o3.copy(t,e):1===s?o3.copy(t,i):(Ki.lerp(t._position,e._position,i._position,s),ys.slerp(t._rotation,e._rotation,i._rotation,s),Ki.lerp(t._scale,e._scale,i._scale,s),t)}static multiply(t,e,i){const s=ys.multiply(n3,e._rotation,i._rotation),r=Ki.multiply(s3,i._scale,e._scale),n=Ki.multiply(r3,i._position,e._scale);return Ki.transformQuat(n,n,e._rotation),Ki.add(n,n,e._position),Ki.copy(t._position,n),ys.copy(t._rotation,s),Ki.copy(t._scale,r),t}static invert(t,e){const{_rotation:i,_scale:s,_position:r}=t;return ys.invert(i,e._rotation),a3(s,e._scale,pi),Ki.negate(r,e._position),Ki.multiply(r,r,s),Ki.transformQuat(r,r,i),t}static fromMatrix(t,e){return Rs.toSRT(e,t._rotation,t._position,t._scale),t}static toMatrix(t,e){return Rs.fromSRT(t,e._rotation,e._position,e._scale)}}function a3(t,e,i){const{x:s,y:r,z:n}=e;return Ki.set(t,Math.abs(s)<=i?0:1/s,Math.abs(r)<=i?0:1/r,Math.abs(n)<=i?0:1/n)}function h3(t,e,i){return Ki.subtract(t.position,e.position,i.position),c3(t.rotation,i.rotation,e.rotation),Ki.subtract(t.scale,e.scale,i.scale),t}i3=o3,o3.IDENTITY=Object.freeze(new i3),o3.ZERO=Object.freeze((()=>{const t=new i3;return Ki.copy(t._position,Ki.ZERO),ys.set(t._rotation,0,0,0,0),Ki.copy(t._scale,Ki.ZERO),t})()),o3.calculateRelative=(()=>{const t=new ys,e=new Ki;return(i,s,r)=>{const n=ys.invert(t,r._rotation),o=a3(e,r._scale,pi),a=Ki.subtract(r3,s._position,r._position);return Ki.transformQuat(a,a,n),Ki.multiply(a,a,o),Ki.copy(i._position,a),ys.multiply(i._rotation,n,s._rotation),Ki.multiply(i._scale,s._scale,o),i}})();const l3=(()=>{const t=new ys;return(e,i,s,r)=>{Ki.scaleAndAdd(e.position,i.position,s.position,r);const n=ys.slerp(t,ys.IDENTITY,s.rotation,r);return ys.multiply(e.rotation,n,i.rotation),Ki.scaleAndAdd(e.scale,i.scale,s.scale,r),e}})(),c3=(()=>{const t=new ys;return(e,i,s)=>{const r=ys.invert(t,i);return ys.multiply(e,s,r)}})(),u3=Object.freeze((()=>{const t=new o3;return t.position=Ki.ZERO,t.rotation=ys.IDENTITY,t.scale=Ki.ZERO,t})());class d3{constructor(t,e){this.transforms=void 0,this.auxiliaryCurves=void 0,this._poseTransformSpace=0,this.transforms=t,this.auxiliaryCurves=e}static _create(t,e){return new d3(t,e)}}class p3{constructor(t){this._involvedTransforms=new Uint16Array(t)}get involvedTransforms(){return this._involvedTransforms}}function _3(t,e,i,s){void 0===s&&(s=void 0),g3(t.transforms,e.transforms,i,s),y3(t.auxiliaryCurves,e.auxiliaryCurves,i)}function g3(t,e,i,s){void 0===s&&(s=void 0);const r=t.length;if(t.length,0!==i)if(1!==i)if(s)for(let r=0;r<s.involvedTransforms.length;++r){const n=s.involvedTransforms[r];m3(t,e,i,n)}else for(let s=0;s<r;++s)m3(t,e,i,s);else s?f3(t,e,s):t.set(e)}function f3(t,e,i){t.length,t.length;for(let s=0;s<i.involvedTransforms.length;++s){const r=i.involvedTransforms[s];t.copyRange(r,e,r,1)}}const m3=(()=>{const t=new o3,e=new o3;return(i,s,r,n)=>{const o=i.getTransform(n,e),a=s.getTransform(n,t);o3.lerp(o,o,a,r),i.setTransform(n,o)}})();function y3(t,e,i){const s=e.length;t.length;for(let r=0;r<s;++r)t[r]=yi(t[r],e[r],i)}const v3=(()=>{const t=new o3,e=new o3;return(i,s,r)=>{const n=s.getTransform(r,t),o=i.getTransform(r,e);h3(o,o,n),i.setTransform(r,o)}})();function b3(t,e){const i=t.length;e.length;for(let s=0;s<i;++s)v3(t,e,s)}function w3(t,e){t.length,e.length;for(let i=0;i<t.length;++i)t[i]-=e[i]}function S3(t,e,i,s){void 0===s&&(s=void 0),T3(t.transforms,e.transforms,i,s),C3(t.auxiliaryCurves,e.auxiliaryCurves,i)}const x3=(()=>{const t=new o3,e=new o3;return(i,s,r,n)=>{const o=s.getTransform(n,t),a=i.getTransform(n,e);l3(a,a,o,r),i.setTransform(n,a)}})();function T3(t,e,i,s){void 0===s&&(s=void 0);const r=t.length;if(e.length,s)for(let r=0;r<s.involvedTransforms.length;++r){const n=s.involvedTransforms[r];x3(t,e,i,n)}else for(let s=0;s<r;++s)x3(t,e,i,s)}function C3(t,e,i){t.length,e.length;for(let s=0;s<t.length;++s)t[s]+=e[s]*i}const I3=new Ki,E3=new ys;class D3{constructor(t){this._transformHandle=t}destroy(){this._transformHandle.destroy()}}class A3 extends D3{setValue(t,e){e.transforms.setPosition(this._transformHandle.index,t)}getValue(t){return t.transforms.getPosition(this._transformHandle.index,I3)}}class M3 extends D3{setValue(t,e){e.transforms.setRotation(this._transformHandle.index,t)}getValue(t){return t.transforms.getRotation(this._transformHandle.index,E3)}}class P3 extends D3{setValue(t,e){const i=ys.fromEuler(P3._EULER_TO_QUAT_CACHE,t.x,t.y,t.z);e.transforms.setRotation(this._transformHandle.index,i)}getValue(t){const e=t.transforms.getRotation(this._transformHandle.index,E3);return ys.toEuler(I3,e)}}P3._EULER_TO_QUAT_CACHE=new ys;class B3 extends D3{setValue(t,e){e.transforms.setScale(this._transformHandle.index,t)}getValue(t){return t.transforms.getScale(this._transformHandle.index,I3)}}class R3{constructor(t){this._handle=t}destroy(){this._handle.destroy()}setValue(t,e){e.auxiliaryCurves[this._handle.index]=t}getValue(t){return t.auxiliaryCurves[this._handle.index]}}function O3(t,e){switch(e){case"position":return new A3(t);case"rotation":return new M3(t);case"eulerAngles":return new P3(t);case"scale":return new B3(t)}}class L3{constructor(t){this.binding=t}destroy(){}setValue(t,e){this.binding.setValue(t)}getValue(t){var e,i,s;return null!==(e=null===(i=(s=this.binding).getValue)||void 0===i?void 0:i.call(s))&&void 0!==e?e:void 0}}class F3{constructor(t,e){this._binding=void 0,this._trackSampler=void 0,this._binding=t,this._trackSampler=e}destroy(){this._binding.destroy()}evaluate(t,e){const{_trackSampler:i,_binding:s}=this,r=i.requiresDefault?s.getValue(e):void 0,n=i.evaluate(t,r);s.setValue(n,e)}}function z3(t,e,i){const s=k3(e[hQ],i);return null!=s?s:void 0}function k3(t,e){const{origin:i}=e,{path:s,proxy:r}=t,n=s.length,o=n-1;if(0!==n&&(s.isPropertyAt(o)||s.isElementAt(o))&&!r){const t=s.isPropertyAt(o)?s.parsePropertyAt(o):s.parseElementAt(o),r=s[oQ](i,0,n-1);if(null===r)return null;if(r instanceof JS&&uQ(t)){const s=(()=>{const t=[];let e=r;for(;e&&e!==i;e=e.parent)t.unshift(e.name);return e===i?t.join("/"):void 0})();if("string"==typeof s){const i=e.bindTransform(s);if(!i)return;return O3(i,t)}}}{const i=t.createRuntimeBinding(e.origin,void 0,!1);return i?new L3(i):null}}class N3{constructor(t,e){this._binding=t,this._curve=e}evaluate(t,e){const{_curve:i,_binding:s}=this,r=e,n=i.evaluate(t);s.setValue(n,r)}}function U3(t,e){return t.isAdditive_experimental?new H3(t,e):new V3(t,e)}class V3{constructor(t,e){this._trackEvaluations=[],this._exoticAnimationEvaluation=void 0,this._auxiliaryCurveEvaluations=[],t._trySyncLegacyData();const i=[];let s;const r=[],{tracks:n}=t,o=t[R2];for(const t of n){if(t instanceof n1)continue;if(Array.from(t.channels()).every((t=>{let{curve:e}=t;return 0===e.keyFramesCount})))continue;const s=z3(0,t,e);if(!s)continue;const r=t[dY](),n=new F3(s,r);i.push(n)}o&&(s=o.createEvaluatorForAnimationGraph(e));const a=t.getAuxiliaryCurveNames_experimental(),h=a.length;for(let i=0;i<h;++i){const s=a[i],n=t.getAuxiliaryCurve_experimental(s),o=e.bindAuxiliaryCurve(s),h=new R3(o);r.push(new N3(h,n))}this._trackEvaluations=i,this._exoticAnimationEvaluation=s,this._auxiliaryCurveEvaluations=r}destroy(){var t;null===(t=this._exoticAnimationEvaluation)||void 0===t||t.destroy();const{_trackEvaluations:e}=this,i=e.length;for(let t=0;t<i;++t)e[t].destroy()}evaluate(t,e){const{_trackEvaluations:i,_exoticAnimationEvaluation:s,_auxiliaryCurveEvaluations:r}=this,n=e.pushDefaultedPose(),o=i.length;for(let e=0;e<o;++e)i[e].evaluate(t,n);s&&s.evaluate(t,n);const a=r.length;for(let e=0;e<a;++e)r[e].evaluate(t,n);return n}}class H3{constructor(t,e){this._clipEval=void 0,this._refClipEval=void 0,this._clipEval=new V3(t,e);const i=t[N2].refClip;i&&i!==t&&(this._refClipEval=new V3(i,e))}destroy(){var t;this._clipEval.destroy(),null===(t=this._refClipEval)||void 0===t||t.destroy()}evaluate(t,e){const i=this._clipEval.evaluate(t,e);let s;if(this._refClipEval){const t=0;s=this._refClipEval.evaluate(t,e)}else s=this._clipEval.evaluate(0,e);var r,n;return n=s,b3((r=i).transforms,n.transforms),w3(r.auxiliaryCurves,n.auxiliaryCurves),e.popPose(),i}}var G3,W3,j3,$3,q3;const{ccclass:X3,type:Y3}=Ja;let Q3=(G3=X3("cc.animation.ClipMotion"),W3=Y3(U2),G3(($3=class t extends j0{constructor(){super(...arguments),this.clip=q3&&q3()}[G0](t,e){return this.clip?new Z3(t,this.clip,e):null}clone(){const e=new t;return e.clip=this.clip,e[an]=lZ(this),e}},q3=Qo($3.prototype,"clip",[W3,va],(function(){return null})),j3=$3))||j3);const K3=Symbol("EvaluatePort");class Z3{constructor(t,e,i){var s,r;this._clipEmbeddedPlayerEval=null,this._frameEventEval=null,this._wrapInfo=new SY,this._duration=0,this._ignoreEmbeddedPlayers=void 0,this._originalClip=e,this._ignoreEmbeddedPlayers=i;const n=null!==(s=null===(r=t.clipOverrides)||void 0===r?void 0:r.get(e))&&void 0!==s?s:e;this._setClip(n,t)}get duration(){return this._duration}createPort(){return new J3(this)}getClipStatuses(t){let e=!1;return{next:()=>e?{done:!0,value:void 0}:(e=!0,{done:!1,value:{__DEBUG_ID__:this.__DEBUG__ID__,clip:this._clip,weight:t}})}}[K3](t,e){var i,s;const{_duration:r,_clip:{duration:n},_clipEval:o}=this,a=r*t,{wrapMode:h}=this._clip,l=t3(a,r,h,2&~h?1:1/0,0,this._wrapInfo),c=l.ratio*n,u=o.evaluate(c,e);return null===(i=this._frameEventEval)||void 0===i||i.sample(l.ratio,l.direction,l.iterations),null===(s=this._clipEmbeddedPlayerEval)||void 0===s||s.evaluate(c,Math.trunc(l.iterations)),u}overrideClips(t){var e;const{_originalClip:i}=this,s=null===(e=t.clipOverrides)||void 0===e?void 0:e.get(i);s&&this._setClip(s,t)}reenter(){var t;null===(t=this._frameEventEval)||void 0===t||t.reset()}_setClip(t,e){var i;null===(i=this._clipEval)||void 0===i||i.destroy(),this._frameEventEval=null,this._clipEmbeddedPlayerEval&&(this._clipEmbeddedPlayerEval.destroy(),this._clipEmbeddedPlayerEval=null),this._clip=t,this._duration=0===t.speed?0:t.duration/t.speed,this._clipEval=U3(t,e),this._frameEventEval=t.createEventEvaluator(e.origin),!this._ignoreEmbeddedPlayers&&t.containsAnyEmbeddedPlayer()&&(this._clipEmbeddedPlayerEval=t.createEmbeddedPlayerEvaluator(e.origin))}}class J3{constructor(t){this._eval=void 0,this._eval=t}evaluate(t,e){return this._eval[K3](t,e)}reenter(){this._eval.reenter()}}var t4,e4,i4,s4,r4,n4;const{ccclass:o4,serializable:a4}=Ja;let h4=o4(`${uY}AnimationBlendItem`)((e4=class t{constructor(){this.motion=i4&&i4()}clone(){const e=new t;return this._copyTo(e),e}_copyTo(t){var e,i;return t.motion=null!==(e=null===(i=this.motion)||void 0===i?void 0:i.clone())&&void 0!==e?e:null,t}},i4=Qo(e4.prototype,"motion",[a4],(function(){return null})),t4=e4))||t4,l4=o4(`${uY}AnimationBlend`)((r4=class extends j0{constructor(){super(...arguments),this.name=n4&&n4()}copyTo(t){t.name=this.name,t[an]=lZ(this)}},n4=Qo(r4.prototype,"name",[a4],(function(){return""})),s4=r4))||s4;class c4{constructor(t,e,i,s,r){this._childEvaluators=s.map((i=>{var s,r;return null!==(s=null===(r=i.motion)||void 0===r?void 0:r[G0](t,e))&&void 0!==s?s:null})),this._weights=new Array(this._childEvaluators.length).fill(0),this._inputs=[...r]}createPort(){return new u4(this,this._childEvaluators.map((t=>{var e;return null!==(e=null==t?void 0:t.createPort())&&void 0!==e?e:null})))}get childCount(){return this._weights.length}getChildWeight(t){return this._weights[t]}getChildMotionEval(t){return this._childEvaluators[t]}get duration(){let t=0;for(let s=0;s<this._childEvaluators.length;++s){var e,i;t+=(null!==(e=null===(i=this._childEvaluators[s])||void 0===i?void 0:i.duration)&&void 0!==e?e:0)*this._weights[s]}return t}getClipStatuses(t){const{_childEvaluators:e,_weights:i}=this,s=e.length;let r,n=0;return{next(){for(;;){if(r){const t=r.next();if(!t.done)return t}if(n>=s)return{done:!0,value:void 0};{const s=e[n];r=null==s?void 0:s.getClipStatuses(t*i[n]),++n}}}}}__evaluatePort(t,e,i){const s=this._childEvaluators.length;let r=0,n=null;for(let a=0;a<s;++a){var o;const s=this._weights[a];if(!s)continue;const h=null===(o=t.childPorts[a])||void 0===o?void 0:o.evaluate(e,i);h&&(r+=s,n?(r&&_3(n,h,s/r),i.popPose()):n=h)}return n||i.pushDefaultedPose()}overrideClips(t){for(let i=0;i<this._childEvaluators.length;++i){var e;null===(e=this._childEvaluators[i])||void 0===e||e.overrideClips(t)}}setInput(t,e){this._inputs[e]=t,this.doEval()}doEval(){this.eval(this._weights,this._inputs)}}class u4{constructor(t,e){this.childPorts=[],this._host=void 0,this._host=t,this.childPorts=e}evaluate(t,e){return this._host.__evaluatePort(this,t,e)}reenter(){const{childPorts:t}=this,e=t.length;for(let s=0;s<e;++s){var i;null===(i=t[s])||void 0===i||i.reenter()}}}var d4,p4,_4,g4,f4,m4,y4,v4;const{ccclass:b4,serializable:w4}=Ja;let S4=b4(`${uY}BindableNumber`)((p4=class t{constructor(t){void 0===t&&(t=0),this.variable=_4&&_4(),this.value=g4&&g4(),this.value=t}clone(){const e=new t;return e.value=this.value,e.variable=this.variable,e}},_4=Qo(p4.prototype,"variable",[w4],(function(){return""})),g4=Qo(p4.prototype,"value",[w4],(function(){return 0})),d4=p4))||d4,x4=b4(`${uY}BindableBoolean`)((m4=class t{constructor(t){void 0===t&&(t=!1),this.variable=y4&&y4(),this.value=v4&&v4(),this.value=t}clone(){const e=new t;return e.value=this.value,e.variable=this.variable,e}},y4=Qo(m4.prototype,"variable",[w4],(function(){return""})),v4=Qo(m4.prototype,"value",[w4],(function(){return!1})),f4=m4))||f4;function T4(t,e,i,s,r){const{variable:n,value:o}=e;if(!n)return o;const a=t.getVar(n);if(!C4(a,n))return o;if(a.type!==i)throw new JK(n,"number");for(var h=arguments.length,l=new Array(h>5?h-5:0),c=5;c<h;c++)l[c-5]=arguments[c];return a.bind(s,r,...l)}function C4(t,e){if(t)return!0;throw new ZK(e)}function I4(t,e,i){if(t!==e)throw new JK(i,"number")}function E4(t,e){if(2!==t)throw new JK(e,"trigger")}function D4(t,e,i){if(t.fill(0),0===e.length);else if(i<=e[0])t[0]=1;else if(i>=e[e.length-1])t[t.length-1]=1;else{let s=0;for(let t=1;t<e.length;++t)if(e[t]>i){s=t;break}const r=e[s-1],n=e[s],o=n-r;t[s-1]=(n-i)/o,t[s]=(i-r)/o}}var A4,M4,P4,B4,R4,O4,L4,F4;const{ccclass:z4,serializable:k4}=Ja;let N4=z4(`${uY}AnimationBlend1DItem`)((M4=class t extends h4{constructor(){super(...arguments),this.threshold=P4&&P4()}clone(){const e=new t;return this._copyTo(e),e}_copyTo(t){return super._copyTo(t),t.threshold=this.threshold,t}},P4=Qo(M4.prototype,"threshold",[k4],(function(){return 0})),A4=M4))||A4,U4=z4("cc.animation.AnimationBlend1D")((F4=class t extends l4{constructor(){super(...arguments),this._items=O4&&O4(),this.param=L4&&L4()}get items(){return this._items}set items(t){this._items=Array.from(t).sort(((t,e)=>{let{threshold:i}=t,{threshold:s}=e;return i-s}))}clone(){const e=new t;return this.copyTo(e),e._items=this._items.map((t=>t.clone())),e.param=this.param.clone(),e}[G0](t,e){const i=new V4(t,e,this,this._items,this._items.map((t=>{let{threshold:e}=t;return e})),0),s=T4(t,this.param,0,i.setInput,i,0);return i.setInput(s,0),i}},F4.Item=N4,O4=Qo((R4=F4).prototype,"_items",[k4],(function(){return[]})),L4=Qo(R4.prototype,"param",[k4],(function(){return new S4})),B4=R4))||B4;class V4 extends c4{constructor(t,e,i,s,r,n){super(t,e,i,s,[n]),this._thresholds=r,this.doEval()}eval(t,e){let[i]=e;D4(t,this._thresholds,i)}}const H4=(()=>{const t=new Qs,e={wA:0,wB:0};return function(i,s,r){if(i.length,s.length,0===s.length)return;if(1===s.length)return void(i[0]=1);if(Qs.strictEquals(r,Qs.ZERO)){const t=s.findIndex((t=>Qs.strictEquals(t,Qs.ZERO)));return void(t>=0?i[t]=1:i.fill(1/s.length))}let n=-1,o=-1,a=-1,h=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;const{x:c,y:u}=r;for(let e=0;e<s.length;++e){const i=s[e];if(Qs.equals(i,Qs.ZERO)){a=e;continue}const d=Qs.normalize(t,i),p=Qs.dot(d,r);d.x*u-d.y*c>0?p>=l&&(l=p,n=e):p>=h&&(h=p,o=e)}let d=0;if(n<0||o<0)d=1;else{const{wA:t,wB:a}=j4(s[n],s[o],r,e);let h=0,l=0;const c=t+a;c>1?(h=t/c,l=a/c):c<0?(h=0,l=0,d=1):(h=t,l=a,d=1-c),i[n]=h,i[o]=l}if(d>0)if(a>=0)i[a]=d;else{const t=d/i.length;for(let e=0;e<i.length;++e)i[e]+=t}}})();function G4(t,e,i){W4(t,e,i,$4)}function W4(t,e,i,s){t.fill(0);const r=new Qs(0,0),n=new Qs(0,0);let o=0;const a=e.length;for(let h=0;h<a;++h){let l=Number.MAX_VALUE,c=!1;for(let t=0;t<a;++t){if(h===t)continue;s(e[h],e[t],i,r,n);const o=1-Qs.dot(r,n)/Qs.lengthSqr(n);if(o<0){c=!0;break}l=Math.min(l,o)}c||(t[h]=l,o+=l)}o>0&&t.forEach(((e,i)=>t[i]=e/o))}function j4(t,e,i,s){const r=Qs.cross(t,e);return r?(s.wA=Qs.cross(i,e)/r,s.wB=Qs.cross(i,t)/-r):(s.wA=0,s.wB=0),s}const $4=(t,e,i,s,r)=>{Qs.subtract(s,i,t),Qs.subtract(r,e,t)};class q4{constructor(t){const{_ANGLE_MULTIPLIER:e}=q4,i=t.length,s=this._exampleMagnitudes=new Array(i).fill(0),r=this._exampleDirections=t.map(((t,e)=>{const i=Qs.copy(new Qs,t),r=Qs.len(i);return s[e]=r,gi(r,0,1e-5)||Qs.multiplyScalar(i,i,1/r),i})),n=this._precomputedVIJs=new Float32Array(3*i*i);for(let t=0;t<i;++t){const o=s[t],a=r[t];for(let h=0;h<i;++h){if(t===h)continue;const l=s[h],c=r[h],u=(o+l)/2,d=3*(i*t+h);n[d+0]=(l-o)/u,n[d+1]=X4(a,c)*e,n[d+2]=u}}this._cacheVIXAngles=new Float32Array(i)}interpolate(t,e){const{_exampleDirections:i,_exampleMagnitudes:s,_precomputedVIJs:r,_cacheVIXAngles:n}=this,{_CACHE_INPUT_DIRECTION:o,_CACHE_VIJ:a,_CACHE_VIX:h,_ANGLE_MULTIPLIER:l}=q4,c=i.length;if(t.length,0===c)return;if(1===c)return void(t[0]=1);const u=e,d=Qs.len(u),p=n;if(Qs.equals(u,Qs.ZERO))for(let t=0;t<c;++t)p[t]=0;else{const t=Qs.multiplyScalar(o,u,1/d);for(let e=0;e<c;++e){const s=i[e];Qs.equals(s,Qs.ZERO)?p[e]=0:p[e]=X4(s,t)*l}}let _=0;for(let e=0;e<c;++e){const n=s[e],o=i[e];let l=Number.POSITIVE_INFINITY;for(let t=0;t<c;++t){if(e===t)continue;const s=i[t],_=3*(c*e+t),{[_+0]:g,[_+1]:f,[_+2]:m}=r;let y=f,v=p[e];Qs.equals(o,Qs.ZERO)?y=p[t]:Qs.equals(s,Qs.ZERO)?y=p[e]:Qs.equals(u,Qs.ZERO)&&(v=y);const b=Qs.set(a,g,y),w=Qs.set(h,(d-n)/m,v),S=1-Qs.dot(w,b)/Qs.lengthSqr(b);if(S<=0){l=0;break}l=Math.min(l,S)}t[e]=l,_+=l}if(_>0)for(let e=0;e<c;++e)t[e]/=_;else{const e=1/c;for(let i=0;i<c;++i)t[i]=e}}}function X4(t,e){const i=Qs.angle(t,e);return t.x*e.y-t.y*e.x<0?-i:i}var Y4,Q4,K4,Z4,J4,t5,e5,i5,s5,r5;q4._CACHE_INPUT_DIRECTION=new Qs,q4._CACHE_VIJ=new Qs,q4._CACHE_VIX=new Qs,q4._ANGLE_MULTIPLIER=1;const{ccclass:n5,serializable:o5}=Ja,a5={SIMPLE_DIRECTIONAL:0,FREEFORM_CARTESIAN:1,FREEFORM_DIRECTIONAL:2};se(a5);let h5=n5(`${uY}AnimationBlend2DItem`)((Q4=class t extends h4{constructor(){super(...arguments),this.threshold=K4&&K4()}clone(){const e=new t;return this._copyTo(e),e}_copyTo(t){return super._copyTo(t),Qs.copy(t.threshold,this.threshold),t}},K4=Qo(Q4.prototype,"threshold",[o5],(function(){return new Qs})),Y4=Q4))||Y4,l5=n5("cc.animation.AnimationBlend2D")((r5=class t extends l4{constructor(){super(...arguments),this._items=t5&&t5(),this.paramX=e5&&e5(),this.paramY=i5&&i5(),this._algorithm=s5&&s5(),this._polarSpaceGBI=void 0}get algorithm(){return this._algorithm}set algorithm(t){t!==this._algorithm&&(this._algorithm=t,this._tryReconstructPolarSpaceInterpolator())}get items(){return this._items}set items(t){this._items=Array.from(t),this._tryReconstructPolarSpaceInterpolator()}__callOnAfterDeserializeRecursive(){this._tryReconstructPolarSpaceInterpolator()}clone(){const e=new t;return this.copyTo(e),e._items=this._items.map((t=>{var e;return null!==(e=null==t?void 0:t.clone())&&void 0!==e?e:null})),e.paramX=this.paramX.clone(),e.paramY=this.paramY.clone(),e.algorithm=this._algorithm,e}[G0](t,e){const{algorithm:i}=this;let s;2===i?(this._polarSpaceGBI,s=new u5(t,e,this,this._items,this._polarSpaceGBI,[0,0])):s=new c5(t,e,this,this._items,this._items.map((t=>{let{threshold:e}=t;return e})),i,[0,0]);const r=T4(t,this.paramX,0,s.setInput,s,0),n=T4(t,this.paramY,0,s.setInput,s,1);return s.setInput(r,0),s.setInput(n,1),s}_tryReconstructPolarSpaceInterpolator(){2===this._algorithm?this._polarSpaceGBI=new q4(this._items.map((t=>t.threshold))):this._polarSpaceGBI=void 0}},r5.Algorithm=a5,r5.Item=h5,t5=Qo((J4=r5).prototype,"_items",[o5],(function(){return[]})),e5=Qo(J4.prototype,"paramX",[o5],(function(){return new S4})),i5=Qo(J4.prototype,"paramY",[o5],(function(){return new S4})),s5=Qo(J4.prototype,"_algorithm",[o5],(function(){return 0})),Z4=J4))||Z4;class c5 extends c4{constructor(t,e,i,s,r,n,o){super(t,e,i,s,o),this._thresholds=void 0,this._algorithm=void 0,this._value=new Qs,this._thresholds=r,this._algorithm=n,this.doEval()}eval(t,e){let[i,s]=e;switch(Qs.set(this._value,i,s),t.fill(0),this._algorithm){case 0:H4(t,this._thresholds,this._value);break;case 1:G4(t,this._thresholds,this._value)}}}class u5 extends c4{constructor(t,e,i,s,r,n){super(t,e,i,s,n),this._interpolator=void 0,this._value=new Qs,this._interpolator=r,this.doEval()}eval(t,e){let[i,s]=e;Qs.set(this._value,i,s),t.fill(0),this._interpolator.interpolate(t,this._value)}}var d5,p5,_5,g5,f5,m5;const{ccclass:y5,serializable:v5}=Ja;let b5=y5(`${uY}AnimationBlendDirectItem`)((p5=class t extends h4{constructor(){super(...arguments),this.weight=_5&&_5()}clone(){const e=new t;return this._copyTo(e),e}_copyTo(t){return super._copyTo(t),t.weight=this.weight,t}},_5=Qo(p5.prototype,"weight",[v5],(function(){return new S4(0)})),d5=p5))||d5;y5("cc.animation.AnimationBlendDirect")((m5=class t extends l4{constructor(){super(...arguments),this._items=f5&&f5()}get items(){return this._items}set items(t){this._items=Array.from(t)}clone(){const e=new t;return this.copyTo(e),e._items=this._items.map((t=>{var e;return null!==(e=null==t?void 0:t.clone())&&void 0!==e?e:null})),e}[G0](t,e){const i=new w5(t,e,this,this._items,new Array(this._items.length).fill(0));for(let e=0;e<this._items.length;++e){const s=T4(t,this._items[e].weight,0,i.setInput,i,e);i.setInput(s,e)}return i}},m5.Item=b5,f5=Qo((g5=m5).prototype,"_items",[v5],(function(){return[]})),g5));class w5 extends c4{constructor(){super(...arguments),this.doEval()}eval(t,e){const i=t.length;for(let s=0;s<i;++s)t[s]=e[s]}}var S5,x5,T5,C5,I5,E5,D5,A5;let M5,P5=oa("cc.JointMask")((x5=class{constructor(){this.path=T5&&T5(),this.enabled=C5&&C5()}},T5=Qo(x5.prototype,"path",[va],(function(){return""})),C5=Qo(x5.prototype,"enabled",[va],(function(){return!0})),S5=x5))||S5;var B5,R5,O5,L5,F5,z5,k5,N5,U5,V5,H5,G5,W5;I5=oa(`${uY}AnimationMask`),E5=Ga(P5),I5((D5=class extends F_{constructor(){super(...arguments),this._jointMasks=A5&&A5()}get joints(){return this._jointMasks}set joints(t){this.clear();for(const e of t)this.addJoint(e.path,e.enabled)}addJoint(t,e){this.removeJoint(t);const i=new P5;i.path=t,i.enabled=e,this._jointMasks.push(i)}removeJoint(t){qt(this._jointMasks,(e=>{let{path:i}=e;return i===t}))}clear(){this._jointMasks.length=0}filterDisabledNodes(t){const{_jointMasks:e}=this,i=e.length,s=new Set;for(let r=0;r<i;++r){const{path:i,enabled:n}=e[r];if(n)continue;const o=t.getChildByPath(i);o&&s.add(o)}return s}isExcluded(t){var e,i;return!(null===(e=null===(i=this._jointMasks.find((e=>{let{path:i}=e;return i===t})))||void 0===i?void 0:i.enabled)||void 0===e||e)}},A5=Qo(D5.prototype,"_jointMasks",[va],(function(){return[]})),s(D5.prototype,"joints",[E5],Object.getOwnPropertyDescriptor(D5.prototype,"joints"),D5.prototype),D5));let j5=oa(`${uY}ClipOverrideEntry`)((R5=class{constructor(){this.original=O5&&O5(),this.substitution=L5&&L5()}},O5=Qo(R5.prototype,"original",[va],(function(){return null})),L5=Qo(R5.prototype,"substitution",[va],(function(){return null})),B5=R5))||B5,$5=(F5=oa(`${uY}AnimationGraphVariant`),z5=Ga(H0),F5((N5=class extends kZ{constructor(){super(...arguments),this._graph=U5&&U5(),this._clipOverrides=V5&&V5()}get original(){return this._graph}set original(t){this._graph=t}get clipOverrides(){return this._clipOverrides}},s(N5.prototype,"original",[z5],Object.getOwnPropertyDescriptor(N5.prototype,"original"),N5.prototype),U5=Qo(N5.prototype,"_graph",[va],(function(){return null})),V5=Qo(N5.prototype,"_clipOverrides",[va],(function(){return new q5})),k5=N5))||k5),q5=oa(`${uY}ClipOverrideMap`)((M5=Symbol.iterator,G5=class{constructor(){this._entries=W5&&W5()}get size(){return this._entries.length}[M5](){return this._entries[Symbol.iterator]()}has(t){return!!this._entries.find((e=>{let{original:i}=e;return i===t}))}get(t){const e=this._entries.find((e=>{let{original:i}=e;return i===t}));return null==e?void 0:e.substitution}set(t,e){const i=this._entries.find((e=>{let{original:i}=e;return i===t}));if(i)i.substitution=e;else{const i=new j5;i.original=t,i.substitution=e,this._entries.push(i)}}delete(t){qt(this._entries,(e=>{let{original:i}=e;return i===t}))}clear(){this._entries.length=0}},W5=Qo(G5.prototype,"_entries",[va],(function(){return[]})),H5=G5))||H5;const X5=10;class Y5{static get BYTES_PER_ELEMENT(){return 80}constructor(t,e,i){this._data=void 0,this._data=void 0===t?new Float64Array:"number"==typeof t?new Float64Array(X5*t):new Float64Array(t,e,"number"==typeof i?X5*i:void 0)}get buffer(){return this._data.buffer}get byteLength(){return this._data.byteLength}get byteOffset(){return this._data.byteOffset}get length(){return this._data.length/X5}getTransform(t,e){const{_data:i}=this,{position:s,rotation:r,scale:n}=e,o=X5*t;return Ki.fromArray(s,i,o),ys.fromArray(r,i,o+3),Ki.fromArray(n,i,o+7),e}getPosition(t,e){const{_data:i}=this,s=X5*t;return Ki.fromArray(e,i,s),e}getRotation(t,e){const{_data:i}=this,s=X5*t;return ys.fromArray(e,i,s+3),e}getScale(t,e){const{_data:i}=this,s=X5*t;return Ki.fromArray(e,i,s+7),e}setTransform(t,e){const{_data:i}=this,{position:s,rotation:r,scale:n}=e,o=X5*t;Ki.toArray(i,s,o),ys.toArray(i,r,o+3),Ki.toArray(i,n,o+7)}setPosition(t,e){const{_data:i}=this,s=X5*t;Ki.toArray(i,e,s)}setRotation(t,e){const{_data:i}=this,s=X5*t;ys.toArray(i,e,s+3)}setScale(t,e){const{_data:i}=this,s=X5*t;Ki.toArray(i,e,s+7)}copyWithin(t,e,i){this._data.copyWithin(t*X5,e*X5,"number"==typeof i?i*X5:void 0)}fill(t,e,i){var s,r;const{length:n}=this;if(null!==(s=e)&&void 0!==s||(e=0),null!==(r=i)&&void 0!==r||(i=n),!(e>=n)){this.setTransform(e,t);for(let t=e+1;t<i;++t)this.copyWithin(t,e,e+1)}}fillZero(t,e){this._data.fill(0,"number"==typeof t?t*X5:void 0,"number"==typeof e?e*X5:void 0)}set(t,e){this._data.set(t._data,"number"==typeof e?e*X5:void 0)}slice(t,e){const i=this._data.slice("number"==typeof t?t*X5:void 0,"number"==typeof e?e*X5:void 0);return new Y5(i.buffer,i.byteOffset,i.length/X5)}copyRange(t,e,i,s){const r=X5*s,n=this._data,o=X5*t,a=e._data,h=X5*i;for(let t=0;t<r;++t)n[o+t]=a[h+t]}}const Q5=Symbol(""),K5=Symbol("");class Z5{constructor(t){this.buffer=void 0,this.useCount=0,this.buffer=new ArrayBuffer(t)}}class J5{constructor(t,e){this._locking=!1,this._pages=[],this._allocatorCount=0,this._manager=t,this._pageSize=e}get pageSize(){return this._pageSize}get debugLocking(){return this._locking}get allocatorCount(){return this._allocatorCount}debugLock(){this._locking,this._locking=!0}debugUnlock(){this._locking,this._locking=!1}getPageMemory(t){return t>=0&&this._pages.length,this._pages[t].buffer}pushPage(t){const e=t[Q5];this._pages.length,e===this._pages.length&&this._pushNewPage(),this._pages.length;const i=this._pages[e];return++i.useCount,++t[Q5],i}popPage(t){const e=t[Q5]-1,i=this._pages[e];i.useCount,--i.useCount,--t[Q5],0===i.useCount&&(this._pages.length,this._pages.pop())}createAllocator(t){const e=new e6(this,t);return++this._allocatorCount,e}destroyAllocator(t){const e=t[Q5];for(let t=0;t<e;++t){const e=this._pages[t];e.useCount,--e.useCount}this._allocatorCount,--this._allocatorCount,0===this._allocatorCount&&this._manager[K5](this)}_pushNewPage(){const t=new Z5(this._pageSize);this._pages.push(t)}}class t6{constructor(t,e){this.buffer=t,this.byteOffset=e}}class e6{constructor(t,e){this[Q5]=0,this._slicesPerPage=0,this._slices=[],this._resource=t,this._sliceSize=e;const i=Math.floor(this._resource.pageSize/e);this._slicesPerPage=i}get isEmpty(){return 0===this._slices.length}destroy(){this._slices.length,this._resource.debugLocking,this._resource.destroyAllocator(this)}debugLock(){this._resource.debugLock()}debugUnlock(){this._resource.debugUnlock()}push(){const{_sliceSize:t,_slices:e,_slicesPerPage:i}=this,s=e.length;let r=0,n=0;0===t?(0===this[Q5]&&this._resource.pushPage(this),this[Q5]):(s===i*this[Q5]&&(this._resource.pushPage(this),this[Q5]),r=s%i,n=(s-r)/i,this[Q5]);const o=this._resource.getPageMemory(n),a=new t6(o,t*r);return this._slices.push(a),a}pop(){const{_slices:t,_slicesPerPage:e}=this,i=t.length-1;0===this._sliceSize?(this[Q5],0===i&&this._resource.popPage(this)):0==i%e&&this._resource.popPage(this),this._slices.pop()}}class i6{constructor(t,e){this._poses=[],this._allocatedCount=0,this._memoryAllocator=void 0,this._transformCount=t,this._auxiliaryCurveCount=e;const i=s6(t,e,1);this._memoryAllocator=n6.createAllocator(i)}destroy(){this._allocatedCount;for(let t=0;t<this._poses.length;++t)this._memoryAllocator.pop();return this._poses.length=0,this._memoryAllocator.destroy()}get allocatedCount(){return this._allocatedCount}push(){0===this._allocatedCount&&this._memoryAllocator.debugLock(),this._allocatedCount===this._poses.length&&(this._allocateNewPose(),this._allocatedCount,this._poses.length);const t=this._poses[this._allocatedCount];return++this._allocatedCount,t}pop(){this._allocatedCount,--this._allocatedCount,0===this._allocatedCount&&this._memoryAllocator.debugUnlock()}get top(){return this._allocatedCount,this._poses[this._allocatedCount-1]}_allocateNewPose(){const t=this._memoryAllocator.push(),e=Y5.BYTES_PER_ELEMENT*this._transformCount,i=t.byteOffset,s=new Y5(t.buffer,i,this._transformCount),r=new Float64Array(t.buffer,i+e,this._auxiliaryCurveCount),n=d3._create(s,r);this._poses.push(n)}}function s6(t,e,i){return(Y5.BYTES_PER_ELEMENT*t+8*e)*i}const r6=s6(128,10,4),n6=new class{constructor(t){this._stacks=new Map,this._thresholds=t,t.every(((t,e,i)=>0===e||t>i[e-1]))}get isEmpty(){return 0===this._stacks.size}createAllocator(t){const e=t,i=this._selectStackPageSize(e);let s=this._stacks.get(i);return s||(s=new J5(this,i),this._stacks.set(i,s)),s.createAllocator(e)}[K5](t){for(const[e,i]of this._stacks)if(i===t){this._stacks.delete(e);break}}_selectStackPageSize(t){let e=Go(this._thresholds,t),i=t;return e>=0?i=this._thresholds[e]:(e=~e,e===this._thresholds.length||(e>=0&&this._thresholds.length,i=this._thresholds[e])),i}}([r6]);function o6(t,e){const i=t.length;let s=0;for(;s<i&&e(t[s],s,t);++s);if(s===i)return i;let r=s;for(let n=s+1;n<i;++n){const i=t[n];if(e(i,n,t)){const e=i;t[n]=t[r],t[r]=e,++r}}return r}const a6=Symbol("PoseHeapAllocator");class h6{constructor(t,e){this._transformCount=0,this._metaValueCount=0,this._pages=[],this._allocatedCount=0,this._foremostPossibleFreePage=0,this._transformCount=t,this._metaValueCount=e}get allocatedCount(){return this._allocatedCount}allocatePose(){++this._allocatedCount;const{_pages:t}=this,e=t.length;for(let i=this._foremostPossibleFreePage;i<e;++i){const e=t[i],s=e.tryAllocate();if(s)return s[a6].pageIndex=i,0===e.freeCount&&++this._foremostPossibleFreePage,s}const i=this._allocatePoseInNewPage();return this._foremostPossibleFreePage=i[a6].pageIndex,i}destroyPose(t){const{_pages:e}=this;e.length;const i=t[a6].pageIndex,s=e[i];s.deallocate(t),--this._allocatedCount,i<this._foremostPossibleFreePage&&(s.freeCount,this._foremostPossibleFreePage=i)}_allocatePoseInNewPage(){const t=new d6(this._transformCount,this._metaValueCount,4),e=this._pages.length;this._pages.push(t);const i=t.tryAllocate();return i[a6].pageIndex=e,i}}class l6{constructor(){this._id=-1}get pageIndex(){return this._id>>u6}set pageIndex(t){this._id&=c6,this._id|=t<<u6}get poseIndex(){return this._id&c6}set poseIndex(t){this._id&=~c6,this._id|=t}}const c6=7,u6=3;class d6{constructor(t,e,i){this._buffer=void 0,this._idleFlags=15,this._poses=void 0,this._freeCount=0,this._transformCount=t,this._metaValueCount=e,this._capacity=i;const s=(Y5.BYTES_PER_ELEMENT*t+8*e)*i;this._buffer=new ArrayBuffer(s),this._poses=new Array(i).fill(null),this._freeCount=i}get capacity(){return this._capacity}get freeCount(){return this._freeCount}tryAllocate(){var t;const{_poses:e,_idleFlags:i,_capacity:s}=this,r=p6(i);if(r>=s)return null;r>=0&&e.length;const n=null!==(t=e[r])&&void 0!==t?t:e[r]=this._createPose(r);return n[a6].poseIndex=r,this._idleFlags&=~(1<<r),this._freeCount,--this._freeCount,n}deallocate(t){const{_poses:e}=this,i=t[a6].poseIndex;i>=0&&e.length,e[i],this._idleFlags|=1<<i,this._freeCount,this._capacity,++this._freeCount}_createPose(t){const e=Y5.BYTES_PER_ELEMENT*this._transformCount,i=(e+8*this._metaValueCount)*t,s=new Y5(this._buffer,i,this._transformCount),r=new Float64Array(this._buffer,i+e,this._metaValueCount),n=d3._create(s,r);return n[a6]=new l6,n}}function p6(t){return 0===t?1/0:Math.log2(t&-t)}var _6,g6,f6,m6,y6,v6,b6,w6;function S6(t,e){if(t.name===e)return t;const i=t.children.length;for(let s=0;s<i;++s){const i=S6(t.children[s],e);if(i)return i}return null}class x6{constructor(t,e,i,s){this._origin=void 0,this._layoutMaintainer=void 0,this._varRegistry=void 0,this._additiveFlagStack=[],this._triggerResetter=t=>this._resetTrigger(t),this._isLayerWideContextPropertiesSet=!1,this._stashView=void 0,this._motionSyncManager=void 0,this._clipOverrides=void 0,this._controller=s,this._origin=t,this._layoutMaintainer=e,this._varRegistry=i,this._additiveFlagStack=[!1]}get origin(){return this._origin}get controller(){return this._controller}get triggerResetter(){return this._triggerResetter}get clipOverrides(){return this._clipOverrides}get additive(){const{_additiveFlagStack:t}=this;return t[t.length-1]}bindTransform(t){const e=this._origin.getChildByPath(t);return e?this._layoutMaintainer.getOrCreateTransformBinding(e):null}bindTransformByName(t){const e=S6(this._origin,t);return e?this._layoutMaintainer.getOrCreateTransformBinding(e):null}getBoneChildren(t){const e=S6(this._origin,t);return e?e.children.map((t=>t.name)):[]}getParentBoneNameByName(t){var e;const i=S6(this._origin,t);return i?i===this._origin?"":null===(e=i.parent)||void 0===e?void 0:e.name:null}bindAuxiliaryCurve(t){return this._layoutMaintainer.getOrCreateAuxiliaryCurveBinding(t)}getEvaluationTimeAuxiliaryCurveView(){return this._layoutMaintainer.auxiliaryCurveRegistry}getVar(t){return this._varRegistry[t]}_pushAdditiveFlag(t){this._additiveFlagStack.push(t)}_popAdditiveFlag(){this._additiveFlagStack.length,this._additiveFlagStack.pop()}_integrityCheck(){return 1===this._additiveFlagStack.length}get stashView(){return this._stashView,this._stashView}get motionSyncManager(){return this._motionSyncManager,this._motionSyncManager}_setLayerWideContextProperties(t,e){this._isLayerWideContextPropertiesSet,this._isLayerWideContextPropertiesSet=!0,this._stashView=t,this._motionSyncManager=e}_unsetLayerWideContextProperties(){this._isLayerWideContextPropertiesSet,this._isLayerWideContextPropertiesSet=!1,this._stashView=void 0,this._motionSyncManager=void 0}_setClipOverrides(t){this._clipOverrides=t}_resetTrigger(t){const e=this._varRegistry[t];e&&(e.value=!1)}}const T6=new o3;class C6{constructor(){this._namedCurves=new Map}names(){return this._namedCurves.keys()}has(t){return this._namedCurves.has(t)}get(t){var e;return null!==(e=this._namedCurves.get(t))&&void 0!==e?e:0}set(t,e){this._namedCurves.set(t,e)}}let I6=(_6=()=>{},g6=()=>{},f6=()=>{},m6=()=>{},y6=()=>{},v6=()=>{},b6=()=>{},w6=class{constructor(t,e){this._origin=void 0,this._auxiliaryCurveRegistry=void 0,this._auxiliaryCurveRecords=[],this._transformRecords=[],this._parentTable=[],this._bindStarted=!1,this._transformCountBeforeBind=-1,this._auxiliaryCurveCountBeforeBind=-1,this._origin=t,this._auxiliaryCurveRegistry=e}get transformCount(){return this._transformRecords.length}get auxiliaryCurveCount(){return this._auxiliaryCurveRecords.length}get auxiliaryCurveRegistry(){return this._auxiliaryCurveRegistry}getOrCreateTransformBinding(t){const{_origin:e}=this;let i=!1;for(let s=t;s;s=s.parent)if(s===e){i=!0;break}if(!i)return null;const s=this._getOrCreateTransformBinding(t);if(t!==e)for(let i=t.parent;i!==e;i=i.parent)this._getOrCreateTransformBinding(i);return s}_getOrCreateTransformBinding(t){const{_transformRecords:e}=this,i=e.findIndex((e=>e.node===t));if(i>=0){const t=e[i];return++t.refCount,t.handle}let s=0;for(let i=t.parent;i;i=i.parent){const t=e.findIndex((t=>t.node===i));if(t>=0){s=t+1;break}}for(let t=s;t<e.length;++t)++e[t].handle.index;const r=new E6(new L6(this,s),t);return e.splice(s,0,r),r.handle}getOrCreateAuxiliaryCurveBinding(t){const{_auxiliaryCurveRecords:e}=this,i=e.findIndex((e=>e.name===t));if(i>=0){const t=e[i];return++t.refCount,t.handle}{const i=e.length,s=new D6(new F6(this,i),t);return e.push(s),s.handle}}createEvaluationContext(){return this._bindStarted,new O6(this.transformCount,this.auxiliaryCurveCount,this._parentTable.slice(),this._origin)}resetPoseStashAllocator(t){this._bindStarted,t._reset(this.transformCount,this.auxiliaryCurveCount)}createTransformFilter(t){const{_origin:e}=this,i=[];for(const{node:r,handle:n}of this._transformRecords){const o=s(e,r);if(void 0===o)B(`${r.getPathInHierarchy()} is not a child of ${e.getPathInHierarchy()}`);else if(t.isExcluded(o))continue;i.push(n.index)}return i.sort(),new p3(i);function s(t,e){const i=[];for(let s=e;s;s=s.parent){if(s===t)return i.join("/");i.unshift(s.name)}}}fetchDefaultTransforms(t){const e=this._transformRecords.length;t.length;for(let i=0;i<e;++i){const{defaultTransform:e}=this._transformRecords[i];t.setTransform(i,e)}}apply(t){const{transforms:e,auxiliaryCurves:i}=t,s=this._transformRecords.length;e.length;for(let t=0;t<s;++t){const i=e.getTransform(t,T6),{node:s}=this._transformRecords[t];s.setRTS(i.rotation,i.position,i.scale)}const r=this._auxiliaryCurveRecords.length;for(let t=0;t<r;++t){const{name:e}=this._auxiliaryCurveRecords[t],s=i[t];this._auxiliaryCurveRegistry.set(e,s)}}_destroyTransformHandle(t){t>=0&&this._transformRecords.length;const e=this._transformRecords[t];e.refCount,--e.refCount}_destroyAuxiliaryCurveHandle(t){t>=0&&this._auxiliaryCurveRecords.length;const e=this._auxiliaryCurveRecords[t];e.refCount,--e.refCount}startBind(){this._bindStarted=!0,this._transformCountBeforeBind=this._transformRecords.length,this._auxiliaryCurveCountBeforeBind=this._auxiliaryCurveRecords.length}endBind(){const{_transformRecords:t,_auxiliaryCurveRecords:e}=this;let i=0;if(A6(t),t.length!==this._transformCountBeforeBind){i|=1;const e=t.length;for(let i=0;i<e;++i)t[i].order=i}else{const e=t.length;let s=!1;for(let i=0;i<e;++i){const e=t[i];e.order!==i&&(s=!0,e.order=i)}s&&(i|=2)}A6(e),e.length!==this._auxiliaryCurveCountBeforeBind&&(i|=4);const{_parentTable:s,_origin:r}=this;s.length=t.length;for(let e=0;e<t.length;++e){const{node:i}=t[e];if(i===r){s[e]=-1;continue}const n=i.parent;if(n===r){const i=t.findIndex((t=>t.node===n));s[e]=i>=0?i:-1}else{const i=t.findIndex((t=>t.node===n));s[e]=i}}return this._bindStarted=!1,i}},s(w6.prototype,"getOrCreateTransformBinding",[_6],Object.getOwnPropertyDescriptor(w6.prototype,"getOrCreateTransformBinding"),w6.prototype),s(w6.prototype,"_getOrCreateTransformBinding",[g6],Object.getOwnPropertyDescriptor(w6.prototype,"_getOrCreateTransformBinding"),w6.prototype),s(w6.prototype,"getOrCreateAuxiliaryCurveBinding",[f6],Object.getOwnPropertyDescriptor(w6.prototype,"getOrCreateAuxiliaryCurveBinding"),w6.prototype),s(w6.prototype,"_destroyTransformHandle",[m6],Object.getOwnPropertyDescriptor(w6.prototype,"_destroyTransformHandle"),w6.prototype),s(w6.prototype,"_destroyAuxiliaryCurveHandle",[y6],Object.getOwnPropertyDescriptor(w6.prototype,"_destroyAuxiliaryCurveHandle"),w6.prototype),s(w6.prototype,"startBind",[v6],Object.getOwnPropertyDescriptor(w6.prototype,"startBind"),w6.prototype),s(w6.prototype,"endBind",[b6],Object.getOwnPropertyDescriptor(w6.prototype,"endBind"),w6.prototype),w6);class E6{constructor(t,e){this.order=-1,this.refCount=1,this.handle=void 0,this.node=void 0,this.defaultTransform=void 0,this.handle=t,this.node=e;const i=new o3;i.position=e.position,i.rotation=e.rotation,i.scale=e.scale,this.defaultTransform=i}}class D6{constructor(t,e){this.refCount=1,this.handle=void 0,this.name=void 0,this.handle=t,this.name=e}}function A6(t){const e=o6(t,(t=>(t.refCount,t.refCount>0)));if(t.length,e!==t.length){for(let i=0;i<e;++i)t[i].handle.index=i;t.splice(e,t.length-e)}}const M6=Symbol("[[DefaultTransforms]]");class P6{constructor(t){this._layoutMaintainer=t}get transformCount(){return this._layoutMaintainer.transformCount}createTransformFilter(t){return this._layoutMaintainer.createTransformFilter(t)}}const B6=new o3,R6=new o3;class O6{constructor(t,e,i,s){this[M6]=void 0,this._poseAllocator=void 0,this._parentTable=void 0,this._componentNode=void 0,this._cacheComponentToWorldTransform=new o3,this._poseAllocator=new i6(t,e),this._parentTable=i,this._componentNode=s,this[M6]=new Y5(t)}destroy(){this._poseAllocator.destroy()}get allocatedPoseCount(){return this._poseAllocator.allocatedCount}get parentTable(){return this._parentTable}pushDefaultedPose(){const t=this._poseAllocator.push();return t.transforms.set(this[M6]),t._poseTransformSpace=0,t.auxiliaryCurves.fill(0),t}pushDefaultedPoseInComponentSpace(){const t=this.pushDefaultedPose();return this._poseTransformsSpaceLocalToComponent(t),t}pushZeroDeltaPose(){const t=this._poseAllocator.push();return t.transforms.fill(u3),t._poseTransformSpace=0,t.auxiliaryCurves.fill(0),t}pushDuplicatedPose(t){const e=this._poseAllocator.push();return e.transforms.set(t.transforms),e._poseTransformSpace=t._poseTransformSpace,e.auxiliaryCurves.set(t.auxiliaryCurves),e}popPose(){this._poseAllocator.pop()}get _stackSize_debugging(){return this._poseAllocator.allocatedCount}_isStackTopPose_debugging(t){return t===this._poseAllocator.top}_poseTransformsSpaceLocalToComponent(t){const{transforms:e}=t,{length:i}=e;for(let t=0;t<i;++t){const i=this._parentTable[t];if(i<0)continue;const s=e.getTransform(t,B6),r=e.getTransform(i,R6);o3.multiply(s,r,s),e.setTransform(t,s)}t._poseTransformSpace=1}_poseTransformsSpaceComponentToLocal(t){const{transforms:e}=t,{length:i}=e;for(let t=i-1;t>=0;--t){const i=this._parentTable[t];if(i<0)continue;const s=e.getTransform(t,B6),r=e.getTransform(i,R6);o3.calculateRelative(s,s,r),e.setTransform(t,s)}t._poseTransformSpace=0}_convertPoseSpaceTransformToTargetSpace(t,e,i,s){const r=i._poseTransformSpace;switch(e){default:break;case 0:1===r?o3.multiply(t,this._getComponentToWorldTransform(),t):o3.multiply(t,this._getLocalToWorldTransform(R6,i,s),t);break;case 1:1===r||o3.multiply(t,this._getLocalToComponentTransform(R6,i,s),t);break;case 2:if(1===r){const e=this._parentTable[s];if(e>=0){const s=i.transforms.getTransform(e,R6),r=o3.invert(s,s);o3.multiply(t,r,t)}}break;case 3:{const e=i.transforms.getTransform(s,R6),r=o3.invert(e,e);o3.multiply(t,r,t);break}}return t}_convertTransformToPoseTransformSpace(t,e,i,s){const r=i._poseTransformSpace;switch(e){default:break;case 0:if(1===r){const e=o3.invert(R6,this._getComponentToWorldTransform());o3.multiply(t,e,t)}else{const e=this._getLocalToWorldTransform(R6,i,s),r=o3.invert(e,e);o3.multiply(t,r,t)}break;case 1:if(1===r);else{const e=this._getLocalToComponentTransform(R6,i,s),r=o3.invert(e,e);o3.multiply(t,r,t)}break;case 2:if(1===r){const e=this._parentTable[s];if(e>=0){const s=i.transforms.getTransform(e,R6);o3.multiply(t,s,t)}}break;case 3:{const e=i.transforms.getTransform(s,R6);o3.multiply(t,e,t);break}}return t}_getComponentToWorldTransform(){const t=this._cacheComponentToWorldTransform,e=this._componentNode;return t.position=e.worldPosition,t.rotation=e.worldRotation,t.scale=e.worldScale,t}_getLocalToComponentTransform(t,e,i){const{_parentTable:s}=this;o3.setIdentity(t);for(let r=s[i];r>=0;r=s[r]){const i=e.transforms.getTransform(r,B6);o3.multiply(t,i,t)}return t}_getLocalToWorldTransform(t,e,i){return this._getLocalToComponentTransform(t,e,i),o3.multiply(t,this._getComponentToWorldTransform(),t),t}}class L6{constructor(t,e){this.index=-1,this._host=void 0,this._host=t,this.index=e}destroy(){this._host._destroyTransformHandle(this.index)}}class F6{constructor(t,e){this.index=-1,this._host=void 0,this._host=t,this.index=e}destroy(){this._host._destroyAuxiliaryCurveHandle(this.index)}}class z6{constructor(){this._context={deltaTime:0,indicativeWeight:0}}generate(t,e){return this._context.deltaTime=t,this._context.indicativeWeight=e,this._context}forkSubWeight(t,e){this._context.deltaTime=t.deltaTime,this._context.indicativeWeight=t.indicativeWeight*e}}class k6{constructor(){this._allocator=null}get allocatedPoseCount(){return this._allocator,this._allocator.allocatedCount}_reset(t,e){this._allocator=new h6(t,e)}allocatePose(){return this._allocator,this._allocator.allocatePose()}destroyPose(t){return this._allocator,this._allocator.destroyPose(t)}}var N6,U6,V6,H6;const{ccclass:G6,serializable:W6}=Ja;G6(`${uY}UnaryCondition`)((H6=class t{constructor(){this.operator=U6&&U6(),this.operand=V6&&V6()}clone(){const e=new t;return e.operator=this.operator,e.operand=this.operand.clone(),e}[G0](t){const{operator:e,operand:i}=this,s=new j6(e,!1),r=T4(t,i,1,s.setOperand,s);return s.reset(r),s}},H6.Operator={TRUTHY:0,FALSY:1},U6=Qo((N6=H6).prototype,"operator",[W6],(function(){return 0})),V6=Qo(N6.prototype,"operand",[W6],(function(){return new x4})),N6));class j6{constructor(t,e){this._operator=t,this._operand=e,this._eval()}reset(t){this.setOperand(t)}setOperand(t){this._operand=t,this._eval()}eval(){return this._result}_eval(){const{_operand:t}=this;switch(this._operator){default:case 0:this._result=!!t;break;case 1:this._result=!t}}}class $6{}const q6=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return()=>{}};var X6,Y6,Q6,K6;const{ccclass:Z6,serializable:J6}=Ja;let t8=Z6(`${uY}TCVariableBinding`)(X6=q6(0,3)((Y6=class extends $6{constructor(){super(...arguments),this.type=Q6&&Q6(),this.variableName=K6&&K6()}getValueType(){return this.type}bind(t){const e=t.getVar(this.variableName);if(e)return new e8(e)}},Q6=Qo(Y6.prototype,"type",[J6,wa],(function(){return 0})),K6=Qo(Y6.prototype,"variableName",[J6],(function(){return""})),X6=Y6))||X6)||X6;class e8{constructor(t){this._varInstance=t}evaluate(){return this._varInstance.value}}var i8,s8,r8;const{ccclass:n8,serializable:o8}=Ja;n8(`${uY}TCAuxiliaryCurveBinding`)(i8=q6(0)((s8=class extends $6{constructor(){super(...arguments),this.curveName=r8&&r8()}getValueType(){return 0}bind(t){const e=t.getEvaluationTimeAuxiliaryCurveView();return new a8(e,this.curveName)}},r8=Qo(s8.prototype,"curveName",[o8],(function(){return""})),i8=s8))||i8);class a8{constructor(t,e){this._view=t,this._curveName=e}evaluate(){return this._view.get(this._curveName)}}var h8;const{ccclass:l8}=Ja;l8(`${uY}TCStateWeightBinding`)(h8=q6(0)(h8=void(h8=class extends $6{getValueType(){return 0}bind(t){return new c8}})||h8)||h8);class c8{evaluate(t){return t.sourceStateWeight}}var u8;const{ccclass:d8}=Ja;d8(`${uY}TCStateMotionTimeBinding`)(u8=q6(0)(u8=void(u8=class extends $6{getValueType(){return 0}bind(t){return new p8}})||u8)||u8);class p8{evaluate(t){return t.sourceStateMotionTimeNormalized}}var _8,g8,f8,m8,y8,v8;const{ccclass:b8,serializable:w8}=Ja;b8(`${uY}BinaryCondition`)((v8=class t{constructor(){this.operator=g8&&g8(),this.lhs=f8&&f8(),this.lhsBinding=m8&&m8(),this.rhs=y8&&y8()}clone(){const e=new t;return e.operator=this.operator,e.lhs=this.lhs,e.lhsBinding=rZ(this.lhsBinding),e.rhs=this.rhs,e}[G0](t){var e;const i=null===(e=this.lhsBinding)||void 0===e?void 0:e.bind(t);return new S8(this.operator,this.lhs,this.rhs,i)}},v8.Operator={EQUAL_TO:0,NOT_EQUAL_TO:1,LESS_THAN:2,LESS_THAN_OR_EQUAL_TO:3,GREATER_THAN:4,GREATER_THAN_OR_EQUAL_TO:5},g8=Qo((_8=v8).prototype,"operator",[w8],(function(){return 0})),f8=Qo(_8.prototype,"lhs",[w8],(function(){return 0})),m8=Qo(_8.prototype,"lhsBinding",[w8],(function(){return new t8})),y8=Qo(_8.prototype,"rhs",[w8],(function(){return 0})),_8));class S8{constructor(t,e,i,s){this._operator=t,this._lhsBindingEvaluation=s,this._lhsValue=e,this._rhsValue=i}eval(t){var e,i;const s=null!==(e=null===(i=this._lhsBindingEvaluation)||void 0===i?void 0:i.evaluate(t))&&void 0!==e?e:this._lhsValue,r=this._rhsValue;switch(this._operator){default:case 0:return s===r;case 1:return s!==r;case 2:return s<r;case 3:return s<=r;case 4:return s>r;case 5:return s>=r}}}var x8,T8,C8;const{ccclass:I8,serializable:E8}=Ja;let D8=I8(`${uY}TriggerCondition`)((T8=class t{constructor(){this.trigger=C8&&C8()}clone(){const e=new t;return e.trigger=this.trigger,e}[G0](t){const e=new A8(!1),i=t.getVar(this.trigger);return C4(i,this.trigger)&&(E4(i.type,this.trigger),e.setTrigger(i.bind(e.setTrigger,e))),e}},C8=Qo(T8.prototype,"trigger",[E8],(function(){return""})),x8=T8))||x8;class A8{constructor(t){this._triggered=!1,this._triggered=t}setTrigger(t){this._triggered=t}eval(){return this._triggered}}var M8;let P8=oa(`${uY}StateMachineComponent`)(M8=class{onMotionStateEnter(t,e){}onMotionStateExit(t,e){}onMotionStateUpdate(t,e){}onStateMachineEnter(t){}onStateMachineExit(t){}})||M8;var B8,R8,O8;let L8=oa(`${uY}MotionSyncInfo`)((R8=class{constructor(){this.group=O8&&O8()}},O8=Qo(R8.prototype,"group",[va],(function(){return""})),B8=R8))||B8;var F8,z8,k8,N8,U8,V8,H8,G8,W8,j8,$8,q8;const X8=1e-5;let Y8=(F8=oa(`${uY}PoseNodePlayMotion`),z8=sJ((t=>{t.category="i18n:ENGINE.animation_graph.pose_graph_node_sub_categories.pose_nodes/"})),k8=(t=>sJ((e=>{e.factory=t})))((Q8=t=>{const e=new Y8;return e.motion=t,e},{listEntries:()=>[{arg:{type:"clip-motion"},menu:"i18n:ENGINE.animation_graph.pose_graph_node_sub_menus.play_or_sample_clip_motion"},{arg:{type:"animation-blend-1d"},menu:"i18n:ENGINE.animation_graph.pose_graph_node_sub_menus.play_or_sample_animation_blend_1d"},{arg:{type:"animation-blend-2d"},menu:"i18n:ENGINE.animation_graph.pose_graph_node_sub_menus.play_or_sample_animation_blend_2d"}],create:t=>{let e=null;switch(t.type){case"clip-motion":e=new Q3;break;case"animation-blend-1d":e=new U4;break;case"animation-blend-2d":e=new l5}return Q8(e)}})),N8=rJ({themeColor:"#227F9B"}),U8=dJ({type:0}),V8=dJ({type:0}),F8(H8=z8(H8=k8(H8=N8((G8=class extends cJ{constructor(){super(...arguments),this.motion=W8&&W8(),this.syncInfo=j8&&j8(),i(this,"startTime",$8,this),i(this,"speedMultiplier",q8,this),this._workspace=null,this._runtimeSyncRecord=void 0}get lastIndicativeWeight(){var t,e;return null!==(t=null===(e=this._workspace)||void 0===e?void 0:e.lastIndicativeWeight)&&void 0!==t?t:0}get elapsedMotionTime(){var t,e;return null!==(t=null===(e=this._workspace)||void 0===e?void 0:e.normalizedTime)&&void 0!==t?t:0}bind(t){const{motion:e}=this;if(!e)return;const i=e[G0](t,!1);i&&(this._workspace=new K8(i,i.createPort()),this.syncInfo.group&&(this._runtimeSyncRecord=t.motionSyncManager.register(this.syncInfo)))}settle(t){}reenter(){if(this._workspace){const{_runtimeSyncRecord:t,_workspace:{motionEval:{duration:e}}}=this;this._forceEvaluateEvaluation();const i=e<X8?0:mi(this.startTime/e);t?t.notifyRenter(i):this._workspace.normalizedTime=i,this._workspace.lastIndicativeWeight=0}}doUpdate(t){if(this._workspace){const{deltaTime:e}=t,{_runtimeSyncRecord:i}=this,s=this._workspace.motionEval.duration;let r=0;s>X8&&(r=e*this.speedMultiplier/s),i?i.notifyUpdate(r,t.indicativeWeight):this._workspace.normalizedTime+=r,this._workspace.lastIndicativeWeight=t.indicativeWeight}}doEvaluate(t){if(this._workspace){const e=this._runtimeSyncRecord?this._runtimeSyncRecord.getSyncedEnterTime():this._workspace.normalizedTime;return this._workspace.motionEvalPort.evaluate(e,t)}return t.pushDefaultedPose()}},W8=Qo(G8.prototype,"motion",[va],(function(){return new Q3})),j8=Qo(G8.prototype,"syncInfo",[va],(function(){return new L8})),$8=s(G8.prototype,"startTime",[va,U8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),q8=s(G8.prototype,"speedMultiplier",[va,V8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),H8=G8))||H8)||H8)||H8)||H8);var Q8;class K8{constructor(t,e){this.normalizedTime=0,this.lastIndicativeWeight=0,this.motionEval=t,this.motionEvalPort=e}}function Z8(t){return t instanceof cJ||t instanceof uJ}class J8{constructor(t,e){this._rootPoseNode=t,this._countingPlayMotionNodes=e}bind(t){var e;null===(e=this._rootPoseNode)||void 0===e||e.bind(t)}settle(t){var e;null===(e=this._rootPoseNode)||void 0===e||e.settle(t)}reenter(){var t;null===(t=this._rootPoseNode)||void 0===t||t.reenter()}update(t){var e;null===(e=this._rootPoseNode)||void 0===e||e.update(t)}evaluate(t){var e,i;return null!==(e=null===(i=this._rootPoseNode)||void 0===i?void 0:i.evaluate(t,1))&&void 0!==e?e:null}countMotionTime(){const{_countingPlayMotionNodes:t}=this;if(!t)return 0;let e=0,i=Number.NEGATIVE_INFINITY;for(let s=0;s<t.length;++s){const{elapsedMotionTime:r,lastIndicativeWeight:n}=t[s];n>i&&(i=n,e=r)}return e}}function t7(t,e,i){void 0===i&&(i=!1);const{outputNode:s}=t,r=t.getShell(s).getBindings();if(r.length,0===r.length)return new J8(void 0,i?[]:void 0);const n=r[0];n.outputIndex,n.producer;const o=new Map,a=e7(t,n.producer,o,e);return new J8(a,i?Array.from(o.values()).filter((t=>t instanceof Y8)):void 0)}function e7(t,e,i,s){const r=t.getShell(e),n=i.get(e);if(n)return n;const o=rZ(e);"__callOnAfterDeserializeRecursive"in o&&o.__callOnAfterDeserializeRecursive(),o instanceof uJ&&o.link(s);const a=o,h=[];for(const{producer:e,outputIndex:n,inputPath:o}of r.getBindings()){if(!Z8(e)){P("There's a input bound to a node with unrecognized type.");continue}const r=e7(t,e,i,s);if(r instanceof cJ)r7(a,o,r,n);else{const t=a7(a,o,r,n);t&&h.push(t)}}const l=new i7(h);let c;return a instanceof cJ?(a._setDependencyEvaluation(l),c=a):c=new s7(a,l),i.set(e,c),c}class i7{constructor(t){this._bindingEvaluations=void 0,this._bindingEvaluations=t}evaluate(){const{_bindingEvaluations:t}=this;for(const e of t)e.evaluate()}}class s7{constructor(t,e){this._outputs=void 0,this._node=t,this._dependency=e,this._outputs=new Array(t.outputCount)}get node(){return this._node}get outputCount(){return this._outputs.length}getDefaultOutput(){return this.getOutput(0)}getOutput(t){return this._outputs[t]}evaluate(){const{_node:t,_dependency:e}=this;e.evaluate(),t.selfEvaluate(this._outputs)}}function r7(t,e,i,s){const[r,n=-1]=e;if(!(r in t))return void P(`Invalid binding: consumer node has no property ${r}`);if(0!==s)return void P(`Node ${i.toString()} does not have specified output ${s}.`);const o=t[r];if(n<0)return null!==o?void P(`Invalid binding: consumer node's input ${r} should be leaved as evaluation before evaluation.`):void(t[r]=i);Array.isArray(o)?n>=o.length?P(`Invalid binding: consumer node's input ${r} have length ${o.length} but the binding specified ${n}`):null===o[n]?o[n]=i:P(`Invalid binding: consumer node's input ${r}[${n}] should be leaved as null before evaluation`):P(`Invalid binding: consumer node's input ${r} should be an array.`)}class n7{constructor(t,e,i,s){this._consumerNode=t,this._consumerPropertyKey=e,this._producerRecord=i,this._producerOutputIndex=s}evaluate(){this._producerRecord.evaluate(),this._consumerNode[this._consumerPropertyKey]=this._producerRecord.getOutput(this._producerOutputIndex)}}class o7{constructor(t,e,i,s,r){this._consumerNode=t,this._consumerPropertyKey=e,this._consumerElementIndex=i,this._producerRecord=s,this._producerOutputIndex=r}evaluate(){this._producerRecord.evaluate(),this._consumerNode[this._consumerPropertyKey][this._consumerElementIndex]=this._producerRecord.getOutput(this._producerOutputIndex)}}function a7(t,e,i,s){const[r,n=-1]=e;if(!(r in t))return void P(`Invalid binding: consumer node has no property ${r}`);const o=t[r];if(n<0)return new n7(t,r,i,s);if(Array.isArray(o)){if(!(n>=o.length))return new o7(t,r,n,i,s);P(`Invalid binding: consumer node's input ${r} have length ${o.length} but the binding specified ${n}`)}else P(`Invalid binding: consumer node's input ${r} should be an array.`)}class h7{constructor(t,e,i){this.passthroughWeight=1,this._motionStates=[],this._proceduralPoseStates=[],this._topLevelEntry=void 0,this._topLevelExit=void 0,this._currentNode=void 0,this._pendingTransitionPath=[],this._activatedTransitions=[],this._activatedTransitionPool=x7.createPool(4),this._updateContextGenerator=new z6,this._conditionEvaluationContext=new S7,this._additive=!1,this._additive=i.additive,this.name=e,this._controller=i.controller;const{entry:s,exit:r}=this._addStateMachine(t,null,i,e);this._topLevelEntry=s,this._topLevelExit=r,this._currentNode=s,s.increaseActiveReference(),this._resetTrigger=i.triggerResetter}get exited(){return this._currentNode===this._topLevelExit}settle(t){const{_proceduralPoseStates:e}=this,i=e.length;for(let s=0;s<i;++s)e[s].settle(t)}reenter(){for(const t of this._activatedTransitions)t.destination.decreaseActiveReference(),this._activatedTransitionPool.free(t);this._activatedTransitions.length=0,this._topLevelEntry.increaseActiveReference(),this._currentNode.decreaseActiveReference(),this._currentNode=this._topLevelEntry}update(t){this.exited,this._loopMatchTransitions(),this._resetStateTickFlagsAndWeights(),this._updateActivatedTransitions(t.deltaTime),this._commitStateUpdates(t)}evaluate(t){return this._sample(t)||this._pushNullishPose(t)}getCurrentStateStatus(){const{_currentNode:t}=this;return 3===t.kind||5===t.kind?t.getStatus():null}getCurrentClipStatuses(){const{_currentNode:t}=this;return 3===t.kind?t.getClipStatuses(t.absoluteWeight):u7}getCurrentTransition(t){const{_activatedTransitions:e}=this;if(0===e.length)return!1;const i=e[e.length-1],s=1===e.length?this._currentNode:e[e.length-2].destination,r=i.getAbsoluteDuration(s);return t.duration=r,t.time=i.normalizedElapsedTime*r,!0}getNextStateStatus(){const{_activatedTransitions:t}=this;if(0===t.length)return null;const e=t[t.length-1].destination;switch(e.kind){default:break;case 5:case 3:return e.getStatus()}return null}getNextClipStatuses(){var t;const{_activatedTransitions:e}=this;if(0===e.length)return u7;const i=e[e.length-1],s=i.destination;return 3===s.kind&&null!==(t=s.getClipStatuses(i.destination.absoluteWeight))&&void 0!==t?t:u7}overrideClips(t){const{_motionStates:e}=this,i=e.length;for(let s=0;s<i;++s)e[s].overrideClips(t)}_addStateMachine(t,e,i,s){const r=Array.from(t.states());let n,o,a;const h=r.map((e=>{if(e instanceof LZ){const t=new g7(e,i);return this._motionStates.push(t),t}if(e===t.entryState)return n=new v7(e,0,e.name);if(e===t.exitState)return a=new v7(e,1,e.name);if(e===t.anyState)return o=new v7(e,2,e.name);if(e instanceof B0)return new b7(e);if(e instanceof L0){const t=new w7(e,i);return this._proceduralPoseStates.push(t),t}return null})),l={components:null,parent:e,entry:n,exit:a,any:o};for(let t=0;t<r.length;++t){const e=h[t];e&&(e.stateMachine=l)}const c=r.map((t=>{if(t instanceof N0){const e=this._addStateMachine(t.stateMachine,l,i,`${s}/${t.name}`);return e.components=new _7(t),e}return null}));for(let e=0;e<r.length;++e){const s=r[e],n=t.getOutgoings(s);let o;o=s instanceof N0?c[e].exit:h[e];for(const t of n){const e=t.to,s=r.findIndex((e=>e===t.to));let n;if(e instanceof N0)n=c[s].entry;else{const t=h[s];n=t instanceof g7?t.entry:t}const a={conditions:t.conditions.map((t=>t[G0](i))),to:n,triggers:void 0,duration:0,normalizedDuration:!1,destinationStart:0,relativeDestinationStart:!1,exitCondition:0,exitConditionEnabled:!1,activated:!1,startEventBinding:void 0,endEventBinding:void 0};(P0(t)||t instanceof R0||t instanceof z0)&&(a.duration=t.duration,a.destinationStart=t.destinationStart,a.relativeDestinationStart=t.relativeDestinationStart,t.startEventBinding.isBound&&(a.startEventBinding=t.startEventBinding),t.endEventBinding.isBound&&(a.endEventBinding=t.endEventBinding),P0(t)&&(a.normalizedDuration=t.relativeDuration,a.exitConditionEnabled=t.exitConditionEnabled,a.exitCondition=t.exitCondition)),a.conditions.forEach(((e,i)=>{const s=t.conditions[i];var r;s instanceof D8&&s.trigger&&(null!==(r=a.triggers)&&void 0!==r?r:a.triggers=[]).push(s.trigger)})),o.addTransition(a)}}return l}_loopMatchTransitions(){const{_pendingTransitionPath:t,_activatedTransitions:e}=this;t.length;let i=0===e.length?this._currentNode:e[e.length-1].destination;for(let e=0;;++e){if(e>=16){G(14e3,16,"");break}const s=this._matchNextTransition(i);if(!s)break;const r=s.to,n=i;if(i=r,l7(r)){if(r===n)break;this._activateTransition(t,s),t.length=0}else t.push(s)}t.length=0}_resetStateTickFlagsAndWeights(){const{_currentNode:t,_activatedTransitions:e}=this;t.resetTickFlagsAndWeight();for(let t=0;t<e.length;++t){const{destination:i}=e[t];i.resetTickFlagsAndWeight()}}_commitStateUpdates(t){const{_currentNode:e,_activatedTransitions:i,_updateContextGenerator:s}=this;this._commitStateUpdate(e,t);for(let e=0;e<i.length;++e){const s=i[e],{destination:r}=s;this._commitStateUpdate(r,t)}}_commitStateUpdate(t,e){const{_updateContextGenerator:i}=this;if(!t.testTickFlag(1))if(t.setTickFlag(1),3===t.kind)t.update(e.deltaTime,this._controller);else if(5===t.kind){const s=i.generate(e.deltaTime,e.indicativeWeight*t.absoluteWeight);t.update(s)}}_sample(t){const{_currentNode:e,_activatedTransitions:i}=this;let s=1,r=null,n=0;var o;if(3===e.kind)r=null!==(o=e.evaluate(t))&&void 0!==o?o:this._pushNullishPose(t);else if(5===e.kind){var a;r=null!==(a=e.evaluate(t))&&void 0!==a?a:this._pushNullishPose(t)}else s-=e.absoluteWeight,r=null;r&&(n=e.absoluteWeight),e.setTickFlag(2);for(let e=0;e<i.length;++e){const o=i[e],{destination:a}=o;if(a.testTickFlag(2))continue;a.setTickFlag(2);const l=a.absoluteWeight;let c;var h;4===a.kind?(s-=l,c=null):c=null!==(h=a.evaluate(t))&&void 0!==h?h:this._pushNullishPose(t),c&&(r?(n+=l,n?(_3(r,c,l/n),t.popPose()):r=c):r=c)}return this.passthroughWeight=s,r}_pushNullishPose(t){return this._additive?t.pushZeroDeltaPose():t.pushDefaultedPose()}_matchNextTransition(t){const e=this._matchTransition(t,t);if(e)return e;if(3===t.kind||5===t.kind){const e=this._matchAnyScoped(t);if(e)return e}return null}_matchAnyScoped(t){for(let e=t.stateMachine;null!==e;e=e.parent){const i=this._matchTransition(e.any,t);if(i)return i}return null}_matchTransition(t,e){t===e||t.kind;const{_conditionEvaluationContext:i}=this;i.set(e);const{outgoingTransitions:s}=t,r=s.length;for(let i=0;i<r;++i){const r=s[i];if(r.activated)continue;const{conditions:n}=r,o=n.length;if(0===o){if(0===t.kind||1===t.kind)return r;if(!r.exitConditionEnabled)continue}if(3===e.kind&&r.exitConditionEnabled){const t=e.duration*r.exitCondition;if(e.time<t)break}let a=!0;for(let t=0;t<o;++t)if(!n[t].eval(this._conditionEvaluationContext)){a=!1;break}if(a)return r}return null}_activateTransition(t,e){const i=e.to;l7(i);const s=this._activatedTransitionPool.alloc();s.reset(t,e),this._activatedTransitions.push(s);const r=s.path.length;for(let t=0;t<r;++t){const e=s.path[t];this._resetTriggersOnTransition(e)}for(let t=0;t<s.path.length;++t){const e=s.path[t];this._callEnterMethods(e.to)}this._activatedTransitions.length;const n=1===this._activatedTransitions.length?this._currentNode:this._activatedTransitions[this._activatedTransitions.length-2].destination;n instanceof p7&&n.transitionOutEventBinding&&this._emit(n.transitionOutEventBinding),e.startEventBinding&&this._emit(e.startEventBinding),i instanceof p7&&i.transitionInEventBinding&&this._emit(i.transitionInEventBinding)}_updateActivatedTransitions(t){const{_activatedTransitions:e}=this;let i=e.length-1,s=1,r=i;for(;i>=0;--i){const n=e[i],o=0===i?this._currentNode:e[i-1].destination;if(n.update(t,o),n.done){this._dropActivatedTransitions(r);break}const a=n.normalizedElapsedTime*s;n.destination.increaseAbsoluteWeight(a),s*=1-n.normalizedElapsedTime,r=i-1}this._currentNode.increaseAbsoluteWeight(s)}_dropActivatedTransitions(t){const{_activatedTransitions:e,_activatedTransitionPool:i}=this;t>=0&&e.length;const s=t+1,r=e[t],n=r.destination;{r.path.length;const t=r.path[r.path.length-1];t.endEventBinding&&this._emit(t.endEventBinding)}this._callExitMethods(this._currentNode);for(let s=0;s<=t;++s){const r=e[s];s!==t&&r.destination.decreaseActiveReference();const n=s===t?r.path.length-1:r.path.length;for(let t=0;t<n;++t){const e=r.path[t];this._callExitMethods(e.to)}i.free(r)}if(t===e.length-1)e.length=0;else{for(let i=t+1;i<e.length;++i)e[i-s]=e[i];e.length-=s}this._currentNode.decreaseActiveReference(),this._currentNode=n}_resetTriggersOnTransition(t){const{triggers:e}=t;if(e){const t=e.length;for(let i=0;i<t;++i){const t=e[i];this._resetTrigger(t)}}}_resetTrigger(t){const{_triggerReset:e}=this;e(t)}_callEnterMethods(t){var e;const{_controller:i}=this;switch(t.kind){default:break;case 3:t.components.callMotionStateEnterMethods(i,t.getStatus());break;case 0:null===(e=t.stateMachine.components)||void 0===e||e.callStateMachineEnterMethods(i)}}_callExitMethods(t){var e;const{_controller:i}=this;switch(t.kind){default:break;case 3:t.components.callMotionStateExitMethods(i,t.getStatus());break;case 1:null===(e=t.stateMachine.components)||void 0===e||e.callStateMachineExitMethods(i)}}_emit(t){t.emit(this._controller.node)}}function l7(t){return 3===t.kind||4===t.kind||5===t.kind}const c7={next:()=>({done:!0,value:void 0})},u7={[Symbol.iterator]:()=>c7};class d7{constructor(t){this.name=void 0,this.outgoingTransitions=[],this._activeReferenceCount=0,this._tickFlags=0,this._absoluteWeight=0,this.name=t.name}get absoluteWeight(){return this._absoluteWeight}get activeReferenceCount(){return this._activeReferenceCount}setPrefix_debug(t){this.__DEBUG_ID__=`${t}${this.name}`}addTransition(t){this.outgoingTransitions.push(t)}increaseActiveReference(){0===this._activeReferenceCount&&(this._absoluteWeight=0,this._tickFlags=0),++this._activeReferenceCount}decreaseActiveReference(){--this._activeReferenceCount}resetTickFlagsAndWeight(){this._checkActivated(),this._absoluteWeight=0,this._tickFlags=0}increaseAbsoluteWeight(t){this._absoluteWeight+=t}testTickFlag(t){return!!(this._tickFlags&t)}setTickFlag(t){this.testTickFlag(t),this._tickFlags|=t}_checkActivated(){this._activeReferenceCount}}class p7 extends d7{constructor(t){super(t),this.transitionInEventBinding=void 0,this.transitionOutEventBinding=void 0,t.transitionInEventBinding.isBound&&(this.transitionInEventBinding=t.transitionInEventBinding),t.transitionOutEventBinding.isBound&&(this.transitionOutEventBinding=t.transitionOutEventBinding)}}class _7{constructor(t){this._components=t.instantiateComponents()}callMotionStateEnterMethods(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateEnter",t,e)}callMotionStateUpdateMethods(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateUpdate",t,e)}callMotionStateExitMethods(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateExit",t,e)}callStateMachineEnterMethods(t){this._callStateMachineCallbackIfNonDefault("onStateMachineEnter",t)}callStateMachineExitMethods(t){this._callStateMachineCallbackIfNonDefault("onStateMachineExit",t)}_callMotionStateCallbackIfNonDefault(t,e,i){const{_components:s}=this,r=s.length;for(let n=0;n<r;++n){const r=s[n];r[t]!==P8.prototype[t]&&r[t](e,i)}}_callStateMachineCallbackIfNonDefault(t,e){const{_components:i}=this,s=i.length;for(let r=0;r<s;++r){const s=i[r];s[t]!==P8.prototype[t]&&s[t](e)}}}class g7{constructor(t,e){var i,s;this._source=null,this._baseSpeed=1,this._speed=1,this._publicState=void 0,this._privateState=void 0;const r=t.name;if(this._baseSpeed=t.speed,this._setSpeedMultiplier(1),t.speedMultiplierEnabled&&t.speedMultiplier){const i=t.speedMultiplier,s=e.getVar(i);if(C4(s,i)){I4(s.type,0,i),s.bind(this._setSpeedMultiplier,this);const t=s.value;this._setSpeedMultiplier(t)}}const n=null!==(i=null===(s=t.motion)||void 0===s?void 0:s[G0](e,!1))&&void 0!==i?i:null;n&&Object.defineProperty(n,"__DEBUG_ID__",{value:r}),this._source=n,this._publicState=new f7(this,t,null==n?void 0:n.createPort()),this._privateState=new f7(this,t,null==n?void 0:n.createPort()),this.components=new _7(t)}get duration(){var t,e;return null!==(t=null===(e=this._source)||void 0===e?void 0:e.duration)&&void 0!==t?t:0}get speed(){return this._speed}get entry(){return this._publicState}get stateMachine(){return this._stateMachine}set stateMachine(t){this._stateMachine=t,this._publicState.stateMachine=t,this._privateState.stateMachine=t}setPrefix_debug(t){this._publicState.setPrefix_debug(t),this._privateState.setPrefix_debug(t)}addTransition(t){t.to===this._publicState?this._publicState.addTransition({...t,to:this._privateState}):this._publicState.addTransition(t),this._privateState.addTransition(t)}getClipStatuses(t){const{_source:e}=this;return e?{[Symbol.iterator]:()=>e.getClipStatuses(t)}:u7}overrideClips(t){var e;null===(e=this._source)||void 0===e||e.overrideClips(t)}_setSpeedMultiplier(t){this._speed=this._baseSpeed*t}}class f7 extends p7{constructor(t,e,i){super(e),this.kind=3,this._container=void 0,this._progress=0,this._port=void 0,this._statusCache={progress:0},this._container=t,this._port=i}get duration(){return this._container.duration}get components(){return this._container.components}get normalizedTime(){return this._progress}get time(){return this._progress*this._container.duration}reenter(t){var e;this._progress=t,null===(e=this._port)||void 0===e||e.reenter()}getStatus(){const{_statusCache:t}=this;return t.progress=y7(this._progress),t}getClipStatuses(t){return this._container.getClipStatuses(t)}update(t,e){this._progress=m7(this._progress,this.duration,t*this._container.speed),this._container.components.callMotionStateUpdateMethods(e,this.getStatus())}evaluate(t){var e,i;return null!==(e=null===(i=this._port)||void 0===i?void 0:i.evaluate(this._progress,t))&&void 0!==e?e:null}}function m7(t,e,i){return 0===e?0:t+i/e}function y7(t){const e=t-Math.trunc(t);return e>=0?e:1+e}class v7 extends d7{constructor(t,e,i){super(t),this.kind=void 0,this.kind=e}}class b7 extends d7{constructor(t){super(t),this.kind=4}}class w7 extends p7{constructor(t,e){super(t),this.kind=5,this.elapsedTime=0,this.statusCache={progress:0},this._instantiatedPoseGraph=void 0,this._statusCache={progress:0},this._elapsedTime=0;const i=t7(t.graph,e,!0);i.bind(e),this._instantiatedPoseGraph=i,this._statusCache.progress=0}settle(t){this._instantiatedPoseGraph.settle(t)}reenter(){this._statusCache.progress=0,this._instantiatedPoseGraph.reenter()}update(t){this._elapsedTime+=t.deltaTime,this._instantiatedPoseGraph.update(t)}evaluate(t){var e;return null!==(e=this._instantiatedPoseGraph.evaluate(t))&&void 0!==e?e:null}getStatus(){return this._statusCache.progress=y7(this._elapsedTime),this._statusCache}countMotionTime(){return this._instantiatedPoseGraph.countMotionTime()}}class S7{constructor(){this.sourceStateWeight=0,this._sourceState=void 0}set(t){this._sourceState=t,l7(t)?(t.activeReferenceCount,this.sourceStateWeight=t.absoluteWeight):this.sourceStateWeight=0}unset(){this._sourceState=void 0,this.sourceStateWeight=0}get sourceStateMotionTimeNormalized(){const{_sourceState:t}=this;switch(t&&(3===t.kind||5===t.kind)&&t.activeReferenceCount,t.kind){case 3:return t.normalizedTime;case 5:return t.countMotionTime();default:return 0}}}class x7{constructor(){this.normalizedElapsedTime=0,this.path=[],this._durationMultiplier=1}get done(){return gi(this.normalizedElapsedTime,1,1e-6)}getAbsoluteDuration(t){return this._getAbsoluteDurationUnscaled(t)*this._durationMultiplier}update(t,e){if(!l7(e))return void(this.normalizedElapsedTime=1);const i=this.getAbsoluteDuration(e);let s=0;if(i<=0)s=0,this.normalizedElapsedTime=1;else{const e=this.normalizedElapsedTime*i,r=i-e;s=Math.min(r,t);const n=mi((e+s)/i);this.normalizedElapsedTime=n}}static createPool(t){return new rn((()=>new x7),t,void 0)}reset(t,e){const i=e.to;l7(i),this.normalizedElapsedTime=0,this.destination=i,this.path=[...t,e];const s=i.activeReferenceCount;if(i.increaseActiveReference(),0===s)if(3===i.kind){const{destinationStart:t,relativeDestinationStart:e}=this.path[0],s=e?t:0===i.duration?0:t/i.duration;i.reenter(s)}else 5===i.kind&&i.reenter();i.activeReferenceCount,this._durationMultiplier=1-i.absoluteWeight}_getAbsoluteDurationUnscaled(t){this.path.length;const{duration:e,normalizedDuration:i}=this.path[0];return i?(3===t.kind?t.duration:1)*e:e}}class T7{constructor(){this._groups=[]}register(t){const{group:e}=t;let i=this._groups.find((t=>t.name===e));return i||(i=new C7(e),this._groups.push(i)),i.addMember()}sync(){for(const t of this._groups)t.sync()}}class C7{constructor(t){this._lastLeader=void 0,this._records=[],this.name=t}addMember(){const t=new I7;return this._records.push(t),t}sync(){const{_records:t}=this,e=t.length,{_lastLeader:i}=this;if(this._lastLeader=void 0,t.every((t=>!t.active)))return;t.sort(((t,e)=>{const i=t.active?t.weight:-1;return(e.active?e.weight:-1)-i}));let s=0;const r=t[0].weight;if(t[s]!==i)for(let n=0;n<e;++n){const e=t[n];if(!e.active||!gi(e.weight,r,1e-6))break;if(e===i){s=n;break}}t[s].active,this._lastLeader=t[s];const n=t[s].normalizedTime;for(let i=0;i<e;++i){const e=t[i];if(!e.active)break;e.normalizedTime=n,e.reset()}}}class I7{constructor(){this.normalizedTime=0,this.weight=0,this.active=!1}notifyRenter(t){this.reset(),this.normalizedTime=t}notifyUpdate(t,e){this.normalizedTime+=t,this.active?this.weight+=e:(this.active=!0,this.weight=e)}reset(){this.active=!1,this.weight=0}getSyncedEnterTime(){return this.normalizedTime}}class E7{constructor(t){this._state=0,this._instantiatedPoseGraph=void 0,this._maxRequestedUpdateTime=0,this._evaluationCache=null,this._updateContextGenerator=new z6,this._allocator=t}set(t,e){this._state;const i=t7(t.graph,e);i.bind(e),this._instantiatedPoseGraph=i,this._state=1}settle(t){1===this._state||this._state,this._instantiatedPoseGraph,this._instantiatedPoseGraph.settle(t),this._state=2}reset(){switch(this._state){case 2:case 4:break;case 3:this._state=4;break;case 6:case 8:this._evaluationCache&&(this._allocator.destroyPose(this._evaluationCache),this._evaluationCache=null),this._maxRequestedUpdateTime=0,this._state=3}}reenter(){switch(this._state){default:this._state;break;case 3:case 6:break;case 2:case 4:this._state=3,this._instantiatedPoseGraph,this._instantiatedPoseGraph.reenter()}}requestUpdate(t){const{deltaTime:e}=t;if(4===this._state||3===this._state||5===this._state||this._state,this._instantiatedPoseGraph,5===this._state)return;const i=Math.max(0,e-this._maxRequestedUpdateTime);if(6===this._state&&gi(i,0,1e-8))return;this._state=5,this._maxRequestedUpdateTime=Math.max(e,this._maxRequestedUpdateTime);const s=this._updateContextGenerator.generate(i,t.indicativeWeight);this._instantiatedPoseGraph.update(s),this._state=6}evaluate(t){switch(this._state){default:this._state;break;case 7:this._state=8;break;case 8:break;case 6:{var e;this._evaluationCache,this._state=7;const i=null===(e=this._instantiatedPoseGraph)||void 0===e?void 0:e.evaluate(t);if(this._state=8,i){const e=this._allocator.allocatePose();e.transforms.set(i.transforms),e.auxiliaryCurves.set(i.auxiliaryCurves),this._evaluationCache=e,t.popPose()}this._state=8;break}}return this._state,this._instantiatedPoseGraph,this._evaluationCache?t.pushDuplicatedPose(this._evaluationCache):null}}class D7{constructor(t){this._allocator=void 0,this._stashEvaluations={},this._allocator=t}bindStash(t){return this._stashEvaluations[t]}getStash(t){return this._stashEvaluations[t]}addStash(t){this._stashEvaluations[t]=new E7(this._allocator)}setStash(t,e,i){this._stashEvaluations,this._stashEvaluations[t].set(e,i)}reset(){for(const t in this._stashEvaluations)this._stashEvaluations[t].reset()}settle(t){for(const e in this._stashEvaluations)this._stashEvaluations[e].settle(t)}}class A7 extends cJ{constructor(t,e,i){super(),this._layerRecords=void 0;const s=t.layers.map((t=>new M7(t,e,i)));this._layerRecords=s}get layerCount(){return this._layerRecords.length}reenter(){}bind(t){}settle(t){const{_layerRecords:e}=this,i=e.length;for(let s=0;s<i;++s)e[s].settle(t)}getLayerWeight(t){return t>=0&&this._layerRecords.length,this._layerRecords[t].weight}setLayerWeight(t,e){t>=0&&this._layerRecords.length,this._layerRecords[t].weight=e}getLayerTopLevelStateMachineEvaluation(t){return this._layerRecords[t].stateMachineEvaluation}overrideClips(t){const{_layerRecords:e}=this,i=e.length;for(let s=0;s<i;++s){const i=e[s];t._pushAdditiveFlag(i.additive),i.stateMachineEvaluation.overrideClips(t),t._popAdditiveFlag()}}doUpdate(t){const{_layerRecords:e}=this,i=e.length;for(let s=0;s<i;++s)e[s].update(t)}doEvaluate(t){const e=t.pushDefaultedPose(),{_layerRecords:i}=this,s=i.length;for(let r=0;r<s;++r){const s=i[r],n=s.stateMachineEvaluation.evaluate(t),o=s.weight*s.stateMachineEvaluation.passthroughWeight,{transformFilter:a}=s;s.additive?S3(e,n,o,a):_3(e,n,o,a),t.popPose(),s.postEvaluate()}return e}}class M7{constructor(t,e,i){var s;this.additive=!1,this.weight=0,this._topLevelStateMachineEval=void 0,this._stashManager=void 0,this._motionSyncManager=void 0,this._mask=void 0,this.transformFilter=void 0;const r=new D7(i);for(const[e,i]of t.stashes())r.addStash(e);this._stashManager=r;const n=new T7;this._motionSyncManager=n,e._setLayerWideContextProperties(r,n);for(const[i,s]of t.stashes())r.setStash(i,s,e);this.weight=t.weight;const o=this.additive=t.additive;this._mask=null!==(s=t.mask)&&void 0!==s?s:void 0,e._pushAdditiveFlag(o),this._topLevelStateMachineEval=new h7(t.stateMachine,t.name,e),e._popAdditiveFlag(),e._unsetLayerWideContextProperties()}get stateMachineEvaluation(){return this._topLevelStateMachineEval}settle(t){this._mask&&(this.transformFilter=t.createTransformFilter(this._mask)),this._stashManager.settle(t),this._topLevelStateMachineEval.settle(t)}update(t){this.stateMachineEvaluation.update(t),this._motionSyncManager.sync()}postEvaluate(){this._stashManager.reset()}}class P7{constructor(t,e,i,s){this._currentTransitionCache={duration:0,time:0},this._rootPoseNode=void 0,this._varInstances={},this._hasAutoTrigger=!1,this._auxiliaryCurveRegistry=new C6,this._poseLayoutMaintainer=void 0,this._bindingContext=void 0,this._settleContext=void 0,this._rootUpdateContextGenerator=new z6;for(const[e,i]of t.variables){const t=i[EK]();this._varInstances[e]=t,t instanceof NK&&1===t.resetMode&&(this._hasAutoTrigger=!0)}const r=new I6(e,this._auxiliaryCurveRegistry);this._poseLayoutMaintainer=r;const n=new x6(e,r,this._varInstances,i);n._setClipOverrides(null!=s?s:void 0),this._bindingContext=n;const o=new P6(r);this._settleContext=o,r.startBind();const a=new k6;this._poseStashAllocator=a,this._rootPoseNode=new A7(t,n,a),this._root=e,this._initializeContexts()}destroy(){this._evaluationContext.destroy()}_destroyAfterException_debugging(){const t=this._evaluationContext._stackSize_debugging;if(0!==t)for(let e=0;e<t;++e)this._evaluationContext.popPose();this._evaluationContext.destroy()}get layerCount(){return this._rootPoseNode.layerCount}update(t){const{_evaluationContext:e,_poseLayoutMaintainer:i,_rootUpdateContextGenerator:s,_rootPoseNode:r}=this,n=s.generate(t,1);r.update(n);const o=r.evaluate(e,1);if(this._hasAutoTrigger){const{_varInstances:t}=this;for(const e in t){const i=t[e];i instanceof NK&&1===i.resetMode&&(i.value=!1)}}i.apply(o),e.popPose()}getVariables(){return Object.entries(this._varInstances)}getCurrentStateStatus(t){return this._rootPoseNode.getLayerTopLevelStateMachineEvaluation(t).getCurrentStateStatus()}getCurrentClipStatuses(t){return this._rootPoseNode.getLayerTopLevelStateMachineEvaluation(t).getCurrentClipStatuses()}getCurrentTransition(t){const{_currentTransitionCache:e}=this;return this._rootPoseNode.getLayerTopLevelStateMachineEvaluation(t).getCurrentTransition(e)?e:null}getNextStateStatus(t){return this._rootPoseNode.getLayerTopLevelStateMachineEvaluation(t).getNextStateStatus()}getNextClipStatuses(t){return this._rootPoseNode.getLayerTopLevelStateMachineEvaluation(t).getNextClipStatuses()}getValue(t){const e=this._varInstances[t];return e?e.value:void 0}setValue(t,e){const i=this._varInstances[t];i&&(i.value=e)}getLayerWeight(t){return this._rootPoseNode.getLayerWeight(t)}setLayerWeight(t,e){this._rootPoseNode.setLayerWeight(t,e)}overrideClips(t){const{_poseLayoutMaintainer:e}=this;e.startBind(),this._bindingContext._setClipOverrides(t),this._rootPoseNode.overrideClips(this._bindingContext),this._updateAfterPossiblePoseLayoutChange()}getAuxiliaryCurveValue(t){return this._auxiliaryCurveRegistry.get(t)}_initializeContexts(){const{_poseLayoutMaintainer:t}=this;t.endBind(),this._createOrUpdateTransformFilters();const e=t.createEvaluationContext();this._evaluationContext=e,t.fetchDefaultTransforms(e[M6]),t.resetPoseStashAllocator(this._poseStashAllocator)}_updateAfterPossiblePoseLayoutChange(){const{_poseLayoutMaintainer:t}=this,e=t.endBind();if(0===e)return;(1&e||2&e)&&this._createOrUpdateTransformFilters();let i=!1;if(1&e||4&e){const e=t.createEvaluationContext();this._evaluationContext.destroy(),this._evaluationContext=e,i=!0,t.resetPoseStashAllocator(this._poseStashAllocator)}(i||1&e||2&e)&&t.fetchDefaultTransforms(this._evaluationContext[M6])}_createOrUpdateTransformFilters(){this._rootPoseNode.settle(this._settleContext)}}var B7,R7,O7,L7,F7,z7;const{ccclass:k7,menu:N7,help:U7,type:V7,serializable:H7,editable:G7,formerlySerializedAs:W7}=Ja;let j7=(B7=k7("cc.animation.AnimationController"),R7=V7(kZ),O7=W7("graph"),B7((F7=class extends Ag{constructor(){super(...arguments),this._graph=z7&&z7(),this._graphEval=null}get graph(){return this._graph}set graph(t){this._graph=t}get layerCount(){var t,e;return null!==(t=null===(e=this._graphEval)||void 0===e?void 0:e.layerCount)&&void 0!==t?t:0}__preload(){const{graph:t}=this;if(t){let e,i=null;if(t instanceof $5){if(!t.original)return;e=t.original,i=t.clipOverrides}else e=t;const s=new P7(e,this.node,this,i);this._graphEval=s}}onDestroy(){var t;null===(t=this._graphEval)||void 0===t||t.destroy()}update(t){var e;null===(e=this._graphEval)||void 0===e||e.update(t)}getVariables(){const{_graphEval:t}=this;return t.getVariables()}setValue(t,e){return this.setValue_experimental(t,e)}setValue_experimental(t,e){const{_graphEval:i}=this;i.setValue(t,e)}getValue(t){const e=this.getValue_experimental(t);return"object"==typeof e?void 0:e}getValue_experimental(t){const{_graphEval:e}=this;return e.getValue(t)}getCurrentStateStatus(t){const{_graphEval:e}=this;return e.getCurrentStateStatus(t)}getCurrentClipStatuses(t){const{_graphEval:e}=this;return e.getCurrentClipStatuses(t)}getCurrentTransition(t){const{_graphEval:e}=this;return e.getCurrentTransition(t)}getNextStateStatus(t){const{_graphEval:e}=this;return e.getNextStateStatus(t)}getNextClipStatuses(t){const{_graphEval:e}=this;return e.getNextClipStatuses(t)}getLayerWeight(t){const{_graphEval:e}=this;return e.getLayerWeight(t)}setLayerWeight(t,e){const{_graphEval:i}=this;return i.setLayerWeight(t,e)}overrideClips_experimental(t){const{_graphEval:e}=this;e.overrideClips(t)}getAuxiliaryCurveValue_experimental(t){const{_graphEval:e}=this;return e?e.getAuxiliaryCurveValue(t):0}},s(F7.prototype,"graph",[R7],Object.getOwnPropertyDescriptor(F7.prototype,"graph"),F7.prototype),z7=Qo(F7.prototype,"_graph",[H7,O7],(function(){return null})),L7=F7))||L7);var $7,q7,X7=Object.freeze({__proto__:null,AnimationController:j7,ColorTrack:gK,ComponentPath:HY,CubicSplineNumberValue:YQ,CubicSplineQuatValue:XQ,CubicSplineVec2Value:jQ,CubicSplineVec3Value:$Q,CubicSplineVec4Value:qQ,HierarchyPath:VY,MorphWeightValueProxy:FQ,MorphWeightsAllValueProxy:kQ,MorphWeightsValueProxy:zQ,ObjectTrack:TK,QuatTrack:lK,RealTrack:KQ,SizeTrack:wK,StateMachineComponent:P8,Track:dQ,TrackPath:lQ,UniformProxyFactory:IQ,VariableType:{FLOAT:0,BOOLEAN:1,TRIGGER:2,INTEGER:3,VEC3_experimental:4,QUAT_experimental:5},VectorTrack:rK,isCustomPath:function(t,e){return t instanceof e},isPropertyPath:UY});t("animation",X7);class Y7{constructor(){this._nodeBlendStates=new Map}createWriter(t,e,i,s){const r=this.ref(t,e);return new Q7(t,e,r,i,s)}destroyWriter(t){const e=t;this.deRef(e.node,e.property)}ref(t,e){let i=this._nodeBlendStates.get(t);return i||(i=this.createNodeBlendState(),this._nodeBlendStates.set(t,i)),i.refProperty(t,e)}deRef(t,e){const i=this._nodeBlendStates.get(t);i&&(i.deRefProperty(e),i.empty&&this._nodeBlendStates.delete(t))}apply(){this._nodeBlendStates.forEach(((t,e)=>{t.apply(e)}))}}class Q7{constructor(t,e,i,s,r){this._node=t,this._property=e,this._propertyBlendState=i,this._host=s,this._constants=r}get node(){return this._node}get property(){return this._property}getValue(){return this._node[this._property]}setValue(t){const{_propertyBlendState:e,_host:i}=this,s=i.weight;e.blend(t,s)}}class K7{constructor(){this.refCount=0,this.accumulatedWeight=0,this.result=new Ki}blend(t,e){this.accumulatedWeight=i9(this.result,this.result,this.accumulatedWeight,t,e)}reset(){this.accumulatedWeight=0,Ki.zero(this.result)}}class Z7{constructor(){this.refCount=0,this.accumulatedWeight=0,this.result=new ys}blend(t,e){this.accumulatedWeight=s9(this.result,this.result,this.accumulatedWeight,t,e)}reset(){this.accumulatedWeight=0,ys.identity(this.result)}}class J7{constructor(){this._transformApplyFlags=0,this._properties={}}get empty(){const{_properties:t}=this;return!(t.position||t.rotation||t.eulerAngles||t.scale)}refProperty(t,e){var i,s;const{_properties:r}=this;let n;switch(e){default:case"position":case"scale":case"eulerAngles":n=null!==(i=r[e])&&void 0!==i?i:r[e]=this._createVec3BlendState(t[e]);break;case"rotation":n=null!==(s=r[e])&&void 0!==s?s:r[e]=this._createQuatBlendState(t.rotation)}return++n.refCount,n}deRefProperty(t){const{_properties:e}=this,i=e[t];i&&(--i.refCount,i.refCount>0||delete e[t])}apply(t){const{_transformApplyFlags:e,_properties:{position:i,scale:s,rotation:r,eulerAngles:n}}=this;if(!e)return;let o,a,h;i&&1&e&&(o=i.result),s&&4&e&&(a=s.result),n&&8&e&&(h=n.result),r&&2&e&&(h=r.result),(h||o||a)&&t.setRTS(h,o,a),this._transformApplyFlags=0}}class t9 extends J7{apply(t){const{_properties:{position:e,scale:i,rotation:s,eulerAngles:r}}=this;e&&e.accumulatedWeight&&(this._transformApplyFlags|=1,e.accumulatedWeight<1&&e.blend(t.position,1-e.accumulatedWeight)),i&&i.accumulatedWeight&&(this._transformApplyFlags|=4,i.accumulatedWeight<1&&i.blend(t.scale,1-i.accumulatedWeight)),r&&r.accumulatedWeight&&(this._transformApplyFlags|=8,r.accumulatedWeight<1&&r.blend(t.eulerAngles,1-r.accumulatedWeight)),s&&s.accumulatedWeight&&(this._transformApplyFlags|=2,s.accumulatedWeight<1&&s.blend(t.rotation,1-s.accumulatedWeight)),super.apply(t),null==e||e.reset(),null==i||i.reset(),null==s||s.reset(),null==r||r.reset()}_createVec3BlendState(t){return new K7}_createQuatBlendState(t){return new Z7}}class e9 extends Y7{createNodeBlendState(){return new t9}}function i9(t,e,i,s,r){const n=i+r;if(1!==r||i){if(n){const e=r/n;Ki.lerp(t,t,s,e)}}else Ki.copy(t,s);return n}function s9(t,e,i,s,r){const n=i+r;if(1!==r||i){if(n){const i=r/n;ys.slerp(t,e,s,i)}}else ys.copy(t,s);return n}let r9=t("AnimationManager",oa((q7=class extends su{constructor(){super(...arguments),this._anims=new Ht([]),this._crossFades=new Ht([]),this._delayEvents=[],this._blendStateBuffer=new e9,this._sockets=[]}get blendState(){return this._blendStateBuffer}addCrossFade(t){-1===this._crossFades.array.indexOf(t)&&this._crossFades.push(t)}removeCrossFade(t){const e=this._crossFades.array.indexOf(t);e>=0?this._crossFades.fastRemoveAt(e):j(3907)}update(t){const{_delayEvents:e,_crossFades:i,_sockets:s}=this;{const e=i.array;for(i.i=0;i.i<e.length;++i.i)e[i.i].update(t)}const r=this._anims,n=r.array;for(r.i=0;r.i<n.length;++r.i){const e=n[r.i];e.isMotionless||e.update(t)}this._blendStateBuffer.apply();const o=uP.getTotalFrames();for(let t=0,e=s.length;t<e;t++){const{target:e,transform:i}=s[t];e.matrix=G$(i,o)}for(let t=0,i=e.length;t<i;t++){const i=e[t];i.fn.apply(i.thisArg,i.args)}e.length=0}destruct(){}addAnimation(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)}removeAnimation(t){const e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):j(3907)}pushDelayEvent(t,e,i){this._delayEvents.push({fn:t,thisArg:e,args:i})}addSockets(t,e){for(let i=0;i<e.length;++i){const s=e[i];if(this._sockets.find((t=>t.target===s.target)))continue;const r=t.getChildByPath(s.path),n=s.target&&r&&W$(r,t);n&&this._sockets.push({target:s.target,transform:n})}}removeSockets(t,e){for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<this._sockets.length;++t){const e=this._sockets[t];if(e.target===i.target){j$(e.transform.node),this._sockets[t]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}},q7.ID="animation",$7=q7))||$7);uP.on("director_init",(()=>{const t=new r9;uP.registerSystem(r9.ID,t,su.Priority.HIGH)})),h.AnimationManager=r9;class n9 extends bY{constructor(t){super(),this._managedStates=[],this._fadings=[],this._scheduled=!1,this._scheduler=null!=t?t:TY()}update(t){if(this.isMotionless)return;const e=this._managedStates,i=this._fadings;if(1===e.length&&1===i.length){const t=e[0].state;t&&(t.weight=1)}else this._calculateWeights(t);1===e.length&&1===i.length&&this._unscheduleThis()}crossFade(t,e){var i;0===this._managedStates.length&&(e=0),0===e&&this.clear();let s=this._managedStates.find((e=>e.state===t));s?null!==(i=s.state)&&void 0!==i&&i.isMotionless&&s.state.play():(s={state:t,reference:0},t&&t.play(),this._managedStates.push(s)),++s.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:s}),this.isMotionless||this._scheduleThis()}clear(){for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0}onPlay(){super.onPlay(),this._scheduleThis()}onPause(){super.onPause();for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.pause()}this._unscheduleThis()}onResume(){super.onResume();for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.resume()}this._scheduleThis()}onStop(){super.onStop(),this.clear()}_calculateWeights(t){const e=this._managedStates,i=this._fadings;for(let t=0;t<e.length;++t){const i=e[t].state;i&&(i.weight=0)}let s=1,r=i.length;for(let e=0;e<i.length;++e){const n=i[e];n.easeTime+=t;const o=0===n.easeDuration?1:mi(n.easeTime/n.easeDuration),a=o*s;if(s*=1-o,n.target.state&&(n.target.state.weight+=a),n.easeTime>=n.easeDuration){r=e+1,n.easeTime=n.easeDuration;break}}if(r!==i.length){for(let t=r;t<i.length;++t){const e=i[t];--e.target.reference,e.target.reference<=0&&(e.target.state&&e.target.state.stop(),jt(this._managedStates,e.target))}i.splice(r)}}_scheduleThis(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)}_unscheduleThis(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)}}var o9,a9,h9,l9,c9,u9,d9,p9,_9,g9,f9;let m9=(o9=oa("cc.Animation"),a9=ha(99),h9=Ga([U2]),l9=Ga(U2),c9=Ga([U2]),o9(u9=a9((f9=class extends(Dn(Ag)){constructor(){super(...arguments),this.playOnLoad=p9&&p9(),this._crossFade=new n9,this._nameToState=dt(!0),this._clips=_9&&_9(),this._defaultClip=g9&&g9(),this._hasBeenPlayed=!1}get clips(){return this._clips}set clips(t){this._crossFade&&this._crossFade.clear();for(const t of this._clips)t&&this._removeStateOfAutomaticClip(t);for(const e of t)e&&this.createState(e);const e=t.find((t=>y9(t,this._defaultClip)));this._defaultClip=e||null,this._clips=t}get defaultClip(){return this._defaultClip}set defaultClip(t){this._defaultClip=t,t&&(this._clips.findIndex((e=>y9(e,t)))>=0||(this._clips.push(t),this.createState(t)))}onLoad(){this.clips=this._clips;for(const t in this._nameToState)this._nameToState[t].initialize(this.node)}start(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}onEnable(){this._crossFade.resume()}onDisable(){this._crossFade.pause()}onDestroy(){this._crossFade.stop();for(const t in this._nameToState)this._nameToState[t].destroy();this._nameToState=dt(!0)}play(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)}crossFade(t,e){void 0===e&&(e=.3),this._hasBeenPlayed=!0;const i=this._nameToState[t];i&&this.doPlayOrCrossFade(i,e)}pause(){this._crossFade.pause()}resume(){this._crossFade.resume()}stop(){this._crossFade.stop()}getState(t){const e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null}createState(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)}removeState(t){const e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])}addClip(t,e){return Xt(this._clips,t)||this._clips.push(t),this.createState(t,e)}removeClip(t,e){let i;for(const e in this._nameToState){const s=this._nameToState[e];if(s.clip===t){i=s;break}}if(t===this._defaultClip){if(!e)return void G(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void G(3903);i.stop()}this._clips=this._clips.filter((e=>e!==t)),i&&delete this._nameToState[i.name]}on(t,e,i,s){const r=super.on(t,e,i,s);return"lastframe"===t&&this._syncAllowLastFrameEvent(),r}once(t,e,i){const s=super.once(t,e,i);return"lastframe"===t&&this._syncAllowLastFrameEvent(),s}off(t,e,i){super.off(t,e,i),"lastframe"===t&&this._syncDisallowLastFrameEvent()}_createState(t,e){return new IY(t,e)}_doCreateState(t,e){const i=this._createState(t,e);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener("lastframe")),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}doPlayOrCrossFade(t,e){this._crossFade.play(),this._crossFade.crossFade(t,e)}_removeStateOfAutomaticClip(t){for(const e in this._nameToState){const i=this._nameToState[e];y9(t,i.clip)&&(i.stop(),delete this._nameToState[e])}}_syncAllowLastFrameEvent(){if(this.hasEventListener("lastframe"))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)}_syncDisallowLastFrameEvent(){if(!this.hasEventListener("lastframe"))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)}},f9.EventType=CY,s((d9=f9).prototype,"clips",[h9],Object.getOwnPropertyDescriptor(d9.prototype,"clips"),d9.prototype),s(d9.prototype,"defaultClip",[l9],Object.getOwnPropertyDescriptor(d9.prototype,"defaultClip"),d9.prototype),p9=Qo(d9.prototype,"playOnLoad",[va],(function(){return!1})),_9=Qo(d9.prototype,"_clips",[c9],(function(){return[]})),g9=Qo(d9.prototype,"_defaultClip",[va],(function(){return null})),u9=d9))||u9)||u9);function y9(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}t({Animation:m9,AnimationComponent:m9}),h.Animation=m9,h.AnimationComponent=m9,Ot(m9,"cc.AnimationComponent"),l.log=M,l.warn=P,l.error=B,l.assert=R,l._throw=F,l.logID=N,l.warnID=G,l.errorID=j,l.assertID=q,l.debug=J,l.path={join:Bc,extname:Rc,mainFileName:Oc,basename:Lc,dirname:Fc,changeExtname:zc,changeBasename:kc,_normalize:Nc,stripSep:Uc,get sep(){return Vc()}};class v9{constructor(t){this._pool=[],this.poolHandlerComp=t}size(){return this._pool.length}clear(){const t=this._pool.length;for(let e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0}put(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();const e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}}get(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=this._pool.length-1;if(s<0)return null;{const t=this._pool[s];this._pool.length=s;const e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;return e&&e.reuse&&e.reuse(arguments),t}}}var b9,w9;t("NodePool",v9),l.NodePool=v9;const S9=null!==(b9=globalThis.jsb)&&void 0!==b9?b9:{};function x9(t,e){t.s(e.name),t.n(e.type),t.n(e.count)}function T9(t,e){e.name=t.s(),e.type=t.n(),e.count=t.n()}function C9(t,e){t.n(e.set),t.n(e.binding),t.s(e.name),t.n(e.members.length);for(const i of e.members)x9(t,i);t.n(e.count)}function I9(t,e){e.set=t.n(),e.binding=t.n(),e.name=t.s();let i=0;i=t.n(),e.members.length=i;for(let s=0;s!==i;++s){const i=new Ld;T9(t,i),e.members[s]=i}e.count=t.n()}function E9(t,e){e.binding=t.n(),e.descriptorType=t.n(),e.count=t.n(),e.stageFlags=t.n()}function D9(t,e){const i=t.n();e.bindings.length=i;for(let s=0;s!==i;++s){const i=new sp;E9(t,i),e.bindings[s]=i}}t("native",{DownloaderHints:S9.DownloaderHints,Downloader:S9.Downloader,zipUtils:S9.zipUtils,fileUtils:S9.fileUtils,DebugRenderer:S9.DebugRenderer,copyTextToClipboard:null===(w9=S9.copyTextToClipboard)||void 0===w9?void 0:w9.bind(S9),garbageCollect:S9.garbageCollect,reflection:S9.reflection,bridge:S9.bridge,jsbBridgeWrapper:S9.jsbBridgeWrapper,AssetsManager:S9.AssetsManager,EventAssetsManager:S9.EventAssetsManager,Manifest:S9.Manifest,saveImageData:S9.saveImageData,process:S9.process,adpf:S9.adpf}),l.renderer=XL;class A9{constructor(t,e,i,s){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=!1),void 0===s&&(s=null),this.light=t,this.probe=s,this.level=e,this.culledByLight=i}reset(t,e,i,s){this.light=t,this.probe=s,this.level=e,this.culledByLight=i}}class M9{constructor(t){void 0===t&&(t=0),this.count=1,this.type=t}reset(t){this.type=t,this.count=1}}class P9{constructor(){this.descriptors=new Map,this.uniformBlocks=new Map,this.capacity=0,this.count=0}reset(){this.descriptors.clear(),this.uniformBlocks.clear(),this.capacity=0,this.count=0}}class B9{constructor(){this.descriptorNames=[],this.uniformBlockNames=[],this.descriptors=[],this.uniformBlocks=[],this.capacity=0,this.count=0}reset(){this.descriptorNames.length=0,this.uniformBlockNames.length=0,this.descriptors.length=0,this.uniformBlocks.length=0,this.capacity=0,this.count=0}}class R9{constructor(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),this.updateFrequency=t,this.parameterType=e,this.descriptorType=i,this.visibility=s}}class O9{constructor(t,e,i,s,r){void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=0),void 0===s&&(s=1),void 0===r&&(r=1),this.source=t,this.target=e,this.resolveFlags=i,this.mode=s,this.mode1=r}reset(t,e,i,s,r){this.source=t,this.target=e,this.resolveFlags=i,this.mode=s,this.mode1=r}}class L9{constructor(t,e,i,s,r,n,o,a,h,l){void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=4294967295),void 0===s&&(s=4294967295),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=0),void 0===l&&(l=0),this.source=t,this.target=e,this.mipLevels=i,this.numSlices=s,this.sourceMostDetailedMip=r,this.sourceFirstSlice=n,this.sourcePlaneSlice=o,this.targetMostDetailedMip=a,this.targetFirstSlice=h,this.targetPlaneSlice=l}reset(t,e,i,s,r,n,o,a,h,l){this.source=t,this.target=e,this.mipLevels=i,this.numSlices=s,this.sourceMostDetailedMip=r,this.sourceFirstSlice=n,this.sourcePlaneSlice=o,this.targetMostDetailedMip=a,this.targetFirstSlice=h,this.targetPlaneSlice=l}}class F9{constructor(t,e,i,s,r,n,o){void 0===t&&(t=new Uint8Array(0)),void 0===e&&(e=""),void 0===i&&(i=4294967295),void 0===s&&(s=4294967295),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),this.source=t,this.target=e,this.mipLevels=i,this.numSlices=s,this.targetMostDetailedMip=r,this.targetFirstSlice=n,this.targetPlaneSlice=o}reset(t,e,i,s,r,n){this.target=t,this.mipLevels=e,this.numSlices=i,this.targetMostDetailedMip=s,this.targetFirstSlice=r,this.targetPlaneSlice=n}}class z9{constructor(t,e,i,s,r,n,o){void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=4294967295),void 0===s&&(s=4294967295),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),this.source=t,this.target=e,this.mipLevels=i,this.numSlices=s,this.targetMostDetailedMip=r,this.targetFirstSlice=n,this.targetPlaneSlice=o}reset(t,e,i,s,r,n,o){this.source=t,this.target=e,this.mipLevels=i,this.numSlices=s,this.targetMostDetailedMip=r,this.targetFirstSlice=n,this.targetPlaneSlice=o}}class k9{constructor(){this.numRenderPasses=0,this.numManagedTextures=0,this.totalManagedTextures=0,this.numUploadBuffers=0,this.numUploadBufferViews=0,this.numFreeUploadBuffers=0,this.numFreeUploadBufferViews=0,this.numDescriptorSets=0,this.numFreeDescriptorSets=0,this.numInstancingBuffers=0,this.numInstancingUniformBlocks=0}reset(){this.numRenderPasses=0,this.numManagedTextures=0,this.totalManagedTextures=0,this.numUploadBuffers=0,this.numUploadBufferViews=0,this.numFreeUploadBuffers=0,this.numFreeUploadBufferViews=0,this.numDescriptorSets=0,this.numFreeDescriptorSets=0,this.numInstancingBuffers=0,this.numInstancingUniformBlocks=0}}function N9(t){return new nn((()=>new t),16)}class U9{constructor(){this.li=N9(A9),this.d=N9(M9),this.db=N9(P9),this.dbf=N9(B9),this.dbi=N9(R9),this.rp=N9(O9),this.cp=N9(L9),this.up=N9(F9),this.mp=N9(z9),this.ps=N9(k9)}reset(){this.li.reset(),this.d.reset(),this.db.reset(),this.dbf.reset(),this.dbi.reset(),this.rp.reset(),this.cp.reset(),this.up.reset(),this.mp.reset(),this.ps.reset()}createLightInfo(t,e,i,s){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=!1),void 0===s&&(s=null);const r=this.li.add();return r.reset(t,e,i,s),r}createDescriptor(t){void 0===t&&(t=0);const e=this.d.add();return e.reset(t),e}createDescriptorBlock(){const t=this.db.add();return t.reset(),t}createDescriptorBlockFlattened(){const t=this.dbf.add();return t.reset(),t}createDescriptorBlockIndex(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0);const r=this.dbi.add();return r.updateFrequency=t,r.parameterType=e,r.descriptorType=i,r.visibility=s,r}createResolvePair(t,e,i,s,r){void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=0),void 0===s&&(s=1),void 0===r&&(r=1);const n=this.rp.add();return n.reset(t,e,i,s,r),n}createCopyPair(t,e,i,s,r,n,o,a,h,l){void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=4294967295),void 0===s&&(s=4294967295),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===h&&(h=0),void 0===l&&(l=0);const c=this.cp.add();return c.reset(t,e,i,s,r,n,o,a,h,l),c}createUploadPair(t,e,i,s,r,n){void 0===t&&(t=""),void 0===e&&(e=4294967295),void 0===i&&(i=4294967295),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0);const o=this.up.add();return o.reset(t,e,i,s,r,n),o}createMovePair(t,e,i,s,r,n,o){void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=4294967295),void 0===s&&(s=4294967295),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0);const a=this.mp.add();return a.reset(t,e,i,s,r,n,o),a}createPipelineStatistics(){const t=this.ps.add();return t.reset(),t}}function V9(t,e){t.n(e.type),t.n(e.count)}function H9(t,e){e.type=t.n(),e.count=t.n()}let G9,W9,j9;class $9{constructor(t,e){this.source=void 0,this.target=void 0,this.source=t,this.target=e}equals(t){return this.source===t.source&&this.target===t.target}}class q9{constructor(t){this.target=void 0,this.target=t}equals(t){return this.target===t.target}}G9=Symbol.iterator;class X9{constructor(t,e){this.iterator=void 0,this.source=void 0,this.iterator=t,this.source=e}[G9](){return this}next(){const t=this.iterator.next();return t.done?{value:void 0,done:!0}:{value:new $9(this.source,t.value.target),done:!1}}}W9=Symbol.iterator;class Y9{constructor(t,e){this.iterator=void 0,this.source=void 0,this.iterator=t,this.source=e}[W9](){return this}next(){const t=this.iterator.next();return t.done?{value:void 0,done:!0}:{value:new $9(t.value.target,this.source),done:!1}}}j9=Symbol.iterator;class Q9{constructor(t,e){this.graph=void 0,this.iterator=void 0,this.graph=t,this.iterator=e}[j9](){return this}next(){const t=this.iterator.next();return t.done?{value:void 0,done:!0}:{value:this.graph.target(t.value),done:!1}}}function K9(t,e){if(e===t.N)return"";const i=[];for(;e!==t.N;e=t.getParent(e))i.push(t.vertexName(e));let s="";for(let t=i.length;t-- >0;)s+="/",s+=i[t];return s}function Z9(t,e,i){const s=t.N,r=i.split("/");if(0===r.length)return e;let n=e,o=0;""===r[0]&&(n=s,++o);for(let e=o;e!==r.length;++e){const i=r[e];if(""!==i&&"."!==i)if(".."!==i){if(n=t.locateChild(n,i),n===s)return s}else{if(n===s)return s;n=t.getParent(n)}}return n}class J9{terminate(t,e){return!1}}function ttt(t){const e=t.v().next();return e.done?t.N:e.value}class ett{constructor(t,e,i){this.v=void 0,this.e=void 0,this.iter=void 0,this.v=t,this.e=e,this.iter=i}}function itt(t,e,i,s,r){let n=null,o=null;const a=new Array;for(s.put(e,1),i.discoverVertex(e,t),o=t.oe(e),r.terminate(e,t)?a.push(new ett(e,null,null)):a.push(new ett(e,null,o));a.length;){const h=a.pop();if(e=h.v,n=h.e,o=h.iter,null!==n&&i.finishEdge(n,t),o)for(let h=o.next();!h.done;h=o.next()){const l=h.value,c=l.target;i.examineEdge(l,t);const u=s.get(c);if(0===u){if(i.treeEdge(l,t),n=l,a.push(new ett(e,n,o)),e=c,s.put(e,1),i.discoverVertex(e,t),o=t.oe(e),r.terminate(e,t))break}else 1===u?i.backEdge(l,t):i.forwardOrCrossEdge(l,t),i.finishEdge(l,t)}s.put(e,4),i.finishVertex(e,t)}}function stt(t,e,i,s){if(void 0===s&&(s=null),null===(s=s||ttt(t))||0===t.nv())return;for(const s of t.v())i.put(s,0),e.initializeVertex(s,t);const r=new J9;s!==ttt(t)&&(e.startVertex(s,t),itt(t,s,e,i,r));for(const s of t.v())0===i.get(s)&&(e.startVertex(s,t),itt(t,s,e,i,r))}class rtt{initializeVertex(t,e){}startVertex(t,e){}discoverVertex(t,e){}examineEdge(t,e){}treeEdge(t,e){}backEdge(t,e){}forwardOrCrossEdge(t,e){}finishEdge(t,e){}finishVertex(t,e){}}class ntt{constructor(t){this.g=void 0,this.g=t,this.N=t.N}edge(t,e){return this.g.reference(t,e)}source(t){return this.g.parent(t)}target(t){return this.g.child(t)}oe(t){return this.g.children(t)}od(t){return this.g.numChildren(t)}v(){return this.g.v()}nv(){return this.g.nv()}}function ott(t){t.x=0,t.y=0,t.z=0,t.w=0}function att(t){t.left=0,t.top=0,t.width=0,t.height=0,t.minDepth=0,t.maxDepth=1}class htt{constructor(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),this.x=t,this.y=e,this.z=i,this.w=s}reset(t,e,i,s){this.x=t,this.y=e,this.z=i,this.w=s}}class ltt{constructor(t,e,i,s,r,n,o,a){void 0===t&&(t=""),void 0===e&&(e=2),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=7),void 0===o&&(o=new Sd),void 0===a&&(a=0),this.slotName1="",this.slotID=0,this.slotName=t,this.accessType=e,this.attachmentType=i,this.loadOp=s,this.storeOp=r,this.clearFlags=n,this.clearColor=o,this.shaderStageFlags=a}reset(t,e,i,s,r,n,o){this.slotName=t,this.slotName1="",this.accessType=e,this.attachmentType=i,this.loadOp=s,this.storeOp=r,this.clearFlags=n,ott(this.clearColor),this.slotID=0,this.shaderStageFlags=o}}class ctt{constructor(t,e,i,s,r,n){void 0===t&&(t=""),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=new htt),void 0===n&&(n=0),this.plane=0,this.name=t,this.accessType=e,this.clearFlags=i,this.clearValueType=s,this.clearValue=r,this.shaderStageFlags=n}reset(t,e,i,s,r){this.name=t,this.accessType=e,this.plane=0,this.clearFlags=i,this.clearValueType=s,this.clearValue.reset(0,0,0,0),this.shaderStageFlags=r}}class utt{constructor(){this.dimension=0,this.alignment=0,this.width=0,this.height=0,this.depthOrArraySize=0,this.mipLevels=0,this.format=0,this.sampleCount=1,this.textureFlags=0,this.flags=0,this.viewType=1}reset(){this.dimension=0,this.alignment=0,this.width=0,this.height=0,this.depthOrArraySize=0,this.mipLevels=0,this.format=0,this.sampleCount=1,this.textureFlags=0,this.flags=0,this.viewType=1}}class dtt{constructor(t){void 0===t&&(t=0),this.residency=t}reset(t){this.residency=t}}class ptt{constructor(t,e){void 0===t&&(t=null),void 0===e&&(e=!1),this.renderWindow=null,this.currentID=0,this.numBackBuffers=0,this.generation=4294967295,this.swapchain=t,this.isDepthStencil=e}reset(t,e){this.swapchain=t,this.renderWindow=null,this.currentID=0,this.numBackBuffers=0,this.generation=4294967295,this.isDepthStencil=e}}class _tt{constructor(){this.states=0}reset(){this.states=0}}class gtt{constructor(t){void 0===t&&(t=null),this.fenceValue=0,this.buffer=t}reset(t){this.buffer=t,this.fenceValue=0}}class ftt{constructor(t){void 0===t&&(t=null),this.fenceValue=0,this.buffer=t}reset(t){this.buffer=t,this.fenceValue=0}}class mtt{constructor(t){void 0===t&&(t=null),this.fenceValue=0,this.texture=t}reset(t){this.texture=t,this.fenceValue=0}}class ytt{constructor(t){void 0===t&&(t=null),this.fenceValue=0,this.texture=t}reset(t){this.texture=t,this.fenceValue=0}}class vtt{constructor(){this.unused=0}reset(){this.unused=0}}class btt{constructor(){this.rasterViews=new Map,this.computeViews=new Map,this.resolvePairs=[]}reset(){this.rasterViews.clear(),this.computeViews.clear(),this.resolvePairs.length=0}}class wtt{constructor(){this.o=[],this.i=[]}}class Stt{constructor(){this.N=4294967295,this.x=[],this._names=[],this._subpasses=[]}edge(t,e){for(const i of this.x[t].o)if(e===i.target)return!0;return!1}source(t){return t.source}target(t){return t.target}oe(t){return new X9(this.x[t].o.values(),t)}od(t){return this.x[t].o.length}ie(t){return new Y9(this.x[t].i.values(),t)}id(t){return this.x[t].i.length}d(t){return this.od(t)+this.id(t)}adj(t){return new Q9(this,this.oe(t))}v(){return this.x.keys()}nv(){return this.x.length}ne(){let t=0;for(const e of this.v())t+=this.od(e);return t}clear(){this._names.length=0,this._subpasses.length=0,this.x.length=0}addVertex(t,e){const i=new wtt,s=this.x.length;return this.x.push(i),this._names.push(t),this._subpasses.push(e),s}addEdge(t,e){return this.x[t].o.push(new q9(e)),this.x[e].i.push(new q9(t)),new $9(t,e)}vertexName(t){return this._names[t]}getName(t){return this._names[t]}setName(t,e){this._names[t]=e}getSubpass(t){return this._subpasses[t]}}class xtt{constructor(t,e,i){void 0===t&&(t=4294967295),void 0===e&&(e=1),void 0===i&&(i=0),this.rasterViews=new Map,this.computeViews=new Map,this.resolvePairs=[],this.viewport=new wd,this.showStatistics=!1,this.subpassID=t,this.count=e,this.quality=i}reset(t,e,i){this.rasterViews.clear(),this.computeViews.clear(),this.resolvePairs.length=0,att(this.viewport),this.subpassID=t,this.count=e,this.quality=i,this.showStatistics=!1}}class Ttt{constructor(t){void 0===t&&(t=4294967295),this.rasterViews=new Map,this.computeViews=new Map,this.subpassID=t}reset(t){this.rasterViews.clear(),this.computeViews.clear(),this.subpassID=t}}class Ctt{constructor(){this.rasterViews=new Map,this.computeViews=new Map,this.attachmentIndexMap=new Map,this.textures=new Map,this.subpassGraph=new Stt,this.width=0,this.height=0,this.count=1,this.quality=0,this.viewport=new wd,this.versionName="",this.version=0,this.hashValue=0,this.showStatistics=!1}reset(){this.rasterViews.clear(),this.computeViews.clear(),this.attachmentIndexMap.clear(),this.textures.clear(),this.subpassGraph.clear(),this.width=0,this.height=0,this.count=1,this.quality=0,att(this.viewport),this.versionName="",this.version=0,this.hashValue=0,this.showStatistics=!1}}class Itt{constructor(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.clearColors=[],this.clearDepth=0,this.clearStencil=0,this.renderPass=t,this.framebuffer=e}reset(t,e){this.renderPass=t,this.framebuffer=e,this.clearColors.length=0,this.clearDepth=0,this.clearStencil=0}}class Ett{constructor(){this.format=0}reset(){this.format=0}}class Dtt{constructor(){this.textureView=null,this.format=0,this.indexOrFirstMipLevel=0,this.numMipLevels=0,this.firstArraySlice=0,this.numArraySlices=0,this.firstPlane=0,this.numPlanes=0}reset(){this.textureView=null,this.format=0,this.indexOrFirstMipLevel=0,this.numMipLevels=0,this.firstArraySlice=0,this.numArraySlices=0,this.firstPlane=0,this.numPlanes=0}}class Att{constructor(t,e){this.o=[],this.i=[],this.t=void 0,this.j=void 0,this.id=t,this.object=e,this.t=t,this.j=e}}class Mtt{constructor(){this.N=4294967295,this.x=[],this._names=[],this._descs=[],this._traits=[],this._states=[],this._samplerInfo=[],this._valueIndex=new Map,this.renderPasses=new Map,this.nextFenceValue=0,this.version=0}edge(t,e){for(const i of this.x[t].o)if(e===i.target)return!0;return!1}source(t){return t.source}target(t){return t.target}oe(t){return new X9(this.x[t].o.values(),t)}od(t){return this.x[t].o.length}ie(t){return new Y9(this.x[t].i.values(),t)}id(t){return this.x[t].i.length}d(t){return this.od(t)+this.id(t)}adj(t){return new Q9(this,this.oe(t))}v(){return this.x.keys()}nv(){return this.x.length}ne(){let t=0;for(const e of this.v())t+=this.od(e);return t}clear(){this.renderPasses.clear(),this.nextFenceValue=0,this.version=0,this._valueIndex.clear(),this._names.length=0,this._descs.length=0,this._traits.length=0,this._states.length=0,this._samplerInfo.length=0,this.x.length=0}addVertex(t,e,i,s,r,n,o,a){void 0===a&&(a=4294967295);const h=new Att(t,e),l=this.x.length;return this.x.push(h),this._names.push(i),this._descs.push(s),this._traits.push(r),this._states.push(n),this._samplerInfo.push(o),this._valueIndex.set(i,l),4294967295!==a&&this.addEdge(a,l),l}addEdge(t,e){return this.x[t].o.push(new q9(e)),this.x[e].i.push(new q9(t)),new $9(t,e)}vertexName(t){return this._names[t]}getName(t){return this._names[t]}setName(t,e){this._names[t]=e}getDesc(t){return this._descs[t]}getTraits(t){return this._traits[t]}getStates(t){return this._states[t]}getSampler(t){return this._samplerInfo[t]}h(t,e){return this.x[e].t===t}w(t){return this.x[t].t}object(t){return this.x[t].j}value(t,e){if(this.x[e].t===t)return this.x[e].j;throw Error("value id not match")}visitVertex(t,e){const i=this.x[e];switch(i.t){case 0:return t.managed(i.j);case 1:return t.managedBuffer(i.j);case 2:return t.managedTexture(i.j);case 3:return t.persistentBuffer(i.j);case 4:return t.persistentTexture(i.j);case 5:return t.framebuffer(i.j);case 6:return t.swapchain(i.j);case 7:return t.formatView(i.j);case 8:return t.subresourceView(i.j);default:throw Error("polymorphic type not found")}}j(t){return this.x[t].j}reference(t,e){for(const i of this.x[t].o)if(e===i.target)return!0;return!1}parent(t){return t.source}child(t){return t.target}children(t){return new X9(this.x[t].o.values(),t)}numChildren(t){return this.x[t].o.length}getParent(t){if(4294967295===t)return 4294967295;const e=this.x[t].i;return 0===e.length?4294967295:e[0].target}addReference(t,e){return this.addEdge(t,e)}contains(t){return this._valueIndex.has(t)}vertex(t){return this._valueIndex.get(t)}find(t){const e=this._valueIndex.get(t);return void 0===e?4294967295:e}}class Ptt{constructor(){this.computeViews=new Map,this.textures=new Map}reset(){this.computeViews.clear(),this.textures.clear()}}class Btt{constructor(){this.resolvePairs=[]}reset(){this.resolvePairs.length=0}}class Rtt{constructor(){this.copyPairs=[],this.uploadPairs=[]}reset(){this.copyPairs.length=0,this.uploadPairs.length=0}}class Ott{constructor(){this.movePairs=[]}reset(){this.movePairs.length=0}}class Ltt{constructor(){this.computeViews=new Map}reset(){this.computeViews.clear()}}class Ftt{constructor(t,e,i){void 0===t&&(t=""),void 0===e&&(e=7),void 0===i&&(i=new Sd),this.slotName=t,this.clearFlags=e,this.clearColor=i}reset(t,e){this.slotName=t,this.clearFlags=e,ott(this.clearColor)}}let ztt=class{constructor(t,e,i){void 0===t&&(t=1),void 0===e&&(e=4294967295),void 0===i&&(i=4294967295),this.viewport=null,this.hint=t,this.phaseID=e,this.passLayoutID=i}reset(t,e,i){this.hint=t,this.phaseID=e,this.passLayoutID=i,this.viewport=null}};class ktt{constructor(t,e,i,s,r,n){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=0),void 0===s&&(s=new A9),void 0===r&&(r=1),void 0===n&&(n=null),this.scene=t,this.camera=e,this.light=s,this.flags=i,this.cullingFlags=r,this.shadingLight=n}reset(t,e,i,s,r){this.scene=t,this.camera=e,this.light.reset(null,0,!1,null),this.flags=i,this.cullingFlags=s,this.shadingLight=r}}class Ntt{constructor(t,e,i,s,r){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),this.material=t,this.passID=e,this.threadGroupCountX=i,this.threadGroupCountY=s,this.threadGroupCountZ=r}reset(t,e,i,s,r){this.material=t,this.passID=e,this.threadGroupCountX=i,this.threadGroupCountY=s,this.threadGroupCountZ=r}}class Utt{constructor(t,e,i,s){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=null),this.material=t,this.passID=e,this.sceneFlags=i,this.camera=s}reset(t,e,i,s){this.material=t,this.passID=e,this.sceneFlags=i,this.camera=s}}class Vtt{constructor(){this.constants=new Map,this.buffers=new Map,this.textures=new Map,this.samplers=new Map,this.custom=""}reset(){this.constants.clear(),this.buffers.clear(),this.textures.clear(),this.samplers.clear(),this.custom=""}}class Htt{constructor(t,e){this.o=[],this.i=[],this.c=[],this.p=[],this.t=void 0,this.j=void 0,this.id=t,this.object=e,this.t=t,this.j=e}}class Gtt{constructor(){this.N=4294967295,this.x=[],this._names=[],this._layoutNodes=[],this._data=[],this._valid=[],this.index=new Map,this.sortedVertices=[]}edge(t,e){for(const i of this.x[t].o)if(e===i.target)return!0;return!1}source(t){return t.source}target(t){return t.target}oe(t){return new X9(this.x[t].o.values(),t)}od(t){return this.x[t].o.length}ie(t){return new Y9(this.x[t].i.values(),t)}id(t){return this.x[t].i.length}d(t){return this.od(t)+this.id(t)}adj(t){return new Q9(this,this.oe(t))}v(){return this.x.keys()}nv(){return this.x.length}ne(){let t=0;for(const e of this.v())t+=this.od(e);return t}clear(){this.index.clear(),this.sortedVertices.length=0,this._names.length=0,this._layoutNodes.length=0,this._data.length=0,this._valid.length=0,this.x.length=0}addVertex(t,e,i,s,r,n,o){void 0===o&&(o=4294967295);const a=new Htt(t,e),h=this.x.length;return this.x.push(a),this._names.push(i),this._layoutNodes.push(s),this._data.push(r),this._valid.push(n),4294967295!==o&&(this.x[o].c.push(new q9(h)),a.p.push(new q9(o))),h}addEdge(t,e){return this.x[t].o.push(new q9(e)),this.x[e].i.push(new q9(t)),new $9(t,e)}vertexName(t){return this._names[t]}getName(t){return this._names[t]}setName(t,e){this._names[t]=e}getLayout(t){return this._layoutNodes[t]}setLayout(t,e){this._layoutNodes[t]=e}getData(t){return this._data[t]}getValid(t){return this._valid[t]}setValid(t,e){this._valid[t]=e}h(t,e){return this.x[e].t===t}w(t){return this.x[t].t}object(t){return this.x[t].j}value(t,e){if(this.x[e].t===t)return this.x[e].j;throw Error("value id not match")}visitVertex(t,e){const i=this.x[e];switch(i.t){case 0:return t.rasterPass(i.j);case 1:return t.rasterSubpass(i.j);case 2:return t.computeSubpass(i.j);case 3:return t.compute(i.j);case 4:return t.resolve(i.j);case 5:return t.copy(i.j);case 6:return t.move(i.j);case 7:return t.raytrace(i.j);case 8:return t.queue(i.j);case 9:return t.scene(i.j);case 10:return t.blit(i.j);case 11:return t.dispatch(i.j);case 12:return t.clear(i.j);case 13:return t.viewport(i.j);default:throw Error("polymorphic type not found")}}j(t){return this.x[t].j}reference(t,e){for(const i of this.x[t].c)if(e===i.target)return!0;return!1}parent(t){return t.source}child(t){return t.target}children(t){return new X9(this.x[t].c.values(),t)}numChildren(t){return this.x[t].c.length}getParent(t){if(4294967295===t)return 4294967295;const e=this.x[t].p;return 0===e.length?4294967295:e[0].target}addReference(t,e){return this.x[t].c.push(new q9(e)),this.x[e].p.push(new q9(t)),new $9(t,e)}}function Wtt(t){return new nn((()=>new t),16)}class jtt{constructor(t){this.renderCommon=void 0,this.cv=Wtt(htt),this.rv=Wtt(ltt),this.cv1=Wtt(ctt),this.rd=Wtt(utt),this.rt=Wtt(dtt),this.rs=Wtt(ptt),this.rs1=Wtt(_tt),this.mb=Wtt(gtt),this.pb=Wtt(ftt),this.mt=Wtt(mtt),this.pt=Wtt(ytt),this.mr=Wtt(vtt),this.s=Wtt(btt),this.sg=Wtt(Stt),this.rs2=Wtt(xtt),this.cs=Wtt(Ttt),this.rp=Wtt(Ctt),this.prpaf=Wtt(Itt),this.fv=Wtt(Ett),this.sv=Wtt(Dtt),this.rg=Wtt(Mtt),this.cp=Wtt(Ptt),this.rp1=Wtt(Btt),this.cp1=Wtt(Rtt),this.mp=Wtt(Ott),this.rp2=Wtt(Ltt),this.cv2=Wtt(Ftt),this.rq=Wtt(ztt),this.sd=Wtt(ktt),this.d=Wtt(Ntt),this.b=Wtt(Utt),this.rd1=Wtt(Vtt),this.rg1=Wtt(Gtt),this.renderCommon=t}reset(){this.cv.reset(),this.rv.reset(),this.cv1.reset(),this.rd.reset(),this.rt.reset(),this.rs.reset(),this.rs1.reset(),this.mb.reset(),this.pb.reset(),this.mt.reset(),this.pt.reset(),this.mr.reset(),this.s.reset(),this.sg.reset(),this.rs2.reset(),this.cs.reset(),this.rp.reset(),this.prpaf.reset(),this.fv.reset(),this.sv.reset(),this.rg.reset(),this.cp.reset(),this.rp1.reset(),this.cp1.reset(),this.mp.reset(),this.rp2.reset(),this.cv2.reset(),this.rq.reset(),this.sd.reset(),this.d.reset(),this.b.reset(),this.rd1.reset(),this.rg1.reset()}createClearValue(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0);const r=this.cv.add();return r.reset(t,e,i,s),r}createRasterView(t,e,i,s,r,n,o){void 0===t&&(t=""),void 0===e&&(e=2),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=7),void 0===o&&(o=0);const a=this.rv.add();return a.reset(t,e,i,s,r,n,o),a}createComputeView(t,e,i,s,r){void 0===t&&(t=""),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0);const n=this.cv1.add();return n.reset(t,e,i,s,r),n}createResourceDesc(){const t=this.rd.add();return t.reset(),t}createResourceTraits(t){void 0===t&&(t=0);const e=this.rt.add();return e.reset(t),e}createRenderSwapchain(t,e){void 0===t&&(t=null),void 0===e&&(e=!1);const i=this.rs.add();return i.reset(t,e),i}createResourceStates(){const t=this.rs1.add();return t.reset(),t}createManagedBuffer(t){void 0===t&&(t=null);const e=this.mb.add();return e.reset(t),e}createPersistentBuffer(t){void 0===t&&(t=null);const e=this.pb.add();return e.reset(t),e}createManagedTexture(t){void 0===t&&(t=null);const e=this.mt.add();return e.reset(t),e}createPersistentTexture(t){void 0===t&&(t=null);const e=this.pt.add();return e.reset(t),e}createManagedResource(){const t=this.mr.add();return t.reset(),t}createSubpass(){const t=this.s.add();return t.reset(),t}createSubpassGraph(){const t=this.sg.add();return t.clear(),t}createRasterSubpass(t,e,i){void 0===t&&(t=4294967295),void 0===e&&(e=1),void 0===i&&(i=0);const s=this.rs2.add();return s.reset(t,e,i),s}createComputeSubpass(t){void 0===t&&(t=4294967295);const e=this.cs.add();return e.reset(t),e}createRasterPass(){const t=this.rp.add();return t.reset(),t}createPersistentRenderPassAndFramebuffer(t,e){void 0===t&&(t=null),void 0===e&&(e=null);const i=this.prpaf.add();return i.reset(t,e),i}createFormatView(){const t=this.fv.add();return t.reset(),t}createSubresourceView(){const t=this.sv.add();return t.reset(),t}createResourceGraph(){const t=this.rg.add();return t.clear(),t}createComputePass(){const t=this.cp.add();return t.reset(),t}createResolvePass(){const t=this.rp1.add();return t.reset(),t}createCopyPass(){const t=this.cp1.add();return t.reset(),t}createMovePass(){const t=this.mp.add();return t.reset(),t}createRaytracePass(){const t=this.rp2.add();return t.reset(),t}createClearView(t,e){void 0===t&&(t=""),void 0===e&&(e=7);const i=this.cv2.add();return i.reset(t,e),i}createRenderQueue(t,e,i){void 0===t&&(t=1),void 0===e&&(e=4294967295),void 0===i&&(i=4294967295);const s=this.rq.add();return s.reset(t,e,i),s}createSceneData(t,e,i,s,r){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=0),void 0===s&&(s=1),void 0===r&&(r=null);const n=this.sd.add();return n.reset(t,e,i,s,r),n}createDispatch(t,e,i,s,r){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0);const n=this.d.add();return n.reset(t,e,i,s,r),n}createBlit(t,e,i,s){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=null);const r=this.b.add();return r.reset(t,e,i,s),r}createRenderData(){const t=this.rd1.add();return t.reset(),t}createRenderGraph(){const t=this.rg1.add();return t.clear(),t}}class $tt{constructor(){this.subpass=0}}class qtt{constructor(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=1),this.descriptorID=t,this.type=e,this.count=i}reset(t,e,i){this.descriptorID=t,this.type=e,this.count=i}}class Xtt{constructor(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.offset=0,this.descriptors=[],this.type=t,this.visibility=e,this.capacity=i}reset(t,e,i){this.type=t,this.visibility=e,this.offset=0,this.capacity=i,this.descriptors.length=0}}class Ytt{constructor(t,e,i,s,r){void 0===t&&(t=4294967295),void 0===e&&(e=0),void 0===i&&(i=[]),void 0===s&&(s=new Map),void 0===r&&(r=new Map),this.uniformBlockCapacity=0,this.samplerTextureCapacity=0,this.slot=t,this.capacity=e,this.descriptorBlocks=i,this.uniformBlocks=s,this.bindingMap=r}reset(t,e){this.slot=t,this.capacity=e,this.uniformBlockCapacity=0,this.samplerTextureCapacity=0,this.descriptorBlocks.length=0,this.uniformBlocks.clear(),this.bindingMap.clear()}}class Qtt{constructor(t,e,i){void 0===t&&(t=new Ytt),void 0===e&&(e=null),void 0===i&&(i=null),this.descriptorSetLayoutInfo=new rp,this.descriptorSetLayoutData=t,this.descriptorSetLayout=e,this.descriptorSet=i}reset(t,e){this.descriptorSetLayoutData.reset(4294967295,0),this.descriptorSetLayoutInfo.bindings.length=0,this.descriptorSetLayout=t,this.descriptorSet=e}}class Ktt{constructor(){this.descriptorSets=new Map}reset(){this.descriptorSets.clear()}}class Ztt{constructor(){this.descriptorBindings=new Map}reset(){this.descriptorBindings.clear()}}class Jtt{constructor(){this.layoutData=new Map,this.bindingData=new Map}reset(){this.layoutData.clear(),this.bindingData.clear()}}class tet{constructor(){this.passes=[]}reset(){this.passes.length=0}}class eet{constructor(){this.techniques=new Map}reset(){this.techniques.clear()}}class iet{constructor(){this.layout=new Ktt,this.pipelineLayout=null}reset(){this.layout.reset(),this.pipelineLayout=null}}class set{constructor(){this.descriptorVisibility=new Map}reset(){this.descriptorVisibility.clear()}}class ret{constructor(){this.rootSignature="",this.shaderPrograms=[],this.shaderIndex=new Map,this.pipelineLayout=null}reset(){this.rootSignature="",this.shaderPrograms.length=0,this.shaderIndex.clear(),this.pipelineLayout=null}}class net{constructor(t,e){this.o=[],this.i=[],this.t=void 0,this.j=void 0,this.id=t,this.object=e,this.t=t,this.j=e}}class oet{constructor(){this.N=4294967295,this.x=[],this._names=[],this._updateFrequencies=[],this._layouts=[],this.valueNames=[],this.attributeIndex=new Map,this.constantIndex=new Map,this.shaderLayoutIndex=new Map,this.effects=new Map,this.constantMacros=""}edge(t,e){for(const i of this.x[t].o)if(e===i.target)return!0;return!1}source(t){return t.source}target(t){return t.target}oe(t){return new X9(this.x[t].o.values(),t)}od(t){return this.x[t].o.length}ie(t){return new Y9(this.x[t].i.values(),t)}id(t){return this.x[t].i.length}d(t){return this.od(t)+this.id(t)}adj(t){return new Q9(this,this.oe(t))}v(){return this.x.keys()}nv(){return this.x.length}ne(){let t=0;for(const e of this.v())t+=this.od(e);return t}clear(){this.valueNames.length=0,this.attributeIndex.clear(),this.constantIndex.clear(),this.shaderLayoutIndex.clear(),this.effects.clear(),this.constantMacros="",this._names.length=0,this._updateFrequencies.length=0,this._layouts.length=0,this.x.length=0}addVertex(t,e,i,s,r,n){void 0===n&&(n=4294967295);const o=new net(t,e),a=this.x.length;return this.x.push(o),this._names.push(i),this._updateFrequencies.push(s),this._layouts.push(r),4294967295!==n&&this.addEdge(n,a),a}addEdge(t,e){return this.x[t].o.push(new q9(e)),this.x[e].i.push(new q9(t)),new $9(t,e)}vertexName(t){return this._names[t]}getName(t){return this._names[t]}getUpdate(t){return this._updateFrequencies[t]}setUpdate(t,e){this._updateFrequencies[t]=e}getLayout(t){return this._layouts[t]}h(t,e){return this.x[e].t===t}w(t){return this.x[t].t}object(t){return this.x[t].j}value(t,e){if(this.x[e].t===t)return this.x[e].j;throw Error("value id not match")}visitVertex(t,e){const i=this.x[e];switch(i.t){case 0:return t.renderStage(i.j);case 1:return t.renderPhase(i.j);default:throw Error("polymorphic type not found")}}j(t){return this.x[t].j}reference(t,e){for(const i of this.x[t].o)if(e===i.target)return!0;return!1}parent(t){return t.source}child(t){return t.target}children(t){return new X9(this.x[t].o.values(),t)}numChildren(t){return this.x[t].o.length}getParent(t){if(4294967295===t)return 4294967295;const e=this.x[t].i;return 0===e.length?4294967295:e[0].target}addReference(t,e){return this.addEdge(t,e)}locateChild(t,e){if(4294967295===t){for(const t of this.x.keys())if(0===this.x[t].i.length&&this._names[t]===e)return t;return 4294967295}for(const i of this.x[t].o){const t=i.target;if(e===this._names[t])return t}return 4294967295}locate(t){return Z9(this,4294967295,t)}locateRelative(t,e){return void 0===e&&(e=4294967295),Z9(this,e,t)}path(t){return K9(this,t)}}function aet(t,e){e.descriptorID=t.n(),e.type=t.n(),e.count=t.n()}function het(t,e){e.type=t.n(),e.visibility=t.n(),e.offset=t.n(),e.capacity=t.n();let i=0;i=t.n(),e.descriptors.length=i;for(let s=0;s!==i;++s){const i=new qtt;aet(t,i),e.descriptors[s]=i}}function cet(t,e){e.slot=t.n(),e.capacity=t.n(),e.uniformBlockCapacity=t.n(),e.samplerTextureCapacity=t.n();let i=0;i=t.n(),e.descriptorBlocks.length=i;for(let s=0;s!==i;++s){const i=new Xtt;het(t,i),e.descriptorBlocks[s]=i}i=t.n();for(let s=0;s!==i;++s){const i=t.n(),s=new Fd;I9(t,s),e.uniformBlocks.set(i,s)}i=t.n();for(let s=0;s!==i;++s){const i=t.n(),s=t.n();e.bindingMap.set(i,s)}}function uet(t,e){cet(t,e.descriptorSetLayoutData),D9(t,e.descriptorSetLayoutInfo)}function det(t,e){let i=0;i=t.n();for(let s=0;s!==i;++s){const i=t.n(),s=new Qtt;uet(t,s),e.descriptorSets.set(i,s)}}function pet(t,e){let i=0;i=t.n();for(let s=0;s!==i;++s){const i=t.n(),s=t.n();e.descriptorBindings.set(i,s)}}function _et(t,e){let i=0;i=t.n();for(let s=0;s!==i;++s){const i=t.n(),s=new Ytt;cet(t,s),e.layoutData.set(i,s)}i=t.n();for(let s=0;s!==i;++s){const i=t.n(),s=new Ztt;pet(t,s),e.bindingData.set(i,s)}}function get(t,e){let i=0;i=t.n(),e.passes.length=i;for(let s=0;s!==i;++s){const i=new Jtt;_et(t,i),e.passes[s]=i}}function fet(t,e){let i=0;i=t.n();for(let s=0;s!==i;++s){const i=t.s(),s=new tet;get(t,s),e.techniques.set(i,s)}}function met(t,e){det(t,e.layout)}function yet(t,e){let i=0;i=t.n();for(let s=0;s!==i;++s){const i=t.n(),s=t.n();e.descriptorVisibility.set(i,s)}}function vet(t,e){e.rootSignature=t.s();let i=0;i=t.n(),e.shaderPrograms.length=i;for(let s=0;s!==i;++s){const i=new iet;met(t,i),e.shaderPrograms[s]=i}i=t.n();for(let s=0;s!==i;++s){const i=t.s(),s=t.n();e.shaderIndex.set(i,s)}}function bet(t,e){const i=t.n();t.n(),t.n(),t.n();for(let s=0;s!==i;++s){const i=t.n(),s=t.n(),r=t.s(),n=t.n(),o=new Ktt;switch(det(t,o),i){case 0:{const i=new set;yet(t,i),e.addVertex(0,i,r,n,o,s);break}case 1:{const i=new ret;vet(t,i),e.addVertex(1,i,r,n,o,s);break}}}let s=0;s=t.n(),e.valueNames.length=s;for(let i=0;i!==s;++i)e.valueNames[i]=t.s();s=t.n();for(let i=0;i!==s;++i){const i=t.s(),s=t.n();e.attributeIndex.set(i,s)}s=t.n();for(let i=0;i!==s;++i){const i=t.s(),s=t.n();e.constantIndex.set(i,s)}s=t.n();for(let i=0;i!==s;++i){const i=t.s(),s=t.n();e.shaderLayoutIndex.set(i,s)}s=t.n();for(let i=0;i!==s;++i){const i=t.s(),s=new eet;fet(t,s),e.effects.set(i,s)}}class wet{constructor(t){this.colors=void 0,this.colors=new Array(t)}get(t){return this.colors[t]}put(t,e){this.colors[t]=e}}function xet(t){switch(t){case 1:case 5:case 9:case 13:return 1;case 6:case 14:case 10:case 2:return 2;case 15:case 3:case 11:case 7:return 3;case 4:case 16:case 12:case 8:case 17:return 4;case 18:case 20:return 6;case 19:case 23:return 8;case 21:return 9;case 22:case 24:return 12;case 25:return 16;default:return 0}}function Tet(t,e){let i=1;return 1&t||0!==e||(i=8&t?1:0),6&~t&&1===e&&(2&t||(i=0),4&t||(i=0)),i}function Cet(t,e,i,s,r,n){void 0===s&&(s=null),void 0===r&&(r=0),void 0===n&&(n=void 0),n=n||new _d;const o=t?t.viewport:new _d(0,0,1,1),a=e,l=i;if(n.x=o.x*a,n.y=o.y*l,n.width=o.width*a,n.height=o.height*l,s)switch(s.type){case 0:{const t=s;if(t.shadowFixedArea||t.csmLevel===Kw.LEVEL_1)n.x=0,n.y=0,n.width=a,n.height=l;else{const t=h.director.root.device.capabilities.screenSpaceSignY;n.x=r%2*.5*a,n.y=t>0?.5*(1-Math.floor(r/2))*l:.5*Math.floor(r/2)*l,n.width=.5*a,n.height=.5*l}break}case 2:n.x=0,n.y=0,n.width=a,n.height=l}return n}function Iet(t,e,i,s,r){const n=`Camera${r}`,o=i.renderArea(),a=o.x,h=o.y,l=i.camera,c=`reflectionProbePassColor${n}`,u=`reflectionProbePassDS${n}`;e.containsResource(c)||(e.addRenderWindow(c,35,a,h,s),e.addDepthStencil(u,55,a,h,3)),e.updateRenderWindow(c,s),e.updateDepthStencil(u,a,h);const d=e.addRenderPass(a,h,"default");d.name=`ReflectionProbePass${r}`,d.setViewport(new wd(0,0,a,h)),d.addRenderTarget(c,Tet(l.clearFlag,0),0,new Sd(l.clearColor.x,l.clearColor.y,l.clearColor.z,l.clearColor.w)),d.addDepthStencil(u,Tet(l.clearFlag,1),0,l.clearDepth,l.clearStencil,l.clearFlag);const p=d.addQueue(1,"reflect-map"),_=new A9;_.probe=i,p.addSceneOfCamera(t,_,8193),Eet(p,l,e)}function Eet(t,e,i){const s=h.director.root.pipeline,r=i.pipelineSceneData,n=r.skybox;t.setMat4("cc_matView",e.matView),t.setMat4("cc_matViewInv",e.node.worldMatrix),t.setMat4("cc_matProj",e.matProj),t.setMat4("cc_matProjInv",e.matProjInv),t.setMat4("cc_matViewProj",e.matViewProj),t.setMat4("cc_matViewProjInv",e.matViewProjInv),t.setVec4("cc_cameraPos",new cr(e.position.x,e.position.y,e.position.z,s.getCombineSignY())),t.setVec4("cc_surfaceTransform",new cr(e.surfaceTransform,0,Math.cos(vi(n.getRotationAngle())),Math.sin(vi(n.getRotationAngle())))),t.setVec4("cc_screenScale",new cr(r.shadingScale,r.shadingScale,1/r.shadingScale,1/r.shadingScale)),t.setVec4("cc_exposure",new cr(e.exposure,1/e.exposure,r.isHDR?1:0,1/_A.standardExposureValue))}function Det(t,e,i){i instanceof Mp?t.bindBuffer(e,i):i instanceof Yp?t.bindTexture(e,i):i instanceof qp&&t.bindSampler(e,i)}function Aet(t,e,i){Det(t,e,i)}function Met(t,e){const i=e;for(const e of i.descriptorSetLayoutData.descriptorBlocks)for(let i=0;i!==e.descriptors.length;++i)if(t===e.descriptors[i].descriptorID)return e.offset+i;return-1}new Qn(0,0,0,.5,.5,.5),new Qn,new class{constructor(){this.shadowEnabled=!1,this.mainLightShadowNames=new Array,this.spotLightShadowNames=new Array,this.validLights=[]}reset(){this.shadowEnabled=!1,this.mainLightShadowNames.length=0,this.spotLightShadowNames.length=0,this.validLights.length=0}};class Pet{constructor(t,e){void 0===e&&(e=2),this.buffers=[],this.currBuffIdx=0,this.device=void 0,this.currUniform=void 0,this._root=void 0;const i=(this._root=h.director.root).device;this.device=i,this.currUniform=new Float32Array(t/4);for(let i=0;i<e;i++){const e=new Ed(18,3,t,t);this.buffers.push(this.device.createBuffer(e))}}getCurrentBuffer(){const{director:t}=h;return this.currBuffIdx=t.getTotalFrames()%this.buffers.length,this.buffers[this.currBuffIdx]}updateData(t){this.currUniform.set(t)}updateBuffer(t,e){const i=e.descriptorSet,s=this.getCurrentBuffer();s.update(this.currUniform),Aet(i,t,s)}}const Bet=new Map,Ret=new Map,Oet=new Map;function Let(t){const e=Oet.get(t);if(e)return e;const i=h.director.root.pipeline,s=i.layoutGraph.locateChild(i.layoutGraph.N,t),r=i.layoutGraph.getLayout(s).descriptorSets.get(3);return Oet.set(t,r),r}function Fet(t,e,i,s){void 0===s&&(s="default"),qet(s,e,i,t)}function zet(t,e){const i=h.director.root.pipeline.layoutGraph,s=i.locateChild(4294967295,e),r=i.getLayout(s).descriptorSets.get(3).descriptorSetLayoutData,n=i.attributeIndex.get(t);return r.uniformBlocks.get(n)}function ket(t,e,i){const s=zet(e,i);if(!s)return-1;let r=0;for(const e of s.members){const i=xet(e.type);if(e.name===t)return r;r+=i*e.count}return-1}const Net=new Map;class Uet{constructor(){this.offset=-1,this.buffer=[],this.blockId=-1}}const Vet=new Map;function Het(t,e,i){let s=!1;if(i<0||i>t.length)return s;const r=Math.min(e.length,t.length-i);for(let n=0;n<r;n++)t[i+n]!==e[n]&&(t[i+n]=e[n],s=!0);return s}function Get(t,e){let i=Net.get(t);if(i)return i;i=[],h.director.root.pipeline.layoutGraph;let s=0;const r=zet(t,e);if(!r)return null;for(const t of r.members)s+=xet(t.type)*t.count;return i.length=s,i.fill(0),Net.set(t,i),i}function Wet(t,e){let i=Bet.get(t);i||(Bet.set(t,new Pet(4*e.length,2)),i=Bet.get(t)),i.updateData(e)}function jet(t,e,i,s,r){const n=t.blockId,o=t.buffer,a=Het(o,e,t.offset),h=Met(n,i),l=i.descriptorSet;if(a||!l.getBuffer(h)&&-1!==h){const t=`${n}${h}${r}${s}`;Ret.set(t,h),Wet(t,o)}}function $et(t,e,i,s,r){const n=Met(t,r);if(-1===n)return;const o=`${t}${n}${i}${e}`;Ret.set(o,n),Wet(o,s)}function qet(t,e,i,s){const{constants:r,samplers:n,textures:o,buffers:a}=s,l=h.director.root.pipeline,c=l.layoutGraph,u=Let(t);Ret.clear();for(const[s,n]of r){let r=Vet.get(s);if(r)jet(r,n,u,e,i);else{const o=Array.from(c.constantIndex).find((t=>{let[e,i]=t;return i===s}))[0];for(const[a,h]of c.attributeIndex){const l=Get(a,t);if(!l)continue;const c=ket(o,a,t);-1!==c?(Vet.set(s,new Uet),r=Vet.get(s),r.buffer=l,r.blockId=h,r.offset=c,jet(r,n,u,e,i)):$et(h,e,i,l,u)}}}const d=u.descriptorSet;for(const[t,e]of o){const i=Met(t,u);if(-1===i)continue;const s=d.getTexture(i);s&&e===l.defaultShadowTexture&&(s.gpuTexture||s.gpuTextureView&&s.gpuTextureView.gpuTexture)||Aet(d,i,e)}for(const[t,e]of n){const i=Met(t,u);-1!==i&&(d.getSampler(i)&&e===l.defaultSampler||Aet(d,i,e))}for(const[t,e]of Ret)Bet.get(t).updateBuffer(e,u);for(const[t,e]of a){const i=Met(t,u);-1!==i&&(d.getBuffer(i)||Aet(d,i,e))}}function Xet(t){return`${t}-`}function Yet(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return e}function Qet(t){return!!t}function Ket(t,e){return t+(e-1)&~(e-1)}function Zet(t,e,i,s,r,n){const o=new Float32Array(4);let a=0,h=0,l=0,c=0;if(t&&1===t.type){const e=t;o[0]=e.position.x,o[1]=e.position.y,o[2]=e.position.z,o[3]=1,a=e.size,h=e.range,l=e.luminanceHDR,c=e.luminanceLDR}else if(t&&2===t.type){const e=t;o[0]=e.position.x,o[1]=e.position.y,o[2]=e.position.z,o[3]=2,a=e.size,h=e.range,l=e.luminanceHDR,c=e.luminanceLDR}else if(t&&3===t.type){const e=t;o[0]=e.position.x,o[1]=e.position.y,o[2]=e.position.z,o[3]=3,a=0,h=e.range,l=e.luminanceHDR,c=e.luminanceLDR}else if(t&&4===t.type){const e=t;o[0]=e.position.x,o[1]=e.position.y,o[2]=e.position.z,o[3]=4,a=0,h=0,l=e.illuminanceHDR,c=e.illuminanceLDR}let u=n+0;r.set(o,u),u=n+8,o.set([a,h,0,0]),r.set(o,u),u=n+4;const d=t?t.color:new Sd;if(t&&t.useColorTemperature){const e=t.colorTemperatureRGB;r[u++]=d.x*e.x,r[u++]=d.y*e.y,r[u++]=d.z*e.z}else r[u++]=d.x,r[u++]=d.y,r[u++]=d.z;switch(r[u]=e?l*i*1e4:c,t?t.type:5){case 1:case 3:r[n+8+2]=0,r[n+8+3]=0;break;case 2:{const e=t;r[n+8+2]=e.spotAngle,r[n+8+3]=s&&s.enabled&&e.shadowEnabled&&s.type===Yw.ShadowMap?1:0,u=n+12;const i=e.direction;r[u++]=i.x,r[u++]=i.y,r[u]=i.z,r[n+16+0]=0,r[n+16+1]=0,r[n+16+2]=0,r[n+16+3]=e.angleAttenuationStrength}break;case 4:{const e=t,i=e.right;r[n+8+0]=i.x,r[n+8+1]=i.y,r[n+8+2]=i.z,r[n+8+3]=0;const s=e.direction;r[n+12+0]=s.x,r[n+12+1]=s.y,r[n+12+2]=s.z,r[n+12+3]=0;const o=e.scale;r[n+16+0]=.5*o.x,r[n+16+1]=.5*o.y,r[n+16+2]=.5*o.z,r[n+16+3]=0}}}function Jet(t){let e="";for(const[i,s]of t.rasterViews)e+=Xet(i),e+=Xet(s.slotName),e+=Xet(s.accessType),e+=Xet(s.attachmentType),e+=Xet(s.loadOp),e+=Xet(s.storeOp),e+=Xet(s.clearFlags),e+=Xet(s.clearColor.x),e+=Xet(s.clearColor.y),e+=Xet(s.clearColor.z),e+=Xet(s.clearColor.w),e+=Xet(s.slotID),e+=Xet(s.shaderStageFlags);for(const[i,s]of t.computeViews){e+=Xet(i);for(const t of s)e+=Xet(t.name),e+=Xet(t.accessType),e+=Xet(t.clearFlags),e+=Xet(t.clearValueType),e+=Xet(t.clearValue.x),e+=Xet(t.clearValue.y),e+=Xet(t.clearValue.z),e+=Xet(t.clearValue.w),e+=Xet(t.shaderStageFlags)}e+=Xet(t.width),e+=Xet(t.height),e+=Xet(t.viewport.left),e+=Xet(t.viewport.top),e+=Xet(t.viewport.width),e+=Xet(t.viewport.height),e+=Xet(t.viewport.minDepth),e+=Xet(t.viewport.maxDepth),e+=Xet(t.showStatistics?1:0),t.hashValue=Yet(e)}const tit=new cr,eit=new Ki,iit=new Sd,sit=new Rs,rit=new Rs;function nit(t,e){const i=e.skybox,s=h.director.root,r=s.pipeline;if(i.reflectionMap){const e=i.reflectionMap.getGFXTexture(),r=s.device.getSampler(i.reflectionMap.getSamplerInfo());t.setTexture("cc_environment",e),t.setSampler("cc_environment",r)}else{const e=i.envmap?i.envmap:pw.get("default-cube-texture");if(e){const i=e.getGFXTexture(),r=s.device.getSampler(e.getSamplerInfo());t.setTexture("cc_environment",i),t.setSampler("cc_environment",r)}}const n=i.diffuseMap?i.diffuseMap:pw.get("default-cube-texture");if(n){const e=n.getGFXTexture(),i=s.device.getSampler(n.getSamplerInfo());t.setTexture("cc_diffuseMap",e),t.setSampler("cc_diffuseMap",i)}t.hasSampler("cc_shadowMap")||t.setSampler("cc_shadowMap",r.defaultSampler),t.hasTexture("cc_shadowMap")||t.setTexture("cc_shadowMap",r.defaultShadowTexture),t.hasSampler("cc_spotShadowMap")||t.setSampler("cc_spotShadowMap",r.defaultSampler),t.hasTexture("cc_spotShadowMap")||t.setTexture("cc_spotShadowMap",r.defaultShadowTexture)}function oit(t,e,i,s){var r;const n=h.director.root.pipeline,o=i.shadows,a=i.skybox,l=i.shadingScale;e&&(t.setMat4("cc_matView",e.matView),t.setMat4("cc_matViewInv",e.node.worldMatrix),t.setMat4("cc_matProj",e.matProj),t.setMat4("cc_matProjInv",e.matProjInv),t.setMat4("cc_matViewProj",e.matViewProj),t.setMat4("cc_matViewProjInv",e.matViewProjInv),tit.set(e.surfaceTransform,e.cameraUsage,Math.cos(vi(a.getRotationAngle())),Math.sin(vi(a.getRotationAngle()))),t.setVec4("cc_surfaceTransform",tit),tit.set(e.exposure,1/e.exposure,i.isHDR?1:0,1/_A.standardExposureValue),t.setVec4("cc_exposure",tit)),e?tit.set(e.position.x,e.position.y,e.position.z,n.getCombineSignY()):tit.set(0,0,0,n.getCombineSignY()),t.setVec4("cc_cameraPos",tit),tit.set(i.shadingScale,i.shadingScale,1/i.shadingScale,1/i.shadingScale),t.setVec4("cc_screenScale",tit);const c=s&&s.mainLight;if(c){const s=c.shadowEnabled&&o.type===Yw.ShadowMap?1:0;tit.set(c.direction.x,c.direction.y,c.direction.z,s),t.setVec4("cc_mainLitDir",tit);let r=c.color.x,n=c.color.y,a=c.color.z;c.useColorTemperature&&(r*=c.colorTemperatureRGB.x,n*=c.colorTemperatureRGB.y,a*=c.colorTemperatureRGB.z);let h=c.illuminance;i.isHDR&&e&&(h*=e.exposure),tit.set(r,n,a,h),t.setVec4("cc_mainLitColor",tit)}else tit.set(0,0,1,0),t.setVec4("cc_mainLitDir",tit),tit.set(0,0,0,0),t.setVec4("cc_mainLitColor",tit);const u=i.ambient,d=u.skyColor;i.isHDR?d.w=u.skyIllum*(e?e.exposure:1):d.w=u.skyIllum,tit.set(d.x,d.y,d.z,d.w),t.setVec4("cc_ambientSky",tit),tit.set(u.groundAlbedo.x,u.groundAlbedo.y,u.groundAlbedo.z,a.envmap?null===(r=a.envmap)||void 0===r?void 0:r.mipmapLevel:1),t.setVec4("cc_ambientGround",tit);const p=i.fog,_=p.colorArray;tit.set(_.x,_.y,_.z,_.z),t.setVec4("cc_fogColor",tit),tit.set(p.fogStart,p.fogEnd,p.fogDensity,0),t.setVec4("cc_fogBase",tit),tit.set(p.fogTop,p.fogRange,p.fogAtten,0),t.setVec4("cc_fogAdd",tit),e&&(tit.set(e.nearClip,e.farClip,e.getClipSpaceMinz(),0),t.setVec4("cc_nearFar",tit),tit.set(e.viewport.x,e.viewport.y,l*e.window.width*e.viewport.z,l*e.window.height*e.viewport.w),t.setVec4("cc_viewPort",tit))}class ait{constructor(t,e,i,s,r,n){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),this.subModel=void 0,this.priority=void 0,this.hash=void 0,this.depth=void 0,this.shaderID=void 0,this.passIndex=void 0,this.subModel=t,this.priority=e,this.hash=i,this.depth=s,this.shaderID=r,this.passIndex=n}update(t,e,i,s,r,n){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),this.subModel=t,this.priority=e,this.hash=i,this.depth=s,this.shaderID=r,this.passIndex=n}}const hit=new nn((()=>new ait),8),lit="CC_USE_RGBE_OUTPUT";function cit(t,e){const i=h.rendering;return i.getPhaseID(i.getPassID(t),e)}function uit(t,e){const i=t.passes;for(let t=0;t<i.length;t++)if(i[t].phaseID===e)return t;return-1}class dit{constructor(){this.probeMap=new Array,this.defaultId=cit("default","default")}clear(){this.probeMap.length=0}applyMacro(){for(const t of this.probeMap){let e=[{name:lit,value:!0}];t.patches&&(e=e.concat(t.patches)),t.onMacroPatchesStateChanged(e)}}removeMacro(){for(const t of this.probeMap){if(!t.patches)continue;const e=t.patches.filter((t=>t.name!==lit));0===e.length?t.onMacroPatchesStateChanged(null):t.onMacroPatchesStateChanged(e)}}addToProbeQueue(t,e){const i=t.subModels;for(let t=0;t<i.length;t++){const s=i[t];if(s.passes[0].blendState.targets[0].blend)continue;let r=uit(s,e),n=!0;r<0&&(r=uit(s,e=this.defaultId),n=!1),r<0||n||this.probeMap.push(s)}}}function pit(t,e,i,s){const r=h.director.root.pipeline,n=r.device,o=r.pipelineSceneData,a=o.shadows;if(a.type===Yw.Planar)return;const l=o.csmLayers,c=Vy(n)?0:1,u=r.device.capabilities;switch(a.enabled&&a.type===Yw.ShadowMap&&i&&i.node&&0===i.type&&l.update(o,e),i.type){case 0:{const e=i;if(a.enabled&&e&&e.shadowEnabled&&a.type===Yw.ShadowMap){let i,r,n,o=.1,h=0,u=0;if(e.shadowFixedArea||e.csmLevel===Kw.LEVEL_1)i=l.specialLayer.matShadowView,r=l.specialLayer.matShadowProj,n=l.specialLayer.matShadowViewProj,e.shadowFixedArea?(o=e.shadowNear,h=e.shadowFar,u=0):(o=.1,h=l.specialLayer.shadowCameraFar,u=1),tit.set(0,c,e.shadowNormalBias,0),t.setVec4("cc_shadowLPNNInfo",tit);else{const t=l.layers[s];i=t.matShadowView,r=t.matShadowProj,n=t.matShadowViewProj,o=t.splitCameraNear,h=t.splitCameraFar,u=e.csmLevel}t.setMat4("cc_matLightView",i),tit.set(r.m10,r.m14,r.m11,r.m15),t.setVec4("cc_shadowProjDepthInfo",tit),tit.set(r.m00,r.m05,1/r.m00,1/r.m05),t.setVec4("cc_shadowProjInfo",tit),t.setMat4("cc_matLightViewProj",n),tit.set(o,h,0,1-e.shadowSaturation),t.setVec4("cc_shadowNFLSInfo",tit),tit.set(0,c,e.shadowNormalBias,u),t.setVec4("cc_shadowLPNNInfo",tit),tit.set(a.size.x,a.size.y,e.shadowPcf,e.shadowBias),t.setVec4("cc_shadowWHPBInfo",tit)}break}case 2:{const e=i;if(a.enabled&&e&&e.shadowEnabled){Rs.invert(sit,e.node.getWorldMatrix()),t.setMat4("cc_matLightView",sit),Rs.perspective(rit,e.angle,1,.001,e.range,!0,u.clipSpaceMinZ,u.clipSpaceSignY,0);const s=rit.clone().invert(),r=rit.clone();Rs.multiply(sit,rit,sit),t.setMat4("cc_matLightViewProj",sit),tit.set(.01,i.range,0,0),t.setVec4("cc_shadowNFLSInfo",tit),tit.set(a.size.x,a.size.y,e.shadowPcf,e.shadowBias),t.setVec4("cc_shadowWHPBInfo",tit),tit.set(2,c,e.shadowNormalBias,0),t.setVec4("cc_shadowLPNNInfo",tit),tit.set(r.m10,r.m14,r.m11,r.m15),t.setVec4("cc_shadowProjDepthInfo",tit),tit.set(s.m10,s.m14,s.m11,s.m15),t.setVec4("cc_shadowInvProjDepthInfo",tit),tit.set(r.m00,r.m05,1/r.m00,1/r.m05),t.setVec4("cc_shadowProjInfo",tit)}break}case 1:tit.set(a.size.x,a.size.y,1,0),t.setVec4("cc_shadowWHPBInfo",tit),tit.set(1,c,0,0),t.setVec4("cc_shadowLPNNInfo",tit);break;case 3:tit.set(a.size.x,a.size.y,1,0),t.setVec4("cc_shadowWHPBInfo",tit),tit.set(3,c,0,0),t.setVec4("cc_shadowLPNNInfo",tit)}iit.set(a.shadowColor.x,a.shadowColor.y,a.shadowColor.z,a.shadowColor.w),t.setColor("cc_shadowColor",iit)}function _it(t,e){const i=t.size.x;switch(e.shadowPcf){case Qw.HARD:return 0;case Qw.SOFT:return 1/(.5*i);case Qw.SOFT_2X:return 2/(.5*i);case Qw.SOFT_4X:return 3/(.5*i)}return 0}function git(t,e){const i=h.director,s=i.root.pipeline,r=s.device,n=i.getScene(),o=e&&e.scene?e.scene.mainLight:n?n.renderScene.mainLight:null,a=s.pipelineSceneData,l=a.shadows,c=a.csmLayers,u=a.csmSupported,d=Vy(r)?0:1;if(o&&l.enabled){if(l.type===Yw.ShadowMap){if(o.shadowEnabled){if(o.shadowFixedArea||o.csmLevel===Kw.LEVEL_1||!u){const e=c.specialLayer.matShadowView,i=c.specialLayer.matShadowProj,s=c.specialLayer.matShadowViewProj,r=o.shadowNear,n=o.shadowFar;t.setMat4("cc_matLightView",e),tit.set(i.m10,i.m14,i.m11,i.m15),t.setVec4("cc_shadowProjDepthInfo",tit),tit.set(i.m00,i.m05,1/i.m00,1/i.m05),t.setVec4("cc_shadowProjInfo",tit),t.setMat4("cc_matLightViewProj",s),tit.set(r,n,0,1-o.shadowSaturation),t.setVec4("cc_shadowNFLSInfo",tit),tit.set(0,d,o.shadowNormalBias,0),t.setVec4("cc_shadowLPNNInfo",tit)}else{const e=_it(l,o);for(let i=0;i<o.csmLevel;i++){const s=c.layers[i],r=s.matShadowView;tit.set(r.m00,r.m04,r.m08,e),t.setVec4("cc_csmViewDir0",tit,i),tit.set(r.m01,r.m05,r.m09,s.splitCameraNear),t.setVec4("cc_csmViewDir1",tit,i),tit.set(r.m02,r.m06,r.m10,s.splitCameraFar),t.setVec4("cc_csmViewDir2",tit,i);const n=s.csmAtlas;t.setVec4("cc_csmAtlas",n,i);const o=s.matShadowViewProj;t.setMat4("cc_matCSMViewProj",o,i);const a=s.matShadowProj;tit.set(a.m10,a.m14,a.m11,a.m15),t.setVec4("cc_csmProjDepthInfo",tit,i),tit.set(a.m00,a.m05,1/a.m00,1/a.m05),t.setVec4("cc_csmProjInfo",tit,i)}tit.set(o.csmTransitionRange,0,0,0),t.setVec4("cc_csmSplitsInfo",tit),tit.set(.1,o.shadowDistance,0,1-o.shadowSaturation),t.setVec4("cc_shadowNFLSInfo",tit),tit.set(0,d,o.shadowNormalBias,o.csmLevel),t.setVec4("cc_shadowLPNNInfo",tit)}tit.set(l.size.x,l.size.y,o.shadowPcf,o.shadowBias),t.setVec4("cc_shadowWHPBInfo",tit)}}else Ki.normalize(eit,l.normal),tit.set(eit.x,eit.y,eit.z,-l.distance),t.setVec4("cc_planarNDInfo",tit),tit.set(0,0,0,l.planeBias),t.setVec4("cc_shadowWHPBInfo",tit);t.setMathColor("cc_shadowColor",l.shadowColor)}}class fit{constructor(t,e){this._data=void 0,this._lg=void 0,this._vertID=-1,this._currBlock=void 0,this._currStage="",this._currFrequency=3,this._currCount=void 0,this._currConstant=[],this._data=t,this._lg=e}get name(){return""}set name(t){}setMat4(t,e,i){void 0===i&&(i=0),fit.setMat4(this._lg,this._data,t,e,i)}static setMat4(t,e,i,s,r){void 0===r&&(r=0);const n=fit.getConstantInfo(t,e,i);Rs.toArray(n.dataArr,s,16*r),e.constants.set(n.constantID,n.dataArr)}setQuaternion(t,e,i){void 0===i&&(i=0),fit.setQuaternion(this._lg,this._data,t,e,i)}static setQuaternion(t,e,i,s,r){void 0===r&&(r=0);const n=fit.getConstantInfo(t,e,i);ys.toArray(n.dataArr,s,4*r),e.constants.set(n.constantID,n.dataArr)}setColor(t,e,i){void 0===i&&(i=0),fit.setColor(this._lg,this._data,t,e,i)}static setColor(t,e,i,s,r){void 0===r&&(r=0);const n=fit.getConstantInfo(t,e,i),o=4*r;n.dataArr[0+o]=s.x,n.dataArr[1+o]=s.y,n.dataArr[2+o]=s.z,n.dataArr[3+o]=s.w,e.constants.set(n.constantID,n.dataArr)}setMathColor(t,e,i){void 0===i&&(i=0),fit.setMathColor(this._lg,this._data,t,e,i)}static setMathColor(t,e,i,s,r){void 0===r&&(r=0);const n=fit.getConstantInfo(t,e,i);_r.toArray(n.dataArr,s,4*r),e.constants.set(n.constantID,n.dataArr)}static getConstantInfo(t,e,i){const s=t.constantIndex.get(i);if(void 0===s)throw new Error(`Constant with name ${i} not found.`);return{constantID:s,dataArr:e.constants.get(s)||[]}}setVec4(t,e,i){void 0===i&&(i=0),fit.setVec4(this._lg,this._data,t,e,i)}static setVec4(t,e,i,s,r){void 0===r&&(r=0);const n=fit.getConstantInfo(t,e,i);cr.toArray(n.dataArr,s,4*r),e.constants.set(n.constantID,n.dataArr)}setVec2(t,e,i){void 0===i&&(i=0),fit.setVec2(this._lg,this._data,t,e,i)}static setVec2(t,e,i,s,r){void 0===r&&(r=0);const n=fit.getConstantInfo(t,e,i);Qs.toArray(n.dataArr,s,2*r),e.constants.set(n.constantID,n.dataArr)}setFloat(t,e,i){void 0===i&&(i=0),fit.setFloat(this._lg,this._data,t,e,i)}static setFloat(t,e,i,s,r){void 0===r&&(r=0);const n=fit.getConstantInfo(t,e,i);n.dataArr[0+r]=s,e.constants.set(n.constantID,n.dataArr)}setArrayBuffer(t,e){fit.setArrayBuffer(this._lg,this._data,t,e)}static setArrayBuffer(t,e,i,s){throw new Error("Method not implemented.")}setBuffer(t,e){fit.setBuffer(this._lg,this._data,t,e)}static setBuffer(t,e,i,s){const r=t.attributeIndex.get(i);e.buffers.set(r,s)}setTexture(t,e){fit.setTexture(this._lg,this._data,t,e)}static setTexture(t,e,i,s){const r=t.attributeIndex.get(i);e.textures.set(r,s)}setReadWriteBuffer(t,e){fit.setReadWriteBuffer(this._lg,this._data,t,e)}static setReadWriteBuffer(t,e,i,s){const r=t.attributeIndex.get(i);e.buffers.set(r,s)}setReadWriteTexture(t,e){fit.setReadWriteTexture(this._lg,this._data,t,e)}static setReadWriteTexture(t,e,i,s){const r=t.attributeIndex.get(i);e.textures.set(r,s)}setSampler(t,e){fit.setSampler(this._lg,this._data,t,e)}static setSampler(t,e,i,s){const r=t.attributeIndex.get(i);e.samplers.set(r,s)}getParentLayout(){const t=h.director.root.pipeline,e=t.renderGraph.getParent(this._vertID);return t.renderGraph.getLayout(e)}getCurrentLayout(){return h.director.root.pipeline.renderGraph.getLayout(this._vertID)}setBuiltinCameraConstants(t){const e=h.director.root.pipeline;this.getParentLayout(),oit(this,t,e.pipelineSceneData,t.scene)}setBuiltinDirectionalLightFrustumConstants(t,e,i){void 0===i&&(i=0),pit(this,t,e,i)}setBuiltinSpotLightFrustumConstants(t){pit(this,null,t,0)}setBuiltinDirectionalLightConstants(t,e){git(this,null,this.getParentLayout())}setBuiltinSphereLightConstants(t,e){const i=h.director.root.pipeline.pipelineSceneData;tit.set(t.position.x,t.position.y,t.position.z,1),this.setVec4("cc_lightPos",tit),tit.set(t.size,t.range,0,0),this.setVec4("cc_lightSizeRangeAngle",tit);const s=i.isHDR;if(tit.set(t.color.x,t.color.y,t.color.z,0),t.useColorTemperature){const e=t.finalColor;tit.x=e.x,tit.y=e.y,tit.z=e.z}tit.w=s?t.luminance*e.exposure*1e4:t.luminance,this.setVec4("cc_lightColor",tit)}setBuiltinSpotLightConstants(t,e){const i=h.director.root.pipeline.pipelineSceneData,s=i.shadows;tit.set(t.position.x,t.position.y,t.position.z,2),this.setVec4("cc_lightPos",tit),tit.set(t.size,t.range,t.spotAngle,s.enabled&&t.shadowEnabled&&s.type===Yw.ShadowMap?1:0),this.setVec4("cc_lightSizeRangeAngle",tit),tit.set(t.direction.x,t.direction.y,t.direction.z,0),this.setVec4("cc_lightDir",tit);const r=i.isHDR;if(tit.set(t.color.x,t.color.y,t.color.z,0),t.useColorTemperature){const e=t.finalColor;tit.x=e.x,tit.y=e.y,tit.z=e.z}tit.w=r?t.luminance*e.exposure*1e4:t.luminance,this.setVec4("cc_lightColor",tit),tit.set(0,0,0,t.angleAttenuationStrength),this.setVec4("cc_lightBoundingSizeVS",tit)}setBuiltinPointLightConstants(t,e){const i=h.director.root.pipeline.pipelineSceneData;tit.set(t.position.x,t.position.y,t.position.z,3),this.setVec4("cc_lightPos",tit),tit.set(0,t.range,0,0),this.setVec4("cc_lightSizeRangeAngle",tit);const s=i.isHDR;if(t.useColorTemperature){const e=t.finalColor;tit.x=e.x,tit.y=e.y,tit.z=e.z}tit.w=s?t.luminance*e.exposure*1e4:t.luminance,tit.set(t.color.x,t.color.y,t.color.z,0),this.setVec4("cc_lightColor",tit)}setBuiltinRangedDirectionalLightConstants(t,e){const i=h.director.root.pipeline.pipelineSceneData;tit.set(t.position.x,t.position.y,t.position.z,4),this.setVec4("cc_lightPos",tit),tit.set(t.right.x,t.right.y,t.right.z,0),this.setVec4("cc_lightSizeRangeAngle",tit),tit.set(t.direction.x,t.direction.y,t.direction.z,0),this.setVec4("cc_lightDir",tit);const s=t.scale;tit.set(.5*s.x,.5*s.y,.5*s.z,0),this.setVec4("cc_lightBoundingSizeVS",tit);const r=i.isHDR;if(tit.set(t.color.x,t.color.y,t.color.z,0),t.useColorTemperature){const e=t.finalColor;tit.x=e.x,tit.y=e.y,tit.z=e.z}tit.w=r?t.illuminance*e.exposure:t.illuminance,this.setVec4("cc_lightColor",tit)}hasSampler(t){const e=this._lg.constantIndex.get(t);return void 0!==e&&this._data.samplers.has(e)}hasTexture(t){const e=this._lg.constantIndex.get(t);return void 0!==e&&this._data.textures.has(e)}setCustomBehavior(t){throw new Error("Method not implemented.")}}class mit{constructor(){this.instances=new Array}empty(){return 0===this.instances.length}clear(){this.instances.length=0}add(t,e,i,s){const r=t.subModels[i],n=r.passes[s].priority,o=r.priority,a=r.shaders[s].typedID,h=n<<16|o<<8|s,l=t.priority,c=hit.add();c.update(r,l,h,e,a,s),this.instances.push(c)}sortOpaqueOrCutout(){this.instances.sort(((t,e)=>t.hash!==e.hash?t.hash-e.hash:t.depth!==e.depth?t.depth-e.depth:t.shaderID-e.shaderID))}sortTransparent(){this.instances.sort(((t,e)=>t.priority!==e.priority?t.priority-e.priority:t.hash!==e.hash?t.hash-e.hash:t.depth!==e.depth?e.depth-t.depth:t.shaderID-e.shaderID))}recordCommandBuffer(t,e,i,s,r,n){void 0===s&&(s=null),void 0===r&&(r=0),void 0===n&&(n=null);for(const o of this.instances){const a=o.subModel,h=o.passIndex,l=a.inputAssembler,c=a.passes[h],u=a.shaders[h],d=Sw.getOrCreatePipelineState(t,c,u,e,l);i.bindPipelineState(d),i.bindDescriptorSet(1,c.descriptorSet),s&&i.bindDescriptorSet(0,s,[r]),n?i.bindDescriptorSet(2,a.descriptorSet,n):i.bindDescriptorSet(2,a.descriptorSet),i.bindInputAssembler(l),i.draw(l)}}}class yit{constructor(){this.passInstances=new Map,this.instanceBuffers=new Array}empty(){return 0===this.passInstances.size}add(t,e,i){if(void 0===this.passInstances.get(t)){const e=this.passInstances.size;e>=this.instanceBuffers.length&&this.instanceBuffers.push(new gw(t)),this.passInstances.set(t,e);const i=this.instanceBuffers[e];i.pass=t,i.instances}this.instanceBuffers[this.passInstances.get(t)].merge(e,i)}clear(){this.passInstances.clear(),this.instanceBuffers.forEach((t=>{t.clear()}))}sort(){}uploadBuffers(t){for(const[e,i]of this.passInstances.entries()){const e=this.instanceBuffers[i];e.hasPendingModels&&e.uploadBuffers(t)}}recordCommandBuffer(t,e,i,s,r){void 0===i&&(i=null),void 0===s&&(s=0),void 0===r&&(r=null);const n=this.instanceBuffers;for(const o of n){if(!o.hasPendingModels)continue;const n=o.instances,a=o.pass;e.bindDescriptorSet(1,a.descriptorSet);let h=null;for(const l of n){if(!l.count)continue;const n=Sw.getOrCreatePipelineState(e_.gfxDevice,a,l.shader,t,l.ia);h!==n&&(e.bindPipelineState(n),h=n),i&&e.bindDescriptorSet(0,i,[s]),r?e.bindDescriptorSet(2,l.descriptorSet,r):e.bindDescriptorSet(2,l.descriptorSet,o.dynamicOffsets),e.bindInputAssembler(l.ia),e.draw(l.ia)}}}}class vit{constructor(t,e,i){void 0===t&&(t=4294967295),void 0===e&&(e=4294967295),void 0===i&&(i=4294967295),this.frustumCulledResultID=void 0,this.lightBoundsCulledResultID=void 0,this.renderQueueTarget=void 0,this.frustumCulledResultID=t,this.lightBoundsCulledResultID=e,this.renderQueueTarget=i}update(t,e,i){void 0===t&&(t=4294967295),void 0===e&&(e=4294967295),void 0===i&&(i=4294967295),this.frustumCulledResultID=t,this.lightBoundsCulledResultID=e,this.renderQueueTarget=i}}function bit(t,e,i,s,r,n){let o;if(r&&n&&(o=Sw.getOrCreatePipelineState(e_.gfxDevice,i,r,e,n)),o){const e=n;t.bindPipelineState(o),t.bindDescriptorSet(1,i.descriptorSet),t.bindDescriptorSet(2,s),t.bindInputAssembler(e),t.draw(e)}}class wit{constructor(){this.probeQueue=new dit,this.opaqueQueue=new mit,this.transparentQueue=new mit,this.opaqueInstancingQueue=new yit,this.transparentInstancingQueue=new yit,this.camera=null,this.sceneFlags=0,this.lightByteOffset=4294967295}sort(){this.opaqueQueue.sortOpaqueOrCutout(),this.transparentQueue.sortTransparent(),this.opaqueInstancingQueue.sort(),this.transparentInstancingQueue.sort()}update(){this.probeQueue.clear(),this.opaqueQueue.clear(),this.transparentQueue.clear(),this.opaqueInstancingQueue.clear(),this.transparentInstancingQueue.clear(),this.camera=null,this.sceneFlags=0,this.lightByteOffset=4294967295}empty(){return this.opaqueQueue.empty()&&this.transparentQueue.empty()&&this.opaqueInstancingQueue.empty()&&this.transparentInstancingQueue.empty()}recordCommands(t,e,i){const s=4294967295===this.lightByteOffset?null:[this.lightByteOffset];3&i&&(this.opaqueQueue.recordCommandBuffer(e_.gfxDevice,e,t,null,0,s),this.opaqueInstancingQueue.recordCommandBuffer(e,t,null,0,s)),4&i&&(this.transparentInstancingQueue.recordCommandBuffer(e,t,null,0,s),this.transparentQueue.recordCommandBuffer(e_.gfxDevice,e,t,null,0,s))}}const Sit=4294967295;function xit(t){switch(t){case 0:return 1;case 1:return 2;case 2:return 16;case 3:return 32;case 4:return 64;case 5:return 4;case 6:return 8;case 7:return 128;case 8:return 256;default:return B("DescriptorType not found"),256}}function Tit(t){switch(t){case 1:return 0;case 2:return 1;case 16:return 2;case 32:return 3;case 64:return 4;case 4:return 5;case 8:return 6;case 128:return 7;case 256:return 8;default:return B("DescriptorTypeOrder not found"),8}}function Cit(t,e){return t.locateChild(t.N,e||"default")}function Iit(t,e,i){return t.locateChild(e,i)}function Eit(t,e,i){return void 0===i?t.locateChild(e,"default"):"number"==typeof i?t.locateChild(e,i.toString()):t.locateChild(e,i)}const Dit=new Map([["cc_lightPos",1],["cc_lightColor",1],["cc_lightSizeRangeAngle",1],["cc_lightDir",1],["cc_lightBoundingSizeVS",1]]);function Ait(t){let e=0;for(const i of t){if(i.count){e+=Cp(i.type)*i.count;continue}const t=Dit.get(i.name);if(void 0===t)if("cc_joints"!==i.name)B(`Invalid uniform count: ${i.name}`);else{const t=Cp(i.type)*Hm.LAYOUT.members[0].count;R(t!==Hm.SIZE),e+=t}else e+=Cp(i.type)*t}return R(!!e),e}function Mit(t,e){const i=JSON.parse(t[0]),s=JSON.parse(e[0]);return 1e4*i.updateFrequency+1e3*i.parameterType+100*i.descriptorType+i.visibility-(1e4*s.updateFrequency+1e3*s.parameterType+100*s.descriptorType+s.visibility)}function Pit(t,e){const i=t.attributeIndex.get(e);if(void 0===i){const i=t.valueNames.length;return t.attributeIndex.set(e,i),t.valueNames.push(e),i}return i}function Bit(t,e){for(let i=0;i<t.descriptorBlocks.length;++i){const s=t.descriptorBlocks[i];let r=s.offset;for(let t=0;t<s.descriptors.length;++t){const i=s.descriptors[t],n=new sp;n.binding=r,n.descriptorType=xit(s.type),n.count=i.count,n.stageFlags=s.visibility,n.immutableSamplers=[],e.bindings.push(n),r+=i.count}}}function Rit(t,e){const i=new rp;return Bit(e,i),t?t.createDescriptorSetLayout(i):null}function Oit(t,e){for(let i=0;i<e._layouts.length;++i)e.getLayout(i).descriptorSets.forEach((e=>{const i=e,s=i.descriptorSetLayoutData;if(t){const e=Rit(t,s);e&&(i.descriptorSetLayout=e,i.descriptorSet=t.createDescriptorSet(new np(e)))}else Bit(s,i.descriptorSetLayoutInfo)}))}function Lit(t,e){const i=JSON.stringify(e),s=t.get(i);if(s)return s;const r=new Xtt(e.descriptorType,e.visibility,0);return t.set(i,r),r}function Fit(t,e,i,s){const r=new Map,n=new Map;for(let o=0;o<s.blocks.length;o++){const a=s.blocks[o],h=Lit(r,{updateFrequency:e,parameterType:4,descriptorType:0,visibility:a.stageFlags}),l=Pit(t,a.name);h.descriptors.push(new qtt(l,0,1)),n.set(l,new Fd(i,4294967295,a.name,a.members,1))}for(let i=0;i<s.samplerTextures.length;i++){const n=s.samplerTextures[i],o=Lit(r,{updateFrequency:e,parameterType:4,descriptorType:2,visibility:n.stageFlags}),a=Pit(t,n.name);o.descriptors.push(new qtt(a,n.type,n.count))}for(let i=0;i<s.samplers.length;i++){const n=s.samplers[i],o=Lit(r,{updateFrequency:e,parameterType:4,descriptorType:3,visibility:n.stageFlags}),a=Pit(t,n.name);o.descriptors.push(new qtt(a,32,n.count))}for(let i=0;i<s.textures.length;i++){const n=s.textures[i],o=Lit(r,{updateFrequency:e,parameterType:4,descriptorType:4,visibility:n.stageFlags}),a=Pit(t,n.name);o.descriptors.push(new qtt(a,n.type,n.count))}for(let i=0;i<s.buffers.length;i++){const n=s.buffers[i],o=Lit(r,{updateFrequency:e,parameterType:4,descriptorType:5,visibility:n.stageFlags}),a=Pit(t,n.name);o.descriptors.push(new qtt(a,0,1))}for(let i=0;i<s.images.length;i++){const n=s.images[i],o=Lit(r,{updateFrequency:e,parameterType:4,descriptorType:7,visibility:n.stageFlags}),a=Pit(t,n.name);o.descriptors.push(new qtt(a,n.type,n.count))}for(let i=0;i<s.subpassInputs.length;i++){const n=s.subpassInputs[i],o=Lit(r,{updateFrequency:e,parameterType:4,descriptorType:8,visibility:n.stageFlags}),a=Pit(t,n.name);o.descriptors.push(new qtt(a,0,n.count))}const o=Array.from(r).sort(Mit),a=new Ytt(i,0);let h=0;for(const[t,e]of o){const i=JSON.parse(t);e.offset=h;for(const t of e.descriptors){if(0===i.descriptorType){const i=n.get(t.descriptorID);if(!i){B(`Uniform block not found for ${t.descriptorID}`);continue}R(4294967295===i.binding),i.binding=e.capacity,a.uniformBlocks.set(t.descriptorID,i)}void 0!==a.bindingMap.get(t.descriptorID)&&B(`Duplicated descriptor ${t.descriptorID}`),a.bindingMap.set(t.descriptorID,e.offset+e.capacity),e.capacity+=t.count}h+=e.capacity,a.capacity+=e.capacity,0===i.descriptorType||1===i.descriptorType?a.uniformBlockCapacity+=e.capacity:2===i.descriptorType&&(a.samplerTextureCapacity+=e.capacity),a.descriptorBlocks.push(e)}return a}function zit(t,e){for(let i=0;i<t.descriptorBlocks.length;++i){const s=t.descriptorBlocks[i];let r=s.offset;for(let t=0;t<s.descriptors.length;++t){const i=s.descriptors[t],n=new sp;n.binding=r,n.descriptorType=xit(s.type),n.count=i.count,n.stageFlags=s.visibility,n.immutableSamplers=[],e.bindings.push(n),r+=i.count}}}let kit,Nit;function Uit(t,e,i){const s=t.descriptorSets.get(e);s&&s.descriptorSetLayout?i.setLayouts.push(s.descriptorSetLayout):i.setLayouts.push(kit)}function Vit(t,e){kit=t.createDescriptorSetLayout(new rp),Nit=t.createPipelineLayout(new op);for(const i of e.v()){const s=e.getLayout(i);for(const[e,i]of s.descriptorSets)null!==i.descriptorSetLayout&&P("descriptor set layout already initialized. It will be overwritten"),zit(i.descriptorSetLayoutData,i.descriptorSetLayoutInfo),i.descriptorSetLayout=t.createDescriptorSetLayout(i.descriptorSetLayoutInfo)}for(const i of e.v()){if(!e.h(1,i))continue;const s=e.getParent(i),r=i,n=e.getLayout(s),o=e.getLayout(r),a=new op;Uit(n,3,a),Uit(o,2,a),Uit(o,1,a),Uit(o,0,a),e.j(r).pipelineLayout=t.createPipelineLayout(a)}}function Hit(t){for(const e of t.v()){const i=t.getLayout(e);for(const[t,e]of i.descriptorSets)null!==e.descriptorSetLayout&&e.descriptorSetLayout.destroy()}Nit.destroy(),kit.destroy()}function Git(){return kit}function Wit(){return Nit}function jit(t,e,i,s){if(s<3){const e=t.getLayout(i).descriptorSets.get(s);return e?e.descriptorSetLayout?e.descriptorSetLayout:(B("descriptor set layout not initialized"),kit):kit}R(3===s),R(e===t.getParent(i));const r=t.getLayout(e).descriptorSets.get(s);return r?r.descriptorSetLayout?r.descriptorSetLayout:(B("descriptor set layout not initialized"),kit):kit}function $it(t,e,i,s){if(s<3){const e=t.getLayout(i).descriptorSets.get(s);return e?e.descriptorSetLayout?e.descriptorSetLayout:(B("descriptor set layout not initialized"),null):null}R(3===s),R(e===t.getParent(i));const r=t.getLayout(e).descriptorSets.get(s);return r?r.descriptorSetLayout?r.descriptorSetLayout:(B("descriptor set layout not initialized"),null):null}function qit(t,e,i){R(e!==t.N);const s=t.j(e).shaderIndex.get(i);return void 0===s?Sit:s}function Xit(t,e){const i=t.attributeIndex.get(e);return void 0===i?Sit:i}function Yit(t,e){return e>=t.valueNames.length?"":t.valueNames[e]}class Qit{constructor(){this.frustumCullingKeyRecycle=new nn((()=>new rst),8),this.frustumCullingsRecycle=new nn((()=>new cst),8),this.lightBoundsCullingRecycle=new nn((()=>new ost),8),this.lightBoundsCullingResultRecycle=new nn((()=>new ast),8),this.lightBoundsCullingKeyRecycle=new nn((()=>new nst),8),this.renderQueueRecycle=new nn((()=>new wit),8),this.renderQueueQueryRecycle=new nn((()=>new vit),8)}}const Kit=Kf.makeMaskExclude([Kf.BitMask.UI_2D,Kf.BitMask.UI_3D,Kf.BitMask.GIZMOS,Kf.BitMask.EDITOR,Kf.BitMask.SCENE_GIZMO,Kf.BitMask.PROFILER]),Zit=new WeakMap;let Jit,tst="",est=0;function ist(t){return Zit.has(t)||Zit.set(t,++est),Zit.get(t)}function sst(t,e,i){void 0===i&&(i=-1),tst="";const s=t.camera,r=t.light.light,n=t.light.level,o=t.light.probe,a=t.shadingLight;return tst+=Xet(s?ist(s):0),tst+=Xet(o?ist(o):0),tst+=Xet(-1===i&&r?ist(r):0),tst+=Xet(-1!==i&&a?ist(a):0),tst+=Xet(-1===i?n:0),tst+=Xet(e?1:0),tst+=Xet(i),tst}class rst{constructor(t,e){void 0===t&&(t=null),void 0===e&&(e=!1),this.sceneData=null,this.castShadows=!1,this.sceneData=t,this.castShadows=e}update(t,e){this.sceneData=t,this.castShadows=e}}class nst{constructor(t,e){void 0===t&&(t=null),void 0===e&&(e=-1),this.sceneData=null,this.frustumCullingID=-1,this.sceneData=t,this.frustumCullingID=e}update(t,e){void 0===t&&(t=null),void 0===e&&(e=-1),this.sceneData=t,this.frustumCullingID=e}}class ost{constructor(){this.resultKeyIndex=new Map,this.resultIndex=new Map}update(){this.resultIndex.clear(),this.resultKeyIndex.clear()}}class ast{constructor(){this.instances=new Array,this.lightByteOffset=4294967295}update(){return this.instances.length=0,this.lightByteOffset=4294967295,this}}function hst(t,e,i){return`${t}-${e}-${i}`}function lst(t){const e=t.split("-");return[parseInt(e[0]),parseInt(e[1]),parseInt(e[2])]}class cst{constructor(){this.resultIndex=new Map,this.resultKeyIndex=new Map}update(){this.resultIndex.clear(),this.resultKeyIndex.clear()}}function ust(t,e){return t&&(e&t.layer)===t.layer}function dst(t,e){return!!(e&t.visFlags)}function pst(t,e){return ust(t.node,e)||dst(t,e)}function _st(t){return Qet((t.node.layer&Kit)===t.node.layer||Kit&t.visFlags)}const gst=new Qn;function fst(t,e,i){const s=t.worldBounds,r=Jit.shadows;return i&&r.type===Yw.Planar?(Qn.transform(gst,s,r.matLight),!ko.aabbFrustum(gst,e)):!ko.aabbFrustum(s,e)}function mst(t,e,i,s,r,n){const o=Jit.skybox,a=o.model,h=e.visibility,l=8&e.clearFlag;!s&&o&&o.enabled&&a&&l&&n.push(a);for(const o of t.models){if(!o.enabled||!o.node||s&&!o.castShadow)continue;if(t.isCulledByLod(e,o))continue;const a=o.worldBounds;if(r)if(0===r.probeType){if(!pst(o,h))continue;if(a&&(c=a,u=r.boundingBox,!ko.aabbWithAABB(c,u)))continue;n.push(o)}else _st(o)&&n.push(o);else{if(!pst(o,h))continue;if(a&&fst(o,i,s))continue;n.push(o)}}var c,u}const yst=new Ki;function vst(t,e){let i=0;return e.node&&(Ki.subtract(yst,e.worldBounds?e.worldBounds.center:e.node.worldPosition,t.position),i=Ki.dot(yst,t.forward)),i}function bst(t,e,i,s,r,n,o){const a=o.probeQueue;s&&a.addToProbeQueue(n,t);const h=n.subModels,l=h.length,c=Jit.skybox.model,u=vst(r,n);for(let s=0;s<l;++s){const r=h[s],l=r.passes,d=l.length;a.probeMap.includes(r)&&(t=a.defaultId);for(let a=0;a<d;++a){if(n===c&&!s&&!a&&e){o.opaqueQueue.add(n,u,s,a);continue}const h=l[a];if(t!==h.phaseID)continue;const d=h.blendState.targets[0].blend;!i&&d||!e&&!d||(1===h.batchingScheme?d?o.transparentInstancingQueue.add(h,r,a):o.opaqueInstancingQueue.add(h,r,a):d?o.transparentQueue.add(n,u,s,a):o.opaqueQueue.add(n,u,s,a))}}}const wst=new Qn(0,0,0,.5,.5,.5),Sst=new Qn;class xst{constructor(){this.frustumCullings=new Map,this.frustumCullingResults=new Array,this.lightBoundsCullings=new Map,this.lightBoundsCullingResults=new Array,this.renderQueueIndex=new Map,this.renderQueues=new Array,this.renderQueueQueryIndex=new Map,this.cullingPools=new Qit,this.numFrustumCulling=0,this.numLightBoundsCulling=0,this.numRenderQueues=0,this.layoutGraph=void 0,this.renderGraph=void 0,this.enableLightCulling=!0,this.kFilterMask=8200,this.kDrawMask=7,this.kAllMask=this.kFilterMask|this.kDrawMask}resetPool(){const t=this.cullingPools;t.frustumCullingKeyRecycle.reset(),t.frustumCullingsRecycle.reset(),t.lightBoundsCullingRecycle.reset(),t.lightBoundsCullingResultRecycle.reset(),t.lightBoundsCullingKeyRecycle.reset(),t.renderQueueRecycle.reset(),t.renderQueueQueryRecycle.reset(),hit.reset()}clear(){this.resetPool(),this.frustumCullings.clear(),this.frustumCullingResults.length=0,this.lightBoundsCullings.clear(),this.lightBoundsCullingResults.length=0,this.renderQueueIndex.clear(),this.renderQueues.length=0,this.renderQueueQueryIndex.clear(),this.numLightBoundsCulling=0,this.numFrustumCulling=0,this.numRenderQueues=0}buildRenderQueues(t,e,i){this.layoutGraph=e,this.renderGraph=t,Jit=i,this.collectCullingQueries(t),this.batchFrustumCulling(i),this.batchLightBoundsCulling(),this.fillRenderQueues()}getOrCreateLightBoundsCulling(t,e){var i;if(!(4&t.cullingFlags))return 4294967295;if(0===(null===(i=t.shadingLight)||void 0===i?void 0:i.type))return 4294967295;if(!this.enableLightCulling)return 4294967295;const s=t.scene;let r=this.lightBoundsCullings.get(s);if(!r){const t=this.cullingPools.lightBoundsCullingRecycle.add();t.update(),this.lightBoundsCullings.set(s,t),r=this.lightBoundsCullings.get(s)}const n=sst(t,!1,e),o=r.resultIndex.get(n);if(void 0!==o)return o;const a=this.numLightBoundsCulling++;this.numLightBoundsCulling>this.lightBoundsCullingResults.length&&this.lightBoundsCullingResults.push(this.cullingPools.lightBoundsCullingResultRecycle.add().update()),r.resultIndex.set(n,a);const h=this.cullingPools.lightBoundsCullingKeyRecycle.add();return h.update(t,e),r.resultKeyIndex.set(n,h),a}getOrCreateFrustumCulling(t){const e=this.renderGraph.j(t),i=e.scene;let s=this.frustumCullings.get(i);if(!s){const t=this.cullingPools.frustumCullingsRecycle.add();t.update(),this.frustumCullings.set(i,t),s=this.frustumCullings.get(i)}const r=Qet(8&e.flags),n=sst(e,r),o=s.resultIndex.get(n);if(void 0!==o)return o;const a=this.numFrustumCulling++;this.numFrustumCulling>this.frustumCullingResults.length&&this.frustumCullingResults.push([]),s.resultIndex.set(n,a);const h=this.cullingPools.frustumCullingKeyRecycle.add();return h.update(e,r),s.resultKeyIndex.set(n,h),a}getOrCreateRenderQueue(t,e,i){const s=this.renderQueueIndex.get(t);if(void 0!==s)return this.renderQueues[s].sceneFlags|=e&this.kDrawMask,s;const r=this.numRenderQueues++;if(this.numRenderQueues>this.renderQueues.length){const t=this.cullingPools.renderQueueRecycle.add();t.update(),this.renderQueues.push(t)}const n=this.renderQueues[r];return this.renderQueueIndex.set(t,r),n.camera=i,n.sceneFlags=e&this.kAllMask,r}collectCullingQueries(t){for(const e of t.v()){if(!t.h(9,e)||!t.getValid(e))continue;const i=t.j(e);if(!i.scene)continue;const s=this.getOrCreateFrustumCulling(e),r=this.getOrCreateLightBoundsCulling(i,s),n=t.getParent(e),o=hst(s,r,t.j(n).phaseID),a=this.getOrCreateRenderQueue(o,i.flags,i.camera),h=this.cullingPools.renderQueueQueryRecycle.add();h.update(s,r,a),this.renderQueueQueryIndex.set(e,h)}}uploadInstancing(t){for(let e=0;e!==this.numRenderQueues;++e){const i=this.renderQueues[e];i.opaqueInstancingQueue.uploadBuffers(t),i.transparentInstancingQueue.uploadBuffers(t)}}_getPhaseIdFromScene(t){const e=this.renderGraph,i=e.getParent(t);return e.j(i).phaseID}getBuiltinShadowFrustum(t,e,i,s){const r=t.csmLayers,n=i.csmLevel,o=t.shadows;return o.type===Yw.Planar?e.frustum:(o.enabled&&o.type===Yw.ShadowMap&&i&&i.node&&r.update(t,e),i.shadowFixedArea||n===Kw.LEVEL_1?r.specialLayer.validFrustum:r.layers[s].validFrustum)}batchFrustumCulling(t){for(const[e,i]of this.frustumCullings)for(const[s,r]of i.resultIndex){const n=i.resultKeyIndex.get(s),o=n.sceneData,a=o.light.light,h=o.light.level,l=n.castShadows,c=o.light.probe,u=c?c.camera:o.camera,d=this.frustumCullingResults[r];if(c)mst(e,u,u.frustum,l,c,d);else if(a)switch(a.type){case 2:mst(e,u,a.frustum,l,null,d);break;case 0:mst(e,u,this.getBuiltinShadowFrustum(t,u,a,h),l,null,d)}else mst(e,u,u.frustum,l,null,d)}}executeSphereLightCulling(t,e,i){const s=t.aabb;for(const t of e){const e=t.worldBounds;e&&!ko.aabbWithAABB(e,s)||i.push(t)}}executeSpotLightCulling(t,e,i){const s=t.aabb,r=t.frustum;for(const t of e){const e=t.worldBounds;(!e||ko.aabbWithAABB(s,e)&&ko.aabbFrustum(e,r))&&i.push(t)}}executePointLightCulling(t,e,i){const s=t.aabb;for(const t of e){const e=t.worldBounds;e&&!ko.aabbWithAABB(s,e)||i.push(t)}}executeRangedDirectionalLightCulling(t,e,i){wst.transform(t.node.worldMatrix,null,null,null,Sst);for(const t of e){const e=t.worldBounds;e&&!ko.aabbWithAABB(Sst,e)||i.push(t)}}batchLightBoundsCulling(){for(const[t,e]of this.lightBoundsCullings)for(const[t,i]of e.resultIndex){const s=e.resultKeyIndex.get(t),r=s.sceneData,n=s.frustumCullingID,o=this.frustumCullingResults[n],a=this.lightBoundsCullingResults[i];switch(r.shadingLight.type){case 1:{const t=r.shadingLight;this.executeSphereLightCulling(t,o,a.instances)}break;case 2:{const t=r.shadingLight;this.executeSpotLightCulling(t,o,a.instances)}break;case 3:{const t=r.shadingLight;this.executePointLightCulling(t,o,a.instances)}break;case 4:{const t=r.shadingLight;this.executeRangedDirectionalLightCulling(t,o,a.instances)}}}}_getModelsByCullingResults(t,e){return 4294967295!==t?t<this.lightBoundsCullingResults.length?this.lightBoundsCullingResults[t].instances:[]:e<this.frustumCullingResults.length?this.frustumCullingResults[e]:[]}fillRenderQueues(){for(const[t,e]of this.renderQueueIndex){const i=this.renderQueues[e],[s,r,n]=lst(t),o=Qet(4&i.sceneFlags),a=Qet(3&i.sceneFlags),h=Qet(8&i.sceneFlags),l=Qet(8192&i.sceneFlags);if(!(h||o||a||l))continue;const c=this._getModelsByCullingResults(r,s),u=i.camera;for(const t of c)bst(n,a,o,l,u,t,i);i.sort()}}}class Tst{constructor(){this.cpuBuffer=void 0,this.programLibrary=void 0,this.device=null,this.elementSize=0,this.maxNumLights=16,this.binding=4294967295,this.resized=!1,this.lightBuffer=void 0,this.firstLightBufferView=null,this.lights=[],this.lightIndex=new Map}init(t,e,i){this.device=e,this.programLibrary=t;const s=this.programLibrary.localLayoutData,r=t.layoutGraph.attributeIndex.get("CCForwardLight"),n=s.uniformBlocks.get(r);this.elementSize=Ket(Ait(n.members),this.device.capabilities.uboOffsetAlignment),this.maxNumLights=i,this.binding=t.localLayoutData.bindingMap.get(r);const o=this.elementSize*this.maxNumLights;this.lightBuffer=this.device.createBuffer(new Ed(18,3,o,this.elementSize)),this.firstLightBufferView=this.device.createBuffer(new Dd(this.lightBuffer,0,this.elementSize)),this.cpuBuffer=new Float32Array(o/4),this.resized=!0}buildLights(t,e,i){for(const[s,r]of t.lightBoundsCullings)for(const[s,n]of r.resultIndex){const o=r.resultKeyIndex.get(s).sceneData;let a=1;if(o.camera)a=o.camera.exposure;else{if(!o.light.probe||!o.light.probe.camera)throw new Error("Unexpected situation: No camera or probe found.");a=o.light.probe.camera.exposure}const h=this.addLight(o.shadingLight,e,a,i);t.lightBoundsCullingResults[n].lightByteOffset=h}for(const[e,i]of t.renderQueueQueryIndex){if(4294967295===i.lightBoundsCulledResultID)continue;const e=t.lightBoundsCullingResults[i.lightBoundsCulledResultID].lightByteOffset;t.renderQueues[i.renderQueueTarget].lightByteOffset=e}}tryUpdateRenderSceneLocalDescriptorSet(t){if(t.lightBoundsCullings.size){for(const[e,i]of t.frustumCullings)for(const t of e.models){if(!t)throw new Error("Unexpected null model.");for(const e of t.subModels){const t=e.descriptorSet,i=t.getBuffer(this.binding);(this.resized||i!==this.firstLightBufferView)&&(t.bindBuffer(this.binding,this.firstLightBufferView),t.update())}}this.resized=!1}}clear(){this.cpuBuffer.fill(0),this.lights.length=0,this.lightIndex.clear()}addLight(t,e,i,s){const r=this.lightIndex.get(t);if(void 0!==r)return r;if(this.lights.length===this.maxNumLights){this.resized=!0,this.maxNumLights*=2;const t=this.elementSize*this.maxNumLights;this.lightBuffer.resize(t),this.firstLightBufferView=this.device.createBuffer(new Dd(this.lightBuffer,0,this.elementSize));const e=this.cpuBuffer;this.cpuBuffer=new Float32Array(t/4),this.cpuBuffer.set(e)}const n=this.lights.length;this.lights[n]=t,this.lightIndex.set(t,n);const o=this.elementSize/4*n;return Zet(t,e,i,s,this.cpuBuffer,o,this.elementSize),n*this.elementSize}buildLightBuffer(t){t.updateBuffer(this.lightBuffer,this.cpuBuffer,this.lights.length*this.elementSize/4)}}let Cst;class Ist{constructor(t){this._name=void 0,this._name=t}get name(){return this._name}}class Est extends Ist{get texture(){return this._texture}set framebuffer(t){this._framebuffer=t}get framebuffer(){return this._framebuffer}get description(){return this._desc}get trait(){return this._trait}get swapchain(){return this._swapchain}constructor(t,e){super(t),this._texture=null,this._swapchain=null,this._framebuffer=null,this._desc=null,this._trait=null;const i=Cst.resourceGraph,s=i.vertex(t);this._desc=i.getDesc(s),this._trait=i.getTraits(s),e instanceof Yp?this._texture=e:e instanceof Op?this._framebuffer=e:e instanceof ptt?this._swapchain=e.swapchain:this.createTextureFromDesc(this._desc)}createTextureFromDesc(t){let e=1;switch(t.dimension){case 1:e=0;break;case 3:e=2}const i=[[16,16],[32,32],[64,64],[8,4],[4,8],[256,1],[512,2]].reduce(((e,i)=>{let[s,r]=i;return t.flags&s?e|r:e}),0);this._texture=Cst.device.createTexture(new Bd(e,i,t.format,t.width,t.height))}release(){var t,e;null===(t=this.framebuffer)||void 0===t||t.destroy(),this._framebuffer=null,null===(e=this.texture)||void 0===e||e.destroy(),this._texture=null}}function Dst(t){const e=h.director.root.pipeline.pipelineSceneData;return!!(e.shadows.enabled&&e.shadows.type===Yw.ShadowMap&&t&&8&t.flags)}class Ast extends Ist{get buffer(){return this._buffer}constructor(t,e){super(t),this._buffer=null;const i=Cst.resourceGraph,s=i.vertex(t),r=i.getDesc(s),n=new Ed(this.calculateBufferUsage(r.flags),1,r.width);this._buffer=Cst.device.createBuffer(n)}calculateBufferUsage(t){return[[2,64],[1,16],[4,32],[256,1],[512,2]].reduce(((e,i)=>{let[s,r]=i;return t&s?e|r:e}),0)}release(){var t;null===(t=this._buffer)||void 0===t||t.destroy(),this._buffer=null}}const Mst=new Float32Array(4);class Pst{get screenQuad(){return this._screenQuad}get blit(){return this._blit}set blit(t){this._blit=t}get stageDesc(){return this._stageDesc}constructor(t){this._isUpdate=!1,this._isGatherLight=!1,this._blit=void 0,this._screenQuad=null,this._stageDesc=void 0,this._lightVolumeBuffer=null,this._lightMeterScale=1e4,this._lightBufferData=void 0,this._blit=t}_createQuadInputAssembler(){return Cst.blit.pipelineIAData}createScreenQuad(){this._screenQuad||(this._screenQuad=this._createQuadInputAssembler())}_gatherVolumeLights(t){if(!t.scene)return;const e=Cst.pipeline,i=Cst.commandBuffer,s=t.scene.sphereLights,r=t.scene.spotLights,n=t.exposure,o=km.LIGHTS_PER_PASS,a=cr.length,h=a*o,l=tn.create(0,0,0,1);let c=0;const u=(i,s)=>{if(!(c>=o)&&(tn.set(l,i.position.x,i.position.y,i.position.z,i.range),ko.sphereFrustum(l,t.frustum))){if(Ki.toArray(Mst,i.position),Mst[3]=s?1:0,this._lightBufferData.set(Mst,c*a+0*h),Ki.toArray(Mst,i.color),i.useColorTemperature){const t=i.colorTemperatureRGB;Mst[0]*=t.x,Mst[1]*=t.y,Mst[2]*=t.z}Mst[3]=e.pipelineSceneData.isHDR?i.luminance*n*this._lightMeterScale:i.luminance,this._lightBufferData.set(Mst,c*a+1*h),Mst[0]=i.size,Mst[1]=i.range,Mst[2]=s?i.spotAngle:0,this._lightBufferData.set(Mst,c*a+2*h),s&&(Ki.toArray(Mst,i.direction),this._lightBufferData.set(Mst,c*a+3*h)),c++}};for(const t of s)u(t,!1);for(const t of r)u(t,!0);const d=3*h+3;this._lightBufferData.set([c],d),i.updateBuffer(this._lightVolumeBuffer,this._lightBufferData)}update(){64&this.blit.sceneFlags&&this.blit.camera&&!this._isGatherLight&&(this._gatherVolumeLights(this.blit.camera),this._isGatherLight=!0,this._isUpdate=!1),this._isUpdate||(this._stageDesc.update(),this._isUpdate=!0)}reset(){this._isUpdate=!1,this._isGatherLight=!1}createStageDescriptor(){const t=this.blit,e=t.material.passes[t.passID],i=Cst.device;if(this._stageDesc=Cst.blit.stageDescs.get(e)||i.createDescriptorSet(new np(e.localSetLayout)),Cst.blit.stageDescs.set(e,this._stageDesc),64&this.blit.sceneFlags){this._lightVolumeBuffer=Cst.blit.lightVolumeBuffer;const t=Cst.blit.deferredLitsBufView;this._lightBufferData=Cst.blit.lightBufferData,this._lightBufferData.fill(0),this._stageDesc.bindBuffer(zm.BINDING,t)}this._stageDesc.bindBuffer(Bm.BINDING,Cst.blit.emptyLocalUBO)}}class Bst{constructor(){this._devicePass=void 0,this._hint=0,this._phaseID=_w("default"),this._renderPhase=null,this._descSetData=null,this._layoutID=-1,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,this._queueId=-1}preRecord(){}postRecord(){}init(t,e,i){this.reset(),this.queueHint=e.hint,this.queueId=i,this._devicePass=t,this._phaseID=h.rendering.getPhaseID(t.passID,Cst.renderGraph.getLayout(i))}get phaseID(){return this._phaseID}set layoutID(t){this._layoutID=t;const e=Cst.layoutGraph;this._renderPhase=e.h(1,t)?e.j(t):null;const i=e.getLayout(t);this._descSetData=i.descriptorSets.get(2)}get layoutID(){return this._layoutID}get descSetData(){return this._descSetData}get renderPhase(){return this._renderPhase}set queueId(t){this._queueId=t}get queueId(){return this._queueId}set isUpdateUBO(t){this._isUpdateUBO=t}get isUpdateUBO(){return this._isUpdateUBO}set isUploadInstance(t){this._isUploadInstance=t}get isUploadInstance(){return this._isUploadInstance}set isUploadBatched(t){this._isUploadBatched=t}get isUploadBatched(){return this._isUploadBatched}reset(){this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1}set queueHint(t){this._hint=t}get queueHint(){return this._hint}get devicePass(){return this._devicePass}record(){this._descSetData&&this._descSetData.descriptorSet&&Cst.commandBuffer.bindDescriptorSet(3,this._descSetData.descriptorSet)}}class Rst{constructor(){this._renderScenes=[],this._devicePass=void 0,this._hint=0,this._graphQueue=void 0,this._phaseID=_w("default"),this._renderPhase=null,this._descSetData=null,this._viewport=null,this._scissor=null,this._layoutID=-1,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,this._blitDesc=null,this._queueId=-1}get phaseID(){return this._phaseID}set layoutID(t){this._layoutID=t;const e=Cst.layoutGraph;this._renderPhase=e.h(1,t)?e.j(t):null;const i=e.getLayout(t);this._descSetData=i.descriptorSets.get(2)}get layoutID(){return this._layoutID}get descSetData(){return this._descSetData}get renderPhase(){return this._renderPhase}get viewport(){return this._viewport}get scissor(){return this._scissor}set queueId(t){this._queueId=t}get queueId(){return this._queueId}set isUpdateUBO(t){this._isUpdateUBO=t}get isUpdateUBO(){return this._isUpdateUBO}set isUploadInstance(t){this._isUploadInstance=t}get isUploadInstance(){return this._isUploadInstance}set isUploadBatched(t){this._isUploadBatched=t}get isUploadBatched(){return this._isUploadBatched}init(t,e,i){this.reset(),this._graphQueue=e,this.queueHint=e.hint;const s=this._viewport=e.viewport;s&&(this._scissor=new _d(s.left,s.top,s.width,s.height)),this.queueId=i,this._devicePass=t,this._phaseID=h.rendering.getPhaseID(t.passID,Cst.renderGraph.getLayout(i))}createBlitDesc(t){this._blitDesc||(this._blitDesc=new Pst(t)),this._blitDesc.createScreenQuad(),this._blitDesc.createStageDescriptor()}setScene(t,e,i){const s=Cst.pools.addDeviceScene();return s.init(this,t,e,i),this._renderScenes.push(s),s}reset(){var t;this._renderScenes.length=0,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,null===(t=this._blitDesc)||void 0===t||t.reset()}get graphQueue(){return this._graphQueue}get blitDesc(){return this._blitDesc}get renderScenes(){return this._renderScenes}set queueHint(t){this._hint=t}get queueHint(){return this._hint}get devicePass(){return this._devicePass}preRecord(){}record(){this._descSetData&&this._descSetData.descriptorSet&&Cst.commandBuffer.bindDescriptorSet(3,this._descSetData.descriptorSet),this._renderScenes.forEach((t=>{t.record()}))}postRecord(){}}class Ost{constructor(t,e,i){this._layoutID=0,this._vertID=-1,this._resID=-1,this._stage=null,this._layout=void 0,this._inputName=void 0,this._descriptorSet=null,this._inputName=i[0],this._layoutID=t,this._vertID=e;const s=Cst.layoutGraph;this._stage=s.j(t),this._layout=s.getLayout(t);const r=this._layout.descriptorSets.get(3);if(!r)return;const n=r.descriptorSet,o=Cst.deviceTextures.get(this._inputName),a=null==o?void 0:o.texture,h=Cst.deviceBuffers.get(this._inputName),l=null==h?void 0:h.buffer;if(!a&&!l)throw Error(`Could not find texture with resource name ${this._inputName}`);this._resID=Cst.resourceGraph.vertex(this._inputName);const c=Cst.resourceGraph.getSampler(this._resID);for(const t of i[1]){const e=t.name,r=s.attributeIndex.get(e);void 0!==r&&this.bindDescriptor(n,r,a,l,c,i[1][0].accessType)}}bindDescriptor(t,e,i,s,r,n){const o=this._layout.descriptorSets.get(3),a=Cst.resourceGraph.getDesc(this._resID);for(const h of o.descriptorSetLayoutData.descriptorBlocks)for(let o=0;o<h.descriptors.length;++o)if(e===h.descriptors[o].descriptorID){if(i){t.bindTexture(h.offset+o,i);const s=Cst.renderGraph.getData(this._vertID).samplers.get(e)||Cst.device.getSampler(r);t.bindSampler(h.offset+o,s)}else if(4&a.flags){const e=0!==n?8388608:32768;t.bindBuffer(h.offset+o,s,0,e)}else t.bindBuffer(h.offset+o,s);this._descriptorSet||(this._descriptorSet=t);break}}get descriptorSet(){return this._descriptorSet}get layoutID(){return this._layoutID}get vertID(){return this._vertID}get stage(){return this._stage}get layout(){return this._layout}}const Lst=new wd,Fst=new _d,zst=new class{constructor(t){void 0===t&&(t=""),this.name=void 0,this.name=t,Cst&&Cst.pipeline.resourceUses.push(t)}set resName(t){this.name=t}checkTexture(t){const e=Cst.deviceTextures.get(t);if(!e)return!1;const{width:i,height:s}=Cst.resourceGraph.getDesc(Cst.resourceGraph.vertex(t)),r=(t,e)=>t===i&&e===s;return e.texture?r(e.texture.width,e.texture.height):!!e.swapchain&&r(e.swapchain.width,e.swapchain.height)}createDeviceTex(t){let e=Cst.deviceTextures.get(this.name);var i;e&&this.checkTexture(this.name)||(null!==(i=e)&&void 0!==i&&i.texture&&e.texture.destroy(),e=new Est(this.name,t),Cst.deviceTextures.set(this.name,e))}checkBuffer(t){const e=Cst.deviceBuffers.get(t),i=Cst.resourceGraph.vertex(this.name),s=Cst.resourceGraph.getDesc(i);return e.buffer.size>=s.width}createDeviceBuf(t){let e=Cst.deviceBuffers.get(this.name);var i;e&&this.checkBuffer(this.name)||(null!==(i=e)&&void 0!==i&&i.buffer&&e.buffer.destroy(),e=new Ast(this.name,t),Cst.deviceBuffers.set(this.name,e))}managed(t){this.createDeviceTex(t)}managedBuffer(t){this.createDeviceBuf(t)}managedTexture(t){}persistentBuffer(t){this.createDeviceBuf(t)}persistentTexture(t){this.createDeviceTex(t)}framebuffer(t){this.createDeviceTex(t)}swapchain(t){this.createDeviceTex(t)}formatView(t){}subresourceView(t){}};class kst{constructor(t,e){this._renderPass=void 0,this._framebuffer=void 0,this._clearColor=[],this._deviceQueues=new Map,this._clearDepth=1,this._clearStencil=0,this._passID=void 0,this._rasterID=void 0,this._rasterPass=void 0,this._layoutName=void 0,this._viewport=null,this._layout=null,this._idxOfRenderData=0,this._rasterID=t,this._rasterPass=e;const i=Cst.device;this._layoutName=Cst.renderGraph.getLayout(t),this._passID=h.rendering.getPassID(this._layoutName);const s=new Xd;s.format=55;const r=[],n=[];let o=null,a=null,l=null;this._processRenderLayout(e);for(const[t,h]of e.rasterViews){let e=Cst.deviceTextures.get(t);if(e){const i=Cst.resourceGraph,s=i.vertex(t),r=i.object(s);if(e.framebuffer&&r instanceof Op&&e.framebuffer!==r)e.framebuffer=r;else if(e.texture){const t=i.getDesc(s);e.texture.width===t.width&&e.texture.height===t.height||e.texture.resize(t.width,t.height)}}else this.visitResource(t),e=Cst.deviceTextures.get(t);if(a||(a=e.swapchain),l||(l=e.framebuffer),0===h.attachmentType){e.swapchain||e.framebuffer||n.push(e.texture);const t=new qd;t.format=e.description.format,t.sampleCount=e.description.sampleCount,t.loadOp=h.loadOp,t.storeOp=h.storeOp,t.barrier=i.getGeneralBarrier(new Jd(0===h.loadOp?2097152:0,0===h.storeOp?2097152:0));const s=new Sd;s.copy(h.clearColor),this._clearColor.push(s),r.push(t)}else 1===h.attachmentType&&(s.depthStoreOp=h.storeOp,s.stencilStoreOp=h.storeOp,s.depthLoadOp=h.loadOp,s.stencilLoadOp=h.loadOp,s.barrier=i.getGeneralBarrier(new Jd(0===h.loadOp?4194304:0,0===h.storeOp?4194304:0)),e.swapchain||e.framebuffer?e.swapchain&&(o=e.swapchain.depthStencilTexture):o=e.texture,this._clearDepth=h.clearColor.x,this._clearStencil=h.clearColor.y)}if(0===r.length){const t=new qd;r.push(t)}if(0===n.length&&!a&&!l){const t=i.createTexture(new Bd);n.push(t)}const c=new Kd;c.colorAttachments=r,(a?a.depthStencilTexture:o)&&(c.depthStencilAttachment=s),this._renderPass=i.createRenderPass(c),this._createFramebuffer(l,a?[a.colorTexture]:n,a?a.depthStencilTexture:o)}get indexOfRD(){return this._idxOfRenderData}get rasterID(){return this._rasterID}get layoutName(){return this._layoutName}get passID(){return this._passID}get renderLayout(){return this._layout}get renderPass(){return this._renderPass}get framebuffer(){return this._framebuffer}get clearColor(){return this._clearColor}get clearDepth(){return this._clearDepth}get clearStencil(){return this._clearStencil}get deviceQueues(){return this._deviceQueues}get viewport(){return this._viewport}addIdxOfRD(){this._idxOfRenderData++}visitResource(t){const e=Cst.resourceGraph,i=e.vertex(t);zst.resName=t,e.visitVertex(zst,i)}addQueue(t){this._deviceQueues.set(t.queueId,t)}preRecord(){Cst.passDescriptorSet=Let(this.layoutName).descriptorSet}_applyRenderLayout(t){const e=Cst.renderGraph.getLayout(this._rasterID);if(e){const i=Cst.layoutGraph,s=i.locateChild(i.N,e);4294967295!==s&&(this._layout=new Ost(s,this._rasterID,t))}}getGlobalDescData(){const t=Cst.layoutGraph.locateChild(Cst.layoutGraph.N,"default");return Cst.layoutGraph.getLayout(t).descriptorSets.get(3)}_applyViewport(t){this._viewport=null;const e=this._rasterPass.viewport;0===e.left&&0===e.top&&0===e.width&&0===e.height||(this._viewport=e)}_showProfiler(t){const e=Cst.pipeline.profiler;if(!e||!e.enabled)return;const i=Cst.profilerDescriptorSet,s=this._renderPass,r=Cst.commandBuffer,n=e.subModels[0],o=n.passes[0],a=n.inputAssembler;Lst.width=t.width,Lst.height=t.height,r.setViewport(Lst),r.setScissor(t),r.bindDescriptorSet(0,i),bit(r,s,o,n.descriptorSet,n.shaders[0],a)}beginPass(){const t=this.framebuffer.colorTextures[0];this._applyViewport(t);const e=Cst.commandBuffer;this._viewport?(Fst.x=this._viewport.left,Fst.y=this._viewport.top,Fst.width=this._viewport.width,Fst.height=this._viewport.height):(Fst.y=Fst.x=0,Fst.width=t.width,Fst.height=t.height),e.beginRenderPass(this.renderPass,this.framebuffer,Fst,this.clearColor,this.clearDepth,this.clearStencil),Cst.passDescriptorSet&&e.bindDescriptorSet(0,Cst.passDescriptorSet)}endPass(){Cst.commandBuffer.endRenderPass()}record(){this.beginPass();for(const t of this._deviceQueues.values())t.record();this._rasterPass.showStatistics&&this._showProfiler(Fst),this.endPass()}postRecord(){}_processRenderLayout(t){for(const e of t.computeViews)this._applyRenderLayout(e);this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()}_createFramebuffer(t,e,i){(t||e.length)&&(this._framebuffer&&t!==this._framebuffer&&this._framebuffer.destroy(),this._framebuffer=t||Cst.device.createFramebuffer(new ip(this._renderPass,e,i)))}resetResource(t,e){var i,s,r,n;this._rasterID=t,this._rasterPass=e,this._layoutName=Cst.renderGraph.getLayout(t),this._passID=h.rendering.getPassID(this._layoutName),this._deviceQueues.clear(),this._idxOfRenderData=0;let o=null;const a=[],l=this._framebuffer,c=null!==(i=null==l?void 0:l.depthStencilTexture)&&void 0!==i?i:null;let u=l?c:null;this._processRenderLayout(e);const d=null!==(s=null==l?void 0:l.width)&&void 0!==s?s:0,p=null!==(r=null==l?void 0:l.height)&&void 0!==r?r:0;let[_,g]=[0,0];for(const[t,i]of e.rasterViews)if(2!==i.attachmentType){const e=Cst.resourceGraph.getDesc(Cst.resourceGraph.vertex(t));_=e.width,g=e.height;break}const f=(null==l?void 0:l.colorTextures.some((t=>!t||0===t.getTextureHandle())))||c&&0===c.getTextureHandle(),m=_!==d||g!==p||null!==(n=null==l?void 0:l.needRebuild)&&void 0!==n&&n||f;for(const[t,i]of e.rasterViews){let e=Cst.deviceTextures.get(t);e||(this.visitResource(t),e=Cst.deviceTextures.get(t));const s=Cst.resourceGraph,r=s.vertex(t),n=s.object(r),h=s.getDesc(r);if(e.framebuffer&&n instanceof Op&&(e.framebuffer!==n||n!==this._framebuffer))o=this._framebuffer=e.framebuffer=n;else if(e.texture&&m){const t=e.texture;t.resize(h.width,h.height),0===i.attachmentType?a.push(t):1===i.attachmentType&&(u=t)}}this._createFramebuffer(o,a,u)}}class Nst{constructor(){this._id=void 0,this._pass=void 0}get id(){return this._id}get pass(){return this._pass}applyInfo(t,e){this._id=t,this._pass=e}}class Ust{constructor(t){this._deviceQueues=[],this._passID=void 0,this._layoutName=void 0,this._viewport=null,this._computeInfo=void 0,this._layout=null,this._computeInfo=t,this._layoutName=Cst.renderGraph.getLayout(t.id),this._passID=h.rendering.getPassID(this._layoutName);for(const e of t.pass.computeViews){let t=Cst.deviceTextures.get(e[0]);t||(this.visitResource(e[0]),t=Cst.deviceTextures.get(e[0])),this._applyRenderLayout(e)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()}preRecord(){Cst.passDescriptorSet=Let(this.layoutName).descriptorSet}postRecord(){}get layoutName(){return this._layoutName}get passID(){return this._passID}get renderLayout(){return this._layout}get deviceQueues(){return this._deviceQueues}get computePassInfo(){return this._computeInfo}visitResource(t){const e=Cst.resourceGraph,i=e.vertex(t);zst.resName=t,e.visitVertex(zst,i)}addQueue(t){this._deviceQueues.push(t)}_applyRenderLayout(t){const e=Cst.renderGraph.getLayout(this._computeInfo.id);if(e){const i=Cst.layoutGraph,s=i.locateChild(i.N,e);4294967295!==s&&(this._layout=new Ost(s,this._computeInfo.id,t))}}getGlobalDescData(){const t=Cst.layoutGraph.locateChild(Cst.layoutGraph.N,"default");return Cst.layoutGraph.getLayout(t).descriptorSets.get(3)}record(){const t=Cst.commandBuffer;Cst.passDescriptorSet&&t.bindDescriptorSet(0,Cst.passDescriptorSet);for(const t of this._deviceQueues)t.record();Fet(Cst.renderGraph.getData(this._computeInfo.id),-1,0,Cst.renderGraph.getLayout(this._computeInfo.id))}resetResource(t,e){this._computeInfo.applyInfo(t,e),this._layoutName=Cst.renderGraph.getLayout(t),this._passID=h.rendering.getPassID(this._layoutName),this._deviceQueues.length=0;for(const t of this._computeInfo.pass.computeViews)this._applyRenderLayout(t);this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()}}const Vst=new wd;class Hst{constructor(){this._currentQueue=void 0,this._renderPass=void 0,this._scene=null,this._camera=null,this._sceneData=void 0,this._blit=void 0,this._sceneID=-1}get blit(){return this._blit}get sceneData(){return this._sceneData}get sceneID(){return this._sceneID}get camera(){return this._camera}preRecord(){this._blit&&(this._currentQueue.createBlitDesc(this._blit),this._currentQueue.blitDesc.update()),Cst.lightResource.buildLightBuffer(Cst.commandBuffer),Cst.lightResource.tryUpdateRenderSceneLocalDescriptorSet(Cst.culling)}postRecord(){}init(t,e,i,s){this._currentQueue=t,this._sceneData=i,this._blit=s,this._sceneID=e,this._renderPass=t.devicePass.renderPass;const r=i&&i.camera?i.camera:null;r&&(this._scene=r.scene,this._camera=r)}_recordUI(){const t=this.camera.scene.batches;for(let e=0;e<t.length;e++){const i=t[e];let s=!1;if(this.camera.visibility&i.visFlags&&(s=!0),!s)continue;const r=i.shaders.length;for(let t=0;t<r;t++){const e=i.passes[t];if(e.phaseID!==this._currentQueue.phaseID)continue;const s=i.shaders[t],r=i.inputAssembler,n=i.descriptorSet;bit(Cst.commandBuffer,this._renderPass,e,n,s,r)}}}_recordBlit(){if(!this.blit)return;const t=this.blit,e=t.material.passes[t.passID];e.update();const i=e.getShaderVariant(),s=this._currentQueue.blitDesc,r=s.screenQuad.quadIA;bit(Cst.commandBuffer,this._renderPass,e,s.stageDesc,i,r)}_updateGlobal(t,e){const i=this._currentQueue.devicePass;i.addIdxOfRD(),Fet(t,e,i.indexOfRD,Cst.renderGraph.getLayout(i.rasterID))}_updateRenderData(){var t;if(this._currentQueue.isUpdateUBO)return;const e=this._currentQueue.devicePass.rasterID,i=Cst.renderGraph.getData(e),s=this.sceneID;this._updateGlobal(i,s);const r=this._currentQueue.queueId,n=Cst.renderGraph.getData(r);this._updateGlobal(n,s);const o=Cst.renderGraph.getData(s);o&&this._updateGlobal(o,s),null===(t=Cst.passDescriptorSet)||void 0===t||t.update(),this._currentQueue.isUpdateUBO=!0}_applyViewport(){const t=this._currentQueue.viewport;if(t)Cst.commandBuffer.setViewport(t),Cst.commandBuffer.setScissor(this._currentQueue.scissor);else if(!this._currentQueue.devicePass.viewport){const t=this._currentQueue.devicePass.framebuffer.colorTextures[0],e=this.sceneData?this.sceneData.light:null,i=Dst(this.sceneData)&&this.sceneData&&e.light?Cet(this.camera,t.width,t.height,e.light,e.level):Cet(this.camera,t.width,t.height);Vst.left=i.x,Vst.top=i.y,Vst.width=i.width,Vst.height=i.height,Cst.commandBuffer.setViewport(Vst),Cst.commandBuffer.setScissor(i)}}record(){const t=this._currentQueue.devicePass,e=Cst.culling;if(this._updateRenderData(),this._applyViewport(),this.blit)return void this._recordBlit();const i=e.renderQueueQueryIndex.get(this.sceneID),s=e.renderQueues[i.renderQueueTarget],r=this.sceneData,n=Qet(8192&r.flags);var o;n&&s.probeQueue.applyMacro(),s.recordCommands(Cst.commandBuffer,this._renderPass,r.flags),n&&s.probeQueue.removeMacro(),512&r.flags&&(null===(o=this.camera.geometryRenderer)||void 0===o||o.render(t.renderPass,Cst.commandBuffer,Cst.pipeline.pipelineSceneData)),16&r.flags&&this._recordUI()}}class Gst{constructor(){this.deviceQueuePool=void 0,this.computeQueuePool=void 0,this.passPool=void 0,this.deviceScenePool=void 0,this.deviceQueuePool=new nn((()=>new Rst),16),this.deviceScenePool=new nn((()=>new Hst),16),this.computeQueuePool=new nn((()=>new Bst),16),this.passPool=new nn((()=>({priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0})),64)}addDeviceQueue(){return this.deviceQueuePool.add()}addComputeQueue(){return this.computeQueuePool.add()}addDeviceScene(){return this.deviceScenePool.add()}reset(){this.deviceQueuePool.reset(),this.computeQueuePool.reset(),this.deviceScenePool.reset()}}const Wst=new _d;class jst{get pipelineIAData(){return this._pipelineIAData}get deferredLitsBufView(){return this._deferredLitsBufView}get lightVolumeBuffer(){return this._lightVolumeBuffer}get lightBufferData(){return this._lightBufferData}get stageDescs(){return this._stageDescs}get emptyLocalUBO(){return this._localUBO}constructor(t){this._pipelineIAData=void 0,this._context=void 0,this._width=void 0,this._height=void 0,this._lightVolumeBuffer=void 0,this._lightBufferData=void 0,this._deferredLitsBufView=void 0,this._localUBO=void 0,this._stageDescs=new Map,this._context=t,this._width=t.width,this._height=t.height,this._pipelineIAData=this._createQuadInputAssembler();const e=this._genQuadVertexData(0,new _d(0,0,t.width,t.height));this._pipelineIAData.quadVB.update(e),this._createLightVolumes(),this._localUBO=t.device.createBuffer(new Ed(18,1,224,224))}resize(t,e){if(t!==this._width||e!==this._height){Wst.y=Wst.x=0,Wst.width=t,Wst.height=e;const i=this._genQuadVertexData(0,Wst);this._pipelineIAData.quadVB.update(i)}}_createLightVolumes(){const t=this._context.root.device;let e=80*km.LIGHTS_PER_PASS;e=Math.ceil(e/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._lightVolumeBuffer=t.createBuffer(new Ed(18,3,e,t.capabilities.uboOffsetAlignment)),this._deferredLitsBufView=t.createBuffer(new Dd(this._lightVolumeBuffer,0,e)),this._lightBufferData=new Float32Array(e/4)}_genQuadVertexData(t,e){const i=e.x/this._context.width,s=(e.x+e.width)/this._context.width;let r=e.y/this._context.height,n=(e.y+e.height)/this._context.height;this._context.root.device.capabilities.screenSpaceSignY>0&&([r,n]=[n,r]);const o=new Float32Array(16),a=(t,e,i,s,r,n,a,h,l,c,u,d,p,_,g,f)=>{o.set([t,e,i,s,r,n,a,h,l,c,u,d,p,_,g,f])};switch(t){case 0:a(-1,-1,i,n,1,-1,s,n,-1,1,i,r,1,1,s,r);break;case 1:a(-1,-1,s,n,1,-1,s,r,-1,1,i,n,1,1,i,r);break;case 2:a(-1,-1,i,r,1,-1,s,r,-1,1,i,n,1,1,s,n);break;case 3:a(-1,-1,i,r,1,-1,i,n,-1,1,s,r,1,1,s,n)}return o}_createQuadInputAssembler(){const t=new Fw,e=h.director.root.device,i=e.createBuffer(new Ed(10,3,64,16));if(!i)return t;const s=e.createBuffer(new Ed(6,1,12,2));if(!s)return t;const r=new Uint16Array(6);r[0]=0,r[1]=1,r[2]=2,r[3]=1,r[4]=3,r[5]=2,s.update(r.buffer);const n=new Array(2);n[0]=new Wd("a_position",21),n[1]=new Wd("a_texCoord",21);const o=e.createInputAssembler(new $d(n,[i],s));return t.quadIB=s,t.quadVB=i,t.quadIA=o,t}}class $st{constructor(t,e,i,s,r,n,o,a){void 0===a&&(a=null),this.device=void 0,this.pipeline=void 0,this.commandBuffer=void 0,this.pipelineSceneData=void 0,this.resourceGraph=void 0,this.devicePasses=new Map,this.deviceTextures=new Map,this.deviceBuffers=new Map,this.layoutGraph=void 0,this.root=void 0,this.pools=void 0,this.blit=void 0,this.culling=void 0,this.lightResource=new Tst,this.renderGraph=void 0,this.width=void 0,this.height=void 0,this.cullCamera=void 0,this.passDescriptorSet=void 0,this.profilerDescriptorSet=void 0,this.pipeline=t,this.device=e,this.commandBuffer=e.commandBuffer,this.pipelineSceneData=t.pipelineSceneData,this.resourceGraph=i,this.renderGraph=s,this.root=l.director.root,this.layoutGraph=r,this.width=n,this.height=o,this.pools=new Gst,this.blit=new jst(this),this.culling=new xst,this.passDescriptorSet=a,this.profilerDescriptorSet=Let("default").descriptorSet}reset(){this.culling.clear(),this.pools.reset(),this.cullCamera=null,this.lightResource.clear()}resize(t,e){this.width=t,this.height=e,this.blit.resize(t,e)}}class qst{constructor(t,e,i,s,r,n){this._context=void 0,this._visitor=void 0,Cst=this._context=new $st(t,e,i,new Gtt,s,r,n);const o=h.rendering.programLib;Cst.lightResource.init(o,e,16)}resize(t,e){Cst.resize(t,e)}_removeDeviceResource(){const t=Cst.pipeline.resourceUses,e=[],i=Cst.deviceTextures;for(const[s,r]of i){const i=Cst.resourceGraph.vertex(s),r=Cst.resourceGraph.getTraits(i);t.includes(s)||0!==r.residency||e.push(s)}for(const t of e)i.get(t).release(),i.delete(t);const s=[],r=Cst.deviceBuffers;for(const[e,i]of r){const i=Cst.resourceGraph.vertex(e),r=Cst.resourceGraph.getTraits(i);t.includes(e)||0!==r.residency||s.push(e)}for(const t of s)r.get(t).release(),r.delete(t);t.length=0}execute(t){Cst.renderGraph=t,Cst.reset();const e=Cst.commandBuffer,i=Cst.culling;i.buildRenderQueues(t,Cst.layoutGraph,Cst.pipelineSceneData),Cst.lightResource.buildLights(i,Cst.pipelineSceneData.isHDR,Cst.pipelineSceneData.shadows),this._removeDeviceResource(),e.begin(),i.uploadInstancing(e),this._visitor||(this._visitor=new Kst),stt(this._visitor.graphView,this._visitor,this._visitor.colorMap),e.end(),Cst.device.queue.submit([e])}release(){Cst.devicePasses.clear();for(const[t,e]of Cst.deviceTextures)e.release();Cst.deviceTextures.clear();for(const[t,e]of Cst.deviceBuffers)e.release();Cst.deviceBuffers.clear()}}class Xst{constructor(){this.queueID=4294967295,this.sceneID=4294967295,this.passID=4294967295,this.dispatchID=4294967295,this.currPass=void 0,this.currQueue=void 0,this.rg=void 0,this.rg=Cst.renderGraph}_isRasterPass(t){return Cst.renderGraph.h(0,t)}isComputePass(t){return Cst.renderGraph.h(3,t)}isDispatch(t){return Cst.renderGraph.h(11,t)}_isQueue(t){return Cst.renderGraph.h(8,t)}_isScene(t){return Cst.renderGraph.h(9,t)}_isBlit(t){return Cst.renderGraph.h(10,t)}applyID(t){this._isRasterPass(t)?this.passID=t:this._isQueue(t)?this.queueID=t:this._isScene(t)||this._isBlit(t)?this.sceneID=t:this.isComputePass(t)?this.passID=t:this.isDispatch(t)&&(this.dispatchID=t)}}class Yst extends Xst{constructor(){super()}clear(t){}viewport(t){}rasterPass(t){if(!this.rg.getValid(this.passID))return;const e=Cst.devicePasses,i=t.hashValue;this.currPass=e.get(i),this.currPass?this.currPass.resetResource(this.passID,t):(this.currPass=new kst(this.passID,t),e.set(i,this.currPass)),this.currPass.preRecord()}rasterSubpass(t){}computeSubpass(t){}resolve(t){}move(t){}raytrace(t){}compute(t){if(!this.rg.getValid(this.passID))return;Cst.devicePasses;const e=new Nst;e.applyInfo(this.passID,t),this.currPass=new Ust(e),this.currPass.preRecord(),this.currPass.record()}copy(t){if(t.uploadPairs.length)for(const e of t.uploadPairs){const t=Cst.deviceBuffers,i=Cst.resourceGraph,s=i.vertex(e.target);zst.resName=e.target,i.visitVertex(zst,s);const r=t.get(e.target);Cst.device.commandBuffer.updateBuffer(r.buffer,e.source,e.source.byteLength)}}queue(t){if(!this.rg.getValid(this.queueID))return;let e;this.currPass instanceof kst?(e=Cst.pools.addDeviceQueue(),e.init(this.currPass,t,this.queueID),this.currQueue=e,this.currPass.addQueue(e)):(e=Cst.pools.addComputeQueue(),e.init(this.currPass,t,this.queueID),this.currQueue=e,this.currPass.addQueue(e));const i=this.rg.getLayout(this.queueID);if(i){const t=Cst.layoutGraph;if(this.currPass.renderLayout){const e=t.locateChild(this.currPass.renderLayout.layoutID,i);this.currQueue.layoutID=e}}this.currQueue.preRecord()}scene(t){this.rg.getValid(this.sceneID)&&this.currQueue.setScene(this.sceneID,t).preRecord()}blit(t){this.rg.getValid(this.sceneID)&&this.currQueue.setScene(this.sceneID,void 0,t).preRecord()}dispatch(t){var e;let i=null;const s=this.currPass,r=null===(e=t.material)||void 0===e?void 0:e.passes[t.passID];null==r||r.update();const n=null==r?void 0:r.getShaderVariant();if(null!==r&&null!==n){const t=new Gp(n,null==r?void 0:r.pipelineLayout);t.bindPoint=1,i=e_.gfxDevice.createPipelineState(t)}const o=Cst.commandBuffer;if(i){o.bindPipelineState(i);const t=s.renderLayout.descriptorSet;o.bindDescriptorSet(0,t)}const a=t.threadGroupCountX,h=t.threadGroupCountY,l=t.threadGroupCountZ;o.dispatch(new Md(a,h,l))}}class Qst extends Xst{constructor(){super()}clear(t){}viewport(t){}rasterPass(t){const e=Cst.devicePasses,i=t.hashValue,s=e.get(i);s&&(this.currPass=s,this.currPass.record())}rasterSubpass(t){}computeSubpass(t){}resolve(t){}compute(t){}copy(t){}move(t){}raytrace(t){}queue(t){}scene(t){}blit(t){}dispatch(t){}}class Kst extends rtt{constructor(){super(),this._preVisitor=void 0,this._postVisitor=void 0,this._graphView=void 0,this._colorMap=void 0,this._preVisitor=new Yst,this._postVisitor=new Qst,this._graphView=new ntt(Cst.renderGraph),this._colorMap=new wet(Cst.renderGraph.nv())}get graphView(){return this._graphView}get colorMap(){return this._colorMap}discoverVertex(t,e){const i=e.g;this._preVisitor.applyID(t),i.visitVertex(this._preVisitor,t)}finishVertex(t,e){e.g.visitVertex(this._postVisitor,t)}}const Zst=new Od(2,2,0,2,2,2),Jst=new Od(1,1,0,2,2,2);class trt{get descriptorSetMap(){return this._descriptorSetMap}get linearSampler(){return this._linearSampler}get pointSampler(){return this._pointSampler}get descriptorSetLayout(){return this._descriptorSetLayout}set globalDescriptorSet(t){this._globalDescriptorSet=t}get globalDescriptorSet(){return this._globalDescriptorSet}constructor(t){this._descriptorSetMap=new Map,this._device=t,this._linearSampler=this._device.getSampler(Zst),this._pointSampler=this._device.getSampler(Jst);const e=new rp(pm.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new np(this._descriptorSetLayout))}regenLayout(){const t=new rp(pm.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new np(this._descriptorSetLayout))}bindBuffer(t,e){this._globalDescriptorSet.bindBuffer(t,e);const i=this._descriptorSetMap.values();let s=i.next();for(;!s.done;)s.value.bindBuffer(t,e),s=i.next()}bindSampler(t,e){this._globalDescriptorSet.bindSampler(t,e);const i=this._descriptorSetMap.values();let s=i.next();for(;!s.done;)s.value.bindSampler(t,e),s=i.next()}bindTexture(t,e){this._globalDescriptorSet.bindTexture(t,e);const i=this._descriptorSetMap.values();let s=i.next();for(;!s.done;)s.value.bindTexture(t,e),s=i.next()}update(){this._globalDescriptorSet.update();const t=this._descriptorSetMap.values();let e=t.next();for(;!e.done;)e.value.update(),e=t.next()}getOrCreateDescriptorSet(t){const e=this._device;if(!this._descriptorSetMap.has(t)){const i=this._globalDescriptorSet,s=e.createDescriptorSet(new np(this._descriptorSetLayout));this._descriptorSetMap.set(t,s);for(let t=0;t<8;t++)s.bindBuffer(t,i.getBuffer(t)),s.bindSampler(t,i.getSampler(t)),s.bindTexture(t,i.getTexture(t));const r=e.createBuffer(new Ed(18,3,256,256));s.bindBuffer(ym.BINDING,r),s.update()}return this._descriptorSetMap.get(t)}destroy(){this._descriptorSetLayout.destroy()}}const ert=new cr,irt=new Od(1,1,0,2,2,2);class srt{constructor(){this.renderData=new Vtt,this.layoutGraph=new oet,this.rg=new Gtt,this.vertId=-1,this.sceneData=new ktt,this.resourceGraph=new Mtt,this.computePass=new Ptt,this.rasterPass=new Ctt,this.rasterSubpass=new xtt,this.renderQueue=new ztt,this.sceneBuilder=new nn((()=>new hrt(this.renderData,this.layoutGraph,this.rg,this.vertId,this.sceneData)),16),this.renderPassBuilder=new nn((()=>new urt(this.renderData,this.rg,this.layoutGraph,this.resourceGraph,this.vertId,this.rasterPass,this.getPipelineSceneData())),16),this.computeQueueBuilder=new nn((()=>new drt(this.renderData,this.rg,this.layoutGraph,this.vertId,this.renderQueue,this.getPipelineSceneData())),16),this.renderQueueBuilder=new nn((()=>new lrt(this.renderData,this.rg,this.layoutGraph,this.vertId,this.renderQueue,this.getPipelineSceneData())),16),this.renderSubpassBuilder=new nn((()=>new crt(this.renderData,this.rg,this.layoutGraph,this.vertId,this.rasterSubpass,this.getPipelineSceneData())),16),this.computePassBuilder=new nn((()=>new prt(this.renderData,this.rg,this.layoutGraph,this.resourceGraph,this.vertId,this.computePass,this.getPipelineSceneData())),16),this.samplerInfo=new nn((()=>new Od),16),this.color=new nn((()=>new Sd),16),this.renderCommonObjectPool=new U9,this.renderGraphPool=new jtt(this.renderCommonObjectPool),this.viewport=new nn((()=>new wd),16)}getPipelineSceneData(){return l.director.root.pipeline.pipelineSceneData}createColor(t,e,i,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===s&&(s=0);const r=this.color.add();return r.set(t,e,i,s),r}createSamplerInfo(t,e,i,s,r,n,o,a){void 0===t&&(t=2),void 0===e&&(e=2),void 0===i&&(i=0),void 0===s&&(s=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=7);const h=this.samplerInfo.add();return h.minFilter=t,h.magFilter=e,h.mipFilter=i,h.addressU=s,h.addressV=r,h.addressW=n,h.maxAnisotropy=o,h.cmpFunc=a,h}reset(){this.sceneBuilder.reset(),this.renderPassBuilder.reset(),this.computePassBuilder.reset(),this.computeQueueBuilder.reset(),this.renderCommonObjectPool.reset(),this.renderGraphPool.reset(),this.viewport.reset(),this.samplerInfo.reset(),this.color.reset(),this.renderQueueBuilder.reset(),this.renderSubpassBuilder.reset()}}let rrt,nrt;function ort(t,e){switch(t){case 1:return e>1?4:0;case 2:return e>1?5:1;case 3:return 2;case 0:return 1}return 1}function art(t){switch(t){case 0:case 4:return 1;case 1:case 5:case 3:return 2;case 2:return 3}return 2}class hrt extends fit{constructor(t,e,i,s,r){super(t,e),this._renderGraph=void 0,this._scene=void 0,this._renderGraph=i,this._scene=r,this._vertID=s}update(t,e,i,s,r){this._data=t,this._lg=e,this._renderGraph=i,this._scene=r,this._vertID=s}useLightFrustum(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=void 0),this._scene.light.light=t,this._scene.light.level=e,this._scene.light.culledByLight=!0,i&&(this._scene.camera=i),32768&this._scene.flags)return;const s=this._renderGraph.getParent(this._vertID),r=this._renderGraph.getParent(s);this._renderGraph.getLayout(r),pit(this,this._scene.camera,t,e)}}class lrt extends fit{constructor(t,e,i,s,r,n){super(t,i),this._renderGraph=void 0,this._queue=void 0,this._pipeline=void 0,this._renderGraph=e,this._vertID=s,this._queue=r,this._pipeline=n}update(t,e,i,s,r,n){this._data=t,this._lg=i,this._renderGraph=e,this._vertID=s,this._queue=r,this._pipeline=n}setArrayBuffer(t,e){throw new Error("Method not implemented.")}get name(){return this._renderGraph.getName(this._vertID)}set name(t){this._renderGraph.setName(this._vertID,t)}addSceneOfCamera(t,e,i,s){void 0===i&&(i=0),void 0===s&&(s="Camera");const r=e.light,n=nrt.createSceneData(t.scene,t,i,!r||8&i?1:5,r);this._renderGraph.addVertex(9,n,s,"",nrt.createRenderData(),!0,this._vertID),this.getParentLayout();const o=h.director.getScene();oit(this,t,this._pipeline,t.scene||(o?o.renderScene:null)),8&i||r&&0!==r.type?pit(this,t,r,e.level):git(this,t)}addScene(t,e,i,s){void 0===e&&(e=0),void 0===i&&(i=void 0),void 0===s&&(s=void 0);const r=nrt.createSceneData(s||t.scene,t,e,!i||8&e?1:5,i),n=nrt.createRenderData(),o=this._renderGraph.addVertex(9,r,"Scene","",n,!0,this._vertID);32768&e||(this.getParentLayout(),oit(this,t,this._pipeline,s||t.scene),i&&0!==i.type?pit(this,t,i,0):8&e||git(this,t));const a=rrt.sceneBuilder.add();return a.update(n,this._lg,this._renderGraph,o,r),a}addFullscreenQuad(t,e,i,s){void 0===i&&(i=0),void 0===s&&(s="Quad"),this._renderGraph.addVertex(10,nrt.createBlit(t,e,i,null),s,"",nrt.createRenderData(),!0,this._vertID),this.getParentLayout();const r=h.director.getScene();oit(this,null,this._pipeline,r?r.renderScene:null),8&i||git(this,null)}addCameraQuad(t,e,i,s){void 0===s&&(s=0),this._renderGraph.addVertex(10,nrt.createBlit(e,i,s,t),"CameraQuad","",nrt.createRenderData(),!0,this._vertID),this.getParentLayout();const r=h.director.getScene();oit(this,t,this._pipeline,t.scene||(r?r.renderScene:null)),8&s||git(this,t)}clearRenderTarget(t,e){void 0===e&&(e=new Sd);const i=nrt.createClearView(t,1);i.clearColor.copy(e),this._renderGraph.addVertex(12,[i],"ClearRenderTarget","",nrt.createRenderData(),!0,this._vertID)}setViewport(t){const e=rrt.viewport.add();this._queue.viewport=e.copy(t)}addCustomCommand(t){throw new Error("Method not implemented.")}}class crt extends fit{constructor(t,e,i,s,r,n){super(t,i),this._renderGraph=void 0,this._layoutID=void 0,this._subpass=void 0,this._pipeline=void 0,this._renderGraph=e,this._vertID=s,this._subpass=r,this._pipeline=n;const o=this._renderGraph.getLayout(this._vertID);this._layoutID=i.locateChild(i.N,o)}update(t,e,i,s,r,n){this._data=t,this._lg=i,this._renderGraph=e,this._vertID=s,this._subpass=r,this._pipeline=n;const o=this._renderGraph.getLayout(this._vertID);this._layoutID=i.locateChild(i.N,o)}addRenderTarget(t,e,i,s,r,n){throw new Error("Method not implemented.")}setCustomShaderStages(t,e){throw new Error("Method not implemented.")}setArrayBuffer(t,e){throw new Error("Method not implemented.")}get name(){return this._renderGraph.getName(this._vertID)}set name(t){this._renderGraph.setName(this._vertID,t)}addDepthStencil(t,e,i,s,r,n,o,a,h){throw new Error("Method not implemented.")}addTexture(t,e,i){throw new Error("Method not implemented.")}addStorageBuffer(t,e,i){throw new Error("Method not implemented.")}addStorageImage(t,e,i){throw new Error("Method not implemented.")}setViewport(t){throw new Error("Method not implemented.")}addQueue(t,e,i){void 0===t&&(t=1),void 0===e&&(e="default");const s=this._lg.locateChild(this._layoutID,e),r=nrt.createRenderQueue(t,s),n=nrt.createRenderData(),o=this._renderGraph.addVertex(8,r,"",e,n,!0,this._vertID),a=rrt.renderQueueBuilder.add();return a.update(n,this._renderGraph,this._lg,o,r,this._pipeline),a}get showStatistics(){return this._subpass.showStatistics}set showStatistics(t){this._subpass.showStatistics=t}}class urt extends fit{constructor(t,e,i,s,r,n,o){super(t,i),this._renderGraph=void 0,this._layoutID=void 0,this._pass=void 0,this._pipeline=void 0,this._resourceGraph=void 0,this._renderGraph=e,this._resourceGraph=s,this._vertID=r,this._pass=n,this._pipeline=o;const a=this._renderGraph.getLayout(this._vertID);this._layoutID=i.locateChild(i.N,a)}update(t,e,i,s,r,n,o){this._renderGraph=e,this._lg=i,this._resourceGraph=s,this._vertID=r,this._pass=n,this._pipeline=o,this._data=t;const a=this._renderGraph.getLayout(this._vertID);this._layoutID=i.locateChild(i.N,a)}setCustomShaderStages(t,e){throw new Error("Method not implemented.")}setArrayBuffer(t,e){throw new Error("Method not implemented.")}setVersion(t,e){this._pass.versionName=t,this._pass.version=e}get name(){return this._renderGraph.getName(this._vertID)}set name(t){this._renderGraph.setName(this._vertID,t)}addRenderTarget(t,e,i,s){void 0===e&&(e=1),void 0===i&&(i=0),void 0===s&&(s=new Sd);let r=1;0===e&&(r=0);const n=nrt.createRasterView("",2,0,e,i,r);n.clearColor.copy(s),this._pass.rasterViews.set(t,n)}addDepthStencil(t,e,i,s,r,n){void 0===e&&(e=1),void 0===i&&(i=0),void 0===s&&(s=1),void 0===r&&(r=0),void 0===n&&(n=6);const o=nrt.createRasterView("",2,1,e,i,n);o.clearColor.set(s,r,0,0),this._pass.rasterViews.set(t,o)}resolveRenderTarget(t,e){}resolveDepthStencil(t,e,i,s){}_addComputeResource(t,e,i){const s=nrt.createComputeView(i);var r;s.accessType=e,this._pass.computeViews.has(t)?null===(r=this._pass.computeViews.get(t))||void 0===r||r.push(s):this._pass.computeViews.set(t,[s])}addTexture(t,e,i){if(void 0===i&&(i=null),this._addComputeResource(t,0,e),i){const t=this._lg.attributeIndex.get(e);this._data.samplers.set(t,i)}}addStorageBuffer(t,e,i){this._addComputeResource(t,e,i)}addStorageImage(t,e,i){this._addComputeResource(t,e,i)}addRenderSubpass(t){void 0===t&&(t="");const e="Raster",i=this._pass.subpassGraph.nv();this._pass.subpassGraph.addVertex(e,nrt.createSubpass());const s=nrt.createRasterSubpass(i,1,0),r=nrt.createRenderData(),n=this._renderGraph.addVertex(1,s,e,t,r,!0),o=rrt.renderSubpassBuilder.add();return o.update(r,this._renderGraph,this._lg,n,s,this._pipeline),o}addQueue(t,e,i){void 0===t&&(t=1),void 0===e&&(e="default");const s=this._lg.locateChild(this._layoutID,e),r=nrt.createRenderQueue(t,s),n=nrt.createRenderData(),o=this._renderGraph.addVertex(8,r,"",e,n,!0,this._vertID),a=rrt.renderQueueBuilder.add();return a.update(n,this._renderGraph,this._lg,o,r,this._pipeline),a}addFullscreenQuad(t,e,i,s){void 0===i&&(i=0),void 0===s&&(s="FullscreenQuad");const r=nrt.createRenderQueue(3),n=this._renderGraph.addVertex(8,r,"Queue","",nrt.createRenderData(),!0,this._vertID);this._renderGraph.addVertex(10,nrt.createBlit(t,e,i,null),s,"",nrt.createRenderData(),!0,n)}addCameraQuad(t,e,i,s,r){void 0===r&&(r="CameraQuad");const n=nrt.createRenderQueue(3),o=this._renderGraph.addVertex(8,n,"Queue","",nrt.createRenderData(),!0,this._vertID);this._renderGraph.addVertex(10,nrt.createBlit(e,i,s,t),r,"",nrt.createRenderData(),!0,o)}setViewport(t){this._pass.viewport.copy(t)}get showStatistics(){return this._pass.showStatistics}set showStatistics(t){this._pass.showStatistics=t}}class drt extends fit{constructor(t,e,i,s,r,n){super(t,i),this._renderGraph=void 0,this._queue=void 0,this._pipeline=void 0,this._renderGraph=e,this._vertID=s,this._queue=r,this._pipeline=n}update(t,e,i,s,r,n){this._data=t,this._lg=i,this._renderGraph=e,this._vertID=s,this._queue=r,this._pipeline=n}setArrayBuffer(t,e){throw new Error("Method not implemented.")}get name(){return this._renderGraph.getName(this._vertID)}set name(t){this._renderGraph.setName(this._vertID,t)}addDispatch(t,e,i,s,r,n){void 0===s&&(s=null),void 0===r&&(r=0),void 0===n&&(n="Dispatch"),this._renderGraph.addVertex(11,nrt.createDispatch(s,r,t,e,i),n,"",nrt.createRenderData(),!0,this._vertID)}}class prt extends fit{constructor(t,e,i,s,r,n,o){super(t,i),this._renderGraph=void 0,this._resourceGraph=void 0,this._layoutID=void 0,this._pass=void 0,this._pipeline=void 0,this._renderGraph=e,this._resourceGraph=s,this._vertID=r,this._pass=n,this._pipeline=o;const a=this._renderGraph.getLayout(this._vertID);this._layoutID=i.locateChild(i.N,a)}update(t,e,i,s,r,n,o){this._data=t,this._renderGraph=e,this._lg=i,this._resourceGraph=s,this._vertID=r,this._pass=n,this._pipeline=o;const a=this._renderGraph.getLayout(this._vertID);this._layoutID=i.locateChild(i.N,a)}setCustomShaderStages(t,e){throw new Error("Method not implemented.")}setArrayBuffer(t,e){throw new Error("Method not implemented.")}get name(){return this._renderGraph.getName(this._vertID)}set name(t){this._renderGraph.setName(this._vertID,t)}addTexture(t,e,i){throw new Error("Method not implemented.")}addStorageBuffer(t,e,i){this._addComputeResource(t,e,i)}addStorageImage(t,e,i){this._addComputeResource(t,e,i)}addMaterialTexture(t,e){throw new Error("Method not implemented.")}addQueue(t,e){void 0===t&&(t="default");const i=this._lg.locateChild(this._layoutID,t),s=nrt.createRenderQueue(1,i),r=nrt.createRenderData(),n=this._renderGraph.addVertex(8,s,"",t,r,!0,this._vertID),o=rrt.computeQueueBuilder.add();return o.update(r,this._renderGraph,this._lg,n,s,this._pipeline),o}_addComputeResource(t,e,i){const s=nrt.createComputeView(i);var r;s.accessType=e,this._pass.computeViews.has(t)?null===(r=this._pass.computeViews.get(t))||void 0===r||r.push(s):this._pass.computeViews.set(t,[s])}}class _rt{constructor(t){this._width=0,this._height=0,this._usesDeferredPipeline=!1,this._copyPassMat=new Lw,this._device=void 0,this._globalDSManager=void 0,this._defaultSampler=void 0,this._globalDescriptorSet=null,this._globalDescriptorSetInfo=null,this._globalDescriptorSetLayout=null,this._profilerDescriptorSet=null,this._macros={},this._pipelineSceneData=new ZE,this._constantMacros="",this._lightingMode=1,this._profiler=null,this._cameras=[],this._resourceUses=[],this._layoutGraph=void 0,this._resourceGraph=new Mtt,this._renderGraph=null,this._compiler=null,this._executor=null,this._customPipelineName="",this._globalDescSetData=void 0,this._combineSignY=0,this._layoutGraph=t}get type(){return 0}get capabilities(){return new $tt}get enableCpuLightCulling(){return!this._executor||this._executor._context.culling.enableLightCulling}set enableCpuLightCulling(t){this._executor&&(this._executor._context.culling.enableLightCulling=t)}addCustomBuffer(t,e,i){throw new Error("Method not implemented.")}addCustomTexture(t,e,i){throw new Error("Method not implemented.")}tryAddRenderWindowDepthStencil(t,e,i,s){i&&(s?this.addDepthStencilImpl(i,s.depthStencilTexture.format,t,e,4,s):this.addDepthStencilImpl(i,55,t,e,0))}addRenderWindow(t,e,i,s,r,n){const o=this._resourceGraph.find(t);if(4294967295!==o)return this.updateRenderWindow(t,r,n),o;this.tryAddRenderWindowDepthStencil(i,s,n,r.swapchain);const a=new utt;return a.dimension=2,a.width=i,a.height=s,a.depthOrArraySize=1,a.mipLevels=1,a.format=r.framebuffer.colorTextures[0].format,a.flags=16,r.swapchain?this._resourceGraph.addVertex(6,new ptt(r.swapchain),t,a,new dtt(4),new _tt,new Od):(a.sampleCount=r.framebuffer.colorTextures[0].info.samples,this._resourceGraph.addVertex(5,r.framebuffer,t,a,new dtt(3),new _tt,new Od))}updateRenderWindow(t,e,i){const s=this.resourceGraph.vertex(t),r=this.resourceGraph.getDesc(s);r.width=e.width,r.height=e.height,this.resourceGraph.object(s)!==e.framebuffer&&(this.resourceGraph.x[s].j=e.framebuffer),this.tryAddRenderWindowDepthStencil(e.width,e.height,i,e.swapchain)}updateStorageBuffer(t,e,i){void 0===i&&(i=0);const s=this.resourceGraph.vertex(t),r=this.resourceGraph.getDesc(s);r.width=e,0!==i&&(r.format=i)}updateRenderTarget(t,e,i,s){void 0===s&&(s=0);const r=this.resourceGraph.vertex(t),n=this.resourceGraph.getDesc(r);n.width=e,n.height=i,0!==s&&(n.format=s)}updateDepthStencil(t,e,i,s){void 0===s&&(s=0);const r=this.resourceGraph.find(t);4294967295!==r&&this.updateDepthStencilImpl(r,e,i,s)}updateStorageTexture(t,e,i,s){void 0===s&&(s=0);const r=this.resourceGraph.vertex(t),n=this.resourceGraph.getDesc(r);n.width=e,n.height=i,0!==s&&(n.format=s)}updateShadingRateTexture(t,e,i){const s=this.resourceGraph.vertex(t),r=this.resourceGraph.getDesc(s);r.width=e,r.height=i}addBuffer(t,e,i,s){const r=this._resourceGraph.find(t);if(4294967295!==r)return this.updateBuffer(t,e),r;const n=new utt;return n.dimension=0,n.width=e,n.flags=i,this._resourceGraph.addVertex(0,new vtt,t,n,new dtt(s),new _tt,new Od(2,2,0,2,2,2))}updateBuffer(t,e){this.updateResource(t,0,e,0,0,0,0,1)}addExternalTexture(t,e,i){throw new Error("Method not implemented.")}updateExternalTexture(t,e){throw new Error("Method not implemented.")}addTexture(t,e,i,s,r,n,o,a,h,l,c){const u=this._resourceGraph.find(t);if(4294967295!==u)return this.updateTexture(t,i,s,r,n,o,a,h),u;const d=new utt;return d.dimension=art(e),d.width=s,d.height=r,d.depthOrArraySize=3===d.dimension?n:o,d.mipLevels=a,d.format=i,d.sampleCount=h,d.flags=l,d.viewType=e,this._resourceGraph.addVertex(0,new vtt,t,d,new dtt(c),new _tt,new Od(2,2,0,2,2,2))}updateTexture(t,e,i,s,r,n,o,a){this.updateResource(t,e,i,s,r,n,o,a)}addResource(t,e,i,s,r,n,o,a,h,l,c){const u=this._resourceGraph.find(t);return 4294967295!==u?(this.updateResource(t,i,s,r,n,o,a,h),u):0===e?this.addBuffer(t,s,l,c):this.addTexture(t,ort(e,o),i,s,r,n,o,a,h,l,c)}updateResource(t,e,i,s,r,n,o,a){const h=this.resourceGraph.vertex(t),l=this.resourceGraph.getDesc(h);l.width=i,l.height=s,l.depthOrArraySize=3===l.dimension?r:n,l.mipLevels=o,0!==e&&(l.format=e),l.sampleCount=a}containsResource(t){return this._resourceGraph.contains(t)}addResolvePass(t){throw new Error("Method not implemented.")}addComputePass(t){const e=nrt.createComputePass(),i=nrt.createRenderData(),s=this._renderGraph.addVertex(3,e,"Compute",t,i,!0),r=rrt.computePassBuilder.add();return r.update(i,this._renderGraph,this._layoutGraph,this._resourceGraph,s,e,this._pipelineSceneData),h.director.root.pipeline,r}addUploadPass(t){const e=nrt.createCopyPass();for(const i of t)e.uploadPairs.push(i);this._renderGraph.addVertex(5,e,"UploadPass","",nrt.createRenderData(),!0)}addCopyPass(t){for(const e of t){const t=e.target,i=this.resourceGraph.find(t),s=this.resourceGraph.getDesc(i),r=this.addRenderPass(s.width,s.height,"copy-pass");r.addRenderTarget(t,1,0,rrt.createColor()),r.addTexture(e.source,"outputResultMap"),r.addQueue(0).addFullscreenQuad(this._copyPassMat,0,0)}}_generateConstantMacros(t){let e="";e+=`#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE ${3&this._device.getFormatFeatures(44)?1:0}\n`,e+=`#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS ${this._device.capabilities.maxVertexUniformVectors}\n`,e+=`#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS ${this._device.capabilities.maxFragmentUniformVectors}\n`,e+=`#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT ${this._device.hasFeature(5)?1:0}\n`,e+=`#define CC_PLATFORM_ANDROID_AND_WEBGL ${zn.os===On.ANDROID&&zn.isBrowser?1:0}\n`,e+=`#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES ${le.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0}\n`,e+=`#define CC_JOINT_UNIFORM_CAPACITY ${Hm.JOINT_UNIFORM_CAPACITY}\n`,this._constantMacros=e,this._layoutGraph.constantMacros=this._constantMacros}setCustomPipelineName(t){this._customPipelineName=t,"Deferred"===this._customPipelineName&&(this._usesDeferredPipeline=!0)}getGlobalDescriptorSetData(){const t=this.layoutGraph.locateChild(this.layoutGraph.N,"default");return this.layoutGraph.getLayout(t).descriptorSets.get(3)}_initCombineSignY(){const t=this._device;this._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5}getCombineSignY(){return this._combineSignY}get globalDescriptorSetData(){return this._globalDescSetData}get defaultSampler(){return this._defaultSampler}get defaultShadowTexture(){return Uy(this.device)}_compileMaterial(){this._copyPassMat.initialize({effectName:"pipeline/copy-pass"});for(let t=0;t<this._copyPassMat.passes.length;++t)this._copyPassMat.passes[t].tryCompile()}activate(t){this._device=e_.gfxDevice,rrt=new srt,nrt=rrt.renderGraphPool,Oit(this._device,this._layoutGraph),this._globalDSManager=new trt(this._device),this._globalDescSetData=this.getGlobalDescriptorSetData(),this._globalDescriptorSetLayout=this._globalDescSetData.descriptorSetLayout,this._globalDescriptorSetInfo=new np(this._globalDescriptorSetLayout),this._globalDescriptorSet=this._device.createDescriptorSet(this._globalDescriptorSetInfo),this._profilerDescriptorSet=this._device.createDescriptorSet(this._globalDescriptorSetInfo),this._globalDSManager.globalDescriptorSet=this.globalDescriptorSet,this._compileMaterial(),this.setMacroBool("CC_USE_HDR",this._pipelineSceneData.isHDR),this.setMacroBool("CC_USE_FLOAT_OUTPUT",le.ENABLE_FLOAT_OUTPUT&&Hy(this._device)),this._generateConstantMacros(!1),this._pipelineSceneData.activate(this._device),this._initCombineSignY();const e=Vy(this._device)?0:1;this.setMacroInt("CC_SHADOWMAP_FORMAT",e);const i=6===this._device.gfxAPI?1:0;this.setMacroInt("CC_SHADOWMAP_USE_LINEAR_DEPTH",i);const s=h.director.root;return this._defaultSampler=s.device.getSampler(irt),this.pipelineSceneData.csmSupported=this.device.capabilities.maxFragmentUniformVectors>=_rt.CSM_UNIFORM_VECTORS+_rt.GLOBAL_UNIFORM_VECTORS,this.setMacroBool("CC_SUPPORT_CASCADED_SHADOW_MAP",this.pipelineSceneData.csmSupported),this.setMacroInt("CC_SHADOW_TYPE",0),this.setMacroInt("CC_DIR_SHADOW_PCF_TYPE",Qw.HARD),this.setMacroInt("CC_DIR_LIGHT_SHADOW_TYPE",0),this.setMacroBool("CC_CASCADED_LAYERS_TRANSITION",!1),this.usesDeferredPipeline&&this.setMacroInt("CC_PIPELINE_TYPE",1),!0}destroy(){var t,e,i;return null===(t=this._globalDSManager)||void 0===t||t.globalDescriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy(),null===(i=this._pipelineSceneData)||void 0===i||i.destroy(),!0}get device(){return this._device}get lightingMode(){return this._lightingMode}set lightingMode(t){this._lightingMode=t}get usesDeferredPipeline(){return this._usesDeferredPipeline}get macros(){return this._macros}get globalDSManager(){return this._globalDSManager}get descriptorSetLayout(){return this._globalDSManager.descriptorSetLayout}get descriptorSet(){return this._globalDSManager.globalDescriptorSet}get profilerDescriptorSet(){return this._profilerDescriptorSet}get globalDescriptorSet(){return this._globalDescriptorSet}get globalDescriptorSetInfo(){return this._globalDescriptorSetInfo}get commandBuffers(){return[this._device.commandBuffer]}get pipelineSceneData(){return this._pipelineSceneData}get constantMacros(){return this._constantMacros}get profiler(){return this._profiler}set profiler(t){this._profiler=t}get geometryRenderer(){throw new Error("Method not implemented.")}get shadingScale(){return this._pipelineSceneData.shadingScale}set shadingScale(t){this._pipelineSceneData.shadingScale=t}getMacroString(t){const e=this._macros[t];return void 0===e?"":e}getMacroInt(t){const e=this._macros[t];return void 0===e?0:e}getMacroBool(t){const e=this._macros[t];return void 0!==e&&e}getSamplerInfo(t){if(this.containsResource(t)){const e=this._resourceGraph.vertex(t);return this._resourceGraph.getSampler(e)}return null}setMacroString(t,e){this._macros[t]=e}setMacroInt(t,e){this._macros[t]=e}setMacroBool(t,e){this._macros[t]=e}onGlobalPipelineStateChanged(){const t=h.rendering.getCustomPipeline(le.CUSTOM_PIPELINE_NAME);t&&("function"==typeof t.onGlobalPipelineStateChanged&&t.onGlobalPipelineStateChanged(),h.rendering.forceResizeAllWindows())}beginSetup(){this._renderGraph||(this._renderGraph=new Gtt),rrt.reset()}endSetup(){this.compile()}addStorageBuffer(t,e,i,s){void 0===s&&(s=0);const r=this._resourceGraph.find(t);if(4294967295!==r)return this.updateStorageBuffer(t,i,e),r;const n=new utt;return n.dimension=0,n.width=i,n.height=1,n.depthOrArraySize=1,n.mipLevels=1,n.format=e,n.flags=4,2===s?this._resourceGraph.addVertex(3,new ftt,t,n,new dtt(2),new _tt,new Od):this._resourceGraph.addVertex(1,new gtt,t,n,new dtt(s),new _tt,new Od)}addRenderTarget(t,e,i,s,r){void 0===r&&(r=0);const n=this._resourceGraph.find(t);if(4294967295!==n)return this.updateRenderTarget(t,i,s,e),n;const o=new utt;return o.dimension=2,o.width=i,o.height=s,o.depthOrArraySize=1,o.mipLevels=1,o.format=e,o.sampleCount=1,o.flags=24,this._resourceGraph.addVertex(0,new vtt,t,o,new dtt(r),new _tt,new Od(2,2,0,2,2,2))}updateDepthStencilImpl(t,e,i,s,r){const n=this.resourceGraph.getDesc(t);if(n.width=e,n.height=i,r){const e=this.resourceGraph.j(t);e.swapchain=r,n.format=e.swapchain.depthStencilTexture.format}else 0!==s&&(n.format=s)}addDepthStencilImpl(t,e,i,s,r,n){const o=this._resourceGraph.find(t);if(4294967295!==o)return this.updateDepthStencilImpl(o,i,s,e,n),o;const a=new utt;return a.dimension=2,a.width=i,a.height=s,a.depthOrArraySize=1,a.mipLevels=1,a.format=e,a.sampleCount=1,a.flags=40,n?this._resourceGraph.addVertex(6,new ptt(n,!0),t,a,new dtt(r),new _tt,new Od(1,1,0)):this._resourceGraph.addVertex(0,new vtt,t,a,new dtt(r),new _tt,new Od(1,1,0))}addDepthStencil(t,e,i,s,r){return void 0===r&&(r=0),this.addDepthStencilImpl(t,e,i,s,r)}addStorageTexture(t,e,i,s,r){void 0===r&&(r=0);const n=this._resourceGraph.find(t);if(4294967295!==n)return this.updateStorageTexture(t,i,s,e),n;const o=new utt;return o.dimension=2,o.width=i,o.height=s,o.depthOrArraySize=1,o.mipLevels=1,o.format=e,o.flags=12,this._resourceGraph.addVertex(0,new vtt,t,o,new dtt(r),new _tt,new Od(1,1,0))}addShadingRateTexture(t,e,i,s){void 0===s&&(s=0);const r=this._resourceGraph.find(t);if(4294967295!==r)return this.addShadingRateTexture(t,e,i),r;const n=new utt;return n.dimension=2,n.width=e,n.height=i,n.depthOrArraySize=1,n.mipLevels=1,n.format=6,n.flags=140,this._resourceGraph.addVertex(0,new vtt,t,n,new dtt(s),new _tt,new Od(2,2,0,2,2,2))}beginFrame(){}update(t){}endFrame(){var t;null===(t=this.renderGraph)||void 0===t||t.clear()}compile(){if(!this._renderGraph)throw new Error("RenderGraph cannot be built without being created");this._renderGraph.x.forEach((t=>{0===t.t&&Jet(t.j)}))}execute(){if(!this._renderGraph)throw new Error("Cannot run without creating rendergraph");this._executor||(this._executor=new qst(this,this._device,this._resourceGraph,this.layoutGraph,this.width,this.height)),this._executor.resize(this.width,this.height),this._executor.execute(this._renderGraph)}_applySize(t){let e=this._width,i=this._height;t.forEach((t=>{const s=t.window;e=Math.max(s.width,e),i=Math.max(s.height,i),this._cameras.includes(t)||this._cameras.push(t)})),e===this._width&&i===this._height||(this._width=e,this._height=i)}get width(){return this._width}get height(){return this._height}render(t){0!==t.length&&(this._applySize(t),Tw(t),this.beginFrame(),this.execute(),this.endFrame())}addBuiltinReflectionProbePass(t){const e=h.internal.reflectionProbeManager;if(!e)return;const i=e.getProbes();if(0!==i.length)for(let e=0;e<i.length;e++){const s=i[e];s.needRender&&1===i[e].probeType&&Iet(t,this,s,s.realtimePlanarTexture.window,0)}}addRenderPassImpl(t,e,i,s,r){void 0===s&&(s=1),void 0===r&&(r=0);const n=nrt.createRasterPass();n.viewport.width=t,n.viewport.height=e,n.count=s,n.quality=r;const o=nrt.createRenderData(),a=this._renderGraph.addVertex(0,n,"Raster",i,o,!0),h=rrt.renderPassBuilder.add();return h.update(o,this._renderGraph,this._layoutGraph,this._resourceGraph,a,n,this._pipelineSceneData),this._updateRasterPassConstants(h,t,e,i),nit(h,this._pipelineSceneData),h}addRenderPass(t,e,i){return void 0===i&&(i="default"),this.addRenderPassImpl(t,e,i)}addMultisampleRenderPass(t,e,i,s,r){return void 0===r&&(r="default"),this.addRenderPassImpl(t,e,r,i,s)}getDescriptorSetLayout(t,e){const i=this._layoutGraph,s=i.shaderLayoutIndex.get(t);return i.getLayout(s).descriptorSets.get(e).descriptorSetLayout}get renderGraph(){return this._renderGraph}get resourceGraph(){return this._resourceGraph}get layoutGraph(){return this._layoutGraph}get resourceUses(){return this._resourceUses}_updateRasterPassConstants(t,e,i,s){const r=h.director,n=r.root,o=e,a=i;n.pipeline.layoutGraph,ert.set(n.cumulativeTime,n.frameTime,r.getTotalFrames()),t.setVec4("cc_time",ert),ert.set(o,a,1/o,1/a),t.setVec4("cc_screenSize",ert),ert.set(o,a,1/o,1/a),t.setVec4("cc_nativeSize",ert);const l=n.debugView;if(ert.set(0,0,0,0),l){const t=[l.singleMode,0,0,0];for(let e=0;e<17;e++){const i=e%8;t[1+(e>>3)]+=(l.isCompositeModeEnabled(e)?1:0)*10**i}t[3]+=(l.lightingWithAlbedo?1:0)*10**6,t[3]+=(l.csmLayerColoration?1:0)*10**7,ert.set(t[0],t[1],t[2],t[3])}t.setVec4("cc_debug_view_mode",ert)}}_rt.MAX_BLOOM_FILTER_PASS_NUM=6,_rt.CSM_UNIFORM_VECTORS=61,_rt.GLOBAL_UNIFORM_VECTORS=64;class grt{constructor(t,e){this.offset=0,this.dataView=void 0,this.dataView=new DataView(t,e)}b(){return 0!==this.dataView.getUint8(this.offset++)}n(){const t=this.dataView.getFloat64(this.offset,!0);return this.offset+=8,t}s(){const t=this.n(),e=String.fromCharCode.apply(null,Array.from(new Uint8Array(this.dataView.buffer,this.offset,t)));return this.offset+=t,e}}class frt{constructor(t,e,i,s,r){this.programInfo=t,this.shaderInfo=e,this.attributes=i,this.blockSizes=s,this.handleMap=r}}class mrt{constructor(){this.programInfos=new Map,this.programProxies=new Map}}const yrt=[2,1,3,0];function vrt(t,e){const i={...e};return i.effectName=t,mv(i),i}function brt(t,e){for(const i of t.blocks)if(i.name===e)return{set:i.set,binding:i.binding};for(const i of t.buffers)if(i.name===e)return{set:i.set,binding:i.binding};for(const i of t.samplerTextures)if(i.name===e)return{set:i.set,binding:i.binding};for(const i of t.samplers)if(i.name===e)return{set:i.set,binding:i.binding};for(const i of t.textures)if(i.name===e)return{set:i.set,binding:i.binding};for(const i of t.images)if(i.name===e)return{set:i.set,binding:i.binding};for(const i of t.subpassInputs)if(i.name===e)return{set:i.set,binding:i.binding};throw B("binding not found in shaderInfo!")}function wrt(t,e){let i=e;const s=/layout\s*\(([^)])+\)\s+uniform\s+(\b\w+\b\s+)?sampler(\w+)\s+(\b\w+\b)/g;let r=s.exec(i);for(;r;){const e=r[4],{set:n,binding:o}=brt(t,e),a=`layout(set = ${n}, binding = ${o}) uniform ${r[2]?r[2]:""} sampler${r[3]} ${r[4]}`;i=i.replace(r[0],a),r=s.exec(i)}const n=/layout\s*\(([^)]+)\)\s*(readonly|writeonly)?\s*\b((uniform\s*|buffer\s*|image2D\s*){1,2})\b\s*(\b\w+\b)\s*[{;]/g;let o=n.exec(i);for(;o;){const e=o[5],{set:s,binding:r}=brt(t,e),a=o[2]?o[2]:"";let h=" {";o[3].includes("image")&&(h=";");let l=o[1];l=l.replace(/set\s*=\s*\d+/g,`set = ${s}`),l=l.replace(/binding\s*=\s*\d+/g,`binding = ${r}`);const c=`layout(${l}) ${a} ${o[3]} ${o[5]}${h}`;i=i.replace(o[0],c),o=n.exec(i)}return i}function Srt(t,e){"glsl4"===Sv(e_.gfxDevice)&&(e.glsl4.vert&&(e.glsl4.vert=wrt(t,e.glsl4.vert)),e.glsl4.frag&&(e.glsl4.frag=wrt(t,e.glsl4.frag)),e.glsl4.compute&&(e.glsl4.compute=wrt(t,e.glsl4.compute)))}function xrt(t,e){Srt(t,e);const i=yrt[1];for(const s of e.blocks){let e=!1;for(const r of t.blocks)if(r.set===i&&r.name===s.name){s.binding=r.binding,e=!0;break}e||B(`Block ${s.name} not found in shader ${t.name}`)}}function Trt(t,e,i,s,r){for(const n of t.descriptorBlocks){const t=n.visibility;let o=n.offset;switch(n.type){case 0:for(const n of e.blocks)n.stageFlags===t&&(r.push(_v(n.members)),s.blocks.push(new Fd(i,o,n.name,n.members.map((t=>new Ld(t.name,t.type,t.count))),1)),++o);break;case 1:case 6:break;case 2:for(const r of e.samplerTextures)r.stageFlags===t&&(s.samplerTextures.push(new zd(i,o,r.name,r.type,r.count)),++o);break;case 3:for(const r of e.samplers)r.stageFlags===t&&(s.samplers.push(new kd(i,o,r.name,r.count)),++o);break;case 4:for(const r of e.textures)r.stageFlags===t&&(s.textures.push(new Nd(i,o,r.name,r.type,r.count)),++o);break;case 5:for(const r of e.buffers)r.stageFlags===t&&(s.buffers.push(new Vd(i,o,r.name,1,r.memoryAccess)),++o);break;case 7:for(const r of e.images)r.stageFlags===t&&(s.images.push(new Ud(i,o,r.name,r.type,r.count,r.memoryAccess)),++o);break;case 8:for(const r of e.subpassInputs)r.stageFlags===t&&(s.subpassInputs.push(new Hd(i,r.binding,r.name,r.count)),++o)}}}function Crt(t,e,i,s,r){for(const n of e.descriptorBlocks){let o=n.offset;switch(n.type){case 0:for(const a of n.descriptors){const n=e.uniformBlocks.get(a.descriptorID);void 0!==n?(r.push(_v(n.members)),s.blocks.push(new Fd(i,o,t[a.descriptorID],n.members.map((t=>new Ld(t.name,t.type,t.count))),1)),++o):B(`Failed to find uniform block ${a.descriptorID} in layout`)}o!==n.offset+n.capacity&&B(`Uniform buffer binding mismatch for set ${i}`);break;case 1:case 6:break;case 2:for(const e of n.descriptors)s.samplerTextures.push(new zd(i,o,t[e.descriptorID],e.type,e.count)),++o;break;case 3:for(const e of n.descriptors)s.samplers.push(new kd(i,o,t[e.descriptorID],e.count)),++o;break;case 4:for(const e of n.descriptors)s.textures.push(new Nd(i,o,t[e.descriptorID],e.type,e.count)),++o;break;case 5:for(const e of n.descriptors)s.buffers.push(new Vd(i,o,t[e.descriptorID],1,3)),++o;break;case 7:for(const e of n.descriptors)s.images.push(new Ud(i,o,t[e.descriptorID],e.type,e.count,3)),++o;break;case 8:for(const e of n.descriptors)s.subpassInputs.push(new Hd(i,o,t[e.descriptorID],e.count)),++o}}}function Irt(t,e,i,s){const r=yrt[0];for(let n=0;n<t.blocks.length;n++){const o=t.blocks[n],a=e.layouts[o.name],h=a&&e.bindings.find((t=>t.binding===a.binding));a&&h&&h.descriptorType&yp?(s.push(_v(o.members)),i.blocks.push(new Fd(r,h.binding,o.name,o.members.map((t=>new Ld(t.name,t.type,t.count))),1))):console.warn(`builtin UBO '${o.name}' not available!`)}for(let s=0;s<t.samplerTextures.length;s++){const n=t.samplerTextures[s],o=e.layouts[n.name],a=o&&e.bindings.find((t=>t.binding===o.binding));o&&a&&a.descriptorType&vp?i.samplerTextures.push(new zd(r,a.binding,n.name,n.type,n.count)):console.warn(`builtin samplerTexture '${n.name}' not available!`)}}function Ert(t){let e=0;for(const i of t.bindings)1!==i.descriptorType&&2!==i.descriptorType||(e+=i.count);return e}function Drt(t){let e=0;for(const i of t.bindings)1!==i.descriptorType&&2!==i.descriptorType&&(e+=i.count);return e}function Art(t,e){for(const i of e)i.flattened=t[i.set]+i.binding}function Mrt(t,e,i){for(const s of i)s.flattened=t[s.set]+s.binding-e[s.set]}function Prt(t,e,i){const s=new Array(4);{var r,n,o,a;const h=(null===(r=t[3])||void 0===r?void 0:r.uniformBlockCapacity)||0,l=(null===(n=t[2])||void 0===n?void 0:n.uniformBlockCapacity)||0,c=(null===(o=t[1])||void 0===o?void 0:o.uniformBlockCapacity)||0,u=e?Ert(e):(null===(a=t[0])||void 0===a?void 0:a.uniformBlockCapacity)||0;s[yrt[3]]=h,s[yrt[2]]=l,s[yrt[1]]=c,s[yrt[0]]=u;const d=0,p=d+h,_=p+l,g=_+u,f=new Array(4);f[yrt[3]]=d,f[yrt[2]]=p,f[yrt[1]]=g,f[yrt[0]]=_,Art(f,i.blocks)}{var h,l,c;const r=0,n=r+((null===(h=t[3])||void 0===h?void 0:h.samplerTextureCapacity)||0),o=n+((null===(l=t[2])||void 0===l?void 0:l.samplerTextureCapacity)||0),a=o+(e?Drt(e):(null===(c=t[0])||void 0===c?void 0:c.samplerTextureCapacity)||0),u=new Array(4);u[yrt[3]]=r,u[yrt[2]]=n,u[yrt[1]]=a,u[yrt[0]]=o,Mrt(u,s,i.samplerTextures)}}function Brt(t,e,i,s,r,n){const o=[null,null,null,null];let a=null;const h=new jd,l=new Array;{const i=e.descriptorSets.get(3);i&&(o[3]=i.descriptorSetLayoutData,Crt(t.valueNames,i.descriptorSetLayoutData,yrt[3],h,l))}{const e=i.descriptorSets.get(2);e&&(o[2]=e.descriptorSetLayoutData,Crt(t.valueNames,e.descriptorSetLayoutData,yrt[2],h,l))}{const e=s.descriptors[1];if(r){const e=r.layout.descriptorSets.get(1);e&&(o[1]=e.descriptorSetLayoutData,Crt(t.valueNames,e.descriptorSetLayoutData,yrt[1],h,l))}else{const t=i.descriptorSets.get(1);t&&(o[1]=t.descriptorSetLayoutData,Trt(t.descriptorSetLayoutData,e,yrt[1],h,l))}}{const e=s.descriptors[0];if(r)if(n)a=_m,Irt(e,_m,h,l);else{const e=r.layout.descriptorSets.get(0);e&&(o[0]=e.descriptorSetLayoutData,Crt(t.valueNames,e.descriptorSetLayoutData,yrt[0],h,l))}else{const t=i.descriptorSets.get(0);t&&(o[0]=t.descriptorSetLayoutData,Trt(t.descriptorSetLayoutData,e,yrt[0],h,l))}}return Prt(o,a,h),h.stages.push(new Gd(1,"")),h.stages.push(new Gd(16,"")),[h,l]}class Rrt{constructor(t,e){void 0===e&&(e=null),this.shader=void 0,this.pipelineState=null,this.shader=t,this.pipelineState=e}get name(){return this.shader.name}}function Ort(t,e){for(const i in t.layouts){const s=t.layouts[i];if(s.binding===e){R(s.name===i);let t=0;return(s instanceof zd||s instanceof Ud)&&(t=s.type),[s.name,t]}}return B("descriptor not found"),["",0]}function Lrt(t,e){const i=new Ytt;for(const s of e.bindings){const[r,n]=Ort(e,s.binding),o=Pit(t,r),a=Tit(s.descriptorType),h=new Xtt(a,s.stageFlags,s.count);h.offset=s.binding,h.descriptors.push(new qtt(o,n,s.count)),i.descriptorBlocks.push(h),void 0!==i.bindingMap.get(o)&&B(`duplicate descriptor name '${r}'`),i.bindingMap.set(o,s.binding);const l=e.layouts[r];l instanceof Fd&&i.uniformBlocks.set(o,l)}return i}function Frt(t,e,i,s,r,n){{const t=Fit(i,1,yrt[1],e.descriptors[1]),s=new Qtt(t);zit(s.descriptorSetLayoutData,s.descriptorSetLayoutInfo),r.layout.descriptorSets.set(1,s)}if(n){const t=Lrt(i,_m),e=new Qtt(t);if(zit(e.descriptorSetLayoutData,e.descriptorSetLayoutInfo),_m.bindings.length!==e.descriptorSetLayoutInfo.bindings.length)B("local descriptor set layout inconsistent");else for(let t=0;t!==_m.bindings.length;++t){const i=_m.bindings[t],s=e.descriptorSetLayoutInfo.bindings[t];i.binding===s.binding&&i.descriptorType===s.descriptorType&&i.count===s.count&&i.stageFlags===s.stageFlags||B("local descriptor set layout inconsistent")}r.layout.descriptorSets.set(0,e)}else{const t=Fit(i,0,yrt[0],e.descriptors[0]),s=new Qtt(t);zit(s.descriptorSetLayoutData,s.descriptorSetLayoutInfo),r.layout.descriptorSets.set(0,s)}const o=s.shaderPrograms.length;s.shaderIndex.set(t,o),s.shaderPrograms.push(r)}function zrt(t,e,i,s,r){R(r<2);const n=e.j(i),o=n.shaderIndex.get(s);if(void 0===o)return Git();const a=n.shaderPrograms[o].layout.descriptorSets.get(r);return void 0===a?Git():(a.descriptorSetLayout||(a.descriptorSetLayout=t.createDescriptorSetLayout(a.descriptorSetLayoutInfo)),a.descriptorSetLayout)}function krt(t,e,i,s,r){R(r<2);const n=e.j(i),o=n.shaderIndex.get(s);if(void 0===o)return null;const a=n.shaderPrograms[o].layout.descriptorSets.get(r);return void 0===a?null:(a.descriptorSetLayout||(a.descriptorSetLayout=t.createDescriptorSetLayout(a.descriptorSetLayoutInfo)),a.descriptorSetLayout)}function Nrt(t,e,i){const s=i.program,r=Cit(t,i.pass);if(r===Sit)return B(`Invalid render pass, program: ${s}`),[Sit,Sit,Sit,null,Sit];const n=i.subpass&&""!==i.subpass&&!0,o=n?Iit(t,r,i.subpass):Sit;if(n&&o===Sit)return B(`Invalid render subpass, program: ${s}`),[Sit,Sit,Sit,null,Sit];const a=Eit(t,o===Sit?r:o,i.phase);if(a===Sit)return B(`Invalid render phase, program: ${s}`),[Sit,Sit,Sit,null,Sit];let h=null,l=Sit;for(let t=0;t<e.shaders.length;++t){const i=e.shaders[t];if(i.name===s){h=i,l=t;break}}return[r,o,a,h,l]}function Urt(t){return void 0===t.descriptors?(B(`No descriptors in shader: ${t.name}, please reimport ALL effects`),1):0}let Vrt=null,Hrt=!1;function Grt(){Hrt=!0}const Wrt=[],jrt=4294967295,$rt=new oet,qrt=new class{constructor(t){this.layoutGraph=void 0,this.phases=new Map,this.mergeHighFrequency=!1,this.fixedLocal=!0,this.localLayoutData=new Ytt,this.localDescriptorSetLayout=null,this.emptyDescriptorSetLayout=null,this.emptyPipelineLayout=null,this.pipeline=null,this.device=null,this.layoutGraph=t;for(const e of t.v())t.h(1,e)&&this.phases.set(e,new mrt)}init(t){if(this.device===t)return;this.device=t,this.emptyDescriptorSetLayout=this.device.createDescriptorSetLayout(new rp),this.emptyPipelineLayout=this.device.createPipelineLayout(new op);let e=Math.floor((this.device.capabilities.maxVertexUniformVectors-38)/3);e=e<256?e:256,Hm.initLayout(e);const i=this.layoutGraph;for(const t of i.v()){const e=i.getLayout(t);for(const[t,i]of e.descriptorSets)zit(i.descriptorSetLayoutData,i.descriptorSetLayoutInfo),i.descriptorSetLayout=this.device.createDescriptorSetLayout(i.descriptorSetLayoutInfo),R(!!i.descriptorSetLayout),i.descriptorSet=this.device.createDescriptorSet(new np(i.descriptorSetLayout)),R(!!i.descriptorSet)}for(const t of i.v()){if(!i.h(1,t))continue;const e=t,s=i.getParent(e),r=i.getLayout(s),n=i.getLayout(e),o=new op;Uit(r,3,o),Uit(n,2,o),Uit(n,1,o),Uit(n,0,o),i.j(e).pipelineLayout=this.device.createPipelineLayout(o)}{const t=_m;this.localLayoutData=Lrt(i,t);const e=new rp;zit(this.localLayoutData,e),this.localDescriptorSetLayout=this.device.createDescriptorSetLayout(e),R(!!this.localDescriptorSetLayout);let s=0;for(const t of this.localLayoutData.descriptorBlocks)if(0===t.type||1===t.type)for(const e of t.descriptors)s+=e.count;R(7===s)}var s;s=this.device,this.layoutGraph.constantMacros,s.getFormatFeatures(44),s.capabilities.maxVertexUniformVectors,s.capabilities.maxFragmentUniformVectors,s.hasFeature(5),Hm.JOINT_UNIFORM_CAPACITY}addEffect(t){const e=this.layoutGraph;for(const i of t.techniques)for(const s of i.passes){const i=s.program,[r,n,o,a]=Nrt(e,t,s);if(null===a||Urt(a)){B(`program: ${i} not found`);continue}R(r!==Sit&&o!==Sit);const h=n===Sit?r:n,l=e.getLayout(h),c=e.getLayout(o);let u=this.phases.get(o);void 0===u&&(u=new mrt,this.phases.set(o,u));const d=u.programInfos,p=vrt(t.name,a);let _=null;if(!this.mergeHighFrequency){const t=e.j(o);_=new iet,Frt(i,a,e,t,_,this.fixedLocal)}const[g,f]=Brt(e,l,c,a,_,this.fixedLocal);xrt(g,p);const m=gv(g),y=new Array;for(const t of p.attributes)y.push(new Wd(t.name,t.format,t.isNormalized,0,t.isInstanced,t.location));const v=new frt(p,g,y,f,m);d.set(a.name,v)}}precompileEffect(t,e){const i=this.layoutGraph;for(const s of e.techniques)for(const r of s.passes){const s=r.program,[n,o,a,h,l]=Nrt(i,e,r);if(null===h||Urt(h)){B(`program: ${s} not valid`);continue}R(n!==Sit&&a!==Sit&&l!==Sit);const c=e.combinations[l];c&&yv(c).forEach((e=>this.getProgramVariant(t,a,s,e)))}}getProgramInfo(t,e){return R(t!==Sit),this.phases.get(t).programInfos.get(e).programInfo}getShaderInfo(t,e){return R(t!==Sit),this.phases.get(t).programInfos.get(e).shaderInfo}getKey(t,e,i){R(t!==Sit);const s=this.phases.get(t);if(void 0===s)return B(`Invalid render phase, program: ${e}`),"";const r=s.programInfos.get(e);return void 0===r?(B(`Invalid program, program: ${e}`),""):uv(r.programInfo,i)}getProgramVariant(t,e,i,s,r){var n;void 0===r&&(r=null),Object.assign(s,null===(n=this.pipeline)||void 0===n?void 0:n.macros),R(e!==Sit);const o=this.phases.get(e);if(void 0===o)return B(`Invalid render phase, program: ${i}`),null;const a=o.programInfos.get(i);if(void 0===a)return B(`Invalid program, program: ${i}`),null;const h=a.programInfo;null===r&&(r=uv(h,s));const l=o.programProxies,c=l.get(r);if(void 0!==c)return c;const u=av(s,h.defines),d=this.layoutGraph.constantMacros+h.constantMacros+u.reduce(((t,e)=>`${t}#define ${e.name} ${e.value}\n`),"");let p=h.glsl3;const _=Sv(t);_?p=h[_]:j(16346);const g=a.shaderInfo;p.compute?(g.stages[0].source=d+p.compute,g.stages[0].stage=32,g.stages.length=1):(g.stages[0].source=d+p.vert,g.stages[1].source=d+p.frag),g.attributes=cv(h,a.attributes,s),g.name=hv(i,u);const f=t.createShader(g),m=new Rrt(f);return l.set(r,m),m}getMaterialDescriptorSetLayout(t,e,i){if(this.mergeHighFrequency){R(e!==Sit);const t=this.layoutGraph.getParent(e);return jit(this.layoutGraph,t,e,1)}return zrt(t,this.layoutGraph,e,i,1)}getLocalDescriptorSetLayout(t,e,i){if(this.mergeHighFrequency){R(e!==Sit);const t=this.layoutGraph.getParent(e);return jit(this.layoutGraph,t,e,0)}return zrt(t,this.layoutGraph,e,i,0)}getBlockSizes(t,e){R(t!==Sit);const i=this.phases.get(t);if(!i)return B(`Invalid render phase, program: ${e}`),[];const s=i.programInfos.get(e);return s?s.blockSizes:(B(`Invalid program, program: ${e}`),[])}getHandleMap(t,e){R(t!==Sit);const i=this.phases.get(t);if(!i)return B(`Invalid render phase, program: ${e}`),{};const s=i.programInfos.get(e);return s?s.handleMap:(B(`Invalid program, program: ${e}`),{})}getPipelineLayout(t,e,i){if(this.mergeHighFrequency)return R(e!==Sit),this.layoutGraph.j(e).pipelineLayout;const s=this.layoutGraph,r=s.j(e),n=r.shaderIndex.get(i);if(void 0===n)return Wit();const o=r.shaderPrograms[n];if(o.pipelineLayout)return o.pipelineLayout;const a=s.getParent(e);if(a===Sit)return Wit();const h=new op,l=$it(this.layoutGraph,a,e,3);l&&h.setLayouts.push(l);const c=$it(this.layoutGraph,a,e,2);c&&h.setLayouts.push(c);const u=krt(t,s,e,i,1);u&&h.setLayouts.push(u);const d=krt(t,s,e,i,0);return d&&h.setLayouts.push(d),o.pipelineLayout=t.createPipelineLayout(h),o.pipelineLayout}getProgramID(t,e){return qit(this.layoutGraph,t,e)}getDescriptorNameID(t){return Xit(this.layoutGraph,t)}getDescriptorName(t){return Yit(this.layoutGraph,t)}}($rt),Xrt=new Map;var Yrt=Object.freeze({__proto__:null,AccessType:{READ:0,READ_WRITE:1,WRITE:2},AttachmentType:{RENDER_TARGET:0,DEPTH_STENCIL:1,SHADING_RATE:2},ClearValueType:{NONE:0,FLOAT_TYPE:1,INT_TYPE:2},CopyPair:L9,Descriptor:M9,DescriptorBlock:P9,DescriptorBlockFlattened:B9,DescriptorBlockIndex:R9,DescriptorTypeOrder:{UNIFORM_BUFFER:0,DYNAMIC_UNIFORM_BUFFER:1,SAMPLER_TEXTURE:2,SAMPLER:3,TEXTURE:4,STORAGE_BUFFER:5,DYNAMIC_STORAGE_BUFFER:6,STORAGE_IMAGE:7,INPUT_ATTACHMENT:8},INVALID_ID:jrt,LightInfo:A9,LightingMode:{NONE:0,DEFAULT:1,CLUSTERED:2},MovePair:z9,ParameterType:{CONSTANTS:0,CBV:1,UAV:2,SRV:3,TABLE:4,SSV:5},PipelineCapabilities:$tt,PipelineStatistics:k9,PipelineType:{BASIC:0,STANDARD:1},QueueHint:{NONE:0,OPAQUE:1,MASK:2,BLEND:3,RENDER_OPAQUE:1,RENDER_CUTOUT:2,RENDER_TRANSPARENT:3},RenderCommonObjectPool:U9,ResolveFlags:{NONE:0,COLOR:1,DEPTH:2,STENCIL:4},ResolvePair:O9,ResourceDimension:{BUFFER:0,TEXTURE1D:1,TEXTURE2D:2,TEXTURE3D:3},ResourceFlags:{NONE:0,UNIFORM:1,INDIRECT:2,STORAGE:4,SAMPLED:8,COLOR_ATTACHMENT:16,DEPTH_STENCIL_ATTACHMENT:32,INPUT_ATTACHMENT:64,SHADING_RATE:128,TRANSFER_SRC:256,TRANSFER_DST:512},ResourceResidency:{MANAGED:0,MEMORYLESS:1,PERSISTENT:2,EXTERNAL:3,BACKBUFFER:4},SceneFlags:{NONE:0,OPAQUE:1,MASK:2,BLEND:4,OPAQUE_OBJECT:1,CUTOUT_OBJECT:2,TRANSPARENT_OBJECT:4,SHADOW_CASTER:8,UI:16,DEFAULT_LIGHTING:32,VOLUMETRIC_LIGHTING:64,CLUSTERED_LIGHTING:128,PLANAR_SHADOW:256,GEOMETRY:512,PROFILER:1024,DRAW_INSTANCING:2048,DRAW_NON_INSTANCING:4096,REFLECTION_PROBE:8192,GPU_DRIVEN:16384,NON_BUILTIN:32768,ALL:4294967295},SubpassCapabilities:{NONE:0,INPUT_DEPTH_STENCIL:1,INPUT_COLOR:2,INPUT_COLOR_MRT:4,HETEROGENEOUS_SAMPLE_COUNT:8},TaskType:{SYNC:0,ASYNC:1},UpdateFrequency:{PER_INSTANCE:0,PER_BATCH:1,PER_PHASE:2,PER_PASS:3,COUNT:4},UploadPair:F9,completePhaseName:function(t){return"number"==typeof t?t.toString():"string"==typeof t?t:"default"},createCustomPipeline:function(){const t=new _rt($rt),e=le.CUSTOM_PIPELINE_NAME;return t.setCustomPipelineName(e),qrt.pipeline=t,t},customPipelineBuilderMap:Xrt,defaultWindowResize:function(t,e,i,s){t.addRenderWindow(e.colorName,36,i,s,e),t.addDepthStencil(e.depthStencilName,55,i,s);const r=e.renderWindowId,n=Vy(t.device)?11:35,o=t.pipelineSceneData.shadows.size;t.addRenderTarget(`ShadowMap${r}`,n,o.x,o.y),t.addDepthStencil(`ShadowDepth${r}`,55,o.x,o.y)},destroy:function(){Hit($rt)},dispatchResizeEvents:function(t,e,i){if(e.windowResize){for(const s of t){if(!s.window.isRenderWindowResized()&&!Hrt)continue;const t=Math.max(Math.floor(s.window.width),1),r=Math.max(Math.floor(s.window.height),1);e.windowResize(i,s.window,s,t,r),Wrt.push(s.window)}for(const t of Wrt)t.setRenderWindowResizeHandled();Wrt.length=0,Hrt=!1}},enableEffectImport:!0,forceResizeAllWindows:Grt,getCustomPipeline:function(t){let e=Xrt.get(t);return e||(e=Xrt.get("Forward")),e},getEditorPipelineSettings:function(){return Vrt},getPassID:function(t){return Cit($rt,t)},getPhaseID:function(t,e){return Eit($rt,t,e)},getSubpassID:function(t,e){return Iit($rt,t,e)},init:function(t,e){if(e&&e.byteLength>=8){const t=new Uint8Array(e);if(new DataView(t.buffer,t.byteOffset,8).getUint32(0)===jrt){const e=new qP.Inflate(new Uint8Array(t.buffer,t.byteOffset+8)).decompress();bet(new grt(e.buffer,e.byteOffset),$rt)}else bet(new grt(t.buffer,t.byteOffset),$rt)}Vit(t,$rt)},loadCopyPair:function(t,e){e.source=t.s(),e.target=t.s(),e.mipLevels=t.n(),e.numSlices=t.n(),e.sourceMostDetailedMip=t.n(),e.sourceFirstSlice=t.n(),e.sourcePlaneSlice=t.n(),e.targetMostDetailedMip=t.n(),e.targetFirstSlice=t.n(),e.targetPlaneSlice=t.n()},loadDescriptor:H9,loadDescriptorBlock:function(t,e){let i=0;i=t.n();for(let s=0;s!==i;++s){const i=t.s(),s=new M9;H9(t,s),e.descriptors.set(i,s)}i=t.n();for(let s=0;s!==i;++s){const i=t.s(),s=new Fd;I9(t,s),e.uniformBlocks.set(i,s)}e.capacity=t.n(),e.count=t.n()},loadDescriptorBlockFlattened:function(t,e){let i=0;i=t.n(),e.descriptorNames.length=i;for(let s=0;s!==i;++s)e.descriptorNames[s]=t.s();i=t.n(),e.uniformBlockNames.length=i;for(let s=0;s!==i;++s)e.uniformBlockNames[s]=t.s();i=t.n(),e.descriptors.length=i;for(let s=0;s!==i;++s){const i=new M9;H9(t,i),e.descriptors[s]=i}i=t.n(),e.uniformBlocks.length=i;for(let s=0;s!==i;++s){const i=new Fd;I9(t,i),e.uniformBlocks[s]=i}e.capacity=t.n(),e.count=t.n()},loadDescriptorBlockIndex:function(t,e){e.updateFrequency=t.n(),e.parameterType=t.n(),e.descriptorType=t.n(),e.visibility=t.n()},loadLightInfo:function(t,e){e.level=t.n(),e.culledByLight=t.b()},loadMovePair:function(t,e){e.source=t.s(),e.target=t.s(),e.mipLevels=t.n(),e.numSlices=t.n(),e.targetMostDetailedMip=t.n(),e.targetFirstSlice=t.n(),e.targetPlaneSlice=t.n()},loadPipelineStatistics:function(t,e){e.numRenderPasses=t.n(),e.numManagedTextures=t.n(),e.totalManagedTextures=t.n(),e.numUploadBuffers=t.n(),e.numUploadBufferViews=t.n(),e.numFreeUploadBuffers=t.n(),e.numFreeUploadBufferViews=t.n(),e.numDescriptorSets=t.n(),e.numFreeDescriptorSets=t.n(),e.numInstancingBuffers=t.n(),e.numInstancingUniformBlocks=t.n()},loadResolvePair:function(t,e){e.source=t.s(),e.target=t.s(),e.resolveFlags=t.n(),e.mode=t.n(),e.mode1=t.n()},packRGBE:function(t){const e=Math.max(Math.max(t.x,t.y),t.z);let i=128;e>1e-4&&(i=Math.log(e)/Math.log(1.1),i=Math.ceil(i),i=fi(i+128,0,255));const s=1/1.1**(i-128),r=fr(t.multiplyScalar(s),new Ki(0,0,0),new Ki(1,1,1));r.multiplyScalar(255);const n=mr(r).add((o=r.subtract(mr(r)))<(a=new Ki(.5,.5,.5))?a:o);var o,a;return new cr(n.x/255,n.y/255,n.z/255,i/255)},programLib:qrt,saveCopyPair:function(t,e){t.s(e.source),t.s(e.target),t.n(e.mipLevels),t.n(e.numSlices),t.n(e.sourceMostDetailedMip),t.n(e.sourceFirstSlice),t.n(e.sourcePlaneSlice),t.n(e.targetMostDetailedMip),t.n(e.targetFirstSlice),t.n(e.targetPlaneSlice)},saveDescriptor:V9,saveDescriptorBlock:function(t,e){t.n(e.descriptors.size);for(const[i,s]of e.descriptors)t.s(i),V9(t,s);t.n(e.uniformBlocks.size);for(const[i,s]of e.uniformBlocks)t.s(i),C9(t,s);t.n(e.capacity),t.n(e.count)},saveDescriptorBlockFlattened:function(t,e){t.n(e.descriptorNames.length);for(const i of e.descriptorNames)t.s(i);t.n(e.uniformBlockNames.length);for(const i of e.uniformBlockNames)t.s(i);t.n(e.descriptors.length);for(const i of e.descriptors)V9(t,i);t.n(e.uniformBlocks.length);for(const i of e.uniformBlocks)C9(t,i);t.n(e.capacity),t.n(e.count)},saveDescriptorBlockIndex:function(t,e){t.n(e.updateFrequency),t.n(e.parameterType),t.n(e.descriptorType),t.n(e.visibility)},saveLightInfo:function(t,e){t.n(e.level),t.b(e.culledByLight)},saveMovePair:function(t,e){t.s(e.source),t.s(e.target),t.n(e.mipLevels),t.n(e.numSlices),t.n(e.targetMostDetailedMip),t.n(e.targetFirstSlice),t.n(e.targetPlaneSlice)},savePipelineStatistics:function(t,e){t.n(e.numRenderPasses),t.n(e.numManagedTextures),t.n(e.totalManagedTextures),t.n(e.numUploadBuffers),t.n(e.numUploadBufferViews),t.n(e.numFreeUploadBuffers),t.n(e.numFreeUploadBufferViews),t.n(e.numDescriptorSets),t.n(e.numFreeDescriptorSets),t.n(e.numInstancingBuffers),t.n(e.numInstancingUniformBlocks)},saveResolvePair:function(t,e){t.s(e.source),t.s(e.target),t.n(e.resolveFlags),t.n(e.mode),t.n(e.mode1)},setCustomPipeline:function(t,e){Xrt.set(t,e),Grt()},setEditorPipelineSettings:function(t){Vrt=t,Hrt=!0}});t("rendering",Yrt),l.rendering=Yrt;class Qrt extends Fp{get gpuDescriptorSet(){return this._gpuDescriptorSet}constructor(){super(),this._gpuDescriptorSet=null}initialize(t){this._layout=t.layout;const{bindings:e,descriptorIndices:i,descriptorCount:s}=t.layout.gpuDescriptorSetLayout;this._buffers=Array(s).fill(null),this._textures=Array(s).fill(null),this._samplers=Array(s).fill(null);const r=[];this._gpuDescriptorSet={gpuDescriptors:r,descriptorIndices:i};for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<i.count;t++)r.push({type:i.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const t=this._gpuDescriptorSet.gpuDescriptors;for(let e=0;e<t.length;++e)if(t[e].type&yp){const i=this._buffers[e];i&&(t[e].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else t[e].type&vp&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}}}const Krt=Math.max,Zrt=Math.min;function Jrt(t){switch(t){case 4:case 6:case 14:case 16:case 24:case 25:case 27:case 36:case 35:case 37:case 39:case 51:case 53:case 56:case 58:case 60:case 61:case 62:case 63:case 64:case 66:case 70:case 71:case 72:case 73:case 74:case 75:case 76:case 79:case 81:case 83:case 84:case 85:case 86:case 87:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:case 106:case 107:case 108:case 109:case 110:case 111:case 112:case 113:case 114:case 115:case 116:default:return 5121;case 5:case 7:case 15:case 17:case 26:case 28:case 38:case 40:case 65:case 67:case 80:case 82:return 5120;case 8:case 18:case 29:case 41:return 36193;case 9:case 19:case 30:case 42:return 5123;case 10:case 20:case 31:case 43:return 5122;case 11:case 21:case 32:case 44:case 48:case 69:case 68:return 5126;case 12:case 22:case 33:case 45:case 52:case 54:return 5125;case 13:case 23:case 34:case 46:return 5124;case 47:return 33635;case 49:return 32820;case 50:return 32819;case 55:return 34042}}function tnt(t){switch(t){case 47:return 36194;case 49:return 32855;case 50:return 32854;case 41:return 34842;case 44:return 34836;case 37:return 35907;case 54:return 33189;case 55:return 34041;default:return j(16309),6408}}function ent(t){switch(t){case 1:return 6406;case 2:return 6409;case 3:return 6410;case 24:case 29:case 32:case 47:return 6407;case 36:case 35:case 37:case 41:case 44:case 49:case 50:return 6408;case 54:return 6402;case 55:return 34041;case 56:return 33776;case 57:return 33777;case 58:return 35916;case 59:return 35917;case 60:return 33778;case 61:return 35918;case 62:return 33779;case 63:return 35919;case 72:return 36196;case 73:return 37492;case 74:return 37493;case 75:return 37494;case 76:return 37495;case 77:return 37496;case 78:return 37497;case 79:return 37488;case 80:return 37489;case 81:return 37490;case 82:return 37491;case 83:return 35841;case 84:return 35843;case 85:return 35840;case 86:return 35842;case 89:return 37808;case 90:return 37809;case 91:return 37810;case 92:return 37811;case 93:return 37812;case 94:return 37813;case 95:return 37814;case 96:return 37815;case 97:return 37816;case 98:return 37817;case 99:return 37818;case 100:return 37819;case 101:return 37820;case 102:return 37821;case 103:return 37840;case 104:return 37841;case 105:return 37842;case 106:return 37843;case 107:return 37844;case 108:return 37845;case 109:return 37846;case 110:return 37847;case 111:return 37848;case 112:return 37849;case 113:return 37850;case 114:return 37851;case 115:return 37852;case 116:return 37853;default:return j(16310),6408}}function int(t){switch(t){case 1:return 35670;case 2:return 35671;case 3:return 35672;case 4:return 35673;case 5:return 5124;case 6:return 35667;case 7:return 35668;case 8:return 35669;case 9:return 5125;case 13:return 5126;case 14:return 35664;case 15:return 35665;case 16:return 35666;case 17:return 35674;case 21:return 35675;case 25:return 35676;case 28:return 35678;case 31:return 35680;default:return j(16311),0}}function snt(t){switch(t){case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:return Int32Array;case 13:case 14:case 15:case 16:case 17:case 21:case 25:return Float32Array;default:return j(16312),Float32Array}}function rnt(t){switch(t){case 35670:return 1;case 35671:return 2;case 35672:return 3;case 35673:return 4;case 5124:return 5;case 35667:return 6;case 35668:return 7;case 35669:return 8;case 5125:return 9;case 5126:return 13;case 35664:return 14;case 35665:return 15;case 35666:return 16;case 35674:return 17;case 35675:return 21;case 35676:return 25;case 35678:return 28;case 35680:return 31;default:return j(16313),0}}function nnt(t){switch(t){case 35670:case 5124:case 5125:case 5126:case 35678:case 35680:return 4;case 35671:case 35667:case 35664:return 8;case 35672:case 35668:case 35665:return 12;case 35673:case 35669:case 35666:case 35674:return 16;case 35675:return 36;case 35676:return 64;default:return j(16314),0}}function ont(t){switch(t){case 35674:return 2;case 35675:return 3;case 35676:return 4;default:return 1}}const ant=[512,513,514,515,516,517,518,519],hnt=[0,7680,7681,7682,7683,5386,34055,34056],lnt=[32774,32778,32779,32775,32776],cnt=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];function unt(t,e){const{gl:i,stateCache:s}=t,r=2&e.memUsage?35048:35044;if(8&e.usage){e.glTarget=34962;const n=i.createBuffer();n&&(e.glBuffer=n,e.size>0&&(t.extensions.useVAO&&s.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),Tnt.gpuInputAssembler=null,s.glArrayBuffer!==e.glBuffer&&(i.bindBuffer(34962,e.glBuffer),s.glArrayBuffer=e.glBuffer),i.bufferData(34962,e.size,r),i.bindBuffer(34962,null),s.glArrayBuffer=null))}else if(4&e.usage){e.glTarget=34963;const n=i.createBuffer();n&&(e.glBuffer=n,e.size>0&&(t.extensions.useVAO&&s.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),Tnt.gpuInputAssembler=null,s.glElementArrayBuffer!==e.glBuffer&&(i.bindBuffer(34963,e.glBuffer),s.glElementArrayBuffer=e.glBuffer),i.bufferData(34963,e.size,r),i.bindBuffer(34963,null),s.glElementArrayBuffer=null))}else 16&e.usage?(e.glTarget=0,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(64&e.usage||2&e.usage||1&e.usage||j(16315),e.glTarget=0)}function dnt(t,e){const{gl:i}=t,s=t.stateCache;if(e.glBuffer){switch(e.glTarget){case 34962:t.extensions.useVAO&&s.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),Tnt.gpuInputAssembler=null,i.bindBuffer(34962,null),s.glArrayBuffer=null;break;case 34963:t.extensions.useVAO&&s.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),Tnt.gpuInputAssembler=null,i.bindBuffer(34963,null),s.glElementArrayBuffer=null}i.deleteBuffer(e.glBuffer),e.glBuffer=null}}function pnt(t,e){const{gl:i,stateCache:s}=t,r=2&e.memUsage?35048:35044;8&e.usage?(t.extensions.useVAO&&s.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),Tnt.gpuInputAssembler=null,s.glArrayBuffer!==e.glBuffer&&i.bindBuffer(34962,e.glBuffer),e.buffer?i.bufferData(34962,e.buffer,r):i.bufferData(34962,e.size,r),i.bindBuffer(34962,null),s.glArrayBuffer=null):4&e.usage?(t.extensions.useVAO&&s.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),Tnt.gpuInputAssembler=null,s.glElementArrayBuffer!==e.glBuffer&&i.bindBuffer(34963,e.glBuffer),e.buffer?i.bufferData(34963,e.buffer,r):i.bufferData(34963,e.size,r),i.bindBuffer(34963,null),s.glElementArrayBuffer=null):16&e.usage?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(64&e.usage||2&e.usage||1&e.usage||j(16315),e.glTarget=0)}function _nt(t,e,i,s,r){if(16&e.usage)ArrayBuffer.isView(i)?e.vf32.set(i,s/4):e.vf32.set(new Float32Array(i),s/4);else if(64&e.usage){e.indirects.clearDraws();const t=i.drawInfos;for(let i=0;i<t.length;++i)e.indirects.setDrawInfo(s+i,t[i])}else{const n=i,{gl:o,stateCache:a}=t;switch(e.glTarget){case 34962:t.extensions.useVAO&&a.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),Tnt.gpuInputAssembler=null,a.glArrayBuffer!==e.glBuffer&&(o.bindBuffer(34962,e.glBuffer),a.glArrayBuffer=e.glBuffer);break;case 34963:t.extensions.useVAO&&a.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),Tnt.gpuInputAssembler=null,a.glElementArrayBuffer!==e.glBuffer&&(o.bindBuffer(34963,e.glBuffer),a.glElementArrayBuffer=e.glBuffer);break;default:return void j(16316)}zn.os===On.IOS&&2&e.memUsage&&0===s&&r===n.byteLength?o.bufferData(e.glTarget,n,o.DYNAMIC_DRAW):r===n.byteLength?o.bufferSubData(e.glTarget,s,n):o.bufferSubData(e.glTarget,s,n.slice(0,r))}}function gnt(t,e){const{gl:i,stateCache:s}=t;e.glFormat=e.glInternalFmt=ent(e.format),e.glType=Jrt(e.format);let r=e.width,n=e.height;switch(e.type){case 1:{e.glTarget=3553;const o=Krt(r,n);if(o>t.capabilities.maxTextureSize&&j(9100,o,t.capabilities.maxTextureSize),t.textureExclusive[e.format]||t.extensions.WEBGL_depth_texture||!mp[e.format].hasDepth){if(e.glTexture=i.createTexture(),e.size>0){const t=s.glTexUnits[s.texUnit];if(t.glTexture!==e.glTexture&&(i.bindTexture(3553,e.glTexture),t.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const s=Sp(e.format,r,n,1),o=new Uint8Array(s);i.compressedTexImage2D(3553,t,e.glInternalFmt,r,n,0,o),r=Krt(1,r>>1),n=Krt(1,n>>1)}else for(let t=0;t<e.mipLevel;++t)i.texImage2D(3553,t,e.glInternalFmt,r,n,0,e.glFormat,e.glType,null),r=Krt(1,r>>1),n=Krt(1,n>>1);e.isPowerOf2?(e.glWrapS=10497,e.glWrapT=10497):(e.glWrapS=33071,e.glWrapT=33071),e.glMinFilter=9729,e.glMagFilter=9729,i.texParameteri(e.glTarget,10242,e.glWrapS),i.texParameteri(e.glTarget,10243,e.glWrapT),i.texParameteri(e.glTarget,10241,e.glMinFilter),i.texParameteri(e.glTarget,10240,e.glMagFilter)}}else e.glInternalFmt=tnt(e.format),e.glRenderbuffer=i.createRenderbuffer(),e.size>0&&(s.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(36161,e.glRenderbuffer),s.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(36161,e.glInternalFmt,r,n));break}case 3:{e.glTarget=34067;const o=Krt(r,n);if(o>t.capabilities.maxCubeMapTextureSize&&j(9100,o,t.capabilities.maxTextureSize),e.glTexture=i.createTexture(),e.size>0){const t=s.glTexUnits[s.texUnit];if(t.glTexture!==e.glTexture&&(i.bindTexture(34067,e.glTexture),t.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<6;++t){r=e.width,n=e.height;for(let s=0;s<e.mipLevel;++s){const o=Sp(e.format,r,n,1),a=new Uint8Array(o);i.compressedTexImage2D(34069+t,s,e.glInternalFmt,r,n,0,a),r=Krt(1,r>>1),n=Krt(1,n>>1)}}else for(let t=0;t<6;++t){r=e.width,n=e.height;for(let s=0;s<e.mipLevel;++s)i.texImage2D(34069+t,s,e.glInternalFmt,r,n,0,e.glFormat,e.glType,null),r=Krt(1,r>>1),n=Krt(1,n>>1)}e.isPowerOf2?(e.glWrapS=10497,e.glWrapT=10497):(e.glWrapS=33071,e.glWrapT=33071),e.glMinFilter=9729,e.glMagFilter=9729,i.texParameteri(e.glTarget,10242,e.glWrapS),i.texParameteri(e.glTarget,10243,e.glWrapT),i.texParameteri(e.glTarget,10241,e.glMinFilter),i.texParameteri(e.glTarget,10240,e.glMagFilter)}break}default:j(16317),e.type=1,e.glTarget=3553}}function fnt(t,e){const{gl:i,stateCache:s}=t;if(e.glTexture){const t=s.glTexUnits;let r=s.texUnit;i.deleteTexture(e.glTexture);for(let s=0;s<t.length;s++)t[s].glTexture===e.glTexture&&(i.activeTexture(33984+s),r=s,i.bindTexture(e.glTarget,null),t[s].glTexture=null);s.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){const t=s.glRenderbuffer;i.deleteRenderbuffer(e.glRenderbuffer),t===e.glRenderbuffer&&(i.bindRenderbuffer(36161,null),s.glRenderbuffer=null),e.glRenderbuffer=null}}function mnt(t,e){if(!e.size)return;const{gl:i,stateCache:s}=t;let r=e.width,n=e.height;switch(e.type){case 1:{e.glTarget=3553;const o=Krt(r,n);if(o>t.capabilities.maxTextureSize&&j(9100,o,t.capabilities.maxTextureSize),e.glRenderbuffer)s.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(36161,e.glRenderbuffer),s.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(36161,e.glInternalFmt,r,n);else if(e.glTexture){const t=s.glTexUnits[s.texUnit];if(t.glTexture!==e.glTexture&&(i.bindTexture(3553,e.glTexture),t.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const s=Sp(e.format,r,n,1),o=new Uint8Array(s);i.compressedTexImage2D(3553,t,e.glInternalFmt,r,n,0,o),r=Krt(1,r>>1),n=Krt(1,n>>1)}else for(let t=0;t<e.mipLevel;++t)i.texImage2D(3553,t,e.glInternalFmt,r,n,0,e.glFormat,e.glType,null),r=Krt(1,r>>1),n=Krt(1,n>>1)}break}case 3:{e.glTarget=34067;const o=Krt(r,n);o>t.capabilities.maxCubeMapTextureSize&&j(9100,o,t.capabilities.maxTextureSize);const a=s.glTexUnits[s.texUnit];if(a.glTexture!==e.glTexture&&(i.bindTexture(34067,e.glTexture),a.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<6;++t){r=e.width,n=e.height;for(let s=0;s<e.mipLevel;++s){const o=Sp(e.format,r,n,1),a=new Uint8Array(o);i.compressedTexImage2D(34069+t,s,e.glInternalFmt,r,n,0,a),r=Krt(1,r>>1),n=Krt(1,n>>1)}}else for(let t=0;t<6;++t){r=e.width,n=e.height;for(let s=0;s<e.mipLevel;++s)i.texImage2D(34069+t,s,e.glInternalFmt,r,n,0,e.glFormat,e.glType,null),r=Krt(1,r>>1),n=Krt(1,n>>1)}break}default:j(16317),e.type=1,e.glTarget=3553}}function ynt(t,e){for(let t=0;t<e.gpuColorTextures.length;++t)if(e.gpuColorTextures[t].isSwapchainTexture)return void(e.isOffscreen=!1);const{gl:i,stateCache:s}=t,r=[],n=i.createFramebuffer();if(n){e.glFramebuffer=n,s.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(36160,e.glFramebuffer);for(let t=0;t<e.gpuColorTextures.length;++t){const s=e.gpuColorTextures[t];s&&(s.glTexture?i.framebufferTexture2D(36160,36064+t,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(36160,36064+t,36161,s.glRenderbuffer),r.push(36064+t),e.width=Zrt(e.width,s.width),e.height=Zrt(e.height,s.height))}const o=e.gpuDepthStencilTexture;if(o){const t=mp[o.format].hasStencil?33306:36096;o.glTexture?i.framebufferTexture2D(36160,t,o.glTarget,o.glTexture,0):i.framebufferRenderbuffer(36160,t,36161,o.glRenderbuffer),e.width=Zrt(e.width,o.width),e.height=Zrt(e.height,o.height)}t.extensions.WEBGL_draw_buffers&&t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);const a=i.checkFramebufferStatus(36160);if(36053!==a)switch(a){case 36054:j(16318);break;case 36055:j(16319);break;case 36057:j(16320);break;case 36061:j(16321)}s.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(36160,s.glFramebuffer)}}function vnt(t,e){const{gl:i,stateCache:s}=t;e.glFramebuffer&&(i.deleteFramebuffer(e.glFramebuffer),s.glFramebuffer===e.glFramebuffer&&(i.bindFramebuffer(36160,null),s.glFramebuffer=null),e.glFramebuffer=null)}function bnt(t,e){const{gl:i,stateCache:s}=t;for(let t=0;t<e.gpuStages.length;t++){const s=e.gpuStages[t];let r=0,n="",o=1;switch(s.type){case 1:n="VertexShader",r=35633;break;case 16:n="FragmentShader",r=35632;break;default:return void j(16322)}const a=i.createShader(r);if(a&&(s.glShader=a,i.shaderSource(s.glShader,s.source),i.compileShader(s.glShader),!i.getShaderParameter(s.glShader,35713))){j(16323,n,e.name),j(16324,s.source.replace(/^|\n/g,(()=>`\n${o++} `))),B(i.getShaderInfoLog(s.glShader));for(let s=0;s<e.gpuStages.length;s++){const s=e.gpuStages[t];s.glShader&&(i.deleteShader(s.glShader),s.glShader=null)}return}}const r=i.createProgram();if(!r)return;e.glProgram=r;for(let t=0;t<e.gpuStages.length;t++){const s=e.gpuStages[t];i.attachShader(e.glProgram,s.glShader)}if(i.linkProgram(e.glProgram),t.extensions.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const s=e.gpuStages[t];s.glShader&&(i.detachShader(e.glProgram,s.glShader),i.deleteShader(s.glShader),s.glShader=null)}if(!i.getProgramParameter(e.glProgram,35714))return j(16326,e.name),void B(i.getProgramInfoLog(e.glProgram));V(16325,e.name);const n=i.getProgramParameter(e.glProgram,35721);e.glInputs=new Array(n);for(let t=0;t<n;++t){const s=i.getActiveAttrib(e.glProgram,t);if(s){const{type:r,name:n,size:o}=s;let a;const h=n.indexOf("[");a=-1!==h?n.substr(0,h):n;const l=i.getAttribLocation(e.glProgram,a),c=rnt(r),u=nnt(r);e.glInputs[t]={binding:l,name:a,type:c,stride:u,count:o,size:u*o,glType:r,glLoc:l}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(let t=0;t<e.blocks.length;++t){const i=e.blocks[t],s={set:i.set,binding:i.binding,name:i.name,size:0,glUniforms:new Array(i.members.length),glActiveUniforms:[]};e.glBlocks[t]=s;for(let t=0;t<i.members.length;++t){const e=i.members[t],r=int(e.type),n=nnt(r),o=n*e.count;s.glUniforms[t]={binding:-1,name:e.name,type:e.type,stride:n,count:e.count,size:o,offset:0,glType:r,glLoc:null,array:null}}}}for(let t=0;t<e.subpassInputs.length;++t){const i=e.subpassInputs[t];e.samplerTextures.push(new zd(i.set,i.binding,i.name,28,i.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(let t=0;t<e.samplerTextures.length;++t){const i=e.samplerTextures[t];e.glSamplerTextures[t]={set:i.set,binding:i.binding,name:i.name,type:i.type,count:i.count,units:[],glUnits:null,glType:int(i.type),glLoc:null}}}const o=i.getProgramParameter(e.glProgram,35718);for(let s=0;s<o;++s){const r=i.getActiveUniform(e.glProgram,s);if(r&&35678!==r.type&&35680!==r.type){const s=i.getUniformLocation(e.glProgram,r.name);if(t.extensions.isLocationActive(s)){let t;const i=r.name.indexOf("[");t=-1!==i?r.name.substr(0,i):r.name;for(let i=0;i<e.glBlocks.length;i++){const n=e.glBlocks[i];for(let e=0;e<n.glUniforms.length;e++){const i=n.glUniforms[e];if(i.name===t){i.glLoc=s,i.count=r.size,i.size=i.stride*i.count,i.array=new(snt(i.type))(i.size/4),n.glActiveUniforms.push(i);break}}}}}}for(let t=0;t<e.glBlocks.length;t++){const i=e.glBlocks[t];for(let t=0;t<i.glUniforms.length;t++){const e=i.glUniforms[t];e.offset=i.size/4,i.size+=e.size}}const a=[],l=[],{bindingMappings:c,capabilities:u}=t,{texUnitCacheMap:d}=t.stateCache,{maxTextureUnits:p}=u;if(h.rendering&&h.rendering.enableEffectImport)for(let s=0;s<e.samplerTextures.length;++s){const r=e.samplerTextures[s],n=i.getUniformLocation(e.glProgram,r.name);t.extensions.isLocationActive(n)&&(a.push(e.glSamplerTextures[s]),l.push(n)),void 0===d[r.name]&&(d[r.name]=r.flattened%p)}else{let s=0;for(let t=0;t<e.blocks.length;++t)e.blocks[t].set===c.flexibleSet&&s++;let r=0;for(let n=0;n<e.samplerTextures.length;++n){const o=e.samplerTextures[n],h=i.getUniformLocation(e.glProgram,o.name);if(t.extensions.isLocationActive(h)&&(a.push(e.glSamplerTextures[n]),l.push(h)),void 0===d[o.name]){let t=o.binding+c.samplerTextureOffsets[o.set]+r;o.set===c.flexibleSet&&(t-=s),d[o.name]=t%p,r+=o.count-1}}}if(a.length){const r=[];for(let t=0;t<a.length;++t){const e=a[t];let i=d[e.name];if(void 0!==i){e.glLoc=l[t];for(let t=0;t<e.count;++t){for(;r[i];)i=(i+1)%p;e.units.push(i),r[i]=!0}}}let n=0;for(let e=0;e<a.length;++e){const i=a[e];if(!t.extensions.isLocationActive(i.glLoc)){i.glLoc=l[e];for(let t=0;t<i.count;++t){for(;r[n];)n=(n+1)%p;void 0===d[i.name]&&(d[i.name]=n),i.units.push(n),r[n]=!0}}}s.glProgram!==e.glProgram&&i.useProgram(e.glProgram);for(let t=0;t<a.length;t++){const e=a[t];e.glUnits=new Int32Array(e.units),i.uniform1iv(e.glLoc,e.glUnits)}s.glProgram!==e.glProgram&&i.useProgram(s.glProgram)}for(let t=0;t<e.glBlocks.length;)e.glBlocks[t].glActiveUniforms.length?t++:(e.glBlocks[t]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=a}function wnt(t,e){if(e.glProgram){const{gl:i,stateCache:s}=t;if(!t.extensions.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const s=e.gpuStages[t];s.glShader&&(i.detachShader(e.glProgram,s.glShader),i.deleteShader(s.glShader),s.glShader=null)}i.deleteProgram(e.glProgram),s.glProgram===e.glProgram&&(i.useProgram(null),s.glProgram=null),e.glProgram=null}}function Snt(t,e){e.glAttribs=new Array(e.attributes.length);const i=[0,0,0,0,0,0,0,0];for(let t=0;t<e.attributes.length;++t){const s=e.attributes[t],{format:r,isNormalized:n,isInstanced:o}=s,a=void 0!==s.stream?s.stream:0,h=e.gpuVertexBuffers[a],l=Jrt(r),{size:c}=mp[r];e.glAttribs[t]={name:s.name,glBuffer:h.glBuffer,glType:l,size:c,count:mp[r].count,stride:h.stride,componentCount:ont(l),isNormalized:void 0!==n&&n,isInstanced:void 0!==o&&o,offset:i[a]},i[a]+=c}}function xnt(t,e){const{stateCache:i}=t,s=e.glVAOs.values();let r=s.next();const n=t.extensions.OES_vertex_array_object;let o=i.glVAO;for(;!r.done;)n.deleteVertexArrayOES(r.value),o===r.value&&(n.bindVertexArrayOES(null),o=null),r=s.next();i.glVAO=o,e.glVAOs.clear()}const Tnt={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},Cnt=new _d;function Int(t,e,i,s,r,n,o){const{gl:a}=t,h=t.stateCache;let l=0;if(i){const t=i.lodLevel;Cnt.x=s.x<<t,Cnt.y=s.y<<t,Cnt.width=s.width<<t,Cnt.height=s.height<<t}if(i&&e){const s=i.glFramebuffer,{x:c,y:u,width:d,height:p}=Cnt;h.glFramebuffer!==s&&(a.bindFramebuffer(36160,s),h.glFramebuffer=s);const _=h.viewport;_.left===c&&_.top===u&&_.width===d&&_.height===p||(a.viewport(c,u,d,p),_.left=c,_.top=u,_.width=d,_.height=p);const g=h.scissorRect;g.x===c&&g.y===u&&g.width===d&&g.height===p||(a.scissor(c,u,d,p),g.x=c,g.y=u,g.width=d,g.height=p);let f=r.length;t.extensions.WEBGL_draw_buffers||(f=1);const m=h.dss;for(let t=0;t<f;++t){const i=e.colorAttachments[t];if(0!==i.format)switch(i.loadOp){case 0:break;case 1:{15!==h.bs.targets[0].blendColorMask&&a.colorMask(!0,!0,!0,!0);const t=r[0];a.clearColor(t.x,t.y,t.z,t.w),l|=16384;break}}}if(e.depthStencilAttachment&&0!==e.depthStencilAttachment.format){switch(e.depthStencilAttachment.depthLoadOp){case 0:break;case 1:m.depthWrite||a.depthMask(!0),a.clearDepth(n),l|=256}if(mp[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case 0:break;case 1:m.stencilWriteMaskFront||a.stencilMaskSeparate(1028,65535),m.stencilWriteMaskBack||a.stencilMaskSeparate(1029,65535),a.clearStencil(o),l|=1024}}if(l&&a.clear(l),16384&l){const t=h.bs.targets[0].blendColorMask;if(15!==t){const e=!!(1&t),i=!!(2&t),s=!!(4&t),r=!!(8&t);a.colorMask(e,i,s,r)}}256&l&&!m.depthWrite&&a.depthMask(!1),1024&l&&(m.stencilWriteMaskFront||a.stencilMaskSeparate(1028,0),m.stencilWriteMaskBack||a.stencilMaskSeparate(1029,0))}}function Ent(t,e,i,s,r,n){const{gl:o}=t,a=t.stateCache,h=a.dss,l=a.bs,c=e&&e.gpuShader;let u,d,p,_=!1;if(e&&Tnt.gpuPipelineState!==e){if(Tnt.gpuPipelineState=e,Tnt.glPrimitive=e.glPrimitive,e.gpuShader){const{glProgram:t}=e.gpuShader;a.glProgram!==t&&(o.useProgram(t),a.glProgram=t,_=!0)}const{rs:t}=e,i=a.rs;if(t){if(i.cullMode!==t.cullMode){switch(t.cullMode){case 0:o.disable(2884);break;case 1:o.enable(2884),o.cullFace(1028);break;case 2:o.enable(2884),o.cullFace(1029)}i.cullMode=t.cullMode}const e=t.isFrontFaceCCW;i.isFrontFaceCCW!==e&&(o.frontFace(e?2305:2304),i.isFrontFaceCCW=e),i.depthBias===t.depthBias&&i.depthBiasSlop===t.depthBiasSlop||(o.polygonOffset(t.depthBias,t.depthBiasSlop),i.depthBias=t.depthBias,i.depthBiasSlop=t.depthBiasSlop),i.lineWidth!==t.lineWidth&&(o.lineWidth(t.lineWidth),i.lineWidth=t.lineWidth)}const{dss:s}=e;s&&(h.depthTest!==s.depthTest&&(s.depthTest?o.enable(2929):o.disable(2929),h.depthTest=s.depthTest),h.depthWrite!==s.depthWrite&&(o.depthMask(s.depthWrite),h.depthWrite=s.depthWrite),h.depthFunc!==s.depthFunc&&(o.depthFunc(ant[s.depthFunc]),h.depthFunc=s.depthFunc),h.stencilTestFront===s.stencilTestFront&&h.stencilTestBack===s.stencilTestBack||(s.stencilTestFront||s.stencilTestBack?o.enable(2960):o.disable(2960),h.stencilTestFront=s.stencilTestFront,h.stencilTestBack=s.stencilTestBack),h.stencilFuncFront===s.stencilFuncFront&&h.stencilRefFront===s.stencilRefFront&&h.stencilReadMaskFront===s.stencilReadMaskFront||(o.stencilFuncSeparate(1028,ant[s.stencilFuncFront],s.stencilRefFront,s.stencilReadMaskFront),h.stencilFuncFront=s.stencilFuncFront,h.stencilRefFront=s.stencilRefFront,h.stencilReadMaskFront=s.stencilReadMaskFront),h.stencilFailOpFront===s.stencilFailOpFront&&h.stencilZFailOpFront===s.stencilZFailOpFront&&h.stencilPassOpFront===s.stencilPassOpFront||(o.stencilOpSeparate(1028,hnt[s.stencilFailOpFront],hnt[s.stencilZFailOpFront],hnt[s.stencilPassOpFront]),h.stencilFailOpFront=s.stencilFailOpFront,h.stencilZFailOpFront=s.stencilZFailOpFront,h.stencilPassOpFront=s.stencilPassOpFront),h.stencilWriteMaskFront!==s.stencilWriteMaskFront&&(o.stencilMaskSeparate(1028,s.stencilWriteMaskFront),h.stencilWriteMaskFront=s.stencilWriteMaskFront),h.stencilFuncBack===s.stencilFuncBack&&h.stencilRefBack===s.stencilRefBack&&h.stencilReadMaskBack===s.stencilReadMaskBack||(o.stencilFuncSeparate(1029,ant[s.stencilFuncBack],s.stencilRefBack,s.stencilReadMaskBack),h.stencilFuncBack=s.stencilFuncBack,h.stencilRefBack=s.stencilRefBack,h.stencilReadMaskBack=s.stencilReadMaskBack),h.stencilFailOpBack===s.stencilFailOpBack&&h.stencilZFailOpBack===s.stencilZFailOpBack&&h.stencilPassOpBack===s.stencilPassOpBack||(o.stencilOpSeparate(1029,hnt[s.stencilFailOpBack],hnt[s.stencilZFailOpBack],hnt[s.stencilPassOpBack]),h.stencilFailOpBack=s.stencilFailOpBack,h.stencilZFailOpBack=s.stencilZFailOpBack,h.stencilPassOpBack=s.stencilPassOpBack),h.stencilWriteMaskBack!==s.stencilWriteMaskBack&&(o.stencilMaskSeparate(1029,s.stencilWriteMaskBack),h.stencilWriteMaskBack=s.stencilWriteMaskBack));const{bs:r}=e;if(r){l.isA2C!==r.isA2C&&(r.isA2C?o.enable(32926):o.disable(32926),l.isA2C=r.isA2C),l.blendColor.x===r.blendColor.x&&l.blendColor.y===r.blendColor.y&&l.blendColor.z===r.blendColor.z&&l.blendColor.w===r.blendColor.w||(o.blendColor(r.blendColor.x,r.blendColor.y,r.blendColor.z,r.blendColor.w),l.blendColor.x=r.blendColor.x,l.blendColor.y=r.blendColor.y,l.blendColor.z=r.blendColor.z,l.blendColor.w=r.blendColor.w);const t=r.targets[0],e=l.targets[0];e.blend!==t.blend&&(t.blend?o.enable(3042):o.disable(3042),e.blend=t.blend),e.blendEq===t.blendEq&&e.blendAlphaEq===t.blendAlphaEq||(o.blendEquationSeparate(lnt[t.blendEq],lnt[t.blendAlphaEq]),e.blendEq=t.blendEq,e.blendAlphaEq=t.blendAlphaEq),e.blendSrc===t.blendSrc&&e.blendDst===t.blendDst&&e.blendSrcAlpha===t.blendSrcAlpha&&e.blendDstAlpha===t.blendDstAlpha||(o.blendFuncSeparate(cnt[t.blendSrc],cnt[t.blendDst],cnt[t.blendSrcAlpha],cnt[t.blendDstAlpha]),e.blendSrc=t.blendSrc,e.blendDst=t.blendDst,e.blendSrcAlpha=t.blendSrcAlpha,e.blendDstAlpha=t.blendDstAlpha),e.blendColorMask!==t.blendColorMask&&(o.colorMask(!!(1&t.blendColorMask),!!(2&t.blendColorMask),!!(4&t.blendColorMask),!!(8&t.blendColorMask)),e.blendColorMask=t.blendColorMask)}}if(e&&e.gpuPipelineLayout&&c){const i=c.glBlocks.length,{dynamicOffsetIndices:n}=e.gpuPipelineLayout;for(let t=0;t<i;t++){const e=c.glBlocks[t],i=s[e.set],a=i&&i.descriptorIndices[e.binding],h=a>=0&&i.gpuDescriptors[a];let l=null,u=0;if(h&&h.gpuBuffer){const{gpuBuffer:t}=h,i=n[e.set],s=i&&i[e.binding];s>=0&&(u=r[s]),"vf32"in t?l=t.vf32:(u+=t.offset,l=t.gpuBuffer.vf32),u>>=2}if(!l)continue;const d=e.glActiveUniforms.length;for(let t=0;t<d;t++){const i=e.glActiveUniforms[t];switch(i.glType){case 35670:case 5124:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniform1iv(i.glLoc,i.array);break}}break;case 35671:case 35667:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniform2iv(i.glLoc,i.array);break}}break;case 35672:case 35668:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniform3iv(i.glLoc,i.array);break}}break;case 35673:case 35669:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniform4iv(i.glLoc,i.array);break}}break;case 5126:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniform1fv(i.glLoc,i.array);break}}break;case 35664:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniform2fv(i.glLoc,i.array);break}}break;case 35665:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniform3fv(i.glLoc,i.array);break}}break;case 35666:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniform4fv(i.glLoc,i.array);break}}break;case 35674:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniformMatrix2fv(i.glLoc,!1,i.array);break}}break;case 35675:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniformMatrix3fv(i.glLoc,!1,i.array);break}}break;case 35676:for(let t=0;t<i.array.length;++t){const e=i.offset+u+t;if(l[e]!==i.array[t]){for(let s=t,r=e;s<i.array.length;++s,++r)i.array[s]=l[r];o.uniformMatrix4fv(i.glLoc,!1,i.array);break}}}}}const h=c.glSamplerTextures.length;for(let e=0;e<h;e++){const i=c.glSamplerTextures[e],r=s[i.set];let n=r&&r.descriptorIndices[i.binding],h=n>=0&&r.gpuDescriptors[n];const l=i.units.length;for(let e=0;e<l;e++){const s=i.units[e];if(h&&h.gpuSampler){if(h.gpuTexture&&h.gpuTexture.size>0){const{gpuTexture:e}=h,i=a.glTexUnits[s];i.glTexture!==e.glTexture&&(a.texUnit!==s&&(o.activeTexture(33984+s),a.texUnit=s),e.glTexture?o.bindTexture(e.glTarget,e.glTexture):o.bindTexture(e.glTarget,t.nullTex2D.gpuTexture.glTexture),i.glTexture=e.glTexture);const{gpuSampler:r}=h;e.isPowerOf2?(u=r.glWrapS,d=r.glWrapT):(u=33071,d=33071),p=e.isPowerOf2?e.mipLevel<=1&&(9985===r.glMinFilter||9987===r.glMinFilter)?9729:r.glMinFilter:9729===r.glMinFilter||9985===r.glMinFilter||9987===r.glMinFilter?9729:9728,e.glWrapS!==u&&(a.texUnit!==s&&(o.activeTexture(33984+s),a.texUnit=s),o.texParameteri(e.glTarget,10242,u),e.glWrapS=u),e.glWrapT!==d&&(a.texUnit!==s&&(o.activeTexture(33984+s),a.texUnit=s),o.texParameteri(e.glTarget,10243,d),e.glWrapT=d),e.glMinFilter!==p&&(a.texUnit!==s&&(o.activeTexture(33984+s),a.texUnit=s),o.texParameteri(e.glTarget,10241,p),e.glMinFilter=p),e.glMagFilter!==r.glMagFilter&&(a.texUnit!==s&&(o.activeTexture(33984+s),a.texUnit=s),o.texParameteri(e.glTarget,10240,r.glMagFilter),e.glMagFilter=r.glMagFilter)}h=r.gpuDescriptors[++n]}}}}if(i&&c&&(_||Tnt.gpuInputAssembler!==i)){Tnt.gpuInputAssembler=i;const e=t.extensions.ANGLE_instanced_arrays;if(t.extensions.useVAO){const s=t.extensions.OES_vertex_array_object;let r=i.glVAOs.get(c.glProgram);if(!r){let t;r=s.createVertexArrayOES(),i.glVAOs.set(c.glProgram,r),s.bindVertexArrayOES(r),o.bindBuffer(34962,null),o.bindBuffer(34963,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null;const n=c.glInputs.length;for(let s=0;s<n;s++){const r=c.glInputs[s];t=null;const n=i.glAttribs.length;for(let e=0;e<n;e++){const s=i.glAttribs[e];if(s.name===r.name){t=s;break}}if(t){a.glArrayBuffer!==t.glBuffer&&(o.bindBuffer(34962,t.glBuffer),a.glArrayBuffer=t.glBuffer);for(let i=0;i<t.componentCount;++i){const s=r.glLoc+i,n=t.offset+t.size*i;o.enableVertexAttribArray(s),a.glCurrentAttribLocs[s]=!0,o.vertexAttribPointer(s,t.count,t.glType,t.isNormalized,t.stride,n),e&&e.vertexAttribDivisorANGLE(s,t.isInstanced?1:0)}}}const h=i.gpuIndexBuffer;h&&o.bindBuffer(34963,h.glBuffer),s.bindVertexArrayOES(null),o.bindBuffer(34962,null),o.bindBuffer(34963,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null}a.glVAO!==r&&(s.bindVertexArrayOES(r),a.glVAO=r)}else{for(let e=0;e<t.capabilities.maxVertexAttributes;++e)a.glCurrentAttribLocs[e]=!1;const s=c.glInputs.length;for(let t=0;t<s;t++){const s=c.glInputs[t];let r=null;const n=i.glAttribs.length;for(let t=0;t<n;t++){const e=i.glAttribs[t];if(e.name===s.name){r=e;break}}if(r){a.glArrayBuffer!==r.glBuffer&&(o.bindBuffer(34962,r.glBuffer),a.glArrayBuffer=r.glBuffer);for(let t=0;t<r.componentCount;++t){const i=s.glLoc+t,n=r.offset+r.size*t;!a.glEnabledAttribLocs[i]&&i>=0&&(o.enableVertexAttribArray(i),a.glEnabledAttribLocs[i]=!0),a.glCurrentAttribLocs[i]=!0,o.vertexAttribPointer(i,r.count,r.glType,r.isNormalized,r.stride,n),e&&e.vertexAttribDivisorANGLE(i,r.isInstanced?1:0)}}}const r=i.gpuIndexBuffer;r&&a.glElementArrayBuffer!==r.glBuffer&&(o.bindBuffer(34963,r.glBuffer),a.glElementArrayBuffer=r.glBuffer);for(let e=0;e<t.capabilities.maxVertexAttributes;++e)a.glEnabledAttribLocs[e]!==a.glCurrentAttribLocs[e]&&(o.disableVertexAttribArray(e),a.glEnabledAttribLocs[e]=!1)}}if(e&&e.dynamicStates.length){const t=e.dynamicStates.length;for(let i=0;i<t;i++)switch(e.dynamicStates[i]){case 1:a.rs.lineWidth!==n.lineWidth&&(o.lineWidth(n.lineWidth),a.rs.lineWidth=n.lineWidth);break;case 2:a.rs.depthBias===n.depthBiasConstant&&a.rs.depthBiasSlop===n.depthBiasSlope||(o.polygonOffset(n.depthBiasConstant,n.depthBiasSlope),a.rs.depthBias=n.depthBiasConstant,a.rs.depthBiasSlop=n.depthBiasSlope);break;case 4:{const t=n.blendConstant;l.blendColor.x===t.x&&l.blendColor.y===t.y&&l.blendColor.z===t.z&&l.blendColor.w===t.w||(o.blendColor(t.x,t.y,t.z,t.w),l.blendColor.copy(t));break}case 16:{const t=n.stencilStatesFront,e=n.stencilStatesBack;h.stencilWriteMaskFront!==t.writeMask&&(o.stencilMaskSeparate(1028,t.writeMask),h.stencilWriteMaskFront=t.writeMask),h.stencilWriteMaskBack!==e.writeMask&&(o.stencilMaskSeparate(1029,e.writeMask),h.stencilWriteMaskBack=e.writeMask);break}case 32:{const t=n.stencilStatesFront,e=n.stencilStatesBack;h.stencilRefFront===t.reference&&h.stencilReadMaskFront===t.compareMask||(o.stencilFuncSeparate(1028,ant[h.stencilFuncFront],t.reference,t.compareMask),h.stencilRefFront=t.reference,h.stencilReadMaskFront=t.compareMask),h.stencilRefBack===e.reference&&h.stencilReadMaskBack===e.compareMask||(o.stencilFuncSeparate(1029,ant[h.stencilFuncBack],e.reference,e.compareMask),h.stencilRefBack=e.reference,h.stencilReadMaskBack=e.compareMask);break}}}}function Dnt(t,e){const{gl:i}=t,{ANGLE_instanced_arrays:s,WEBGL_multi_draw:r}=t.extensions,{gpuInputAssembler:n,glPrimitive:o}=Tnt;if(n){const t=n.gpuIndexBuffer;if(n.gpuIndirectBuffer){const e=n.gpuIndirectBuffer.indirects;if(e.drawByIndex){for(let i=0;i<e.drawCount;i++)e.byteOffsets[i]=e.offsets[i]*t.stride;if(r)e.instancedDraw?r.multiDrawElementsInstancedWEBGL(o,e.counts,0,n.glIndexType,e.byteOffsets,0,e.instances,0,e.drawCount):r.multiDrawElementsWEBGL(o,e.counts,0,n.glIndexType,e.byteOffsets,0,e.drawCount);else for(let t=0;t<e.drawCount;t++)e.instances[t]&&s?s.drawElementsInstancedANGLE(o,e.counts[t],n.glIndexType,e.byteOffsets[t],e.instances[t]):i.drawElements(o,e.counts[t],n.glIndexType,e.byteOffsets[t])}else if(r)e.instancedDraw?r.multiDrawArraysInstancedWEBGL(o,e.offsets,0,e.counts,0,e.instances,0,e.drawCount):r.multiDrawArraysWEBGL(o,e.offsets,0,e.counts,0,e.drawCount);else for(let t=0;t<e.drawCount;t++)e.instances[t]&&s?s.drawArraysInstancedANGLE(o,e.offsets[t],e.counts[t],e.instances[t]):i.drawArrays(o,e.offsets[t],e.counts[t])}else if(e.instanceCount&&s)if(t){if(e.indexCount>0){const i=e.firstIndex*t.stride;s.drawElementsInstancedANGLE(o,e.indexCount,n.glIndexType,i,e.instanceCount)}}else e.vertexCount>0&&s.drawArraysInstancedANGLE(o,e.firstVertex,e.vertexCount,e.instanceCount);else if(t){if(e.indexCount>0){const s=e.firstIndex*t.stride;i.drawElements(o,e.indexCount,n.glIndexType,s)}}else e.vertexCount>0&&i.drawArrays(o,e.firstVertex,e.vertexCount)}}function Ant(t,e,i,s){const{gl:r,stateCache:n}=t,o=n.glTexUnits[n.texUnit];o.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);let a=0,h=0;switch(i.glTarget){case 3553:for(let t=0;t<s.length;t++){const n=s[t];r.texSubImage2D(3553,n.texSubres.mipLevel,n.texOffset.x,n.texOffset.y,i.glFormat,i.glType,e[a++])}break;case 34067:for(let t=0;t<s.length;t++){const n=s[t],o=n.texSubres.baseArrayLayer+n.texSubres.layerCount;for(h=n.texSubres.baseArrayLayer;h<o;++h)r.texSubImage2D(34069+h,n.texSubres.mipLevel,n.texOffset.x,n.texOffset.y,i.glFormat,i.glType,e[a++])}break;default:j(16327)}1&i.flags&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}let Mnt=new Uint8Array(1);function Pnt(t,e,i,s,r){const n=Ep(e).height,o=Sp(e,r.width,r.height,r.depth),a=Sp(e,s.width,1,1),h=Sp(e,s.width,s.height,1),l=Sp(e,r.width,1,1),c=Ip(mp[e]);Mnt.byteLength<o&&(Mnt=new Uint8Array(o));let u=0,d=i;for(let e=0;e<r.depth;e++){d=i+h*e;for(let e=0;e<r.height;e+=n)Mnt.subarray(u,u+l).set(new Uint8Array(t.buffer,t.byteOffset+d,l)),u+=l,d+=a}const p=o/c.BYTES_PER_ELEMENT;return q(Number.isInteger(p),9101),new c(Mnt.buffer,0,p)}function Bnt(t,e,i,s){const{gl:r,stateCache:n}=t,o=n.glTexUnits[n.texUnit];o.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);let a=0,h=0;const l=mp[i.format],c=Ip(l),{isCompressed:u}=l,d=Ep(i.format),p=new gd,_=new pd,g=new gd;switch(i.glTarget){case 3553:for(let n=0;n<s.length;n++){const o=s[n],h=o.texSubres.mipLevel;_.x=0===o.texOffset.x?0:Dp(o.texOffset.x,d.width),_.y=0===o.texOffset.y?0:Dp(o.texOffset.y,d.height),p.width=o.texExtent.width<d.width?o.texExtent.width:Dp(o.texExtent.width,d.width),p.height=o.texExtent.height<d.height?o.texExtent.width:Dp(o.texExtent.height,d.height),g.width=o.buffStride>0?o.buffStride:p.width,g.height=o.buffTexHeight>0?o.buffTexHeight:p.height;const l=o.texExtent.width+_.x===i.width>>h?o.texExtent.width:p.width,f=o.texExtent.height+_.y===i.height>>h?o.texExtent.height:p.height;let m;const y=e[a++];if(g.width===p.width&&g.height===p.height){const t=Sp(i.format,l,f,1)/c.BYTES_PER_ELEMENT;q(Number.isInteger(t),9101),m=new c(y.buffer,y.byteOffset+o.buffOffset,t)}else m=Pnt(y,i.format,o.buffOffset,g,p);u?36196===i.glInternalFmt||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(3553,h,i.glInternalFmt,l,f,0,m):r.compressedTexSubImage2D(3553,h,_.x,_.y,l,f,i.glFormat,m):r.texSubImage2D(3553,h,_.x,_.y,l,f,i.glFormat,i.glType,m)}break;case 34067:for(let n=0;n<s.length;n++){const o=s[n],l=o.texSubres.mipLevel;_.x=0===o.texOffset.x?0:Dp(o.texOffset.x,d.width),_.y=0===o.texOffset.y?0:Dp(o.texOffset.y,d.height),p.width=o.texExtent.width<d.width?o.texExtent.width:Dp(o.texExtent.width,d.width),p.height=o.texExtent.height<d.height?o.texExtent.width:Dp(o.texExtent.height,d.height),g.width=o.buffStride>0?o.buffStride:p.width,g.height=o.buffTexHeight>0?o.buffTexHeight:p.height;const f=o.texExtent.width+_.x===i.width>>l?o.texExtent.width:p.width,m=o.texExtent.height+_.y===i.height>>l?o.texExtent.height:p.height,y=o.texSubres.baseArrayLayer+o.texSubres.layerCount;for(h=o.texSubres.baseArrayLayer;h<y;++h){let s;const n=e[a++];if(g.width===p.width&&g.height===p.height){const t=Sp(i.format,f,m,1)/c.BYTES_PER_ELEMENT;q(Number.isInteger(t),9101),s=new c(n.buffer,n.byteOffset+o.buffOffset,t)}else s=Pnt(n,i.format,o.buffOffset,g,p);u?36196===i.glInternalFmt||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(34069+h,l,i.glInternalFmt,f,m,0,s):r.compressedTexSubImage2D(34069+h,l,_.x,_.y,f,m,i.glFormat,s):r.texSubImage2D(34069+h,l,_.x,_.y,f,m,i.glFormat,i.glType,s)}}break;default:j(16327)}1&i.flags&&r.generateMipmap(i.glTarget)}function Rnt(t,e,i,s){const{gl:r}=t,n=t.stateCache,o=r.createFramebuffer();r.bindFramebuffer(36160,o);let a=0,h=0,l=1,c=1;if(3553===e.glTarget)for(let t=0;t<s.length;t++){const n=s[t];r.framebufferTexture2D(36160,36064,e.glTarget,e.glTexture,n.texSubres.mipLevel),a=n.texOffset.x,h=n.texOffset.y,l=n.texExtent.width,c=n.texExtent.height,r.readPixels(a,h,l,c,e.glFormat,e.glType,i[t])}else j(16399);r.bindFramebuffer(36160,null),n.glFramebuffer=null,r.deleteFramebuffer(o)}function Ont(t,e,i,s,r){t.blitManager.draw(e,i,s,r)}class Lnt{static get instance(){return Lnt._instance}static setInstance(t){Lnt._instance=t}}function Fnt(t){return new Int32Array(t)}Lnt._instance=null;class znt{constructor(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this._capacity=4,this.counts=Fnt(this._capacity),this.offsets=Fnt(this._capacity),this.instances=Fnt(this._capacity),this.byteOffsets=Fnt(this._capacity)}clearDraws(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1}setDrawInfo(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)}_ensureCapacity(t){if(this._capacity>t)return;this._capacity=y(t);const e=Fnt(this._capacity),i=Fnt(this._capacity),s=Fnt(this._capacity);this.byteOffsets=Fnt(this._capacity),e.set(this.counts),i.set(this.offsets),s.set(this.instances),this.counts=e,this.offsets=i,this.instances=s}}class knt{constructor(){this._gpuShader=null,this._gpuDescriptorSetLayout=null,this._gpuPipelineLayout=null,this._gpuPipelineState=null,this._gpuVertexBuffer=null,this._gpuInputAssembler=null,this._gpuPointSampler=null,this._gpuLinearSampler=null,this._gpuDescriptorSet=null,this._gpuUniformBuffer=null,this._drawInfo=null,this._glFramebuffer=null,this._uniformBuffer=null;const t=Lnt.instance.bindingMappingInfo.maxBlockCounts[0];this._gpuShader={name:"Blit Pass",blocks:[new Fd(0,0,"BlitParams",[new Ld("tilingOffsetSrc",16,1),new Ld("tilingOffsetDst",16,1)],1)],samplerTextures:[new zd(0,t,"textureSrc",28,1)],subpassInputs:[],gpuStages:[{type:1,source:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nuniform vec4 tilingOffsetSrc;\nuniform vec4 tilingOffsetDst;\nvarying vec2 v_texCoord;\nvoid main() {\n    v_texCoord = a_texCoord * tilingOffsetSrc.xy + tilingOffsetSrc.zw;\n    gl_Position = vec4((a_position + 1.0) * tilingOffsetDst.xy - 1.0 + tilingOffsetDst.zw * 2.0, 0, 1);\n}",glShader:null},{type:16,source:"\nprecision mediump float;\nuniform sampler2D textureSrc;\nvarying vec2 v_texCoord;\nvoid main() {\n    gl_FragColor = texture2D(textureSrc, v_texCoord);\n}",glShader:null}],glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]},bnt(Lnt.instance,this._gpuShader),this._gpuDescriptorSetLayout={bindings:[new sp(0,1,1,1),new sp(t,16,1,16)],dynamicBindings:[],descriptorIndices:[],descriptorCount:t+1};for(let e=0;e<t;e++)this._gpuDescriptorSetLayout.descriptorIndices[e]=0;this._gpuDescriptorSetLayout.descriptorIndices.push(1),this._gpuPipelineLayout={gpuSetLayouts:[this._gpuDescriptorSetLayout],dynamicOffsetCount:0,dynamicOffsetOffsets:[0],dynamicOffsetIndices:[[]]},this._gpuPipelineState={glPrimitive:5,gpuShader:this._gpuShader,gpuPipelineLayout:this._gpuPipelineLayout,rs:null,dss:new Up(!1,!1),bs:null,dynamicStates:[],gpuRenderPass:null},this._gpuVertexBuffer={usage:8,memUsage:1,size:64,stride:16,buffer:null,vf32:null,indirects:new znt,glTarget:0,glBuffer:null},unt(Lnt.instance,this._gpuVertexBuffer),Lnt.instance.memoryStatus.bufferSize+=this._gpuVertexBuffer.size;const e=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]);_nt(Lnt.instance,this._gpuVertexBuffer,e,0,e.length),this._gpuInputAssembler={attributes:[new Wd("a_position",21),new Wd("a_texCoord",21)],gpuVertexBuffers:[this._gpuVertexBuffer],gpuIndexBuffer:null,gpuIndirectBuffer:null,glAttribs:[],glIndexType:0,glVAOs:new Map},Snt(Lnt.instance,this._gpuInputAssembler),this._gpuPointSampler={glMinFilter:9728,glMagFilter:9728,glWrapS:10497,glWrapT:10497,glWrapR:10497},this._gpuLinearSampler={glMinFilter:9729,glMagFilter:9729,glWrapS:10497,glWrapT:10497,glWrapR:10497},this._uniformBuffer=new Float32Array(8),this._gpuUniformBuffer={usage:16,memUsage:1,size:32,stride:32,buffer:this._uniformBuffer,vf32:null,indirects:new znt,glTarget:0,glBuffer:null},unt(Lnt.instance,this._gpuUniformBuffer),Lnt.instance.memoryStatus.bufferSize+=this._gpuUniformBuffer.size,this._gpuDescriptorSet={gpuDescriptors:[{type:1,gpuBuffer:this._gpuUniformBuffer,gpuTexture:null,gpuSampler:null},{type:16,gpuBuffer:null,gpuTexture:null,gpuSampler:null}],descriptorIndices:this._gpuDescriptorSetLayout.descriptorIndices},this._drawInfo=new Ad(4,0,0,0,0,0,0),this._glFramebuffer=Lnt.instance.gl.createFramebuffer()}destroy(){this._glFramebuffer&&(Lnt.instance.gl.deleteFramebuffer(this._glFramebuffer),this._glFramebuffer=null),this._gpuVertexBuffer&&(Lnt.instance.memoryStatus.bufferSize-=this._gpuVertexBuffer.size,dnt(Lnt.instance,this._gpuVertexBuffer)),this._gpuUniformBuffer&&(Lnt.instance.memoryStatus.bufferSize-=this._gpuUniformBuffer.size,dnt(Lnt.instance,this._gpuUniformBuffer)),this._gpuShader&&wnt(Lnt.instance,this._gpuShader),this._gpuInputAssembler&&xnt(Lnt.instance,this._gpuInputAssembler)}draw(t,e,i,s){const r=Lnt.instance,{gl:n}=r,o=r.stateCache,a=o.glFramebuffer;if(n.viewport(0,0,e.width,e.height),n.scissor(0,0,e.width,e.height),!(this._uniformBuffer&&this._gpuUniformBuffer&&this._gpuPipelineState&&this._gpuInputAssembler&&this._gpuDescriptorSet&&this._drawInfo))return;const h=this._gpuDescriptorSet.gpuDescriptors[1];h.gpuTexture=t,h.gpuSampler=1===s?this._gpuPointSampler:this._gpuLinearSampler;const l=mp[e.format];let c=36064;l.hasStencil?c=33306:l.hasDepth&&(c=36096);const u=i.map(((t,e)=>e));u.sort(((t,e)=>i[t].srcSubres.mipLevel-i[e].srcSubres.mipLevel)),o.glFramebuffer!==this._glFramebuffer&&(n.bindFramebuffer(36160,this._glFramebuffer),o.glFramebuffer=this._glFramebuffer);let d=i[0].dstSubres.mipLevel;e.glTexture?n.framebufferTexture2D(36160,c,e.glTarget,e.glTexture,d):n.framebufferRenderbuffer(36160,c,36161,e.glRenderbuffer);for(let s=0;s<u.length;++s){const o=i[u[s]];t.glTexture&&d!==o.srcSubres.mipLevel&&(d=o.srcSubres.mipLevel,n.framebufferTexture2D(36160,c,e.glTarget,e.glTexture,d));const a=t.width,h=t.height,l=e.width,p=e.height;this._uniformBuffer[0]=o.srcExtent.width/a,this._uniformBuffer[1]=o.srcExtent.height/h,this._uniformBuffer[2]=o.srcOffset.x/a,this._uniformBuffer[3]=o.srcOffset.y/h,this._uniformBuffer[4]=o.dstExtent.width/l,this._uniformBuffer[5]=o.dstExtent.height/p,this._uniformBuffer[6]=o.dstOffset.x/l,this._uniformBuffer[7]=o.dstOffset.y/p,_nt(r,this._gpuUniformBuffer,this._uniformBuffer,0,4*this._uniformBuffer.length),Ent(r,this._gpuPipelineState,this._gpuInputAssembler,[this._gpuDescriptorSet],[],null),Dnt(r,this._drawInfo)}o.glFramebuffer!==a&&(n.bindFramebuffer(36160,a),o.glFramebuffer=a);const p=o.viewport;n.viewport(p.left,p.top,p.width,p.height);const _=o.scissorRect;n.scissor(_.x,_.y,_.width,_.height)}}class Nnt extends Mp{get gpuBuffer(){return this._gpuBuffer}get gpuBufferView(){return this._gpuBufferView}constructor(){super(),this._gpuBuffer=null,this._gpuBufferView=null,this._uniformBuffer=null}initialize(t){if("buffer"in t){this._isBufferView=!0;const e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,16&this._usage&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new znt,glTarget:0,glBuffer:null},16&this._usage&&(this._gpuBuffer.buffer=this._uniformBuffer),unt(Lnt.instance,this._gpuBuffer),Lnt.instance.memoryStatus.bufferSize+=this._size}destroy(){this._gpuBuffer&&(dnt(Lnt.instance,this._gpuBuffer),Lnt.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)}resize(t){if(this._isBufferView)return void G(16379);const e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(pnt(Lnt.instance,this._gpuBuffer),Lnt.instance.memoryStatus.bufferSize-=e,Lnt.instance.memoryStatus.bufferSize+=t)))}update(t,e){if(this._isBufferView)return void G(16380);let i;i=void 0!==e?e:64&this._usage?0:t.byteLength,_nt(Lnt.instance,this._gpuBuffer,t,0,i)}}class Unt extends Pp{constructor(){super(),this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets=[],this._curDynamicOffsets=Array(8).fill(0),this._curDynamicStates=new _p,this._isStateInvalied=!1}initialize(t){this._type=t.type,this._queue=t.queue;const e=Lnt.instance.bindingMappings.blockOffsets.length;for(let t=0;t<e;t++)this._curGPUDescriptorSets.push(null)}destroy(){}begin(t,e,i){this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(t,e,i,s,r,n){j(16401),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(t){const e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)}bindDescriptorSet(t,e,i){const s=e.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=s,this._isStateInvalied=!0),i){var r;const e=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(e){const s=this._curDynamicOffsets,r=e.dynamicOffsetOffsets[t];for(let t=0;t<i.length;t++)s[r+t]=i[t];this._isStateInvalied=!0}}}bindInputAssembler(t){const e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0}setViewport(t){const e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)}setScissor(t){const e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)}setLineWidth(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)}setDepthBias(t,e,i){const s=this._curDynamicStates;s.depthBiasConstant===t&&s.depthBiasClamp===e&&s.depthBiasSlope===i||(s.depthBiasConstant=t,s.depthBiasClamp=e,s.depthBiasSlope=i,this._isStateInvalied=!0)}setBlendConstants(t){const e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)}setDepthBound(t,e){const i=this._curDynamicStates;i.depthMinBounds===t&&i.depthMaxBounds===e||(i.depthMinBounds=t,i.depthMaxBounds=e,this._isStateInvalied=!0)}setStencilWriteMask(t,e){const i=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;1&t&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0),2&t&&s.writeMask!==e&&(s.writeMask=e,this._isStateInvalied=!0)}setStencilCompareMask(t,e,i){const s=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;1&t&&(s.compareMask===i&&s.reference===e||(s.reference=e,s.compareMask=i,this._isStateInvalied=!0)),2&t&&(r.compareMask===i&&r.reference===e||(r.reference=e,r.compareMask=i,this._isStateInvalied=!0))}draw(t){j(16328)}updateBuffer(t,e,i){j(16329)}copyBuffersToTexture(t,e,i){j(16330)}execute(t,e){j(16402)}pipelineBarrier(t,e,i,s,r){}bindStates(){j(16401)}blitTexture(t,e,i,s){j(16401)}}class Vnt extends Op{get gpuFramebuffer(){return this._gpuFramebuffer}constructor(){super(),this._gpuFramebuffer=null,this._gpuColorTextures=[],this._gpuDepthStencilTexture=void 0}get needRebuild(){if(this.gpuFramebuffer){var t;for(let t=0;t<this.gpuFramebuffer.gpuColorTextures.length;t++)if(this.gpuFramebuffer.gpuColorTextures[t].glTexture!==this._gpuColorTextures[t])return!0;if((null===(t=this.gpuFramebuffer.gpuDepthStencilTexture)||void 0===t?void 0:t.glTexture)!==this._gpuDepthStencilTexture)return!0}return!1}initialize(t){var e;this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[];const i=this._depthStencilTexture=t.depthStencilTexture||null;let s=0;const r=[];for(let e=0;e<t.colorTextures.length;++e){const i=t.colorTextures[e];i&&(r.push(i.gpuTexture),s=i.lodLevel)}let n=null;i&&(n=i.gpuTexture,s=i.lodLevel);let o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:r,gpuDepthStencilTexture:n,glFramebuffer:null,isOffscreen:!0,get width(){return this.gpuColorTextures.length>0?this.gpuColorTextures[0].width:this.gpuDepthStencilTexture?this.gpuDepthStencilTexture.width:o},set width(t){o=t},get height(){return this.gpuColorTextures.length>0?this.gpuColorTextures[0].height:this.gpuDepthStencilTexture?this.gpuDepthStencilTexture.height:a},set height(t){a=t},lodLevel:s},ynt(Lnt.instance,this._gpuFramebuffer),this.gpuFramebuffer.gpuColorTextures.forEach((t=>this._gpuColorTextures.push(t.glTexture))),this._gpuDepthStencilTexture=null===(e=this.gpuFramebuffer.gpuDepthStencilTexture)||void 0===e?void 0:e.glTexture,this._width=this._gpuFramebuffer.width,this._height=this._gpuFramebuffer.height}destroy(){this._gpuFramebuffer&&(vnt(Lnt.instance,this._gpuFramebuffer),this._gpuFramebuffer=null,this._gpuColorTextures.length=0,this._gpuDepthStencilTexture=null)}}class Hnt extends Lp{get gpuInputAssembler(){return this._gpuInputAssembler}constructor(){super(),this._gpuInputAssembler=null}initialize(t){if(0===t.vertexBuffers.length)return void j(16331);if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{const t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;const e=new Array(t.vertexBuffers.length);for(let i=0;i<t.vertexBuffers.length;++i){const s=t.vertexBuffers[i];s.gpuBuffer&&(e[i]=s.gpuBuffer)}let i=null,s=0;if(t.indexBuffer&&(i=t.indexBuffer.gpuBuffer,i))switch(i.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:j(16332)}let r=null;t.indirectBuffer&&(r=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:e,gpuIndexBuffer:i,gpuIndirectBuffer:r,glAttribs:[],glIndexType:s,glVAOs:new Map},Snt(Lnt.instance,this._gpuInputAssembler)}destroy(){const t=Lnt.instance;this._gpuInputAssembler&&t.extensions.useVAO&&xnt(t,this._gpuInputAssembler),this._gpuInputAssembler=null}}class Gnt extends zp{get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}constructor(){super(),this._gpuDescriptorSetLayout=null}initialize(t){Array.prototype.push.apply(this._bindings,t.bindings);let e=0,i=-1;const s=[];for(let t=0;t<this._bindings.length;t++){const r=this._bindings[t];s.push(e),e+=r.count,r.binding>i&&(i=r.binding)}this._bindingIndices=Array(i+1).fill(-1);const r=this._descriptorIndices=Array(i+1).fill(-1);for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];this._bindingIndices[e.binding]=t,r[e.binding]=s[t]}const n=[];for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];if(10&e.descriptorType)for(let t=0;t<e.count;t++)n.push(e.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:n,descriptorIndices:r,descriptorCount:e}}destroy(){this._bindings.length=0}}class Wnt extends kp{get gpuPipelineLayout(){return this._gpuPipelineLayout}constructor(){super(),this._gpuPipelineLayout=null}initialize(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);const e=[],i=[];let s=0;const r=[];for(let t=0;t<this._setLayouts.length;t++){const n=this._setLayouts[t],o=n.gpuDescriptorSetLayout.dynamicBindings,a=Array(n.bindingIndices.length).fill(-1);for(let t=0;t<o.length;t++){const e=o[t];a[e]<0&&(a[e]=s+t)}i.push(n.gpuDescriptorSetLayout),e.push(a),r.push(s),s+=o.length}this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:e,dynamicOffsetCount:s,dynamicOffsetOffsets:r}}destroy(){this._setLayouts.length=0}}const jnt=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class $nt extends Wp{get gpuPipelineState(){return this._gpuPipelineState}constructor(){super(),this._gpuPipelineState=null}initialize(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;const e=this._bs;if(t.blendState){const i=t.blendState,{targets:s}=i;s&&s.forEach(((t,i)=>{e.setTarget(i,t)})),void 0!==i.isA2C&&(e.isA2C=i.isA2C),void 0!==i.isIndepend&&(e.isIndepend=i.isIndepend),void 0!==i.blendColor&&(e.blendColor=i.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;const i=[];for(let t=0;t<31;t++)this._dynamicStates&1<<t&&i.push(1<<t);this._gpuPipelineState={glPrimitive:jnt[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:i}}destroy(){this._gpuPipelineState=null}}class qnt extends Unt{beginRenderPass(t,e,i,s,r,n){Int(Lnt.instance,t.gpuRenderPass,e.gpuFramebuffer,i,s,r,n),this._isInRenderPass=!0}draw(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();const e="drawInfo"in t?t.drawInfo:t;Dnt(Lnt.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;const i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else j(16328)}setViewport(t){const{stateCache:e,gl:i}=Lnt.instance;e.viewport.left===t.left&&e.viewport.top===t.top&&e.viewport.width===t.width&&e.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),e.viewport.left=t.left,e.viewport.top=t.top,e.viewport.width=t.width,e.viewport.height=t.height)}setScissor(t){const{stateCache:e,gl:i}=Lnt.instance;e.scissorRect.x===t.x&&e.scissorRect.y===t.y&&e.scissorRect.width===t.width&&e.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),e.scissorRect.x=t.x,e.scissorRect.y=t.y,e.scissorRect.width=t.width,e.scissorRect.height=t.height)}updateBuffer(t,e,i){if(this._isInRenderPass)j(16329);else{const s=t.gpuBuffer;if(s){let r;r=void 0!==i?i:64&t.usage?0:e.byteLength,_nt(Lnt.instance,s,e,0,r)}}}copyBuffersToTexture(t,e,i){if(this._isInRenderPass)j(16330);else{const s=e.gpuTexture;s&&Bnt(Lnt.instance,t,s,i)}}execute(t,e){j(16402)}bindStates(){Ent(Lnt.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}blitTexture(t,e,i,s){const r=t.gpuTexture,n=e.gpuTexture;Ont(Lnt.instance,r,n,i,s)}}class Xnt extends jp{constructor(){super(),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(t){this._type=t.type}destroy(){}submit(t){const e=t.length;for(let i=0;i<e;i++){const e=t[i];this.numDrawCalls+=e.numDrawCalls,this.numInstances+=e.numInstances,this.numTris+=e.numTris}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class Ynt extends $p{get gpuRenderPass(){return this._gpuRenderPass}constructor(){super(),this._gpuRenderPass=null}initialize(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()}destroy(){this._gpuRenderPass=null}}const Qnt=[10497,33648,33071,33071];class Knt extends qp{get gpuSampler(){return this._gpuSampler}constructor(t,e){super(t,e),this._gpuSampler=null;let i=0,s=0;const r=this._info.minFilter,n=this._info.magFilter,o=this._info.mipFilter;i=2===r||3===r?2===o||3===o?9987:1===o?9985:9729:2===o||3===o?9986:1===o?9984:9728,s=2===n||3===n?9729:9728;const a=Qnt[this._info.addressU],h=Qnt[this._info.addressV],l=Qnt[this._info.addressW];this._gpuSampler={glMinFilter:i,glMagFilter:s,glWrapS:a,glWrapT:h,glWrapR:l}}}class Znt extends Xp{get gpuShader(){return null===this._gpuShader.glProgram&&bnt(Lnt.instance,this._gpuShader),this._gpuShader}constructor(){super(),this._gpuShader=null}initialize(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(let e=0;e<t.stages.length;++e){const i=t.stages[e];this._gpuShader.gpuStages[e]={type:i.stage,source:i.source,glShader:null}}}destroy(){this._gpuShader&&(wnt(Lnt.instance,this._gpuShader),this._gpuShader=null)}}class Jnt{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new wd,this.scissorRect=new _d(0,0,0,0),this.rs=new Np,this.dss=new Up,this.bs=new Hp,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(t,e){for(let e=0;e<t;++e)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)}}class tot extends Yp{get gpuTexture(){return this._gpuTexture}get lodLevel(){return this._lodLevel}constructor(){super(),this._gpuTexture=null,this._lodLevel=0}initialize(t,e){let i=t;const s=t;"texture"in t&&(i=s.texture.info,this._isTextureView=!0),this._info.copy(i),this._isPowerOf2=bp(this._info.width)&&bp(this._info.height),this._size=xp(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(s),this._lodLevel=s.baseLevel,this._gpuTexture=s.texture._gpuTexture):(this._gpuTexture={type:i.type,format:i.format,usage:i.usage,width:i.width,height:i.height,depth:i.depth,size:this._size,arrayLayer:i.layerCount,mipLevel:i.levelCount,samples:i.samples,flags:i.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},this._gpuTexture.isSwapchainTexture||(gnt(Lnt.instance,this._gpuTexture),Lnt.instance.memoryStatus.textureSize+=this._size),this._viewInfo.texture=this,this._viewInfo.type=t.type,this._viewInfo.format=t.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=t.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=t.layerCount)}destroy(){!this._isTextureView&&this._gpuTexture&&(fnt(Lnt.instance,this._gpuTexture),Lnt.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}getTextureHandle(){const t=this._gpuTexture;return t?t.glTexture?t.glTexture:t.glRenderbuffer?t.glRenderbuffer:0:0}resize(t,e){if(this._info.width===t&&this._info.height===e)return;this._info.levelCount===tot.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=tot.getLevelCount(t,e):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,tot.getLevelCount(t,e)));const i=this._size;this._info.width=t,this._info.height=e,this._size=xp(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,this._gpuTexture.isSwapchainTexture||(mnt(Lnt.instance,this._gpuTexture),Lnt.instance.memoryStatus.textureSize-=i,Lnt.instance.memoryStatus.textureSize+=this._size))}initAsSwapchainTexture(t){const e=new Bd;e.format=t.format,e.usage=mp[t.format].hasDepth?32:16,e.width=t.width,e.height=t.height,this.initialize(e,!0)}}const eot="webglcontextlost";function iot(t){t.activeTexture(33984),t.pixelStorei(3333,1),t.pixelStorei(3317,1),t.pixelStorei(37440,!1),t.bindFramebuffer(36160,null),t.enable(3089),t.enable(2884),t.cullFace(1029),t.frontFace(2305),t.disable(32823),t.polygonOffset(0,0),t.enable(2929),t.depthMask(!0),t.depthFunc(513),t.depthRange(0,1),t.stencilFuncSeparate(1028,519,1,65535),t.stencilOpSeparate(1028,7680,7680,7680),t.stencilMaskSeparate(1028,65535),t.stencilFuncSeparate(1029,519,1,65535),t.stencilOpSeparate(1029,7680,7680,7680),t.stencilMaskSeparate(1029,65535),t.disable(2960),t.disable(32926),t.disable(3042),t.blendEquationSeparate(32774,32774),t.blendFuncSeparate(1,0,1,0),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}function sot(t,e){const i=["","WEBKIT_","MOZ_"];for(let s=0;s<i.length;++s){const r=t.getExtension(i[s]+e);if(r)return r}return null}function rot(t){const e={EXT_texture_filter_anisotropic:sot(t,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:sot(t,"EXT_blend_minmax"),EXT_frag_depth:sot(t,"EXT_frag_depth"),EXT_shader_texture_lod:sot(t,"EXT_shader_texture_lod"),EXT_sRGB:sot(t,"EXT_sRGB"),OES_vertex_array_object:sot(t,"OES_vertex_array_object"),EXT_color_buffer_half_float:sot(t,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:sot(t,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:sot(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:sot(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:sot(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:sot(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:sot(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:sot(t,"WEBGL_debug_shaders"),WEBGL_draw_buffers:sot(t,"WEBGL_draw_buffers"),WEBGL_lose_context:sot(t,"WEBGL_lose_context"),WEBGL_depth_texture:sot(t,"WEBGL_depth_texture"),OES_texture_half_float:sot(t,"OES_texture_half_float"),OES_texture_half_float_linear:sot(t,"OES_texture_half_float_linear"),OES_texture_float:sot(t,"OES_texture_float"),OES_texture_float_linear:sot(t,"OES_texture_float_linear"),OES_standard_derivatives:sot(t,"OES_standard_derivatives"),OES_element_index_uint:sot(t,"OES_element_index_uint"),ANGLE_instanced_arrays:sot(t,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:sot(t,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:t=>!!t,useVAO:!1};return zn.os===On.IOS&&14===zn.osMainVersion&&zn.isBrowser||(e.WEBGL_compressed_texture_astc=sot(t,"WEBGL_compressed_texture_astc")),zn.os!==On.ANDROID&&zn.os!==On.IOS&&(e.WEBGL_multi_draw=sot(t,"WEBGL_multi_draw")),zn.browserType===Pn.UC&&(e.ANGLE_instanced_arrays=null),zn.os===On.IOS&&zn.osMainVersion<=10&&(e.destroyShadersImmediately=!1),e.OES_vertex_array_object&&(e.useVAO=!0),e}function not(t){let e=null;try{const i={alpha:le.ENABLE_TRANSPARENT_CANVAS,antialias:le.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl",i)}catch(t){return null}return e}class oot extends Rp{get extensions(){return this._extensions}get blitManager(){return this._blitManager}constructor(){super(),this.stateCache=new Jnt,this.nullTex2D=null,this.nullTexCube=null,this._canvas=null,this._webGLContextLostHandler=null,this._extensions=null,this._blitManager=null}initialize(t){this._canvas=t.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(eot,this._webGLContextLostHandler);const{instance:e}=Lnt,{gl:i,capabilities:s}=e;this.stateCache.initialize(s.maxTextureUnits,s.maxVertexAttributes),this._extensions=rot(i),iot(i);let r=55,n=i.getParameter(3414);const o=i.getParameter(3415);n&&o?r=55:n&&(r=54),this._colorTexture=new tot,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:35,width:t.width,height:t.height}),this._depthStencilTexture=new tot,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:r,width:t.width,height:t.height}),this.nullTex2D=e.createTexture(new Bd(1,4,35,2,2,1)),this.nullTexCube=e.createTexture(new Bd(3,4,35,2,2,1,6));const a=new bd;a.texExtent.width=2,a.texExtent.height=2;const h=new Uint8Array(this.nullTex2D.size);h.fill(0),e.copyBuffersToTexture([h],this.nullTex2D,[a]),a.texSubres.layerCount=6,e.copyBuffersToTexture([h,h,h,h,h,h],this.nullTexCube,[a]),this._blitManager=new knt}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(eot,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._blitManager&&(this._blitManager.destroy(),this._blitManager=null),this._extensions=null,this._canvas=null}resize(t,e,i){this._colorTexture.width===t&&this._colorTexture.height===e||(O(`Resizing swapchain: ${t}x${e}`),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))}_onWebGLContextLost(t){G(11e3),P(t)}}class aot extends Bp{constructor(){super(),this._swapchain=null,this._context=null,this._bindingMappings=null,this._textureExclusive=new Array(117)}get gl(){return this._context}get extensions(){return this._swapchain.extensions}get stateCache(){return this._swapchain.stateCache}get nullTex2D(){return this._swapchain.nullTex2D}get nullTexCube(){return this._swapchain.nullTexCube}get textureExclusive(){return this._textureExclusive}get bindingMappings(){return this._bindingMappings}get blitManager(){return this._swapchain.blitManager}initialize(t){Lnt.setInstance(this),this._gfxAPI=6;const e=this._bindingMappingInfo=t.bindingMappingInfo,i=[],s=[],r=e.setIndices[0];i[r]=0,s[r]=0;for(let t=1;t<e.setIndices.length;++t){const r=e.setIndices[t],n=e.setIndices[t-1];i[r]=e.maxBlockCounts[n]+i[n],s[r]=e.maxSamplerTextureCounts[n]+s[n]}for(let t=0;t<e.setIndices.length;++t){const i=e.setIndices[t];s[i]-=e.maxBlockCounts[i]}this._bindingMappings={blockOffsets:i,samplerTextureOffsets:s,flexibleSet:e.setIndices[e.setIndices.length-1]};const n=this._context=not(Bp.canvas);if(!n)return j(16333),!1;this._queue=this.createQueue(new lp(0)),this._cmdBuff=this.createCommandBuffer(new hp(this._queue));const o=n.getParameter.bind(n);this._caps.maxVertexAttributes=o(34921),this._caps.maxVertexUniformVectors=o(36347),this._caps.maxFragmentUniformVectors=o(36349),this._caps.maxTextureUnits=o(34930),this._caps.maxVertexTextureUnits=o(35660),this._caps.maxTextureSize=o(3379),this._caps.maxCubeMapTextureSize=o(34076),this._caps.maxArrayTextureLayers=0,this._caps.max3DTextureSize=0,this._caps.maxUniformBufferBindings=16;const a=n.getSupportedExtensions();let h="";if(a)for(const t of a)h+=`${t} `;const l=rot(n);l.WEBGL_debug_renderer_info?(this._renderer=o(l.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=o(l.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=o(7937),this._vendor=o(7936));const c=o(7938);this._features.fill(!1),this.initFormatFeatures(l),l.EXT_blend_minmax&&(this._features[3]=!0),l.OES_element_index_uint&&(this._features[0]=!0),l.ANGLE_instanced_arrays&&(this._features[1]=!0),l.WEBGL_draw_buffers&&(this._features[2]=!0);let u="";return this.getFormatFeatures(72)&&(u+="etc1 "),this.getFormatFeatures(73)&&(u+="etc2 "),this.getFormatFeatures(56)&&(u+="dxt "),this.getFormatFeatures(83)&&(u+="pvrtc "),this.getFormatFeatures(89)&&(u+="astc "),O("WebGL device initialized."),O(`RENDERER: ${this._renderer}`),O(`VENDOR: ${this._vendor}`),O(`VERSION: ${c}`),O(`COMPRESSED_FORMAT: ${u}`),O(`EXTENSIONS: ${h}`),!0}destroy(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._swapchain=null}flushCommands(t){}acquire(t){}present(){const t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()}initFormatFeatures(t){const e=this._formatFeatures,i=this._textureExclusive;e.fill(0),i.fill(!0),e[24]=7,e[47]=7,i[47]=!1,e[35]=7,e[50]=7,i[50]=!1,e[49]=7,i[49]=!1,e[54]=1,i[54]=!1,e[55]=1,i[55]=!1,e[7]|=16,e[17]|=16,e[28]|=16,e[40]|=16,e[6]|=16,e[16]|=16,e[27]|=16,e[39]|=16,e[7]|=16,e[17]|=16,e[28]|=16,e[40]|=16,e[6]|=16,e[16]|=16,e[27]|=16,e[39]|=16,e[11]|=16,e[21]|=16,e[32]|=16,e[44]|=16,t.EXT_sRGB&&(e[25]=7,e[37]=7,i[37]=!1),t.WEBGL_depth_texture&&(e[54]|=7,e[55]|=7),t.WEBGL_color_buffer_float&&(e[32]|=1,e[44]|=1,i[32]=!1,i[44]=!1),t.EXT_color_buffer_half_float&&(e[29]|=1,e[41]|=1,i[29]=!1,i[41]=!1),t.OES_texture_float&&(e[32]|=3,e[44]|=3),t.OES_texture_half_float&&(e[29]|=3,e[41]|=3),t.OES_texture_float_linear&&(e[32]|=4,e[44]|=4),t.OES_texture_half_float_linear&&(e[29]|=4,e[41]|=4),t.WEBGL_compressed_texture_etc1&&(e[72]=6),t.WEBGL_compressed_texture_etc&&(e[73]=6,e[77]=6,e[74]=6,e[78]=6,e[75]=6,e[76]=6),t.WEBGL_compressed_texture_s3tc&&(e[56]=6,e[57]=6,e[58]=6,e[59]=6,e[60]=6,e[61]=6,e[62]=6,e[63]=6),t.WEBGL_compressed_texture_pvrtc&&(e[83]|=6,e[84]|=6,e[85]|=6,e[86]|=6),t.WEBGL_compressed_texture_astc&&(e[89]|=6,e[90]|=6,e[91]|=6,e[92]|=6,e[93]|=6,e[94]|=6,e[95]|=6,e[96]|=6,e[97]|=6,e[98]|=6,e[99]|=6,e[100]|=6,e[101]|=6,e[102]|=6,e[103]|=6,e[104]|=6,e[105]|=6,e[106]|=6,e[107]|=6,e[108]|=6,e[109]|=6,e[110]|=6,e[111]|=6,e[112]|=6,e[113]|=6,e[114]|=6,e[115]|=6,e[116]|=6)}createCommandBuffer(t){const e=new(0===t.type?qnt:Unt);return e.initialize(t),e}createSwapchain(t){const e=new oot;return this._swapchain=e,e.initialize(t),e}createBuffer(t){const e=new Nnt;return e.initialize(t),e}createTexture(t){const e=new tot;return e.initialize(t),e}createDescriptorSet(t){const e=new Qrt;return e.initialize(t),e}createShader(t){const e=new Znt;return e.initialize(t),e}createInputAssembler(t){const e=new Hnt;return e.initialize(t),e}createRenderPass(t){const e=new Ynt;return e.initialize(t),e}createFramebuffer(t){const e=new Vnt;return e.initialize(t),e}createDescriptorSetLayout(t){const e=new Gnt;return e.initialize(t),e}createPipelineLayout(t){const e=new Wnt;return e.initialize(t),e}createPipelineState(t){const e=new $nt;return e.initialize(t),e}createQueue(t){const e=new Xnt;return e.initialize(t),e}getSampler(t){const e=qp.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new Knt(t,e)),this._samplers.get(e)}getSwapchains(){return[this._swapchain]}getGeneralBarrier(t){const e=Qp.computeHash(t);return this._generalBarrierss.has(e)||this._generalBarrierss.set(e,new Qp(t,e)),this._generalBarrierss.get(e)}getTextureBarrier(t){const e=Kp.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Kp(t,e)),this._textureBarriers.get(e)}getBufferBarrier(t){const e=Zp.computeHash(t);return this._bufferBarriers.has(e)||this._bufferBarriers.set(e,new Zp(t,e)),this._bufferBarriers.get(e)}copyBuffersToTexture(t,e,i){Bnt(this,t,e.gpuTexture,i)}copyTextureToBuffers(t,e,i){Rnt(this,t.gpuTexture,e,i)}copyTexImagesToTexture(t,e,i){Ant(this,t,e.gpuTexture,i)}}t("WebGLDevice",aot),l.WebGLDevice=aot;class hot extends Fp{constructor(){super(),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(t){this._layout=t.layout;const{bindings:e,descriptorIndices:i,descriptorCount:s}=t.layout.getGpuDescriptorSetLayout();this._buffers=Array(s).fill(null),this._textures=Array(s).fill(null),this._samplers=Array(s).fill(null);const r=[];this._gpuDescriptorSet={gpuDescriptors:r,descriptorIndices:i};for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<i.count;t++)r.push({type:i.descriptorType,gpuBuffer:null,gpuTextureView:null,gpuSampler:null})}}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const t=this._gpuDescriptorSet.gpuDescriptors;for(let e=0;e<t.length;++e)t[e].type&yp?this._buffers[e]&&(t[e].gpuBuffer=this._buffers[e].getGpuBuffer()):t[e].type&vp&&(this._textures[e]&&(t[e].gpuTextureView=this._textures[e].gpuTextureView),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}}}const lot=[10497,33648,33071,33071],cot=new Float32Array(4),uot=Math.max,dot=Math.min;function pot(t){switch(t){case 4:case 6:case 14:case 16:case 24:case 25:case 27:case 36:case 35:case 37:case 39:case 56:case 58:case 60:case 61:case 62:case 63:case 64:case 66:case 70:case 71:case 72:case 73:case 74:case 75:case 76:case 79:case 81:case 83:case 84:case 85:case 86:case 87:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:case 106:case 107:case 108:case 109:case 110:case 111:case 112:case 113:case 114:case 115:case 116:default:return 5121;case 5:case 7:case 15:case 17:case 26:case 28:case 38:case 40:case 65:case 67:case 80:case 82:return 5120;case 8:case 18:case 29:case 41:return 5131;case 9:case 19:case 30:case 42:return 5123;case 10:case 20:case 31:case 43:return 5122;case 11:case 21:case 32:case 44:case 53:case 54:case 69:case 68:return 5126;case 12:case 22:case 33:case 45:return 5125;case 13:case 23:case 34:case 46:return 5124;case 47:return 33635;case 48:return 35899;case 49:return 32820;case 50:return 32819;case 51:case 52:return 33640;case 55:return 34042}}function _ot(t){switch(t){case 1:return 6406;case 2:return 6409;case 3:return 6410;case 4:return 33321;case 5:return 36756;case 6:return 33330;case 7:return 33329;case 14:return 33323;case 15:return 36757;case 16:return 33336;case 17:return 33335;case 24:return 32849;case 26:return 36758;case 27:return 36221;case 28:return 36239;case 36:case 35:return 32856;case 38:return 36759;case 39:return 36220;case 40:return 36238;case 10:return 33331;case 9:return 33332;case 8:return 33325;case 20:return 33337;case 19:return 33338;case 18:return 33327;case 31:return 36233;case 30:return 36215;case 29:return 34843;case 43:return 36232;case 42:return 36214;case 41:return 34842;case 13:return 33333;case 12:return 33334;case 11:return 33326;case 23:return 33339;case 22:return 33340;case 21:return 33328;case 34:return 36227;case 33:return 36209;case 32:return 34837;case 46:return 36226;case 45:return 36208;case 44:return 34836;case 47:return 36194;case 49:return 32855;case 50:return 32854;case 25:return 35905;case 37:return 35907;case 51:return 32857;case 52:return 36975;case 48:return 35898;case 54:return 36012;case 55:return 35056;case 56:return 33776;case 57:return 33777;case 58:return 35916;case 59:return 35917;case 60:return 33778;case 61:return 35918;case 62:return 33779;case 63:return 35919;case 72:return 36196;case 73:return 37492;case 74:return 37493;case 75:return 37494;case 76:return 37495;case 77:return 37496;case 78:return 37497;case 79:return 37488;case 80:return 37489;case 81:return 37490;case 82:return 37491;case 83:return 35841;case 84:return 35843;case 85:return 35840;case 86:return 35842;case 89:return 37808;case 90:return 37809;case 91:return 37810;case 92:return 37811;case 93:return 37812;case 94:return 37813;case 95:return 37814;case 96:return 37815;case 97:return 37816;case 98:return 37817;case 99:return 37818;case 100:return 37819;case 101:return 37820;case 102:return 37821;case 103:return 37840;case 104:return 37841;case 105:return 37842;case 106:return 37843;case 107:return 37844;case 108:return 37845;case 109:return 37846;case 110:return 37847;case 111:return 37848;case 112:return 37849;case 113:return 37850;case 114:return 37851;case 115:return 37852;case 116:return 37853;default:return j(16309),6408}}function got(t){switch(t){case 1:return 6406;case 2:return 6409;case 3:return 6410;case 4:case 5:case 6:case 7:case 9:case 10:case 8:case 12:case 13:case 11:return 6403;case 14:case 15:case 16:case 17:case 19:case 20:case 18:case 22:case 23:case 21:return 33319;case 24:case 26:case 27:case 28:case 30:case 31:case 29:case 33:case 34:case 32:case 48:case 47:case 25:return 6407;case 36:case 35:case 38:case 39:case 40:case 42:case 43:case 41:case 45:case 46:case 44:case 51:case 49:case 50:case 37:return 6408;case 54:return 6402;case 55:return 34041;case 56:return 33776;case 57:return 33777;case 58:return 35916;case 59:return 35917;case 60:return 33778;case 61:return 35918;case 62:return 33779;case 63:return 35919;case 72:return 36196;case 73:return 37492;case 74:return 37493;case 75:return 37494;case 76:return 37495;case 77:return 37496;case 78:return 37497;case 79:return 37488;case 80:return 37489;case 81:return 37490;case 82:return 37491;case 83:return 35841;case 84:return 35843;case 85:return 35840;case 86:return 35842;case 89:return 37808;case 90:return 37809;case 91:return 37810;case 92:return 37811;case 93:return 37812;case 94:return 37813;case 95:return 37814;case 96:return 37815;case 97:return 37816;case 98:return 37817;case 99:return 37818;case 100:return 37819;case 101:return 37820;case 102:return 37821;case 103:return 37840;case 104:return 37841;case 105:return 37842;case 106:return 37843;case 107:return 37844;case 108:return 37845;case 109:return 37846;case 110:return 37847;case 111:return 37848;case 112:return 37849;case 113:return 37850;case 114:return 37851;case 115:return 37852;case 116:return 37853;default:return j(16310),6408}}function fot(t){switch(t){case 1:return 35670;case 2:return 35671;case 3:return 35672;case 4:return 35673;case 5:return 5124;case 6:return 35667;case 7:return 35668;case 8:return 35669;case 9:return 5125;case 13:return 5126;case 14:return 35664;case 15:return 35665;case 16:return 35666;case 17:return 35674;case 18:return 35685;case 19:return 35686;case 20:return 35687;case 21:return 35675;case 22:return 35688;case 23:return 35689;case 24:return 35690;case 25:return 35676;case 28:return 35678;case 29:return 36289;case 30:return 35679;case 31:return 35680;default:return j(16311),0}}function mot(t){switch(t){case 35670:return 1;case 35671:return 2;case 35672:return 3;case 35673:return 4;case 5124:return 5;case 35667:return 6;case 35668:return 7;case 35669:return 8;case 5125:return 9;case 36294:return 10;case 36295:return 11;case 36296:return 12;case 5126:return 13;case 35664:return 14;case 35665:return 15;case 35666:return 16;case 35674:return 17;case 35685:return 18;case 35686:return 19;case 35687:return 20;case 35675:return 21;case 35688:return 22;case 35689:return 23;case 35690:return 24;case 35676:return 25;case 35678:return 28;case 36289:return 29;case 35679:return 30;case 35680:return 31;default:return j(16313),0}}function yot(t){switch(t){case 35670:case 5124:case 5125:case 5126:case 35678:case 36289:case 36292:case 35679:case 35680:case 36298:case 36303:case 36299:case 36300:case 36306:case 36311:case 36307:case 36308:return 4;case 35671:case 35667:case 36294:case 35664:return 8;case 35672:case 35668:case 36295:case 35665:return 12;case 35673:case 35669:case 36296:case 35666:case 35674:return 16;case 35685:case 35687:return 24;case 35686:case 35689:return 32;case 35675:return 36;case 35688:case 35690:return 48;case 35676:return 64;default:return j(16314),0}}function vot(t){switch(t){case 35674:case 35685:case 35686:return 2;case 35687:case 35675:case 35688:return 3;case 35689:case 35690:case 35676:return 4;default:return 1}}const bot=[512,513,514,515,516,517,518,519],wot=[0,7680,7681,7682,7683,5386,34055,34056],Sot=[32774,32778,32779,32775,32776],xot=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];function Tot(t,e){const{gl:i}=t,s=t.getStateCache(),r=2&e.memUsage?35048:35044;if(8&e.usage){e.glTarget=34962;const n=i.createBuffer();n&&(e.glBuffer=n,e.size>0&&(t.extensions.useVAO&&s.glVAO&&(i.bindVertexArray(null),s.glVAO=null),kot.gpuInputAssembler=null,s.glArrayBuffer!==e.glBuffer&&(i.bindBuffer(34962,e.glBuffer),s.glArrayBuffer=e.glBuffer),i.bufferData(34962,e.size,r),i.bindBuffer(34962,null),s.glArrayBuffer=null))}else if(4&e.usage){e.glTarget=34963;const n=i.createBuffer();n&&(e.glBuffer=n,e.size>0&&(t.extensions.useVAO&&s.glVAO&&(i.bindVertexArray(null),s.glVAO=null),kot.gpuInputAssembler=null,s.glElementArrayBuffer!==e.glBuffer&&(i.bindBuffer(34963,e.glBuffer),s.glElementArrayBuffer=e.glBuffer),i.bufferData(34963,e.size,r),i.bindBuffer(34963,null),s.glElementArrayBuffer=null))}else if(16&e.usage){e.glTarget=35345;const t=i.createBuffer();t&&e.size>0&&(e.glBuffer=t,s.glUniformBuffer!==e.glBuffer&&(i.bindBuffer(35345,e.glBuffer),s.glUniformBuffer=e.glBuffer),i.bufferData(35345,e.size,r),i.bindBuffer(35345,null),s.glUniformBuffer=null)}else 64&e.usage||2&e.usage||1&e.usage||j(16315),e.glTarget=0}function Cot(t,e){const{gl:i}=t,s=t.getStateCache(),r=t.extensions.useVAO;if(e.glBuffer){switch(e.glTarget){case 34962:r&&s.glVAO&&(i.bindVertexArray(null),s.glVAO=null),kot.gpuInputAssembler=null,i.bindBuffer(34962,null),s.glArrayBuffer=null;break;case 34963:r&&s.glVAO&&(i.bindVertexArray(null),s.glVAO=null),kot.gpuInputAssembler=null,i.bindBuffer(34963,null),s.glElementArrayBuffer=null;break;case 35345:i.bindBuffer(35345,null),s.glUniformBuffer=null}i.deleteBuffer(e.glBuffer),e.glBuffer=null}}function Iot(t,e){const{gl:i}=t,s=t.getStateCache(),r=2&e.memUsage?35048:35044;8&e.usage?(t.extensions.useVAO&&s.glVAO&&(i.bindVertexArray(null),s.glVAO=null),kot.gpuInputAssembler=null,s.glArrayBuffer!==e.glBuffer&&i.bindBuffer(34962,e.glBuffer),e.buffer?i.bufferData(34962,e.buffer,r):i.bufferData(34962,e.size,r),i.bindBuffer(34962,null),s.glArrayBuffer=null):4&e.usage?(t.extensions.useVAO&&s.glVAO&&(i.bindVertexArray(null),s.glVAO=null),kot.gpuInputAssembler=null,s.glElementArrayBuffer!==e.glBuffer&&i.bindBuffer(34963,e.glBuffer),e.buffer?i.bufferData(34963,e.buffer,r):i.bufferData(34963,e.size,r),i.bindBuffer(34963,null),s.glElementArrayBuffer=null):16&e.usage?(s.glUniformBuffer!==e.glBuffer&&i.bindBuffer(35345,e.glBuffer),i.bufferData(35345,e.size,r),i.bindBuffer(35345,null),s.glUniformBuffer=null):(64&e.usage||2&e.usage||1&e.usage||j(16315),e.glTarget=0)}function Eot(t,e,i,s,r){if(64&e.usage){e.indirects.clearDraws();const t=i.drawInfos;for(let i=0;i<t.length;++i)e.indirects.setDrawInfo(s+i,t[i])}else{const n=i,{gl:o}=t,a=t.getStateCache();switch(e.glTarget){case 34962:t.extensions.useVAO&&a.glVAO&&(o.bindVertexArray(null),a.glVAO=null),kot.gpuInputAssembler=null,a.glArrayBuffer!==e.glBuffer&&(o.bindBuffer(34962,e.glBuffer),a.glArrayBuffer=e.glBuffer),zn.os===On.IOS&&2&e.memUsage&&0===s&&r===n.byteLength?o.bufferData(e.glTarget,n,o.DYNAMIC_DRAW):r===n.byteLength?o.bufferSubData(e.glTarget,s,n):o.bufferSubData(e.glTarget,s,n.slice(0,r));break;case 34963:t.extensions.useVAO&&a.glVAO&&(o.bindVertexArray(null),a.glVAO=null),kot.gpuInputAssembler=null,a.glElementArrayBuffer!==e.glBuffer&&(o.bindBuffer(34963,e.glBuffer),a.glElementArrayBuffer=e.glBuffer),zn.os===On.IOS&&2&e.memUsage&&0===s&&r===n.byteLength?o.bufferData(e.glTarget,n,o.DYNAMIC_DRAW):r===n.byteLength?o.bufferSubData(e.glTarget,s,n):o.bufferSubData(e.glTarget,s,n.slice(0,r));break;case 35345:a.glUniformBuffer!==e.glBuffer&&(o.bindBuffer(35345,e.glBuffer),a.glUniformBuffer=e.glBuffer),zn.os===On.IOS&&2&e.memUsage&&0===s&&r===n.byteLength?o.bufferData(e.glTarget,n,o.DYNAMIC_DRAW):r===n.byteLength?o.bufferSubData(e.glTarget,s,n):o.bufferSubData(e.glTarget,s,new Float32Array(n,0,r/4));break;default:j(16316)}}}function Dot(t,e){const{gl:i}=t,s=t.getStateCache(),r=t.capabilities;e.glInternalFmt=_ot(e.format),e.glFormat=got(e.format),e.glType=pot(e.format);let n=e.width,o=e.height;const a=e.depth,h=e.arrayLayer;switch(e.type){case 1:{e.glTarget=3553;const t=uot(n,o);if(t>r.maxTextureSize&&j(9100,t,r.maxTextureSize),1===e.samples){if(e.glTexture=i.createTexture(),e.size>0){const t=s.glTexUnits[s.texUnit];if(t.glTexture!==e.glTexture&&(i.bindTexture(3553,e.glTexture),t.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const s=Sp(e.format,n,o,1),r=new Uint8Array(s);i.compressedTexImage2D(3553,t,e.glInternalFmt,n,o,0,r),n=uot(1,n>>1),o=uot(1,o>>1)}else 128&e.flags?i.texImage2D(3553,0,e.glInternalFmt,n,o,0,e.glFormat,e.glType,null):i.texStorage2D(3553,e.mipLevel,e.glInternalFmt,n,o)}}else e.glRenderbuffer=i.createRenderbuffer(),e.size>0&&(s.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(36161,e.glRenderbuffer),s.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorageMultisample(36161,e.samples,e.glInternalFmt,e.width,e.height));break}case 5:{e.glTarget=35866;const t=uot(n,o);if(t>r.maxTextureSize&&j(9100,t,r.maxTextureSize),h>r.maxArrayTextureLayers&&j(9100,h,r.maxArrayTextureLayers),e.glTexture=i.createTexture(),e.size>0){const t=s.glTexUnits[s.texUnit];if(t.glTexture!==e.glTexture&&(i.bindTexture(35866,e.glTexture),t.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const s=Sp(e.format,n,o,h),r=new Uint8Array(s);i.compressedTexImage3D(35866,t,e.glInternalFmt,n,o,h,0,r),n=uot(1,n>>1),o=uot(1,o>>1)}else i.texStorage3D(35866,e.mipLevel,e.glInternalFmt,n,o,h)}break}case 2:{e.glTarget=32879;const t=uot(uot(n,o),a);if(t>r.max3DTextureSize&&j(9100,t,r.max3DTextureSize),e.glTexture=i.createTexture(),e.size>0){const t=s.glTexUnits[s.texUnit];if(t.glTexture!==e.glTexture&&(i.bindTexture(32879,e.glTexture),t.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const s=Sp(e.format,n,o,a),r=new Uint8Array(s);i.compressedTexImage3D(32879,t,e.glInternalFmt,n,o,a,0,r),n=uot(1,n>>1),o=uot(1,o>>1)}else i.texStorage3D(32879,e.mipLevel,e.glInternalFmt,n,o,a)}break}case 3:{e.glTarget=34067;const t=uot(n,o);if(t>r.maxCubeMapTextureSize&&j(9100,t,r.maxTextureSize),e.glTexture=i.createTexture(),e.size>0){const t=s.glTexUnits[s.texUnit];if(t.glTexture!==e.glTexture&&(i.bindTexture(34067,e.glTexture),t.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const s=Sp(e.format,n,o,1),r=new Uint8Array(s);for(let s=0;s<6;++s)i.compressedTexImage2D(34069+s,t,e.glInternalFmt,n,o,0,r);n=uot(1,n>>1),o=uot(1,o>>1)}else i.texStorage2D(34067,e.mipLevel,e.glInternalFmt,n,o)}break}default:j(16317),e.type=1,e.glTarget=3553}}function Aot(t,e){const{gl:i}=t,s=t.getStateCache();if(e.glTexture){const t=s.glTexUnits;let r=s.texUnit;i.deleteTexture(e.glTexture);for(let s=0;s<t.length;++s)t[s].glTexture===e.glTexture&&(i.activeTexture(33984+s),r=s,i.bindTexture(e.glTarget,null),t[s].glTexture=null);s.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){let t=s.glRenderbuffer;i.deleteRenderbuffer(e.glRenderbuffer),t===e.glRenderbuffer&&(i.bindRenderbuffer(36161,null),s.glRenderbuffer=null),e.glRenderbuffer=null}}function Mot(t,e){if(!e.size)return;const{gl:i}=t,s=t.getStateCache(),r=t.capabilities;let n=e.width,o=e.height;const a=e.depth,h=e.arrayLayer;switch(e.type){case 1:{e.glTarget=3553;const a=uot(n,o);if(a>r.maxTextureSize&&j(9100,a,r.maxTextureSize),1===e.samples){const r=s.glTexUnits[s.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(3553,e.glTexture),r.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const s=Sp(e.format,n,o,1),r=new Uint8Array(s);i.compressedTexImage2D(3553,t,e.glInternalFmt,n,o,0,r),n=uot(1,n>>1),o=uot(1,o>>1)}else Aot(t,e),Dot(t,e)}else e.glRenderbuffer&&(s.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(36161,e.glRenderbuffer),s.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorageMultisample(36161,e.samples,e.glInternalFmt,e.width,e.height));break}case 5:{e.glTarget=35866;const t=uot(n,o);if(t>r.maxTextureSize&&j(9100,t,r.maxTextureSize),h>r.maxArrayTextureLayers&&j(9100,h,r.maxArrayTextureLayers),e.glTexture=i.createTexture(),e.size>0){const t=s.glTexUnits[s.texUnit];if(t.glTexture!==e.glTexture&&(i.bindTexture(35866,e.glTexture),t.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const s=Sp(e.format,n,o,h),r=new Uint8Array(s);i.compressedTexImage3D(35866,t,e.glInternalFmt,n,o,h,0,r),n=uot(1,n>>1),o=uot(1,o>>1)}else i.texStorage3D(35866,e.mipLevel,e.glInternalFmt,n,o,h)}break}case 2:{e.glTarget=32879;const t=uot(uot(n,o),a);if(t>r.max3DTextureSize&&j(9100,t,r.max3DTextureSize),e.glTexture=i.createTexture(),e.size>0){const t=s.glTexUnits[s.texUnit];if(t.glTexture!==e.glTexture&&(i.bindTexture(32879,e.glTexture),t.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<e.mipLevel;++t){const s=Sp(e.format,n,o,a),r=new Uint8Array(s);i.compressedTexImage3D(32879,t,e.glInternalFmt,n,o,a,0,r),n=uot(1,n>>1),o=uot(1,o>>1)}else i.texStorage3D(32879,e.mipLevel,e.glInternalFmt,n,o,a)}break}case 3:{e.type=3,e.glTarget=34067;const a=uot(n,o);a>r.maxCubeMapTextureSize&&j(9100,a,r.maxTextureSize);const h=s.glTexUnits[s.texUnit];if(h.glTexture!==e.glTexture&&(i.bindTexture(34067,e.glTexture),h.glTexture=e.glTexture),mp[e.format].isCompressed)for(let t=0;t<6;++t){n=e.width,o=e.height;for(let s=0;s<e.mipLevel;++s){const r=Sp(e.format,n,o,1),a=new Uint8Array(r);i.compressedTexImage2D(34069+t,s,e.glInternalFmt,n,o,0,a),n=uot(1,n>>1),o=uot(1,o>>1)}}else Aot(t,e),Dot(t,e);break}default:j(16317),e.type=1,e.glTarget=3553}}function Pot(t,e){const{gl:i}=t,s=e.glSamplers.values().next();for(;!s.done;){i.deleteSampler(s.value);const e=t.getStateCache().glSamplerUnits;for(let t=0;t<e.length;++t)e[t]===s.value&&(i.bindSampler(t,null),e[t]=null)}e.glSamplers.clear()}function Bot(t,e){const i=t.getStateCache();for(let t=0;t<e.gpuColorViews.length;++t)if(e.gpuColorViews[t].gpuTexture.isSwapchainTexture)return void(e.isOffscreen=!1);const{gl:s}=t,r=[],n=s.createFramebuffer();if(n){e.glFramebuffer=n,i.glFramebuffer!==e.glFramebuffer&&s.bindFramebuffer(36160,e.glFramebuffer);for(let t=0;t<e.gpuColorViews.length;++t){const i=e.gpuColorViews[t],n=i.gpuTexture;n&&(n.glTexture?s.framebufferTexture2D(36160,36064+t,n.glTarget,n.glTexture,i.baseLevel):s.framebufferRenderbuffer(36160,36064+t,36161,n.glRenderbuffer),r.push(36064+t),e.width=dot(e.width,n.width>>i.baseLevel),e.height=dot(e.height,n.height>>i.baseLevel))}const t=e.gpuDepthStencilView;if(t){const i=t.gpuTexture,r=mp[i.format].hasStencil?33306:36096;i.glTexture?s.framebufferTexture2D(36160,r,i.glTarget,i.glTexture,e.gpuDepthStencilView.baseLevel):s.framebufferRenderbuffer(36160,r,36161,i.glRenderbuffer),e.width=dot(e.width,i.width>>t.baseLevel),e.height=dot(e.height,i.height>>t.baseLevel)}s.drawBuffers(r);const o=s.checkFramebufferStatus(36160);if(36053!==o)switch(o){case 36054:j(16318);break;case 36055:j(16319);break;case 36057:j(16320);break;case 36061:j(16321)}i.glFramebuffer!==e.glFramebuffer&&s.bindFramebuffer(36160,i.glFramebuffer)}}function Rot(t,e){const{gl:i}=t,s=t.getStateCache();e.glFramebuffer&&(i.deleteFramebuffer(e.glFramebuffer),s.glFramebuffer===e.glFramebuffer&&(i.bindFramebuffer(36160,null),s.glFramebuffer=null),e.glFramebuffer=null)}function Oot(t,e){const{gl:i}=t,s=t.getStateCache(),r=t.capabilities;for(let t=0;t<e.gpuStages.length;t++){const s=e.gpuStages[t];let r=0,n="",o=1;switch(s.type){case 1:n="VertexShader",r=35633;break;case 16:n="FragmentShader",r=35632;break;default:return void j(16322)}const a=i.createShader(r);if(a&&(s.glShader=a,i.shaderSource(s.glShader,`#version 300 es\n${s.source}`),i.compileShader(s.glShader),!i.getShaderParameter(s.glShader,35713))){j(16323,n,e.name),j(16324,s.source.replace(/^|\n/g,(()=>`\n${o++} `))),B(i.getShaderInfoLog(s.glShader));for(let s=0;s<e.gpuStages.length;s++){const s=e.gpuStages[t];s.glShader&&(i.deleteShader(s.glShader),s.glShader=null)}return}}const n=i.createProgram();if(!n)return;e.glProgram=n;const o=!(!h.rendering||!h.rendering.enableEffectImport);for(let t=0;t<e.gpuStages.length;t++){const s=e.gpuStages[t];i.attachShader(e.glProgram,s.glShader)}i.linkProgram(e.glProgram);for(let t=0;t<e.gpuStages.length;t++){const s=e.gpuStages[t];s.glShader&&(i.detachShader(e.glProgram,s.glShader),i.deleteShader(s.glShader),s.glShader=null)}if(!i.getProgramParameter(e.glProgram,35714))return j(16326,e.name),void B(i.getProgramInfoLog(e.glProgram));V(16325,e.name);const a=i.getProgramParameter(e.glProgram,35721);e.glInputs=new Array(a);for(let t=0;t<a;++t){const s=i.getActiveAttrib(e.glProgram,t);if(s){let r;const n=s.name.indexOf("[");r=-1!==n?s.name.substr(0,n):s.name;const o=i.getAttribLocation(e.glProgram,r),a=mot(s.type),h=yot(s.type);e.glInputs[t]={name:r,type:a,stride:h,count:s.size,size:h*s.size,glType:s.type,glLoc:o}}}const l=i.getProgramParameter(e.glProgram,35382);let c,u,d,p;if(l){e.glBlocks=new Array(l);for(let s=0;s<l;++s){c=i.getActiveUniformBlockName(e.glProgram,s);const r=c.indexOf("[");-1!==r&&(c=c.substr(0,r)),p=null;for(let t=0;t<e.blocks.length;t++)if(e.blocks[t].name===c){p=e.blocks[t];break}if(p){u=s,d=i.getActiveUniformBlockParameter(e.glProgram,u,35392);const r=o?p.flattened:p.binding+(t.bindingMappings.blockOffsets[p.set]||0);i.uniformBlockBinding(e.glProgram,u,r),e.glBlocks[s]={set:p.set,binding:p.binding,idx:u,name:c,size:d,glBinding:r}}else j(16404,c)}}for(let t=0;t<e.subpassInputs.length;++t){const i=e.subpassInputs[t];e.samplerTextures.push(new zd(i.set,i.binding,i.name,28,i.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(let t=0;t<e.samplerTextures.length;++t){const i=e.samplerTextures[t];e.glSamplerTextures[t]={set:i.set,binding:i.binding,name:i.name,type:i.type,count:i.count,units:[],glUnits:null,glType:fot(i.type),glLoc:null}}}const _=[],g=[],f=s.texUnitCacheMap;if(o)for(let t=0;t<e.samplerTextures.length;++t){const s=e.samplerTextures[t],n=i.getUniformLocation(e.glProgram,s.name);n&&-1!==n.id&&(_.push(e.glSamplerTextures[t]),g.push(n)),void 0===f[s.name]&&(f[s.name]=s.flattened%r.maxTextureUnits)}else{let s=0;for(let i=0;i<e.blocks.length;++i)e.blocks[i].set===t.bindingMappings.flexibleSet&&s++;let n=0;for(let o=0;o<e.samplerTextures.length;++o){const a=e.samplerTextures[o],h=i.getUniformLocation(e.glProgram,a.name);if(h&&-1!==h.id&&(_.push(e.glSamplerTextures[o]),g.push(h)),void 0===f[a.name]){let e=a.binding+t.bindingMappings.samplerTextureOffsets[a.set]+n;a.set===t.bindingMappings.flexibleSet&&(e-=s),f[a.name]=e%r.maxTextureUnits,n+=a.count-1}}}if(_.length){const t=[];for(let e=0;e<_.length;++e){const i=_[e];let s=f[i.name];if(void 0!==s){i.glLoc=g[e];for(let e=0;e<i.count;++e){for(;t[s];)s=(s+1)%r.maxTextureUnits;i.units.push(s),t[s]=!0}}}let n=0;for(let e=0;e<_.length;++e){const i=_[e];if(!i.glLoc){for(i.glLoc=g[e];t[n];)n++;for(let e=0;e<i.count;++e){for(;t[n];)n=(n+1)%r.maxTextureUnits;void 0===f[i.name]&&(f[i.name]=n),i.units.push(n),t[n]=!0}}}s.glProgram!==e.glProgram&&i.useProgram(e.glProgram);for(let t=0;t<_.length;t++){const e=_[t];e.glUnits=new Int32Array(e.units),i.uniform1iv(e.glLoc,e.glUnits)}s.glProgram!==e.glProgram&&i.useProgram(s.glProgram)}e.glSamplerTextures=_}function Lot(t,e){const{gl:i}=t,s=t.getStateCache();e.glProgram&&(i.deleteProgram(e.glProgram),s.glProgram===e.glProgram&&(i.useProgram(null),s.glProgram=null),e.glProgram=null)}function Fot(t,e){e.glAttribs=new Array(e.attributes.length);const i=[0,0,0,0,0,0,0,0];for(let t=0;t<e.attributes.length;++t){const s=e.attributes[t],r=void 0!==s.stream?s.stream:0,n=e.gpuVertexBuffers[r],o=pot(s.format),{size:a}=mp[s.format];e.glAttribs[t]={name:s.name,glBuffer:n.glBuffer,glType:o,size:a,count:mp[s.format].count,stride:n.stride,componentCount:vot(o),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:i[r]},i[r]+=a}}function zot(t,e){const{gl:i}=t,s=t.getStateCache(),r=e.glVAOs.values();let n=r.next(),o=s.glVAO;for(;!n.done;)i.deleteVertexArray(n.value),o===n.value&&(i.bindVertexArray(null),o=null),n=r.next();s.glVAO=o,e.glVAOs.clear()}const kot={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function Not(t,e,i,s,r,n,o){const{gl:a}=t,h=t.getStateCache();let l=0;if(i&&e){h.glFramebuffer!==i.glFramebuffer&&(a.bindFramebuffer(36160,i.glFramebuffer),h.glFramebuffer=i.glFramebuffer),h.viewport.left===s.x&&h.viewport.top===s.y&&h.viewport.width===s.width&&h.viewport.height===s.height||(a.viewport(s.x,s.y,s.width,s.height),h.viewport.left=s.x,h.viewport.top=s.y,h.viewport.width=s.width,h.viewport.height=s.height),h.scissorRect.x===s.x&&h.scissorRect.y===s.y&&h.scissorRect.width===s.width&&h.scissorRect.height===s.height||(a.scissor(s.x,s.y,s.width,s.height),h.scissorRect.x=s.x,h.scissorRect.y=s.y,h.scissorRect.width=s.width,h.scissorRect.height=s.height),kot.invalidateAttachments.length=0;for(let t=0;t<r.length;++t){const i=e.colorAttachments[t];if(0!==i.format)switch(i.loadOp){case 0:break;case 1:if(15!==h.bs.targets[0].blendColorMask&&a.colorMask(!0,!0,!0,!0),1===e.colorAttachments.length){const t=r[0];a.clearColor(t.x,t.y,t.z,t.w),l|=16384}else cot[0]=r[t].x,cot[1]=r[t].y,cot[2]=r[t].z,cot[3]=r[t].w,a.clearBufferfv(6144,t,cot);break;case 2:kot.invalidateAttachments.push(36064+t)}}if(e.depthStencilAttachment&&0!==e.depthStencilAttachment.format){switch(e.depthStencilAttachment.depthLoadOp){case 0:break;case 1:h.dss.depthWrite||a.depthMask(!0),a.clearDepth(n),l|=256;break;case 2:kot.invalidateAttachments.push(36096)}if(mp[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case 0:break;case 1:h.dss.stencilWriteMaskFront||a.stencilMaskSeparate(1028,65535),h.dss.stencilWriteMaskBack||a.stencilMaskSeparate(1029,65535),a.clearStencil(o),l|=1024;break;case 2:kot.invalidateAttachments.push(36128)}}if(i.glFramebuffer&&kot.invalidateAttachments.length&&a.invalidateFramebuffer(36160,kot.invalidateAttachments),l&&a.clear(l),16384&l){const t=h.bs.targets[0].blendColorMask;if(15!==t){const e=!!(1&t),i=!!(2&t),s=!!(4&t),r=!!(8&t);a.colorMask(e,i,s,r)}}256&l&&!h.dss.depthWrite&&a.depthMask(!1),1024&l&&(h.dss.stencilWriteMaskFront||a.stencilMaskSeparate(1028,0),h.dss.stencilWriteMaskBack||a.stencilMaskSeparate(1029,0))}}function Uot(t,e,i,s,r,n){const{gl:o}=t,a=t.capabilities,h=t.getStateCache(),l=h.rs,c=h.dss,u=h.bs,d=u.blendColor,p=e&&e.gpuShader;let _=!1;if(e&&kot.gpuPipelineState!==e){if(kot.gpuPipelineState=e,kot.glPrimitive=e.glPrimitive,p){const{glProgram:t}=p;h.glProgram!==t&&(o.useProgram(t),h.glProgram=t,_=!0)}const{rs:t}=e;if(t){if(l.cullMode!==t.cullMode){switch(t.cullMode){case 0:o.disable(2884);break;case 1:o.enable(2884),o.cullFace(1028);break;case 2:o.enable(2884),o.cullFace(1029)}l.cullMode=t.cullMode}const e=t.isFrontFaceCCW;l.isFrontFaceCCW!==e&&(o.frontFace(e?2305:2304),l.isFrontFaceCCW=e),l.depthBias===t.depthBias&&l.depthBiasSlop===t.depthBiasSlop||(o.polygonOffset(t.depthBias,t.depthBiasSlop),l.depthBias=t.depthBias,l.depthBiasSlop=t.depthBiasSlop),l.lineWidth!==t.lineWidth&&(o.lineWidth(t.lineWidth),l.lineWidth=t.lineWidth)}const{dss:i}=e;i&&(c.depthTest!==i.depthTest&&(i.depthTest?o.enable(2929):o.disable(2929),c.depthTest=i.depthTest),c.depthWrite!==i.depthWrite&&(o.depthMask(i.depthWrite),c.depthWrite=i.depthWrite),c.depthFunc!==i.depthFunc&&(o.depthFunc(bot[i.depthFunc]),c.depthFunc=i.depthFunc),c.stencilTestFront===i.stencilTestFront&&c.stencilTestBack===i.stencilTestBack||(i.stencilTestFront||i.stencilTestBack?o.enable(2960):o.disable(2960),c.stencilTestFront=i.stencilTestFront,c.stencilTestBack=i.stencilTestBack),c.stencilFuncFront===i.stencilFuncFront&&c.stencilRefFront===i.stencilRefFront&&c.stencilReadMaskFront===i.stencilReadMaskFront||(o.stencilFuncSeparate(1028,bot[i.stencilFuncFront],i.stencilRefFront,i.stencilReadMaskFront),c.stencilFuncFront=i.stencilFuncFront,c.stencilRefFront=i.stencilRefFront,c.stencilReadMaskFront=i.stencilReadMaskFront),c.stencilFailOpFront===i.stencilFailOpFront&&c.stencilZFailOpFront===i.stencilZFailOpFront&&c.stencilPassOpFront===i.stencilPassOpFront||(o.stencilOpSeparate(1028,wot[i.stencilFailOpFront],wot[i.stencilZFailOpFront],wot[i.stencilPassOpFront]),c.stencilFailOpFront=i.stencilFailOpFront,c.stencilZFailOpFront=i.stencilZFailOpFront,c.stencilPassOpFront=i.stencilPassOpFront),c.stencilWriteMaskFront!==i.stencilWriteMaskFront&&(o.stencilMaskSeparate(1028,i.stencilWriteMaskFront),c.stencilWriteMaskFront=i.stencilWriteMaskFront),c.stencilFuncBack===i.stencilFuncBack&&c.stencilRefBack===i.stencilRefBack&&c.stencilReadMaskBack===i.stencilReadMaskBack||(o.stencilFuncSeparate(1029,bot[i.stencilFuncBack],i.stencilRefBack,i.stencilReadMaskBack),c.stencilFuncBack=i.stencilFuncBack,c.stencilRefBack=i.stencilRefBack,c.stencilReadMaskBack=i.stencilReadMaskBack),c.stencilFailOpBack===i.stencilFailOpBack&&c.stencilZFailOpBack===i.stencilZFailOpBack&&c.stencilPassOpBack===i.stencilPassOpBack||(o.stencilOpSeparate(1029,wot[i.stencilFailOpBack],wot[i.stencilZFailOpBack],wot[i.stencilPassOpBack]),c.stencilFailOpBack=i.stencilFailOpBack,c.stencilZFailOpBack=i.stencilZFailOpBack,c.stencilPassOpBack=i.stencilPassOpBack),c.stencilWriteMaskBack!==i.stencilWriteMaskBack&&(o.stencilMaskSeparate(1029,i.stencilWriteMaskBack),c.stencilWriteMaskBack=i.stencilWriteMaskBack));const{bs:s}=e;if(s){u.isA2C!==s.isA2C&&(s.isA2C?o.enable(32926):o.disable(32926),u.isA2C=s.isA2C);const t=s.blendColor;d.x===t.x&&d.y===t.y&&d.z===t.z&&d.w===t.w||(o.blendColor(t.x,t.y,t.z,t.w),d.x=t.x,d.y=t.y,d.z=t.z,d.w=t.w);const e=s.targets[0],i=h.bs.targets[0];i.blend!==e.blend&&(e.blend?o.enable(3042):o.disable(3042),i.blend=e.blend),i.blendEq===e.blendEq&&i.blendAlphaEq===e.blendAlphaEq||(o.blendEquationSeparate(Sot[e.blendEq],Sot[e.blendAlphaEq]),i.blendEq=e.blendEq,i.blendAlphaEq=e.blendAlphaEq),i.blendSrc===e.blendSrc&&i.blendDst===e.blendDst&&i.blendSrcAlpha===e.blendSrcAlpha&&i.blendDstAlpha===e.blendDstAlpha||(o.blendFuncSeparate(xot[e.blendSrc],xot[e.blendDst],xot[e.blendSrcAlpha],xot[e.blendDstAlpha]),i.blendSrc=e.blendSrc,i.blendDst=e.blendDst,i.blendSrcAlpha=e.blendSrcAlpha,i.blendDstAlpha=e.blendDstAlpha),i.blendColorMask!==e.blendColorMask&&(o.colorMask(!!(1&e.blendColorMask),!!(2&e.blendColorMask),!!(4&e.blendColorMask),!!(8&e.blendColorMask)),i.blendColorMask=e.blendColorMask)}}if(e&&e.gpuPipelineLayout&&p){const i=p.glBlocks.length,{dynamicOffsetIndices:n}=e.gpuPipelineLayout;for(let t=0;t<i;t++){const e=p.glBlocks[t],i=s[e.set],a=i&&i.descriptorIndices[e.binding],l=a>=0&&i.gpuDescriptors[a];if(!l||!l.gpuBuffer)continue;const c=n[e.set],u=c&&c[e.binding];let d=l.gpuBuffer.glOffset;u>=0&&(d+=r[u]),h.glBindUBOs[e.glBinding]===l.gpuBuffer.glBuffer&&h.glBindUBOOffsets[e.glBinding]===d||(d?o.bindBufferRange(35345,e.glBinding,l.gpuBuffer.glBuffer,d,l.gpuBuffer.size):o.bindBufferBase(35345,e.glBinding,l.gpuBuffer.glBuffer),h.glUniformBuffer=h.glBindUBOs[e.glBinding]=l.gpuBuffer.glBuffer,h.glBindUBOOffsets[e.glBinding]=d)}const a=p.glSamplerTextures.length;for(let e=0;e<a;e++){const i=p.glSamplerTextures[e],r=s[i.set];let n=r&&r.descriptorIndices[i.binding],a=n>=0&&r.gpuDescriptors[n];for(let e=0;e<i.units.length;e++){const s=i.units[e],l=h.glTexUnits[s];if(!(a&&a.gpuTextureView&&a.gpuTextureView.gpuTexture&&a.gpuSampler))continue;const c=a.gpuTextureView,u=c.gpuTexture,d=c.baseLevel,p=d+c.levelCount;if(u.size>0){l.glTexture!==u.glTexture&&(h.texUnit!==s&&(o.activeTexture(33984+s),h.texUnit=s),u.glTexture?o.bindTexture(u.glTarget,u.glTexture):o.bindTexture(u.glTarget,t.nullTex2D.gpuTexture.glTexture),l.glTexture=u.glTexture);const{gpuSampler:e}=a,i=e.getGLSampler(t,d,p);h.glSamplerUnits[s]!==i&&(o.bindSampler(s,i),h.glSamplerUnits[s]=i)}a=r.gpuDescriptors[++n]}}}if(i&&p&&(_||kot.gpuInputAssembler!==i))if(kot.gpuInputAssembler=i,t.extensions.useVAO){let t=i.glVAOs.get(p.glProgram);if(!t){let e;t=o.createVertexArray(),i.glVAOs.set(p.glProgram,t),o.bindVertexArray(t),o.bindBuffer(34962,null),o.bindBuffer(34963,null),h.glArrayBuffer=null,h.glElementArrayBuffer=null;for(let t=0;t<p.glInputs.length;t++){const s=p.glInputs[t];e=null;for(let t=0;t<i.glAttribs.length;t++){const r=i.glAttribs[t];if(r.name===s.name){e=r;break}}if(e){h.glArrayBuffer!==e.glBuffer&&(o.bindBuffer(34962,e.glBuffer),h.glArrayBuffer=e.glBuffer);for(let t=0;t<e.componentCount;++t){const i=s.glLoc+t,r=e.offset+e.size*t;o.enableVertexAttribArray(i),h.glCurrentAttribLocs[i]=!0,o.vertexAttribPointer(i,e.count,e.glType,e.isNormalized,e.stride,r),o.vertexAttribDivisor(i,e.isInstanced?1:0)}}}const s=i.gpuIndexBuffer;s&&o.bindBuffer(34963,s.glBuffer),o.bindVertexArray(null),o.bindBuffer(34962,null),o.bindBuffer(34963,null),h.glArrayBuffer=null,h.glElementArrayBuffer=null}h.glVAO!==t&&(o.bindVertexArray(t),h.glVAO=t)}else{for(let t=0;t<a.maxVertexAttributes;++t)h.glCurrentAttribLocs[t]=!1;for(let t=0;t<p.glInputs.length;t++){const e=p.glInputs[t];let s=null;for(let t=0;t<i.glAttribs.length;t++){const r=i.glAttribs[t];if(r.name===e.name){s=r;break}}if(s){h.glArrayBuffer!==s.glBuffer&&(o.bindBuffer(34962,s.glBuffer),h.glArrayBuffer=s.glBuffer);for(let t=0;t<s.componentCount;++t){const i=e.glLoc+t,r=s.offset+s.size*t;!h.glEnabledAttribLocs[i]&&i>=0&&(o.enableVertexAttribArray(i),h.glEnabledAttribLocs[i]=!0),h.glCurrentAttribLocs[i]=!0,o.vertexAttribPointer(i,s.count,s.glType,s.isNormalized,s.stride,r),o.vertexAttribDivisor(i,s.isInstanced?1:0)}}}const t=i.gpuIndexBuffer;t&&h.glElementArrayBuffer!==t.glBuffer&&(o.bindBuffer(34963,t.glBuffer),h.glElementArrayBuffer=t.glBuffer);for(let t=0;t<a.maxVertexAttributes;++t)h.glEnabledAttribLocs[t]!==h.glCurrentAttribLocs[t]&&(o.disableVertexAttribArray(t),h.glEnabledAttribLocs[t]=!1)}if(e&&e.dynamicStates.length){const t=e.dynamicStates.length;for(let i=0;i<t;i++)switch(e.dynamicStates[i]){case 1:l.lineWidth!==n.lineWidth&&(o.lineWidth(n.lineWidth),l.lineWidth=n.lineWidth);break;case 2:l.depthBias===n.depthBiasConstant&&h.rs.depthBiasSlop===n.depthBiasSlope||(o.polygonOffset(n.depthBiasConstant,n.depthBiasSlope),l.depthBias=n.depthBiasConstant,l.depthBiasSlop=n.depthBiasSlope);break;case 4:{const t=n.blendConstant;d.x===t.x&&d.y===t.y&&d.z===t.z&&d.w===t.w||(o.blendColor(t.x,t.y,t.z,t.w),d.copy(t));break}case 16:{const t=n.stencilStatesFront,e=n.stencilStatesBack;c.stencilWriteMaskFront!==t.writeMask&&(o.stencilMaskSeparate(1028,t.writeMask),c.stencilWriteMaskFront=t.writeMask),c.stencilWriteMaskBack!==e.writeMask&&(o.stencilMaskSeparate(1029,e.writeMask),c.stencilWriteMaskBack=e.writeMask);break}case 32:{const t=n.stencilStatesFront,e=n.stencilStatesBack;c.stencilRefFront===t.reference&&c.stencilReadMaskFront===t.compareMask||(o.stencilFuncSeparate(1028,bot[c.stencilFuncFront],t.reference,t.compareMask),c.stencilRefFront=t.reference,c.stencilReadMaskFront=t.compareMask),c.stencilRefBack===e.reference&&c.stencilReadMaskBack===e.compareMask||(o.stencilFuncSeparate(1029,bot[c.stencilFuncBack],e.reference,e.compareMask),c.stencilRefBack=e.reference,c.stencilReadMaskBack=e.compareMask);break}}}}function Vot(t,e){const{gl:i}=t,{gpuInputAssembler:s,glPrimitive:r}=kot,n=t.extensions.WEBGL_multi_draw;if(s){const t=s.gpuIndexBuffer;if(s.gpuIndirectBuffer){const{indirects:e}=s.gpuIndirectBuffer;if(e.drawByIndex){for(let i=0;i<e.drawCount;i++)e.byteOffsets[i]=e.offsets[i]*t.stride;if(n)e.instancedDraw?n.multiDrawElementsInstancedWEBGL(r,e.counts,0,s.glIndexType,e.byteOffsets,0,e.instances,0,e.drawCount):n.multiDrawElementsWEBGL(r,e.counts,0,s.glIndexType,e.byteOffsets,0,e.drawCount);else for(let t=0;t<e.drawCount;t++)e.instances[t]?i.drawElementsInstanced(r,e.counts[t],s.glIndexType,e.byteOffsets[t],e.instances[t]):i.drawElements(r,e.counts[t],s.glIndexType,e.byteOffsets[t])}else if(n)e.instancedDraw?n.multiDrawArraysInstancedWEBGL(r,e.offsets,0,e.counts,0,e.instances,0,e.drawCount):n.multiDrawArraysWEBGL(r,e.offsets,0,e.counts,0,e.drawCount);else for(let t=0;t<e.drawCount;t++)e.instances[t]?i.drawArraysInstanced(r,e.offsets[t],e.counts[t],e.instances[t]):i.drawArrays(r,e.offsets[t],e.counts[t])}else if(e.instanceCount)if(t){if(e.indexCount>0){const n=e.firstIndex*t.stride;i.drawElementsInstanced(r,e.indexCount,s.glIndexType,n,e.instanceCount)}}else e.vertexCount>0&&i.drawArraysInstanced(r,e.firstVertex,e.vertexCount,e.instanceCount);else if(t){if(e.indexCount>0){const n=e.firstIndex*t.stride;i.drawElements(r,e.indexCount,s.glIndexType,n)}}else e.vertexCount>0&&i.drawArrays(r,e.firstVertex,e.vertexCount)}}function Hot(t,e){if(t.length>1||e.length>1)return!1;if(t[0]instanceof HTMLVideoElement){const i=t[0];return 0===e[0].texOffset.x&&0===e[0].texOffset.y&&e[0].texExtent.width===i.videoWidth&&e[0].texExtent.height===i.videoHeight}return!1}function Got(t,e,i,s){const{gl:r}=t,n=t.getStateCache(),o=n.glTexUnits[n.texUnit];o.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);let a=0,h=0;switch(i.glTarget){case 3553:if(128&i.flags||Hot(e,s))r.texImage2D(3553,s[0].texSubres.mipLevel,i.glInternalFmt,s[0].texExtent.width,s[0].texExtent.height,0,i.glFormat,i.glType,e[0]);else for(let t=0;t<s.length;t++){const n=s[t];r.texSubImage2D(3553,n.texSubres.mipLevel,n.texOffset.x,n.texOffset.y,i.glFormat,i.glType,e[a++])}break;case 34067:for(let t=0;t<s.length;t++){const n=s[t],o=n.texSubres.baseArrayLayer+n.texSubres.layerCount;for(h=n.texSubres.baseArrayLayer;h<o;++h)r.texSubImage2D(34069+h,n.texSubres.mipLevel,n.texOffset.x,n.texOffset.y,i.glFormat,i.glType,e[a++])}break;default:j(16327)}1&i.flags&&r.generateMipmap(i.glTarget)}let Wot=new Uint8Array(1);function jot(t,e,i,s,r){const n=Ep(e).height,o=Sp(e,r.width,r.height,r.depth),a=Sp(e,s.width,1,1),h=Sp(e,s.width,s.height,1),l=Sp(e,r.width,1,1),c=Ip(mp[e]);Wot.byteLength<o&&(Wot=new Uint8Array(o));let u=0,d=i;for(let e=0;e<r.depth;e++){d=i+h*e;for(let e=0;e<r.height;e+=n)Wot.subarray(u,u+l).set(new Uint8Array(t.buffer,t.byteOffset+d,l)),u+=l,d+=a}const p=o/c.BYTES_PER_ELEMENT;return q(Number.isInteger(p),9101),new c(Wot.buffer,0,p)}function $ot(t,e,i,s){const{gl:r}=t,n=t.getStateCache(),o=n.glTexUnits[n.texUnit];o.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);let a=0,h=0;const l=mp[i.format],c=Ip(l),{isCompressed:u}=l,d=Ep(i.format),p=new gd,_=new pd,g=new gd;switch(i.glTarget){case 3553:for(let t=0;t<s.length;t++){const n=s[t],o=n.texSubres.mipLevel;_.x=0===n.texOffset.x?0:Dp(n.texOffset.x,d.width),_.y=0===n.texOffset.y?0:Dp(n.texOffset.y,d.height),p.width=n.texExtent.width<d.width?n.texExtent.width:Dp(n.texExtent.width,d.width),p.height=n.texExtent.height<d.height?n.texExtent.width:Dp(n.texExtent.height,d.height),g.width=n.buffStride>0?n.buffStride:p.width,g.height=n.buffTexHeight>0?n.buffTexHeight:p.height;const h=n.texExtent.width+_.x===i.width>>o?n.texExtent.width:p.width,l=n.texExtent.height+_.y===i.height>>o?n.texExtent.height:p.height;let f;const m=e[a++];if(g.width===p.width&&g.height===p.height){const t=Sp(i.format,h,l,1)/c.BYTES_PER_ELEMENT;q(Number.isInteger(t),9101),f=new c(m.buffer,m.byteOffset+n.buffOffset,t)}else f=jot(m,i.format,n.buffOffset,g,p);u?36196!==i.glInternalFmt?r.compressedTexSubImage2D(3553,o,_.x,_.y,h,l,i.glFormat,f):r.compressedTexImage2D(3553,o,i.glInternalFmt,h,l,0,f):r.texSubImage2D(3553,o,_.x,_.y,h,l,i.glFormat,i.glType,f)}break;case 35866:for(let t=0;t<s.length;t++){const n=s[t],o=n.texSubres.mipLevel;_.x=0===n.texOffset.x?0:Dp(n.texOffset.x,d.width),_.y=0===n.texOffset.y?0:Dp(n.texOffset.y,d.height),p.width=n.texExtent.width<d.width?n.texExtent.width:Dp(n.texExtent.width,d.width),p.height=n.texExtent.height<d.height?n.texExtent.width:Dp(n.texExtent.height,d.height),p.depth=1,g.width=n.buffStride>0?n.buffStride:p.width,g.height=n.buffTexHeight>0?n.buffTexHeight:p.height;const l=n.texExtent.width+_.x===i.width>>o?n.texExtent.width:p.width,f=n.texExtent.height+_.y===i.height>>o?n.texExtent.height:p.height,m=n.texSubres.baseArrayLayer+n.texSubres.layerCount;for(h=n.texSubres.baseArrayLayer;h<m;++h){let t;_.z=h;const s=e[a++];if(g.width===p.width&&g.height===p.height){const e=Sp(i.format,l,f,1)/c.BYTES_PER_ELEMENT;q(Number.isInteger(e),9101),t=new c(s.buffer,s.byteOffset+n.buffOffset,e)}else t=jot(s,i.format,n.buffOffset,g,p);u?36196!==i.glInternalFmt?r.compressedTexSubImage3D(35866,o,_.x,_.y,_.z,l,f,p.depth,i.glFormat,t):r.compressedTexImage3D(35866,o,i.glInternalFmt,l,f,p.depth,0,t):r.texSubImage3D(35866,o,_.x,_.y,_.z,l,f,p.depth,i.glFormat,i.glType,t)}}break;case 32879:for(let t=0;t<s.length;t++){const n=s[t],o=n.texSubres.mipLevel;_.x=0===n.texOffset.x?0:Dp(n.texOffset.x,d.width),_.y=0===n.texOffset.y?0:Dp(n.texOffset.y,d.height),_.z=n.texOffset.z,p.width=n.texExtent.width<d.width?n.texExtent.width:Dp(n.texExtent.width,d.width),p.height=n.texExtent.height<d.height?n.texExtent.width:Dp(n.texExtent.height,d.height),p.depth=n.texExtent.depth,g.width=n.buffStride>0?n.buffStride:p.width,g.height=n.buffTexHeight>0?n.buffTexHeight:p.height;const h=n.texExtent.width+_.x===i.width>>o?n.texExtent.width:p.width,l=n.texExtent.height+_.y===i.height>>o?n.texExtent.height:p.height;let f;const m=e[a++];if(g.width===p.width&&g.height===p.height){const t=Sp(i.format,h,l,p.depth)/c.BYTES_PER_ELEMENT;q(Number.isInteger(t),9101),f=new c(m.buffer,m.byteOffset+n.buffOffset,t)}else f=jot(m,i.format,n.buffOffset,g,p);u?36196!==i.glInternalFmt?r.compressedTexSubImage3D(35866,o,_.x,_.y,_.z,h,l,p.depth,i.glFormat,f):r.compressedTexImage3D(35866,o,i.glInternalFmt,h,l,p.depth,0,f):r.texSubImage3D(35866,o,_.x,_.y,_.z,h,l,p.depth,i.glFormat,i.glType,f)}break;case 34067:for(let t=0;t<s.length;t++){const n=s[t],o=n.texSubres.mipLevel;_.x=0===n.texOffset.x?0:Dp(n.texOffset.x,d.width),_.y=0===n.texOffset.y?0:Dp(n.texOffset.y,d.height),p.width=n.texExtent.width<d.width?n.texExtent.width:Dp(n.texExtent.width,d.width),p.height=n.texExtent.height<d.height?n.texExtent.width:Dp(n.texExtent.height,d.height),g.width=n.buffStride>0?n.buffStride:p.width,g.height=n.buffTexHeight>0?n.buffTexHeight:p.height;const l=n.texExtent.width+_.x===i.width>>o?n.texExtent.width:p.width,f=n.texExtent.height+_.y===i.height>>o?n.texExtent.height:p.height,m=n.texSubres.baseArrayLayer+n.texSubres.layerCount;for(h=n.texSubres.baseArrayLayer;h<m;++h){let t;const s=e[a++];if(g.width===p.width&&g.height===p.height){const e=Sp(i.format,l,f,1)/c.BYTES_PER_ELEMENT;q(Number.isInteger(e),9101),t=new c(s.buffer,s.byteOffset+n.buffOffset,e)}else t=jot(s,i.format,n.buffOffset,g,p);u?36196!==i.glInternalFmt?r.compressedTexSubImage2D(34069+h,o,_.x,_.y,l,f,i.glFormat,t):r.compressedTexImage2D(34069+h,o,i.glInternalFmt,l,f,0,t):r.texSubImage2D(34069+h,o,_.x,_.y,l,f,i.glFormat,i.glType,t)}}break;default:j(16327)}1&i.flags&&r.generateMipmap(i.glTarget)}function qot(t,e,i,s){const{gl:r}=t,n=t.getStateCache(),o=r.createFramebuffer();r.bindFramebuffer(36160,o);let a=0,h=0,l=1,c=1;if(3553===e.glTarget)for(let t=0;t<s.length;t++){const n=s[t];r.framebufferTexture2D(36160,36064,e.glTarget,e.glTexture,n.texSubres.mipLevel),a=n.texOffset.x,h=n.texOffset.y,l=n.texExtent.width,c=n.texExtent.height,r.readPixels(a,h,l,c,e.glFormat,e.glType,i[t])}else j(16399);r.bindFramebuffer(36160,null),n.glFramebuffer=null,r.deleteFramebuffer(o)}function Xot(t,e,i,s,r){const{gl:n}=t,o=t.getStateCache(),a=t.blitManager;if(!a)return;const h=2===r||3===r?9729:9728,l=a.srcFramebuffer,c=a.dstFramebuffer,u=o.glReadFramebuffer,d=o.glFramebuffer;let p=s[0].srcSubres.mipLevel,_=s[0].dstSubres.mipLevel;const g=t=>{let e=0,i=36064;return t.hasStencil?i=33306:t.hasDepth&&(i=36096),t.hasDepth||t.hasStencil?(t.hasDepth&&(e|=256),t.hasStencil&&(e|=1024)):e|=16384,{mask:e,attachment:i}},f=s.map(((t,e)=>e));f.sort(((t,e)=>s[t].srcSubres.mipLevel-s[e].srcSubres.mipLevel));const{mask:m,attachment:y}=g(mp[e.format]),{mask:v,attachment:b}=g(mp[i.format]);o.glReadFramebuffer!==l&&(n.bindFramebuffer(36008,l),o.glReadFramebuffer=l),o.glFramebuffer!==c&&(n.bindFramebuffer(36009,c),o.glFramebuffer=c),e.glTexture?n.framebufferTexture2D(36008,y,e.glTarget,e.glTexture,p):n.framebufferRenderbuffer(36008,y,36161,e.glRenderbuffer),i.glTexture?n.framebufferTexture2D(36009,b,i.glTarget,i.glTexture,_):n.framebufferRenderbuffer(36009,b,36161,i.glRenderbuffer);for(let t=0;t<f.length;t++){const r=s[f[t]];e.glTexture&&p!==r.srcSubres.mipLevel&&(p=r.srcSubres.mipLevel,n.framebufferTexture2D(36008,y,e.glTarget,e.glTexture,p)),i.glTexture&&_!==r.dstSubres.mipLevel&&(_=r.dstSubres.mipLevel,n.framebufferTexture2D(36009,b,i.glTarget,i.glTexture,_)),n.blitFramebuffer(r.srcOffset.x,r.srcOffset.y,r.srcOffset.x+r.srcExtent.width,r.srcOffset.y+r.srcExtent.height,r.dstOffset.x,r.dstOffset.y,r.dstOffset.x+r.dstExtent.width,r.dstOffset.y+r.dstExtent.height,m,h)}o.glReadFramebuffer!==u&&(n.bindFramebuffer(36008,u),o.glReadFramebuffer=u),o.glFramebuffer!==d&&(n.bindFramebuffer(36009,d),o.glFramebuffer=d)}class Yot{static get instance(){return Yot._instance}static setInstance(t){Yot._instance=t}}Yot._instance=null;class Qot{constructor(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}clearDraws(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1}setDrawInfo(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)}_ensureCapacity(t){if(this._capacity>t)return;this._capacity=Di(t);const e=new Int32Array(this._capacity),i=new Int32Array(this._capacity),s=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),i.set(this.offsets),s.set(this.instances),this.counts=e,this.offsets=i,this.instances=s}}class Kot{get srcFramebuffer(){return this._srcFramebuffer}get dstFramebuffer(){return this._dstFramebuffer}constructor(){this._srcFramebuffer=void 0,this._dstFramebuffer=void 0;const{gl:t}=Yot.instance;this._srcFramebuffer=t.createFramebuffer(),this._dstFramebuffer=t.createFramebuffer()}destroy(){const{gl:t}=Yot.instance;t.deleteFramebuffer(this._srcFramebuffer),t.deleteFramebuffer(this._dstFramebuffer)}}class Zot extends Mp{constructor(){super(),this._gpuBuffer=null}getGpuBuffer(){return this._gpuBuffer}initialize(t){if("buffer"in t){this._isBufferView=!0;const e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:e.getGpuBuffer().indirects,glTarget:e.getGpuBuffer().glTarget,glBuffer:e.getGpuBuffer().glBuffer,glOffset:t.offset}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new Qot,glTarget:0,glBuffer:null,glOffset:0},Tot(Yot.instance,this._gpuBuffer),Yot.instance.memoryStatus.bufferSize+=this._size}destroy(){this._gpuBuffer&&(this._isBufferView||(Cot(Yot.instance,this._gpuBuffer),Yot.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)}resize(t){if(this._isBufferView)return void G(16379);const e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=t,t>0&&(Iot(Yot.instance,this._gpuBuffer),Yot.instance.memoryStatus.bufferSize-=e,Yot.instance.memoryStatus.bufferSize+=t)))}update(t,e){if(this._isBufferView)return void G(16380);let i;i=void 0!==e?e:64&this._usage?0:t.byteLength,Eot(Yot.instance,this._gpuBuffer,t,0,i)}}class Jot extends Pp{constructor(){super(),this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUDescriptorSets=[],this._curGPUInputAssembler=null,this._curDynamicOffsets=Array(8).fill(0),this._curDynamicStates=new _p,this._isStateInvalid=!1}initialize(t){this._type=t.type,this._queue=t.queue;const e=Yot.instance.bindingMappings.blockOffsets.length;for(let t=0;t<e;t++)this._curGPUDescriptorSets.push(null)}destroy(){}begin(t,e,i){this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalid&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(t,e,i,s,r,n){j(16401),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(t){const e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalid=!0)}bindDescriptorSet(t,e,i){const s=e.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=s,this._isStateInvalid=!0),i){var r;const e=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(e){const s=this._curDynamicOffsets,r=e.dynamicOffsetOffsets[t];for(let t=0;t<i.length;t++)s[r+t]=i[t];this._isStateInvalid=!0}}}bindInputAssembler(t){const e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalid=!0}setViewport(t){const e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalid=!0)}setScissor(t){const e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalid=!0)}setLineWidth(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalid=!0)}setDepthBias(t,e,i){const s=this._curDynamicStates;s.depthBiasConstant===t&&s.depthBiasClamp===e&&s.depthBiasSlope===i||(s.depthBiasConstant=t,s.depthBiasClamp=e,s.depthBiasSlope=i,this._isStateInvalid=!0)}setBlendConstants(t){const e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalid=!0)}setDepthBound(t,e){const i=this._curDynamicStates;i.depthMinBounds===t&&i.depthMaxBounds===e||(i.depthMinBounds=t,i.depthMaxBounds=e,this._isStateInvalid=!0)}setStencilWriteMask(t,e){const i=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;1&t&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalid=!0),2&t&&s.writeMask!==e&&(s.writeMask=e,this._isStateInvalid=!0)}setStencilCompareMask(t,e,i){const s=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;1&t&&(s.compareMask===i&&s.reference===e||(s.reference=e,s.compareMask=i,this._isStateInvalid=!0)),2&t&&(r.compareMask===i&&r.reference===e||(r.reference=e,r.compareMask=i,this._isStateInvalid=!0))}draw(t){j(16328)}updateBuffer(t,e,i){j(16329)}copyBuffersToTexture(t,e,i){j(16330)}execute(t,e){j(16402)}pipelineBarrier(t,e,i,s,r){}bindStates(){j(16401),this._isStateInvalid=!1}blitTexture(t,e,i,s){j(16401)}}class tat extends Op{constructor(){super(),this._gpuFramebuffer=null,this._gpuColorViews=[],this._gpuDepthStencilView=void 0}getGpuFramebuffer(){return this._gpuFramebuffer}get needRebuild(){const t=this.getGpuFramebuffer();if(t){var e;for(let e=0;e<t.gpuColorViews.length;e++)if(t.gpuColorViews[e].gpuTexture.glTexture!==this._gpuColorViews[e])return!0;if((null===(e=t.gpuDepthStencilView)||void 0===e?void 0:e.gpuTexture.glTexture)!==this._gpuDepthStencilView)return!0}return!1}initialize(t){var e;this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;const i=[];for(let e=0;e<t.colorTextures.length;e++){const s=t.colorTextures[e];s&&i.push(s.gpuTextureView)}let s=null;t.depthStencilTexture&&(s=t.depthStencilTexture.gpuTextureView);let r=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.getGpuRenderPass(),gpuColorViews:i,gpuDepthStencilView:s,glFramebuffer:null,isOffscreen:!0,get width(){return this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.width:this.gpuDepthStencilView?this.gpuDepthStencilView.gpuTexture.width:r},set width(t){r=t},get height(){return this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.height:this.gpuDepthStencilView?this.gpuDepthStencilView.gpuTexture.height:n},set height(t){n=t}},Bot(Yot.instance,this._gpuFramebuffer),this._gpuFramebuffer.gpuColorViews.forEach((t=>this._gpuColorViews.push(t.gpuTexture.glTexture))),this._gpuDepthStencilView=null===(e=this._gpuFramebuffer.gpuDepthStencilView)||void 0===e?void 0:e.gpuTexture.glTexture,this._width=this._gpuFramebuffer.width,this._height=this._gpuFramebuffer.height}destroy(){this._gpuFramebuffer&&(Rot(Yot.instance,this._gpuFramebuffer),this._gpuFramebuffer=null,this._gpuColorViews.length=0,this._gpuDepthStencilView=null)}}class eat extends Lp{constructor(){super(),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(t){if(0===t.vertexBuffers.length)return void j(16331);if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{const t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;const e=new Array(t.vertexBuffers.length);for(let i=0;i<t.vertexBuffers.length;++i){const s=t.vertexBuffers[i];s.getGpuBuffer()&&(e[i]=s.getGpuBuffer())}let i=null,s=0;if(t.indexBuffer&&(i=t.indexBuffer.getGpuBuffer(),i))switch(i.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:j(16332)}let r=null;t.indirectBuffer&&(r=t.indirectBuffer.getGpuBuffer()),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:e,gpuIndexBuffer:i,gpuIndirectBuffer:r,glAttribs:[],glIndexType:s,glVAOs:new Map},Fot(Yot.instance,this._gpuInputAssembler)}destroy(){const t=Yot.instance;this._gpuInputAssembler&&t.extensions.useVAO&&zot(t,this._gpuInputAssembler),this._gpuInputAssembler=null}}class iat extends zp{getGpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}constructor(){super(),this._gpuDescriptorSetLayout=null}initialize(t){Array.prototype.push.apply(this._bindings,t.bindings);let e=0,i=-1;const s=[];for(let t=0;t<this._bindings.length;t++){const r=this._bindings[t];s.push(e),e+=r.count,r.binding>i&&(i=r.binding)}this._bindingIndices=Array(i+1).fill(-1);const r=this._descriptorIndices=Array(i+1).fill(-1);for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];this._bindingIndices[e.binding]=t,r[e.binding]=s[t]}const n=[];for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];if(10&e.descriptorType)for(let t=0;t<e.count;t++)n.push(e.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:n,descriptorIndices:r,descriptorCount:e}}destroy(){this._bindings.length=0}}class sat extends kp{constructor(){super(),this._gpuPipelineLayout=null}getGpuPipelineLayout(){return this._gpuPipelineLayout}initialize(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);const e=[],i=[];let s=0;const r=[];for(let t=0;t<this._setLayouts.length;t++){const n=this._setLayouts[t],o=n.getGpuDescriptorSetLayout(),a=o.dynamicBindings,h=Array(n.bindingIndices.length).fill(-1);for(let t=0;t<a.length;t++){const e=a[t];h[e]<0&&(h[e]=s+t)}i.push(o),e.push(h),r.push(s),s+=a.length}this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:e,dynamicOffsetCount:s,dynamicOffsetOffsets:r}}destroy(){this._setLayouts.length=0}}const rat=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class nat extends Wp{constructor(){super(),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;const e=this._bs;if(t.blendState){const i=t.blendState,{targets:s}=i;s&&s.forEach(((t,i)=>{e.setTarget(i,t)})),void 0!==i.isA2C&&(e.isA2C=i.isA2C),void 0!==i.isIndepend&&(e.isIndepend=i.isIndepend),void 0!==i.blendColor&&(e.blendColor=i.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;const i=[];for(let t=0;t<31;t++)this._dynamicStates&1<<t&&i.push(1<<t);this._gpuPipelineState={glPrimitive:rat[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.getGpuPipelineLayout(),rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.getGpuRenderPass(),dynamicStates:i}}destroy(){this._gpuPipelineState=null}}class oat extends Jot{constructor(){super()}beginRenderPass(t,e,i,s,r,n){Not(Yot.instance,t.getGpuRenderPass(),e.getGpuFramebuffer(),i,s,r,n),this._isInRenderPass=!0}draw(t){if(this._isInRenderPass){this._isStateInvalid&&this.bindStates();const e="drawInfo"in t?t.drawInfo:t;Vot(Yot.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;const i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else j(16328)}setViewport(t){const{gl:e}=Yot.instance,i=Yot.instance.getStateCache();i.viewport.left===t.left&&i.viewport.top===t.top&&i.viewport.width===t.width&&i.viewport.height===t.height||(e.viewport(t.left,t.top,t.width,t.height),i.viewport.left=t.left,i.viewport.top=t.top,i.viewport.width=t.width,i.viewport.height=t.height)}setScissor(t){const{gl:e}=Yot.instance,i=Yot.instance.getStateCache();i.scissorRect.x===t.x&&i.scissorRect.y===t.y&&i.scissorRect.width===t.width&&i.scissorRect.height===t.height||(e.scissor(t.x,t.y,t.width,t.height),i.scissorRect.x=t.x,i.scissorRect.y=t.y,i.scissorRect.width=t.width,i.scissorRect.height=t.height)}updateBuffer(t,e,i){if(this._isInRenderPass)j(16329);else{const s=t.getGpuBuffer();if(s){let r;r=void 0!==i?i:64&t.usage?0:e.byteLength,Eot(Yot.instance,s,e,0,r)}}}copyBuffersToTexture(t,e,i){if(this._isInRenderPass)j(16330);else{const s=e.gpuTexture;s&&$ot(Yot.instance,t,s,i)}}execute(t,e){j(16402)}bindStates(){Uot(Yot.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalid=!1}blitTexture(t,e,i,s){const r=t.gpuTexture,n=e.gpuTexture;Xot(Yot.instance,r,n,i,s)}}class aat extends jp{constructor(){super(),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(t){this._type=t.type}destroy(){}submit(t){for(let e=0;e<t.length;e++){const i=t[e];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class hat extends $p{constructor(){super(),this._gpuRenderPass=null}getGpuRenderPass(){return this._gpuRenderPass}initialize(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()}destroy(){this._gpuRenderPass=null}}class lat extends qp{get gpuSampler(){return this._gpuSampler}constructor(t,e){var i;super(t,e),this._gpuSampler=null,this._gpuSampler={glSamplers:new Map,minFilter:this._info.minFilter,magFilter:this._info.magFilter,mipFilter:this._info.mipFilter,addressU:this._info.addressU,addressV:this._info.addressV,addressW:this._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0,getGLSampler(t,e,i){const{gl:s}=t,r=e<<16|i;if(!this.glSamplers.has(r)){const t=s.createSampler();if(t){this.glSamplers.set(r,t);const n=s.samplerParameteri.bind(s),o=s.samplerParameterf.bind(s);n(t,10241,this.glMinFilter),n(t,10240,this.glMagFilter),n(t,10242,this.glWrapS),n(t,10243,this.glWrapT),n(t,32882,this.glWrapR),o(t,33082,e),o(t,33083,i)}}return this.glSamplers.get(r)}},Yot.instance,2===(i=this._gpuSampler).minFilter||3===i.minFilter?2===i.mipFilter||3===i.mipFilter?i.glMinFilter=9987:1===i.mipFilter?i.glMinFilter=9985:i.glMinFilter=9729:2===i.mipFilter||3===i.mipFilter?i.glMinFilter=9986:1===i.mipFilter?i.glMinFilter=9984:i.glMinFilter=9728,2===i.magFilter||3===i.magFilter?i.glMagFilter=9729:i.glMagFilter=9728,i.glWrapS=lot[i.addressU],i.glWrapT=lot[i.addressV],i.glWrapR=lot[i.addressW]}destroy(){this._gpuSampler&&(Pot(Yot.instance,this._gpuSampler),this._gpuSampler=null)}}class cat extends Xp{constructor(){super(),this._gpuShader=null}get gpuShader(){return null===this._gpuShader.glProgram&&Oot(Yot.instance,this._gpuShader),this._gpuShader}initialize(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(let e=0;e<t.stages.length;++e){const i=t.stages[e];this._gpuShader.gpuStages[e]={type:i.stage,source:i.source,glShader:null}}}destroy(){this._gpuShader&&(Lot(Yot.instance,this._gpuShader),this._gpuShader=null)}}class uat{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new wd,this.scissorRect=new _d(0,0,0,0),this.rs=new Np,this.dss=new Up,this.bs=new Hp,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(t,e,i){for(let e=0;e<t;++e)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=t,this.glSamplerUnits.fill(null),this.glBindUBOs.length=e,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=e,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=i,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=i,this.glCurrentAttribLocs.fill(!1)}}class dat extends Yp{constructor(){super(),this._gpuTexture=null,this._gpuTextureView=null}get gpuTexture(){return this._gpuTexture}get gpuTextureView(){return this._gpuTextureView}initialize(t,e){let i=t;const s=t;if("texture"in t&&(i=s.texture.info,this._isTextureView=!0),this._info.copy(i),this._isPowerOf2=bp(this._info.width)&&bp(this._info.height),this._size=xp(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView){var r;if(this._viewInfo.copy(s),this._gpuTexture=s.texture._gpuTexture,(null===(r=this._gpuTexture)||void 0===r?void 0:r.format)!==i.format)return void N(16403);this._gpuTextureView={gpuTexture:this._gpuTexture,type:s.type,format:s.format,baseLevel:s.baseLevel,levelCount:s.levelCount}}else this._gpuTexture={type:i.type,format:i.format,usage:i.usage,width:i.width,height:i.height,depth:i.depth,size:this._size,arrayLayer:i.layerCount,mipLevel:i.levelCount,samples:i.samples,flags:i.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},!this._gpuTexture.isSwapchainTexture&&this._gpuTexture&&(Dot(Yot.instance,this._gpuTexture),Yot.instance.memoryStatus.textureSize+=this._size),this._viewInfo.texture=this,this._viewInfo.type=t.type,this._viewInfo.format=t.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=t.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=t.layerCount,this._gpuTextureView={gpuTexture:this._gpuTexture,type:this._viewInfo.type,format:this._viewInfo.format,baseLevel:this._viewInfo.baseLevel,levelCount:this._viewInfo.levelCount}}destroy(){!this._isTextureView&&this._gpuTexture&&(Aot(Yot.instance,this._gpuTexture),Yot.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}getTextureHandle(){const t=this._gpuTexture;return t?t.glTexture?t.glTexture:t.glRenderbuffer?t.glRenderbuffer:0:0}resize(t,e){if(this._info.width===t&&this._info.height===e)return;this._info.levelCount===dat.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=dat.getLevelCount(t,e):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,dat.getLevelCount(t,e)));const i=this._size;this._info.width=t,this._info.height=e,this._size=xp(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,this._gpuTexture.isSwapchainTexture||(Mot(Yot.instance,this._gpuTexture),Yot.instance.memoryStatus.textureSize-=i,Yot.instance.memoryStatus.textureSize+=this._size))}initAsSwapchainTexture(t){const e=new Bd;e.format=t.format,e.usage=mp[t.format].hasDepth?32:16,e.width=t.width,e.height=t.height,this.initialize(e,!0)}}const pat="webglcontextlost";function _at(t){t.activeTexture(33984),t.pixelStorei(3333,1),t.pixelStorei(3317,1),t.pixelStorei(37440,!1),t.bindFramebuffer(36160,null),t.enable(3089),t.enable(2884),t.cullFace(1029),t.frontFace(2305),t.polygonOffset(0,0),t.enable(2929),t.depthMask(!0),t.depthFunc(513),t.stencilFuncSeparate(1028,519,1,65535),t.stencilOpSeparate(1028,7680,7680,7680),t.stencilMaskSeparate(1028,65535),t.stencilFuncSeparate(1029,519,1,65535),t.stencilOpSeparate(1029,7680,7680,7680),t.stencilMaskSeparate(1029,65535),t.disable(2960),t.disable(32926),t.disable(3042),t.blendEquationSeparate(32774,32774),t.blendFuncSeparate(1,0,1,0),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}function gat(t,e){const i=["","WEBKIT_","MOZ_"];for(let s=0;s<i.length;++s){const r=t.getExtension(i[s]+e);if(r)return r}return null}function fat(t){const e={EXT_texture_filter_anisotropic:gat(t,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:gat(t,"EXT_color_buffer_half_float"),EXT_color_buffer_float:gat(t,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:gat(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:gat(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:gat(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:gat(t,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:gat(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:gat(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:gat(t,"WEBGL_debug_shaders"),WEBGL_lose_context:gat(t,"WEBGL_lose_context"),WEBGL_debug_renderer_info:gat(t,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:gat(t,"OES_texture_half_float_linear"),OES_texture_float_linear:gat(t,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return zn.os!==On.ANDROID&&zn.os!==On.IOS&&(e.WEBGL_multi_draw=gat(t,"WEBGL_multi_draw")),e}function mat(t){let e=null;try{var i;if(null!==(i=globalThis.__globalXR)&&void 0!==i&&i.webxrCompatible){const i={alpha:le.ENABLE_TRANSPARENT_CANVAS,antialias:le.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1,xrCompatible:!0};return e=t.getContext("webgl2",i),e}const s={alpha:le.ENABLE_TRANSPARENT_CANVAS,antialias:le.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl2",s)}catch(t){return null}return e}class yat extends Rp{constructor(){super(),this.stateCache=new uat,this.nullTex2D=null,this.nullTexCube=null,this._canvas=null,this._webGL2ContextLostHandler=null,this._extensions=null,this._blitManager=null}get extensions(){return this._extensions}get blitManager(){return this._blitManager}initialize(t){this._canvas=t.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(pat,this._onWebGLContextLost);const e=Yot.instance.gl;this.stateCache.initialize(Yot.instance.capabilities.maxTextureUnits,Yot.instance.capabilities.maxUniformBufferBindings,Yot.instance.capabilities.maxVertexAttributes),this._extensions=fat(e),_at(e);let i=55;const s=e.getParameter(3414),r=e.getParameter(3415);s&&r?i=55:s&&(i=54),this._colorTexture=new dat,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:35,width:t.width,height:t.height}),this._depthStencilTexture=new dat,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=Yot.instance.createTexture(new Bd(1,4,35,2,2,0)),this.nullTexCube=Yot.instance.createTexture(new Bd(3,4,35,2,2,0,6));const n=new bd;n.texExtent.width=2,n.texExtent.height=2;const o=new Uint8Array(this.nullTex2D.size);o.fill(0),Yot.instance.copyBuffersToTexture([o],this.nullTex2D,[n]),n.texSubres.layerCount=6,Yot.instance.copyBuffersToTexture([o,o,o,o,o,o],this.nullTexCube,[n]),this._blitManager=new Kot}destroy(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(pat,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._blitManager&&(this._blitManager.destroy(),this._blitManager=null),this._extensions=null,this._canvas=null}resize(t,e,i){this._colorTexture.width===t&&this._colorTexture.height===e||(O(`Resizing swapchain: ${t}x${e}`),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))}_onWebGLContextLost(t){G(11e3),P(t)}}class vat extends Bp{constructor(){super(),this._swapchain=null,this._context=null,this._bindingMappings=null,this._textureExclusive=new Array(117)}get gl(){return this._context}get extensions(){return this._swapchain.extensions}getStateCache(){return this._swapchain.stateCache}get nullTex2D(){return this._swapchain.nullTex2D}get nullTexCube(){return this._swapchain.nullTexCube}get textureExclusive(){return this._textureExclusive}get bindingMappings(){return this._bindingMappings}get blitManager(){return this._swapchain.blitManager}initialize(t){Yot.setInstance(this),this._gfxAPI=7;const e=this._bindingMappingInfo=t.bindingMappingInfo,i=[],s=[],r=e.setIndices[0];i[r]=0,s[r]=0;for(let t=1;t<e.setIndices.length;++t){const r=e.setIndices[t],n=e.setIndices[t-1];i[r]=e.maxBlockCounts[n]+i[n],s[r]=e.maxSamplerTextureCounts[n]+s[n]}for(let t=0;t<e.setIndices.length;++t){const i=e.setIndices[t];s[i]-=e.maxBlockCounts[i]}this._bindingMappings={blockOffsets:i,samplerTextureOffsets:s,flexibleSet:e.setIndices[e.setIndices.length-1]};const n=this._context=mat(Bp.canvas);if(!n)return j(16405),!1;this._queue=this.createQueue(new lp(0)),this._cmdBuff=this.createCommandBuffer(new hp(this._queue));const o=n.getParameter.bind(n);if(this._caps.maxVertexAttributes=o(34921),this._caps.maxVertexUniformVectors=o(36347),zn.os===On.IOS){const t=this._caps.maxVertexUniformVectors;Hn.browserType===Pn.WECHAT?this._caps.maxVertexUniformVectors=t<256?t:256:Hn.browserType===Pn.SAFARI&&(this._caps.maxVertexUniformVectors=t<512?t:512)}this._caps.maxFragmentUniformVectors=o(36349),this._caps.maxTextureUnits=o(34930),this._caps.maxVertexTextureUnits=o(35660),this._caps.maxUniformBufferBindings=o(35375),this._caps.maxUniformBlockSize=o(35376),this._caps.maxTextureSize=o(3379),this._caps.maxCubeMapTextureSize=o(34076),this._caps.maxArrayTextureLayers=o(35071),this._caps.max3DTextureSize=o(32883),this._caps.uboOffsetAlignment=o(35380);const a=n.getSupportedExtensions();let h="";if(a)for(const t of a)h+=`${t} `;const l=fat(n);l.WEBGL_debug_renderer_info?(this._renderer=o(l.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=o(l.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=o(7937),this._vendor=o(7936));const c=o(7938);this._features.fill(!1),this.initFormatFeatures(l),this._features[0]=!0,this._features[1]=!0,this._features[2]=!0,this._features[3]=!0;let u="";return this.getFormatFeatures(72)&&(u+="etc1 "),this.getFormatFeatures(73)&&(u+="etc2 "),this.getFormatFeatures(56)&&(u+="dxt "),this.getFormatFeatures(83)&&(u+="pvrtc "),this.getFormatFeatures(89)&&(u+="astc "),O("WebGL2 device initialized."),O(`RENDERER: ${this._renderer}`),O(`VENDOR: ${this._vendor}`),O(`VERSION: ${c}`),O(`COMPRESSED_FORMAT: ${u}`),O(`EXTENSIONS: ${h}`),!0}destroy(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);const t=this._samplers.values();let e=t.next();for(;!e.done;)e.value.destroy(),e=t.next();this._swapchain=null}flushCommands(t){}acquire(t){}present(){const t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()}initFormatFeatures(t){const e=this._formatFeatures,i=this._textureExclusive;e.fill(0),i.fill(!0);let s=31;e[4]=s,e[14]=s,e[24]=s,e[35]=s,s=15,e[5]=s,e[15]=s,e[26]=s,e[38]=s,e[47]=s,e[50]=s,e[49]=s,e[51]=s,e[25]=s,e[37]=s,e[48]=s,e[53]=s,e[54]=s,e[55]=s,e[52]=15,s=27,e[8]=s,e[18]=s,e[29]=s,e[41]=s,s=26,e[11]=s,e[21]=s,e[32]=s,e[44]=s,e[52]=15,s=31,e[7]=s,e[6]=s,e[10]=s,e[9]=s,e[13]=s,e[12]=s,e[17]=s,e[16]=s,e[20]=s,e[19]=s,e[23]=s,e[22]=s,e[28]=s,e[27]=s,e[31]=s,e[30]=s,e[34]=s,e[33]=s,e[40]=s,e[39]=s,e[43]=s,e[42]=s,e[46]=s,e[45]=s,i[4]=!1,i[14]=!1,i[24]=!1,i[47]=!1,i[50]=!1,i[49]=!1,i[35]=!1,i[51]=!1,i[52]=!1,i[37]=!1,i[7]=!1,i[6]=!1,i[10]=!1,i[9]=!1,i[13]=!1,i[12]=!1,i[17]=!1,i[16]=!1,i[20]=!1,i[19]=!1,i[23]=!1,i[22]=!1,i[40]=!1,i[39]=!1,i[43]=!1,i[42]=!1,i[46]=!1,i[45]=!1,i[54]=!1,i[55]=!1,t.EXT_color_buffer_float&&(e[11]|=1,e[21]|=1,e[44]|=1,i[11]=!1,i[21]=!1,i[44]=!1),t.EXT_color_buffer_half_float&&(i[8]=!1,i[18]=!1,i[41]=!1),t.OES_texture_float_linear&&(e[32]|=4,e[44]|=4,e[11]|=4,e[21]|=4),t.OES_texture_half_float_linear&&(e[29]|=4,e[41]|=4,e[8]|=4,e[18]|=4),t.WEBGL_compressed_texture_etc1&&(e[72]=6),t.WEBGL_compressed_texture_etc&&(e[73]=6,e[77]=6,e[74]=6,e[78]=6,e[75]=6,e[76]=6),t.WEBGL_compressed_texture_s3tc&&(e[56]=6,e[57]=6,e[58]=6,e[59]=6,e[60]=6,e[61]=6,e[62]=6,e[63]=6),t.WEBGL_compressed_texture_pvrtc&&(e[83]=6,e[84]=6,e[85]=6,e[86]=6),t.WEBGL_compressed_texture_astc&&(e[89]=6,e[90]=6,e[91]=6,e[92]=6,e[93]=6,e[94]=6,e[95]=6,e[96]=6,e[97]=6,e[98]=6,e[99]=6,e[100]=6,e[101]=6,e[102]=6,e[103]=6,e[104]=6,e[105]=6,e[106]=6,e[107]=6,e[108]=6,e[109]=6,e[110]=6,e[111]=6,e[112]=6,e[113]=6,e[114]=6,e[115]=6,e[116]=6)}createCommandBuffer(t){const e=new(0===t.type?oat:Jot);return e.initialize(t),e}createSwapchain(t){const e=new yat;return this._swapchain=e,e.initialize(t),e}createBuffer(t){const e=new Zot;return e.initialize(t),e}createTexture(t){const e=new dat;return e.initialize(t),e}createDescriptorSet(t){const e=new hot;return e.initialize(t),e}createShader(t){const e=new cat;return e.initialize(t),e}createInputAssembler(t){const e=new eat;return e.initialize(t),e}createRenderPass(t){const e=new hat;return e.initialize(t),e}createFramebuffer(t){const e=new tat;return e.initialize(t),e}createDescriptorSetLayout(t){const e=new iat;return e.initialize(t),e}createPipelineLayout(t){const e=new sat;return e.initialize(t),e}createPipelineState(t){const e=new nat;return e.initialize(t),e}createQueue(t){const e=new aat;return e.initialize(t),e}getSampler(t){const e=qp.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new lat(t,e)),this._samplers.get(e)}getSwapchains(){return[this._swapchain]}getGeneralBarrier(t){const e=Qp.computeHash(t);return this._generalBarrierss.has(e)||this._generalBarrierss.set(e,new Qp(t,e)),this._generalBarrierss.get(e)}getTextureBarrier(t){const e=Kp.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Kp(t,e)),this._textureBarriers.get(e)}getBufferBarrier(t){const e=Zp.computeHash(t);return this._bufferBarriers.has(e)||this._bufferBarriers.set(e,new Zp(t,e)),this._bufferBarriers.get(e)}copyBuffersToTexture(t,e,i){$ot(this,t,e.gpuTexture,i)}copyTextureToBuffers(t,e,i){qot(this,t.gpuTexture,e,i)}copyTexImagesToTexture(t,e,i){Got(this,t,e.gpuTexture,i)}}var bat,wat,Sat,xat,Tat,Cat,Iat,Eat,Dat,Aat;t("WebGL2Device",vat),l.WebGL2Device=vat,t("Billboard",(bat=oa("cc.Billboard"),wat=Ga(qf),Sat=Ga(qf),bat((Tat=class extends Ag{get texture(){return this._texture}set texture(t){this._texture=t,this.updateTexture()}updateTexture(){this._material&&this._material.setProperty("mainTexture",this._texture)}get height(){return this._height}set height(t){this._height=t,this.updateHeight()}updateHeight(){this._material&&(this._uniform.y=this._height,this._material.setProperty("cc_size_rotation",this._uniform))}get width(){return this._width}set width(t){this._width=t,this.updateWidth()}updateWidth(){this._material&&(this._uniform.x=this._width,this._material.setProperty("cc_size_rotation",this._uniform))}get rotation(){return Math.round(100*bi(this._rotation))/100}set rotation(t){this._rotation=vi(t),this.updateRotation()}updateRotation(){this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}get technique(){return this._techIndex}set technique(t){var e,i;t=Math.floor(t);const s=null===(e=this._material)||void 0===e||null===(i=e.effectAsset)||void 0===i?void 0:i.techniques;s&&t>=s.length&&(t=s.length-1),t<0&&(t=0),this._techIndex=t,this.updateTechnique()}updateTechnique(){this._model&&this._mesh&&this._material&&this._material.technique!==this._techIndex&&(this.detachFromScene(),this._model.destroy(),this._model=null,this._material.destroy(),this._material=null,this._mesh.destroy(),this._mesh=null,this.createModel(),this.updateWidth(),this.updateHeight(),this.updateRotation(),this.updateTexture(),this.enabled?(this.attachToScene(),this._model.enabled=!0):this._model.enabled=!1)}constructor(){super(),this._texture=Cat&&Cat(),this._height=Iat&&Iat(),this._width=Eat&&Eat(),this._rotation=Dat&&Dat(),this._techIndex=Aat&&Aat(),this._model=null,this._mesh=null,this._material=null,this._uniform=new cr(1,1,0,0)}onLoad(){this.createModel()}onEnable(){this.attachToScene(),this._model.enabled=!0,this.updateWidth(),this.updateHeight(),this.updateRotation(),this.updateTexture(),this.updateTechnique()}onDisable(){this.detachFromScene()}attachToScene(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}createModel(){this._mesh=lB({primitiveMode:7,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[_r.WHITE.r,_r.WHITE.g,_r.WHITE.b,_r.WHITE.a,_r.WHITE.r,_r.WHITE.g,_r.WHITE.b,_r.WHITE.a,_r.WHITE.r,_r.WHITE.g,_r.WHITE.b,_r.WHITE.a,_r.WHITE.r,_r.WHITE.g,_r.WHITE.b,_r.WHITE.a],attributes:[new Wd("a_position",32),new Wd("a_texCoord",21),new Wd("a_color",39,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});const t=this._model=h.director.root.createModel(CA,this.node);t.node=t.transform=this.node,null==this._material&&(this._material=new Lw,this._material.copy(pw.get("default-billboard-material"),{technique:this._techIndex})),t.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)}},Cat=Qo(Tat.prototype,"_texture",[wat],(function(){return null})),s(Tat.prototype,"texture",[Sat],Object.getOwnPropertyDescriptor(Tat.prototype,"texture"),Tat.prototype),Iat=Qo(Tat.prototype,"_height",[va],(function(){return 0})),Eat=Qo(Tat.prototype,"_width",[va],(function(){return 0})),Dat=Qo(Tat.prototype,"_rotation",[va],(function(){return 0})),Aat=Qo(Tat.prototype,"_techIndex",[va],(function(){return 0})),xat=Tat))||xat));const Mat=[new Wd("a_position",32),new Wd("a_texCoord",44),new Wd("a_texCoord1",32),new Wd("a_color",35,!0)],Pat=new Ki,Bat=new Ki;class Rat extends CA{constructor(){super(),this._capacity=void 0,this._vertSize=0,this._vBuffer=null,this._vertAttrsFloatCount=0,this._vdataF32=null,this._vdataUint32=null,this._subMeshData=null,this._vertCount=0,this._indexCount=0,this._material=null,this._iaVertCount=0,this._iaIndexCount=0,this.type=5,this._capacity=100}setCapacity(t){this._capacity=t,this.createBuffer()}createBuffer(){this._vertSize=0;for(const t of Mat)t.offset=this._vertSize,this._vertSize+=mp[t.format].size;this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}updateMaterial(t){this._material=t,super.setSubModelMaterial(0,t)}createSubMeshData(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;const t=this._device.createBuffer(new Ed(10,1,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);const i=new Uint16Array((this._capacity-1)*this._indexCount);let s=0;for(let t=0;t<this._capacity-1;++t){const e=2*t;i[s++]=e,i[s++]=e+1,i[s++]=e+2,i[s++]=e+3,i[s++]=e+2,i[s++]=e+1}const r=this._device.createBuffer(new Ed(6,1,(this._capacity-1)*this._indexCount*2,2));return r.update(i),this._iaVertCount=this._capacity*this._vertCount,this._iaIndexCount=(this._capacity-1)*this._indexCount,this._subMeshData=new _S([t],Mat,7,r),this.initSubModel(0,this._subMeshData,this._material),e}addLineVertexData(t,e,i){if(t.length>1){let s=0;Ki.subtract(Pat,t[1],t[0]),this._vdataF32[s++]=t[0].x,this._vdataF32[s++]=t[0].y,this._vdataF32[s++]=t[0].z,this._vdataF32[s++]=0,this._vdataF32[s++]=e.evaluate(0,1),this._vdataF32[s++]=0,this._vdataF32[s++]=0,this._vdataF32[s++]=Pat.x,this._vdataF32[s++]=Pat.y,this._vdataF32[s++]=Pat.z,this._vdataUint32[s++]=_r.toUint32(i.evaluate(0,1)),this._vdataF32[s++]=t[0].x,this._vdataF32[s++]=t[0].y,this._vdataF32[s++]=t[0].z,this._vdataF32[s++]=1,this._vdataF32[s++]=e.evaluate(0,1),this._vdataF32[s++]=0,this._vdataF32[s++]=1,this._vdataF32[s++]=Pat.x,this._vdataF32[s++]=Pat.y,this._vdataF32[s++]=Pat.z,this._vdataUint32[s++]=_r.toUint32(i.evaluate(0,1));for(let r=1;r<t.length-1;r++){Ki.subtract(Pat,t[r-1],t[r]),Ki.subtract(Bat,t[r+1],t[r]),Ki.subtract(Bat,Bat,Pat);const n=r/t.length;this._vdataF32[s++]=t[r].x,this._vdataF32[s++]=t[r].y,this._vdataF32[s++]=t[r].z,this._vdataF32[s++]=0,this._vdataF32[s++]=e.evaluate(n,1),this._vdataF32[s++]=n,this._vdataF32[s++]=0,this._vdataF32[s++]=Bat.x,this._vdataF32[s++]=Bat.y,this._vdataF32[s++]=Bat.z,this._vdataUint32[s++]=_r.toUint32(i.evaluate(n,1)),this._vdataF32[s++]=t[r].x,this._vdataF32[s++]=t[r].y,this._vdataF32[s++]=t[r].z,this._vdataF32[s++]=1,this._vdataF32[s++]=e.evaluate(n,1),this._vdataF32[s++]=n,this._vdataF32[s++]=1,this._vdataF32[s++]=Bat.x,this._vdataF32[s++]=Bat.y,this._vdataF32[s++]=Bat.z,this._vdataUint32[s++]=_r.toUint32(i.evaluate(n,1))}Ki.subtract(Pat,t[t.length-1],t[t.length-2]),this._vdataF32[s++]=t[t.length-1].x,this._vdataF32[s++]=t[t.length-1].y,this._vdataF32[s++]=t[t.length-1].z,this._vdataF32[s++]=0,this._vdataF32[s++]=e.evaluate(1,1),this._vdataF32[s++]=1,this._vdataF32[s++]=0,this._vdataF32[s++]=Pat.x,this._vdataF32[s++]=Pat.y,this._vdataF32[s++]=Pat.z,this._vdataUint32[s++]=_r.toUint32(i.evaluate(1,1)),this._vdataF32[s++]=t[t.length-1].x,this._vdataF32[s++]=t[t.length-1].y,this._vdataF32[s++]=t[t.length-1].z,this._vdataF32[s++]=1,this._vdataF32[s++]=e.evaluate(1,1),this._vdataF32[s++]=1,this._vdataF32[s++]=1,this._vdataF32[s++]=Pat.x,this._vdataF32[s++]=Pat.y,this._vdataF32[s++]=Pat.z,this._vdataUint32[s++]=_r.toUint32(i.evaluate(1,1))}this.updateIA(Math.max(0,t.length-1))}updateIA(t){const e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.firstIndex=0,e.indexCount=this._indexCount*t,e.vertexCount=this._iaVertCount}destroySubMeshData(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}var Oat,Lat;const Fat=ri.Attr.setClassAttr,zat=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],kat=te({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3});let Nat=t("CurveRange",oa("cc.CurveRange")((Lat=class{set mode(t){switch(this._mode=t,t){case kat.Constant:case kat.TwoConstants:break;case kat.Curve:this.spline||(this.spline=wc());break;case kat.TwoCurves:this.splineMax||(this.splineMax=wc()),this.splineMin||(this.splineMin=wc())}}get mode(){return this._mode}get curve(){var t;return null!==(t=this._curve)&&void 0!==t?t:this._curve=new yc(this.spline)}set curve(t){this._curve=t,this.spline=t._internalCurve}get curveMin(){var t;return null!==(t=this._curveMin)&&void 0!==t?t:this._curveMin=new yc(this.splineMin)}set curveMin(t){this._curveMin=t,this.splineMin=t._internalCurve}get curveMax(){var t;return null!==(t=this._curveMax)&&void 0!==t?t:this._curveMax=new yc(this.splineMax)}set curveMax(t){this._curveMax=t,this.splineMax=t._internalCurve}constructor(){this.constant=0,this.constantMin=0,this.constantMax=0,this.multiplier=1,this._mode=kat.Constant}evaluate(t,e){switch(this._mode){default:case kat.Constant:return this.constant;case kat.Curve:return this.spline.evaluate(t)*this.multiplier;case kat.TwoCurves:return yi(this.splineMin.evaluate(t),this.splineMax.evaluate(t),e)*this.multiplier;case kat.TwoConstants:return yi(this.constantMin,this.constantMax,e)}}getMax(){switch(this._mode){default:case kat.Constant:return this.constant;case kat.Curve:return this.multiplier;case kat.TwoConstants:return this.constantMax;case kat.TwoCurves:return this.multiplier}}isZero(){switch(this._mode){default:case kat.Constant:return gi(this.constant,0,pi);case kat.Curve:return gi(this.multiplier,0,pi);case kat.TwoConstants:return gi(Math.max(Math.abs(this.constantMax),Math.abs(this.constantMin)),0,pi);case kat.TwoCurves:return gi(this.multiplier,0,pi)}}_onBeforeSerialize(t){return zat[this._mode]}},Lat.Mode=kat,Oat=Lat))||Oat);function Uat(t,e,i){switch(t.mode){case kat.Constant:return t.constant;case kat.Curve:return t.spline.evaluate(e)*t.multiplier;case kat.TwoCurves:return 0===i?t.splineMin.evaluate(e)*t.multiplier:t.splineMax.evaluate(e)*t.multiplier;case kat.TwoConstants:return 0===i?t.constantMin:t.constantMax;default:return 0}}function Vat(t){switch(t.mode){case kat.TwoConstants:case kat.TwoCurves:return 2;default:return 1}}function Hat(t,e,i){const s=new j_({width:e,height:i,_data:t,_compressed:!1,format:44}),r=new qf;return r.setFilters(1,1),r.setMipFilter(0),r.setWrapMode(2,2,2),r.image=s,r}function Gat(t,e,i,s){return null===t||i!==t.width||s!==t.height?(t&&t.destroy(),t=Hat(e,i,s)):t.uploadData(e),t}function Wat(t,e,i,s){const r=Vat(s),n=i*r*4;null!==e&&e.length===n||(e=new Float32Array(i*r*4));const o=1/(i-1);let a=0;for(let t=0;t<r;t++)for(let r=0;r<i;r++){const i=Uat(s,o*r,t);e[a+2]=i,a+=4}return{texture:Gat(t,e,i,r),texdata:e}}function jat(t,e,i,s){const r=Vat(s),n=i*r*4;null!==e&&e.length===n||(e=new Float32Array(i*r*4));const o=1/(i-1);let a=0,h=0;for(let t=0;t<r;t++)for(let r=0;r<i;r++)a=Uat(s,o*r,t),e[h]=a,e[h+1]=a,e[h+2]=a,h+=4;return{texture:Gat(t,e,i,r),texdata:e}}function $at(t,e,i,s,r){const n=Math.max(Vat(s),Vat(r)),o=i*n*4;null!==e&&e.length===o||(e=new Float32Array(i*n*4));const a=[s,r],h=1/(i-1);for(let t=0;t<n;t++)for(let s=0;s<2;s++){const r=a[s];let n=0;for(let o=0;o<i;o++)n=Uat(r,h*o,t),e[4*(t*i+o)+s]=n}return{texture:Gat(t,e,i,n),texdata:e}}function qat(t,e,i,s,r,n,o){const a=Math.max(Vat(s),Vat(r),Vat(n)),h=i*a*4;null!==e&&e.length===h||(e=new Float32Array(i*a*4));const l=[s,r,n],c=1/(i-1);for(let t=0;t<a;t++)for(let s=0;s<3;s++){const r=l[s];let n=0,a=0;for(let h=0;h<i;h++){const l=Uat(r,c*h,t);o?a=l:(n+=l,a=n/(h+1)),e[4*(t*i+h)+s]=a}}return{texture:Gat(t,e,i,a),texdata:e}}function Xat(t,e,i,s,r,n,o){const a=Math.max(Vat(s),Vat(r),Vat(n),Vat(o)),h=i*a*4;null!==e&&e.length===h||(e=new Float32Array(i*a*4));const l=[s,r,n,o],c=1/(i-1);for(let t=0;t<a;t++)for(let s=0;s<4;s++){const r=l[s];let n=0,o=0;for(let a=0;a<i;a++)n+=Uat(r,c*a,t),o=n/(a+1),e[4*(t*i+a)+s]=o}return{texture:Gat(t,e,i,a),texdata:e}}var Yat,Qat,Kat,Zat,Jat,tht,eht,iht,sht,rht,nht,oht,aht,hht,lht,cht;ri.fastDefine("cc.CurveRange",Nat,{multiplier:1,constantMax:0,constantMin:0,constant:0,mode:kat.Constant,splineMax:Object.freeze(wc()),splineMin:Object.freeze(wc()),spline:Object.freeze(wc())}),Fat(Nat,"multiplier","visible",!0),Fat(Nat,"constantMax","visible",!0),Fat(Nat,"constantMin","visible",!0),Fat(Nat,"constant","visible",!0),We(Nat,"mode",kat),Fat(Nat,"mode","visible",!0),Fat(Nat,"splineMax","type","Object"),Fat(Nat,"splineMax","ctor",nl),Fat(Nat,"splineMax","visible",!0),Fat(Nat,"splineMin","type","Object"),Fat(Nat,"splineMin","ctor",nl),Fat(Nat,"splineMin","visible",!0),Fat(Nat,"spline","type","Object"),Fat(Nat,"spline","ctor",nl),Fat(Nat,"spline","visible",!0);const uht=te({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),dht=new _r,pht=new _r;let _ht=t("GradientRange",(Yat=oa("cc.GradientRange"),Qat=Ga(uht),Kat=Ga(_c),Zat=Ga(_c),Jat=Ga(_c),tht=Ga(uht),Yat((cht=class{constructor(){this.color=sht&&sht(),this.colorMin=rht&&rht(),this.colorMax=nht&&nht(),this.gradient=oht&&oht(),this.gradientMin=aht&&aht(),this.gradientMax=hht&&hht(),this._mode=lht&&lht(),this._color=_r.WHITE.clone()}get mode(){return this._mode}set mode(t){this._mode=t}evaluate(t,e){switch(this._mode){case uht.Color:return this.color;case uht.TwoColors:return _r.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case uht.RandomColor:return this.gradient.getRandomColor(this._color);case uht.Gradient:return this.gradient.evaluateFast(this._color,t);case uht.TwoGradients:return _r.lerp(this._color,this.gradientMin.evaluateFast(dht,t),this.gradientMax.evaluateFast(pht,t),e),this._color;default:return this.color}}_onBeforeSerialize(t){return(!1)[this._mode]}},cht.Mode=uht,s((iht=cht).prototype,"mode",[Qat],Object.getOwnPropertyDescriptor(iht.prototype,"mode"),iht.prototype),sht=Qo(iht.prototype,"color",[va],(function(){return _r.WHITE.clone()})),rht=Qo(iht.prototype,"colorMin",[va],(function(){return _r.WHITE.clone()})),nht=Qo(iht.prototype,"colorMax",[va],(function(){return _r.WHITE.clone()})),oht=Qo(iht.prototype,"gradient",[Kat],(function(){return new _c})),aht=Qo(iht.prototype,"gradientMin",[Zat],(function(){return new _c})),hht=Qo(iht.prototype,"gradientMax",[Jat],(function(){return new _c})),lht=Qo(iht.prototype,"_mode",[tht],(function(){return uht.Color})),eht=iht))||eht));function ght(t,e,i){switch(t.mode){case uht.Color:return t.color;case uht.TwoColors:return 0===i?t.colorMin:t.colorMax;case uht.RandomColor:return t.gradient.getRandomColor(dht);case uht.Gradient:return t.gradient.evaluateFast(dht,e);case uht.TwoGradients:return 0===i?t.gradientMin.evaluateFast(dht,e):t.gradientMax.evaluateFast(dht,e);default:return t.color}}function fht(t){switch(t.mode){case uht.TwoColors:case uht.TwoGradients:return 2;default:return 1}}function mht(t,e,i,s){const r=fht(s),n=i*r*4;null!==e&&e.length===n||(e=new Uint8Array(i*r*4));const o=1/(i-1);let a=0;for(let t=0;t<r;t++)for(let r=0;r<i;r++){const i=ght(s,o*r,t);e[a]=i.r,e[a+1]=i.g,e[a+2]=i.b,e[a+3]=i.a,a+=4}return null!==t&&i===t.width&&r===t.height||(t&&t.destroy(),(t=new qf).create(i,r,35),t.setFilters(2,2),t.setWrapMode(2,2)),t.uploadData(e),{texture:t,texdata:e}}var yht,vht,bht,wht,Sht,xht,Tht,Cht,Iht,Eht,Dht,Aht,Mht,Pht,Bht,Rht,Oht,Lht,Fht,zht;const kht="CC_USE_WORLD_SPACE",Nht={CC_USE_WORLD_SPACE:!1,CC_USE_WORLD_SCALE:!0};t("Line",(yht=oa("cc.Line"),vht=Ga(qf),bht=Ga(qf),wht=Ga(Lw),Sht=Ga([Ki]),xht=Ga([Ki]),Tht=Ga(Nat),Cht=Ga(_ht),Iht=Ga(Qs),Eht=Ga(Qs),yht((Aht=class extends Rk{get texture(){return this._texture}set texture(t){this._texture=t,this.material&&this.material.setProperty("mainTexture",t)}get lineMaterial(){return this.getSharedMaterial(0)}set lineMaterial(t){this.setSharedMaterial(t,0)}get sharedMaterials(){return super.sharedMaterials}set sharedMaterials(t){super.sharedMaterials=t}get worldSpace(){return this._worldSpace}set worldSpace(t){this._worldSpace=t;const e=this.getMaterialInstance(0);e&&(Nht[kht]=this.worldSpace,e.recompileShaders(Nht),this._models[0]&&this._models[0].setSubModelMaterial(0,e))}get positions(){return this._positions}set positions(t){this._positions=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this.width,this.color)}get width(){return this._width}set width(t){this._width=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this._width,this._color)}get color(){return this._color}set color(t){this._color=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this._width,this._color)}get tile(){return this._tile}set tile(t){this._tile.set(t),this.material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this.material.setProperty("mainTiling_Offset",this._tile_offset))}get offset(){return this._offset}set offset(t){this._offset.set(t),this.material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this.material.setProperty("mainTiling_Offset",this._tile_offset))}constructor(){super(),this._texture=Mht&&Mht(),this._material=Pht&&Pht(),this._worldSpace=Bht&&Bht(),this._positions=Rht&&Rht(),this._width=Oht&&Oht(),this._color=Lht&&Lht(),this._tile=Fht&&Fht(),this._tile_offset=new cr,this._offset=zht&&zht()}onLoad(){const t=h.director.root.createModel(Rat);if(0===this._models.length?this._models.push(t):this._models[0]=t,t.node=t.transform=this.node,this._material&&(this.lineMaterial=this._material,this._material=null),null===this.lineMaterial){const t=pw.get("default-trail-material");this.material=t}const e=this.getMaterialInstance(0);e&&(Nht[kht]=this.worldSpace,e.recompileShaders(Nht),t.updateMaterial(e)),t.setCapacity(100)}onEnable(){super.onEnable(),0!==this._models.length&&this._models[0]&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._models[0].addLineVertexData(this._positions,this.width,this.color))}onDisable(){this._models.length>0&&this._models[0]&&this._detachFromScene()}_attachToScene(){if(super._attachToScene(),this._models.length>0&&this._models[0]&&this.node&&this.node.scene){const t=this._models[0];t.scene&&this._detachFromScene(),this._getRenderScene().addModel(t)}}_detachFromScene(){if(super._detachFromScene(),this._models.length>0&&this._models[0]){const t=this._models[0];t.scene&&t.scene.removeModel(t)}}_onMaterialModified(t,e){super._onMaterialModified(t,e);const i=this.getMaterialInstance(0);i&&(Nht[kht]=this.worldSpace,i.recompileShaders(Nht),this._models[0])&&this._models[0].updateMaterial(i)}},Mht=Qo(Aht.prototype,"_texture",[vht],(function(){return null})),s(Aht.prototype,"texture",[bht],Object.getOwnPropertyDescriptor(Aht.prototype,"texture"),Aht.prototype),Pht=Qo(Aht.prototype,"_material",[va],(function(){return null})),s(Aht.prototype,"lineMaterial",[wht],Object.getOwnPropertyDescriptor(Aht.prototype,"lineMaterial"),Aht.prototype),s(Aht.prototype,"sharedMaterials",[Wa,va],Object.getOwnPropertyDescriptor(Aht.prototype,"sharedMaterials"),Aht.prototype),Bht=Qo(Aht.prototype,"_worldSpace",[va],(function(){return!1})),Rht=Qo(Aht.prototype,"_positions",[Sht],(function(){return[]})),s(Aht.prototype,"positions",[xht],Object.getOwnPropertyDescriptor(Aht.prototype,"positions"),Aht.prototype),s(Aht.prototype,"width",[Tht],Object.getOwnPropertyDescriptor(Aht.prototype,"width"),Aht.prototype),Oht=Qo(Aht.prototype,"_width",[va],(function(){return new Nat})),s(Aht.prototype,"color",[Cht],Object.getOwnPropertyDescriptor(Aht.prototype,"color"),Aht.prototype),Lht=Qo(Aht.prototype,"_color",[va],(function(){return new _ht})),Fht=Qo(Aht.prototype,"_tile",[va],(function(){return new Qs(1,1)})),s(Aht.prototype,"tile",[Iht],Object.getOwnPropertyDescriptor(Aht.prototype,"tile"),Aht.prototype),zht=Qo(Aht.prototype,"_offset",[va],(function(){return new Qs(0,0)})),s(Aht.prototype,"offset",[Eht],Object.getOwnPropertyDescriptor(Aht.prototype,"offset"),Aht.prototype),Dht=Aht))||Dht));class Uht{constructor(t){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new Ki(0,0,0),this.velocity=new Ki(0,0,0),this.animatedVelocity=new Ki(0,0,0),this.ultimateVelocity=new Ki(0,0,0),this.angularVelocity=new Ki(0,0,0),this.axisOfRotation=new Ki(0,0,0),this.rotation=new Ki(0,0,0),this.startEuler=new Ki(0,0,0),this.startRotation=new ys,this.startRotated=!1,this.deltaQuat=new ys,this.deltaMat=new Rs,this.localMat=new Rs,this.startSize=new Ki(0,0,0),this.size=new Ki(0,0,0),this.startColor=_r.WHITE.clone(),this.color=_r.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}reset(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()}}Uht.INDENTIFY_NEG_QUAT=10,Uht.R2D=180/Math.PI;const Vht="noiseModule",Hht=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule","noiseModule"],Ght=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule","_trailModule"];class Wht{constructor(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}bindTarget(t){this.target=t}update(t,e){}}const jht=te({World:0,Local:1,Custom:2}),$ht=te({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),qht=te({World:0,Local:1,View:2}),Xht=te({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),Yht=te({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),Qht=te({Base:0,Edge:1,Shell:2,Volume:3}),Kht=te({Random:0,Loop:1,PingPong:2}),Zht=te({Particles:0}),Jht=te({Stretch:0}),tlt=new Ki(0,0,-1);function elt(t,e,i,s){return e!==t?(t===jht.World||Rs.invert(i,i),Rs.getRotation(s,i),!0):(ys.set(s,0,0,0,1),!1)}function ilt(t,e){Qs.set(t,Math.cos(e),Math.sin(e))}function slt(t){const e=xi(-1,1),i=xi(0,2*Math.PI),s=Math.sqrt(1-e*e),r=s*Math.cos(i),n=s*Math.sin(i);Ki.set(t,r,n,e)}function rlt(t,e,i){slt(t),Ki.multiplyScalar(t,t,e+(i-e)*wi())}function nlt(t,e,i,s){ilt(t,s),t.z=0,Ki.multiplyScalar(t,t,e+(i-e)*wi())}function olt(t){for(let e=0;e<t.length;e++){const i=e+Ti(0,t.length-e),s=t[i];t[i]=t[e],t[e]=s}}function alt(){let t=xi(-1,1);return 0===t&&t++,p(t)}function hlt(t){const e=Nat.Mode;switch(t.mode){case e.TwoCurves:case e.TwoConstants:return!0;default:return!1}}function llt(t){const e=_ht.Mode;switch(t.mode){case e.TwoGradients:case e.TwoColors:return!0;default:return!1}}var clt,ult,dlt,plt,_lt,glt;let flt=(clt=oa("cc.ColorOvertimeModule"),ult=Ga(_ht),clt((plt=class extends Wht{constructor(){super(),this._enable=_lt&&_lt(),this.color=glt&&glt(),this.name="colorModule"}get enable(){return this._enable}set enable(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}animate(t){t.color.set(t.startColor);const e=llt(this.color)?Ci(t.randomSeed+91041):0;t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,e))}},_lt=Qo(plt.prototype,"_enable",[va],(function(){return!1})),glt=Qo(plt.prototype,"color",[ult,va],(function(){return new _ht})),dlt=plt))||dlt);var mlt,ylt,vlt,blt,wlt,Slt,xlt,Tlt,Clt,Ilt,Elt,Dlt;const Alt=212165,Mlt=new Ki;let Plt=(mlt=oa("cc.ForceOvertimeModule"),ylt=Ga(Nat),vlt=Ga(Nat),blt=Ga(Nat),wlt=Ga(jht),mlt((xlt=class extends Wht{get enable(){return this._enable}set enable(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}constructor(){super(),this._enable=Tlt&&Tlt(),this.x=Clt&&Clt(),this.y=Ilt&&Ilt(),this.z=Elt&&Elt(),this.space=Dlt&&Dlt(),this.randomized=!1,this.rotation=void 0,this.needTransform=void 0,this.name="forceModule",this.rotation=new ys,this.needTransform=!1,this.needUpdate=!0}update(t,e){this.needTransform=elt(t,this.space,e,this.rotation)}animate(t,e){const i=1-t.remainingLifetime/t.startLifetime,s=hlt(this.x)?Ci(t.randomSeed+Alt):0,r=hlt(this.y)?Ci(t.randomSeed+Alt):0,n=hlt(this.z)?Ci(t.randomSeed+Alt):0,o=Ki.set(Mlt,this.x.evaluate(i,s),this.y.evaluate(i,r),this.z.evaluate(i,n));this.needTransform&&Ki.transformQuat(o,o,this.rotation),Ki.scaleAndAdd(t.velocity,t.velocity,o,e),Ki.copy(t.ultimateVelocity,t.velocity)}},Tlt=Qo(xlt.prototype,"_enable",[va],(function(){return!1})),Clt=Qo(xlt.prototype,"x",[ylt,va],(function(){return new Nat})),Ilt=Qo(xlt.prototype,"y",[vlt,va],(function(){return new Nat})),Elt=Qo(xlt.prototype,"z",[blt,va],(function(){return new Nat})),Dlt=Qo(xlt.prototype,"space",[wlt,va],(function(){return jht.Local})),Slt=xlt))||Slt);var Blt,Rlt,Olt,Llt,Flt,zlt,klt,Nlt,Ult,Vlt,Hlt,Glt,Wlt,jlt,$lt,qlt;const Xlt=23541,Ylt=new Ki,Qlt=new Ki;let Klt=(Blt=oa("cc.LimitVelocityOvertimeModule"),Rlt=Ga(Nat),Olt=Ga(Nat),Llt=Ga(Nat),Flt=Ga(Nat),zlt=Ga(jht),Blt((Nlt=class extends Wht{get enable(){return this._enable}set enable(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}constructor(){super(),this._enable=Ult&&Ult(),this.limitX=Vlt&&Vlt(),this.limitY=Hlt&&Hlt(),this.limitZ=Glt&&Glt(),this.limit=Wlt&&Wlt(),this.dampen=jlt&&jlt(),this.separateAxes=$lt&&$lt(),this.space=qlt&&qlt(),this.drag=null,this.multiplyDragByParticleSize=!1,this.multiplyDragByParticleVelocity=!1,this.name="limitModule",this.rotation=void 0,this.needTransform=void 0,this.rotation=new ys,this.needTransform=!1,this.needUpdate=!0}update(t,e){this.needTransform=elt(t,this.space,e,this.rotation)}animate(t,e){const i=1-t.remainingLifetime/t.startLifetime,s=Ylt;if(this.separateAxes){const e=hlt(this.limitX)?Ci(t.randomSeed+Xlt):0,r=hlt(this.limitY)?Ci(t.randomSeed+Xlt):0,n=hlt(this.limitZ)?Ci(t.randomSeed+Xlt):0;Ki.set(Qlt,this.limitX.evaluate(i,e),this.limitY.evaluate(i,r),this.limitZ.evaluate(i,n)),this.needTransform&&Ki.transformQuat(Qlt,Qlt,this.rotation),Ki.set(s,Zlt(t.ultimateVelocity.x,Qlt.x,this.dampen),Zlt(t.ultimateVelocity.y,Qlt.y,this.dampen),Zlt(t.ultimateVelocity.z,Qlt.z,this.dampen))}else{Ki.normalize(s,t.ultimateVelocity);const e=hlt(this.limit)?Ci(t.randomSeed+Xlt):0;Ki.multiplyScalar(s,s,Zlt(t.ultimateVelocity.length(),this.limit.evaluate(i,e),this.dampen))}Ki.copy(t.ultimateVelocity,s),Ki.copy(t.velocity,t.ultimateVelocity)}},Ult=Qo(Nlt.prototype,"_enable",[va],(function(){return!1})),Vlt=Qo(Nlt.prototype,"limitX",[Rlt,va],(function(){return new Nat})),Hlt=Qo(Nlt.prototype,"limitY",[Olt,va],(function(){return new Nat})),Glt=Qo(Nlt.prototype,"limitZ",[Llt,va],(function(){return new Nat})),Wlt=Qo(Nlt.prototype,"limit",[Flt,va],(function(){return new Nat})),jlt=Qo(Nlt.prototype,"dampen",[va],(function(){return 3})),$lt=Qo(Nlt.prototype,"separateAxes",[va],(function(){return!1})),qlt=Qo(Nlt.prototype,"space",[zlt,va],(function(){return jht.Local})),klt=Nlt))||klt);function Zlt(t,e,i){const s=Math.sign(t);let r=Math.abs(t);if(r>e){const t=r-r*i;r=t>e?t:e}return r*s}var Jlt,tct,ect,ict,sct,rct,nct,oct,act,hct,lct;const cct=125292;let uct=(Jlt=oa("cc.RotationOvertimeModule"),tct=Ga(Nat),ect=Ga(Nat),ict=Ga(Nat),Jlt((rct=class extends Wht{constructor(){super(),this._enable=nct&&nct(),this._separateAxes=oct&&oct(),this.x=act&&act(),this.y=hct&&hct(),this.z=lct&&lct(),this.name="rotationModule",this._startMat=new Rs,this._matRot=new Rs,this._quatRot=new ys,this._otherEuler=new Ki}get enable(){return this._enable}set enable(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}get separateAxes(){return this._separateAxes}set separateAxes(t){this._separateAxes=t}_processRotation(t,e){const i=t.particleSystem.processor.getInfo().renderMode;i!==Xht.Mesh&&i===Xht.StrecthedBillboard&&this._quatRot.set(0,0,0,1),ys.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=Uht.INDENTIFY_NEG_QUAT)}animate(t,e){const i=1-t.remainingLifetime/t.startLifetime,s=hlt(this.z)?Ci(t.randomSeed+cct):0,r=t.particleSystem.processor.getInfo().renderMode;if(this._separateAxes&&r!==Xht.VerticalBillboard&&r!==Xht.HorizontalBillboard){const r=hlt(this.x)?Ci(t.randomSeed+cct):0,n=hlt(this.y)?Ci(t.randomSeed+cct):0;ys.fromEuler(t.deltaQuat,this.x.evaluate(i,r)*e*Uht.R2D,this.y.evaluate(i,n)*e*Uht.R2D,this.z.evaluate(i,s)*e*Uht.R2D)}else ys.fromEuler(t.deltaQuat,0,0,this.z.evaluate(i,s)*e*Uht.R2D);t.deltaMat=Rs.fromQuat(t.deltaMat,t.deltaQuat),t.localMat=t.localMat.multiply(t.deltaMat),t.startRotated||(r!==Xht.Mesh&&(r===Xht.StrecthedBillboard?t.startEuler.set(0,0,0):r!==Xht.Billboard&&t.startEuler.set(0,0,t.startEuler.z)),ys.fromEuler(t.startRotation,t.startEuler.x*Uht.R2D,t.startEuler.y*Uht.R2D,t.startEuler.z*Uht.R2D),t.startRotated=!0),this._startMat=Rs.fromQuat(this._startMat,t.startRotation),this._matRot=this._startMat.multiply(t.localMat),Rs.getRotation(this._quatRot,this._matRot),this._processRotation(t,Uht.R2D),t.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)}},nct=Qo(rct.prototype,"_enable",[va],(function(){return!1})),oct=Qo(rct.prototype,"_separateAxes",[va],(function(){return!1})),act=Qo(rct.prototype,"x",[tct,va],(function(){return new Nat})),hct=Qo(rct.prototype,"y",[ect,va],(function(){return new Nat})),lct=Qo(rct.prototype,"z",[ict,va],(function(){return new Nat})),sct=rct))||sct);var dct,pct,_ct,gct,fct,mct,yct,vct,bct,wct,Sct,xct,Tct;const Cct=39825;let Ict=(dct=oa("cc.SizeOvertimeModule"),pct=Ga(Nat),_ct=Ga(Nat),gct=Ga(Nat),fct=Ga(Nat),dct((yct=class extends Wht{constructor(){super(),this._enable=vct&&vct(),this.separateAxes=bct&&bct(),this.size=wct&&wct(),this.x=Sct&&Sct(),this.y=xct&&xct(),this.z=Tct&&Tct(),this.name="sizeModule"}get enable(){return this._enable}set enable(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}animate(t,e){if(this.separateAxes){const e=1-t.remainingLifetime/t.startLifetime,i=hlt(this.x)?Ci(t.randomSeed+Cct):0,s=hlt(this.y)?Ci(t.randomSeed+Cct):0,r=hlt(this.z)?Ci(t.randomSeed+Cct):0;t.size.x=t.startSize.x*this.x.evaluate(e,i),t.size.y=t.startSize.y*this.y.evaluate(e,s),t.size.z=t.startSize.z*this.z.evaluate(e,r)}else{const e=hlt(this.size)?Ci(t.randomSeed+Cct):0;Ki.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,e))}}},vct=Qo(yct.prototype,"_enable",[va],(function(){return!1})),bct=Qo(yct.prototype,"separateAxes",[va],(function(){return!1})),wct=Qo(yct.prototype,"size",[pct,va],(function(){return new Nat})),Sct=Qo(yct.prototype,"x",[_ct,va],(function(){return new Nat})),xct=Qo(yct.prototype,"y",[gct,va],(function(){return new Nat})),Tct=Qo(yct.prototype,"z",[fct,va],(function(){return new Nat})),mct=yct))||mct);var Ect,Dct,Act,Mct,Pct,Bct,Rct,Oct,Lct,Fct,zct,kct,Nct,Uct,Vct,Hct,Gct,Wct,jct,$ct,qct,Xct,Yct;const Qct=te({Grid:0}),Kct=te({WholeSheet:0,SingleRow:1});let Zct=(Ect=oa("cc.TextureAnimationModule"),Dct=ba("numTilesX"),Act=ba("numTilesY"),Mct=Ga(Qct),Pct=Ga(Qct),Bct=Ga(Kct),Rct=Ga(Nat),Oct=Ga(Nat),Ect((Fct=class extends Wht{constructor(){super(),this._enable=zct&&zct(),this._numTilesX=kct&&kct(),this._numTilesY=Nct&&Nct(),this._mode=Uct&&Uct(),this.animation=Vct&&Vct(),this.frameOverTime=Hct&&Hct(),this.startFrame=Gct&&Gct(),this.cycleCount=Wct&&Wct(),this._flipU=jct&&jct(),this._flipV=$ct&&$ct(),this._uvChannelMask=qct&&qct(),this.randomRow=Xct&&Xct(),this.rowIndex=Yct&&Yct(),this.name="textureModule"}get enable(){return this._enable}set enable(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}get mode(){return this._mode}set mode(t){t!==Qct.Grid&&B("particle texture animation's sprites is not supported!")}get numTilesX(){return this._numTilesX}set numTilesX(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}get numTilesY(){return this._numTilesY}set numTilesY(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}get flipU(){return this._flipU}set flipU(t){B("particle texture animation's flipU is not supported!")}get flipV(){return this._flipV}set flipV(t){B("particle texture animation's flipV is not supported!")}get uvChannelMask(){return this._uvChannelMask}set uvChannelMask(t){B("particle texture animation's uvChannelMask is not supported!")}init(t){t.startRow=Math.floor(wi()*this.numTilesY)}animate(t,e){const i=1-t.remainingLifetime/t.startLifetime,s=hlt(this.startFrame)?Ci(t.randomSeed+90794):0,r=hlt(this.frameOverTime)?Ci(t.randomSeed+90794):0,n=this.startFrame.evaluate(i,s)/(this.numTilesX*this.numTilesY);if(this.animation===Kct.WholeSheet)t.frameIndex=Ai(this.cycleCount*(this.frameOverTime.evaluate(i,r)+n),1);else if(this.animation===Kct.SingleRow){const e=1/this.numTilesY;if(this.randomRow){const s=Ai(this.cycleCount*(this.frameOverTime.evaluate(i,r)+n),1),o=t.startRow*e,a=o+e;t.frameIndex=yi(o,a,s)}else{const s=this.rowIndex*e,o=s+e;t.frameIndex=yi(s,o,Ai(this.cycleCount*(this.frameOverTime.evaluate(i,r)+n),1))}}}},zct=Qo(Fct.prototype,"_enable",[va],(function(){return!1})),kct=Qo(Fct.prototype,"_numTilesX",[Dct],(function(){return 0})),Nct=Qo(Fct.prototype,"_numTilesY",[Act],(function(){return 0})),Uct=Qo(Fct.prototype,"_mode",[Mct],(function(){return Qct.Grid})),s(Fct.prototype,"mode",[Pct],Object.getOwnPropertyDescriptor(Fct.prototype,"mode"),Fct.prototype),Vct=Qo(Fct.prototype,"animation",[Bct,va],(function(){return Kct.WholeSheet})),Hct=Qo(Fct.prototype,"frameOverTime",[Rct,va],(function(){return new Nat})),Gct=Qo(Fct.prototype,"startFrame",[Oct,va],(function(){return new Nat})),Wct=Qo(Fct.prototype,"cycleCount",[va],(function(){return 0})),jct=Qo(Fct.prototype,"_flipU",[va],(function(){return 0})),$ct=Qo(Fct.prototype,"_flipV",[va],(function(){return 0})),qct=Qo(Fct.prototype,"_uvChannelMask",[va],(function(){return-1})),Xct=Qo(Fct.prototype,"randomRow",[va],(function(){return!1})),Yct=Qo(Fct.prototype,"rowIndex",[va],(function(){return 0})),Lct=Fct))||Lct);var Jct,tut,eut,iut,sut,rut,nut,out,aut,hut,lut,cut,uut,dut;const put=197866,_ut=new Ki;let gut=(Jct=oa("cc.VelocityOvertimeModule"),tut=Ga(Nat),eut=Ga(Nat),iut=Ga(Nat),sut=Ga(Nat),rut=Ga(jht),Jct((out=class extends Wht{get enable(){return this._enable}set enable(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}constructor(){super(),this._enable=aut&&aut(),this.x=hut&&hut(),this.y=lut&&lut(),this.z=cut&&cut(),this.speedModifier=uut&&uut(),this.space=dut&&dut(),this.rotation=void 0,this.needTransform=void 0,this.name="velocityModule",this.rotation=new ys,this.speedModifier.constant=1,this.needTransform=!1,this.needUpdate=!0}update(t,e){this.needTransform=elt(t,this.space,e,this.rotation)}animate(t,e){const i=1-t.remainingLifetime/t.startLifetime,s=hlt(this.x)?Ci(t.randomSeed^put):0,r=hlt(this.y)?Ci(156497^t.randomSeed):0,n=hlt(this.z)?Ci(984136^t.randomSeed):0,o=hlt(this.speedModifier)?Ci(t.randomSeed+put):0,a=Ki.set(_ut,this.x.evaluate(i,s),this.y.evaluate(i,r),this.z.evaluate(i,n));this.needTransform&&Ki.transformQuat(a,a,this.rotation),Ki.add(t.animatedVelocity,t.animatedVelocity,a),Ki.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),Ki.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,this.speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,o))}},aut=Qo(out.prototype,"_enable",[va],(function(){return!1})),hut=Qo(out.prototype,"x",[tut,va],(function(){return new Nat})),lut=Qo(out.prototype,"y",[eut,va],(function(){return new Nat})),cut=Qo(out.prototype,"z",[iut,va],(function(){return new Nat})),uut=Qo(out.prototype,"speedModifier",[sut,va],(function(){return new Nat})),dut=Qo(out.prototype,"space",[rut,va],(function(){return jht.Local})),nut=out))||nut);var fut,mut,yut,vut,but,wut,Sut,xut;let Tut=t("Burst",(fut=oa("cc.Burst"),mut=Ga(Nat),fut((vut=class{get time(){return this._time}set time(t){this._time=t,this._curTime=t}get repeatCount(){return this._repeatCount}set repeatCount(t){this._repeatCount=t,this._remainingCount=t}constructor(){this._time=but&&but(),this._repeatCount=wut&&wut(),this.repeatInterval=Sut&&Sut(),this.count=xut&&xut(),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}update(t,e){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){let i=Ai(t.time-t.startDelay.evaluate(0,1),t.duration)-e;i=i>0?i:0;const s=Ai(t.time-t.startDelay.evaluate(0,1),t.duration);this._curTime>=i&&this._curTime<s&&(t.emit(this.count.evaluate(this._curTime/t.duration,1),e-(s-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}reset(){this._remainingCount=0,this._curTime=0}getMaxCount(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)}},but=Qo(vut.prototype,"_time",[va],(function(){return 0})),wut=Qo(vut.prototype,"_repeatCount",[va],(function(){return 1})),Sut=Qo(vut.prototype,"repeatInterval",[va],(function(){return 1})),xut=Qo(vut.prototype,"count",[mut,va],(function(){return new Nat})),yut=vut))||yut));var Cut,Iut,Eut,Dut,Aut,Mut,Put,But,Rut,Out,Lut,Fut,zut,kut,Nut,Uut,Vut,Hut,Gut,Wut,jut,$ut,qut,Xut,Yut,Qut,Kut,Zut;const Jut=new Ki(0,0,0),tdt=[0,0,0],edt=new Ki(.5,.5,.5);let idt=(Cut=oa("cc.ShapeModule"),Iut=Ga(Yht),Eut=ba("shapeType"),Dut=Ga(Yht),Aut=Ga(Qht),Mut=Ga(Kht),Put=Ga(Nat),Cut((Rut=class{get position(){return this._position}set position(t){this._position=t,this.constructMat()}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this.constructMat()}get scale(){return this._scale}set scale(t){this._scale=t,this.constructMat()}get arc(){return bi(this._arc)}set arc(t){this._arc=vi(t)}get angle(){return Math.round(100*bi(this._angle))/100}set angle(t){this._angle=vi(t)}get enable(){return this._enable}set enable(t){this._enable=t}get shapeType(){return this._shapeType}set shapeType(t){switch(this._shapeType=t,this._shapeType){case Yht.Box:this.emitFrom===Qht.Base&&(this.emitFrom=Qht.Volume);break;case Yht.Cone:this.emitFrom===Qht.Edge&&(this.emitFrom=Qht.Base);break;case Yht.Sphere:case Yht.Hemisphere:this.emitFrom!==Qht.Base&&this.emitFrom!==Qht.Edge||(this.emitFrom=Qht.Volume)}}constructor(){this._enable=Out&&Out(),this._shapeType=Lut&&Lut(),this.emitFrom=Fut&&Fut(),this.alignToDirection=zut&&zut(),this.randomDirectionAmount=kut&&kut(),this.sphericalDirectionAmount=Nut&&Nut(),this.randomPositionAmount=Uut&&Uut(),this.radius=Vut&&Vut(),this.radiusThickness=Hut&&Hut(),this.arcMode=Gut&&Gut(),this.arcSpread=Wut&&Wut(),this.arcSpeed=jut&&jut(),this.length=$ut&&$ut(),this.boxThickness=qut&&qut(),this._position=Xut&&Xut(),this._rotation=Yut&&Yut(),this._scale=Qut&&Qut(),this._arc=Kut&&Kut(),this._angle=Zut&&Zut(),this.mat=new Rs,this.quat=new ys,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}onInit(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem.time}emit(t){switch(this.shapeType){case Yht.Box:odt(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case Yht.Circle:adt(this.radius,this.radiusThickness,this.generateArcAngle(),t.position,t.velocity);break;case Yht.Cone:ndt(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case Yht.Sphere:sdt(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case Yht.Hemisphere:rdt(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:P(`${this.shapeType} shapeType is not supported by ShapeModule.`)}if(this.randomPositionAmount>0&&(t.position.x+=xi(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=xi(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=xi(-this.randomPositionAmount,this.randomPositionAmount)),Ki.transformQuat(t.velocity,t.velocity,this.quat),Ki.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){const e=Ki.normalize(Jut,t.position);Ki.lerp(t.velocity,t.velocity,e,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem.time}constructMat(){ys.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Rs.fromRTS(this.mat,this.quat,this._position,this._scale)}generateArcAngle(){if(this.arcMode===Kht.Random)return xi(0,this._arc);let t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem.time,1)*(this.particleSystem.time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case Kht.Loop:return Ai(t,this._arc);case Kht.PingPong:return Mi(t,this._arc);default:return Ai(t,this._arc)}}},Out=Qo(Rut.prototype,"_enable",[va],(function(){return!1})),Lut=Qo(Rut.prototype,"_shapeType",[Iut,Eut],(function(){return Yht.Cone})),s(Rut.prototype,"shapeType",[Dut],Object.getOwnPropertyDescriptor(Rut.prototype,"shapeType"),Rut.prototype),Fut=Qo(Rut.prototype,"emitFrom",[Aut,va],(function(){return Qht.Volume})),zut=Qo(Rut.prototype,"alignToDirection",[va],(function(){return!1})),kut=Qo(Rut.prototype,"randomDirectionAmount",[va],(function(){return 0})),Nut=Qo(Rut.prototype,"sphericalDirectionAmount",[va],(function(){return 0})),Uut=Qo(Rut.prototype,"randomPositionAmount",[va],(function(){return 0})),Vut=Qo(Rut.prototype,"radius",[va],(function(){return 1})),Hut=Qo(Rut.prototype,"radiusThickness",[va],(function(){return 1})),Gut=Qo(Rut.prototype,"arcMode",[Mut,va],(function(){return Kht.Random})),Wut=Qo(Rut.prototype,"arcSpread",[va],(function(){return 0})),jut=Qo(Rut.prototype,"arcSpeed",[Put,va],(function(){return new Nat})),$ut=Qo(Rut.prototype,"length",[va],(function(){return 5})),qut=Qo(Rut.prototype,"boxThickness",[va],(function(){return new Ki(0,0,0)})),Xut=Qo(Rut.prototype,"_position",[va],(function(){return new Ki(0,0,0)})),Yut=Qo(Rut.prototype,"_rotation",[va],(function(){return new Ki(0,0,0)})),Qut=Qo(Rut.prototype,"_scale",[va],(function(){return new Ki(1,1,1)})),Kut=Qo(Rut.prototype,"_arc",[va],(function(){return vi(360)})),Zut=Qo(Rut.prototype,"_angle",[va],(function(){return vi(25)})),But=Rut))||But);function sdt(t,e,i,s,r){switch(t){case Qht.Volume:rlt(s,e*(1-i),e),Ki.normalize(r,s);break;case Qht.Shell:slt(s),Ki.multiplyScalar(s,s,e),Ki.normalize(r,s);break;default:P(`${t} is not supported for sphere emitter.`)}}function rdt(t,e,i,s,r){switch(t){case Qht.Volume:rlt(s,e*(1-i),e),s.z>0&&(s.z*=-1),Ki.normalize(r,s);break;case Qht.Shell:slt(s),Ki.multiplyScalar(s,s,e),s.z>0&&(s.z*=-1),Ki.normalize(r,s);break;default:P(`${t} is not supported for hemisphere emitter.`)}}function ndt(t,e,i,s,r,n,o,a){switch(t){case Qht.Base:nlt(o,e*(1-i),e,s),Qs.multiplyScalar(a,o,Math.sin(r)),a.z=-Math.cos(r)*e,Ki.normalize(a,a),o.z=0;break;case Qht.Shell:ilt(o,s),Qs.multiplyScalar(a,o,Math.sin(r)),a.z=-Math.cos(r),Ki.normalize(a,a),Qs.multiplyScalar(o,o,e),o.z=0;break;case Qht.Volume:nlt(o,e*(1-i),e,s),Qs.multiplyScalar(a,o,Math.sin(r)),a.z=-Math.cos(r)*e,Ki.normalize(a,a),o.z=0,Ki.add(o,o,Ki.multiplyScalar(Jut,a,n*wi()/-a.z));break;default:P(`${t} is not supported for cone emitter.`)}}function odt(t,e,i,s){switch(t){case Qht.Volume:r=i,n=edt,Ki.set(r,xi(-n.x,n.x),xi(-n.y,n.y),xi(-n.z,n.z));break;case Qht.Shell:tdt[0]=xi(-.5,.5),tdt[1]=xi(-.5,.5),tdt[2]=.5*alt(),olt(tdt),hdt(tdt,e),Ki.set(i,tdt[0],tdt[1],tdt[2]);break;case Qht.Edge:tdt[0]=xi(-.5,.5),tdt[1]=.5*alt(),tdt[2]=.5*alt(),olt(tdt),hdt(tdt,e),Ki.set(i,tdt[0],tdt[1],tdt[2]);break;default:P(`${t} is not supported for box emitter.`)}var r,n;Ki.copy(s,tlt)}function adt(t,e,i,s,r){nlt(s,t*(1-e),t,i),Ki.normalize(r,s)}function hdt(t,e){e.x>0&&(t[0]+=.5*xi(-e.x,e.x),t[0]=fi(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*xi(-e.y,e.y),t[1]=fi(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*xi(-e.z,e.z),t[2]=fi(t[2],-.5,.5))}const ldt=[0,0,1,0,0,1,1,1],cdt=[0,0,0,1,0,0,0,1,0,1,1,0];class udt extends CA{constructor(){super(),this._capacity=void 0,this._bufferSize=void 0,this._vertAttrs=void 0,this._vertAttribSize=void 0,this._vBuffer=void 0,this._vertAttrsFloatCount=void 0,this._vdataF32=void 0,this._vdataUint32=void 0,this._subMeshData=void 0,this._mesh=void 0,this._vertCount=0,this._indexCount=0,this._startTimeOffset=0,this._lifeTimeOffset=0,this._material=null,this._vertAttribSizeStatic=void 0,this._vertStaticAttrsFloatCount=void 0,this._insBuffers=void 0,this._insIndices=void 0,this._useInstance=void 0,this._iaVertCount=0,this._iaIndexCount=0,this.type=4,this._capacity=0,this._bufferSize=16,this._vertAttrs=null,this._vertAttribSize=0,this._vBuffer=null,this._vertAttrsFloatCount=0,this._vdataF32=null,this._vdataUint32=null,this._vertAttribSizeStatic=0,this._vertStaticAttrsFloatCount=0,this._insBuffers=[],this._insIndices=null,e_.gfxDevice.hasFeature(1)?this._useInstance=!0:this._useInstance=!1,this._subMeshData=null,this._mesh=null}setCapacity(t){const e=this._capacity!==t;this._capacity=t,this._bufferSize=Math.max(this._capacity,16),this._subMeshData&&e&&this.rebuild()}setVertexAttributes(t,e){if(this._useInstance)this.setVertexAttributesIns(t,e);else{if(this._mesh===t&&this._vertAttrs===e)return;this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0;for(const t of this._vertAttrs)t.offset=this._vertAttribSize,this._vertAttribSize+=mp[t.format].size;this._vertAttrsFloatCount=this._vertAttribSize/4,this.rebuild()}}setVertexAttributesIns(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0,this._vertAttribSizeStatic=0;for(const t of this._vertAttrs)0===t.stream?(t.offset=this._vertAttribSize,this._vertAttribSize+=mp[t.format].size):1===t.stream&&(t.offset=this._vertAttribSizeStatic,this._vertAttribSizeStatic+=mp[t.format].size);this._vertAttrsFloatCount=this._vertAttribSize/4,this._vertStaticAttrsFloatCount=this._vertAttribSizeStatic/4,this.rebuild()}}createSubMeshData(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);const t=this._device.createBuffer(new Ed(10,3,this._vertAttribSize*this._bufferSize*this._vertCount,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._bufferSize*this._vertCount);if(this._mesh&&this._capacity>0){let t=this._vertAttrs[this._vertAttrs.findIndex((t=>"a_texCoord"===t.name))].offset;this._mesh.copyAttribute(0,"a_texCoord",e,this._vertAttribSize,t);let i=this._vertAttrs.findIndex((t=>"a_texCoord3"===t.name));if(t=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,"a_position",e,this._vertAttribSize,t),t=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,"a_normal",e,this._vertAttribSize,t),t=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,"a_color",e,this._vertAttribSize,t)){const i=new Uint32Array(e);for(let e=0;e<this._vertCount;++e)i[e*this._vertAttrsFloatCount+t/4]=_r.toUint32(_r.WHITE)}const s=new Float32Array(e);for(let t=1;t<this._capacity;t++)s.copyWithin(t*this._vertAttribSize*this._vertCount/4,0,this._vertAttribSize*this._vertCount/4)}t.update(e);const i=new Uint16Array(this._bufferSize*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,i);for(let t=1;t<this._capacity;t++)for(let e=0;e<this._indexCount;e++)i[t*this._indexCount+e]=i[e]+t*this._vertCount}else{let t=0;for(let e=0;e<this._capacity;++e){const s=4*e;i[t++]=s,i[t++]=s+1,i[t++]=s+2,i[t++]=s+3,i[t++]=s+2,i[t++]=s+1}}const s=this._device.createBuffer(new Ed(6,1,this._bufferSize*this._indexCount*2,2));return s.update(i),this._iaVertCount=this._capacity*this._vertCount,this._iaIndexCount=this._capacity*this._indexCount,this._subMeshData=new _S([t],this._vertAttrs,7,s),this.initSubModel(0,this._subMeshData,this._material),e}createSubMeshDataInsDynamic(){this._insBuffers.length=0,this.destroySubMeshData();const t=this._device.createBuffer(new Ed(10,3,this._vertAttribSize*this._bufferSize,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._bufferSize);return t.update(e),this._insBuffers.push(t),e}createSubMeshDataInsStatic(){this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);const t=this._device.createBuffer(new Ed(10,3,this._vertAttribSizeStatic*this._vertCount,this._vertAttribSizeStatic)),e=new ArrayBuffer(this._vertAttribSizeStatic*this._vertCount);if(this._mesh){let t=this._vertAttrs.findIndex((t=>"a_texCoord"===t.name)),i=this._vertAttrs[t].offset;if(this._mesh.copyAttribute(0,"a_texCoord",e,this._vertAttribSizeStatic,i),t=this._vertAttrs.findIndex((t=>"a_texCoord3"===t.name)),i=this._vertAttrs[t++].offset,this._mesh.copyAttribute(0,"a_position",e,this._vertAttribSizeStatic,i),i=this._vertAttrs[t++].offset,this._mesh.copyAttribute(0,"a_normal",e,this._vertAttribSizeStatic,i),i=this._vertAttrs[t++].offset,!this._mesh.copyAttribute(0,"a_color",e,this._vertAttribSizeStatic,i)){const t=new Uint32Array(e);for(let e=0;e<this._vertCount;++e)t[e*this._vertStaticAttrsFloatCount+i/4]=_r.toUint32(_r.WHITE)}}else{const t=new Float32Array(e);for(let e=0;e<cdt.length;++e)t[e]=cdt[e]}t.update(e);const i=new Uint16Array(this._indexCount);this._mesh?this._mesh.copyIndices(0,i):(i[0]=0,i[1]=1,i[2]=2,i[3]=3,i[4]=2,i[5]=1);const s=this._device.createBuffer(new Ed(6,1,2*this._indexCount,2));s.update(i),this._insIndices=s,this._iaVertCount=this._vertCount,this._iaIndexCount=this._indexCount,this._insBuffers.push(t)}createInsSubmesh(){this._subMeshData=new _S(this._insBuffers,this._vertAttrs,7,this._insIndices),this.initSubModel(0,this._subMeshData,this._material)}updateMaterial(t){this._material=t,this.setSubModelMaterial(0,t)}addParticleVertexData(t,e){if(this._useInstance)this.addParticleVertexDataIns(t,e);else if(this._mesh)for(let i=0;i<this._vertCount;i++){let s=(t*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[s++]=e.position.x,this._vdataF32[s++]=e.position.y,this._vdataF32[s++]=e.position.z,s+=2,this._vdataF32[s++]=e.texcoord.z,this._vdataF32[s++]=e.size.x,this._vdataF32[s++]=e.size.y,this._vdataF32[s++]=e.size.z,this._vdataF32[s++]=e.rotation.x,this._vdataF32[s++]=e.rotation.y,this._vdataF32[s++]=e.rotation.z,this._vdataUint32[s++]=e.color}else{let i=t*this._vertAttrsFloatCount;this._vdataF32[i++]=e.position.x,this._vdataF32[i++]=e.position.y,this._vdataF32[i++]=e.position.z,this._vdataF32[i++]=e.texcoord.x,this._vdataF32[i++]=e.texcoord.y,this._vdataF32[i++]=e.texcoord.z,this._vdataF32[i++]=e.size.x,this._vdataF32[i++]=e.size.y,this._vdataF32[i++]=e.size.z,this._vdataF32[i++]=e.rotation.x,this._vdataF32[i++]=e.rotation.y,this._vdataF32[i++]=e.rotation.z,this._vdataUint32[i++]=e.color,e.velocity&&(this._vdataF32[i++]=e.velocity.x,this._vdataF32[i++]=e.velocity.y,this._vdataF32[i++]=e.velocity.z)}}addParticleVertexDataIns(t,e){let i=t*this._vertAttrsFloatCount;this._mesh?(this._vdataF32[i++]=e.position.x,this._vdataF32[i++]=e.position.y,this._vdataF32[i++]=e.position.z,this._vdataF32[i++]=e.texcoord.z,this._vdataF32[i++]=e.size.x,this._vdataF32[i++]=e.size.y,this._vdataF32[i++]=e.size.z,this._vdataF32[i++]=e.rotation.x,this._vdataF32[i++]=e.rotation.y,this._vdataF32[i++]=e.rotation.z,this._vdataUint32[i++]=e.color):(this._vdataF32[i++]=e.position.x,this._vdataF32[i++]=e.position.y,this._vdataF32[i++]=e.position.z,this._vdataF32[i++]=e.texcoord.z,this._vdataF32[i++]=e.size.x,this._vdataF32[i++]=e.size.y,this._vdataF32[i++]=e.size.z,this._vdataF32[i++]=e.rotation.x,this._vdataF32[i++]=e.rotation.y,this._vdataF32[i++]=e.rotation.z,this._vdataUint32[i++]=e.color,e.velocity&&(this._vdataF32[i++]=e.velocity.x,this._vdataF32[i++]=e.velocity.y,this._vdataF32[i++]=e.velocity.z))}addGPUParticleVertexData(t,e,i){if(this._useInstance)this.addGPUParticleVertexDataIns(t,e,i);else{let s=e*this._vertAttrsFloatCount*this._vertCount;for(let e=0;e<this._vertCount;e++){let r=s;this._vdataF32[r++]=t.position.x,this._vdataF32[r++]=t.position.y,this._vdataF32[r++]=t.position.z,this._vdataF32[r++]=i,this._vdataF32[r++]=t.startSize.x,this._vdataF32[r++]=t.startSize.y,this._vdataF32[r++]=t.startSize.z,this._vdataF32[r++]=ldt[2*e],this._vdataF32[r++]=t.rotation.x,this._vdataF32[r++]=t.rotation.y,this._vdataF32[r++]=t.rotation.z,this._vdataF32[r++]=ldt[2*e+1],this._vdataF32[r++]=t.startColor.r/255,this._vdataF32[r++]=t.startColor.g/255,this._vdataF32[r++]=t.startColor.b/255,this._vdataF32[r++]=t.startColor.a/255,this._vdataF32[r++]=t.velocity.x,this._vdataF32[r++]=t.velocity.y,this._vdataF32[r++]=t.velocity.z,this._vdataF32[r++]=t.startLifetime,this._vdataF32[r++]=t.randomSeed,s+=this._vertAttrsFloatCount}}}addGPUParticleVertexDataIns(t,e,i){let s=e*this._vertAttrsFloatCount,r=s;this._vdataF32[r++]=t.position.x,this._vdataF32[r++]=t.position.y,this._vdataF32[r++]=t.position.z,this._vdataF32[r++]=i,this._vdataF32[r++]=t.startSize.x,this._vdataF32[r++]=t.startSize.y,this._vdataF32[r++]=t.startSize.z,this._vdataF32[r++]=t.frameIndex,this._vdataF32[r++]=t.rotation.x,this._vdataF32[r++]=t.rotation.y,this._vdataF32[r++]=t.rotation.z,this._vdataF32[r++]=t.startColor.r/255,this._vdataF32[r++]=t.startColor.g/255,this._vdataF32[r++]=t.startColor.b/255,this._vdataF32[r++]=t.startColor.a/255,this._vdataF32[r++]=t.velocity.x,this._vdataF32[r++]=t.velocity.y,this._vdataF32[r++]=t.velocity.z,this._vdataF32[r++]=t.startLifetime,this._vdataF32[r++]=t.randomSeed,s+=this._vertAttrsFloatCount}updateGPUParticles(t,e,i){if(this._useInstance)return this.updateGPUParticlesIns(t,e,i);{const s=this._vertAttrsFloatCount*this._vertCount;let r=0,n=0,o=0,a=0,h=0;for(let l=0;l<t;++l)r=l*s,n=this._vdataF32[r+this._startTimeOffset],o=this._vdataF32[r+this._lifeTimeOffset],h=e-n,o-h<i&&(a=--t*s,this._vdataF32.copyWithin(r,a,a+s),l--);return t}}updateGPUParticlesIns(t,e,i){const s=this._vertAttrsFloatCount;let r=0,n=0,o=0,a=0,h=0;for(let l=0;l<t;++l)r=l*s,n=this._vdataF32[r+this._startTimeOffset],o=this._vdataF32[r+this._lifeTimeOffset],h=e-n,o-h<i&&(a=--t*s,this._vdataF32.copyWithin(r,a,a+s),l--);return t}constructAttributeIndex(){if(!this._vertAttrs)return;let t=this._vertAttrs.findIndex((t=>"a_position_starttime"===t.name)),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((t=>"a_dir_life"===t.name)),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}updateIA(t){if(this._useInstance)this.updateIAIns(t);else{if(t<=0)return;const e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.firstIndex=0,e.indexCount=this._indexCount*t,e.vertexCount=this._iaVertCount}}updateIAIns(t){if(t<=0)return;const e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.instanceCount=t,e.firstIndex=0,e.indexCount=this._indexCount,e.instanceCount=t,e.vertexCount=this._iaVertCount}clear(){this._useInstance?this.clearIns():this._subModels[0].inputAssembler.indexCount=0}clearIns(){this._subModels[0].inputAssembler.instanceCount=0}destroy(){super.destroy(),this.doDestroy()}doDestroy(){this._vBuffer=null,this._vdataF32=null,this._vdataUint32=null,this._insBuffers=[],this._insIndices=null,this._vertAttrs=null,this._material=null,this._mesh=null,this.destroySubMeshData()}rebuild(){this._useInstance?this.rebuildIns():(this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer))}rebuildIns(){this._vBuffer=this.createSubMeshDataInsDynamic(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this.createSubMeshDataInsStatic(),this.createInsSubmesh()}destroySubMeshData(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}set useInstance(t){this._useInstance!==t&&(this._useInstance=t)}get useInstance(){return this._useInstance}}class ddt{get model(){return this._model}constructor(t){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._useInstance=void 0,this._renderInfo=t,e_.gfxDevice.hasFeature(1)?this._useInstance=!0:this._useInstance=!1}getUseInstance(){return this._useInstance}getInfo(){return this._renderInfo}onInit(t){this._particleSystem=t}onEnable(){if(!this._particleSystem)return;this.attachToScene();const t=this._model;t&&(t.node=t.transform=this._particleSystem.node)}onDisable(){this.detachFromScene()}onDestroy(){this._model&&(h.director.root.destroyModel(this._model),this._model=null)}attachToScene(){var t;this._model&&(this._model.scene&&this.detachFromScene(),null===(t=this._particleSystem)||void 0===t||t._getRenderScene().addModel(this._model))}detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}setVertexAttributes(){this._model&&(this.updateVertexAttrib(),this._model.setVertexAttributes(this._renderInfo.renderMode===Xht.Mesh?this._renderInfo.mesh:null,this._vertAttrs))}clear(){this._model&&(this._model.enabled=!1)}getModel(){return this._model}_initModel(){!this._model&&this._particleSystem&&(this._model=h.director.root.createModel(udt),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)}updateTrailMaterial(){}getDefaultTrailMaterial(){return null}}class pdt{constructor(t){this.permutation=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this.accSpeed=new Ki,this.noiseSpeed=new Ki,this.noiseFrequency=0,this.noiseAbs=new Ki,this.noiseAmplitude=new Ki,this.octaves=new Ki,this.dt=0,this.point=new Ki,this.result=new Ki,this.mixOut=new Qs,t&&(this.permutation=t)}noise(t,e,i,s,r){void 0===s&&(s=0),void 0===r&&(r=1);const n=new Array(512);for(let t=0;t<256;t++)n[256+t]=n[t]=this.permutation[t];const o=255&Math.floor(t),a=255&Math.floor(e),h=255&Math.floor(i);t-=Math.floor(t),e-=Math.floor(e),i-=Math.floor(i);const l=this.fade(t),c=this.fade(e),u=this.fade(i),d=n[o]+a,p=n[d]+h,_=n[d+1]+h,g=n[o+1]+a,f=n[g]+h,m=n[g+1]+h;return s+this.scale(this.lerp(u,this.lerp(c,this.lerp(l,this.grad(n[p],t,e,i),this.grad(n[f],t-1,e,i)),this.lerp(l,this.grad(n[_],t,e-1,i),this.grad(n[m],t-1,e-1,i))),this.lerp(c,this.lerp(l,this.grad(n[p+1],t,e,i-1),this.grad(n[f+1],t-1,e,i-1)),this.lerp(l,this.grad(n[_+1],t,e-1,i-1),this.grad(n[m+1],t-1,e-1,i-1)))))*(r-s)}fade(t){return t*t*t*(t*(6*t-15)+10)}lerp(t,e,i){return e+t*(i-e)}grad(t,e,i,s){const r=15&t,n=r<8?e:i,o=r<4?i:12===r||14===r?e:s;return(1&r?-n:n)+(2&r?-o:o)}scale(t){return(1+t)/2}setSpeed(t,e,i){this.noiseSpeed.set(t,e,i)}setFrequency(t){this.noiseFrequency=t}setAbs(t,e,i){this.noiseAbs.set(t,e,i)}setAmplititude(t,e,i){this.noiseAmplitude.set(t,e,i)}setOctaves(t,e,i){this.octaves.set(t,e,i)}setTime(t){this.dt=t}setSamplePoint(t){this.point.set(t)}getResult(){return this.result}getNoise(t,e,i,s,r,n,o){let a=n,h=0;if(h+=this.noise(t*a,e*a,i*a,-1,1),1===o.x)return h;let l=1,c=1;for(let s=1;s<o.x;++s)l*=o.y,a*=o.z,c+=l,h+=this.noise(t*a,e*a,i*a,-1,1)*l;return h/c}getNoiseMix(t,e,i,s,r,n){t.x=this.getNoise(e.x,e.y,e.z,i,s,r,n),t.y=this.getNoise(e.y,e.z,e.x,i,s,r,n)}getNoiseParticle(){this.accSpeed.set(this.noiseSpeed.x*this.dt,this.noiseSpeed.y*this.dt,this.noiseSpeed.z*this.dt);const t=this.getNoise(this.point.z+this.accSpeed.x,this.point.y,this.point.x,this.dt,this.accSpeed,this.noiseFrequency,this.octaves),e=this.getNoise(this.point.x+1e3,this.point.z+this.accSpeed.y,this.point.y,this.dt,this.accSpeed,this.noiseFrequency,this.octaves),i=this.getNoise(this.point.y,this.point.x+1e3,this.point.z+this.accSpeed.z,this.dt,this.accSpeed,this.noiseFrequency,this.octaves);this.result.set(t*this.noiseAmplitude.x,e*this.noiseAmplitude.y,i*this.noiseAmplitude.z)}getPreview(t,e,i){for(let s=0;s<i;++s)for(let r=0;r<e;++r){const n=(r-.5*e)/e+this.noiseSpeed.x*this.dt,o=(s-.5*i)/i+this.noiseSpeed.y*this.dt,a=this.getNoise(n,o,0,this.dt,this.accSpeed,this.noiseFrequency,this.octaves);t[s*e+r]=.5*(a+1)}}}const _dt=new cr,gdt=new Ki,fdt=new Rs,mdt=new Rs,ydt=new ys;new Ki;const vdt=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule"],bdt=[0,0,1,0,0,1,1,1],wdt="CC_USE_WORLD_SPACE",Sdt="CC_RENDER_MODE",xdt=[new Wd("a_position",32),new Wd("a_texCoord",32),new Wd("a_texCoord1",32),new Wd("a_texCoord2",32),new Wd("a_color",35,!0)],Tdt=[new Wd("a_position",32),new Wd("a_texCoord",32),new Wd("a_texCoord1",32),new Wd("a_texCoord2",32),new Wd("a_color",35,!0),new Wd("a_color1",32)],Cdt=[new Wd("a_position",32),new Wd("a_texCoord",32),new Wd("a_texCoord1",32),new Wd("a_texCoord2",32),new Wd("a_color",35,!0),new Wd("a_texCoord3",32),new Wd("a_normal",32),new Wd("a_color1",35,!0)],Idt=[new Wd("a_texCoord4",44,!1,0,!0),new Wd("a_texCoord1",32,!1,0,!0),new Wd("a_texCoord2",32,!1,0,!0),new Wd("a_color",35,!0,0,!0),new Wd("a_texCoord",32,!1,1)],Edt=[new Wd("a_texCoord4",44,!1,0,!0),new Wd("a_texCoord1",32,!1,0,!0),new Wd("a_texCoord2",32,!1,0,!0),new Wd("a_color",35,!0,0,!0),new Wd("a_color1",32,!1,0,!0),new Wd("a_texCoord",32,!1,1)],Ddt=[new Wd("a_texCoord4",44,!1,0,!0),new Wd("a_texCoord1",32,!1,0,!0),new Wd("a_texCoord2",32,!1,0,!0),new Wd("a_color",35,!0,0,!0),new Wd("a_texCoord",32,!1,1),new Wd("a_texCoord3",32,!1,1),new Wd("a_normal",32,!1,1),new Wd("a_color1",35,!0,1)],Adt={parent:null,owner:null,subModelIdx:0};class Mdt{constructor(){this.position=void 0,this.texcoord=void 0,this.size=void 0,this.rotation=void 0,this.color=void 0,this.velocity=void 0,this.position=new Ki,this.texcoord=new Ki,this.size=new Ki,this.rotation=new Ki,this.color=0,this.velocity=null}}class Pdt extends ddt{constructor(t){super(t),this._defines=void 0,this._trailDefines=void 0,this._frameTile_velLenScale=void 0,this._tmp_velLenScale=void 0,this._defaultMat=null,this._node_scale=void 0,this._particleVertexData=void 0,this._particles=null,this._defaultTrailMat=null,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._fillDataFunc=null,this._uScaleHandle=0,this._uLenHandle=0,this._uNodeRotHandle=0,this._alignSpace=qht.View,this._inited=!1,this._localMat=new Rs,this._gravity=new cr,this.noise=new pdt,this._model=null,this._frameTile_velLenScale=new cr(1,1,0,0),this._tmp_velLenScale=this._frameTile_velLenScale.clone(),this._node_scale=new Ki,this._particleVertexData=new Mdt,this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},this._trailDefines={CC_USE_WORLD_SPACE:!0}}onInit(t){super.onInit(t),this._particles=new nn((()=>new Uht(this)),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0}clear(){super.clear(),this._particles.reset(),this._particleSystem&&this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1}updateRenderMode(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()}onDestroy(){var t;null===(t=this._particles)||void 0===t||t.destroy(),super.onDestroy()}getFreeParticle(){return this._particleSystem&&this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}getDefaultTrailMaterial(){return this._defaultTrailMat}setNewParticle(t){}_initModuleList(){vdt.forEach((t=>{if(!this._particleSystem)return;const e=this._particleSystem[t];e&&e.enable&&(e.needUpdate&&this._updateList.set(e.name,e),e.needAnimate&&this._animateList.set(e.name,e))})),this._runAnimateList.length=0;for(let t=0,e=Hht.length;t<e;t++){const e=this._animateList.get(Hht[t]);e&&this._runAnimateList.push(e)}}enableModule(t,e,i){e?(i.needUpdate&&this._updateList.set(i.name,i),i.needAnimate&&this._animateList.set(i.name,i)):(this._animateList.delete(t),this._updateList.delete(t)),this._runAnimateList.length=0;for(let t=0,e=Hht.length;t<e;t++){const e=this._animateList.get(Hht[t]);e&&this._runAnimateList.push(e)}this.updateMaterialParams()}updateAlignSpace(t){this._alignSpace=t}getDefaultMaterial(){return this._defaultMat}updateRotation(t){t&&this.doUpdateRotation(t)}doUpdateRotation(t){if(this._renderInfo.renderMode===Xht.Mesh||this._alignSpace!==qht.View){var e;if(this._alignSpace===qht.Local)null===(e=this._particleSystem)||void 0===e||e.node.getRotation(ydt);else if(this._alignSpace===qht.World){var i;null===(i=this._particleSystem)||void 0===i||i.node.getWorldRotation(ydt)}else if(this._alignSpace===qht.View){var s,r;ydt.set(0,0,0,1);const t=null===(s=this._particleSystem)||void 0===s||null===(r=s.node.scene.renderScene)||void 0===r?void 0:r.cameras;if(void 0!==t)for(let e=0;e<(null==t?void 0:t.length);++e){const i=t[e];if((i.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){ys.fromViewUp(ydt,i.forward);break}}}else ydt.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,ydt)}}updateScale(t){t&&this.doUpdateScale(t)}doUpdateScale(t){var e,i,s;const r=this._node_scale;switch(null===(e=this._particleSystem)||void 0===e?void 0:e.scaleSpace){case jht.Local:null===(i=this._particleSystem)||void 0===i||i.node.getScale(r);break;case jht.World:null===(s=this._particleSystem)||void 0===s||s.node.getWorldScale(r)}t.setUniform(this._uScaleHandle,_dt.set(r.x,r.y,r.z))}updateParticles(t){const e=this._particleSystem;if(!e)return this._particles.length;e.node.getWorldMatrix(fdt);const i=(e.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(i),this.doUpdateRotation(i),this._updateList.forEach((()=>{}));const s=e._trailModule,r=s&&s.enable;r&&s.update();const n=!e.gravityModifier.isZero();if(n){if(e.simulationSpace===jht.Local){const t=e.node.getRotation();Rs.fromQuat(this._localMat,t),this._localMat.transpose()}if(e.node.parent){const t=e.node.parent.getWorldRotation();Rs.fromQuat(mdt,t),mdt.transpose()}}for(let i=0;i<this._particles.length;++i){const o=this._particles.data[i];if(o.remainingLifetime-=t,Ki.set(o.animatedVelocity,0,0,0),o.remainingLifetime<0)r&&s.removeParticle(o),this._particles.removeAt(i),--i;else{if(n){const i=hlt(e.gravityModifier)?Ci(o.randomSeed):0;if(e.simulationSpace===jht.Local){const s=1-o.remainingLifetime/o.startLifetime,r=9.8*-e.gravityModifier.evaluate(s,i)*t;this._gravity.x=0,this._gravity.y=r,this._gravity.z=0,this._gravity.w=1,gi(r,0,pi)||(e.node.parent&&(this._gravity=this._gravity.transformMat4(mdt)),this._gravity=this._gravity.transformMat4(this._localMat),o.velocity.x+=this._gravity.x,o.velocity.y+=this._gravity.y,o.velocity.z+=this._gravity.z)}else o.velocity.y-=9.8*e.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,i)*t}Ki.copy(o.ultimateVelocity,o.velocity),this._runAnimateList.forEach((e=>{e.animate(o,t)})),Ki.scaleAndAdd(o.position,o.position,o.ultimateVelocity,t),r&&s.animate(o,t)}}return this._model.enabled=this._particles.length>0,this._particles.length}getNoisePreview(t,e,i){this._runAnimateList.forEach((s=>{s.name===Vht&&s.getNoisePreview(t,this._particleSystem,e,i)}))}updateRenderData(){let t=0;for(let e=0;e<this._particles.length;++e){const i=this._particles.data[e];let s=0;const r=this._particleSystem._textureAnimationModule;r&&r.enable&&(s=i.frameIndex),t=4*e,this._fillDataFunc(i,t,s)}}beforeRender(){this._model.updateIA(this._particles.length)}getParticleCount(){return this._particles.length}onMaterialModified(t,e){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())}onRebuildPSO(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);const i=this._particleSystem._trailModule,s=null==i?void 0:i.getModel();s&&1===t&&s.setSubModelMaterial(0,e)}_setFillFunc(){this._renderInfo.renderMode===Xht.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===Xht.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData}_fillMeshData(t,e,i){const s=e/4;Ki.copy(this._particleVertexData.position,t.position),gdt.z=i,Ki.copy(this._particleVertexData.texcoord,gdt),Ki.copy(this._particleVertexData.size,t.size),Ki.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=_r.toUint32(t.color),this._model.addParticleVertexData(s,this._particleVertexData)}_fillStrecthedData(t,e,i){if(this._useInstance)this._fillStrecthedDataIns(t,e,i);else for(let s=0;s<4;++s)Ki.copy(this._particleVertexData.position,t.position),gdt.x=bdt[2*s],gdt.y=bdt[2*s+1],gdt.z=i,Ki.copy(this._particleVertexData.texcoord,gdt),Ki.copy(this._particleVertexData.size,t.size),Ki.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=_r.toUint32(t.color),this._particleVertexData.velocity=t.ultimateVelocity,this._model.addParticleVertexData(e++,this._particleVertexData)}_fillStrecthedDataIns(t,e,i){const s=e/4;Ki.copy(this._particleVertexData.position,t.position),gdt.z=i,Ki.copy(this._particleVertexData.texcoord,gdt),Ki.copy(this._particleVertexData.size,t.size),Ki.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=_r.toUint32(t.color),this._particleVertexData.velocity=t.ultimateVelocity,this._model.addParticleVertexData(s,this._particleVertexData)}_fillNormalData(t,e,i){if(this._useInstance)this._fillNormalDataIns(t,e,i);else for(let s=0;s<4;++s)Ki.copy(this._particleVertexData.position,t.position),gdt.x=bdt[2*s],gdt.y=bdt[2*s+1],gdt.z=i,Ki.copy(this._particleVertexData.texcoord,gdt),Ki.copy(this._particleVertexData.size,t.size),Ki.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=_r.toUint32(t.color),this._model.addParticleVertexData(e++,this._particleVertexData)}_fillNormalDataIns(t,e,i){const s=e/4;Ki.copy(this._particleVertexData.position,t.position),gdt.z=i,Ki.copy(this._particleVertexData.texcoord,gdt),Ki.copy(this._particleVertexData.size,t.size),Ki.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=_r.toUint32(t.color),this._model.addParticleVertexData(s,this._particleVertexData)}updateVertexAttrib(){if(this._renderInfo.renderMode===Xht.Mesh&&this._renderInfo.mesh){const t=this._renderInfo.mesh.readAttributeFormat(0,"a_color");if(t){let e=35;for(let i=0;i<mp.length;++i)if(mp[i].name===t.name){e=i;break}this._vertAttrs[7]=new Wd("a_color1",e,!0,this._useInstance?1:0)}else{const t=35;this._vertAttrs[7]=new Wd("a_color1",t,!0,this._useInstance?1:0)}}}_setVertexAttrib(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case Xht.StrecthedBillboard:this._vertAttrs=Tdt.slice();break;case Xht.Mesh:this._vertAttrs=Cdt.slice();break;default:this._vertAttrs=xdt.slice()}}_setVertexAttribIns(){switch(this._renderInfo.renderMode){case Xht.StrecthedBillboard:this._vertAttrs=Edt.slice();break;case Xht.Mesh:this._vertAttrs=Ddt.slice();break;default:this._vertAttrs=Idt.slice()}}updateMaterialParams(){if(!this._particleSystem)return;const t=this._particleSystem,e=t.sharedMaterial;null!=e&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(Adt.parent=pw.get("default-particle-material"),Adt.owner=this._particleSystem,Adt.subModelIdx=0,this._defaultMat=new Gw(Adt),Adt.parent=null,Adt.owner=null,Adt.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));const i=t.getMaterialInstance(0)||this._defaultMat;t.simulationSpace===jht.World?this._defines[wdt]=!0:this._defines[wdt]=!1;const s=i.passes[0];this._uScaleHandle=s.getHandle("scale"),this._uLenHandle=s.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=s.getHandle("nodeRotation");const r=this._renderInfo.renderMode,n=this._frameTile_velLenScale;r===Xht.Billboard?this._defines[Sdt]=0:r===Xht.StrecthedBillboard?(this._defines[Sdt]=1,n.z=this._renderInfo.velocityScale,n.w=this._renderInfo.lengthScale):r===Xht.HorizontalBillboard?this._defines[Sdt]=2:r===Xht.VerticalBillboard?this._defines[Sdt]=3:r===Xht.Mesh?this._defines[Sdt]=4:P(`particle system renderMode ${r} not support.`);const o=t._textureAnimationModule;o&&o.enable?(cr.copy(this._tmp_velLenScale,n),Qs.set(this._tmp_velLenScale,o.numTilesX,o.numTilesY),s.setUniform(this._uLenHandle,this._tmp_velLenScale)):s.setUniform(this._uLenHandle,n);let a=!1;const h=this._particleSystem._rotationOvertimeModule;a=!!h&&h.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=a,this._defines.CC_INSTANCE_PARTICLE=this._useInstance,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}updateTrailMaterial(){if(!this._particleSystem)return;const t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===jht.World||e.space===jht.World?this._trailDefines[wdt]=!0:this._trailDefines[wdt]=!1;let i=t.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(Adt.parent=pw.get("default-trail-material"),Adt.owner=this._particleSystem,Adt.subModelIdx=1,this._defaultTrailMat=new Gw(Adt),Adt.parent=null,Adt.owner=null,Adt.subModelIdx=0),i=i||this._defaultTrailMat,i.recompileShaders(this._trailDefines),e.updateMaterial()}}setUseInstance(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())}}const Bdt=new cr,Rdt=new Rs,Odt=new cr,Ldt=new ys,Fdt=new ys;new Ki;const zdt=32,kdt="CC_USE_WORLD_SPACE",Ndt="CC_RENDER_MODE",Udt="a_position_starttime",Vdt="a_size_uv",Hdt="a_rotation_uv",Gdt="a_color",Wdt="a_dir_life",jdt="a_rndSeed",$dt="a_size_fid",qdt="a_rotation",Xdt=[new Wd(Udt,44),new Wd(Vdt,44),new Wd(Hdt,44),new Wd(Gdt,44),new Wd(Wdt,44),new Wd(jdt,11)],Ydt=[new Wd(Udt,44),new Wd(Vdt,44),new Wd(Hdt,44),new Wd(Gdt,44),new Wd(Wdt,44),new Wd(jdt,11),new Wd("a_texCoord",32),new Wd("a_texCoord3",32),new Wd("a_normal",32),new Wd("a_color1",35,!0)],Qdt=[new Wd(Udt,44,!1,0,!0),new Wd($dt,44,!1,0,!0),new Wd(qdt,32,!1,0,!0),new Wd(Gdt,44,!1,0,!0),new Wd(Wdt,44,!1,0,!0),new Wd(jdt,11,!1,0,!0),new Wd("a_uv",32,!1,1)],Kdt=[new Wd(Udt,44,!1,0,!0),new Wd($dt,44,!1,0,!0),new Wd(qdt,32,!1,0,!0),new Wd(Gdt,44,!1,0,!0),new Wd(Wdt,44,!1,0,!0),new Wd(jdt,11,!1,0,!0),new Wd("a_texCoord",32,!1,1),new Wd("a_texCoord3",32,!1,1),new Wd("a_normal",32,!1,1),new Wd("a_color1",35,!0,1)],Zdt={parent:null,owner:null,subModelIdx:0};class Jdt extends ddt{constructor(t){super(t),this._defines=void 0,this._frameTile_velLenScale=void 0,this._unifrom_velLenScale=void 0,this._tmp_velLenScale=void 0,this._node_scale=void 0,this._vertAttrs=[],this._defaultMat=null,this._particleNum=0,this._tempParticle=null,this._colorTexture=null,this._forceTexture=null,this._velocityTexture=null,this._rotationTexture=null,this._sizeTexture=null,this._animTexture=null,this._colorData=null,this._forceData=null,this._velocityData=null,this._rotationData=null,this._sizeData=null,this._animData=null,this._uTimeHandle=0,this._uRotHandle=0,this._uNodeRotHandle=0,this._alignSpace=qht.View,this._inited=!1,this._frameTile_velLenScale=new cr(1,1,0,0),this._unifrom_velLenScale=this._frameTile_velLenScale.clone(),this._tmp_velLenScale=this._frameTile_velLenScale.clone(),this._node_scale=new Ki,this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},this._tempParticle=new Uht(null),this._particleNum=0}onInit(t){super.onInit(t),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0}updateRenderMode(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()}setVertexAttributes(){super.setVertexAttributes(),this._model.constructAttributeIndex()}clear(){super.clear(),this._particleNum=0,this.updateRenderData()}onDestroy(){super.onDestroy(),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy(),this._forceData=null,this._velocityData=null,this._colorData=null,this._sizeData=null,this._rotationData=null,this._animData=null}enableModule(t,e,i){var s;const r=(null===(s=this._particleSystem)||void 0===s?void 0:s.getMaterialInstance(0))||this._defaultMat;r&&(this.initShaderUniform(r),r.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,r))}getFreeParticle(){var t;return this._particleSystem&&this._particleNum>=(null===(t=this._particleSystem)||void 0===t?void 0:t.capacity)?null:this._tempParticle}setNewParticle(t){this._particleSystem&&(this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem.time),this._particleNum++)}getDefaultMaterial(){return this._defaultMat}updateRotation(t){t&&this.doUpdateRotation(t)}doUpdateRotation(t){if(this._renderInfo.renderMode===Xht.Mesh||this._alignSpace!==qht.View){var e;if(this._alignSpace===qht.Local)null===(e=this._particleSystem)||void 0===e||e.node.getRotation(Fdt);else if(this._alignSpace===qht.World){var i;null===(i=this._particleSystem)||void 0===i||i.node.getWorldRotation(Fdt)}else if(this._alignSpace===qht.View){var s,r;Fdt.set(0,0,0,1);const t=null===(s=this._particleSystem)||void 0===s||null===(r=s.node.scene.renderScene)||void 0===r?void 0:r.cameras;if(void 0!==t&&this._particleSystem)for(let e=0;e<(null==t?void 0:t.length);++e){const i=t[e];if((i.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){ys.fromViewUp(Fdt,i.forward);break}}}else Fdt.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,Fdt)}}updateScale(t){t&&this.doUpdateScale(t)}doUpdateScale(t){var e;const i=this._node_scale;switch(null===(e=this._particleSystem)||void 0===e?void 0:e.scaleSpace){case jht.Local:this._particleSystem.node.getScale(i);break;case jht.World:this._particleSystem.node.getWorldScale(i)}t.setUniform(t.getHandle("scale"),Bdt.set(i.x,i.y,i.z))}updateParticles(t){return this._particleSystem?(this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem.time,t),this.updateShaderUniform(t),this._model.enabled=this._particleNum>0,this._particleNum):this._particleNum}updateRenderData(){}beforeRender(){this._model.updateIA(this._particleNum)}updateAlignSpace(t){this._alignSpace=t}updateShaderUniform(t){if(!this._particleSystem)return;const e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(!e)return;const i=e.passes[0];Odt.x=this._particleSystem.time,Odt.y=t,i.setUniform(this._uTimeHandle,Odt),this._particleSystem.node.getWorldRotation(Ldt),i.setUniform(this._uRotHandle,Ldt),this.doUpdateRotation(i)}initShaderUniform(t){var e,i,s,r,n,o;const a=t.passes[0];this._uTimeHandle=a.getHandle("u_timeDelta"),this._uRotHandle=a.getHandle("u_worldRot"),this._uNodeRotHandle=a.getHandle("nodeRotation"),this.doUpdateScale(a),a.setUniform(a.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),Odt.x=zdt,Odt.y=.03125,a.setUniform(a.getHandle("u_sampleInfo"),Odt);let h=!1;const l=null===(e=this._particleSystem)||void 0===e?void 0:e._forceOvertimeModule;if(h=!!l&&l.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=h,h){const t=qat(this._forceTexture,this._forceData,zdt,l.x,l.y,l.z);this._forceTexture=t.texture,this._forceData=t.texdata;const e=a.getHandle("force_over_time_tex0"),i=vw.getBindingFromHandle(e);a.bindSampler(i,this._forceTexture.getGFXSampler()),a.bindTexture(i,this._forceTexture.getGFXTexture());const s=a.getHandle("u_force_space");a.setUniform(s,l.space);const r=a.getHandle("u_force_mode");a.setUniform(r,this._forceTexture.height)}const c=null===(i=this._particleSystem)||void 0===i?void 0:i._velocityOvertimeModule;if(h=!!c&&c.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=h,h){const t=Xat(this._velocityTexture,this._velocityData,zdt,c.x,c.y,c.z,c.speedModifier);this._velocityTexture=t.texture,this._velocityData=t.texdata;const e=a.getHandle("velocity_over_time_tex0"),i=vw.getBindingFromHandle(e);a.bindSampler(i,this._velocityTexture.getGFXSampler()),a.bindTexture(i,this._velocityTexture.getGFXTexture());const s=a.getHandle("u_velocity_space");a.setUniform(s,c.space);const r=a.getHandle("u_velocity_mode");a.setUniform(r,this._velocityTexture.height)}const u=null===(s=this._particleSystem)||void 0===s?void 0:s._colorOverLifetimeModule;if(h=!!u&&u.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=h,h){const t=mht(this._colorTexture,this._colorData,zdt,u.color);this._colorTexture=t.texture,this._colorData=t.texdata;const e=a.getHandle("color_over_time_tex0"),i=vw.getBindingFromHandle(e);a.bindSampler(i,this._colorTexture.getGFXSampler()),a.bindTexture(i,this._colorTexture.getGFXTexture());const s=a.getHandle("u_color_mode");a.setUniform(s,this._colorTexture.height)}const d=null===(r=this._particleSystem)||void 0===r?void 0:r._rotationOvertimeModule;if(h=!!d&&d.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=h,h){let t;if(t=d.separateAxes?qat(this._rotationTexture,this._rotationData,zdt,d.x,d.y,d.z):Wat(this._rotationTexture,this._rotationData,zdt,d.z),this._rotationTexture=t.texture,this._rotationData=t.texdata,this._rotationTexture){const t=a.getHandle("rotation_over_time_tex0"),e=vw.getBindingFromHandle(t);a.bindSampler(e,this._rotationTexture.getGFXSampler()),a.bindTexture(e,this._rotationTexture.getGFXTexture());const i=a.getHandle("u_rotation_mode");a.setUniform(i,this._rotationTexture.height)}}const p=null===(n=this._particleSystem)||void 0===n?void 0:n._sizeOvertimeModule;if(h=!!p&&p.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=h,h){let t;if(t=p.separateAxes?qat(this._sizeTexture,this._sizeData,zdt,p.x,p.y,p.z,!0):jat(this._sizeTexture,this._sizeData,zdt,p.size),this._sizeTexture=t.texture,this._sizeData=t.texdata,this._sizeTexture){const t=a.getHandle("size_over_time_tex0"),e=vw.getBindingFromHandle(t);a.bindSampler(e,this._sizeTexture.getGFXSampler()),a.bindTexture(e,this._sizeTexture.getGFXTexture());const i=a.getHandle("u_size_mode");a.setUniform(i,this._sizeTexture.height)}}const _=null===(o=this._particleSystem)||void 0===o?void 0:o._textureAnimationModule;if(h=!!_&&_.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=h,h){const t=$at(this._animTexture,this._animData,zdt,_.startFrame,_.frameOverTime);this._animTexture=t.texture,this._animData=t.texdata;const e=a.getHandle("texture_animation_tex0"),i=vw.getBindingFromHandle(e);a.bindSampler(i,this._animTexture.getGFXSampler()),a.bindTexture(i,this._animTexture.getGFXTexture());const s=a.getHandle("u_anim_info");Odt.x=this._animTexture.height,Odt.y=_.numTilesX*_.numTilesY,Odt.z=_.cycleCount,a.setUniform(s,Odt)}this._defines.USE_VK_SHADER=4===e_.gfxDevice.gfxAPI,this._defines.CC_INSTANCE_PARTICLE=this._useInstance}getParticleCount(){return this._particleNum}onMaterialModified(t,e){this._inited&&this.updateMaterialParams()}onRebuildPSO(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)}updateVertexAttrib(){if(this._renderInfo.renderMode===Xht.Mesh&&this._renderInfo.mesh){const t=this._renderInfo.mesh.readAttributeFormat(0,"a_color");if(t){let e=35;for(let i=0;i<mp.length;++i)if(mp[i].name===t.name){e=i;break}this._vertAttrs[9]=new Wd("a_color1",e,!0,this._useInstance?1:0)}else{const t=35;this._vertAttrs[9]=new Wd("a_color1",t,!0,this._useInstance?1:0)}}}_setVertexAttrib(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case Xht.StrecthedBillboard:this._vertAttrs=Xdt.slice();break;case Xht.Mesh:this._vertAttrs=Ydt.slice();break;default:this._vertAttrs=Xdt.slice()}}_setVertexAttribIns(){switch(this._renderInfo.renderMode){case Xht.StrecthedBillboard:this._vertAttrs=Qdt.slice();break;case Xht.Mesh:this._vertAttrs=Kdt.slice();break;default:this._vertAttrs=Qdt.slice()}}updateMaterialParams(){if(!this._particleSystem)return;const t=this._particleSystem,e=t.sharedMaterial;null!==e&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(Zdt.parent=pw.get("default-particle-gpu-material"),Zdt.owner=t,Zdt.subModelIdx=0,this._defaultMat=new Gw(Zdt),Zdt.parent=null,Zdt.owner=null,Zdt.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));const i=t.getMaterialInstance(0)||this._defaultMat;t.node.getWorldMatrix(Rdt),t.simulationSpace===jht.World?this._defines[kdt]=!0:this._defines[kdt]=!1;const s=this._renderInfo.renderMode;s===Xht.Billboard?this._defines[Ndt]=0:s===Xht.StrecthedBillboard?(this._defines[Ndt]=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):s===Xht.HorizontalBillboard?this._defines[Ndt]=2:s===Xht.VerticalBillboard?this._defines[Ndt]=3:s===Xht.Mesh?this._defines[Ndt]=4:P(`particle system renderMode ${s} not support.`);const r=t._textureAnimationModule;r&&r.enable?(Qs.set(this._frameTile_velLenScale,r.numTilesX,r.numTilesY),cr.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,cr.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}setUseInstance(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())}getNoisePreview(t,e,i){}}var tpt,ept,ipt,spt,rpt,npt,opt,apt,hpt,lpt,cpt,upt,dpt,ppt,_pt,gpt,fpt,mpt,ypt,vpt,bpt;function wpt(){const t=uP.root.device;return!!(t.capabilities.maxVertexTextureUnits>=8&&3&t.getFormatFeatures(44))||(h.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}let Spt=(tpt=oa("cc.ParticleSystemRenderer"),ept=Ga(Xht),ipt=Ga(Xht),spt=Ga(ZP),rpt=Ga(Lw),npt=Ga(Lw),opt=Ga(Lw),apt=Ga(Lw),hpt=Ga(qht),tpt(((bpt=class{constructor(){this._renderMode=upt&&upt(),this._velocityScale=dpt&&dpt(),this._lengthScale=ppt&&ppt(),this._mesh=_pt&&_pt(),this._cpuMaterial=gpt&&gpt(),this._gpuMaterial=fpt&&fpt(),this._mainTexture=mpt&&mpt(),this._useGPU=ypt&&ypt(),this._alignSpace=vpt&&vpt(),this._particleSystem=null}get renderMode(){return this._renderMode}set renderMode(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}get velocityScale(){return this._velocityScale}set velocityScale(t){this._velocityScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}get lengthScale(){return this._lengthScale}set lengthScale(t){this._lengthScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}get mesh(){return this._mesh}set mesh(t){this._mesh=t,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}get particleMaterial(){return this._particleSystem?this._particleSystem.getSharedMaterial(0):null}set particleMaterial(t){this._particleSystem&&this._particleSystem.setSharedMaterial(t,0)}get cpuMaterial(){return this._cpuMaterial}set cpuMaterial(t){if(t){const e=t.effectName;if(-1===e.indexOf("particle")||-1!==e.indexOf("particle-gpu"))return void G(6035)}this._cpuMaterial=t,this.particleMaterial=this._cpuMaterial}get gpuMaterial(){return this._gpuMaterial}set gpuMaterial(t){t&&-1===t.effectName.indexOf("particle-gpu")?G(6035):(this._gpuMaterial=t,this.particleMaterial=this._gpuMaterial)}get trailMaterial(){return this._particleSystem?this._particleSystem.getSharedMaterial(1):null}set trailMaterial(t){this._particleSystem&&this._particleSystem.setSharedMaterial(t,1)}get mainTexture(){return this._mainTexture}set mainTexture(t){this._mainTexture=t}get useGPU(){return this._useGPU}set useGPU(t){this._useGPU!==t&&(wpt()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}get alignSpace(){return this._alignSpace}set alignSpace(t){this._alignSpace=t,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}create(t){null===this._particleSystem?this._particleSystem=t:this._particleSystem!==t&&j(6033)}onInit(t){this.create(t);const e=this._useGPU&&wpt();this._particleSystem.processor?j(6034):(this._particleSystem.processor=e?new Jdt(this):new Pdt(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(t)),e?this.gpuMaterial=this.particleMaterial:(this.particleMaterial&&-1!==this.particleMaterial.effectName.indexOf("particle-gpu")&&(this.particleMaterial=null,G(6035)),this.cpuMaterial=this.particleMaterial)}_switchProcessor(){if(!this._particleSystem)return;this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null);const t=this._useGPU&&wpt();this.particleMaterial=t?this.gpuMaterial:this.cpuMaterial,this._particleSystem.processor=t?new Jdt(this):new Pdt(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule()}}).AlignmentSpace=qht,s((cpt=bpt).prototype,"renderMode",[ept],Object.getOwnPropertyDescriptor(cpt.prototype,"renderMode"),cpt.prototype),upt=Qo(cpt.prototype,"_renderMode",[ipt,va],(function(){return Xht.Billboard})),dpt=Qo(cpt.prototype,"_velocityScale",[va],(function(){return 1})),ppt=Qo(cpt.prototype,"_lengthScale",[va],(function(){return 1})),_pt=Qo(cpt.prototype,"_mesh",[va],(function(){return null})),s(cpt.prototype,"mesh",[spt],Object.getOwnPropertyDescriptor(cpt.prototype,"mesh"),cpt.prototype),s(cpt.prototype,"particleMaterial",[rpt],Object.getOwnPropertyDescriptor(cpt.prototype,"particleMaterial"),cpt.prototype),s(cpt.prototype,"cpuMaterial",[npt],Object.getOwnPropertyDescriptor(cpt.prototype,"cpuMaterial"),cpt.prototype),gpt=Qo(cpt.prototype,"_cpuMaterial",[va],(function(){return null})),s(cpt.prototype,"gpuMaterial",[opt],Object.getOwnPropertyDescriptor(cpt.prototype,"gpuMaterial"),cpt.prototype),fpt=Qo(cpt.prototype,"_gpuMaterial",[va],(function(){return null})),s(cpt.prototype,"trailMaterial",[apt],Object.getOwnPropertyDescriptor(cpt.prototype,"trailMaterial"),cpt.prototype),mpt=Qo(cpt.prototype,"_mainTexture",[va],(function(){return null})),ypt=Qo(cpt.prototype,"_useGPU",[va],(function(){return!1})),s(cpt.prototype,"alignSpace",[hpt],Object.getOwnPropertyDescriptor(cpt.prototype,"alignSpace"),cpt.prototype),vpt=Qo(cpt.prototype,"_alignSpace",[va],(function(){return qht.View})),lpt=cpt))||lpt);var xpt,Tpt,Cpt,Ipt,Ept,Dpt,Apt,Mpt,Ppt,Bpt,Rpt,Opt,Lpt,Fpt,zpt,kpt,Npt,Upt,Vpt,Hpt,Gpt,Wpt,jpt,$pt;const qpt=Math.cos(vi(100)),Xpt={position:new Ki,velocity:new Ki},Ypt=new ys,Qpt=new Ki,Kpt=new Ki,Zpt=new _r;class Jpt{constructor(t){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new Ki,lifetime:0,width:0,velocity:new Ki,direction:0,color:new _r})}getElement(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])}addElement(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new Ki,lifetime:0,width:0,velocity:new Ki,direction:0,color:new _r}),this.start++,this.start%=this.trailElements.length);const t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]}iterateElement(t,e,i,s){const r=this.start>=this.end?this.end+this.trailElements.length:this.end;for(let n=this.start;n<r;n++)e(t,this.trailElements[n%this.trailElements.length],i,s)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)}count(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}clear(){this.start=-1,this.end=-1}}let t_t=(xpt=oa("cc.TrailModule"),Tpt=Ga(Zht),Cpt=Ga(Nat),Ipt=Ga(jht),Ept=Ga(Jht),Dpt=Ga(Nat),Apt=Ga(_ht),Mpt=Ga(_ht),Ppt=Ga(jht),xpt((Rpt=class{get enable(){return this._enable}set enable(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}get minParticleDistance(){return this._minParticleDistance}set minParticleDistance(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}get space(){return this._space}set space(t){this._space=t;const e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}getModel(){return this._trailModel}get inited(){return this._inited}constructor(){this._enable=Opt&&Opt(),this.mode=Lpt&&Lpt(),this.lifeTime=Fpt&&Fpt(),this._minParticleDistance=zpt&&zpt(),this.existWithParticles=kpt&&kpt(),this.textureMode=Npt&&Npt(),this.widthFromParticle=Upt&&Upt(),this.widthRatio=Vpt&&Vpt(),this.colorFromParticle=Hpt&&Hpt(),this.colorOverTrail=Gpt&&Gpt(),this.colorOvertime=Wpt&&Wpt(),this._space=jpt&&jpt(),this._particleSystem=$pt&&$pt(),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._psTransform=new Rs,this._iaVertCount=0,this._iaIndexCount=0,this._inited=void 0,this._vertAttrs=[new Wd("a_position",32),new Wd("a_texCoord",44),new Wd("a_texCoord1",32),new Wd("a_color",35,!0)],this._vertSize=0;for(const t of this._vertAttrs)this._vertSize+=mp[t.format].size;this._particleTrail=new Map,this._inited=!1}onInit(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;let e=0;const i=t.startLifetime.getMax(),s=t.rateOverTime.getMax(),r=t.duration;for(let s=0,n=t.bursts.length;s<n;s++)e+=t.bursts[s].getMaxCount(t)*Math.ceil(i/r);this.lifeTime.getMax()<1&&G(6036),this._trailNum=Math.ceil(i*Math.ceil(this.lifeTime.getMax())*60*(s*r+e)),this._trailSegments=new rn((()=>new Jpt(10)),Math.ceil(s*r),(t=>{t.trailElements.length=0})),this._enable&&(this.enable=this._enable),this._inited=!0}onEnable(){this._attachToScene()}onDisable(){this._particleTrail.clear(),this._detachFromScene()}_attachToScene(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))}_detachFromScene(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)}destroy(){this.destroySubMeshData(),this._trailModel&&(uP.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)}play(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)}clear(){if(this.enable){const t=this._particleTrail.values();let e=t.next();for(;!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}}updateMaterial(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))}update(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem.time,1),this.space===jht.World&&this._particleSystem.simulationSpace===jht.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(this._psTransform),this._particleSystem.node.getWorldRotation(Ypt)):this._needTransform=!1}animate(t,e){if(!this._trailSegments)return;if(t.loopCount>t.lastLoop)return void(t.trailDelay>1?(t.lastLoop=t.loopCount,t.trailDelay=0):t.trailDelay++);let i=this._particleTrail.get(t);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(t,i);let s=i.getElement(i.end-1);if(this._needTransform?Ki.transformMat4(Qpt,t.position,this._psTransform):Ki.copy(Qpt,t.position),s&&(i.iterateElement(this,this._updateTrailElement,t,e),Ki.squaredDistance(s.position,Qpt)<this._minSquaredDistance))return;if(s=i.addElement(),!s)return;Ki.copy(s.position,Qpt),s.lifetime=0,this.widthFromParticle?s.width=t.size.x*this.widthRatio.evaluate(0,1):s.width=this.widthRatio.evaluate(0,1);const r=i.count();if(2===r){const t=i.getElement(i.end-2);Ki.subtract(t.velocity,s.position,t.position)}else if(r>2){const t=i.getElement(i.end-2),e=i.getElement(i.end-3);Ki.subtract(Qpt,e.position,t.position),Ki.subtract(Kpt,s.position,t.position),Ki.subtract(t.velocity,Kpt,Qpt),Ki.equals(Ki.ZERO,t.velocity)&&Ki.copy(t.velocity,Qpt),Ki.normalize(t.velocity,t.velocity),this._checkDirectionReverse(t,e)}this.colorFromParticle?s.color.set(t.color):s.color.set(this.colorOvertime.evaluate(0,1))}removeParticle(t){const e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))}updateRenderData(){this.vbOffset=0,this.ibOffset=0;for(const t of this._particleTrail.keys()){const e=this._particleTrail.get(t);if(-1===e.start)continue;const i=4*this.vbOffset/this._vertSize,s=e.start>=e.end?e.end+e.trailElements.length:e.end,r=s-e.start,n=1/r,o=e.trailElements[e.start];this._fillVertexBuffer(o,this.colorOverTrail.evaluate(1,1),i,1,0,4);for(let t=e.start+1;t<s;t++){const s=e.trailElements[t%e.trailElements.length],o=t-e.start;this._fillVertexBuffer(s,this.colorOverTrail.evaluate(1-o/r,1),i,1-o*n,o,5)}this._needTransform?Ki.transformMat4(Xpt.position,t.position,this._psTransform):Ki.copy(Xpt.position,t.position);const a=this._trailModel;if(a&&a.node.invalidateChildren(1),1===r||2===r){const t=e.getElement(e.end-1);Ki.subtract(t.velocity,Xpt.position,t.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=t.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=t.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=t.velocity.z,this._vbF32[this.vbOffset-4]=t.velocity.x,this._vbF32[this.vbOffset-3]=t.velocity.y,this._vbF32[this.vbOffset-2]=t.velocity.z,Ki.subtract(Xpt.velocity,Xpt.position,t.position),this._checkDirectionReverse(Xpt,t)}else if(r>2){const t=e.getElement(e.end-1),s=e.getElement(e.end-2);Ki.subtract(Qpt,s.position,t.position),Ki.subtract(Kpt,Xpt.position,t.position),Ki.normalize(Qpt,Qpt),Ki.normalize(Kpt,Kpt),Ki.subtract(t.velocity,Kpt,Qpt),Ki.normalize(t.velocity,t.velocity),this._checkDirectionReverse(t,s),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(t,this.colorOverTrail.evaluate(n,1),i,n,r-1,5),Ki.subtract(Xpt.velocity,Xpt.position,t.position),Ki.normalize(Xpt.velocity,Xpt.velocity),this._checkDirectionReverse(Xpt,t)}this.widthFromParticle?Xpt.width=t.size.x*this.widthRatio.evaluate(0,1):Xpt.width=this.widthRatio.evaluate(0,1),Xpt.color=t.color,Ki.equals(Xpt.velocity,Ki.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(Xpt,this.colorOverTrail.evaluate(0,1),i,0,r,1)}this._trailModel&&(this._trailModel.enabled=this.ibOffset>0)}updateIA(t){const e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){const i=e[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),i.inputAssembler.firstIndex=0,i.inputAssembler.indexCount=t,i.inputAssembler.vertexCount=this._iaVertCount}}beforeRender(){this.updateIA(this.ibOffset)}_createModel(){this._trailModel||(this._trailModel=h.director.root.createModel(CA))}rebuild(){const t=uP.root.device,e=t.createBuffer(new Ed(10,3,this._vertSize*(this._trailNum+1)*2,this._vertSize)),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),e.update(i);const s=t.createBuffer(new Ed(6,3,12*Math.max(1,this._trailNum),2));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),s.update(this._iBuffer),this._iaVertCount=2*(this._trailNum+1),this._iaIndexCount=6*this._trailNum,this._subMeshData=new _S([e],this._vertAttrs,7,s);const r=this._trailModel;r&&this._material&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)}_updateTrailElement(t,e,i,s){return e.lifetime+=s,t.colorFromParticle?(e.color.set(i.color),e.color.multiply(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),t.widthFromParticle?e.width=i.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime}_fillVertexBuffer(t,e,i,s,r,n){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=s,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,Zpt.set(t.color),Zpt.multiply(e),this._vbUint32[this.vbOffset++]=_r.toUint32(Zpt),this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=s,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=_r.toUint32(Zpt),1&n&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&n&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)}_checkDirectionReverse(t,e){Ki.dot(t.velocity,e.velocity)<qpt?t.direction=1-e.direction:t.direction=e.direction}destroySubMeshData(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}},Opt=Qo(Rpt.prototype,"_enable",[va],(function(){return!1})),Lpt=Qo(Rpt.prototype,"mode",[Tpt,va],(function(){return Zht.Particles})),Fpt=Qo(Rpt.prototype,"lifeTime",[Cpt,va],(function(){return new Nat})),zpt=Qo(Rpt.prototype,"_minParticleDistance",[va],(function(){return.1})),s(Rpt.prototype,"space",[Ipt],Object.getOwnPropertyDescriptor(Rpt.prototype,"space"),Rpt.prototype),kpt=Qo(Rpt.prototype,"existWithParticles",[va],(function(){return!0})),Npt=Qo(Rpt.prototype,"textureMode",[Ept,va],(function(){return Jht.Stretch})),Upt=Qo(Rpt.prototype,"widthFromParticle",[va],(function(){return!0})),Vpt=Qo(Rpt.prototype,"widthRatio",[Dpt,va],(function(){return new Nat})),Hpt=Qo(Rpt.prototype,"colorFromParticle",[va],(function(){return!1})),Gpt=Qo(Rpt.prototype,"colorOverTrail",[Apt,va],(function(){return new _ht})),Wpt=Qo(Rpt.prototype,"colorOvertime",[Mpt,va],(function(){return new _ht})),jpt=Qo(Rpt.prototype,"_space",[Ppt],(function(){return jht.World})),$pt=Qo(Rpt.prototype,"_particleSystem",[va],(function(){return null})),Bpt=Rpt))||Bpt);const e_t=new Rs,i_t=new Rs,s_t=new ys,r_t=new Ki,n_t=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"];class o_t{constructor(t){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new Rs,this._gravity=new cr,this.minPos=new Ki,this.maxPos=new Ki,this._nodePos=new Ki,this._nodeSize=new Ki,this._particleSystem=t,this._processor=this._particleSystem.processor,this._node=t.node,this._particlesAll=[],this._initModuleList()}_updateBoundingNode(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)}setBoundingBoxSize(t){this.maxPos.x=this._nodePos.x+t.x,this.maxPos.y=this._nodePos.y+t.y,this.maxPos.z=this._nodePos.z+t.z,this.minPos.x=this._nodePos.x-t.x,this.minPos.y=this._nodePos.y-t.y,this.minPos.z=this._nodePos.z-t.z,this._updateBoundingNode()}setBoundingBoxCenter(t,e,i){this.maxPos.x=t+.5*this._nodeSize.x,this.maxPos.y=e+.5*this._nodeSize.y,this.maxPos.z=i+.5*this._nodeSize.z,this.minPos.x=t-.5*this._nodeSize.x,this.minPos.y=e-.5*this._nodeSize.y,this.minPos.z=i-.5*this._nodeSize.z,this._updateBoundingNode()}_initModuleList(){n_t.forEach((t=>{const e=this._particleSystem[t];e&&e.enable&&(e.needUpdate&&this._updateList.set(e.name,e),e.needAnimate&&this._animateList.set(e.name,e))})),this._runAnimateList.length=0;for(let t=0,e=Hht.length;t<e;t++){const e=this._animateList.get(Hht[t]);e&&this._runAnimateList.push(e)}}_emit(t,e,i){const s=this._particleSystem,r=this._node,n=s.time%s.duration/s.duration;r.invalidateChildren(1),s.simulationSpace===jht.World&&(r.getWorldMatrix(e_t),r.getWorldRotation(s_t));for(let r=0;r<t;++r){const t=new Uht(s);t.particleSystem=s,t.reset();const r=Ci(Ti(0,d));s._shapeModule&&s._shapeModule.enable?s._shapeModule.emit(t):(Ki.set(t.position,0,0,0),Ki.copy(t.velocity,tlt)),s._textureAnimationModule&&s._textureAnimationModule.enable&&s._textureAnimationModule.init(t);const o=s.startSpeed.evaluate(n,r);Ki.multiplyScalar(t.velocity,t.velocity,o),s.simulationSpace===jht.World&&(Ki.transformMat4(t.position,t.position,e_t),Ki.transformQuat(t.velocity,t.velocity,s_t)),Ki.copy(t.ultimateVelocity,t.velocity),Ki.set(t.rotation,0,0,0),s.startSize3D?Ki.set(t.startSize,s.startSizeX.evaluate(n,r),s.startSizeY.evaluate(n,r),s.startSizeZ.evaluate(n,r)):(Ki.set(t.startSize,s.startSizeX.evaluate(n,r),1,1),t.startSize.y=t.startSize.x),Ki.copy(t.size,t.startSize),t.startLifetime=s.startLifetime.evaluate(n,r)+e,t.remainingLifetime=t.startLifetime,i.push(t)}}_updateParticles(t,e){const i=this._particleSystem;switch(i.node.getWorldMatrix(e_t),i.scaleSpace){case jht.Local:i.node.getScale(r_t);break;case jht.World:i.node.getWorldScale(r_t)}if(this._updateList.forEach((()=>{})),i.simulationSpace===jht.Local){const t=i.node.getRotation();Rs.fromQuat(this._localMat,t),this._localMat.transpose()}i.node.parent&&(i.node.parent.getWorldMatrix(i_t),i_t.invert());for(let s=0;s<e.length;++s){const r=e[s];if(r.remainingLifetime-=t,Ki.set(r.animatedVelocity,0,0,0),i.gravityModifier.mode!==kat.Constant||0!==i.gravityModifier.constant){const e=hlt(i.gravityModifier)?Ci(r.randomSeed):0;if(i.simulationSpace===jht.Local){const s=9.8*-i.gravityModifier.evaluate(1-r.remainingLifetime/r.startLifetime,e)*t;this._gravity.x=0,this._gravity.y=s,this._gravity.z=0,this._gravity.w=1,gi(s,0,pi)||(i.node.parent&&(this._gravity=this._gravity.transformMat4(i_t)),this._gravity=this._gravity.transformMat4(this._localMat),r.velocity.x+=this._gravity.x,r.velocity.y+=this._gravity.y,r.velocity.z+=this._gravity.z)}else r.velocity.y-=9.8*i.gravityModifier.evaluate(1-r.remainingLifetime/r.startLifetime,e)*t}Ki.copy(r.ultimateVelocity,r.velocity),this._runAnimateList.forEach((e=>{e.animate(r,t)})),Ki.scaleAndAdd(r.position,r.position,r.ultimateVelocity,t)}}_calculateBounding(t){const e=new Ki,i=new Ki,s=new Ki,r=new Ki,n=new Ki(1,1,1);if(this._processor.getInfo().renderMode===Xht.Mesh){const t=this._processor.getInfo().mesh;if(t&&t.struct.minPosition&&t.struct.maxPosition){const e=new Qn;Qn.fromPoints(e,t.struct.minPosition,t.struct.maxPosition);const i=Math.max(e.halfExtents.x,e.halfExtents.y,e.halfExtents.z);n.set(i,i,i)}}const o=this._particleSystem.node.worldMatrix;for(let a=0;a<this._particlesAll.length;++a){const h=this._particlesAll[a];Ki.multiply(e,r_t,h.size),Ki.multiply(e,e,n),i.set(h.position),this._particleSystem.simulationSpace!==jht.World&&Ki.transformMat4(i,i,o),t&&0===a?(Ki.subtract(this.minPos,i,e),Ki.add(this.maxPos,i,e)):(Ki.subtract(s,i,e),Ki.add(r,i,e),Ki.min(this.minPos,this.minPos,s),Ki.max(this.maxPos,this.maxPos,r))}}calculatePositions(){this._emit(this._particleSystem.capacity,0,this._particlesAll);const t=hlt(this._particleSystem.startLifetime)?Ci(Ti(0,d)):0;this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,t),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()}clear(){this._particlesAll.length=0}destroy(){}}var a_t,h_t,l_t,c_t,u_t,d_t,p_t,__t,g_t,f_t,m_t,y_t,v_t,b_t,w_t,S_t,x_t,T_t,C_t,I_t,E_t,D_t,A_t,M_t,P_t,B_t,R_t,O_t,L_t,F_t;const{ccclass:z_t,serializable:k_t,displayOrder:N_t,type:U_t,range:V_t,slide:H_t,visible:G_t}=Ja;let W_t=(a_t=z_t("cc.NoiseModule"),h_t=U_t(Pe),l_t=U_t(Pe),c_t=U_t(Pe),u_t=U_t(Pe),d_t=U_t(Pe),p_t=U_t(Pe),__t=U_t(Pe),g_t=U_t(Pe),f_t=U_t(Pe),m_t=U_t(Pe),y_t=U_t(Me),v_t=U_t(Pe),b_t=U_t(Pe),a_t((S_t=class extends Wht{constructor(){super(),this._enable=x_t&&x_t(),this._strengthX=T_t&&T_t(),this._strengthY=C_t&&C_t(),this._strengthZ=I_t&&I_t(),this._noiseSpeedX=E_t&&E_t(),this._noiseSpeedY=D_t&&D_t(),this._noiseSpeedZ=A_t&&A_t(),this._noiseFrequency=M_t&&M_t(),this._remapX=P_t&&P_t(),this._remapY=B_t&&B_t(),this._remapZ=R_t&&R_t(),this._octaves=O_t&&O_t(),this._octaveMultiplier=L_t&&L_t(),this._octaveScale=F_t&&F_t(),this.name=Vht,this.noise=new pdt,this.samplePosition=new Ki}get enable(){return this._enable}set enable(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}get strengthX(){return this._strengthX}set strengthX(t){this._strengthX=t}get strengthY(){return this._strengthY}set strengthY(t){this._strengthY=t}get strengthZ(){return this._strengthZ}set strengthZ(t){this._strengthZ=t}get noiseSpeedX(){return this._noiseSpeedX}set noiseSpeedX(t){this._noiseSpeedX=t}get noiseSpeedY(){return this._noiseSpeedY}set noiseSpeedY(t){this._noiseSpeedY=t}get noiseSpeedZ(){return this._noiseSpeedZ}set noiseSpeedZ(t){this._noiseSpeedZ=t}get noiseFrequency(){return this._noiseFrequency}set noiseFrequency(t){this._noiseFrequency=t}get remapX(){return this._remapX}set remapX(t){this._remapX=t}get remapY(){return this._remapY}set remapY(t){this._remapY=t}get remapZ(){return this._remapZ}set remapZ(t){this._remapZ=t}get octaves(){return this._octaves}set octaves(t){this._octaves=t}get octaveMultiplier(){return this._octaveMultiplier}set octaveMultiplier(t){this._octaveMultiplier=t}get octaveScale(){return this._octaveScale}set octaveScale(t){this._octaveScale=t}animate(t,e){this.noise.setTime(t.particleSystem.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.samplePosition.set(t.position),this.samplePosition.add3f(1*wi(),1*wi(),1*wi()),this.noise.setSamplePoint(this.samplePosition),this.noise.getNoiseParticle();const i=this.noise.getResult();i.multiply3f(wi(),wi(),wi()),Ki.add(t.position,t.position,i.multiplyScalar(e))}getNoisePreview(t,e,i,s){this.noise.setTime(e.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.noise.getNoiseParticle(),this.noise.getPreview(t,i,s)}},x_t=Qo(S_t.prototype,"_enable",[k_t],(function(){return!1})),s(S_t.prototype,"strengthX",[h_t],Object.getOwnPropertyDescriptor(S_t.prototype,"strengthX"),S_t.prototype),T_t=Qo(S_t.prototype,"_strengthX",[k_t],(function(){return 10})),s(S_t.prototype,"strengthY",[l_t],Object.getOwnPropertyDescriptor(S_t.prototype,"strengthY"),S_t.prototype),C_t=Qo(S_t.prototype,"_strengthY",[k_t],(function(){return 10})),s(S_t.prototype,"strengthZ",[c_t],Object.getOwnPropertyDescriptor(S_t.prototype,"strengthZ"),S_t.prototype),I_t=Qo(S_t.prototype,"_strengthZ",[k_t],(function(){return 10})),s(S_t.prototype,"noiseSpeedX",[u_t],Object.getOwnPropertyDescriptor(S_t.prototype,"noiseSpeedX"),S_t.prototype),E_t=Qo(S_t.prototype,"_noiseSpeedX",[k_t],(function(){return 0})),s(S_t.prototype,"noiseSpeedY",[d_t],Object.getOwnPropertyDescriptor(S_t.prototype,"noiseSpeedY"),S_t.prototype),D_t=Qo(S_t.prototype,"_noiseSpeedY",[k_t],(function(){return 0})),s(S_t.prototype,"noiseSpeedZ",[p_t],Object.getOwnPropertyDescriptor(S_t.prototype,"noiseSpeedZ"),S_t.prototype),A_t=Qo(S_t.prototype,"_noiseSpeedZ",[k_t],(function(){return 0})),s(S_t.prototype,"noiseFrequency",[__t],Object.getOwnPropertyDescriptor(S_t.prototype,"noiseFrequency"),S_t.prototype),M_t=Qo(S_t.prototype,"_noiseFrequency",[k_t],(function(){return 1})),s(S_t.prototype,"remapX",[g_t],Object.getOwnPropertyDescriptor(S_t.prototype,"remapX"),S_t.prototype),P_t=Qo(S_t.prototype,"_remapX",[k_t],(function(){return 0})),s(S_t.prototype,"remapY",[f_t],Object.getOwnPropertyDescriptor(S_t.prototype,"remapY"),S_t.prototype),B_t=Qo(S_t.prototype,"_remapY",[k_t],(function(){return 0})),s(S_t.prototype,"remapZ",[m_t],Object.getOwnPropertyDescriptor(S_t.prototype,"remapZ"),S_t.prototype),R_t=Qo(S_t.prototype,"_remapZ",[k_t],(function(){return 0})),s(S_t.prototype,"octaves",[y_t],Object.getOwnPropertyDescriptor(S_t.prototype,"octaves"),S_t.prototype),O_t=Qo(S_t.prototype,"_octaves",[k_t],(function(){return 1})),s(S_t.prototype,"octaveMultiplier",[v_t],Object.getOwnPropertyDescriptor(S_t.prototype,"octaveMultiplier"),S_t.prototype),L_t=Qo(S_t.prototype,"_octaveMultiplier",[k_t],(function(){return.5})),s(S_t.prototype,"octaveScale",[b_t],Object.getOwnPropertyDescriptor(S_t.prototype,"octaveScale"),S_t.prototype),F_t=Qo(S_t.prototype,"_octaveScale",[k_t],(function(){return 2})),w_t=S_t))||w_t);var j_t,$_t,q_t,X_t,Y_t,Q_t,K_t,Z_t,J_t,tgt,egt,igt,sgt,rgt,ngt,ogt,agt,hgt,lgt,cgt,ugt,dgt,pgt,_gt,ggt,fgt,mgt,ygt,vgt,bgt,wgt,Sgt,xgt,Tgt,Cgt,Igt,Egt,Dgt,Agt,Mgt,Pgt,Bgt,Rgt,Ogt,Lgt,Fgt,zgt,kgt,Ngt,Ugt,Vgt,Hgt,Ggt,Wgt,jgt,$gt,qgt,Xgt,Ygt,Qgt,Kgt,Zgt,Jgt,tft,eft,ift,sft,rft,nft,oft,aft,hft,lft,cft,uft,dft,pft,_ft,gft,fft,mft,yft,vft,bft,wft,Sft,xft,Tft,Cft,Ift,Eft;const Dft=new Rs,Aft=new ys,Mft=Object.getOwnPropertyDescriptor(EO.prototype,"sharedMaterials");let Pft,Bft=t("ParticleSystem",(j_t=oa("cc.ParticleSystem"),$_t=ha(99),q_t=Ga(_ht),X_t=Ga(jht),Y_t=ba("startSize"),Q_t=Ga(Nat),K_t=Ga(Nat),Z_t=Ga(Nat),J_t=Ga(Nat),tgt=Ga(Nat),egt=Ga(Nat),igt=Ga(Nat),sgt=ba("startRotation"),rgt=Ga(Nat),ngt=Ga(Nat),ogt=Ga(jht),agt=Ga(Nat),hgt=Ga(Nat),lgt=Ga(Nat),cgt=Ga([Tut]),ugt=Ga(Be),dgt=Ga($ht),pgt=Ga(Pe),_gt=Ga(Pe),ggt=Ga(Pe),fgt=ba("enableCulling"),mgt=Ga(flt),ygt=Ga(flt),vgt=Ga(idt),bgt=Ga(idt),wgt=Ga(Ict),Sgt=Ga(Ict),xgt=Ga(gut),Tgt=Ga(gut),Cgt=Ga(Plt),Igt=Ga(Plt),Egt=Ga(Klt),Dgt=Ga(Klt),Agt=Ga(uct),Mgt=Ga(uct),Pgt=Ga(Zct),Bgt=Ga(Zct),Rgt=Ga(W_t),Ogt=Ga(W_t),Lgt=Ga(t_t),Fgt=Ga(t_t),zgt=Ga(Spt),j_t(kgt=$_t((Eft=class extends Rk{get capacity(){return this._capacity}set capacity(t){this._capacity=Math.floor(t>0?t:0),this.processor&&this.processor.model&&this.processor.model.setCapacity(this._capacity)}get prewarm(){return this._prewarm}set prewarm(t){!0===t&&this.loop,this._prewarm=t}get simulationSpace(){return this._simulationSpace}set simulationSpace(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}set renderCulling(t){this._renderCulling=t,t&&(this._boundingBox||(this._boundingBox=new Qn,this._calculateBounding(!1)))}get renderCulling(){return this._renderCulling}get cullingMode(){return this._cullingMode}set cullingMode(t){this._cullingMode=t}get aabbHalfX(){return this.getBoundingX()||0}set aabbHalfX(t){this.setBoundingX(t)}get aabbHalfY(){return this.getBoundingY()||0}set aabbHalfY(t){this.setBoundingY(t)}get aabbHalfZ(){return this.getBoundingZ()||0}set aabbHalfZ(t){this.setBoundingZ(t)}get dataCulling(){return this._dataCulling}set dataCulling(t){this._dataCulling=t}get sharedMaterials(){return Mft.get.call(this)}set sharedMaterials(t){Mft.set.call(this,t)}get colorOverLifetimeModule(){return this._colorOverLifetimeModule}set colorOverLifetimeModule(t){t&&(this._colorOverLifetimeModule=t)}get shapeModule(){return this._shapeModule}set shapeModule(t){t&&(this._shapeModule=t)}get sizeOvertimeModule(){return this._sizeOvertimeModule}set sizeOvertimeModule(t){t&&(this._sizeOvertimeModule=t)}get velocityOvertimeModule(){return this._velocityOvertimeModule}set velocityOvertimeModule(t){t&&(this._velocityOvertimeModule=t)}get forceOvertimeModule(){return this._forceOvertimeModule}set forceOvertimeModule(t){t&&(this._forceOvertimeModule=t)}get limitVelocityOvertimeModule(){return this._limitVelocityOvertimeModule}set limitVelocityOvertimeModule(t){t&&(this._limitVelocityOvertimeModule=t)}get rotationOvertimeModule(){return this._rotationOvertimeModule}set rotationOvertimeModule(t){t&&(this._rotationOvertimeModule=t)}get textureAnimationModule(){return this._textureAnimationModule}set textureAnimationModule(t){t&&(this._textureAnimationModule=t)}get noiseModule(){return this._noiseModule}set noiseModule(t){t&&(this._noiseModule=t)}get trailModule(){return this._trailModule}set trailModule(t){t&&(this._trailModule=t)}constructor(){super(),this.startColor=Ugt&&Ugt(),this.scaleSpace=Vgt&&Vgt(),this.startSize3D=Hgt&&Hgt(),this.startSizeX=Ggt&&Ggt(),this.startSizeY=Wgt&&Wgt(),this.startSizeZ=jgt&&jgt(),this.startSpeed=$gt&&$gt(),this.startRotation3D=qgt&&qgt(),this.startRotationX=Xgt&&Xgt(),this.startRotationY=Ygt&&Ygt(),this.startRotationZ=Qgt&&Qgt(),this.startDelay=Kgt&&Kgt(),this.startLifetime=Zgt&&Zgt(),this.duration=Jgt&&Jgt(),this.loop=tft&&tft(),this.simulationSpeed=eft&&eft(),this.playOnAwake=ift&&ift(),this.gravityModifier=sft&&sft(),this.rateOverTime=rft&&rft(),this.rateOverDistance=nft&&nft(),this.bursts=oft&&oft(),this._renderCulling=aft&&aft(),this._cullingMode=hft&&hft(),this._aabbHalfX=lft&&lft(),this._aabbHalfY=cft&&cft(),this._aabbHalfZ=uft&&uft(),this._dataCulling=dft&&dft(),this._colorOverLifetimeModule=pft&&pft(),this._shapeModule=_ft&&_ft(),this._sizeOvertimeModule=gft&&gft(),this._velocityOvertimeModule=fft&&fft(),this._forceOvertimeModule=mft&&mft(),this._limitVelocityOvertimeModule=yft&&yft(),this._rotationOvertimeModule=vft&&vft(),this._textureAnimationModule=bft&&bft(),this._noiseModule=wft&&wft(),this._trailModule=Sft&&Sft(),this.renderer=xft&&xft(),this._isPlaying=void 0,this._isPaused=void 0,this._isStopped=void 0,this._isEmitting=void 0,this._needToRestart=void 0,this._needRefresh=void 0,this._time=void 0,this._emitRateTimeCounter=void 0,this._emitRateDistanceCounter=void 0,this._oldWPos=void 0,this._curWPos=void 0,this._boundingBox=void 0,this._culler=void 0,this._oldPos=void 0,this._curPos=void 0,this._isCulled=void 0,this._isSimulating=void 0,this._customData1=void 0,this._customData2=void 0,this._subEmitters=void 0,this._needAttach=void 0,this._prewarm=Tft&&Tft(),this._capacity=Cft&&Cft(),this._simulationSpace=Ift&&Ift(),this.processor=null,this.rateOverTime.constant=10,this.startLifetime.constant=5,this.startSizeX.constant=1,this.startSpeed.constant=5,this._isPlaying=!1,this._isPaused=!1,this._isStopped=!0,this._isEmitting=!1,this._needToRestart=!1,this._needRefresh=!0,this._needAttach=!1,this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._oldWPos=new Ki,this._curWPos=new Ki,this._boundingBox=null,this._culler=null,this._oldPos=null,this._curPos=null,this._isCulled=!1,this._isSimulating=!0,this._customData1=new Qs,this._customData2=new Qs,this._subEmitters=[]}onFocusInEditor(){this.renderer.create(this)}onLoad(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&!this.renderer.useGPU&&this._trailModule.enable&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()}_onMaterialModified(t,e){null!==this.processor&&this.processor.onMaterialModified(t,e)}_onRebuildPSO(t,e){this.processor.onRebuildPSO(t,e)}_collectModels(){return this._models.length=0,this._models.push(this.processor.model),this._trailModule&&this._trailModule.enable&&this._trailModule.getModel()&&this._models.push(this._trailModule.getModel()),this._models}_attachToScene(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()}_detachFromScene(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)}bindModule(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor),this._noiseModule&&this._noiseModule.bindTarget(this.processor)}play(){if(this._needToRestart&&(this.reset(),this._needToRestart=!1),this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){const t=this.processor.getModel();t&&(t.enabled=this.enabledInHierarchy)}}pause(){this._isStopped?P("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}stopEmitting(){this._isEmitting=!1,this._needToRestart=!0}stop(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._isEmitting&&(this._isEmitting=!1),this._isStopped=!0,this._needRefresh=!0,this.reset()}reset(){this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._resetPosition();for(const t of this.bursts)t.reset()}clear(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)}getParticleCount(){return this.processor?this.processor.getParticleCount():0}setCustomData1(t,e){Qs.set(this._customData1,t,e)}setCustomData2(t,e){Qs.set(this._customData2,t,e)}onDestroy(){var t;this.stop(),null!==(t=this.processor.getModel())&&void 0!==t&&t.scene&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()),uP.off("director_before_commit",this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)}onEnable(){super.onEnable(),uP.on("director_before_commit",this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()}onDisable(){uP.off("director_before_commit",this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._oldPos=null,this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)}_calculateBounding(t){this._boundingBox&&(this._culler||(this._culler=new o_t(this)),this._culler.calculatePositions(),Qn.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),t?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())}update(t){const e=t*this.simulationSpeed;if(this.renderCulling){var i;if(this._boundingBox||(this._boundingBox=new Qn,this._calculateBounding(!1)),this._curPos||(this._curPos=new Ki),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new Ki,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){const t=this._curPos.x-this._oldPos.x,e=this._curPos.y-this._oldPos.y,i=this._curPos.z-this._oldPos.z,s=this._boundingBox.center;s.x+=t,s.y+=e,s.z+=i,this._culler.setBoundingBoxCenter(s.x,s.y,s.z),this._oldPos.set(this._curPos)}const t=null===(i=this.node.scene.renderScene)||void 0===i?void 0:i.cameras;let s=!0;if(void 0!==t&&this._boundingBox)for(let e=0;e<t.length;++e){const i=t[e];if((i.visibility&this.node.layer)===this.node.layer&&ko.aabbFrustum(this._boundingBox,i.frustum)){s=!1;break}}if(s){if(this._cullingMode!==$ht.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===$ht.PauseAndCatchup&&(this._time+=e),this._cullingMode!==$ht.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=e,this._emit(e),0!==this.processor.updateParticles(e)||this._isEmitting||this.stop();else{const t=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0];this.processor.updateRotation(t),this.processor.updateScale(t)}var s,r;this._needAttach&&this.getParticleCount()>0&&!this._isCulled&&(null!==(s=this.processor.getModel())&&void 0!==s&&s.scene||this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&(null!==(r=this._trailModule.getModel())&&void 0!==r&&r.scene||this._trailModule._attachToScene()),this._needAttach=!1);!this.renderer.useGPU&&this._trailModule&&this._trailModule.enable&&(this._trailModule.inited||(this._trailModule.clear(),this._trailModule.destroy(),this._trailModule.onInit(this),this._trailModule.enable=!1,this._trailModule.enable=!0))}beforeRender(){var t,e;this.getParticleCount()<=0?null!==(e=this.processor.getModel())&&void 0!==e&&e.scene&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._needAttach=!1):null!==(t=this.processor.getModel())&&void 0!==t&&t.scene||(this._needAttach=!0),this._isPlaying&&(this.processor.updateRenderData(),this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&(this._trailModule.updateRenderData(),this._trailModule.beforeRender()))}_onVisibilityChange(t){this.processor.model&&(this.processor.model.visFlags=t)}emit(t,e){const i=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(1),this._needRefresh=!1),this._simulationSpace===jht.World&&(this.node.getWorldMatrix(Dft),this.node.getWorldRotation(Aft));for(let s=0;s<t;++s){const t=this.processor.getFreeParticle();if(null===t)return;t.particleSystem=this,t.reset();const s=Ci(Ti(0,d));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(t):(Ki.set(t.position,0,0,0),Ki.copy(t.velocity,tlt)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(t);const r=this.startSpeed.evaluate(i,s);Ki.multiplyScalar(t.velocity,t.velocity,r),this._simulationSpace===jht.World&&(Ki.transformMat4(t.position,t.position,Dft),Ki.transformQuat(t.velocity,t.velocity,Aft)),Ki.copy(t.ultimateVelocity,t.velocity),this.startRotation3D?t.startEuler.set(this.startRotationX.evaluate(i,s),this.startRotationY.evaluate(i,s),this.startRotationZ.evaluate(i,s)):t.startEuler.set(0,0,this.startRotationZ.evaluate(i,s)),t.rotation.set(t.startEuler),this.startSize3D?Ki.set(t.startSize,this.startSizeX.evaluate(i,s),this.startSizeY.evaluate(i,s),this.startSizeZ.evaluate(i,s)):(Ki.set(t.startSize,this.startSizeX.evaluate(i,s),1,1),t.startSize.y=t.startSize.x),Ki.copy(t.size,t.startSize),t.startColor.set(this.startColor.evaluate(i,s)),t.color.set(t.startColor),t.startLifetime=this.startLifetime.evaluate(i,s)+e,t.remainingLifetime=t.startLifetime,t.randomSeed=Ti(0,233280),t.loopCount++,this.processor.setNewParticle(t)}}_prewarmSystem(){this.startDelay.mode=kat.Constant,this.startDelay.constant=0;const t=this.duration/1;for(let e=0;e<t;++e)this._time+=1,this._emit(1),this.processor.updateParticles(1)}_emit(t){const e=this.startDelay.evaluate(0,1);if(this._time>e){if(this._time>this.duration+e&&(this.loop||(this._isEmitting=!1)),!this._isEmitting)return;if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*t,this._emitRateTimeCounter>1){const e=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=e,this.emit(e,t)}const i=this.rateOverDistance.evaluate(this._time/this.duration,1);if(i>0){Ki.copy(this._oldWPos,this._curWPos),this.node.getWorldPosition(this._curWPos);const t=Ki.distance(this._curWPos,this._oldWPos);this._emitRateDistanceCounter+=t*i}if(this._emitRateDistanceCounter>1){const e=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=e,this.emit(e,t)}for(const e of this.bursts)e.update(this,t)}}_resetPosition(){this.node.getWorldPosition(this._oldWPos),Ki.copy(this._curWPos,this._oldWPos)}addSubEmitter(t){this._subEmitters.push(t)}removeSubEmitter(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)}addBurst(t){this.bursts.push(t)}removeBurst(t){const e=this.bursts.indexOf(t);e>-1&&this.bursts.splice(e,1)}getBoundingX(){return this._aabbHalfX}getBoundingY(){return this._aabbHalfY}getBoundingZ(){return this._aabbHalfZ}setBoundingX(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=t)}setBoundingY(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=t)}setBoundingZ(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=t)}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isStopped(){return this._isStopped}get isEmitting(){return this._isEmitting}get time(){return this._time}_onBeforeSerialize(t){return this.dataCulling?t.filter((t=>!Ght.includes(t)||this[t]&&this[t].enable)):t}getNoisePreview(t,e){const i=[];return this.processor&&this.processor.getNoisePreview(i,t,e),i}},Eft.CullingMode=$ht,Ugt=Qo((Ngt=Eft).prototype,"startColor",[q_t,va],(function(){return new _ht})),Vgt=Qo(Ngt.prototype,"scaleSpace",[X_t,va],(function(){return jht.Local})),Hgt=Qo(Ngt.prototype,"startSize3D",[va],(function(){return!1})),Ggt=Qo(Ngt.prototype,"startSizeX",[Y_t,Q_t],(function(){return new Nat})),Wgt=Qo(Ngt.prototype,"startSizeY",[K_t,va],(function(){return new Nat})),jgt=Qo(Ngt.prototype,"startSizeZ",[Z_t,va],(function(){return new Nat})),$gt=Qo(Ngt.prototype,"startSpeed",[J_t,va],(function(){return new Nat})),qgt=Qo(Ngt.prototype,"startRotation3D",[va],(function(){return!1})),Xgt=Qo(Ngt.prototype,"startRotationX",[tgt,va],(function(){return new Nat})),Ygt=Qo(Ngt.prototype,"startRotationY",[egt,va],(function(){return new Nat})),Qgt=Qo(Ngt.prototype,"startRotationZ",[igt,sgt],(function(){return new Nat})),Kgt=Qo(Ngt.prototype,"startDelay",[rgt,va],(function(){return new Nat})),Zgt=Qo(Ngt.prototype,"startLifetime",[ngt,va],(function(){return new Nat})),Jgt=Qo(Ngt.prototype,"duration",[va],(function(){return 5})),tft=Qo(Ngt.prototype,"loop",[va],(function(){return!0})),s(Ngt.prototype,"simulationSpace",[ogt,va],Object.getOwnPropertyDescriptor(Ngt.prototype,"simulationSpace"),Ngt.prototype),eft=Qo(Ngt.prototype,"simulationSpeed",[va],(function(){return 1})),ift=Qo(Ngt.prototype,"playOnAwake",[va],(function(){return!0})),sft=Qo(Ngt.prototype,"gravityModifier",[agt,va],(function(){return new Nat})),rft=Qo(Ngt.prototype,"rateOverTime",[hgt,va],(function(){return new Nat})),nft=Qo(Ngt.prototype,"rateOverDistance",[lgt,va],(function(){return new Nat})),oft=Qo(Ngt.prototype,"bursts",[cgt,va],(function(){return[]})),s(Ngt.prototype,"renderCulling",[ugt],Object.getOwnPropertyDescriptor(Ngt.prototype,"renderCulling"),Ngt.prototype),aft=Qo(Ngt.prototype,"_renderCulling",[va],(function(){return!1})),s(Ngt.prototype,"cullingMode",[dgt],Object.getOwnPropertyDescriptor(Ngt.prototype,"cullingMode"),Ngt.prototype),hft=Qo(Ngt.prototype,"_cullingMode",[va],(function(){return $ht.Pause})),s(Ngt.prototype,"aabbHalfX",[pgt],Object.getOwnPropertyDescriptor(Ngt.prototype,"aabbHalfX"),Ngt.prototype),lft=Qo(Ngt.prototype,"_aabbHalfX",[va],(function(){return 0})),s(Ngt.prototype,"aabbHalfY",[_gt],Object.getOwnPropertyDescriptor(Ngt.prototype,"aabbHalfY"),Ngt.prototype),cft=Qo(Ngt.prototype,"_aabbHalfY",[va],(function(){return 0})),s(Ngt.prototype,"aabbHalfZ",[ggt],Object.getOwnPropertyDescriptor(Ngt.prototype,"aabbHalfZ"),Ngt.prototype),uft=Qo(Ngt.prototype,"_aabbHalfZ",[va],(function(){return 0})),dft=Qo(Ngt.prototype,"_dataCulling",[va,fgt],(function(){return!1})),s(Ngt.prototype,"sharedMaterials",[Wa,va],Object.getOwnPropertyDescriptor(Ngt.prototype,"sharedMaterials"),Ngt.prototype),pft=Qo(Ngt.prototype,"_colorOverLifetimeModule",[mgt],(function(){return null})),s(Ngt.prototype,"colorOverLifetimeModule",[ygt],Object.getOwnPropertyDescriptor(Ngt.prototype,"colorOverLifetimeModule"),Ngt.prototype),_ft=Qo(Ngt.prototype,"_shapeModule",[vgt],(function(){return null})),s(Ngt.prototype,"shapeModule",[bgt],Object.getOwnPropertyDescriptor(Ngt.prototype,"shapeModule"),Ngt.prototype),gft=Qo(Ngt.prototype,"_sizeOvertimeModule",[wgt],(function(){return null})),s(Ngt.prototype,"sizeOvertimeModule",[Sgt],Object.getOwnPropertyDescriptor(Ngt.prototype,"sizeOvertimeModule"),Ngt.prototype),fft=Qo(Ngt.prototype,"_velocityOvertimeModule",[xgt],(function(){return null})),s(Ngt.prototype,"velocityOvertimeModule",[Tgt],Object.getOwnPropertyDescriptor(Ngt.prototype,"velocityOvertimeModule"),Ngt.prototype),mft=Qo(Ngt.prototype,"_forceOvertimeModule",[Cgt],(function(){return null})),s(Ngt.prototype,"forceOvertimeModule",[Igt],Object.getOwnPropertyDescriptor(Ngt.prototype,"forceOvertimeModule"),Ngt.prototype),yft=Qo(Ngt.prototype,"_limitVelocityOvertimeModule",[Egt],(function(){return null})),s(Ngt.prototype,"limitVelocityOvertimeModule",[Dgt],Object.getOwnPropertyDescriptor(Ngt.prototype,"limitVelocityOvertimeModule"),Ngt.prototype),vft=Qo(Ngt.prototype,"_rotationOvertimeModule",[Agt],(function(){return null})),s(Ngt.prototype,"rotationOvertimeModule",[Mgt],Object.getOwnPropertyDescriptor(Ngt.prototype,"rotationOvertimeModule"),Ngt.prototype),bft=Qo(Ngt.prototype,"_textureAnimationModule",[Pgt],(function(){return null})),s(Ngt.prototype,"textureAnimationModule",[Bgt],Object.getOwnPropertyDescriptor(Ngt.prototype,"textureAnimationModule"),Ngt.prototype),wft=Qo(Ngt.prototype,"_noiseModule",[Rgt],(function(){return null})),s(Ngt.prototype,"noiseModule",[Ogt],Object.getOwnPropertyDescriptor(Ngt.prototype,"noiseModule"),Ngt.prototype),Sft=Qo(Ngt.prototype,"_trailModule",[Lgt],(function(){return null})),s(Ngt.prototype,"trailModule",[Fgt],Object.getOwnPropertyDescriptor(Ngt.prototype,"trailModule"),Ngt.prototype),xft=Qo(Ngt.prototype,"renderer",[zgt,va],(function(){return new Spt})),Tft=Qo(Ngt.prototype,"_prewarm",[va],(function(){return!1})),Cft=Qo(Ngt.prototype,"_capacity",[va],(function(){return 100})),Ift=Qo(Ngt.prototype,"_simulationSpace",[va],(function(){return jht.Local})),kgt=Ngt))||kgt)||kgt));class Rft{static instantiate(t){this.registeredSceneEvent||(uP.on("director_before_scene_launch",this.onSceneUnload,this),this.registeredSceneEvent=!0);const e=t._uuid;if(!this.particleSystemPool.has(e)){const i=new rn((()=>rZ(t)||new JS),1,(t=>t.destroy()));this.particleSystemPool.set(e,i)}return this.particleSystemPool.get(e).alloc()}static destroy(t){var e,i;const s=null===(e=t.prefab)||void 0===e||null===(i=e.asset)||void 0===i?void 0:i.uuid;s&&this.particleSystemPool.has(s)&&(this.stop(t),this.particleSystemPool.get(s).free(t))}static play(t){for(const e of t.getComponentsInChildren(Bft))e.play()}static stop(t){for(const e of t.getComponentsInChildren(Bft))e.stop()}static onSceneUnload(){this.particleSystemPool.forEach((t=>t.destroy())),this.particleSystemPool.clear()}}function Oft(t){h._global.CC_PHYSICS_BUILTIN="builtin"===t,h._global.CC_PHYSICS_CANNON="cannon.js"===t,h._global.CC_PHYSICS_AMMO="bullet"===t}t("ParticleUtils",Rft),Rft.particleSystemPool=new Map,Rft.registeredSceneEvent=!1,h.ParticleUtils=Rft;const Lft={id:"",switchTo:function(t){if(!Lft.runInEditor)return;const e=Lft;if(Lft.physicsWorld&&t!==Lft.id&&null!=Lft.backend[t]?(Lft.physicsWorld.destroy(),M(`[PHYSICS]: switch from ${Lft.id} to ${t}.`),Oft(t),e.id=t,e.wrapper=Lft.backend[t],e.physicsWorld=Vft()):(M(`[PHYSICS]: using ${t}.`),e.physicsWorld=Vft()),Pft){const t=e.physicsWorld;t.setGravity(Pft.gravity),t.setAllowSleep(Pft.allowSleep)}},register:function(t,e){if(M(`[PHYSICS]: register ${t}.`),Lft.backend[t]=e,!Lft.physicsWorld||Lft.id===t){Oft(t);const i=Lft;i.id=t,i.wrapper=e}},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0};function Fft(t){if(Pft||(Pft=t),Lft.runInEditor&&!Lft.physicsWorld){M(`[PHYSICS]: using ${Lft.id}.`);const t=Lft.physicsWorld=Vft();t.setGravity(Pft.gravity),t.setAllowSleep(Pft.allowSleep)}}const zft=function(){return 0},kft={impl:null,debugDrawFlags:0,debugDrawConstraintSize:0,setGravity:zft,setAllowSleep:zft,setDefaultMaterial:zft,step:zft,syncAfterEvents:zft,syncSceneToPhysics:zft,raycast:zft,raycastClosest:zft,sweepBox:zft,sweepBoxClosest:zft,sweepSphere:zft,sweepSphereClosest:zft,sweepCapsule:zft,sweepCapsuleClosest:zft,emitEvents:zft,destroy:zft},Nft={World:0,RigidBody:1,BoxCollider:2,SphereCollider:3,CapsuleCollider:4,MeshCollider:5,CylinderCollider:6,ConeCollider:7,TerrainCollider:8,SimplexCollider:9,PlaneCollider:10,PointToPointConstraint:11,HingeConstraint:12,FixedConstraint:13,ConfigurableConstraint:14,BoxCharacterController:15,CapsuleCharacterController:16};function Uft(t,e){return null==t&&(Lft.id?P(`${Lft.id} physics does not support ${Nft[e]}`):j(9600),!0)}function Vft(){return Uft(Lft.wrapper.PhysicsWorld,0)?kft:new Lft.wrapper.PhysicsWorld}const Hft={impl:null,rigidBody:null,isAwake:!1,isSleepy:!1,isSleeping:!1,initialize:zft,onEnable:zft,onDisable:zft,onDestroy:zft,setType:zft,setMass:zft,setLinearDamping:zft,setAngularDamping:zft,useGravity:zft,setLinearFactor:zft,setAngularFactor:zft,setAllowSleep:zft,wakeUp:zft,sleep:zft,clearState:zft,clearForces:zft,clearVelocity:zft,setSleepThreshold:zft,getSleepThreshold:zft,getLinearVelocity:zft,setLinearVelocity:zft,getAngularVelocity:zft,setAngularVelocity:zft,applyForce:zft,applyLocalForce:zft,applyImpulse:zft,applyLocalImpulse:zft,applyTorque:zft,applyLocalTorque:zft,setGroup:zft,getGroup:zft,addGroup:zft,removeGroup:zft,setMask:zft,getMask:zft,addMask:zft,removeMask:zft,isUsingCCD:zft,useCCD:zft},Gft={INITED:!1},Wft={impl:null,collider:null,attachedRigidBody:null,initialize:zft,onLoad:zft,onEnable:zft,onDisable:zft,onDestroy:zft,setGroup:zft,getGroup:zft,addGroup:zft,removeGroup:zft,setMask:zft,getMask:zft,addMask:zft,removeMask:zft,setMaterial:zft,setAsTrigger:zft,setCenter:zft,getAABB:zft,getBoundingSphere:zft,updateSize:zft,updateRadius:zft,setRadius:zft,setCylinderHeight:zft,setDirection:zft,setHeight:zft,setShapeType:zft,setVertices:zft,setMesh:zft,setTerrain:zft,setNormal:zft,setConstant:zft,updateEventListener:zft};function jft(t){return Gft.INITED||(Gft.INITED=!0,Gft[0]=function(){return Uft(Lft.wrapper.BoxShape,2)?Wft:new Lft.wrapper.BoxShape},Gft[1]=function(){return Uft(Lft.wrapper.SphereShape,3)?Wft:new Lft.wrapper.SphereShape},Gft[2]=function(){return Uft(Lft.wrapper.CapsuleShape,4)?Wft:new Lft.wrapper.CapsuleShape},Gft[3]=function(){return Uft(Lft.wrapper.CylinderShape,6)?Wft:new Lft.wrapper.CylinderShape},Gft[4]=function(){return Uft(Lft.wrapper.ConeShape,7)?Wft:new Lft.wrapper.ConeShape},Gft[5]=function(){return Uft(Lft.wrapper.TrimeshShape,5)?Wft:new Lft.wrapper.TrimeshShape},Gft[8]=function(){return Uft(Lft.wrapper.TerrainShape,8)?Wft:new Lft.wrapper.TerrainShape},Gft[7]=function(){return Uft(Lft.wrapper.SimplexShape,9)?Wft:new Lft.wrapper.SimplexShape},Gft[6]=function(){return Uft(Lft.wrapper.PlaneShape,10)?Wft:new Lft.wrapper.PlaneShape}),Gft[t]()}const $ft={INITED:!1},qft={impl:null,initialize:zft,onLoad:zft,onEnable:zft,onDisable:zft,onDestroy:zft,setEnableCollision:zft,setConnectedBody:zft,setPivotA:zft,setPivotB:zft,setAxis:zft,setSecondaryAxis:zft,setBreakForce:zft,setBreakTorque:zft,setConstraintMode:zft,setLinearLimit:zft,setAngularExtent:zft,setLinearSoftConstraint:zft,setLinearStiffness:zft,setLinearDamping:zft,setLinearRestitution:zft,setSwingSoftConstraint:zft,setTwistSoftConstraint:zft,setSwingStiffness:zft,setSwingDamping:zft,setSwingRestitution:zft,setTwistStiffness:zft,setTwistDamping:zft,setTwistRestitution:zft,setDriverMode:zft,setLinearMotorTarget:zft,setLinearMotorVelocity:zft,setLinearMotorForceLimit:zft,setAngularMotorTarget:zft,setAngularMotorVelocity:zft,setAngularMotorForceLimit:zft,setAutoPivotB:zft,setLimitEnabled:zft,setLowerLimit:zft,setUpperLimit:zft,setMotorEnabled:zft,setMotorVelocity:zft,setMotorForceLimit:zft};function Xft(t){return $ft.INITED||($ft.INITED=!0,$ft[0]=function(){return Uft(Lft.wrapper.PointToPointConstraint,11)?qft:new Lft.wrapper.PointToPointConstraint},$ft[1]=function(){return Uft(Lft.wrapper.HingeConstraint,12)?qft:new Lft.wrapper.HingeConstraint},$ft[2]=function(){return Uft(Lft.wrapper.FixedConstraint,13)?qft:new Lft.wrapper.FixedConstraint},$ft[3]=function(){return Uft(Lft.wrapper.ConfigurableConstraint,14)?qft:new Lft.wrapper.ConfigurableConstraint}),$ft[t]()}const Yft={INITED:!1},Qft={initialize:zft,onLoad:zft,onEnable:zft,onDisable:zft,onDestroy:zft,onGround:zft,getPosition:zft,setPosition:zft,setStepOffset:zft,setSlopeLimit:zft,setContactOffset:zft,setDetectCollisions:zft,setOverlapRecovery:zft,setGroup:zft,getGroup:zft,addGroup:zft,removeGroup:zft,setMask:zft,getMask:zft,addMask:zft,removeMask:zft,move:zft,syncPhysicsToScene:zft,updateEventListener:zft,setHalfHeight:zft,setHalfSideExtent:zft,setHalfForwardExtent:zft,setRadius:zft,setHeight:zft};function Kft(t){return Yft.INITED||(Yft.INITED=!0,Yft[0]=function(){return Uft(Lft.wrapper.BoxCharacterController,15)?Qft:new Lft.wrapper.BoxCharacterController},Yft[1]=function(){return Uft(Lft.wrapper.CapsuleCharacterController,16)?Qft:new Lft.wrapper.CapsuleCharacterController}),Yft[t]()}let Zft={};const Jft={BODY_CACHE_NAME:"body",CCT_CACHE_NAME:"cct"};TP.onPostInfrastructureInitDelegate.add((function(){return NP().then((()=>Promise.all([e.import("./bullet.release.wasm-1fDRrQ3c.js").then((function(t){return t.b})),e.import("./bullet.release.wasm-vGDNSL-o.js")]).then((t=>{let[{default:e},{default:i}]=t;return s=e,r=i,new Promise(((t,e)=>{const i=t=>`[bullet]: bullet wasm lib load failed: ${t}`;s({instantiateWasm(t,s){kP(r,t).then((t=>{s(t.instance,t.module)})).catch((t=>e(i(t))))}}).then((t=>{M("[bullet]:bullet wasm lib loaded."),Zft=t,globalThis.Bullet=Zft})).then(t).catch((t=>e(i(t))))}));var s,r})))).catch((t=>{B(t)}))}));const tmt={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},emt={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},imt={type:"onControllerTriggerEnter",collider:null,characterController:null,impl:null};class smt{constructor(){this.BT_TRANSFORM_0=Zft.Transform_new(),this.BT_TRANSFORM_1=Zft.Transform_new(),this.BT_V3_0=Zft.Vec3_new(0,0,0),this.BT_V3_1=Zft.Vec3_new(0,0,0),this.BT_V3_2=Zft.Vec3_new(0,0,0),this.BT_QUAT_0=Zft.Quat_new(0,0,0,1)}static get instance(){return null==smt._instance&&(smt._instance=new smt),smt._instance}static setWrapper(t,e,i){this.ROOT[e]||(this.ROOT[e]={}),this.ROOT[e][t]=i}static delWrapper(t,e){delete this.ROOT[e][t]}static getWrapper(t,e){return this.ROOT[e][t]}static isNotEmptyShape(t){return t!==Zft.EmptyShape_static()}}smt._instance=void 0,smt.ROOT={};const rmt=new Ki,nmt=new Ki,omt=new Ki,amt=new ys,hmt=new ys,lmt=new Rs;new Rs;const cmt=new _r;function umt(t,e){return Zft.Vec3_set(t,e.x,e.y,e.z),t}function dmt(t,e){const i=Zft.HEAPF32.subarray(e/4,e/4+3);return t.x=i[0],t.y=i[1],t.z=i[2],t}function pmt(t,e){return Zft.Quat_set(t,e.x,e.y,e.z,e.w),t}function _mt(t,e){const i=Zft.HEAPF32.subarray(e/4,e/4+4);return t.x=i[0],t.y=i[1],t.z=i[2],t.w=i[3],t}function gmt(t,e){const i=e.renderingSubMeshes.length;for(let s=0;s<i;s++){const i=e.renderingSubMeshes[s],r=i.geometricInfo;if(r){const e=i.primitiveMode,s=r.positions,n=r.indices,o=smt.instance.BT_V3_0,a=smt.instance.BT_V3_1,h=smt.instance.BT_V3_2;if(7===e){const e=n.length;for(let i=0;i<e;i+=3){const e=3*n[i],r=3*n[i+1],l=3*n[i+2];Zft.Vec3_set(o,s[e],s[e+1],s[e+2]),Zft.Vec3_set(a,s[r],s[r+1],s[r+2]),Zft.Vec3_set(h,s[l],s[l+1],s[l+2]),Zft.TriangleMesh_addTriangle(t,o,a,h,!1)}}else if(8===e){const e=n.length-2;let i=0;for(let r=0;r<e;r+=1){const e=3*n[r-i],l=3*n[r+i+1],c=3*n[r+2];i=~i,Zft.Vec3_set(o,s[e],s[e+1],s[e+2]),Zft.Vec3_set(a,s[l],s[l+1],s[l+2]),Zft.Vec3_set(h,s[c],s[c+1],s[c+2]),Zft.TriangleMesh_addTriangle(t,o,a,h,!1)}}else if(9===e){const e=n.length-1,i=3*n[0];Zft.Vec3_set(o,s[i],s[i+1],s[i+2]);for(let i=1;i<e;i+=1){const e=3*n[i],r=3*n[i+1];Zft.Vec3_set(a,s[e],s[e+1],s[e+2]),Zft.Vec3_set(h,s[r],s[r+1],s[r+2]),Zft.TriangleMesh_addTriangle(t,o,a,h,!1)}}}}return t}function fmt(t,e){return t*e}var mmt,ymt,vmt,bmt,wmt,Smt,xmt,Tmt,Cmt,Imt,Emt,Dmt;Jft.CACHE=smt;let Amt=t("PhysicsMaterial",(mmt=oa("cc.PhysicsMaterial"),ymt=Ga(Pe),vmt=Ga(Pe),bmt=Ga(Pe),wmt=Ga(Pe),mmt((Dmt=class t extends F_{get friction(){return this._friction}set friction(e){_i(this._friction,e)||(this._friction=e,this.emit(t.EVENT_UPDATE))}get rollingFriction(){return this._rollingFriction}set rollingFriction(e){_i(this._rollingFriction,e)||(this._rollingFriction=e,this.emit(t.EVENT_UPDATE))}get spinningFriction(){return this._spinningFriction}set spinningFriction(e){_i(this._spinningFriction,e)||(this._spinningFriction=e,this.emit(t.EVENT_UPDATE))}get restitution(){return this._restitution}set restitution(e){_i(this._restitution,e)||(this._restitution=e,this.emit(t.EVENT_UPDATE))}constructor(){super(),this.id=void 0,this._friction=Tmt&&Tmt(),this._rollingFriction=Cmt&&Cmt(),this._spinningFriction=Imt&&Imt(),this._restitution=Emt&&Emt(),t.allMaterials.push(this),this.id=t._idCounter++,this._uuid||(this._uuid=`pm_${this.id}`)}clone(){const e=new t;return e._friction=this._friction,e._restitution=this._restitution,e._rollingFriction=this._rollingFriction,e._spinningFriction=this._spinningFriction,e}destroy(){if(super.destroy()){const e=t.allMaterials.indexOf(this);return e>=0&&t.allMaterials.splice(e,1),!0}return!1}setValues(e,i,s,r){const n=this._friction!==e||this._rollingFriction!==i||this._spinningFriction!==s||this._restitution!==r;this._friction=e,this._rollingFriction=i,this._spinningFriction=s,this._restitution=r,n&&this.emit(t.EVENT_UPDATE)}},Dmt.allMaterials=[],Dmt.EVENT_UPDATE="event_update",Dmt._idCounter=0,s((xmt=Dmt).prototype,"friction",[ymt],Object.getOwnPropertyDescriptor(xmt.prototype,"friction"),xmt.prototype),s(xmt.prototype,"rollingFriction",[vmt],Object.getOwnPropertyDescriptor(xmt.prototype,"rollingFriction"),xmt.prototype),s(xmt.prototype,"spinningFriction",[bmt],Object.getOwnPropertyDescriptor(xmt.prototype,"spinningFriction"),xmt.prototype),s(xmt.prototype,"restitution",[wmt],Object.getOwnPropertyDescriptor(xmt.prototype,"restitution"),xmt.prototype),Tmt=Qo(xmt.prototype,"_friction",[va],(function(){return.6})),Cmt=Qo(xmt.prototype,"_rollingFriction",[va],(function(){return 0})),Imt=Qo(xmt.prototype,"_spinningFriction",[va],(function(){return 0})),Emt=Qo(xmt.prototype,"_restitution",[va],(function(){return 0})),Smt=xmt))||Smt));class Mmt{constructor(){this._hitPoint=new Ki,this._hitNormal=new Ki,this._distance=0,this._collider=null,this._closestHitFraction=0}get hitPoint(){return this._hitPoint}get distance(){return this._distance}get collider(){return this._collider}get hitNormal(){return this._hitNormal}get closestHitFraction(){return this._closestHitFraction}_assign(t,e,i,s,r){Ki.copy(this._hitPoint,t),Ki.copy(this._hitNormal,s),this._distance=e,this._collider=i,r&&(this._closestHitFraction=r)}clone(){const t=new Mmt;return Ki.copy(t._hitPoint,this._hitPoint),Ki.copy(t._hitNormal,this._hitNormal),t._distance=this._distance,t._collider=this._collider,t._closestHitFraction=this._closestHitFraction,t}}t("PhysicsRayResult",Mmt);class Pmt extends Mmt{constructor(){super(...arguments),this._id=0}get id(){return this._id}_assign(t,e,i,s,r){void 0===r&&(r=0),super._assign(t,e,i,s),this._id=r}clone(){const t=new Pmt;return Ki.copy(t._hitPoint,this._hitPoint),Ki.copy(t._hitNormal,this._hitNormal),t._distance=this._distance,t._collider=this._collider,t._id=this._id,t}}t("PhysicsLineStripCastResult",Pmt);class Bmt{constructor(t){if(1===t){const t=this;for(let e=0;e<32;e++){const i="_"+(1<<e);t[i]=0,t.updateArray=[],Object.defineProperty(t,1<<e,{get(){return this[i]},set(t){this[i]!==t&&(this[i]=t,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})}this._1=1}else{for(let t=0;t<32;t++)this[""+(1<<t)]=0;this[1]=1}}}const Rmt=t("ERigidBodyType",{DYNAMIC:1,STATIC:2,KINEMATIC:4});te(Rmt);const Omt=t("EAxisDirection",{X_AXIS:0,Y_AXIS:1,Z_AXIS:2});te(Omt);const Lmt={X:0,Y:1,Z:2,SWING1:3,SWING2:4,TWIST:5};te(Lmt);const Fmt={VERTEX:1,LINE:2,TRIANGLE:3,TETRAHEDRON:4};te(Fmt);const zmt=t("EColliderType",{BOX:0,SPHERE:1,CAPSULE:2,CYLINDER:3,CONE:4,MESH:5,PLANE:6,SIMPLEX:7,TERRAIN:8});te(zmt);const kmt={POINT_TO_POINT:0,HINGE:1,FIXED:2,CONFIGURABLE:3};te(kmt);const Nmt={FREE:0,LIMITED:1,LOCKED:2};te(Nmt);const Umt={DISABLED:0,SERVO:1,INDUCTION:2};te(Umt);const Vmt={BOX:0,CAPSULE:1};te(Vmt);const Hmt={DEFAULT:1};te(Hmt);const Gmt=t("EPhysicsDrawFlags",{NONE:0,WIRE_FRAME:1,CONSTRAINT:2,AABB:4});te(Gmt),h.internal.PhysicsGroup=Hmt;class Wmt extends su{static get PHYSICS_NONE(){return!Lft.id}static get PHYSICS_BUILTIN(){return"builtin"===Lft.id}static get PHYSICS_CANNON(){return"cannon.js"===Lft.id}static get PHYSICS_BULLET(){return"bullet"===Lft.id}static get PHYSICS_PHYSX(){return"physx"===Lft.id}static get PhysicsGroup(){return Hmt}static get instance(){return Wmt._instance}get enable(){return this._enable}set enable(t){this._enable=t}get allowSleep(){return this._allowSleep}set allowSleep(t){this._allowSleep=t,this.physicsWorld&&this.physicsWorld.setAllowSleep(t)}get maxSubSteps(){return this._maxSubSteps}set maxSubSteps(t){this._maxSubSteps=t}get fixedTimeStep(){return this._fixedTimeStep}set fixedTimeStep(t){this._fixedTimeStep=t}get gravity(){return this._gravity}set gravity(t){this._gravity.set(t),this.physicsWorld&&this.physicsWorld.setGravity(t)}get sleepThreshold(){return this._sleepThreshold}set sleepThreshold(t){this._sleepThreshold=t}get autoSimulation(){return this._autoSimulation}set autoSimulation(t){this._autoSimulation=t}get defaultMaterial(){return this._material}setDefaultPhysicsMaterial(t){this._material=t,this.physicsWorld.setDefaultMaterial(this._material),this._material.on(Amt.EVENT_UPDATE,this._updateMaterial,this)}initDefaultMaterial(){if(null!=this._material)return Promise.resolve();const t=pw.get("default-physics-material");if(!t)return j(9642),Promise.resolve();const e=ae.querySettings("physics","defaultMaterial");return e?new Promise(((t,i)=>{uw.loadAny(e,((e,s)=>!e&&s instanceof Amt?t(s):i(e)))})).then((t=>{this.setDefaultPhysicsMaterial(t)})).catch((i=>{P(i),G(9643,e),this.setDefaultPhysicsMaterial(t)})):(this.setDefaultPhysicsMaterial(t),Promise.resolve())}get physicsWorld(){return Lft.physicsWorld}constructor(){super(),this.raycastClosestResult=new Mmt,this.raycastResults=[],this.lineStripCastClosestResult=new Pmt,this.lineStripCastResults=[],this.sweepCastClosestResult=new Mmt,this.sweepCastResults=[],this.collisionMatrix=new Bmt(1),this.minVolumeSize=1e-5,this.useNodeChains=!1,this._enable=!0,this._allowSleep=!0,this._maxSubSteps=1,this._subStepCount=0,this._fixedTimeStep=1/60,this._autoSimulation=!0,this._accumulator=0,this._sleepThreshold=.1,this._gravity=new Ki(0,-10,0),this._material=void 0,this.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},this.raycastResultPool=new nn((()=>new Mmt),1),this.sweepResultPool=new nn((()=>new Mmt),1)}postUpdate(t){if(this.physicsWorld)if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=t,uP.emit("director_before_physics");this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>=this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this.physicsWorld.emitEvents(),this.physicsWorld.syncAfterEvents(),this._accumulator-=this._fixedTimeStep,this._subStepCount++}uP.emit("director_after_physics")}}else this.physicsWorld.syncSceneToPhysics()}resetConfiguration(t){const e=t?t.allowSleep:ae.querySettings("physics","allowSleep");"boolean"==typeof e&&(this._allowSleep=e);const i=t?t.fixedTimeStep:ae.querySettings("physics","fixedTimeStep");"number"==typeof i&&(this._fixedTimeStep=i);const s=t?t.maxSubSteps:ae.querySettings("physics","maxSubSteps");"number"==typeof s&&(this._maxSubSteps=s);const r=t?t.sleepThreshold:ae.querySettings("physics","sleepThreshold");"number"==typeof r&&(this._sleepThreshold=r);const n=t?t.autoSimulation:ae.querySettings("physics","autoSimulation");"boolean"==typeof n&&(this.autoSimulation=n);const o=t?t.gravity:ae.querySettings("physics","gravity");o&&Ki.copy(this._gravity,o);const a=t?t.collisionMatrix:ae.querySettings("physics","collisionMatrix");if(a)for(const t in a)this.collisionMatrix[""+(1<<parseInt(t))]=a[t];const h=t?t.collisionGroups:ae.querySettings("physics","collisionGroups");h&&h instanceof Array&&(h.forEach((t=>{Hmt[t.name]=1<<t.index})),te.update(Hmt)),this.physicsWorld&&(this.physicsWorld.setGravity(this._gravity),this.physicsWorld.setAllowSleep(this._allowSleep))}resetAccumulator(t){void 0===t&&(t=0),this._accumulator=t}step(t,e,i){this.physicsWorld&&this.physicsWorld.step(t,e,i)}syncSceneToPhysics(){this.physicsWorld&&this.physicsWorld.syncSceneToPhysics()}emitEvents(){this.physicsWorld&&this.physicsWorld.emitEvents()}get debugDrawFlags(){return this.physicsWorld.debugDrawFlags}set debugDrawFlags(t){this.physicsWorld.debugDrawFlags=t}get debugDrawConstraintSize(){return this.physicsWorld.debugDrawConstraintSize}set debugDrawConstraintSize(t){this.physicsWorld.debugDrawConstraintSize=t}raycast(t,e,i,s){return void 0===e&&(e=4294967295),void 0===i&&(i=1e7),void 0===s&&(s=!0),!!this.physicsWorld&&(this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=e>>>0,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=s,this.physicsWorld.raycast(t,this.raycastOptions,this.raycastResultPool,this.raycastResults))}raycastClosest(t,e,i,s){return void 0===e&&(e=4294967295),void 0===i&&(i=1e7),void 0===s&&(s=!0),!!this.physicsWorld&&(this.raycastOptions.mask=e>>>0,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=s,this.physicsWorld.raycastClosest(t,this.raycastOptions,this.raycastClosestResult))}lineStripCast(t,e,i,s){if(void 0===e&&(e=4294967295),void 0===i&&(i=1e7),void 0===s&&(s=!0),t.length<2)return!1;this.lineStripCastResults=[];let r=0;const n=new qr;for(let o=1;o<t.length&&!(r>i);++o){const i=t[o-1],a=t[o],h=new Ki;Ki.subtract(h,a,i);const l=Ki.len(h);if(r+=l,Ki.multiplyScalar(h,h,1/l),n.d=h,n.o=i,this.raycast(n,e,l,s))for(let t=0;t<this.raycastResults.length;t++){const e=this.raycastResults[t];if(0===t&&Ki.equals(i,e.hitPoint))continue;const s=new Pmt;s._assign(e.hitPoint,e.distance,e.collider,e.hitNormal,o-1),this.lineStripCastResults.push(s)}}return this.lineStripCastResults.length>0}lineStripCastClosest(t,e,i,s){if(void 0===e&&(e=4294967295),void 0===i&&(i=1e7),void 0===s&&(s=!0),t.length<2)return!1;let r=0;const n=new qr;let o=!1;for(let a=1;a<t.length&&!(r>i);++a){const i=t[a-1],h=t[a],l=new Ki;Ki.subtract(l,h,i);const c=Ki.len(l);if(r+=c,Ki.multiplyScalar(l,l,1/c),n.d=l,n.o=i,o=this.raycastClosest(n,e,c,s),o){const t=this.raycastClosestResult,e=new Pmt;e._assign(t.hitPoint,t.distance,t.collider,t.hitNormal,a-1),this.lineStripCastClosestResult=e;break}}return o}sweepBox(t,e,i,s,r,n){return void 0===s&&(s=4294967295),void 0===r&&(r=1e7),void 0===n&&(n=!0),!!this.physicsWorld&&(this.sweepResultPool.reset(),this.sweepCastResults.length=0,this.raycastOptions.mask=s>>>0,this.raycastOptions.maxDistance=r,this.raycastOptions.queryTrigger=n,this.physicsWorld.sweepBox(t,e,i,this.raycastOptions,this.sweepResultPool,this.sweepCastResults))}sweepBoxClosest(t,e,i,s,r,n){return void 0===s&&(s=4294967295),void 0===r&&(r=1e7),void 0===n&&(n=!0),!!this.physicsWorld&&(this.raycastOptions.mask=s>>>0,this.raycastOptions.maxDistance=r,this.raycastOptions.queryTrigger=n,this.physicsWorld.sweepBoxClosest(t,e,i,this.raycastOptions,this.sweepCastClosestResult))}sweepSphere(t,e,i,s,r){return void 0===i&&(i=4294967295),void 0===s&&(s=1e7),void 0===r&&(r=!0),!!this.physicsWorld&&(this.sweepResultPool.reset(),this.sweepCastResults.length=0,this.raycastOptions.mask=i>>>0,this.raycastOptions.maxDistance=s,this.raycastOptions.queryTrigger=r,this.physicsWorld.sweepSphere(t,e,this.raycastOptions,this.sweepResultPool,this.sweepCastResults))}sweepSphereClosest(t,e,i,s,r){return void 0===i&&(i=4294967295),void 0===s&&(s=1e7),void 0===r&&(r=!0),!!this.physicsWorld&&(this.raycastOptions.mask=i>>>0,this.raycastOptions.maxDistance=s,this.raycastOptions.queryTrigger=r,this.physicsWorld.sweepSphereClosest(t,e,this.raycastOptions,this.sweepCastClosestResult))}sweepCapsule(t,e,i,s,r,n,o){return void 0===r&&(r=4294967295),void 0===n&&(n=1e7),void 0===o&&(o=!0),!!this.physicsWorld&&(this.sweepResultPool.reset(),this.sweepCastResults.length=0,this.raycastOptions.mask=r>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=o,this.physicsWorld.sweepCapsule(t,e,i,s,this.raycastOptions,this.sweepResultPool,this.sweepCastResults))}sweepCapsuleClosest(t,e,i,s,r,n,o){return void 0===r&&(r=4294967295),void 0===n&&(n=1e7),void 0===o&&(o=!0),!!this.physicsWorld&&(this.raycastOptions.mask=r>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=o,this.physicsWorld.sweepCapsuleClosest(t,e,i,s,this.raycastOptions,this.sweepCastClosestResult))}_updateMaterial(){this.physicsWorld&&this.physicsWorld.setDefaultMaterial(this._material)}static constructAndRegister(){if(!Wmt._instance){const t=this.doConstructAndRegister();t&&TP.onPostProjectInitDelegate.add(t.initDefaultMaterial.bind(t))}}static constructAndRegisterManually(){return Promise.resolve()}static doConstructAndRegister(){var t;if(null!==(t=ae.querySettings("physics","enabled"))&&void 0!==t&&!t)return null;if(!Wmt._instance){const t=new Wmt;Wmt._instance=t,t.resetConfiguration(),Fft(t),uP.registerSystem(Wmt.ID,t,t.priority)}return Wmt._instance}}var jmt,$mt,qmt,Xmt,Ymt,Qmt,Kmt,Zmt,Jmt,tyt,eyt,iyt,syt,ryt,nyt,oyt;t("PhysicsSystem",Wmt),Wmt.ID="PHYSICS",Wmt._instance=null,uP.once("director_init",(()=>{Wmt.constructAndRegister()}));let ayt=t("RigidBody",(jmt=oa("cc.RigidBody"),$mt=ha(-1),qmt=Ga(Wmt.PhysicsGroup),Xmt=Ga(Rmt),jmt(Ymt=la(Ymt=$mt((oyt=class extends Ag{constructor(){super(...arguments),this._body=null,this._group=Kmt&&Kmt(),this._type=Zmt&&Zmt(),this._mass=Jmt&&Jmt(),this._allowSleep=tyt&&tyt(),this._linearDamping=eyt&&eyt(),this._angularDamping=iyt&&iyt(),this._useGravity=syt&&syt(),this._linearFactor=ryt&&ryt(),this._angularFactor=nyt&&nyt()}get group(){return this._group}set group(t){this._group=t,this._body&&this._body.getGroup()!==t&&this._body.setGroup(t)}get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this._body&&this._body.setType(t))}get mass(){return this._mass}set mass(t){this._mass!==t&&(t=t<=0?1e-4:t,this._mass=t,this._body&&this._body.setMass(t))}get allowSleep(){return this._allowSleep}set allowSleep(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}get linearDamping(){return this._linearDamping}set linearDamping(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}get angularDamping(){return this._angularDamping}set angularDamping(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}get useGravity(){return this._useGravity}set useGravity(t){this._useGravity=t,this._body&&this._body.useGravity(t)}get linearFactor(){return this._linearFactor}set linearFactor(t){Ki.copy(this._linearFactor,t),this._body&&this._body.setLinearFactor(this._linearFactor)}get angularFactor(){return this._angularFactor}set angularFactor(t){Ki.copy(this._angularFactor,t),this._body&&this._body.setAngularFactor(this._angularFactor)}get sleepThreshold(){return this._isInitialized?this._body.getSleepThreshold():.1}set sleepThreshold(t){this._isInitialized&&this._body.setSleepThreshold(t)}get useCCD(){return!!this._isInitialized&&this._body.isUsingCCD()}set useCCD(t){this._isInitialized&&this._body.useCCD(t)}get isAwake(){return!!this._isInitialized&&this._body.isAwake}get isSleepy(){return!!this._isInitialized&&this._body.isSleepy}get isSleeping(){return!!this._isInitialized&&this._body.isSleeping}get isStatic(){return 2===this._type}set isStatic(t){t&&this.isStatic||!t&&!this.isStatic||(this.type=t?2:1)}get isDynamic(){return 1===this._type}set isDynamic(t){t&&this.isDynamic||!t&&!this.isDynamic||(this.type=t?1:4)}get isKinematic(){return 4===this._type}set isKinematic(t){t&&this.isKinematic||!t&&!this.isKinematic||(this.type=t?4:1)}get body(){return this._body}get _isInitialized(){const t=null===this._body;return t&&B("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!t}onLoad(){Lft.runInEditor&&(this._body=Uft(Lft.wrapper.RigidBody,1)?Hft:new Lft.wrapper.RigidBody,this._body.initialize(this))}onEnable(){this._body&&this._body.onEnable()}onDisable(){this._body&&this._body.onDisable()}onDestroy(){this._body&&this._body.onDestroy()}applyForce(t,e){this._isInitialized&&this._body.applyForce(t,e)}applyLocalForce(t,e){this._isInitialized&&this._body.applyLocalForce(t,e)}applyImpulse(t,e){this._isInitialized&&this._body.applyImpulse(t,e)}applyLocalImpulse(t,e){this._isInitialized&&this._body.applyLocalImpulse(t,e)}applyTorque(t){this._isInitialized&&this._body.applyTorque(t)}applyLocalTorque(t){this._isInitialized&&this._body.applyLocalTorque(t)}wakeUp(){this._isInitialized&&this._body.wakeUp()}sleep(){this._isInitialized&&this._body.sleep()}clearState(){this._isInitialized&&this._body.clearState()}clearForces(){this._isInitialized&&this._body.clearForces()}clearVelocity(){this._isInitialized&&this._body.clearVelocity()}getLinearVelocity(t){this._isInitialized&&this._body.getLinearVelocity(t)}setLinearVelocity(t){this._isInitialized&&this._body.setLinearVelocity(t)}getAngularVelocity(t){this._isInitialized&&this._body.getAngularVelocity(t)}setAngularVelocity(t){this._isInitialized&&this._body.setAngularVelocity(t)}getGroup(){return this._isInitialized?this._body.getGroup():0}setGroup(t){this._isInitialized&&this._body.setGroup(t)}addGroup(t){this._isInitialized&&this._body.addGroup(t)}removeGroup(t){this._isInitialized&&this._body.removeGroup(t)}getMask(){return this._isInitialized?this._body.getMask():0}setMask(t){this._isInitialized&&this._body.setMask(t)}addMask(t){this._isInitialized&&this._body.addMask(t)}removeMask(t){this._isInitialized&&this._body.removeMask(t)}},oyt.Type=Rmt,s((Qmt=oyt).prototype,"group",[qmt],Object.getOwnPropertyDescriptor(Qmt.prototype,"group"),Qmt.prototype),s(Qmt.prototype,"type",[Xmt],Object.getOwnPropertyDescriptor(Qmt.prototype,"type"),Qmt.prototype),Kmt=Qo(Qmt.prototype,"_group",[va],(function(){return Wmt.PhysicsGroup.DEFAULT})),Zmt=Qo(Qmt.prototype,"_type",[va],(function(){return 1})),Jmt=Qo(Qmt.prototype,"_mass",[va],(function(){return 1})),tyt=Qo(Qmt.prototype,"_allowSleep",[va],(function(){return!0})),eyt=Qo(Qmt.prototype,"_linearDamping",[va],(function(){return.1})),iyt=Qo(Qmt.prototype,"_angularDamping",[va],(function(){return.1})),syt=Qo(Qmt.prototype,"_useGravity",[va],(function(){return!0})),ryt=Qo(Qmt.prototype,"_linearFactor",[va],(function(){return new Ki(1,1,1)})),nyt=Qo(Qmt.prototype,"_angularFactor",[va],(function(){return new Ki(1,1,1)})),Ymt=Qmt))||Ymt)||Ymt)||Ymt));var hyt,lyt,cyt,uyt,dyt,pyt,_yt,gyt,fyt,myt,yyt;ayt||t("RigidBody",ayt={});let vyt=t("Collider",(hyt=oa("cc.Collider"),lyt=Ga(ayt),cyt=Ga(Amt),uyt=Ga(Ki),dyt=Ga(Amt),hyt((yyt=class extends(Dn(Ag)){get attachedRigidBody(){return byt(this.node)}get sharedMaterial(){return this._material}set sharedMaterial(t){this.material=t}get material(){return this._isSharedMaterial&&this._material&&(this._material.off(Amt.EVENT_UPDATE,this._updateMaterial,this),this._material=this._material.clone(),this._material.on(Amt.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1),this._material}set material(t){this._shape?(t&&this._material?this._material.id!==t.id&&(this._material.off(Amt.EVENT_UPDATE,this._updateMaterial,this),t.on(Amt.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1,this._material=t):t&&!this._material?(t.on(Amt.EVENT_UPDATE,this._updateMaterial,this),this._material=t):!t&&this._material&&(this._material.off(Amt.EVENT_UPDATE,this._updateMaterial,this),this._material=t),this._updateMaterial()):this._material=t}get isTrigger(){return this._isTrigger}set isTrigger(t){this._isTrigger=t,this._shape&&this._shape.setAsTrigger(this._isTrigger)}get center(){return this._center}set center(t){Ki.copy(this._center,t),this._shape&&this._shape.setCenter(this._center)}get shape(){return this._shape}get worldBounds(){return null==this._aabb&&(this._aabb=new Qn),this._shape&&this._shape.getAABB(this._aabb),this._aabb}get boundingSphere(){return null==this._boundingSphere&&(this._boundingSphere=new tn),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}get needTriggerEvent(){return this._needTriggerEvent}get needCollisionEvent(){return this._needCollisionEvent}get _isInitialized(){const t=null===this._shape;return t&&B("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!t}constructor(t){super(),this.type=void 0,this._shape=null,this._aabb=null,this._boundingSphere=null,this._isSharedMaterial=!0,this._needTriggerEvent=!1,this._needCollisionEvent=!1,this._material=gyt&&gyt(),this._isTrigger=fyt&&fyt(),this._center=myt&&myt(),this.type=t}on(t,e,i,s){const r=super.on(t,e,i,s);return this._updateNeedEvent(t),r}off(t,e,i){super.off(t,e,i),this._updateNeedEvent()}once(t,e,i){const s=super.once(t,e,i);return this._updateNeedEvent(t),s}removeAll(t){super.removeAll(t),this._updateNeedEvent()}getGroup(){return this._isInitialized?this._shape.getGroup():0}setGroup(t){this._isInitialized&&this._shape.setGroup(t)}addGroup(t){this._isInitialized&&this._shape.addGroup(t)}removeGroup(t){this._isInitialized&&this._shape.removeGroup(t)}getMask(){return this._isInitialized?this._shape.getMask():0}setMask(t){this._isInitialized&&this._shape.setMask(t)}addMask(t){this._isInitialized&&this._shape.addMask(t)}removeMask(t){this._isInitialized&&this._shape.removeMask(t)}onLoad(){Lft.runInEditor&&(this.sharedMaterial=this._material,this._shape=jft(this.type),this._shape.initialize(this),this._shape.onLoad())}onEnable(){this._shape&&this._shape.onEnable()}onDisable(){this._shape&&this._shape.onDisable()}onDestroy(){this._shape&&(this._needTriggerEvent=!1,this._needCollisionEvent=!1,this._shape.updateEventListener(),this._material&&this._material.off(Amt.EVENT_UPDATE,this._updateMaterial,this),this._shape.onDestroy()),this._boundingSphere&&this._boundingSphere.destroy()}_updateMaterial(){this._shape&&this._shape.setMaterial(this._material)}_updateNeedEvent(t){this.isValid&&(void 0!==t?("onCollisionEnter"!==t&&"onCollisionStay"!==t&&"onCollisionExit"!==t||(this._needCollisionEvent=!0),"onTriggerEnter"!==t&&"onTriggerStay"!==t&&"onTriggerExit"!==t&&"onControllerTriggerEnter"!==t&&"onControllerTriggerStay"!==t&&"onControllerTriggerExit"!==t||(this._needTriggerEvent=!0)):(this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")||this.hasEventListener("onControllerTriggerEnter")||this.hasEventListener("onControllerTriggerStay")||this.hasEventListener("onControllerTriggerExit")||(this._needTriggerEvent=!1),this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1)),this._shape&&this._shape.updateEventListener())}},yyt.Type=zmt,yyt.Axis=Omt,s((_yt=yyt).prototype,"attachedRigidBody",[lyt],Object.getOwnPropertyDescriptor(_yt.prototype,"attachedRigidBody"),_yt.prototype),s(_yt.prototype,"sharedMaterial",[cyt],Object.getOwnPropertyDescriptor(_yt.prototype,"sharedMaterial"),_yt.prototype),s(_yt.prototype,"center",[uyt],Object.getOwnPropertyDescriptor(_yt.prototype,"center"),_yt.prototype),gyt=Qo(_yt.prototype,"_material",[dyt],(function(){return null})),fyt=Qo(_yt.prototype,"_isTrigger",[va],(function(){return!1})),myt=Qo(_yt.prototype,"_center",[va],(function(){return new Ki})),pyt=_yt))||pyt));function byt(t){const e=t.getComponent(ayt);return e&&e.isValid?e:null}var wyt,Syt,xyt,Tyt,Cyt;vyt||t("Collider",vyt={});let Iyt=t("BoxCollider",(wyt=oa("cc.BoxCollider"),Syt=Ga(Ki),wyt((Tyt=class extends vyt{get size(){return this._size}set size(t){Ki.strictEquals(this._size,t)||(Ki.copy(this._size,t),UX(this._size),this._shape&&this.shape.updateSize())}get shape(){return this._shape}constructor(){super(0),this._size=Cyt&&Cyt()}},s(Tyt.prototype,"size",[Syt],Object.getOwnPropertyDescriptor(Tyt.prototype,"size"),Tyt.prototype),Cyt=Qo(Tyt.prototype,"_size",[va],(function(){return new Ki(1,1,1)})),xyt=Tyt))||xyt));var Eyt,Dyt,Ayt;let Myt=t("SphereCollider",oa("cc.SphereCollider")((Dyt=class extends vyt{get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.updateRadius())}get shape(){return this._shape}constructor(){super(1),this._radius=Ayt&&Ayt()}},Ayt=Qo(Dyt.prototype,"_radius",[va],(function(){return.5})),Eyt=Dyt))||Eyt);var Pyt,Byt,Ryt,Oyt,Lyt,Fyt,zyt;let kyt=t("CapsuleCollider",(Pyt=oa("cc.CapsuleCollider"),Byt=Ga(Omt),Pyt((Oyt=class extends vyt{get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.setRadius(t))}get cylinderHeight(){return this._cylinderHeight}set cylinderHeight(t){this._cylinderHeight!==t&&(this._cylinderHeight=Math.abs(t),this._shape&&this.shape.setCylinderHeight(t))}get direction(){return this._direction}set direction(t){(t=Math.floor(t))<0||t>2||this._direction!==t&&(this._direction=t,this._shape&&this.shape.setDirection(t))}get height(){return 2*this._radius+this._cylinderHeight}set height(t){let e=t-2*this._radius;e<0&&(e=0),this.cylinderHeight=e}get worldHeight(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}get shape(){return this._shape}constructor(){super(2),this._radius=Lyt&&Lyt(),this._cylinderHeight=Fyt&&Fyt(),this._direction=zyt&&zyt()}_getRadiusScale(){if(null==this.node)return 1;const t=this.node.worldScale;return 1===this._direction?Math.abs(Ri(t.x,t.z)):0===this._direction?Math.abs(Ri(t.y,t.z)):Math.abs(Ri(t.x,t.y))}_getHeightScale(){if(null==this.node)return 1;const t=this.node.worldScale;return 1===this._direction?Math.abs(t.y):0===this._direction?Math.abs(t.x):Math.abs(t.z)}},s(Oyt.prototype,"direction",[Byt],Object.getOwnPropertyDescriptor(Oyt.prototype,"direction"),Oyt.prototype),Lyt=Qo(Oyt.prototype,"_radius",[va],(function(){return.5})),Fyt=Qo(Oyt.prototype,"_cylinderHeight",[va],(function(){return 1})),zyt=Qo(Oyt.prototype,"_direction",[va],(function(){return 1})),Ryt=Oyt))||Ryt));var Nyt,Uyt,Vyt,Hyt,Gyt,Wyt,jyt;let $yt=t("CylinderCollider",(Nyt=oa("cc.CylinderCollider"),Uyt=Ga(Omt),Nyt((Hyt=class extends vyt{get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.setRadius(t))}get height(){return this._height}set height(t){this._height!==t&&(this._height=Math.abs(t),this._shape&&this.shape.setHeight(t))}get direction(){return this._direction}set direction(t){this._direction!==t&&(t<0||t>2||(this._direction=t,this._shape&&this.shape.setDirection(t)))}get shape(){return this._shape}constructor(){super(3),this._radius=Gyt&&Gyt(),this._height=Wyt&&Wyt(),this._direction=jyt&&jyt()}},s(Hyt.prototype,"direction",[Uyt],Object.getOwnPropertyDescriptor(Hyt.prototype,"direction"),Hyt.prototype),Gyt=Qo(Hyt.prototype,"_radius",[va],(function(){return.5})),Wyt=Qo(Hyt.prototype,"_height",[va],(function(){return 2})),jyt=Qo(Hyt.prototype,"_direction",[va],(function(){return 1})),Vyt=Hyt))||Vyt));var qyt,Xyt,Yyt,Qyt,Kyt,Zyt,Jyt;let tvt=t("ConeCollider",(qyt=oa("cc.ConeCollider"),Xyt=Ga(Omt),qyt((Qyt=class extends vyt{get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.setRadius(t))}get height(){return this._height}set height(t){this._height!==t&&(t<0&&(t=0),this._height=t,this._shape&&this.shape.setHeight(t))}get direction(){return this._direction}set direction(t){this._direction!==t&&(t<0||t>2||(this._direction=t,this._shape&&this.shape.setDirection(t)))}get shape(){return this._shape}constructor(){super(4),this._radius=Kyt&&Kyt(),this._height=Zyt&&Zyt(),this._direction=Jyt&&Jyt()}},s(Qyt.prototype,"direction",[Xyt],Object.getOwnPropertyDescriptor(Qyt.prototype,"direction"),Qyt.prototype),Kyt=Qo(Qyt.prototype,"_radius",[va],(function(){return.5})),Zyt=Qo(Qyt.prototype,"_height",[va],(function(){return 1})),Jyt=Qo(Qyt.prototype,"_direction",[va],(function(){return 1})),Yyt=Qyt))||Yyt));var evt,ivt,svt,rvt,nvt,ovt;let avt=t("MeshCollider",(evt=oa("cc.MeshCollider"),ivt=Ga(ZP),evt((rvt=class extends vyt{get mesh(){return this._mesh}set mesh(t){this._mesh!==t&&(this._mesh=t,this._shape&&this.shape.setMesh(this._mesh))}get convex(){return this._convex}set convex(t){this._convex!==t&&(this._convex=t,this._shape&&this._mesh&&this.shape.setMesh(this._mesh))}get shape(){return this._shape}onEnable(){if(super.onEnable(),this.node){const t=this.node.getComponent(ayt);t&&t.isValid&&1===t.type&&!this.convex&&G(9630,this.node.name)}}constructor(){super(5),this._mesh=nvt&&nvt(),this._convex=ovt&&ovt()}},s(rvt.prototype,"mesh",[ivt],Object.getOwnPropertyDescriptor(rvt.prototype,"mesh"),rvt.prototype),nvt=Qo(rvt.prototype,"_mesh",[va],(function(){return null})),ovt=Qo(rvt.prototype,"_convex",[va],(function(){return!1})),svt=rvt))||svt));var hvt,lvt,cvt,uvt,dvt,pvt;let _vt=t("ConstantForce",oa("cc.ConstantForce")(hvt=aa(ayt)(hvt=la((lvt=class extends Ag{constructor(){super(...arguments),this._rigidBody=null,this._force=cvt&&cvt(),this._localForce=uvt&&uvt(),this._torque=dvt&&dvt(),this._localTorque=pvt&&pvt(),this._mask=0}get force(){return this._force}set force(t){Ki.copy(this._force,t),this._maskUpdate(this._force,1)}get localForce(){return this._localForce}set localForce(t){Ki.copy(this._localForce,t),this._maskUpdate(this.localForce,2)}get torque(){return this._torque}set torque(t){Ki.copy(this._torque,t),this._maskUpdate(this._torque,4)}get localTorque(){return this._localTorque}set localTorque(t){Ki.copy(this._localTorque,t),this._maskUpdate(this._localTorque,8)}onLoad(){this._rigidBody=this.node.getComponent(ayt),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)}lateUpdate(t){null!=this._rigidBody&&0!==this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))}_maskUpdate(t,e){t.strictEquals(Ki.ZERO)?this._mask&=~e:this._mask|=e}},cvt=Qo(lvt.prototype,"_force",[va],(function(){return new Ki})),uvt=Qo(lvt.prototype,"_localForce",[va],(function(){return new Ki})),dvt=Qo(lvt.prototype,"_torque",[va],(function(){return new Ki})),pvt=Qo(lvt.prototype,"_localTorque",[va],(function(){return new Ki})),hvt=lvt))||hvt)||hvt)||hvt);var gvt,fvt,mvt,yvt,vvt,bvt,wvt,Svt,xvt,Tvt,Cvt;const Ivt=32768,Evt=1/128,Dvt=1/512,Avt=16842754,Mvt=16842755,Pvt=16842756,Bvt=16842758,Rvt=16842759,Ovt=16842760,Lvt=16843025;class Fvt{constructor(){this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}reserve(t){if(this.buffer.byteLength>t)return;let e=this.buffer.byteLength;for(;e<t;)e+=e;const i=new Uint8Array(e);for(let t=0;t<this.length;++t)i[t]=this.buffer[t];this.buffer=i,this._buffView=new DataView(this.buffer.buffer)}assign(t){this.buffer=t,this.length=t.length,this._seekPos=t.byteOffset,this._buffView=new DataView(t.buffer)}writeInt8(t){this.reserve(this.length+1),this._buffView.setInt8(this.length,t),this.length+=1}writeInt16(t){this.reserve(this.length+2),this._buffView.setInt16(this.length,t,!0),this.length+=2}writeInt32(t){this.reserve(this.length+4),this._buffView.setInt32(this.length,t,!0),this.length+=4}writeIntArray(t){this.reserve(this.length+4*t.length);for(let e=0;e<t.length;++e)this._buffView.setInt32(this.length+4*e,t[e],!0);this.length+=4*t.length}writeFloat(t){this.reserve(this.length+4),this._buffView.setFloat32(this.length,t,!0),this.length+=4}writeFloatArray(t){this.reserve(this.length+4*t.length);for(let e=0;e<t.length;++e)this._buffView.setFloat32(this.length+4*e,t[e],!0);this.length+=4*t.length}writeDouble(t){this.reserve(this.length+8),this._buffView.setFloat64(this.length,t,!0),this.length+=8}writeDoubleArray(t){this.reserve(this.length+8*t.length);for(let e=0;e<t.length;++e)this._buffView.setFloat64(this.length+8*e,t[e],!0);this.length+=8*t.length}writeString(t){this.reserve(this.length+t.length+4),this._buffView.setInt32(this.length,t.length,!0);for(let e=0;e<t.length;++e)this._buffView.setInt8(this.length+4+e,t.charCodeAt(e));this.length+=t.length+4}readInt8(){const t=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,t}readInt16(){const t=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,t}readInt(){const t=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,t}readIntArray(t){for(let e=0;e<t.length;++e)t[e]=this._buffView.getInt32(this._seekPos+4*e,!0);return this._seekPos+=4*t.length,t}readFloat(){const t=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,t}readFloatArray(t){for(let e=0;e<t.length;++e)t[e]=this._buffView.getFloat32(this._seekPos+4*e,!0);return this._seekPos+=4*t.length,t}readDouble(){const t=this._buffView.getFloat64(this._seekPos,!0);return this._seekPos+=8,t}readDoubleArray(t){for(let e=0;e<t.length;++e)t[e]=this._buffView.getFloat64(this._seekPos+4*e,!0);return this._seekPos+=8*t.length,t}readString(){const t=this.readInt();let e="";for(let i=0;i<t;++i)e+=String.fromCharCode(this.readInt8());return e}}oa("cc.TerrainLayerInfo")((gvt=class{constructor(){this.slot=fvt&&fvt(),this.tileSize=mvt&&mvt(),this.detailMap=yvt&&yvt(),this.normalMap=vvt&&vvt(),this.roughness=bvt&&bvt(),this.metallic=wvt&&wvt()}},fvt=Qo(gvt.prototype,"slot",[va],(function(){return 0})),mvt=Qo(gvt.prototype,"tileSize",[va],(function(){return 1})),yvt=Qo(gvt.prototype,"detailMap",[va],(function(){return null})),vvt=Qo(gvt.prototype,"normalMap",[va],(function(){return null})),bvt=Qo(gvt.prototype,"roughness",[va],(function(){return 1})),wvt=Qo(gvt.prototype,"metallic",[va],(function(){return 0})),gvt));let zvt=oa("cc.TerrainLayerBinaryInfo")(Svt=class{constructor(){this.slot=0,this.tileSize=1,this.roughness=1,this.metallic=0,this.detailMapId="",this.normalMapId=""}})||Svt,kvt=oa("cc.TerrainAsset")((Tvt=class extends F_{constructor(){super(),this._version=0,this._data=null,this._tileSize=1,this._blockCount=[1,1],this._weightMapSize=128,this._lightMapSize=128,this._heights=new Uint16Array,this._normals=new Float32Array,this._weights=new Uint8Array,this._layerBuffer=[-1,-1,-1,-1],this._layerBinaryInfos=[],this._layerInfos=Cvt&&Cvt()}get _nativeAsset(){return this._data.buffer}set _nativeAsset(t){this._data&&this._data.byteLength===t.byteLength?this._data.set(new Uint8Array(t)):this._data=new Uint8Array(t),this._loadNativeData(this._data)}get version(){return this._version}set tileSize(t){this._tileSize=t}get tileSize(){return this._tileSize}set blockCount(t){this._blockCount=t}get blockCount(){return this._blockCount}set lightMapSize(t){this._lightMapSize=t}get lightMapSize(){return this._lightMapSize}set weightMapSize(t){this._weightMapSize=t}get weightMapSize(){return this._weightMapSize}set heights(t){this._heights=t}get heights(){return this._heights}set normals(t){this._normals=t}get normals(){return this._normals}set weights(t){this._weights=t}get weights(){return this._weights}set layerBuffer(t){this._layerBuffer=t}get layerBuffer(){return this._layerBuffer}set layerInfos(t){this._layerInfos=t}get layerInfos(){return this._layerInfos}get layerBinaryInfos(){return this._layerBinaryInfos}getLayer(t,e,i){const s=4*(e*this.blockCount[0]+t)+i;return t<this.blockCount[0]&&e<this.blockCount[1]&&s<this._layerBuffer.length?this._layerBuffer[s]:-1}getHeight(t,e){const i=32*this._blockCount[0]+1;return(this._heights[e*i+t]-Ivt)*Evt}getVertexCountI(){return this._blockCount.length<1?0:32*this._blockCount[0]+1}getVertexCountJ(){return this._blockCount.length<2?0:32*this._blockCount[1]+1}_setNativeData(t){this._data=t}_loadNativeData(t){if(!t||0===t.length)return!1;const e=new Fvt;if(e.assign(t),this._version=e.readInt(),this._version===Lvt)return!0;if(16842753!==this._version&&this._version!==Avt&&this._version!==Mvt&&this._version!==Pvt&&16842757!==this._version&&this._version!==Bvt&&this._version!==Rvt&&this._version!==Ovt)return!1;this._version>=Rvt?this.tileSize=e.readDouble():this.tileSize=e.readFloat(),this.tileSize=Math.floor(100*this.tileSize)/100,e.readIntArray(this._blockCount),this.weightMapSize=e.readInt16(),this.lightMapSize=e.readInt16();const i=e.readInt();this.heights=new Uint16Array(i);for(let t=0;t<this.heights.length;++t)this.heights[t]=e.readInt16();if(this._version<Ovt)for(let t=0;t<this.heights.length;++t){const e=(this._heights[t]-Ivt)*Dvt,i=Ivt+e/Evt;this.heights[t]=i}if(this._version>=Bvt){const t=e.readInt();this.normals=new Float32Array(t);for(let t=0;t<this.normals.length;++t)this.normals[t]=e.readFloat()}const s=e.readInt();this.weights=new Uint8Array(s);for(let t=0;t<this.weights.length;++t)this.weights[t]=e.readInt8();if(this._version>=Avt){const t=e.readInt();this.layerBuffer=new Array(t);for(let t=0;t<this.layerBuffer.length;++t)this.layerBuffer[t]=e.readInt16()}if(this._version>=Mvt){const t=e.readInt();this._layerBinaryInfos=new Array(t);for(let t=0;t<this._layerBinaryInfos.length;++t)this._layerBinaryInfos[t]=new zvt,this._layerBinaryInfos[t].slot=e.readInt(),this._version>=Rvt?this._layerBinaryInfos[t].tileSize=e.readDouble():this._layerBinaryInfos[t].tileSize=e.readFloat(),this._layerBinaryInfos[t].detailMapId=e.readString(),this._version>=Pvt&&(this._layerBinaryInfos[t].normalMapId=e.readString(),this._version>=Rvt?(this._layerBinaryInfos[t].roughness=e.readDouble(),this._layerBinaryInfos[t].metallic=e.readDouble()):(this._layerBinaryInfos[t].roughness=e.readFloat(),this._layerBinaryInfos[t].metallic=e.readFloat()))}return!0}_exportNativeData(){const t=new Fvt;t.writeInt32(Ovt),t.writeDouble(this.tileSize),t.writeIntArray(this._blockCount),t.writeInt16(this.weightMapSize),t.writeInt16(this.lightMapSize),t.writeInt32(this.heights.length);for(let e=0;e<this.heights.length;++e)t.writeInt16(this.heights[e]);t.writeInt32(this.normals.length);for(let e=0;e<this.normals.length;++e)t.writeFloat(this.normals[e]);t.writeInt32(this.weights.length);for(let e=0;e<this.weights.length;++e)t.writeInt8(this.weights[e]);t.writeInt32(this.layerBuffer.length);for(let e=0;e<this.layerBuffer.length;++e)t.writeInt16(this.layerBuffer[e]);const e=[];e.length=this.layerInfos.length;for(let t=0;t<e.length;++t){const i=this.layerInfos[t],s=new zvt;s.slot=t,s.tileSize=i.tileSize,s.detailMapId=i.detailMap?i.detailMap._uuid:"",s.normalMapId=i.normalMap?i.normalMap._uuid:"",s.metallic=i.metallic,s.roughness=i.roughness,e[t]=s}t.writeInt32(e.length);for(let i=0;i<e.length;++i)t.writeInt32(e[i].slot),t.writeDouble(e[i].tileSize),t.writeString(e[i].detailMapId),t.writeString(e[i].normalMapId),t.writeDouble(e[i].roughness),t.writeDouble(e[i].metallic);return t.buffer}_exportDefaultNativeData(){const t=new Fvt;return t.writeInt32(Lvt),t.buffer}},Cvt=Qo(Tvt.prototype,"_layerInfos",[va],(function(){return[]})),xvt=Tvt))||xvt;var Nvt,Uvt,Vvt,Hvt,Gvt;let Wvt=t("TerrainCollider",(Nvt=oa("cc.TerrainCollider"),Uvt=Ga(kvt),Nvt((Hvt=class extends vyt{get terrain(){return this._terrain}set terrain(t){this._terrain=t,this._shape&&this.shape.setTerrain(this._terrain)}get shape(){return this._shape}onEnable(){if(super.onEnable(),this.node){const t=this.node.getComponent(ayt);t&&t.isValid&&1===t.type&&G(9630,this.node.name)}}constructor(){super(8),this._terrain=Gvt&&Gvt()}},s(Hvt.prototype,"terrain",[Uvt],Object.getOwnPropertyDescriptor(Hvt.prototype,"terrain"),Hvt.prototype),Gvt=Qo(Hvt.prototype,"_terrain",[va],(function(){return null})),Vvt=Hvt))||Vvt));var jvt,$vt,qvt,Xvt,Yvt,Qvt,Kvt;let Zvt=t("SimplexCollider",(jvt=oa("cc.SimplexCollider"),$vt=Ga(Fmt),jvt(((Kvt=class extends vyt{get shapeType(){return this._shapeType}set shapeType(t){this._shapeType=t,this._shape&&this.shape.setShapeType(t)}get vertex0(){return this._vertices[0]}set vertex0(t){Ki.copy(this._vertices[0],t),this.updateVertices()}get vertex1(){return this._vertices[1]}set vertex1(t){Ki.copy(this._vertices[1],t),this.updateVertices()}get vertex2(){return this._vertices[2]}set vertex2(t){Ki.copy(this._vertices[2],t),this.updateVertices()}get vertex3(){return this._vertices[3]}set vertex3(t){Ki.copy(this._vertices[3],t),this.updateVertices()}get shape(){return this._shape}get vertices(){return this._vertices}constructor(){super(7),this._shapeType=Yvt&&Yvt(),this._vertices=Qvt&&Qvt()}updateVertices(){this._shape&&this.shape.setVertices(this._vertices)}}).ESimplexType=Fmt,s((Xvt=Kvt).prototype,"shapeType",[$vt],Object.getOwnPropertyDescriptor(Xvt.prototype,"shapeType"),Xvt.prototype),Yvt=Qo(Xvt.prototype,"_shapeType",[va],(function(){return 4})),Qvt=Qo(Xvt.prototype,"_vertices",[va],(function(){return[new Ki(0,0,0),new Ki(0,0,1),new Ki(1,0,0),new Ki(0,1,0)]})),qvt=Xvt))||qvt));var Jvt,tbt,ebt,ibt,sbt,rbt;Zvt||t("SimplexCollider",Zvt={});let nbt=t("PlaneCollider",(Jvt=oa("cc.PlaneCollider"),tbt=Ga(Ki),Jvt((ibt=class extends vyt{get normal(){return this._normal}set normal(t){Ki.strictEquals(this._normal,t)||(Ki.copy(this._normal,t),this._shape&&this.shape.setNormal(this._normal))}get constant(){return this._constant}set constant(t){this._constant!==t&&(this._constant=t,this._shape&&this.shape.setConstant(this._constant))}get shape(){return this._shape}onEnable(){if(super.onEnable(),this.node){const t=this.node.getComponent(ayt);t&&t.isValid&&1===t.type&&G(9630,this.node.name)}}constructor(){super(6),this._normal=sbt&&sbt(),this._constant=rbt&&rbt()}},s(ibt.prototype,"normal",[tbt],Object.getOwnPropertyDescriptor(ibt.prototype,"normal"),ibt.prototype),sbt=Qo(ibt.prototype,"_normal",[va],(function(){return new Ki(0,1,0)})),rbt=Qo(ibt.prototype,"_constant",[va],(function(){return 0})),ebt=ibt))||ebt));var obt,abt,hbt,lbt,cbt,ubt,dbt,pbt,_bt,gbt;let fbt=t("Constraint",(obt=oa("cc.Constraint"),abt=aa(ayt),hbt=Ga(ayt),lbt=Ga(ayt),cbt=Ga(ayt),obt(ubt=abt((gbt=class extends(Dn(Ag)){get attachedBody(){return this.getComponent(ayt)}get connectedBody(){return this._connectedBody}set connectedBody(t){this._connectedBody=t,this._constraint&&this._constraint.setConnectedBody(t)}get enableCollision(){return this._enableCollision}set enableCollision(t){this._enableCollision=t,this._constraint&&this._constraint.setEnableCollision(t)}constructor(t){super(),this.TYPE=void 0,this._enableCollision=pbt&&pbt(),this._connectedBody=_bt&&_bt(),this._constraint=null,this.TYPE=t}onLoad(){Lft.runInEditor&&(this._constraint=Xft(this.TYPE),this._constraint.initialize(this))}onEnable(){this._constraint&&this._constraint.onEnable()}onDisable(){this._constraint&&this._constraint.onDisable()}onDestroy(){this._constraint&&this._constraint.onDestroy()}},gbt.Type=kmt,s((dbt=gbt).prototype,"attachedBody",[hbt],Object.getOwnPropertyDescriptor(dbt.prototype,"attachedBody"),dbt.prototype),s(dbt.prototype,"connectedBody",[lbt],Object.getOwnPropertyDescriptor(dbt.prototype,"connectedBody"),dbt.prototype),pbt=Qo(dbt.prototype,"_enableCollision",[va],(function(){return!0})),_bt=Qo(dbt.prototype,"_connectedBody",[cbt],(function(){return null})),ubt=dbt))||ubt)||ubt));var mbt,ybt,vbt,bbt,wbt,Sbt,xbt,Tbt,Cbt,Ibt,Ebt,Dbt,Abt,Mbt,Pbt,Bbt,Rbt,Obt,Lbt,Fbt,zbt,kbt,Nbt,Ubt,Vbt,Hbt,Gbt,Wbt,jbt,$bt,qbt,Xbt,Ybt,Qbt,Kbt,Zbt,Jbt,twt,ewt,iwt,swt,rwt,nwt,owt,awt,hwt;fbt||t("Constraint",fbt={});let lwt=(mbt=oa("cc.HingeLimitData"),ybt=ba("enabled"),vbt=ba("upperLimit"),bbt=ba("lowerLimit"),wbt=Ga(Be),Sbt=Ga(Pe),xbt=Ga(Pe),mbt((Cbt=class{constructor(){this._enabled=Ibt&&Ibt(),this._upperLimit=Ebt&&Ebt(),this._lowerLimit=Dbt&&Dbt()}get enabled(){return this._enabled}set enabled(t){this._enabled=t}get upperLimit(){return this._upperLimit}set upperLimit(t){this._upperLimit=t}get lowerLimit(){return this._lowerLimit}set lowerLimit(t){this._lowerLimit=t}},Ibt=Qo(Cbt.prototype,"_enabled",[va,ybt],(function(){return!1})),Ebt=Qo(Cbt.prototype,"_upperLimit",[va,vbt],(function(){return Number.MAX_VALUE})),Dbt=Qo(Cbt.prototype,"_lowerLimit",[va,bbt],(function(){return-Number.MAX_VALUE})),s(Cbt.prototype,"enabled",[wbt],Object.getOwnPropertyDescriptor(Cbt.prototype,"enabled"),Cbt.prototype),s(Cbt.prototype,"upperLimit",[Sbt],Object.getOwnPropertyDescriptor(Cbt.prototype,"upperLimit"),Cbt.prototype),s(Cbt.prototype,"lowerLimit",[xbt],Object.getOwnPropertyDescriptor(Cbt.prototype,"lowerLimit"),Cbt.prototype),Tbt=Cbt))||Tbt),cwt=(Abt=oa("cc.HingeMotorData"),Mbt=ba("enabled"),Pbt=ba("motorVelocity"),Bbt=ba("motorForceLimit"),Rbt=Ga(Be),Obt=Ga(Pe),Lbt=Ga(Pe),Abt((zbt=class{constructor(){this._enabled=kbt&&kbt(),this._motorVelocity=Nbt&&Nbt(),this._motorForceLimit=Ubt&&Ubt()}get enabled(){return this._enabled}set enabled(t){this._enabled=t}get motorVelocity(){return this._motorVelocity}set motorVelocity(t){this._motorVelocity=t}get motorForceLimit(){return this._motorForceLimit}set motorForceLimit(t){this._motorForceLimit=t}},kbt=Qo(zbt.prototype,"_enabled",[va,Mbt],(function(){return!1})),Nbt=Qo(zbt.prototype,"_motorVelocity",[va,Pbt],(function(){return 0})),Ubt=Qo(zbt.prototype,"_motorForceLimit",[va,Bbt],(function(){return 0})),s(zbt.prototype,"enabled",[Rbt],Object.getOwnPropertyDescriptor(zbt.prototype,"enabled"),zbt.prototype),s(zbt.prototype,"motorVelocity",[Obt],Object.getOwnPropertyDescriptor(zbt.prototype,"motorVelocity"),zbt.prototype),s(zbt.prototype,"motorForceLimit",[Lbt],Object.getOwnPropertyDescriptor(zbt.prototype,"motorForceLimit"),zbt.prototype),Fbt=zbt))||Fbt),uwt=t("HingeConstraint",(Vbt=oa("cc.HingeConstraint"),Hbt=Ga(Ki),Gbt=Ga(Ki),Wbt=Ga(Ki),jbt=Ga(Be),$bt=Ga(Pe),qbt=Ga(Pe),Xbt=Ga(Be),Ybt=Ga(Pe),Qbt=Ga(Pe),Kbt=ba("axisA"),Zbt=ba("pivotA"),Jbt=ba("pivotB"),twt=ba("limitData"),ewt=ba("motorData"),Vbt((s((swt=class extends fbt{get pivotA(){return this._pivotA}set pivotA(t){Ki.copy(this._pivotA,t),this.constraint.setPivotA(this._pivotA)}get pivotB(){return this._pivotB}set pivotB(t){Ki.copy(this._pivotB,t),this.constraint.setPivotB(this._pivotB)}get axis(){return this._axis}set axis(t){Ki.copy(this._axis,t),this.constraint.setAxis(this._axis)}get limitEnabled(){return this._limitData.enabled}set limitEnabled(t){this._limitData.enabled=t,this.constraint.setLimitEnabled(t)}get upperLimit(){return this._limitData.upperLimit}set upperLimit(t){this._limitData.upperLimit=t,this.constraint.setUpperLimit(t)}get lowerLimit(){return this._limitData.lowerLimit}set lowerLimit(t){this._limitData.lowerLimit=t,this.constraint.setLowerLimit(t)}get motorEnabled(){return this._motorData.enabled}set motorEnabled(t){this._motorData.enabled=t,this.constraint.setMotorEnabled(t)}get motorVelocity(){return this._motorData.motorVelocity}set motorVelocity(t){this._motorData.motorVelocity=t,this.constraint.setMotorVelocity(t)}get motorForceLimit(){return this._motorData.motorForceLimit}set motorForceLimit(t){this._motorData.motorForceLimit=t,this.constraint.setMotorForceLimit(t)}get constraint(){return this._constraint}constructor(){super(1),this._axis=rwt&&rwt(),this._pivotA=nwt&&nwt(),this._pivotB=owt&&owt(),this._limitData=awt&&awt(),this._motorData=hwt&&hwt()}}).prototype,"pivotA",[Hbt],Object.getOwnPropertyDescriptor(swt.prototype,"pivotA"),swt.prototype),s(swt.prototype,"pivotB",[Gbt],Object.getOwnPropertyDescriptor(swt.prototype,"pivotB"),swt.prototype),s(swt.prototype,"axis",[Wbt],Object.getOwnPropertyDescriptor(swt.prototype,"axis"),swt.prototype),s(swt.prototype,"limitEnabled",[jbt],Object.getOwnPropertyDescriptor(swt.prototype,"limitEnabled"),swt.prototype),s(swt.prototype,"upperLimit",[$bt],Object.getOwnPropertyDescriptor(swt.prototype,"upperLimit"),swt.prototype),s(swt.prototype,"lowerLimit",[qbt],Object.getOwnPropertyDescriptor(swt.prototype,"lowerLimit"),swt.prototype),s(swt.prototype,"motorEnabled",[Xbt],Object.getOwnPropertyDescriptor(swt.prototype,"motorEnabled"),swt.prototype),s(swt.prototype,"motorVelocity",[Ybt],Object.getOwnPropertyDescriptor(swt.prototype,"motorVelocity"),swt.prototype),s(swt.prototype,"motorForceLimit",[Qbt],Object.getOwnPropertyDescriptor(swt.prototype,"motorForceLimit"),swt.prototype),rwt=Qo(swt.prototype,"_axis",[va,Kbt],(function(){return new Ki})),nwt=Qo(swt.prototype,"_pivotA",[va,Zbt],(function(){return new Ki})),owt=Qo(swt.prototype,"_pivotB",[va,Jbt],(function(){return new Ki})),awt=Qo(swt.prototype,"_limitData",[va,twt],(function(){return new lwt})),hwt=Qo(swt.prototype,"_motorData",[va,ewt],(function(){return new cwt})),iwt=swt))||iwt));var dwt,pwt,_wt,gwt,fwt,mwt,ywt,vwt,bwt;let wwt=t("FixedConstraint",(dwt=oa("cc.FixedConstraint"),pwt=Ga(Pe),_wt=Ga(Pe),gwt=ba("breakForce"),fwt=ba("breakTorque"),dwt((s((ywt=class extends fbt{get breakForce(){return this._breakForce}set breakForce(t){this._breakForce=t,this.constraint.setBreakForce(t)}get breakTorque(){return this._breakTorque}set breakTorque(t){this._breakTorque=t,this.constraint.setBreakTorque(t)}get constraint(){return this._constraint}constructor(){super(2),this._breakForce=vwt&&vwt(),this._breakTorque=bwt&&bwt()}}).prototype,"breakForce",[pwt],Object.getOwnPropertyDescriptor(ywt.prototype,"breakForce"),ywt.prototype),s(ywt.prototype,"breakTorque",[_wt],Object.getOwnPropertyDescriptor(ywt.prototype,"breakTorque"),ywt.prototype),vwt=Qo(ywt.prototype,"_breakForce",[va,gwt],(function(){return 1e8})),bwt=Qo(ywt.prototype,"_breakTorque",[va,fwt],(function(){return 1e8})),mwt=ywt))||mwt));var Swt,xwt,Twt,Cwt,Iwt,Ewt,Dwt,Awt,Mwt,Pwt,Bwt,Rwt,Owt,Lwt,Fwt,zwt,kwt,Nwt,Uwt,Vwt,Hwt,Gwt,Wwt,jwt,$wt,qwt,Xwt,Ywt,Qwt,Kwt,Zwt,Jwt,tSt,eSt,iSt,sSt,rSt,nSt,oSt,aSt,hSt,lSt,cSt,uSt,dSt,pSt,_St,gSt,fSt,mSt,ySt,vSt,bSt,wSt,SSt,xSt,TSt,CSt,ISt,ESt,DSt,ASt,MSt,PSt,BSt,RSt,OSt,LSt,FSt,zSt,kSt,NSt,USt,VSt,HSt,GSt,WSt,jSt,$St,qSt,XSt,YSt,QSt,KSt,ZSt,JSt,txt,ext,ixt,sxt,rxt,nxt,oxt,axt,hxt,lxt,cxt,uxt,dxt,pxt,_xt,gxt,fxt,mxt,yxt,vxt,bxt,wxt,Sxt,xxt,Txt;let Cxt=(Swt=oa("cc.LinearLimitSettings"),xwt=Ga(Nmt),Twt=Ga(Nmt),Cwt=Ga(Nmt),Iwt=Ga(Ki),Ewt=Ga(Ki),Dwt=Ga(Pe),Awt=Ga(Be),Mwt=Ga(Pe),Pwt=Ga(Pe),Swt((s((Rwt=class{get xMotion(){return this._xMotion}set xMotion(t){this._xMotion=t,this._impl.setConstraintMode(0,t)}get yMotion(){return this._yMotion}set yMotion(t){this._yMotion=t,this._impl.setConstraintMode(1,t)}get zMotion(){return this._zMotion}set zMotion(t){this._zMotion=t,this._impl.setConstraintMode(2,t)}get upper(){return this._upper}set upper(t){Ki.copy(this._upper,t);{const e=this.lower;this._impl.setLinearLimit(0,e.x,t.x),this._impl.setLinearLimit(1,e.y,t.y),this._impl.setLinearLimit(2,e.z,t.z)}}get lower(){return this._lower}set lower(t){Ki.copy(this._lower,t);{const e=this.upper;this._impl.setLinearLimit(0,t.x,e.x),this._impl.setLinearLimit(1,t.y,e.y),this._impl.setLinearLimit(2,t.z,e.z)}}get restitution(){return this._bounciness}set restitution(t){this._bounciness=t,this._impl.setLinearRestitution(t)}get enableSoftConstraint(){return this._enableSoftConstraint}set enableSoftConstraint(t){this._enableSoftConstraint=t,this._impl.setLinearSoftConstraint(t)}get stiffness(){return this._stiffness}set stiffness(t){this._stiffness=t,this._impl.setLinearStiffness(t)}get damping(){return this._damping}set damping(t){this._damping=t,this._impl.setLinearDamping(t)}set impl(t){this._impl=t}constructor(t){this._xMotion=Owt&&Owt(),this._yMotion=Lwt&&Lwt(),this._zMotion=Fwt&&Fwt(),this._upper=zwt&&zwt(),this._lower=kwt&&kwt(),this._enableSoftConstraint=Nwt&&Nwt(),this._bounciness=Uwt&&Uwt(),this._stiffness=Vwt&&Vwt(),this._damping=Hwt&&Hwt(),this._impl=void 0,this._impl=t}}).prototype,"xMotion",[xwt],Object.getOwnPropertyDescriptor(Rwt.prototype,"xMotion"),Rwt.prototype),s(Rwt.prototype,"yMotion",[Twt],Object.getOwnPropertyDescriptor(Rwt.prototype,"yMotion"),Rwt.prototype),s(Rwt.prototype,"zMotion",[Cwt],Object.getOwnPropertyDescriptor(Rwt.prototype,"zMotion"),Rwt.prototype),s(Rwt.prototype,"upper",[Iwt],Object.getOwnPropertyDescriptor(Rwt.prototype,"upper"),Rwt.prototype),s(Rwt.prototype,"lower",[Ewt],Object.getOwnPropertyDescriptor(Rwt.prototype,"lower"),Rwt.prototype),s(Rwt.prototype,"restitution",[Dwt],Object.getOwnPropertyDescriptor(Rwt.prototype,"restitution"),Rwt.prototype),s(Rwt.prototype,"enableSoftConstraint",[Awt],Object.getOwnPropertyDescriptor(Rwt.prototype,"enableSoftConstraint"),Rwt.prototype),s(Rwt.prototype,"stiffness",[Mwt],Object.getOwnPropertyDescriptor(Rwt.prototype,"stiffness"),Rwt.prototype),s(Rwt.prototype,"damping",[Pwt],Object.getOwnPropertyDescriptor(Rwt.prototype,"damping"),Rwt.prototype),Owt=Qo(Rwt.prototype,"_xMotion",[va],(function(){return 0})),Lwt=Qo(Rwt.prototype,"_yMotion",[va],(function(){return 0})),Fwt=Qo(Rwt.prototype,"_zMotion",[va],(function(){return 0})),zwt=Qo(Rwt.prototype,"_upper",[va],(function(){return new Ki})),kwt=Qo(Rwt.prototype,"_lower",[va],(function(){return new Ki})),Nwt=Qo(Rwt.prototype,"_enableSoftConstraint",[va],(function(){return!1})),Uwt=Qo(Rwt.prototype,"_bounciness",[va],(function(){return 0})),Vwt=Qo(Rwt.prototype,"_stiffness",[va],(function(){return 0})),Hwt=Qo(Rwt.prototype,"_damping",[va],(function(){return 0})),Bwt=Rwt))||Bwt),Ixt=(Gwt=oa("cc.AngularLimitSettings"),Wwt=Ga(Nmt),jwt=Ga(Nmt),$wt=Ga(Nmt),qwt=Ga(Pe),Xwt=Ga(Pe),Ywt=Ga(Pe),Qwt=Ga(Pe),Kwt=Ga(Pe),Zwt=Ga(Be),Jwt=Ga(Pe),tSt=Ga(Pe),eSt=Ga(Be),iSt=Ga(Pe),sSt=Ga(Pe),Gwt((s((nSt=class{get twistMotion(){return this._twistMotion}set twistMotion(t){this._twistMotion=t,this._impl.setConstraintMode(3,t)}get swingMotion1(){return this._swing1Motion}set swingMotion1(t){this._swing1Motion=t,this._impl.setConstraintMode(4,t)}get swingMotion2(){return this._swing2Motion}set swingMotion2(t){this._swing2Motion=t,this._impl.setConstraintMode(5,t)}get twistExtent(){return this._twistExtent}set twistExtent(t){this._twistExtent=t,this._impl.setAngularExtent(t,this.swingExtent1,this.swingExtent2)}get swingExtent1(){return this._swingExtent1}set swingExtent1(t){this._swingExtent1=t,this._impl.setAngularExtent(this.twistExtent,t,this.swingExtent2)}get swingExtent2(){return this._swingExtent2}set swingExtent2(t){this._swingExtent2=t,this._impl.setAngularExtent(this.twistExtent,this.swingExtent1,t)}get twistRestitution(){return this._twistBounciness}set twistRestitution(t){this._twistBounciness=t,this._impl.setTwistRestitution(t)}get swingRestitution(){return this._swingBounciness}set swingRestitution(t){this._swingBounciness=t,this._impl.setSwingRestitution(t)}get enableSoftConstraintTwist(){return this._enableSoftConstraintTwist}set enableSoftConstraintTwist(t){this._enableSoftConstraintTwist=t,this._impl.setTwistSoftConstraint(t)}get twistStiffness(){return this._twistStiffness}set twistStiffness(t){this._twistStiffness=t,this._impl.setTwistStiffness(t)}get twistDamping(){return this._twistDamping}set twistDamping(t){this._twistDamping=t,this._impl.setTwistDamping(t)}get enableSoftConstraintSwing(){return this._enableSoftConstraintSwing}set enableSoftConstraintSwing(t){this._enableSoftConstraintSwing=t,this._impl.setSwingSoftConstraint(t)}get swingStiffness(){return this._swingStiffness}set swingStiffness(t){this._swingStiffness=t,this._impl.setSwingStiffness(t)}get swingDamping(){return this._swingDamping}set swingDamping(t){this._swingDamping=t,this._impl.setSwingDamping(t)}set impl(t){this._impl=t}constructor(t){this._swing1Motion=oSt&&oSt(),this._swing2Motion=aSt&&aSt(),this._twistMotion=hSt&&hSt(),this._twistExtent=lSt&&lSt(),this._swingExtent1=cSt&&cSt(),this._swingExtent2=uSt&&uSt(),this._enableSoftConstraintSwing=dSt&&dSt(),this._swingBounciness=pSt&&pSt(),this._swingStiffness=_St&&_St(),this._swingDamping=gSt&&gSt(),this._enableSoftConstraintTwist=fSt&&fSt(),this._twistBounciness=mSt&&mSt(),this._twistStiffness=ySt&&ySt(),this._twistDamping=vSt&&vSt(),this._impl=void 0,this._impl=t}}).prototype,"twistMotion",[Wwt],Object.getOwnPropertyDescriptor(nSt.prototype,"twistMotion"),nSt.prototype),s(nSt.prototype,"swingMotion1",[jwt],Object.getOwnPropertyDescriptor(nSt.prototype,"swingMotion1"),nSt.prototype),s(nSt.prototype,"swingMotion2",[$wt],Object.getOwnPropertyDescriptor(nSt.prototype,"swingMotion2"),nSt.prototype),s(nSt.prototype,"twistExtent",[qwt],Object.getOwnPropertyDescriptor(nSt.prototype,"twistExtent"),nSt.prototype),s(nSt.prototype,"swingExtent1",[Xwt],Object.getOwnPropertyDescriptor(nSt.prototype,"swingExtent1"),nSt.prototype),s(nSt.prototype,"swingExtent2",[Ywt],Object.getOwnPropertyDescriptor(nSt.prototype,"swingExtent2"),nSt.prototype),s(nSt.prototype,"twistRestitution",[Qwt],Object.getOwnPropertyDescriptor(nSt.prototype,"twistRestitution"),nSt.prototype),s(nSt.prototype,"swingRestitution",[Kwt],Object.getOwnPropertyDescriptor(nSt.prototype,"swingRestitution"),nSt.prototype),s(nSt.prototype,"enableSoftConstraintTwist",[Zwt],Object.getOwnPropertyDescriptor(nSt.prototype,"enableSoftConstraintTwist"),nSt.prototype),s(nSt.prototype,"twistStiffness",[Jwt],Object.getOwnPropertyDescriptor(nSt.prototype,"twistStiffness"),nSt.prototype),s(nSt.prototype,"twistDamping",[tSt],Object.getOwnPropertyDescriptor(nSt.prototype,"twistDamping"),nSt.prototype),s(nSt.prototype,"enableSoftConstraintSwing",[eSt],Object.getOwnPropertyDescriptor(nSt.prototype,"enableSoftConstraintSwing"),nSt.prototype),s(nSt.prototype,"swingStiffness",[iSt],Object.getOwnPropertyDescriptor(nSt.prototype,"swingStiffness"),nSt.prototype),s(nSt.prototype,"swingDamping",[sSt],Object.getOwnPropertyDescriptor(nSt.prototype,"swingDamping"),nSt.prototype),oSt=Qo(nSt.prototype,"_swing1Motion",[va],(function(){return 0})),aSt=Qo(nSt.prototype,"_swing2Motion",[va],(function(){return 0})),hSt=Qo(nSt.prototype,"_twistMotion",[va],(function(){return 0})),lSt=Qo(nSt.prototype,"_twistExtent",[va],(function(){return 0})),cSt=Qo(nSt.prototype,"_swingExtent1",[va],(function(){return 0})),uSt=Qo(nSt.prototype,"_swingExtent2",[va],(function(){return 0})),dSt=Qo(nSt.prototype,"_enableSoftConstraintSwing",[va],(function(){return!1})),pSt=Qo(nSt.prototype,"_swingBounciness",[va],(function(){return 0})),_St=Qo(nSt.prototype,"_swingStiffness",[va],(function(){return 0})),gSt=Qo(nSt.prototype,"_swingDamping",[va],(function(){return 0})),fSt=Qo(nSt.prototype,"_enableSoftConstraintTwist",[va],(function(){return!1})),mSt=Qo(nSt.prototype,"_twistBounciness",[va],(function(){return 0})),ySt=Qo(nSt.prototype,"_twistStiffness",[va],(function(){return 0})),vSt=Qo(nSt.prototype,"_twistDamping",[va],(function(){return 0})),rSt=nSt))||rSt),Ext=(bSt=oa("cc.LinearDriverSettings"),wSt=Ga(Umt),SSt=Ga(Umt),xSt=Ga(Umt),TSt=Ga(Ki),CSt=Ga(Ki),ISt=Ga(Pe),bSt((s((DSt=class{get xDrive(){return this._xDrive}set xDrive(t){this._xDrive=t,this._impl.setDriverMode(0,t)}get yDrive(){return this._yDrive}set yDrive(t){this._yDrive=t,this._impl.setDriverMode(1,t)}get zDrive(){return this._zDrive}set zDrive(t){this._zDrive=t,this._impl.setDriverMode(2,t)}get targetPosition(){return this._target}set targetPosition(t){Ki.copy(this._target,t),this._impl.setLinearMotorTarget(t)}get targetVelocity(){return this._velocity}set targetVelocity(t){Ki.copy(this._velocity,t),this._impl.setLinearMotorVelocity(t)}get strength(){return this._strength}set strength(t){this._strength=t,this._impl.setLinearMotorForceLimit(t)}set impl(t){this._impl=t}constructor(t){this._target=ASt&&ASt(),this._velocity=MSt&&MSt(),this._xDrive=PSt&&PSt(),this._yDrive=BSt&&BSt(),this._zDrive=RSt&&RSt(),this._strength=OSt&&OSt(),this._impl=void 0,this._impl=t}}).prototype,"xDrive",[wSt],Object.getOwnPropertyDescriptor(DSt.prototype,"xDrive"),DSt.prototype),s(DSt.prototype,"yDrive",[SSt],Object.getOwnPropertyDescriptor(DSt.prototype,"yDrive"),DSt.prototype),s(DSt.prototype,"zDrive",[xSt],Object.getOwnPropertyDescriptor(DSt.prototype,"zDrive"),DSt.prototype),s(DSt.prototype,"targetPosition",[TSt],Object.getOwnPropertyDescriptor(DSt.prototype,"targetPosition"),DSt.prototype),s(DSt.prototype,"targetVelocity",[CSt],Object.getOwnPropertyDescriptor(DSt.prototype,"targetVelocity"),DSt.prototype),s(DSt.prototype,"strength",[ISt],Object.getOwnPropertyDescriptor(DSt.prototype,"strength"),DSt.prototype),ASt=Qo(DSt.prototype,"_target",[va],(function(){return new Ki})),MSt=Qo(DSt.prototype,"_velocity",[va],(function(){return new Ki})),PSt=Qo(DSt.prototype,"_xDrive",[va],(function(){return 0})),BSt=Qo(DSt.prototype,"_yDrive",[va],(function(){return 0})),RSt=Qo(DSt.prototype,"_zDrive",[va],(function(){return 0})),OSt=Qo(DSt.prototype,"_strength",[va],(function(){return 0})),ESt=DSt))||ESt),Dxt=(LSt=oa("cc.AngularDriverSettings"),FSt=Ga(Umt),zSt=Ga(Umt),kSt=Ga(Umt),NSt=Ga(Ki),USt=Ga(Ki),VSt=Ga(Pe),LSt((s((GSt=class{get twistDrive(){return this._twistDrive}set twistDrive(t){this._twistDrive=t,this._impl.setDriverMode(3,t)}get swingDrive1(){return this._swingDrive1}set swingDrive1(t){this._swingDrive1=t,this._impl.setDriverMode(4,t)}get swingDrive2(){return this._swingDrive2}set swingDrive2(t){this._swingDrive2=t,this._impl.setDriverMode(5,t)}get targetOrientation(){return this._targetOrientation}set targetOrientation(t){Ki.copy(this._targetOrientation,t),this._impl.setAngularMotorTarget(t)}get targetVelocity(){return this._targetVelocity}set targetVelocity(t){Ki.copy(this._targetVelocity,t),this._impl.setAngularMotorVelocity(t)}get strength(){return this._strength}set strength(t){this._strength=t,this._impl.setAngularMotorForceLimit(t)}set impl(t){this._impl=t}constructor(t){this._swingDrive1=WSt&&WSt(),this._swingDrive2=jSt&&jSt(),this._twistDrive=$St&&$St(),this._targetOrientation=qSt&&qSt(),this._targetVelocity=XSt&&XSt(),this._strength=YSt&&YSt(),this._impl=void 0,this._impl=t}}).prototype,"twistDrive",[FSt],Object.getOwnPropertyDescriptor(GSt.prototype,"twistDrive"),GSt.prototype),s(GSt.prototype,"swingDrive1",[zSt],Object.getOwnPropertyDescriptor(GSt.prototype,"swingDrive1"),GSt.prototype),s(GSt.prototype,"swingDrive2",[kSt],Object.getOwnPropertyDescriptor(GSt.prototype,"swingDrive2"),GSt.prototype),s(GSt.prototype,"targetOrientation",[NSt],Object.getOwnPropertyDescriptor(GSt.prototype,"targetOrientation"),GSt.prototype),s(GSt.prototype,"targetVelocity",[USt],Object.getOwnPropertyDescriptor(GSt.prototype,"targetVelocity"),GSt.prototype),s(GSt.prototype,"strength",[VSt],Object.getOwnPropertyDescriptor(GSt.prototype,"strength"),GSt.prototype),WSt=Qo(GSt.prototype,"_swingDrive1",[va],(function(){return 0})),jSt=Qo(GSt.prototype,"_swingDrive2",[va],(function(){return 0})),$St=Qo(GSt.prototype,"_twistDrive",[va],(function(){return 0})),qSt=Qo(GSt.prototype,"_targetOrientation",[va],(function(){return new Ki})),XSt=Qo(GSt.prototype,"_targetVelocity",[va],(function(){return new Ki})),YSt=Qo(GSt.prototype,"_strength",[va],(function(){return 0})),HSt=GSt))||HSt),Axt=t("ConfigurableConstraint",(QSt=oa("cc.ConfigurableConstraint"),KSt=Ga(Ki),ZSt=Ga(Ki),JSt=Ga(Ki),txt=Ga(Ki),ext=Ga(Be),ixt=Ga(Pe),sxt=Ga(Pe),rxt=Ga(Cxt),nxt=Ga(Ixt),oxt=Ga(Ext),axt=Ga(Dxt),hxt=ba("linearLimitSettings"),lxt=ba("angularLimitSettings"),cxt=ba("linearDriverSettings"),uxt=ba("angularDriverSettings"),QSt((s((pxt=class extends fbt{get axis(){return this._axis}set axis(t){Ki.copy(this._axis,t),this.constraint.setAxis(this._axis)}get secondaryAxis(){return this._secondaryAxis}set secondaryAxis(t){Ki.copy(this._secondaryAxis,t),this.constraint.setSecondaryAxis(this._secondaryAxis)}get pivotA(){return this._pivotA}set pivotA(t){Ki.copy(this._pivotA,t),this.constraint.setPivotA(this._pivotA)}get pivotB(){return this._pivotB}set pivotB(t){Ki.copy(this._pivotB,t),this.constraint.setPivotB(this._pivotB)}get autoPivotB(){return this._autoPivotB}set autoPivotB(t){this._autoPivotB=t,this.constraint.setAutoPivotB(this._autoPivotB)}get breakForce(){return this._breakForce}set breakForce(t){this._breakForce=t,this.constraint.setBreakForce(t)}get breakTorque(){return this._breakTorque}set breakTorque(t){this._breakTorque=t,this.constraint.setBreakTorque(t)}get linearLimitSettings(){return this._linearLimitSettings}set linearLimitSettings(t){this._linearLimitSettings=t;{const e=this.constraint;e.setConstraintMode(0,t.xMotion),e.setConstraintMode(1,t.yMotion),e.setConstraintMode(2,t.zMotion);const i=t.upper,s=t.lower;e.setLinearLimit(0,s.x,i.x),e.setLinearLimit(1,s.y,i.y),e.setLinearLimit(2,s.z,i.z),e.setLinearSoftConstraint(t.enableSoftConstraint),e.setLinearDamping(t.damping),e.setLinearStiffness(t.stiffness),e.setLinearRestitution(t.restitution)}}get angularLimitSettings(){return this._angularLimitSettings}set angularLimitSettings(t){this._angularLimitSettings=t;{const e=this.constraint;e.setConstraintMode(3,t.twistMotion),e.setConstraintMode(4,t.swingMotion1),e.setConstraintMode(5,t.swingMotion2),e.setAngularExtent(t.twistExtent,t.swingExtent1,t.swingExtent2),e.setTwistRestitution(t.twistRestitution),e.setSwingRestitution(t.swingRestitution),e.setTwistSoftConstraint(t.enableSoftConstraintTwist),e.setSwingSoftConstraint(t.enableSoftConstraintSwing),e.setTwistDamping(t.twistDamping),e.setSwingDamping(t.swingDamping),e.setTwistStiffness(t.twistStiffness),e.setSwingStiffness(t.swingStiffness)}}get linearDriverSettings(){return this._linearDriverSettings}set linearDriverSettings(t){this._linearDriverSettings=t;{const e=this.constraint;e.setDriverMode(0,t.xDrive),e.setDriverMode(1,t.yDrive),e.setDriverMode(2,t.zDrive),e.setLinearMotorTarget(t.targetPosition),e.setLinearMotorVelocity(t.targetVelocity),e.setLinearMotorForceLimit(t.strength)}}get angularDriverSettings(){return this._angularDriverSettings}set angularDriverSettings(t){this._angularDriverSettings=t;{const e=this.constraint;e.setDriverMode(3,t.twistDrive),e.setDriverMode(4,t.swingDrive1),e.setDriverMode(5,t.swingDrive2),e.setAngularMotorTarget(t.targetOrientation),e.setAngularMotorVelocity(t.targetVelocity),e.setAngularMotorForceLimit(t.strength)}}get constraint(){return this._constraint}constructor(){super(3),this._breakForce=_xt&&_xt(),this._breakTorque=gxt&&gxt(),this._linearLimitSettings=fxt&&fxt(),this._angularLimitSettings=mxt&&mxt(),this._linearDriverSettings=yxt&&yxt(),this._angularDriverSettings=vxt&&vxt(),this._pivotA=bxt&&bxt(),this._pivotB=wxt&&wxt(),this._autoPivotB=Sxt&&Sxt(),this._axis=xxt&&xxt(),this._secondaryAxis=Txt&&Txt(),this._linearLimitSettings=new Cxt(this.constraint),this._angularLimitSettings=new Ixt(this.constraint),this._linearDriverSettings=new Ext(this.constraint),this._angularDriverSettings=new Dxt(this.constraint)}onLoad(){super.onLoad(),this.linearLimitSettings.impl=this.constraint,this.angularLimitSettings.impl=this.constraint,this.linearDriverSettings.impl=this.constraint,this.angularDriverSettings.impl=this.constraint}}).prototype,"axis",[KSt],Object.getOwnPropertyDescriptor(pxt.prototype,"axis"),pxt.prototype),s(pxt.prototype,"secondaryAxis",[ZSt],Object.getOwnPropertyDescriptor(pxt.prototype,"secondaryAxis"),pxt.prototype),s(pxt.prototype,"pivotA",[JSt],Object.getOwnPropertyDescriptor(pxt.prototype,"pivotA"),pxt.prototype),s(pxt.prototype,"pivotB",[txt],Object.getOwnPropertyDescriptor(pxt.prototype,"pivotB"),pxt.prototype),s(pxt.prototype,"autoPivotB",[ext],Object.getOwnPropertyDescriptor(pxt.prototype,"autoPivotB"),pxt.prototype),s(pxt.prototype,"breakForce",[ixt],Object.getOwnPropertyDescriptor(pxt.prototype,"breakForce"),pxt.prototype),s(pxt.prototype,"breakTorque",[sxt],Object.getOwnPropertyDescriptor(pxt.prototype,"breakTorque"),pxt.prototype),s(pxt.prototype,"linearLimitSettings",[rxt],Object.getOwnPropertyDescriptor(pxt.prototype,"linearLimitSettings"),pxt.prototype),s(pxt.prototype,"angularLimitSettings",[nxt],Object.getOwnPropertyDescriptor(pxt.prototype,"angularLimitSettings"),pxt.prototype),s(pxt.prototype,"linearDriverSettings",[oxt],Object.getOwnPropertyDescriptor(pxt.prototype,"linearDriverSettings"),pxt.prototype),s(pxt.prototype,"angularDriverSettings",[axt],Object.getOwnPropertyDescriptor(pxt.prototype,"angularDriverSettings"),pxt.prototype),_xt=Qo(pxt.prototype,"_breakForce",[va],(function(){return 1e8})),gxt=Qo(pxt.prototype,"_breakTorque",[va],(function(){return 1e8})),fxt=Qo(pxt.prototype,"_linearLimitSettings",[va,hxt],null),mxt=Qo(pxt.prototype,"_angularLimitSettings",[va,lxt],null),yxt=Qo(pxt.prototype,"_linearDriverSettings",[va,cxt],null),vxt=Qo(pxt.prototype,"_angularDriverSettings",[va,uxt],null),bxt=Qo(pxt.prototype,"_pivotA",[va],(function(){return new Ki})),wxt=Qo(pxt.prototype,"_pivotB",[va],(function(){return new Ki})),Sxt=Qo(pxt.prototype,"_autoPivotB",[va],(function(){return!1})),xxt=Qo(pxt.prototype,"_axis",[va],(function(){return new Ki(0,1,0)})),Txt=Qo(pxt.prototype,"_secondaryAxis",[va],(function(){return new Ki(1,0,0)})),dxt=pxt))||dxt));var Mxt,Pxt,Bxt,Rxt,Oxt,Lxt,Fxt;let zxt=t("PointToPointConstraint",(Mxt=oa("cc.PointToPointConstraint"),Pxt=Ga(Ki),Bxt=Ga(Ki),Mxt((s((Oxt=class extends fbt{get pivotA(){return this._pivotA}set pivotA(t){Ki.copy(this._pivotA,t),this.constraint.setPivotA(this._pivotA)}get pivotB(){return this._pivotB}set pivotB(t){Ki.copy(this._pivotB,t),this.constraint.setPivotB(this._pivotB)}get constraint(){return this._constraint}constructor(){super(0),this._pivotA=Lxt&&Lxt(),this._pivotB=Fxt&&Fxt()}}).prototype,"pivotA",[Pxt],Object.getOwnPropertyDescriptor(Oxt.prototype,"pivotA"),Oxt.prototype),s(Oxt.prototype,"pivotB",[Bxt],Object.getOwnPropertyDescriptor(Oxt.prototype,"pivotB"),Oxt.prototype),Lxt=Qo(Oxt.prototype,"_pivotA",[va],(function(){return new Ki})),Fxt=Qo(Oxt.prototype,"_pivotB",[va],(function(){return new Ki})),Rxt=Oxt))||Rxt));var kxt,Nxt,Uxt,Vxt,Hxt,Gxt,Wxt,jxt,$xt,qxt,Xxt,Yxt,Qxt,Kxt,Zxt;let Jxt=t("CharacterController",(kxt=oa("cc.CharacterController"),Nxt=Ga(Wmt.PhysicsGroup),Uxt=Ga(Pe),Vxt=Ga(Pe),Hxt=Ga(Pe),Gxt=Ga(Pe),Wxt=Ga(Ki),kxt(jxt=la(($xt=class extends(Dn(Ag)){get group(){return this._group}set group(t){this._group=t,this._cct&&this._cct.getGroup()!==t&&this._cct.setGroup(t)}get minMoveDistance(){return this._minMoveDistance}set minMoveDistance(t){this._minMoveDistance!==t&&(this._minMoveDistance=Math.abs(t))}get stepOffset(){return this._stepOffset}set stepOffset(t){this._stepOffset!==t&&(this._stepOffset=Math.abs(t),this._cct&&this._cct.setStepOffset(t))}get slopeLimit(){return this._slopeLimit}set slopeLimit(t){this._slopeLimit!==t&&(this._slopeLimit=Math.abs(t),this._cct&&this._cct.setSlopeLimit(t))}get skinWidth(){return this._skinWidth}set skinWidth(t){this._skinWidth!==t&&(this._skinWidth=Math.abs(t),this._cct&&this._cct.setContactOffset(Math.max(1e-4,t)))}get center(){return this._center}set center(t){Ki.equals(this._center,t)||Ki.copy(this._center,t)}constructor(t){super(),this.type=void 0,this._cct=null,this._group=qxt&&qxt(),this._minMoveDistance=Xxt&&Xxt(),this._stepOffset=Yxt&&Yxt(),this._slopeLimit=Qxt&&Qxt(),this._skinWidth=Kxt&&Kxt(),this._center=Zxt&&Zxt(),this._initialized=!1,this._prevPos=new Ki,this._currentPos=new Ki,this._velocity=new Ki,this._centerWorldPosition=new Ki,this._needCollisionEvent=!1,this._needTriggerEvent=!1,this.type=t}get _isInitialized(){return!(null===this._cct||!this._initialized)}onLoad(){Lft.runInEditor&&(this._cct=Kft(this.type),this._initialized=this._cct.initialize(this),this._cct.onLoad())}onEnable(){this._cct&&this._cct.onEnable()}onDisable(){this._cct&&this._cct.onDisable()}onDestroy(){this._cct&&(this._needCollisionEvent=!1,this._needTriggerEvent=!1,this._cct.updateEventListener(),this._cct.onDestroy(),this._cct=null)}get centerWorldPosition(){return this._isInitialized&&this._cct.getPosition(this._centerWorldPosition),this._centerWorldPosition}set centerWorldPosition(t){this._isInitialized&&this._cct.setPosition(t)}get velocity(){return this._velocity}get isGrounded(){return this._cct.onGround()}move(t){if(!this._isInitialized)return;this._prevPos.set(this.centerWorldPosition);const e=Wmt.instance.fixedTimeStep;this._cct.move(t,this._minMoveDistance,e),this._currentPos.set(this.centerWorldPosition),this._velocity=this._currentPos.subtract(this._prevPos).multiplyScalar(1/e),this._cct.syncPhysicsToScene()}on(t,e,i,s){const r=super.on(t,e,i,s);return this._updateNeedEvent(t),r}off(t,e,i){super.off(t,e,i),this._updateNeedEvent()}once(t,e,i){const s=super.once(t,e,i);return this._updateNeedEvent(t),s}getGroup(){return this._isInitialized?this._cct.getGroup():0}setGroup(t){this._isInitialized&&this._cct.setGroup(t)}addGroup(t){this._isInitialized&&this._cct.addGroup(t)}removeGroup(t){this._isInitialized&&this._cct.removeGroup(t)}getMask(){return this._isInitialized?this._cct.getMask():0}setMask(t){this._isInitialized&&this._cct.setMask(t)}addMask(t){this._isInitialized&&this._cct.addMask(t)}removeMask(t){this._isInitialized&&this._cct.removeMask(t)}get needCollisionEvent(){return this._needCollisionEvent}get needTriggerEvent(){return this._needTriggerEvent}_updateNeedEvent(t){this.isValid&&(void 0!==t?("onControllerColliderHit"===t&&(this._needCollisionEvent=!0),"onControllerTriggerEnter"!==t&&"onControllerTriggerStay"!==t&&"onControllerTriggerExit"!==t||(this._needTriggerEvent=!0)):(this.hasEventListener("onControllerColliderHit")||(this._needCollisionEvent=!1),this.hasEventListener("onControllerTriggerEnter")||this.hasEventListener("onControllerTriggerStay")||this.hasEventListener("onControllerTriggerExit")||(this._needTriggerEvent=!1)),this._cct&&this._cct.updateEventListener())}},s($xt.prototype,"group",[Nxt],Object.getOwnPropertyDescriptor($xt.prototype,"group"),$xt.prototype),s($xt.prototype,"minMoveDistance",[Uxt],Object.getOwnPropertyDescriptor($xt.prototype,"minMoveDistance"),$xt.prototype),s($xt.prototype,"stepOffset",[Vxt],Object.getOwnPropertyDescriptor($xt.prototype,"stepOffset"),$xt.prototype),s($xt.prototype,"slopeLimit",[Hxt],Object.getOwnPropertyDescriptor($xt.prototype,"slopeLimit"),$xt.prototype),s($xt.prototype,"skinWidth",[Gxt],Object.getOwnPropertyDescriptor($xt.prototype,"skinWidth"),$xt.prototype),s($xt.prototype,"center",[Wxt],Object.getOwnPropertyDescriptor($xt.prototype,"center"),$xt.prototype),qxt=Qo($xt.prototype,"_group",[va],(function(){return Wmt.PhysicsGroup.DEFAULT})),Xxt=Qo($xt.prototype,"_minMoveDistance",[va],(function(){return.001})),Yxt=Qo($xt.prototype,"_stepOffset",[va],(function(){return.5})),Qxt=Qo($xt.prototype,"_slopeLimit",[va],(function(){return 45})),Kxt=Qo($xt.prototype,"_skinWidth",[va],(function(){return.01})),Zxt=Qo($xt.prototype,"_center",[va],(function(){return new Ki})),jxt=$xt))||jxt)||jxt));var tTt,eTt,iTt,sTt,rTt,nTt,oTt,aTt,hTt,lTt;new Ki(0,0,0);let cTt=t("BoxCharacterController",(tTt=oa("cc.BoxCharacterController"),eTt=ha(-1),iTt=Ga(Pe),sTt=Ga(Pe),rTt=Ga(Pe),tTt(nTt=eTt((oTt=class extends Jxt{constructor(){super(0),this._halfHeight=aTt&&aTt(),this._halfSideExtent=hTt&&hTt(),this._halfForwardExtent=lTt&&lTt()}get halfHeight(){return this._halfHeight}set halfHeight(t){this._halfHeight!==t&&(this._halfHeight=Math.abs(t),this._cct&&this._cct.setHalfHeight(t))}get halfSideExtent(){return this._halfSideExtent}set halfSideExtent(t){this._halfSideExtent!==t&&(this._halfSideExtent=Math.abs(t),this._cct&&this._cct.setHalfSideExtent(t))}get halfForwardExtent(){return this._halfForwardExtent}set halfForwardExtent(t){this._halfForwardExtent!==t&&(this._halfForwardExtent=Math.abs(t),this._cct&&this._cct.setHalfForwardExtent(t))}},s(oTt.prototype,"halfHeight",[iTt],Object.getOwnPropertyDescriptor(oTt.prototype,"halfHeight"),oTt.prototype),s(oTt.prototype,"halfSideExtent",[sTt],Object.getOwnPropertyDescriptor(oTt.prototype,"halfSideExtent"),oTt.prototype),s(oTt.prototype,"halfForwardExtent",[rTt],Object.getOwnPropertyDescriptor(oTt.prototype,"halfForwardExtent"),oTt.prototype),aTt=Qo(oTt.prototype,"_halfHeight",[va],(function(){return.5})),hTt=Qo(oTt.prototype,"_halfSideExtent",[va],(function(){return.5})),lTt=Qo(oTt.prototype,"_halfForwardExtent",[va],(function(){return.5})),nTt=oTt))||nTt)||nTt));var uTt,dTt,pTt,_Tt,gTt,fTt,mTt,yTt;new Ki(0,0,0);let vTt=t("CapsuleCharacterController",(uTt=oa("cc.CapsuleCharacterController"),dTt=ha(-1),pTt=Ga(Pe),_Tt=Ga(Pe),uTt(gTt=dTt((fTt=class extends Jxt{constructor(){super(1),this._radius=mTt&&mTt(),this._height=yTt&&yTt()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=Math.abs(t),this._cct&&this._cct.setRadius(t))}get height(){return this._height}set height(t){this._height!==t&&(this._height=Math.abs(t),this._cct&&this._cct.setHeight(t))}},s(fTt.prototype,"radius",[pTt],Object.getOwnPropertyDescriptor(fTt.prototype,"radius"),fTt.prototype),s(fTt.prototype,"height",[_Tt],Object.getOwnPropertyDescriptor(fTt.prototype,"height"),fTt.prototype),mTt=Qo(fTt.prototype,"_radius",[va],(function(){return.5})),yTt=Qo(fTt.prototype,"_height",[va],(function(){return 1})),gTt=fTt))||gTt)||gTt));class bTt{constructor(){this.worldPosition=new Ki,this.worldNormal=new Ki,this.motionDirection=new Ki,this.motionLength=0}}h.PhysicsSystem=Wmt,h.PhysicsMaterial=Amt,h.PhysicsRayResult=Mmt,h.ConstantForce=_vt;var wTt=Object.freeze({__proto__:null,BoxCharacterController:cTt,BoxCollider:Iyt,CapsuleCharacterController:vTt,CapsuleCollider:kyt,CharacterController:Jxt,CharacterControllerContact:bTt,get Collider(){return vyt},ConeCollider:tvt,ConfigurableConstraint:Axt,ConstantForce:_vt,get Constraint(){return fbt},CylinderCollider:$yt,EAxisDirection:Omt,ECharacterControllerType:Vmt,EColliderType:zmt,EConstraintMode:Nmt,EConstraintType:kmt,ED6Axis:Lmt,EDriverMode:Umt,EPhysicsDrawFlags:Gmt,ERigidBodyType:Rmt,ESimplexType:Fmt,FixedConstraint:wwt,HingeConstraint:uwt,MeshCollider:avt,PhysicsGroup:Hmt,PhysicsLineStripCastResult:Pmt,PhysicsMaterial:Amt,PhysicsRayResult:Mmt,PhysicsSystem:Wmt,PlaneCollider:nbt,PointToPointConstraint:zxt,get RigidBody(){return ayt},get SimplexCollider(){return Zvt},SphereCollider:Myt,TerrainCollider:Wvt,selector:Lft,utils:cY});t("physics",wTt),h.physics=wTt;const STt=rmt,xTt=nmt;class TTt{get isAwake(){const t=Zft.CollisionObject_getActivationState(this.impl);return 1===t||4===t}get isSleepy(){return 3===Zft.CollisionObject_getActivationState(this.impl)}get isSleeping(){return 2===Zft.CollisionObject_getActivationState(this.impl)}setMass(t){this._rigidBody.isDynamic&&(Zft.RigidBody_setMass(this.impl,t),this._wakeUpIfSleep(),this._sharedBody.dirty|=1)}setType(t){this._sharedBody.setType(t)}setLinearDamping(t){Zft.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)}setAngularDamping(t){Zft.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)}useGravity(t){if(!this._rigidBody.isDynamic)return;let e=Zft.RigidBody_getFlags(this.impl);t?e&=-2:(Zft.RigidBody_setGravity(this.impl,umt(smt.instance.BT_V3_0,Ki.ZERO)),e|=1),Zft.RigidBody_setFlags(this.impl,e),this._wakeUpIfSleep(),this._sharedBody.dirty|=1}useCCD(t){Zft.CollisionObject_setCcdMotionThreshold(this.impl,t?.01:0),Zft.CollisionObject_setCcdSweptSphereRadius(this.impl,t?.1:0),this._isUsingCCD=t}isUsingCCD(){return this._isUsingCCD}setLinearFactor(t){Zft.RigidBody_setLinearFactor(this.impl,umt(smt.instance.BT_V3_0,t)),this._wakeUpIfSleep()}setAngularFactor(t){Zft.RigidBody_setAngularFactor(this.impl,umt(smt.instance.BT_V3_0,t)),this._wakeUpIfSleep()}setAllowSleep(t){this._rigidBody.isDynamic&&(t?Zft.CollisionObject_forceActivationState(this.impl,1):Zft.CollisionObject_forceActivationState(this.impl,4),this._wakeUpIfSleep())}get impl(){return this._sharedBody.body}get rigidBody(){return this._rigidBody}get sharedBody(){return this._sharedBody}get isEnabled(){return this._isEnabled}constructor(){this.id=void 0,this._isEnabled=!1,this._isUsingCCD=!1,this._sharedBody=void 0,this._rigidBody=void 0,this.id=TTt.idCounter++}clearState(){Zft.RigidBody_clearState(this.impl)}clearVelocity(){this.setLinearVelocity(Ki.ZERO),this.setAngularVelocity(Ki.ZERO)}clearForces(){Zft.RigidBody_clearForces(this.impl)}initialize(t){this._rigidBody=t,this._sharedBody=Wmt.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0}onEnable(){this._isEnabled=!0,this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.bodyEnabled=!0}onDisable(){this._isEnabled=!1,this._sharedBody.bodyEnabled=!1}onDestroy(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null}wakeUp(t){void 0===t&&(t=!0),Zft.CollisionObject_activate(this.impl,t)}sleep(){const t=Zft.CollisionObject_getActivationState(this.impl);4!==t&&5!==t&&Zft.CollisionObject_forceActivationState(this.impl,2)}setSleepThreshold(t){this._wakeUpIfSleep(),Zft.RigidBody_setSleepingThresholds(this.impl,t,t)}getSleepThreshold(){return Zft.RigidBody_getLinearSleepingThreshold(this.impl)}getLinearVelocity(t){return dmt(t,Zft.RigidBody_getLinearVelocity(this.impl))}setLinearVelocity(t){this._wakeUpIfSleep(),umt(Zft.RigidBody_getLinearVelocity(this.impl),t)}getAngularVelocity(t){return dmt(t,Zft.RigidBody_getAngularVelocity(this.impl))}setAngularVelocity(t){this._wakeUpIfSleep(),umt(Zft.RigidBody_getAngularVelocity(this.impl),t)}applyLocalForce(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();const i=this._sharedBody.node.worldRotation,s=Ki.transformQuat(STt,t,i),r=e?Ki.transformQuat(xTt,e,i):Ki.ZERO;Zft.RigidBody_applyForce(this.impl,umt(smt.instance.BT_V3_0,s),umt(smt.instance.BT_V3_1,r))}applyLocalTorque(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),Ki.transformQuat(STt,t,this._sharedBody.node.worldRotation),Zft.RigidBody_applyTorque(this.impl,umt(smt.instance.BT_V3_0,STt))}applyLocalImpulse(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();const i=this._sharedBody.node.worldRotation,s=Ki.transformQuat(STt,t,i),r=e?Ki.transformQuat(xTt,e,i):Ki.ZERO;Zft.RigidBody_applyImpulse(this.impl,umt(smt.instance.BT_V3_0,s),umt(smt.instance.BT_V3_1,r))}applyForce(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();const i=e||Ki.ZERO;Zft.RigidBody_applyForce(this.impl,umt(smt.instance.BT_V3_0,t),umt(smt.instance.BT_V3_1,i))}applyTorque(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),Zft.RigidBody_applyTorque(this.impl,umt(smt.instance.BT_V3_0,t))}applyImpulse(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();const i=e||Ki.ZERO;Zft.RigidBody_applyImpulse(this.impl,umt(smt.instance.BT_V3_0,t),umt(smt.instance.BT_V3_1,i))}getGroup(){return this._sharedBody.collisionFilterGroup}setGroup(t){this._sharedBody.collisionFilterGroup=t}addGroup(t){this._sharedBody.collisionFilterGroup|=t}removeGroup(t){this._sharedBody.collisionFilterGroup&=~t}getMask(){return this._sharedBody.collisionFilterMask}setMask(t){this._sharedBody.collisionFilterMask=t}addMask(t){this._sharedBody.collisionFilterMask|=t}removeMask(t){this._sharedBody.collisionFilterMask&=~t}_wakeUpIfSleep(){this.isAwake||Zft.CollisionObject_activate(this.impl,!0)}}TTt.idCounter=0;const CTt={syncPhysicsToGraphics(t){Jft.CACHE.getWrapper(t,Jft.BODY_CACHE_NAME).syncPhysicsToGraphics()},onShapeHitExt(t,e){Jft.CACHE.getWrapper(e,Jft.CCT_CACHE_NAME).onShapeHitExt(t)},onDebugDrawLine(t,e,i){const s=Jft.CACHE.world;s&&s.onDebugDrawLine(t,e,i)},clearLines(){const t=Jft.CACHE.world;t&&t.onClearLines()},flushLines(){}},ITt=rmt,ETt=amt;let DTt=0;class ATt{static getSharedBody(t,e,i){const s=t.uuid;let r;if(ATt.sharedBodesMap.has(s))r=ATt.sharedBodesMap.get(s);else{r=new ATt(t,e);const i=1,s=Wmt.instance.collisionMatrix[i];r._collisionFilterGroup=i,r._collisionFilterMask=s,ATt.sharedBodesMap.set(t.uuid,r)}if(i){r._wrappedBody=i;const t=i.rigidBody.group,e=Wmt.instance.collisionMatrix[t];r._collisionFilterGroup=t,r._collisionFilterMask=e}return r}get wrappedBody(){return this._wrappedBody}get bodyCompoundShape(){return this.bodyStruct.compound}get ghostCompoundShape(){return this.ghostStruct.compound}get body(){return this.bodyStruct.body}get ghost(){return this.ghostStruct.ghost}get collisionFilterGroup(){return this._collisionFilterGroup}set collisionFilterGroup(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this.dirty|=1,this.dirty|=2)}get collisionFilterMask(){return this._collisionFilterMask}set collisionFilterMask(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this.dirty|=1,this.dirty|=2)}get bodyStruct(){return this._instantiateBodyStruct(),this._bodyStruct}get ghostStruct(){return this._instantiateGhostStruct(),this._ghostStruct}set bodyEnabled(t){if(t){if(this.bodyIndex<0){if(0===this.bodyStruct.wrappedShapes.length){if(!this.wrappedBody)return;if(!this.wrappedBody.rigidBody.isDynamic)return}this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitialBody()}}else this.bodyIndex>=0&&(0===this.bodyStruct.wrappedShapes.length&&null==this.wrappedBody||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.rigidBody.enabledInHierarchy)&&(Zft.RigidBody_clearState(this.body),this.bodyIndex=-1,this.wrappedWorld.removeSharedBody(this))}set ghostEnabled(t){t?this.ghostIndex<0&&this.ghostStruct.wrappedShapes.length>0&&(this.ghostIndex=1,this.wrappedWorld.addGhostObject(this),this.syncInitialGhost()):this.ghostIndex>=0&&0===this.ghostStruct.wrappedShapes.length&&this.ghost&&(this.ghostIndex=-1,this.wrappedWorld.removeGhostObject(this))}set reference(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}constructor(t,e){this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.wrappedJoints0=[],this.wrappedJoints1=[],this.dirty=0,this._collisionFilterGroup=Wmt.PhysicsGroup.DEFAULT,this._collisionFilterMask=-1,this.ref=0,this.bodyIndex=-1,this.ghostIndex=-1,this._bodyStruct=void 0,this._ghostStruct=void 0,this._wrappedBody=null,this.id=ATt.idCounter++,this.wrappedWorld=e,this.node=t}_instantiateBodyStruct(){if(this._bodyStruct)return;let t=0;this._wrappedBody&&this._wrappedBody.rigidBody.enabled&&this._wrappedBody.rigidBody.isDynamic&&(t=this._wrappedBody.rigidBody.mass);const e=smt.instance.BT_TRANSFORM_0,i=smt.instance.BT_QUAT_0;umt(Zft.Transform_getOrigin(e),this.node.worldPosition),pmt(i,this.node.worldRotation),Zft.Transform_setRotation(e,i);const s=Zft.MotionState.implement(CTt).$$.ptr;Zft.ccMotionState_setup(s,this.id,e);const r=Zft.RigidBody_new(t,s),n=Wmt.instance.sleepThreshold;Zft.RigidBody_setSleepingThresholds(r,n,n),this._bodyStruct={id:DTt++,body:r,motionState:s,compound:Zft.ccCompoundShape_new(),wrappedShapes:[],useCompound:!1},smt.setWrapper(this.id,Jft.BODY_CACHE_NAME,this),this._ghostStruct&&Zft.CollisionObject_setIgnoreCollisionCheck(this.ghost,this.body,!0),this._wrappedBody&&this.setBodyType(this._wrappedBody.rigidBody.type)}_instantiateGhostStruct(){if(this._ghostStruct)return;const t=Zft.CollisionObject_new(),e=Zft.ccCompoundShape_new();Zft.CollisionObject_setCollisionShape(t,e),Zft.CollisionObject_setCollisionFlags(t,5),this._ghostStruct={id:DTt++,ghost:t,compound:e,wrappedShapes:[]},this._bodyStruct&&Zft.CollisionObject_setIgnoreCollisionCheck(this.body,this.ghost,!0),this._wrappedBody&&this.setGhostType(this._wrappedBody.rigidBody.type)}setType(t){this.setBodyType(t),this.setGhostType(t)}setBodyType(t){if(this._bodyStruct&&this._wrappedBody){const e=this._bodyStruct.body,i=this._wrappedBody,s=i.rigidBody;let r=Zft.CollisionObject_getCollisionFlags(e);const n=smt.instance.BT_V3_0;switch(t){case 1:r&=-3,r&=-2,Zft.CollisionObject_setCollisionFlags(e,r),i.setMass(s.mass),i.useGravity(s.useGravity),i.setAllowSleep(s.allowSleep);break;case 4:Zft.Vec3_set(n,0,0,0),Zft.RigidBody_setMassProps(e,0,n),r|=2,r&=-2,Zft.CollisionObject_setCollisionFlags(e,r),Zft.CollisionObject_forceActivationState(e,4);break;default:Zft.Vec3_set(n,0,0,0),Zft.RigidBody_setMassProps(e,0,n),r|=1,r&=-3,Zft.CollisionObject_setCollisionFlags(e,r),Zft.CollisionObject_forceActivationState(e,2)}this.dirty|=1}}setGhostType(t){if(this._ghostStruct){const e=this._ghostStruct.ghost;let i=Zft.CollisionObject_getCollisionFlags(e);switch(t){case 1:case 4:i&=-2,i|=2,Zft.CollisionObject_setCollisionFlags(e,i),Zft.CollisionObject_forceActivationState(e,4);break;default:i&=-3,i|=1,Zft.CollisionObject_setCollisionFlags(e,i),Zft.CollisionObject_forceActivationState(e,2)}this.dirty|=2}}addShape(t,e){function i(t,e){Zft.CollisionObject_setCollisionShape(t.body,e),t.dirty|=1,t._wrappedBody&&t._wrappedBody.isEnabled&&t._wrappedBody.setMass(t._wrappedBody.rigidBody.mass)}if(e)this.ghostStruct.wrappedShapes.indexOf(t)<0&&(this.ghostStruct.wrappedShapes.push(t),t.setCompound(this.ghostCompoundShape),this.ghostEnabled=!0);else if(this.bodyStruct.wrappedShapes.indexOf(t)<0){if(this.bodyStruct.wrappedShapes.push(t),this.bodyStruct.useCompound)t.setCompound(this.bodyCompoundShape);else{const e=this.bodyStruct.wrappedShapes.length;if(1!==e||t.needCompound()){this.bodyStruct.useCompound=!0;for(let t=0;t<e;t++)this.bodyStruct.wrappedShapes[t].setCompound(this.bodyCompoundShape);i(this,this.bodyStruct.compound)}else i(this,t.impl)}this.bodyEnabled=!0}}removeShape(t,e){if(e){const e=this.ghostStruct.wrappedShapes.indexOf(t);e>=0&&(Wt(this.ghostStruct.wrappedShapes,e),t.setCompound(0),this.ghostEnabled=!1)}else{const e=this.bodyStruct.wrappedShapes.indexOf(t);e>=0&&(this.bodyStruct.useCompound?t.setCompound(0):Zft.CollisionObject_setCollisionShape(this.body,Zft.EmptyShape_static()),Zft.CollisionObject_activate(this.body,!0),this.dirty|=1,Wt(this.bodyStruct.wrappedShapes,e),this.bodyEnabled=!1)}}addJoint(t,e){e?this.wrappedJoints1.indexOf(t)<0&&this.wrappedJoints1.push(t):this.wrappedJoints0.indexOf(t)<0&&this.wrappedJoints0.push(t)}removeJoint(t,e){if(e){const e=this.wrappedJoints1.indexOf(t);e>=0&&Wt(this.wrappedJoints1,e)}else{const e=this.wrappedJoints0.indexOf(t);e>=0&&Wt(this.wrappedJoints0,e)}}updateDirty(){this.dirty&&(this.bodyIndex>=0&&1&this.dirty&&this.updateBodyByReAdd(),this.ghostIndex>=0&&2&this.dirty&&this.updateGhostByReAdd(),this.dirty=0)}syncSceneToPhysics(){if(this.node.hasChangedFlags){const t=smt.instance.BT_QUAT_0,e=Zft.CollisionObject_getWorldTransform(this.body);if(pmt(t,this.node.worldRotation),umt(Zft.Transform_getOrigin(e),this.node.worldPosition),Zft.Transform_setRotation(e,t),4&this.node.hasChangedFlags&&this.syncBodyScale(),Zft.CollisionObject_isKinematicObject(this.body)){const t=Zft.RigidBody_getMotionState(this.body);t&&Zft.MotionState_setWorldTransform(t,e)}else this.isBodySleeping()&&Zft.CollisionObject_activate(this.body,!1)}}syncPhysicsToScene(){Zft.CollisionObject_isStaticOrKinematicObject(this.body)||this.syncPhysicsToGraphics()}syncPhysicsToGraphics(){if(this.isBodySleeping())return;const t=smt.instance.BT_QUAT_0,e=smt.instance.BT_TRANSFORM_0;Zft.RigidBody_getWorldTransform(this.body,e);const i=Zft.Transform_getRotationAndOrigin(e,t);if(this.node.worldRotation=_mt(ETt,t),this.node.worldPosition=dmt(ITt,i),this._ghostStruct){const e=Zft.CollisionObject_getWorldTransform(this.ghost);umt(Zft.Transform_getOrigin(e),this.node.worldPosition),pmt(t,this.node.worldRotation),Zft.Transform_setRotation(e,t)}}syncSceneToGhost(){if(this.node.hasChangedFlags){const t=smt.instance.BT_QUAT_0,e=Zft.CollisionObject_getWorldTransform(this.ghost);umt(Zft.Transform_getOrigin(e),this.node.worldPosition),pmt(t,this.node.worldRotation),Zft.Transform_setRotation(e,t),4&this.node.hasChangedFlags&&this.syncGhostScale(),Zft.CollisionObject_activate(this.ghost,!1)}}syncInitialBody(){const t=smt.instance.BT_QUAT_0,e=Zft.CollisionObject_getWorldTransform(this.body);umt(Zft.Transform_getOrigin(e),this.node.worldPosition),pmt(t,this.node.worldRotation),Zft.Transform_setRotation(e,t),this.syncBodyScale(),Zft.CollisionObject_activate(this.body,!1)}syncInitialGhost(){const t=smt.instance.BT_QUAT_0,e=Zft.CollisionObject_getWorldTransform(this.ghost);umt(Zft.Transform_getOrigin(e),this.node.worldPosition),pmt(t,this.node.worldRotation),Zft.Transform_setRotation(e,t),this.syncGhostScale(),Zft.CollisionObject_activate(this.body,!1)}syncBodyScale(){for(let t=0;t<this.bodyStruct.wrappedShapes.length;t++)this.bodyStruct.wrappedShapes[t].updateScale();for(let t=0;t<this.wrappedJoints0.length;t++)this.wrappedJoints0[t].updateScale0();for(let t=0;t<this.wrappedJoints1.length;t++)this.wrappedJoints1[t].updateScale1()}syncGhostScale(){for(let t=0;t<this.ghostStruct.wrappedShapes.length;t++)this.ghostStruct.wrappedShapes[t].updateScale()}updateBodyByReAdd(){this.bodyIndex>=0&&(this.wrappedWorld.removeSharedBody(this),this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this))}updateGhostByReAdd(){this.ghostIndex>=0&&(this.wrappedWorld.removeGhostObject(this),this.ghostIndex=this.wrappedWorld.ghosts.length,this.wrappedWorld.addGhostObject(this))}destroy(){if(ATt.sharedBodesMap.delete(this.node.uuid),this.node=null,this.wrappedWorld=null,this._bodyStruct){const t=this._bodyStruct;smt.delWrapper(this.id,Jft.BODY_CACHE_NAME),Zft._safe_delete(t.motionState,3),Zft._safe_delete(t.compound,5),Zft._safe_delete(t.body,4),this._bodyStruct=null}if(this._ghostStruct){const t=this._ghostStruct;Zft._safe_delete(t.compound,5),Zft._safe_delete(t.ghost,4),this._ghostStruct=null}}isBodySleeping(){return Zft.CollisionObject_isSleeping(this.body)}}ATt.idCounter=0,ATt.sharedBodesMap=new Map;const MTt=rmt,PTt={};class BTt{constructor(){this.id=BTt.idCounter++,this._isEnabled=!1,this._isTrigger=!1,this._isInitialized=!1,this._impl=0,this._compound=0,this.quat=Zft.Quat_new(0,0,0,1),this.transform=Zft.Transform_new(),this._collider=void 0,this._sharedBody=void 0}updateEventListener(){this._sharedBody.wrappedWorld.updateNeedEmitEvents(this.collider.needCollisionEvent||this.collider.needTriggerEvent)}setMaterial(t){const e=null==t?Wmt.instance.defaultMaterial:t;if(!this._isTrigger&&this._isEnabled)if(this._compound){PTt[e._uuid]||(PTt[e._uuid]=Zft.ccMaterial_new());const t=PTt[e._uuid];Zft.ccMaterial_set(t,e.restitution,e.friction,e.rollingFriction,e.spinningFriction),Zft.CollisionShape_setMaterial(this._impl,t)}else Zft.CollisionObject_setMaterial(this._sharedBody.body,e.restitution,e.friction,e.rollingFriction,e.spinningFriction)}setCenter(t){Ki.copy(MTt,t),MTt.multiply(this._collider.node.worldScale),umt(Zft.Transform_getOrigin(this.transform),MTt),this.updateCompoundTransform()}setAsTrigger(t){this._isTrigger!==t&&(this._isEnabled&&(this._sharedBody.removeShape(this,!t),this._sharedBody.addShape(this,t)),this._isTrigger=t)}get attachedRigidBody(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}get impl(){return this._impl}get collider(){return this._collider}get sharedBody(){return this._sharedBody}getAABB(t){const e=smt.instance.BT_TRANSFORM_0;Zft.Transform_setIdentity(e),Zft.Transform_setRotation(e,pmt(smt.instance.BT_QUAT_0,this._collider.node.worldRotation));const i=smt.instance.BT_V3_0,s=smt.instance.BT_V3_1;Zft.CollisionShape_getAabb(this._impl,e,i,s),t.halfExtents.x=(Zft.Vec3_x(s)-Zft.Vec3_x(i))/2,t.halfExtents.y=(Zft.Vec3_y(s)-Zft.Vec3_y(i))/2,t.halfExtents.z=(Zft.Vec3_z(s)-Zft.Vec3_z(i))/2,Ki.add(t.center,this._collider.node.worldPosition,this._collider.center)}getBoundingSphere(t){t.radius=Zft.CollisionShape_getLocalBoundingSphere(this._impl),Ki.add(t.center,this._collider.node.worldPosition,this._collider.center)}initialize(t){this._collider=t,this._isInitialized=!0,this._sharedBody=Wmt.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),this.setWrapper()}setWrapper(){smt.isNotEmptyShape(this._impl)&&(Zft.CollisionShape_setUserPointer(this._impl,this._impl),smt.setWrapper(this._impl,BTt.TYPE,this))}onLoad(){this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)}onEnable(){this._isEnabled=!0,this._sharedBody.addShape(this,this._isTrigger),this.setMaterial(this.collider.sharedMaterial)}onDisable(){this._isEnabled=!1,this._sharedBody.removeShape(this,this._isTrigger)}onDestroy(){this._sharedBody.reference=!1,this._collider=null,Zft._safe_delete(this.quat,1),Zft._safe_delete(this.transform,2),this._compound&&Zft._safe_delete(this._compound,5),smt.isNotEmptyShape(this._impl)&&(Zft._safe_delete(this._impl,5),smt.delWrapper(this._impl,BTt.TYPE))}updateByReAdd(){this._isEnabled&&(this._sharedBody.removeShape(this,this._isTrigger),this._sharedBody.addShape(this,this._isTrigger))}getGroup(){return this._sharedBody.collisionFilterGroup}setGroup(t){this._sharedBody.collisionFilterGroup=t}addGroup(t){this._sharedBody.collisionFilterGroup|=t}removeGroup(t){this._sharedBody.collisionFilterGroup&=~t}getMask(){return this._sharedBody.collisionFilterMask}setMask(t){this._sharedBody.collisionFilterMask=t}addMask(t){this._sharedBody.collisionFilterMask|=t}removeMask(t){this._sharedBody.collisionFilterMask&=~t}setCompound(t){this._compound&&Zft.CompoundShape_removeChildShape(this._compound,this._impl),t&&Zft.CompoundShape_addChildShape(t,this.transform,this._impl),this._compound=t}updateScale(){this.setCenter(this._collider.center)}updateCompoundTransform(){this._compound?Zft.CompoundShape_updateChildTransform(this._compound,this._impl,this.transform,!0):this._isEnabled&&!this._isTrigger&&this._sharedBody&&!this._sharedBody.bodyStruct.useCompound&&(this._sharedBody.dirty|=1)}needCompound(){return 8===this._collider.type||!this._collider.center.equals(Ki.ZERO)}}BTt.TYPE="shape",BTt.idCounter=0;class RTt{constructor(){this.matrix=[]}get(t,e){if(e>t){const i=e;e=t,t=i}return this.matrix[(t*(t+1)>>1)+e-1]}set(t,e,i){if(e>t){const i=e;e=t,t=i}this.matrix[(t*(t+1)>>1)+e-1]=i?1:0}reset(){this.matrix.length=0}setNumObjects(t){this.matrix.length=t*(t-1)>>1}}class OTt{constructor(){this.data=void 0,this.data={keys:[]}}get(t,e){if(t>e){const i=e;e=t,t=i}return this.data[`${t}-${e}`]}set(t,e,i){if(t>e){const i=e;e=t,t=i}const s=`${t}-${e}`;if(null==i){const t=this.data.keys.indexOf(s);if(-1!==t)return this.data.keys.splice(t,1),delete this.data[s],i}return this.get(t,e)||this.data.keys.push(s),this.data[s]=i,this.data[s]}reset(){this.data={keys:[]}}getLength(){return this.data.keys.length}getKeyByIndex(t){return this.data.keys[t]}getDataByKey(t){return this.data[t]}}class LTt{get isBodyA(){return this.event.selfCollider.shape.sharedBody.body===Zft.PersistentManifold_getBody0(this.event.impl)}constructor(t){this.impl=0,this.event=void 0,this.event=t}getLocalPointOnA(t){this.impl&&dmt(t,Zft.ManifoldPoint_get_m_localPointA(this.impl))}getLocalPointOnB(t){this.impl&&dmt(t,Zft.ManifoldPoint_get_m_localPointB(this.impl))}getWorldPointOnA(t){this.impl&&dmt(t,Zft.ManifoldPoint_get_m_positionWorldOnA(this.impl))}getWorldPointOnB(t){this.impl&&dmt(t,Zft.ManifoldPoint_get_m_positionWorldOnB(this.impl))}getLocalNormalOnA(t){if(this.impl){const e=smt.instance.BT_QUAT_0,i=Zft.PersistentManifold_getBody0(this.event.impl),s=Zft.CollisionObject_getWorldTransform(i);Zft.Transform_getRotation(s,e);const r=amt;_mt(r,e),ys.conjugate(r,r),dmt(t,Zft.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||Ki.negate(t,t),Ki.transformQuat(t,t,r)}}getLocalNormalOnB(t){if(this.impl){const e=smt.instance.BT_QUAT_0,i=Zft.PersistentManifold_getBody1(this.event.impl),s=Zft.CollisionObject_getWorldTransform(i);Zft.Transform_getRotation(s,e);const r=amt;_mt(r,e),ys.conjugate(r,r),dmt(t,Zft.ManifoldPoint_get_m_normalWorldOnB(this.impl)),Ki.transformQuat(t,t,r)}}getWorldNormalOnA(t){this.impl&&(dmt(t,Zft.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||Ki.negate(t,t))}getWorldNormalOnB(t){this.impl&&dmt(t,Zft.ManifoldPoint_get_m_normalWorldOnB(this.impl))}}const FTt=[],zTt=rmt,kTt=nmt,NTt=omt,UTt=cmt,VTt=new bTt;class HTt{setDefaultMaterial(t){}setAllowSleep(t){Zft.ccDiscreteDynamicsWorld_setAllowSleep(this._world,t)}setGravity(t){Zft.DynamicsWorld_setGravity(this._world,umt(smt.instance.BT_V3_0,t))}updateNeedEmitEvents(t){if(this.ghosts)if(t)this._needEmitEvents=!0;else{this._needEmitEvents=!1;for(let t=0;t<this.ghosts.length;t++){const e=this.ghosts[t].ghostStruct.wrappedShapes;for(let t=0;t<e.length;t++){const i=e[t].collider;if(i.needCollisionEvent||i.needTriggerEvent)return void(this._needEmitEvents=!0)}}for(let t=0;t<this.bodies.length;t++){const e=this.bodies[t].bodyStruct.wrappedShapes;for(let t=0;t<e.length;t++){const i=e[t].collider;if(i.needCollisionEvent||i.needTriggerEvent)return void(this._needEmitEvents=!0)}}}}updateNeedEmitCCTEvents(t){if(this.ccts)if(t)this._needEmitCCTEvents=!0;else{this._needEmitCCTEvents=!1;const t=this.ccts,e=t.length;for(let i=0;i<e;i++)if(t[i].characterController.needCollisionEvent)return void(this._needEmitCCTEvents=!0)}}get impl(){return this._world}constructor(){this._world=void 0,this._broadphase=void 0,this._solver=void 0,this._dispatcher=void 0,this._debugDraw=void 0,this._debugLineCount=0,this._MAX_DEBUG_LINE_COUNT=16384,this._debugDrawFlags=0,this._debugConstraintSize=.3,this._needEmitEvents=!1,this._needSyncAfterEvents=!1,this._needEmitCCTEvents=!1,this.bodies=[],this.ghosts=[],this.ccts=[],this.constraints=[],this.triggerArrayMat=new RTt,this.characterControllerArrayMat=new RTt,this.collisionArrayMat=new RTt,this.contactsDic=new OTt,this.oldContactsDic=new OTt,this.cctShapeEventDic=new OTt,this.cctContactsDic=new OTt,this.cctOldContactsDic=new OTt,Jft.CACHE.world=this,this._broadphase=Zft.DbvtBroadphase_new(),this._dispatcher=Zft.CollisionDispatcher_new(),this._solver=Zft.SequentialImpulseConstraintSolver_new(),this._world=Zft.ccDiscreteDynamicsWorld_new(this._dispatcher,this._broadphase,this._solver);const t=Zft.DebugDraw.implement(CTt);this._debugDraw=t.$$.ptr,Zft.CollisionWorld_setDebugDrawer(this._world,this._debugDraw),Zft.DebugDraw_setDebugMode(this._debugDraw,0),Zft.DebugDraw_setAABBColor(this._debugDraw,0,1,1),Zft.DebugDraw_setActiveObjectColor(this._debugDraw,1,0,1),Zft.DebugDraw_setDeactiveObjectColor(this._debugDraw,1,0,1),Zft.DebugDraw_setWantsDeactivationObjectColor(this._debugDraw,1,0,1),Zft.DebugDraw_setDisabledDeactivationObjectColor(this._debugDraw,1,0,1),Zft.DebugDraw_setDisabledSimulationObjectColor(this._debugDraw,1,0,1),Zft.DebugDraw_setConstraintLimitColor(this._debugDraw,.5,.5,.5)}destroy(){(this.constraints.length||this.bodies.length||this.ccts.length)&&B("You should destroy all physics component first."),Zft._safe_delete(this._world,12),Zft._safe_delete(this._broadphase,10),Zft._safe_delete(this._dispatcher,9),Zft._safe_delete(this._solver,11),Zft._safe_delete(this._debugDraw,14),this.bodies=null,this.ghosts=null,this.ccts=null,this.constraints=null,this.triggerArrayMat=null,this.characterControllerArrayMat=null,this.collisionArrayMat=null,this.contactsDic=null,this.oldContactsDic=null,this.cctShapeEventDic=null,this.cctShapeEventPool=null,FTt.length=0}step(t,e,i){void 0===i&&(i=0),(this.bodies.length||this.ghosts.length)&&(void 0===e&&(e=t),Zft.DynamicsWorld_stepSimulation(this._world,e,i,t),Zft.CollisionWorld_debugDrawWorld(this._world))}syncSceneToPhysics(){for(let t=this.ghosts.length-1;t>=0;t--){const e=this.ghosts[t];e.updateDirty(),e.syncSceneToGhost()}for(let t=this.bodies.length-1;t>=0;t--){const e=this.bodies[t];e.updateDirty(),e.syncSceneToPhysics()}const t=this.ccts;for(let e=t.length-1;e>=0;e--){const i=t[e];i.updateDirty(),i.syncSceneToPhysics()}}syncAfterEvents(){this._needSyncAfterEvents&&this.syncSceneToPhysics()}raycast(t,e,i,s){t.computeHit(zTt,e.maxDistance);const r=umt(smt.instance.BT_V3_0,zTt),n=umt(smt.instance.BT_V3_1,t.o),o=Zft.ccAllRayCallback_static();if(Zft.ccAllRayCallback_reset(o,n,r,e.mask>>>0,e.queryTrigger),Zft.ccAllRayCallback_setFlags(o,4),Zft.CollisionWorld_rayTest(this._world,n,r,o),Zft.RayCallback_hasHit(o)){const e=Zft.ccAllRayCallback_getHitPointWorld(o),r=Zft.ccAllRayCallback_getHitNormalWorld(o),n=Zft.ccAllRayCallback_getCollisionShapePtrs(o),a=Zft.ccAllRayCallback_getClosestHitFraction(o);for(let o=0,h=Zft.int_array_size(n);o<h;o++){dmt(zTt,Zft.Vec3_array_at(e,o)),dmt(kTt,Zft.Vec3_array_at(r,o));const h=smt.getWrapper(Zft.int_array_at(n,o),BTt.TYPE),l=i.add();s.push(l),l._assign(zTt,Ki.distance(t.o,zTt),h.collider,kTt,a)}return!0}return!1}raycastClosest(t,e,i){t.computeHit(zTt,e.maxDistance);const s=umt(smt.instance.BT_V3_0,zTt),r=umt(smt.instance.BT_V3_1,t.o),n=Zft.ccClosestRayCallback_static();if(Zft.ccClosestRayCallback_reset(n,r,s,e.mask>>>0,e.queryTrigger),Zft.ccClosestRayCallback_setFlags(n,4),Zft.CollisionWorld_rayTest(this._world,r,s,n),Zft.RayCallback_hasHit(n)){dmt(zTt,Zft.ccClosestRayCallback_getHitPointWorld(n)),dmt(kTt,Zft.ccClosestRayCallback_getHitNormalWorld(n));const e=smt.getWrapper(Zft.ccClosestRayCallback_getCollisionShapePtr(n),BTt.TYPE),s=Zft.ccClosestConvexCallback_getClosestHitFraction(n);return i._assign(zTt,Ki.distance(t.o,zTt),e.collider,kTt,s),!0}return!1}sweepBox(t,e,i,s,r,n){const o=smt.instance.BT_V3_0;return umt(o,e),HTt._sweepBoxGeometry||(HTt._sweepBoxGeometry=Zft.BoxShape_new(o)),Zft.BoxShape_setUnscaledHalfExtents(HTt._sweepBoxGeometry,o),this.sweep(t,HTt._sweepBoxGeometry,i,s,r,n)}sweepBoxClosest(t,e,i,s,r){const n=smt.instance.BT_V3_0;return umt(n,e),HTt._sweepBoxGeometry||(HTt._sweepBoxGeometry=Zft.BoxShape_new(n)),Zft.BoxShape_setUnscaledHalfExtents(HTt._sweepBoxGeometry,n),this.sweepClosest(t,HTt._sweepBoxGeometry,i,s,r)}sweepSphere(t,e,i,s,r){return HTt._sweepSphereGeometry||(HTt._sweepSphereGeometry=Zft.SphereShape_new(e)),Zft.SphereShape_setUnscaledRadius(HTt._sweepSphereGeometry,e),this.sweep(t,HTt._sweepSphereGeometry,ys.IDENTITY,i,s,r)}sweepSphereClosest(t,e,i,s){return HTt._sweepSphereGeometry||(HTt._sweepSphereGeometry=Zft.SphereShape_new(e)),Zft.SphereShape_setUnscaledRadius(HTt._sweepSphereGeometry,e),this.sweepClosest(t,HTt._sweepSphereGeometry,ys.IDENTITY,i,s)}sweepCapsule(t,e,i,s,r,n,o){return HTt._sweepCapsuleGeometry||(HTt._sweepCapsuleGeometry=Zft.CapsuleShape_new(e,i)),Zft.CapsuleShape_updateProp(HTt._sweepCapsuleGeometry,e,.5*i,1),this.sweep(t,HTt._sweepCapsuleGeometry,s,r,n,o)}sweepCapsuleClosest(t,e,i,s,r,n){return HTt._sweepCapsuleGeometry||(HTt._sweepCapsuleGeometry=Zft.CapsuleShape_new(e,i)),Zft.CapsuleShape_updateProp(HTt._sweepCapsuleGeometry,e,.5*i,1),this.sweepClosest(t,HTt._sweepCapsuleGeometry,s,r,n)}sweep(t,e,i,s,r,n){const o=smt.instance.BT_TRANSFORM_0,a=smt.instance.BT_TRANSFORM_1,h=smt.instance.BT_QUAT_0;umt(Zft.Transform_getOrigin(o),t.o),pmt(h,i),Zft.Transform_setRotation(o,h),t.computeHit(zTt,s.maxDistance),umt(Zft.Transform_getOrigin(a),zTt),pmt(h,i),Zft.Transform_setRotation(a,h);const l=Zft.ccAllConvexCallback_static();if(Zft.ccAllConvexCallback_reset(l,o,a,s.mask>>>0,s.queryTrigger),Zft.CollisionWorld_convexSweepTest(this._world,e,o,a,l,0),Zft.ConvexCallback_hasHit(l)){const e=Zft.ccAllConvexCallback_getHitPointWorld(l),i=Zft.ccAllConvexCallback_getHitNormalWorld(l),s=Zft.ccAllConvexCallback_getCollisionShapePtrs(l),o=Zft.ccAllConvexCallback_getClosestHitFraction(l);for(let a=0,h=Zft.int_array_size(s);a<h;a++){dmt(zTt,Zft.Vec3_array_at(e,a)),dmt(kTt,Zft.Vec3_array_at(i,a));const h=smt.getWrapper(Zft.int_array_at(s,a),BTt.TYPE),l=r.add();n.push(l),l._assign(zTt,Ki.distance(t.o,zTt),h.collider,kTt,o)}return!0}return!1}sweepClosest(t,e,i,s,r){const n=smt.instance.BT_TRANSFORM_0,o=smt.instance.BT_TRANSFORM_1,a=smt.instance.BT_QUAT_0;umt(Zft.Transform_getOrigin(n),t.o),pmt(a,i),Zft.Transform_setRotation(n,a),t.computeHit(zTt,s.maxDistance),umt(Zft.Transform_getOrigin(o),zTt),pmt(a,i),Zft.Transform_setRotation(o,a);const h=Zft.ccClosestConvexCallback_static();if(Zft.ccClosestConvexCallback_reset(h,n,o,s.mask>>>0,s.queryTrigger),Zft.CollisionWorld_convexSweepTest(this._world,e,n,o,h,0),Zft.ConvexCallback_hasHit(h)){dmt(zTt,Zft.ccClosestConvexCallback_getHitPointWorld(h)),dmt(kTt,Zft.ccClosestConvexCallback_getHitNormalWorld(h));const e=smt.getWrapper(Zft.ccClosestConvexCallback_getCollisionShapePtr(h),BTt.TYPE),i=Zft.ccClosestConvexCallback_getClosestHitFraction(h);return r._assign(zTt,Ki.distance(t.o,zTt),e.collider,kTt,i),!0}return!1}getSharedBody(t,e){return ATt.getSharedBody(t,this,e)}addSharedBody(t){if(this.bodies.indexOf(t)<0){this.bodies.push(t);const e=t.collisionFilterGroup,i=t.collisionFilterMask;Zft.DynamicsWorld_addRigidBody(this._world,t.body,e>>>0,i>>>0)}}removeSharedBody(t){const e=this.bodies.indexOf(t);e>=0&&(Wt(this.bodies,e),Zft.DynamicsWorld_removeRigidBody(this._world,t.body))}addGhostObject(t){if(this.ghosts.indexOf(t)<0){this.ghosts.push(t);const e=t.collisionFilterGroup,i=t.collisionFilterMask;Zft.CollisionWorld_addCollisionObject(this._world,t.ghost,e>>>0,i>>>0)}}removeGhostObject(t){const e=this.ghosts.indexOf(t);e>=0&&(Wt(this.ghosts,e),Zft.CollisionWorld_removeCollisionObject(this._world,t.ghost))}addCCT(t){if(this.ccts.indexOf(t)<0){this.ccts.push(t);const e=Zft.CharacterController_getGhostObject(t.impl),i=t.getGroup(),s=t.getMask();Zft.CollisionWorld_addCollisionObject(this._world,e,i>>>0,s>>>0),Zft.DynamicsWorld_addAction(this._world,t.impl)}}removeCCT(t){const e=this.ccts.indexOf(t);if(e>=0){Wt(this.ccts,e);const i=Zft.CharacterController_getGhostObject(t.impl);Zft.CollisionWorld_removeCollisionObject(this._world,i),Zft.DynamicsWorld_removeAction(this._world,t.impl)}}addConstraint(t){const e=this.constraints.indexOf(t);e<0&&(this.constraints.push(t),Zft.DynamicsWorld_addConstraint(this.impl,t.impl,!t.constraint.enableCollision),t.index=e)}removeConstraint(t){const e=this.constraints.indexOf(t);e>=0&&(this.constraints.splice(e,1),Zft.DynamicsWorld_removeConstraint(this.impl,t.impl),t.index=-1)}emitEvents(){this._needSyncAfterEvents=!1,this._needEmitEvents&&(this.gatherConatactData(),this.emitCollisionAndTriggerEvent(),this.emitCCTTriggerEvent()),this._needEmitCCTEvents&&this.emitCCTCollisionEvent()}emitCollisionAndTriggerEvent(){let t=this.contactsDic.getLength();for(;t--;){FTt.push.apply(FTt,emt.contacts),emt.contacts.length=0;const e=this.contactsDic.getKeyByIndex(t),i=this.contactsDic.getDataByKey(e),s=i.shape0,r=i.shape1;this.oldContactsDic.set(s.id,r.id,i);const n=s.collider,o=r.collider;if(n&&o){if(n.isTrigger||o.isTrigger)this.triggerArrayMat.get(s.id,r.id)?tmt.type="onTriggerStay":(tmt.type="onTriggerEnter",this.triggerArrayMat.set(s.id,r.id,!0)),tmt.impl=i.impl,tmt.selfCollider=n,tmt.otherCollider=o,n.emit(tmt.type,tmt),tmt.selfCollider=o,tmt.otherCollider=n,o.emit(tmt.type,tmt),this._needSyncAfterEvents=!0;else{const t=n.attachedRigidBody,e=o.attachedRigidBody;if(t&&e){if(t.isSleeping&&e.isSleeping)continue}else if(!t&&e){if(e.isSleeping)continue}else if(!e&&t&&t.isSleeping)continue;this.collisionArrayMat.get(s.id,r.id)?emt.type="onCollisionStay":(emt.type="onCollisionEnter",this.collisionArrayMat.set(s.id,r.id,!0));for(let t=0;t<i.contacts.length;t++){const e=i.contacts[t];if(FTt.length>0){const t=FTt.pop();t.impl=e,emt.contacts.push(t)}else{const t=new LTt(emt);t.impl=e,emt.contacts.push(t)}}emt.impl=i.impl,emt.selfCollider=n,emt.otherCollider=o,n.emit(emt.type,emt),emt.selfCollider=o,emt.otherCollider=n,o.emit(emt.type,emt),this._needSyncAfterEvents=!0}null==this.oldContactsDic.get(s.id,r.id)&&this.oldContactsDic.set(s.id,r.id,i)}}let e=this.oldContactsDic.getLength();for(;e--;){const t=this.oldContactsDic.getKeyByIndex(e),i=this.oldContactsDic.getDataByKey(t),s=i.shape0,r=i.shape1,n=s.collider,o=r.collider;if(n&&o){const e=n.isTrigger||o.isTrigger;null==this.contactsDic.getDataByKey(t)&&(e?this.triggerArrayMat.get(s.id,r.id)&&(tmt.type="onTriggerExit",tmt.selfCollider=n,tmt.otherCollider=o,n.emit(tmt.type,tmt),tmt.selfCollider=o,tmt.otherCollider=n,o.emit(tmt.type,tmt),this.triggerArrayMat.set(s.id,r.id,!1),this.oldContactsDic.set(s.id,r.id,null),this._needSyncAfterEvents=!0):this.collisionArrayMat.get(s.id,r.id)&&(FTt.push.apply(FTt,emt.contacts),emt.contacts.length=0,emt.type="onCollisionExit",emt.selfCollider=n,emt.otherCollider=o,n.emit(emt.type,emt),emt.selfCollider=o,emt.otherCollider=n,o.emit(emt.type,emt),this.collisionArrayMat.set(s.id,r.id,!1),this.oldContactsDic.set(s.id,r.id,null),this._needSyncAfterEvents=!0))}}this.contactsDic.reset()}emitCCTTriggerEvent(){let t=this.cctContactsDic.getLength();for(;t--;){const e=this.cctContactsDic.getKeyByIndex(t),i=this.cctContactsDic.getDataByKey(e),s=i.shape,r=i.cct;this.cctOldContactsDic.set(s.id,r.id,i);const n=s.collider,o=r.characterController;n&&o&&(n.isTrigger&&(this.characterControllerArrayMat.get(s.id,r.id)?imt.type="onControllerTriggerStay":(imt.type="onControllerTriggerEnter",this.characterControllerArrayMat.set(s.id,r.id,!0)),imt.impl=i.impl,imt.collider=n,imt.characterController=o,n.emit(imt.type,imt),imt.collider=n,imt.characterController=o,o.emit(imt.type,imt),this._needSyncAfterEvents=!0),null==this.cctOldContactsDic.get(s.id,r.id)&&this.cctOldContactsDic.set(s.id,r.id,i))}let e=this.cctOldContactsDic.getLength();for(;e--;){const t=this.cctOldContactsDic.getKeyByIndex(e),i=this.cctOldContactsDic.getDataByKey(t),s=i.shape,r=i.cct,n=s.collider,o=r.characterController;if(n&&o){const e=n.isTrigger;null==this.cctContactsDic.getDataByKey(t)&&e&&this.characterControllerArrayMat.get(s.id,r.id)&&(imt.type="onControllerTriggerExit",imt.collider=n,imt.characterController=o,n.emit(imt.type,imt),imt.collider=n,imt.characterController=o,o.emit(imt.type,imt),this.characterControllerArrayMat.set(s.id,r.id,!1),this.cctOldContactsDic.set(s.id,r.id,null),this._needSyncAfterEvents=!0)}}this.cctContactsDic.reset()}emitCCTCollisionEvent(){let t=this.cctShapeEventDic.getLength();for(;t--;){var e;const i=this.cctShapeEventDic.getKeyByIndex(t),s=this.cctShapeEventDic.getDataByKey(i),r=s.BulletCharacterController,n=s.BulletShape,o=s.worldPos,a=s.worldNormal,h=s.motionDir,l=s.motionLength;VTt.controller=r.characterController,VTt.collider=n.collider,VTt.worldPosition.set(o.x,o.y,o.z),VTt.worldNormal.set(a.x,a.y,a.z),VTt.motionDirection.set(h.x,h.y,h.z),VTt.motionLength=l,null===(e=VTt.controller)||void 0===e||e.emit("onControllerColliderHit",VTt),this._needSyncAfterEvents=!0}this.cctShapeEventDic.reset()}gatherConatactData(){const t=Zft.Dispatcher_getNumManifolds(this._dispatcher);for(let e=0;e<t;e++){const t=Zft.Dispatcher_getManifoldByIndexInternal(this._dispatcher,e),i=Zft.PersistentManifold_getNumContacts(t);for(let e=0;e<i;e++){const i=Zft.PersistentManifold_getContactPoint(t,e),s=Zft.ManifoldPoint_getShape0(i),r=Zft.ManifoldPoint_getShape1(i);let n=!1;if(!n){const e=smt.getWrapper(s,BTt.TYPE),o=smt.getWrapper(r,BTt.TYPE);if(e&&o&&(n=!0,e.collider.needTriggerEvent||o.collider.needTriggerEvent||e.collider.needCollisionEvent||o.collider.needCollisionEvent)){let s=this.contactsDic.get(e.id,o.id);s||(s=this.contactsDic.set(e.id,o.id,{shape0:e,shape1:o,contacts:[],impl:t})),s.contacts.push(i)}}if(!n){const e=smt.getWrapper(s,BTt.TYPE),o=smt.getWrapper(r,Jft.CCT_CACHE_NAME);if(e&&o&&(n=!0,e.collider.needTriggerEvent)){let s=this.cctContactsDic.get(e.id,o.id);s||(s=this.cctContactsDic.set(e.id,o.id,{shape:e,cct:o,contacts:[],impl:t})),s.contacts.push(i),n=!0}}if(!n){const e=smt.getWrapper(s,Jft.CCT_CACHE_NAME),o=smt.getWrapper(r,BTt.TYPE);if(o&&e&&(n=!0,o.collider.needTriggerEvent)){let s=this.cctContactsDic.get(o.id,e.id);s||(s=this.cctContactsDic.set(o.id,e.id,{shape:o,cct:e,contacts:[],impl:t})),s.contacts.push(i),n=!0}}}}}get debugDrawFlags(){return this._debugDrawFlags}set debugDrawFlags(t){this._debugDrawFlags=t,this._debugDraw&&this._setDebugDrawMode()}get debugDrawConstraintSize(){return this._debugConstraintSize}set debugDrawConstraintSize(t){this._debugConstraintSize=t;for(let t=0;t<this.constraints.length;t++)this.constraints[t].updateDebugDrawSize()}_setDebugDrawMode(){let t=0;1&this._debugDrawFlags&&(t|=1),2&this._debugDrawFlags&&(t|=2048,t|=4096),4&this._debugDrawFlags&&(t|=2),Zft.DebugDraw_setDebugMode(this._debugDraw,t)}_getDebugRenderer(){var t;const e=null===(t=uP.root.mainWindow)||void 0===t?void 0:t.cameras;return e?0===e.length?null:e[0]?(e[0].initGeometryRenderer(),e[0].geometryRenderer):null:null}onDebugDrawLine(t,e,i){const s=this._getDebugRenderer();s&&this._debugLineCount<this._MAX_DEBUG_LINE_COUNT&&(this._debugLineCount++,dmt(zTt,t),dmt(kTt,e),dmt(NTt,i),UTt.set(255*NTt.x,255*NTt.y,255*NTt.z,255),s.addLine(zTt,kTt,UTt))}onClearLines(){this._debugLineCount=0}}HTt._sweepBoxGeometry=void 0,HTt._sweepSphereGeometry=void 0,HTt._sweepCapsuleGeometry=void 0;class GTt extends BTt{updateSize(){const t=smt.instance.BT_V3_0;umt(t,this.getMinUnscaledHalfExtents(NX)),Zft.BoxShape_setUnscaledHalfExtents(this.impl,t),this.updateCompoundTransform()}get collider(){return this._collider}onComponentSet(){const t=smt.instance.BT_V3_0;umt(t,this.getMinUnscaledHalfExtents(NX)),this._impl=Zft.BoxShape_new(t),this.updateScale()}updateScale(){super.updateScale();const t=smt.instance.BT_V3_0;Zft.CollisionShape_setLocalScaling(this._impl,umt(t,this.getMinScale(NX))),this.updateCompoundTransform()}getMinUnscaledHalfExtents(t){const e=this.collider.size,i=UX(NX.set(this._collider.node.worldScale)),s=Wmt.instance.minVolumeSize,r=e.x/2,n=e.y/2,o=e.z/2,a=r*i.x<s?s/i.x:r,h=n*i.y<s?s/i.y:n,l=o*i.z<s?s/i.z:o;return t.set(a,h,l),t}getMinScale(t){const e=this.collider.size,i=UX(NX.set(this._collider.node.worldScale)),s=Wmt.instance.minVolumeSize,r=e.x/2,n=e.y/2,o=e.z/2,a=r*i.x<s?s/r:i.x,h=n*i.y<s?s/n:i.y,l=o*i.z<s?s/o:i.z;return t.set(a,h,l),t}}class WTt extends BTt{updateRadius(){Zft.SphereShape_setUnscaledRadius(this.impl,this.getMinUnscaledRadius()),this.updateCompoundTransform()}get collider(){return this._collider}onComponentSet(){this._impl=Zft.SphereShape_new(this.getMinUnscaledRadius()),this.updateScale()}updateScale(){super.updateScale();const t=this.getMinScale();rmt.set(t,t,t);const e=smt.instance.BT_V3_0;Zft.CollisionShape_setLocalScaling(this._impl,umt(e,rmt)),this.updateCompoundTransform()}getMinUnscaledRadius(){const t=this.collider.radius,e=Math.abs(Bi(this._collider.node.worldScale)),i=Wmt.instance.minVolumeSize;return e*t<i?i/e:t}getMinScale(){const t=this.collider.radius,e=Math.abs(Bi(this._collider.node.worldScale)),i=Wmt.instance.minVolumeSize;return e*t<i?i/t:e}}class jTt extends BTt{setCylinderHeight(t){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)}setDirection(t){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)}setRadius(t){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)}get collider(){return this._collider}onComponentSet(){this._impl=Zft.CapsuleShape_new(.5,1),this.setRadius(this.collider.radius)}updateScale(){super.updateScale(),this.setRadius(this.collider.radius)}updateProperties(t,e,i,s){const r=s,n=i;let o,a;1===n?(o=t*Math.abs(Ri(r.x,r.z)),a=e/2*Math.abs(r.y)):0===n?(o=t*Math.abs(Ri(r.y,r.z)),a=e/2*Math.abs(r.x)):(o=t*Math.abs(Ri(r.x,r.y)),a=e/2*Math.abs(r.z)),Zft.CapsuleShape_updateProp(this._impl,o,a,n),this.updateCompoundTransform()}}class $Tt{static getBulletBvhTriangleMeshShape(t,e){let i;return $Tt.BulletBvhTriangleMeshShapeMap.has(t)?(i=$Tt.BulletBvhTriangleMeshShapeMap.get(t),i.reference=!0):(i=new $Tt(t,e),$Tt.BulletBvhTriangleMeshShapeMap.set(t,i)),i}set reference(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}constructor(t,e){this.key=void 0,this.ref=0,this.bulletBvhTriangleMeshShapePtr=void 0,this.btTriangleMeshPtr=0,this.reference=!0,this.key=t,this.btTriangleMeshPtr=Zft.TriangleMesh_new(),gmt(this.btTriangleMeshPtr,e),this.bulletBvhTriangleMeshShapePtr=Zft.BvhTriangleMeshShape_new(this.btTriangleMeshPtr,!0,!0)}destroy(){this.bulletBvhTriangleMeshShapePtr&&Zft._safe_delete(this.bulletBvhTriangleMeshShapePtr,5),this.btTriangleMeshPtr&&Zft._safe_delete(this.btTriangleMeshPtr,8),$Tt.BulletBvhTriangleMeshShapeMap.delete(this.key)}}$Tt.BulletBvhTriangleMeshShapeMap=new Map;class qTt extends BTt{constructor(){super(...arguments),this.btBVHMeshShape=void 0,this.refBtTriangleMesh=0}get collider(){return this._collider}setMesh(t){if(!this._isInitialized)return;this._impl&&smt.isNotEmptyShape(this._impl)&&(this._compound&&Zft.CompoundShape_removeChildShape(this._compound,this._impl),Zft._safe_delete(this._impl,5),smt.delWrapper(this._impl,BTt.TYPE),this._impl=0);const e=t;if(e&&e.renderingSubMeshes.length>0){if(this.collider.convex){const t=this._getBtTriangleMesh(e);this._impl=Zft.ConvexTriangleMeshShape_new(t)}else this.btBVHMeshShape=$Tt.getBulletBvhTriangleMeshShape(e.hash,e),this._impl=Zft.ScaledBvhTriangleMeshShape_new(this.btBVHMeshShape.bulletBvhTriangleMeshShapePtr,1,1,1);const t=smt.instance.BT_V3_0;umt(t,this._collider.node.worldScale),Zft.CollisionShape_setLocalScaling(this._impl,t),Zft.CollisionShape_setMargin(this._impl,.01),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=Zft.EmptyShape_static()}onComponentSet(){this.setMesh(this.collider.mesh)}onDestroy(){this.collider.convex?this.refBtTriangleMesh&&Zft._safe_delete(this.refBtTriangleMesh,8):this.btBVHMeshShape&&(this.btBVHMeshShape.reference=!1),super.onDestroy()}updateScale(){super.updateScale();const t=smt.instance.BT_V3_0;umt(t,this._collider.node.worldScale),Zft.CollisionShape_setLocalScaling(this._impl,t),this.updateCompoundTransform()}_getBtTriangleMesh(t){return this.refBtTriangleMesh=Zft.TriangleMesh_new(),gmt(this.refBtTriangleMesh,t),this.refBtTriangleMesh}}class XTt extends BTt{setHeight(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}setDirection(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}setRadius(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}get collider(){return this._collider}onComponentSet(){const t=smt.instance.BT_V3_0;Zft.Vec3_set(t,.5,1,.5),this._impl=Zft.CylinderShape_new(t),this.setRadius(this.collider.radius)}updateScale(){super.updateScale(),this.setRadius(this.collider.radius)}updateProperties(t,e,i,s){const r=s,n=i;let o,a;1===n?(a=e*Math.abs(r.y),o=t*Math.abs(Ri(r.x,r.z))):0===n?(a=e*Math.abs(r.x),o=t*Math.abs(Ri(r.y,r.z))):(a=e*Math.abs(r.z),o=t*Math.abs(Ri(r.x,r.y))),Zft.CylinderShape_updateProp(this._impl,o,a/2,n),this.updateCompoundTransform()}}class YTt extends BTt{setHeight(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}setDirection(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}setRadius(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}get impl(){return this._impl}get collider(){return this._collider}onComponentSet(){this._impl=Zft.ConeShape_new(.5,1),this.setRadius(this.collider.radius)}updateScale(){super.updateScale(),this.setRadius(this.collider.radius)}updateProperties(t,e,i,s){const r=s,n=i;let o,a;1===n?(a=e*Math.abs(r.y),o=t*Math.abs(Ri(r.x,r.z))):0===n?(a=e*Math.abs(r.x),o=t*Math.abs(Ri(r.y,r.z))):(a=e*Math.abs(r.z),o=t*Math.abs(Ri(r.x,r.y))),Zft.ConeShape_setRadius(this._impl,o),Zft.ConeShape_setHeight(this._impl,a),Zft.ConeShape_setConeUpIndex(this._impl,n);const h=smt.instance.BT_V3_0;Zft.Vec3_set(h,1,1,1),Zft.CollisionShape_setLocalScaling(this._impl,h),this.updateCompoundTransform()}}class QTt extends BTt{constructor(){super(...arguments),this._bufPtr=0,this._tileSize=0,this._localOffset=new Ki}get collider(){return this._collider}setTerrain(t){if(this._isInitialized)if(this._impl&&smt.isNotEmptyShape(this._impl))P("[Physics][Bullet]: change the terrain asset after initialization is not support.");else{const e=t;if(e){this._tileSize=e.tileSize;const t=e.getVertexCountI(),i=e.getVertexCountJ();this._bufPtr=Zft._malloc(4*t*i);let s=0,r=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER;for(let o=0;o<i;o++)for(let i=0;i<t;i++){const t=e.getHeight(i,o);Zft._write_f32(this._bufPtr+s,t),r>t&&(r=t),t>n&&(n=t),s+=4}n+=.01,r-=.01,this._localOffset.set((t-1)/2*this._tileSize,(n+r)/2,(i-1)/2*this._tileSize),this._impl=Zft.TerrainShape_new(t,i,this._bufPtr,1,r,n);const o=smt.instance.BT_V3_0;Zft.Vec3_set(o,this._tileSize,1,this._tileSize),Zft.CollisionShape_setLocalScaling(this._impl,o),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=Zft.EmptyShape_static()}}onComponentSet(){this.setTerrain(this.collider.terrain)}onDestroy(){this._bufPtr&&Zft._free(this._bufPtr),super.onDestroy()}setCenter(t){Ki.copy(rmt,t),rmt.add(this._localOffset),umt(Zft.Transform_getOrigin(this.transform),rmt),this.updateCompoundTransform()}}class KTt extends BTt{setShapeType(t){}setVertices(t){}get collider(){return this._collider}onComponentSet(){this._impl=Zft.SimplexShape_new();const t=this.collider.shapeType,e=this.collider.vertices,i=smt.instance.BT_V3_0;for(let s=0;s<t;s++)Zft.SimplexShape_addVertex(this._impl,umt(i,e[s]));Zft.CollisionShape_setLocalScaling(this._impl,umt(i,this._collider.node.worldScale))}onLoad(){super.onLoad(),this.collider.updateVertices()}updateScale(){super.updateScale();const t=smt.instance.BT_V3_0;Zft.CollisionShape_setLocalScaling(this._impl,umt(t,this._collider.node.worldScale))}}class ZTt extends BTt{setNormal(t){umt(Zft.StaticPlaneShape_getPlaneNormal(this.impl),t),this.updateCompoundTransform()}setConstant(t){Zft.StaticPlaneShape_setPlaneConstant(this.impl,t),this.updateCompoundTransform()}updateScale(){super.updateScale();const t=smt.instance.BT_V3_0;umt(t,this._collider.node.worldScale),Zft.CollisionShape_setLocalScaling(this._impl,t),this.updateCompoundTransform()}get collider(){return this._collider}onComponentSet(){const t=smt.instance.BT_V3_0;umt(t,this.collider.normal),this._impl=Zft.StaticPlaneShape_new(t,this.collider.constant),this.updateScale()}}class JTt{constructor(){this.dirty=0,this.index=-1,this._impl=0,this._com=void 0,this._rigidBody=void 0,this._connectedBody=null,this._collided=!1}setConnectedBody(t){if(this._connectedBody===t)return;const e=this._connectedBody;e&&e.body.sharedBody.removeJoint(this,1);const i=this._rigidBody.body.sharedBody;i.removeJoint(this,0),this._impl&&(i.wrappedWorld.removeConstraint(this),Zft._safe_delete(this._impl,13)),this._connectedBody=t;const s=this._connectedBody;this.onComponentSet(),this.setEnableCollision(this._collided),i.wrappedWorld.addConstraint(this),i.addJoint(this,0),s&&s.body.sharedBody.addJoint(this,1)}setEnableCollision(t){this._collided!==t&&(this._collided=t,this.updateByReAdd())}get impl(){return this._impl}get constraint(){return this._com}updateByReAdd(){if(this._rigidBody&&this.index>=0){const t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.wrappedWorld.addConstraint(this)}}initialize(t){this._com=t,this._rigidBody=t.attachedBody,this._connectedBody=t.connectedBody,this._collided=t.enableCollision,this.onComponentSet(),this.setEnableCollision(this._collided)}updateDebugDrawSize(){if(this.impl){const t=Wmt.instance.physicsWorld.debugDrawConstraintSize;Zft.TypedConstraint_setDbgDrawSize(this.impl,t)}}onEnable(){const t=this._rigidBody.body.sharedBody;t.wrappedWorld.addConstraint(this),t.addJoint(this,0);const e=this._connectedBody;e&&e.body.sharedBody.addJoint(this,1)}onDisable(){const t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.removeJoint(this,0);const e=this._connectedBody;e&&e.body.sharedBody.removeJoint(this,1)}onDestroy(){Zft._safe_delete(this._impl,13),this._com=null,this._rigidBody=null,this._connectedBody=null}}class tCt extends JTt{setPivotA(t){const e=this.constraint,i=smt.instance.BT_V3_0;Ki.multiply(rmt,e.node.worldScale,e.pivotA),umt(i,rmt),Zft.P2PConstraint_setPivotA(this._impl,i),e.connectedBody||this.setPivotB(e.pivotB)}setPivotB(t){const e=this.constraint,i=this._rigidBody.node,s=smt.instance.BT_V3_0,r=e.connectedBody;r?(Ki.multiply(rmt,r.node.worldScale,e.pivotB),umt(s,rmt)):(Ki.multiply(rmt,i.worldScale,e.pivotA),Ki.transformQuat(rmt,rmt,i.worldRotation),Ki.add(rmt,rmt,i.worldPosition),umt(s,rmt)),Zft.P2PConstraint_setPivotB(this._impl,s)}get constraint(){return this._com}onComponentSet(){const t=this.constraint.connectedBody,e=this._rigidBody.body.impl,i=t?t.body.impl:Zft.TypedConstraint_getFixedBody(),s=smt.instance.BT_V3_0,r=smt.instance.BT_V3_1;this._impl=Zft.P2PConstraint_new(e,i,s,r),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.updateDebugDrawSize()}updateScale0(){this.setPivotA(this.constraint.pivotA)}updateScale1(){this.setPivotB(this.constraint.pivotB)}}class eCt extends JTt{setBreakForce(t){Zft.TypedConstraint_setMaxImpulseThreshold(this._impl,t)}setBreakTorque(t){}get constraint(){return this._com}onComponentSet(){const t=this.constraint.connectedBody,e=this._rigidBody.body.impl,i=t?t.body.impl:Zft.TypedConstraint_getFixedBody(),s=smt.instance.BT_TRANSFORM_0,r=smt.instance.BT_TRANSFORM_1;this._impl=Zft.FixedConstraint_new(e,i,s,r),this.setBreakForce(this.constraint.breakForce),this.setBreakTorque(this.constraint.breakTorque),this.updateFrames(),this.updateDebugDrawSize()}updateFrames(){const t=this.constraint.connectedBody,e=this._rigidBody.body.sharedBody,i=rmt,s=amt,r=smt.instance.BT_TRANSFORM_0,n=smt.instance.BT_TRANSFORM_1,o=smt.instance.BT_QUAT_0,a=lmt;if(Rs.fromRT(a,e.node.worldRotation,e.node.worldPosition),Rs.invert(a,a),Rs.getRotation(s,a),Rs.getTranslation(i,a),umt(Zft.Transform_getOrigin(r),i),pmt(o,s),Zft.Transform_setRotation(r,o),t){const e=t.body.sharedBody;Rs.fromRT(a,e.node.worldRotation,e.node.worldPosition),Rs.invert(a,a),Rs.getRotation(s,a),Rs.getTranslation(i,a),umt(Zft.Transform_getOrigin(n),i),pmt(o,s),Zft.Transform_setRotation(n,o)}else Zft.Transform_setIdentity(n);Zft.FixedConstraint_setFrames(this._impl,r,n)}updateScale0(){this.updateFrames()}updateScale1(){this.updateFrames()}}class iCt extends JTt{setPivotA(t){this.updateFrames()}setPivotB(t){this.updateFrames()}setAxis(t){this.updateFrames()}setLimitEnabled(t){this.constraint.limitEnabled?Zft.HingeConstraint_setLimit(this._impl,vi(this.constraint.lowerLimit),vi(this.constraint.upperLimit),.9,.3,1):Zft.HingeConstraint_setLimit(this._impl,1,0,.9,.3,1)}setLowerLimit(t){this.constraint.limitEnabled&&Zft.HingeConstraint_setLimit(this._impl,vi(this.constraint.lowerLimit),vi(this.constraint.upperLimit),.9,.3,1)}setUpperLimit(t){this.constraint.limitEnabled&&Zft.HingeConstraint_setLimit(this._impl,vi(this.constraint.lowerLimit),vi(this.constraint.upperLimit),.9,.3,1)}setMotorEnabled(t){Zft.HingeConstraint_enableMotor(this._impl,t);const e=-this.constraint.motorVelocity/60,i=fmt(this.constraint.motorForceLimit,Wmt.instance.fixedTimeStep);Zft.HingeConstraint_setMotorVelocity(this._impl,e),Zft.HingeConstraint_setMaxMotorImpulse(this._impl,i)}setMotorVelocity(t){if(this.constraint.motorEnabled){const e=-t/60;Zft.HingeConstraint_setMotorVelocity(this._impl,e)}}setMotorForceLimit(t){if(this.constraint.motorEnabled){const e=fmt(t,Wmt.instance.fixedTimeStep);Zft.HingeConstraint_setMaxMotorImpulse(this._impl,e)}}get constraint(){return this._com}onComponentSet(){const t=this.constraint.connectedBody,e=this._rigidBody.body.impl,i=t?t.body.impl:Zft.TypedConstraint_getFixedBody(),s=smt.instance.BT_TRANSFORM_0,r=smt.instance.BT_TRANSFORM_1;this._impl=Zft.HingeConstraint_new(e,i,s,r),this.setLimitEnabled(this.constraint.limitEnabled),this.setLowerLimit(this.constraint.lowerLimit),this.setUpperLimit(this.constraint.upperLimit),this.setMotorEnabled(this.constraint.motorEnabled),this.setMotorVelocity(this.constraint.motorVelocity),this.setMotorForceLimit(this.constraint.motorForceLimit),this.updateFrames(),this.updateDebugDrawSize()}updateFrames(){const t=this.constraint,e=t.node,i=rmt,s=amt,r=hmt,n=smt.instance.BT_TRANSFORM_0;Ki.multiply(i,e.worldScale,t.pivotA),umt(Zft.Transform_getOrigin(n),i);const o=smt.instance.BT_QUAT_0;Ki.normalize(i,t.axis),ys.rotationTo(r,Ki.UNIT_Z,i),pmt(o,r),Zft.Transform_setRotation(n,o);const a=smt.instance.BT_TRANSFORM_1,h=this.constraint.connectedBody;h?(Ki.multiply(i,h.node.worldScale,t.pivotB),ys.multiply(r,e.worldRotation,r),ys.invert(s,h.node.worldRotation),ys.multiply(r,s,r)):(Ki.multiply(i,e.worldScale,t.pivotA),Ki.transformQuat(i,i,e.worldRotation),Ki.add(i,i,e.worldPosition),ys.multiply(r,e.worldRotation,r)),umt(Zft.Transform_getOrigin(a),i),pmt(o,r),Zft.Transform_setRotation(a,o),Zft.HingeConstraint_setFrames(this._impl,n,a)}updateScale0(){this.updateFrames()}updateScale1(){this.updateFrames()}}class sCt extends JTt{_setLimit(t,e,i,s){switch(t){case 2:Zft.Generic6DofSpring2Constraint_setLimit(this._impl,e,0,0);break;case 1:Zft.Generic6DofSpring2Constraint_setLimit(this._impl,e,i,s);break;case 0:Zft.Generic6DofSpring2Constraint_setLimit(this._impl,e,1,0)}}setConstraintMode(t,e){const i=this.constraint.linearLimitSettings,s=this.constraint.angularLimitSettings,r=[0,0,0],n=[0,0,0];let o=0,a=0;switch(t){case 0:case 1:case 2:Ki.toArray(r,i.lower),Ki.toArray(n,i.upper),a=r[t],o=n[t];break;case 3:o=.5*vi(s.twistExtent),a=-o;break;case 4:o=.5*vi(s.swingExtent1),a=-o;break;case 5:o=.5*vi(s.swingExtent2),a=-o;break;default:B(`idx should be in [0, 5], but give ${t}`)}this._setLimit(e,t,a,o)}setLinearLimit(t,e,i){let s=0;const r=this.constraint.linearLimitSettings;switch(t){case 0:s=r.xMotion;break;case 1:s=r.yMotion;break;case 2:s=r.zMotion}this._setLimit(s,t,e,i)}setAngularExtent(t,e,i){const s=this.constraint.angularLimitSettings;this._setLimit(s.twistMotion,3,.5*-vi(t),.5*vi(t)),this._setLimit(s.swingMotion1,4,.5*-vi(e),.5*vi(e)),this._setLimit(s.swingMotion2,5,.5*-vi(i),.5*vi(i))}setSwingSoftConstraint(t){Zft.Generic6DofSpring2Constraint_enableSpring(this._impl,4,t),Zft.Generic6DofSpring2Constraint_enableSpring(this._impl,5,t)}setTwistSoftConstraint(t){Zft.Generic6DofSpring2Constraint_enableSpring(this._impl,3,t)}setLinearSoftConstraint(t){Zft.Generic6DofSpring2Constraint_enableSpring(this._impl,0,t),Zft.Generic6DofSpring2Constraint_enableSpring(this._impl,1,t),Zft.Generic6DofSpring2Constraint_enableSpring(this._impl,2,t)}setLinearStiffness(t){Zft.Generic6DofSpring2Constraint_setStiffness(this._impl,0,t),Zft.Generic6DofSpring2Constraint_setStiffness(this._impl,1,t),Zft.Generic6DofSpring2Constraint_setStiffness(this._impl,2,t)}setLinearDamping(t){Zft.Generic6DofSpring2Constraint_setDamping(this._impl,0,t),Zft.Generic6DofSpring2Constraint_setDamping(this._impl,1,t),Zft.Generic6DofSpring2Constraint_setDamping(this._impl,2,t)}setLinearRestitution(t){Zft.Generic6DofSpring2Constraint_setBounce(this._impl,0,t),Zft.Generic6DofSpring2Constraint_setBounce(this._impl,1,t),Zft.Generic6DofSpring2Constraint_setBounce(this._impl,2,t)}setSwingStiffness(t){Zft.Generic6DofSpring2Constraint_setStiffness(this._impl,4,t),Zft.Generic6DofSpring2Constraint_setStiffness(this._impl,5,t)}setSwingDamping(t){Zft.Generic6DofSpring2Constraint_setDamping(this._impl,4,t),Zft.Generic6DofSpring2Constraint_setDamping(this._impl,5,t)}setSwingRestitution(t){Zft.Generic6DofSpring2Constraint_setBounce(this._impl,4,t),Zft.Generic6DofSpring2Constraint_setBounce(this._impl,5,t)}setTwistStiffness(t){Zft.Generic6DofSpring2Constraint_setStiffness(this._impl,3,t)}setTwistDamping(t){Zft.Generic6DofSpring2Constraint_setDamping(this._impl,3,t)}setTwistRestitution(t){Zft.Generic6DofSpring2Constraint_setBounce(this._impl,3,t)}setDriverMode(t,e){0===e?Zft.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!1):1===e?(Zft.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!0),Zft.Generic6DofSpring2Constraint_setServo(this._impl,t,!0)):2===e&&(Zft.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!0),Zft.Generic6DofSpring2Constraint_setServo(this._impl,t,!1))}_updateMotorTargetAndVelocity(t){let e=0,i=0,s=0,r=0;const n=this.constraint.linearDriverSettings,o=this.constraint.angularDriverSettings;switch(t){case 0:i=0,e=n.xDrive,s=n.targetPosition.x,r=-n.targetVelocity.x;break;case 1:i=1,e=n.yDrive,s=n.targetPosition.y,r=-n.targetVelocity.y;break;case 2:i=2,e=n.zDrive,s=n.targetPosition.z,r=-n.targetVelocity.z;break;case 3:i=3,e=o.twistDrive,s=-vi(o.targetOrientation.x),r=-vi(o.targetVelocity.x);break;case 4:i=4,e=o.swingDrive1,s=-vi(o.targetOrientation.y),r=-vi(o.targetVelocity.y);break;case 5:i=5,e=o.swingDrive2,s=-vi(o.targetOrientation.z),r=-vi(o.targetVelocity.z)}const a=t>2?o.strength:n.strength;Zft.Generic6DofSpring2Constraint_setServoTarget(this._impl,i,s),1===e?t>2?Zft.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,i,-s*a*.1):Zft.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,i,s*a*.1):2===e&&Zft.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,i,r)}setLinearMotorTarget(t){this._updateMotorTargetAndVelocity(0),this._updateMotorTargetAndVelocity(1),this._updateMotorTargetAndVelocity(2)}setLinearMotorVelocity(t){this._updateMotorTargetAndVelocity(0),this._updateMotorTargetAndVelocity(1),this._updateMotorTargetAndVelocity(2)}setLinearMotorForceLimit(t){Zft.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,0,t),Zft.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,1,t),Zft.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,2,t)}setAngularMotorTarget(t){this._updateMotorTargetAndVelocity(3),this._updateMotorTargetAndVelocity(4),this._updateMotorTargetAndVelocity(5)}setAngularMotorVelocity(t){this._updateMotorTargetAndVelocity(3),this._updateMotorTargetAndVelocity(4),this._updateMotorTargetAndVelocity(5)}setAngularMotorForceLimit(t){Zft.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,3,t),Zft.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,4,t),Zft.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,5,t)}setPivotA(t){this.updateFrames()}setPivotB(t){this.updateFrames()}setAutoPivotB(t){this.updateFrames()}setAxis(t){this.updateFrames()}setSecondaryAxis(t){this.updateFrames()}setBreakForce(t){const e=fmt(Math.max(this.constraint.breakForce,this.constraint.breakTorque),Wmt.instance.fixedTimeStep);Zft.TypedConstraint_setMaxImpulseThreshold(this._impl,e)}setBreakTorque(t){const e=fmt(Math.max(this.constraint.breakForce,this.constraint.breakTorque),Wmt.instance.fixedTimeStep);Zft.TypedConstraint_setMaxImpulseThreshold(this._impl,e)}get constraint(){return this._com}onComponentSet(){const t=this.constraint.connectedBody,e=this._rigidBody.body.impl,i=t&&t.body.impl||Zft.TypedConstraint_getFixedBody(),s=smt.instance.BT_TRANSFORM_0,r=smt.instance.BT_TRANSFORM_1;this._impl=Zft.Generic6DofSpring2Constraint_new(e,i,s,r,3);const n=this.constraint.linearLimitSettings,o=this.constraint.angularLimitSettings;this.setConstraintMode(0,n.xMotion),this.setConstraintMode(1,n.yMotion),this.setConstraintMode(2,n.zMotion),this.setConstraintMode(3,o.twistMotion),this.setConstraintMode(4,o.swingMotion1),this.setConstraintMode(5,o.swingMotion2),this.setLinearSoftConstraint(n.enableSoftConstraint),this.setLinearStiffness(n.stiffness),this.setLinearDamping(n.damping),this.setLinearRestitution(n.restitution),this.setSwingSoftConstraint(o.enableSoftConstraintSwing),this.setSwingRestitution(o.swingRestitution),this.setSwingStiffness(o.swingStiffness),this.setSwingDamping(o.swingDamping),this.setTwistSoftConstraint(o.enableSoftConstraintTwist),this.setTwistRestitution(o.twistRestitution),this.setTwistStiffness(o.twistStiffness),this.setTwistDamping(o.twistDamping);const a=this.constraint.linearDriverSettings,h=this.constraint.angularDriverSettings;this.setDriverMode(0,a.xDrive),this.setDriverMode(1,a.yDrive),this.setDriverMode(2,a.zDrive),this.setDriverMode(3,h.twistDrive),this.setDriverMode(4,h.swingDrive1),this.setDriverMode(5,h.swingDrive2),this.setLinearMotorTarget(a.targetPosition),this.setLinearMotorVelocity(a.targetVelocity),this.setLinearMotorForceLimit(a.strength),this.setAngularMotorTarget(h.targetOrientation),this.setAngularMotorVelocity(h.targetVelocity),this.setAngularMotorForceLimit(h.strength),this.setBreakForce(this.constraint.breakForce),this.setBreakTorque(this.constraint.breakTorque),this.updateFrames(),this.updateDebugDrawSize()}updateFrames(){const t=this.constraint,e=t.node,i=rmt,s=amt,r=hmt,n=smt.instance.BT_TRANSFORM_0;Ki.multiply(i,e.worldScale,t.pivotA),umt(Zft.Transform_getOrigin(n),i);const o=smt.instance.BT_QUAT_0,a=t.axis,h=t.secondaryAxis,l=Ki.cross(nmt,a,h);Rs.set(lmt,a.x,a.y,a.z,0,h.x,h.y,h.z,0,l.x,l.y,l.z,0,0,0,0,1).getRotation(s),pmt(o,s),Zft.Transform_setRotation(n,o);const c=smt.instance.BT_TRANSFORM_1,u=this.constraint.connectedBody;u?(ys.multiply(s,e.worldRotation,s),ys.invert(r,u.node.worldRotation),ys.multiply(s,r,s),t.autoPivotB?(Ki.multiply(i,t.node.worldScale,t.pivotA),Ki.transformQuat(i,i,e.worldRotation),Ki.add(i,i,t.node.worldPosition),Ki.subtract(i,i,u.node.worldPosition),Ki.transformQuat(i,i,r)):Ki.multiply(i,u.node.worldScale,t.pivotB)):(Ki.multiply(i,e.worldScale,t.pivotA),Ki.transformQuat(i,i,e.worldRotation),Ki.add(i,i,e.worldPosition),ys.multiply(s,e.worldRotation,s)),umt(Zft.Transform_getOrigin(c),i),pmt(o,s),Zft.Transform_setRotation(c,o),Zft.Generic6DofSpring2Constraint_setFrames(this._impl,n,c)}updateScale0(){this.updateFrames()}updateScale1(){this.updateFrames()}}const rCt=new Ki(0,0,0),nCt=new Ki(0,0,0);new Ki(0,0,0);class oCt{get isEnabled(){return this._isEnabled}get impl(){return this._impl}get characterController(){return this._comp}constructor(){this.wrappedWorld=void 0,this._isEnabled=!1,this._impl=0,this._comp=null,this._btCollisionFlags=0,this._word3=0,this._dirty=!1,this._collisionFilterGroup=1,this._collisionFilterMask=-1,this.id=oCt.idCounter++,this.wrappedWorld=Wmt.instance.physicsWorld}onComponentSet(){}updateScale(){}initialize(t){this._comp=t;const e=this._comp.group,i=Wmt.instance.collisionMatrix[e];return this._collisionFilterGroup=e,this._collisionFilterMask=i,this.onComponentSet(),0!==this._impl||(B("[Physics]: Initialize BulletCharacterController failed"),!1)}setWrapper(){smt.setWrapper(this._impl,Jft.CCT_CACHE_NAME,this);const t=Zft.CharacterController_getCollisionShape(this.impl);smt.setWrapper(t,Jft.CCT_CACHE_NAME,this)}onEnable(){this._isEnabled=!0,this._impl||this.onComponentSet(),this.setDetectCollisions(!1),this.setOverlapRecovery(!0),Wmt.instance.physicsWorld.addCCT(this),this.setWrapper()}onDisable(){this._isEnabled=!1,this.wrappedWorld.removeCCT(this),this.onDestroy()}onDestroy(){Zft._safe_delete(this._impl,6),smt.delWrapper(this._impl,Jft.CCT_CACHE_NAME),this._impl=0}onLoad(){}getPosition(t){this._impl&&dmt(t,Zft.CharacterController_getPosition(this.impl))}setPosition(t){this._impl&&(umt(Zft.CharacterController_getPosition(this.impl),t),this.syncPhysicsToScene())}setContactOffset(t){this._impl&&Zft.CharacterController_setContactOffset(this._impl,t)}setStepOffset(t){this._impl&&Zft.CharacterController_setStepOffset(this._impl,t)}setSlopeLimit(t){this._impl&&Zft.CharacterController_setSlopeLimit(this._impl,we(t))}setDetectCollisions(t){this._impl&&Zft.CharacterController_setCollision(this.impl,t)}setOverlapRecovery(t){this._impl&&Zft.CharacterController_setOverlapRecovery(this.impl,t)}onGround(){return(4&this._btCollisionFlags)>0}syncSceneToPhysics(){const t=this.characterController.node;t.hasChangedFlags&&(4&t.hasChangedFlags&&this.syncScale(),1&t.hasChangedFlags&&(Ki.add(rCt,t.worldPosition,this.scaledCenter),this.setPosition(rCt)))}syncPhysicsToScene(){this.getPosition(rCt),rCt.subtract(this.scaledCenter),this._comp.node.setWorldPosition(rCt)}syncScale(){this.updateScale()}get scaledCenter(){return Ki.multiply(nCt,this._comp.center,this._comp.node.worldScale),nCt}move(t,e,i){if(!this._isEnabled)return;const s=smt.instance.BT_V3_0;Zft.Vec3_set(s,t.x,t.y,t.z),this._btCollisionFlags=Zft.CharacterController_move(this.impl,s,e,i)}setGroup(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this._dirty=!0)}getGroup(){return this._collisionFilterGroup}addGroup(t){this._collisionFilterGroup|=t,this._dirty=!0}removeGroup(t){this._collisionFilterGroup&=~t,this._dirty=!0}setMask(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this._dirty=!0)}getMask(){return this._collisionFilterMask}addMask(t){this._collisionFilterMask|=t,this._dirty=!0}removeMask(t){this._collisionFilterMask&=~t,this._dirty=!0}updateEventListener(){this.wrappedWorld.updateNeedEmitCCTEvents(this.characterController.needCollisionEvent)}updateDirty(){this._dirty&&(Wmt.instance.physicsWorld.removeCCT(this),Wmt.instance.physicsWorld.addCCT(this),this._dirty=!1)}onShapeHitExt(t){const e=Zft.ControllerShapeHit_getHitShape(t),i=Wmt.instance.physicsWorld;i.cctShapeEventDic.get(this.impl,e);const s=new Ki;dmt(s,Zft.ControllerHit_getHitWorldPos(t));const r=new Ki;dmt(r,Zft.ControllerHit_getHitWorldNormal(t));const n=new Ki;dmt(n,Zft.ControllerHit_getHitMotionDir(t));const o=Zft.ControllerHit_getHitMotionLength(t),a=smt.getWrapper(e,BTt.TYPE);a&&i.cctShapeEventDic.set(this.impl,e,{BulletCharacterController:this,BulletShape:a,worldPos:s,worldNormal:r,motionDir:n,motionLength:o})}}oCt.idCounter=0;const aCt=new Ki(0,0,0);class hCt extends oCt{get component(){return this._comp}onComponentSet(){this.component.node.getWorldPosition(aCt),aCt.add(this.scaledCenter);const t=smt.instance.BT_V3_0;Zft.Vec3_set(t,aCt.x,aCt.y,aCt.z);const e=Ki.UNIT_Y,i=smt.instance.BT_V3_1;Zft.Vec3_set(i,e.x,e.y,e.z);const s=Zft.ControllerHitReport.implement(CTt).$$.ptr,r=Wmt.instance.physicsWorld,n=Zft.CapsuleCharacterControllerDesc_new(we(this.component.slopeLimit),this.component.stepOffset,this.component.skinWidth,i,t,s,this.component.radius,this.component.height);this._impl=Zft.CapsuleCharacterController_new(r.impl,n,0),this.updateScale()}setRadius(t){this.updateScale()}setHeight(t){this.updateScale()}updateScale(){this.updateGeometry()}updateGeometry(){const t=this.component.node.worldScale,e=this.component.radius*Ri(t.x,t.z),i=this.component.height*Math.abs(t.y);Zft.CapsuleCharacterController_setRadius(this.impl,e),Zft.CapsuleCharacterController_setHeight(this.impl,i),this._dirty=!0}}const lCt=new Ki(0,0,0);class cCt extends oCt{get component(){return this._comp}onComponentSet(){this.component.node.getWorldPosition(lCt),lCt.add(this.scaledCenter);const t=smt.instance.BT_V3_0;Zft.Vec3_set(t,lCt.x,lCt.y,lCt.z);const e=Ki.UNIT_Y,i=smt.instance.BT_V3_1;Zft.Vec3_set(i,e.x,e.y,e.z);const s=Zft.ControllerHitReport.implement(CTt).$$.ptr,r=Wmt.instance.physicsWorld,n=Zft.BoxCharacterControllerDesc_new(we(this.component.slopeLimit),this.component.stepOffset,this.component.skinWidth,i,t,s,this.component.halfHeight,this.component.halfSideExtent,this.component.halfForwardExtent);this._impl=Zft.BoxCharacterController_new(r.impl,n,0),this.updateScale()}setHalfHeight(t){this.updateScale()}setHalfSideExtent(t){this.updateScale()}setHalfForwardExtent(t){this.updateScale()}updateScale(){this.updateGeometry()}updateGeometry(){const t=this.component.node.worldScale;Zft.BoxCharacterController_setHalfSideExtent(this.impl,this.component.halfSideExtent*t.x),Zft.BoxCharacterController_setHalfHeight(this.impl,this.component.halfHeight*t.y),Zft.BoxCharacterController_setHalfForwardExtent(this.impl,this.component.halfForwardExtent*t.z),this._dirty=!0}}var uCt,dCt,pCt,_Ct,gCt,fCt,mCt;TP.once(xP.EVENT_PRE_SUBSYSTEM_INIT,(()=>{Lft.register("bullet",{PhysicsWorld:HTt,RigidBody:TTt,BoxShape:GTt,SphereShape:WTt,CapsuleShape:jTt,TrimeshShape:qTt,CylinderShape:XTt,ConeShape:YTt,TerrainShape:QTt,SimplexShape:KTt,PlaneShape:ZTt,PointToPointConstraint:tCt,HingeConstraint:iCt,FixedConstraint:eCt,ConfigurableConstraint:sCt,BoxCharacterController:cCt,CapsuleCharacterController:hCt})}));const yCt={BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,TORUS:5,PLANE:6,QUAD:7};te(yCt);let vCt=t("Primitive",(uCt=oa("cc.Primitive"),dCt=Ga(yCt),uCt((mCt=class extends ZP{constructor(t){void 0===t&&(t=0),super(),this.type=gCt&&gCt(),this.info=fCt&&fCt(),this.type=t}onLoaded(){lB((0,kX[yCt[this.type].toLowerCase()])(this.info),this)}},mCt.PrimitiveType=yCt,gCt=Qo((_Ct=mCt).prototype,"type",[dCt],(function(){return 0})),fCt=Qo(_Ct.prototype,"info",[va],(function(){return{}})),pCt=_Ct))||pCt));h.Primitive=vCt,l.primitives=kX;class bCt{get value(){return this._value}set value(t){this._value=t}constructor(t,e,i){this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=i}sample(t){this._average(this._value,t)}human(){const{average:t,isInteger:e}=this._opts,i=t?this._averageValue:this._value;return e?Math.round(i):Math.round(100*i)/100}alarm(){return void 0!==this._opts.below&&this._value<this._opts.below||void 0!==this._opts.over&&this._value>this._opts.over}_average(t,e){if(void 0===e&&(e=0),this._opts.average){this._accumValue+=t,++this._accumSamples;const i=e;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}var wCt;let SCt=oa("cc.PerfCounter")(wCt=class extends bCt{constructor(t,e,i){super(t,e,i),this._time=i}start(t){void 0===t&&(t=0),this._time=t}end(t){void 0===t&&(t=0),this._value=t-this._time,this._average(this._value)}tick(){this.end(),this.start()}frame(t){const e=t,i=e-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=e,this._average(this._value))}})||wCt;const xCt="0123456789. ",TCt=500,CCt={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},ICt={fps:{desc:"Framerate (FPS)",below:30,average:TCt,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:TCt},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:TCt,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:TCt},render:{desc:"Renderer (ms)",min:0,max:50,average:TCt,color:"#f90"},present:{desc:"Present (ms)",min:0,max:50,average:TCt,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},ECt={fontSize:23,quadHeight:.4,segmentsPerLine:8,textureWidth:280,textureHeight:280};class DCt extends su{constructor(){super(),this._profilerStats=null,this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new bd,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=ECt.textureHeight/(Object.keys(ICt).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=u.document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}init(){ae.querySettings("profiling","showFPS")?this.showStats():this.hideStats()}get _stats(){return G(16381),this._profilerStats}get stats(){return this._profilerStats}isShowingStats(){return this._showFPS}hideStats(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),uP.off("director_before_update",this.beforeUpdate,this),uP.off("director_after_update",this.afterUpdate,this),uP.off("director_before_physics",this.beforePhysics,this),uP.off("director_after_physics",this.afterPhysics,this),uP.off("director_before_draw",this.beforeDraw,this),uP.off("director_after_render",this.afterRender,this),uP.off("director_after_draw",this.afterPresent,this),this._showFPS=!1,uP.root.pipeline.profiler=null,h.game.config.showFPS=!1)}showStats(){if(!this._showFPS){if(!this._device){const t=h.director.root;this._device=e_.gfxDevice,this._swapchain=t.mainWindow.swapchain}this.generateCanvas(),this.generateStats(),h.game.once(h.Game.EVENT_ENGINE_INITED,this.generateNode,this),h.game.on(h.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),uP.on("director_before_update",this.beforeUpdate,this),uP.on("director_after_update",this.afterUpdate,this),uP.on("director_before_physics",this.beforePhysics,this),uP.on("director_after_physics",this.afterPhysics,this),uP.on("director_before_draw",this.beforeDraw,this),uP.on("director_after_render",this.afterRender,this),uP.on("director_after_draw",this.afterPresent,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,h.game.config.showFPS=!0}}generateCanvas(){if(this._canvasDone)return;const{textureWidth:t,textureHeight:e}=ECt;this._ctx&&this._canvas&&(this._canvas.width=t,this._canvas.height=e,this._canvas.style.width=`${this._canvas.width}`,this._canvas.style.height=`${this._canvas.height}`,this._ctx.font=`${ECt.fontSize}px Arial`,this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new Bd(1,6,35,t,e)),this._region.texExtent.width=t,this._region.texExtent.height=e)}generateStats(){if(this._statsDone||!this._ctx||!this._canvas)return;this._profilerStats=null;const t=performance.now();this._ctx.textAlign="left";let e=0;for(const i in ICt){const s=ICt[i];this._ctx.fillText(s.desc,0,e*this._lineHeight),s.counter=new SCt(i,s,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(let t=0;t<12;++t){const e=this._ctx.measureText(xCt[t]).width;this._eachNumWidth=Math.max(this._eachNumWidth,e)}for(let t=0;t<12;++t)this._ctx.fillText(xCt[t],t*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._profilerStats=ICt,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}generateNode(){if(this._rootNode&&this._rootNode.isValid)return;this._rootNode=new JS("PROFILER_NODE"),this._rootNode._objFlags=h.Object.Flags.DontSave|h.Object.Flags.HideInHierarchy,TP.addPersistRootNode(this._rootNode);const t=new JS("Profiler_Root");t.parent=this._rootNode;const e=ECt.quadHeight,i=e/this._totalLines,s=e/this._wordHeight,r=i/ECt.fontSize,n=this._eachNumWidth*this._canvas.width*r,o=[0,e,0,s,e,0,s,0,0,0,0,0],a=[0,2,1,0,3,2],l=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0];let c=0;for(let t=0;t<this._totalLines;t++)for(let r=0;r<ECt.segmentsPerLine;r++){o.push(s+r*n,e-t*i,0),o.push(s+(r+1)*n,e-t*i,0),o.push(s+(r+1)*n,e-(t+1)*i,0),o.push(s+r*n,e-(t+1)*i,0),c=4*(t*ECt.segmentsPerLine+r+1),a.push(0+c,2+c,1+c,0+c,3+c,2+c);const h=t*ECt.segmentsPerLine+r,u=Math.floor(h/4),d=h-4*u;l.push(0,this._wordHeight,u,d),l.push(this._eachNumWidth,this._wordHeight,u,d),l.push(this._eachNumWidth,1,u,d),l.push(0,1,u,d)}this._meshRenderer=t.addComponent(lG),this._meshRenderer.mesh=lB({positions:o,indices:a,colors:l});const u=new Lw;u.initialize({effectName:"util/profiler"});const d=this.pass=u.passes[0],p=d.getBinding("mainTexture"),_=d.getBinding("digits"),g=d.getBinding("offset");d.bindTexture(p,this._texture),this.digitsData=d.blocks[_],this.offsetData=d.blocks[g],this.offsetData[3]=-1,this._meshRenderer.material=u,this._meshRenderer.node.layer=Kf.Enum.PROFILER,this._inited=!0}beforeUpdate(){if(!this._profilerStats)return;const t=performance.now();this._profilerStats.frame.counter.start(t),this._profilerStats.logic.counter.start(t)}afterUpdate(){if(!this._profilerStats)return;const t=performance.now();uP.isPaused()?this._profilerStats.frame.counter.start(t):this._profilerStats.logic.counter.end(t)}beforePhysics(){if(!this._profilerStats)return;const t=performance.now();this._profilerStats.physics.counter.start(t)}afterPhysics(){if(!this._profilerStats)return;const t=performance.now();this._profilerStats.physics.counter.end(t)}beforeDraw(){if(!this._profilerStats||!this._inited)return;const t=this._swapchain.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){const i=Is[t];let s=-.9,r=-.9*e;Hn.isXR&&(s=-.5,r=-.5*e),this.offsetData[0]=s*i[0]+r*i[2],this.offsetData[1]=s*i[1]+r*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass.setRootBufferDirty(!0),this._meshRenderer.model?uP.root.pipeline.profiler=this._meshRenderer.model:uP.root.pipeline.profiler=null;const i=performance.now();this._profilerStats.render.counter.start(i)}afterRender(){if(!this._profilerStats||!this._inited)return;const t=performance.now();this._profilerStats.render.counter.end(t),this._profilerStats.present.counter.start(t)}afterPresent(){if(!this._profilerStats||!this._inited)return;const t=performance.now();if(this._profilerStats.frame.counter.end(t),this._profilerStats.fps.counter.frame(t),this._profilerStats.present.counter.end(t),t-this.lastTime<TCt)return;this.lastTime=t;const e=this._device;this._profilerStats.draws.counter.value=e.numDrawCalls,this._profilerStats.instances.counter.value=e.numInstances,this._profilerStats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._profilerStats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._profilerStats.tricount.counter.value=e.numTris;let i=0;const s=this.digitsData;for(const e in this._profilerStats){const r=this._profilerStats[e];r.counter.sample(t);const n=r.counter.human().toString();for(let t=ECt.segmentsPerLine-1;t>=0;t--){const e=i*ECt.segmentsPerLine+t,r=n[n.length-(ECt.segmentsPerLine-t)];let o=CCt[r];void 0===o&&(o=11),s[e]=o}i++}}}t("Profiler",DCt);const ACt=t("profiler",new DCt);uP.registerSystem("profiler",ACt,0),h.profiler=ACt,h.internal.DataPoolManager=class{constructor(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new N$(t),this.jointAnimationInfo=new U$(t)}releaseSkeleton(t){this.jointTexturePool.releaseSkeleton(t)}releaseAnimationClip(t){this.jointTexturePool.releaseAnimationClip(t)}clear(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()}};const MCt=new Rs,PCt=new Rs;class BCt extends IY{constructor(t,e){void 0===e&&(e=""),super(t,e),this._frames=1,this._bakedDuration=0,this._animInfo=null,this._sockets=[],this._animInfoMgr=void 0,this._parent=null,this._curvesInited=!1,this._animInfoMgr=h.director.root.dataPoolManager.jointAnimationInfo}initialize(t){if(this._curveLoaded)return;this._parent=t.getComponent("cc.SkeletalAnimation");const e=this._parent.useBakedAnimation;this._doNotCreateEval=e,super.initialize(t),this._curvesInited=!e;const{frames:i,samples:s}=T$.getOrExtract(this.clip);this._frames=i-1,this._animInfo=this._animInfoMgr.getData(t.uuid),this._bakedDuration=this._frames/s,this.setUseBaked(e)}onPlay(){super.onPlay(),this._parent.useBakedAnimation&&(this._animInfoMgr.switchClip(this._animInfo,this.clip),this._parent.getUsers().forEach((t=>{t.uploadAnimation(this.clip)})))}setUseBaked(t){t?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=super._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,super.initialize(this._targetNode),this._curvesInited=!0))}rebuildSocketCurves(t){if(this._sockets.length=0,!this._targetNode)return;const e=this._targetNode;for(let i=0;i<t.length;++i){const s=t[i],r=e.getChildByPath(s.path);if(!s.target)continue;const n=T$.getOrExtract(this.clip);let o,a=s.path,h=n.joints[a],l=r;for(;!h;){const t=a.lastIndexOf("/");if(a=a.substring(0,t),h=n.joints[a],l&&(o||(o=Rs.identity(PCt)),Rs.fromRTS(MCt,l.rotation,l.position,l.scale),Rs.multiply(o,MCt,o),l=l.parent),t<0)break}const c=h&&h.transforms,{frames:u}=n,d=[];for(let t=0;t<u;t++){let e;e=c&&o?Rs.multiply(MCt,c[t],o):c?c[t]:o||new Rs;const i={pos:new Ki,rot:new ys,scale:new Ki};Rs.toRTS(e,i.rot,i.pos,i.scale),d.push(i)}this._sockets.push({target:s.target,frames:d})}}_sampleCurvesBaked(t){const e=t/this.duration,i=this._animInfo,s=this.clip;i.currentClip!==s&&(this._animInfoMgr.switchClip(this._animInfo,s),this._parent.getUsers().forEach((t=>{t.uploadAnimation(s)})),i.data[0]=-1);const r=e*this._frames+.5|0;if(r!==i.data[0]){i.data[0]=r,i.dirty=!0;for(let t=0;t<this._sockets.length;++t){const{target:e,frames:i}=this._sockets[t],{pos:s,rot:n,scale:o}=i[r];e.setRTS(n,s,o)}}}}var RCt,OCt,LCt,FCt,zCt,kCt,NCt,UCt,VCt,HCt,GCt,WCt,jCt,$Ct,qCt;t("SkeletalAnimationState",BCt);let XCt=t("Socket",(RCt=oa("cc.SkeletalAnimation.Socket"),OCt=Ga(JS),RCt((FCt=class{constructor(t,e){void 0===t&&(t=""),void 0===e&&(e=null),this.path=zCt&&zCt(),this.target=kCt&&kCt(),this.path=t,this.target=e}},zCt=Qo(FCt.prototype,"path",[va],(function(){return""})),kCt=Qo(FCt.prototype,"target",[OCt],(function(){return null})),LCt=FCt))||LCt));Ot(XCt,"cc.SkeletalAnimationComponent.Socket");const YCt=new Rs,QCt=new Rs;function KCt(t,e,i){void 0===e&&(e=""),void 0===i&&(i=[]);for(let s=0;s<t.children.length;s++){const r=t.children[s];if(!r)continue;const n=e?`${e}/${r.name}`:r.name;i.push(n),KCt(r,n,i)}return i}t("SkeletalAnimation",(NCt=oa("cc.SkeletalAnimation"),UCt=ha(99),VCt=Ga([XCt]),HCt=Ga([XCt]),NCt(GCt=UCt((qCt=class extends m9{constructor(){super(...arguments),this._useBakedAnimation=jCt&&jCt(),this._sockets=$Ct&&$Ct(),this._users=new Set,this._currentBakedState=null}get sockets(){return this._sockets}set sockets(t){if(!this._useBakedEffectively){const e=TY();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}get useBakedAnimation(){return this._useBakedAnimation}set useBakedAnimation(t){this._useBakedAnimation=t,this._applyBakeFlagChange()}onLoad(){super.onLoad();const t=this.node.getComponentsInChildren(gq);for(let e=0;e<t.length;++e){const i=t[e];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}}onDestroy(){super.onDestroy(),h.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),TY().removeSockets(this.node,this._sockets),this._removeAllUsers()}onEnable(){var t;super.onEnable(),null===(t=this._currentBakedState)||void 0===t||t.resume()}onDisable(){var t;super.onDisable(),null===(t=this._currentBakedState)||void 0===t||t.pause()}start(){this.sockets=this._sockets,this._applyBakeFlagChange(),super.start()}pause(){var t;this._useBakedEffectively?null===(t=this._currentBakedState)||void 0===t||t.pause():super.pause()}resume(){var t;this._useBakedEffectively?null===(t=this._currentBakedState)||void 0===t||t.resume():super.resume()}stop(){this._useBakedEffectively?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):super.stop()}querySockets(){const t=this._defaultClip&&Object.keys(T$.getOrExtract(this._defaultClip).joints).sort().reduce(((t,e)=>(e.startsWith(`${t[t.length-1]}/`)||t.push(e),t)),[])||[];if(!t.length)return["please specify a valid default animation clip first"];const e=[];for(let i=0;i<t.length;i++){const s=t[i],r=this.node.getChildByPath(s);r&&(e.push(s),KCt(r,s,e))}return e}rebuildSocketAnimations(){for(const t of this._sockets){const e=this.node.getChildByPath(t.path),{target:i}=t;e&&i&&(i.name=`${t.path.substring(t.path.lastIndexOf("/")+1)} Socket`,i.parent=this.node,I$(e,this.node,YCt),Rs.fromRTS(QCt,i.rotation,i.position,i.scale),Rs.equals(QCt,YCt)||(i.matrix=YCt))}for(const t of Object.keys(this._nameToState))this._nameToState[t].rebuildSocketCurves(this._sockets)}createSocket(t){const e=this._sockets.find((e=>e.path===t));if(e)return e.target;if(!this.node.getChildByPath(t))return P("illegal socket path"),null;const i=new JS;return i.parent=this.node,this._sockets.push(new XCt(t,i)),this.rebuildSocketAnimations(),i}notifySkinnedMeshAdded(t){const{_useBakedEffectively:e}=this,i=t.associatedAnimation;if(i&&i._users.delete(t),t.associatedAnimation=this,t.setUseBakedAnimation(e,!0),e){const{_currentBakedState:e}=this;e&&t.uploadAnimation(e.clip)}this._users.add(t)}notifySkinnedMeshRemoved(t){t.associatedAnimation===this||t.associatedAnimation,t.setUseBakedAnimation(!1),t.associatedAnimation=null,this._users.delete(t)}getUsers(){return this._users}_createState(t,e){return new BCt(t,e)}_doCreateState(t,e){const i=super._doCreateState(t,e);return i.rebuildSocketCurves(this._sockets),i}doPlayOrCrossFade(t,e){if(this._useBakedEffectively){this._currentBakedState&&this._currentBakedState.stop();const e=t;this._currentBakedState=e,e.play()}else super.doPlayOrCrossFade(t,e)}_removeAllUsers(){Array.from(this._users).forEach((t=>{this.notifySkinnedMeshRemoved(t)}))}get _useBakedEffectively(){return this._useBakedAnimation}_applyBakeFlagChange(){const t=this._useBakedEffectively;for(const e in this._nameToState)this._nameToState[e].setUseBaked(t);this._users.forEach((e=>{e.setUseBakedAnimation(t)})),t?TY().removeSockets(this.node,this._sockets):(TY().addSockets(this.node,this._sockets),this._currentBakedState=null)}},qCt.Socket=XCt,s((WCt=qCt).prototype,"sockets",[VCt],Object.getOwnPropertyDescriptor(WCt.prototype,"sockets"),WCt.prototype),jCt=Qo(WCt.prototype,"_useBakedAnimation",[va],(function(){return!0})),$Ct=Qo(WCt.prototype,"_sockets",[HCt],(function(){return[]})),GCt=WCt))||GCt)||GCt));const ZCt=new Ki,JCt=new Ki;function tIt(t,e){let i=null;return{value:e.length>0?e[e.length-1]:Ki.ZERO,progress:(t,e,s,r)=>i.getPoint(r),clone:t=>Ki.clone(t),add:(t,e)=>t.clone().add(e),sub:(t,e)=>t.clone().subtract(e),onStart(s){const{start:r,end:n,relative:o,reversed:a}=s;i=Ec.create(t),i.addKnot(r);let h=null;o&&a&&(h=JCt,Ki.subtract(h,r,e[e.length-1]));for(let t=0,s=e.length;t<s;++t){const n=a?e[s-1-t]:e[t];o?a?t>0&&i.addKnot(Ki.copy(ZCt,h).add(n)):i.addKnot(Ki.copy(ZCt,r).add(n)):i.addKnot(n)}o&&a&&i.addKnot(n)},onComplete(){i=null},onStop(){i=null},legacyProgress:!1}}var eIt,iIt,sIt,rIt,nIt,oIt,aIt,hIt,lIt,cIt,uIt,dIt,pIt,_It,gIt,fIt,mIt,yIt,vIt,bIt,wIt,SIt,xIt,TIt,CIt,IIt,EIt,DIt=Object.freeze({__proto__:null,bezier:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return tIt(1,e)},catmullRom:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return tIt(2,e)}});t("tweenProgress",DIt);class AIt{constructor(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1}}class MIt{constructor(){this._hashTargets=new Map,this._arrayTargets=[],this._currentTarget=void 0,this._elementPool=[]}_getElement(t,e){let i=this._elementPool.pop();return i||(i=new AIt),i.target=t,i.paused=!!e,i}_putElement(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)}_onNodeActiveChanged(t,e){e?this.resumeTarget(t):this.pauseTarget(t)}_onNodeDestroy(t){this._removeAllActionsFromTarget(t,!1)}_registerNodeEvent(t){t.isValid&&(t.on("active-changed",this._onNodeActiveChanged,this),t.on("node-destroyed",this._onNodeDestroy,this))}_unregisterNodeEvent(t){t.isValid&&(t.off("active-changed",this._onNodeActiveChanged,this),t.off("node-destroyed",this._onNodeDestroy,this))}addAction(t,e,i){if(!t||!e)return void j(1e3);let s=this._hashTargets.get(e);s?s.actions||(s.actions=[]):(s=this._getElement(e,i),this._hashTargets.set(e,s),this._arrayTargets.push(s)),0===s.actions.length&&e instanceof JS&&this._registerNodeEvent(e),s.target=e,s.actions.push(t),t.startWithTarget(e)}removeAllActions(){const t=this._arrayTargets;for(let e=0;e<t.length;e++){const i=t[e];i&&(i.target instanceof JS&&this._unregisterNodeEvent(i.target),this._putElement(i))}this._arrayTargets.length=0,this._hashTargets=new Map}removeAllActionsFromTarget(t){this._removeAllActionsFromTarget(t,!0)}_removeAllActionsFromTarget(t,e){if(null==t)return;const i=this._hashTargets.get(t);i&&(e&&t instanceof JS&&this._unregisterNodeEvent(t),i.actions.length=0,this._deleteHashElement(i))}removeAction(t){if(null==t)return;const e=t.getOriginalTarget(),i=this._hashTargets.get(e);if(i)for(let e=0;e<i.actions.length;e++)if(i.actions[e]===t){i.actions.splice(e,1),i.actionIndex>=e&&i.actionIndex--;break}}_removeActionByTag(t,e,i){for(let s=0,r=e.actions.length;s<r;++s){const r=e.actions[s];if(r&&r.getTag()===t){if(i&&r.getOriginalTarget()!==i)continue;this._removeActionAtIndex(s,e);break}}}_removeAllActionsByTag(t,e,i){for(let s=e.actions.length-1;s>=0;--s){const r=e.actions[s];if(r&&r.getTag()===t){if(i&&r.getOriginalTarget()!==i)continue;this._removeActionAtIndex(s,e)}}}removeActionByTag(t,e){-1===t&&N(1002);const i=this._hashTargets;if(e){const s=i.get(e);s&&this._removeActionByTag(t,s,e)}else i.forEach((e=>{this._removeActionByTag(t,e)}))}removeAllActionsByTag(t,e){-1===t&&N(1002);const i=this._hashTargets;if(e){const s=i.get(e);s&&this._removeAllActionsByTag(t,s,e)}else i.forEach((e=>{this._removeAllActionsByTag(t,e)}))}getActionByTag(t,e){-1===t&&N(1004);const i=this._hashTargets.get(e);if(i){if(null!=i.actions)for(let e=0;e<i.actions.length;++e){const s=i.actions[e];if(s&&s.getTag()===t)return s}N(1005,t)}return null}getNumberOfRunningActionsInTarget(t){const e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0}pauseTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!0)}resumeTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!1)}pauseAllRunningActions(){const t=[],e=this._arrayTargets;for(let i=0;i<e.length;i++){const s=e[i];s&&!s.paused&&(s.paused=!0,s.target&&t.push(s.target))}return t}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])}pauseTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])}isActionRunning(t){const e=this._hashTargets.get(t.getOriginalTarget());let i=-1;return e&&(i=e.actions.indexOf(t)),-1!==i}_removeActionAtIndex(t,e){e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&(e.target instanceof JS&&this._unregisterNodeEvent(e.target),this._deleteHashElement(e))}_deleteHashElement(t){let e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);const i=this._arrayTargets;for(let e=0,s=i.length;e<s;e++)if(i[e]===t){i.splice(e,1);break}this._putElement(t),e=!0}return e}update(t){const e=this._arrayTargets;let i;for(let s=0;s<e.length;s++){this._currentTarget=e[s],i=this._currentTarget;const r=i.target;if(!vn(r)||r.isValid){if(!i.paused&&i.actions){for(i.lock=!0,i.actionIndex=0;i.actionIndex<i.actions.length;i.actionIndex++)if(i.currentAction=i.actions[i.actionIndex],i.currentAction){if(i.currentAction.step(t),i.currentAction&&i.currentAction.isDone()){i.currentAction.stop();const t=i.currentAction;i.currentAction=null,this.removeAction(t)}i.currentAction=null}i.lock=!1}0===i.actions.length&&(r instanceof JS&&this._unregisterNodeEvent(r),this._deleteHashElement(i)&&s--)}else this.removeAllActionsFromTarget(r),s--}}}class PIt extends su{get ActionManager(){return this.actionMgr}constructor(){super(),this.actionMgr=new MIt}update(t){this.actionMgr.update(t)}}t("TweenSystem",PIt),PIt.ID="TWEEN",PIt.instance=void 0,uP.on("director_init",(()=>{const t=new PIt;PIt.instance=t,uP.registerSystem(PIt.ID,t,su.Priority.MEDIUM)}));class BIt{constructor(){this.originalTarget=null,this.target=null,this._owner=null,this.tag=-1,this._id=void 0,this._paused=!1}isDone(){return!0}startWithTarget(t){this.originalTarget=t,this.target=t}stop(){this.target=null}getTarget(){return this.target}setTarget(t){this.target=t}getOriginalTarget(){return this.originalTarget}setOriginalTarget(t){this.originalTarget=t}_getWorkerTarget(){var t;const e=null===(t=this._owner)||void 0===t?void 0:t.getTarget();return null!=e?e:this.target}getTag(){return this.tag}setTag(t){this.tag=t}setId(t){this._id=t}getId(){return this._id}setPaused(t){this._paused=t}}class RIt extends BIt{constructor(){super(),this._duration=0}getDurationScaled(){return this._duration}getDuration(){return this._duration}setDuration(t){this._duration=t}}class OIt extends RIt{isDone(){return!0}step(t){this.update(1)}update(t){}reverse(){return this.clone()}isUnknownDuration(){return!1}}class LIt extends OIt{update(t){const e=this._getWorkerTarget();if(!e)return;const i=e.getComponentsInChildren(EO);for(let t=0;t<i.length;++t)i[t].enabled=!0}reverse(){return new FIt}clone(){const t=new LIt;return t._id=this._id,t}}class FIt extends OIt{update(t){const e=this._getWorkerTarget();if(!e)return;const i=e.getComponentsInChildren(EO);for(let t=0;t<i.length;++t)i[t].enabled=!1}reverse(){return new LIt}clone(){const t=new FIt;return t._id=this._id,t}}class zIt extends OIt{constructor(t){super(),this._isNeedCleanUp=!0,void 0!==t&&this.init(t)}update(t){const e=this._getWorkerTarget();e&&(e.removeFromParent(),this._isNeedCleanUp&&e.destroy())}init(t){return this._isNeedCleanUp=t,!0}reverse(){return new zIt(this._isNeedCleanUp)}clone(){const t=new zIt(this._isNeedCleanUp);return t._id=this._id,t}}function kIt(t){return new zIt(t)}class NIt extends OIt{constructor(t,e,i){super(),this._callbackThis=void 0,this._callback=void 0,this._data=void 0,this.initWithFunction(t,e,i)}initWithFunction(t,e,i){return t&&(this._callback=t),e&&(this._callbackThis=e),void 0!==i&&(this._data=i),!0}execute(){if(this._callback){const t=this._getWorkerTarget();this._callback.call(this._callbackThis,t,this._data)}}update(t){this.execute()}getTargetCallback(){return this._callbackThis}setTargetCallback(t){t!==this._callbackThis&&(this._callbackThis=t)}clone(){const t=new NIt;return t._id=this._id,this._callback&&t.initWithFunction(this._callback,this._callbackThis,this._data),t}}function UIt(t,e,i){return new NIt(t,e,i)}class VIt extends RIt{clone(){return new VIt}reverse(){return this.clone()}update(t){}step(t){}isUnknownDuration(){return!1}}class HIt extends RIt{constructor(t){super(),this.MAX_VALUE=2,this._elapsed=0,this._startTime=0,this._firstTick=!1,this._speed=1,void 0===t||Number.isNaN(t)||this.initWithDuration(t)}setStartTime(t){t=t<0?0:t>this._duration?this._duration:t,this._startTime=t}getElapsed(){return this._elapsed}initWithDuration(t){return this._duration=0===t?le.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0}isDone(){return this._elapsed>=this._duration}_cloneDecoration(t){t._speed=this._speed}step(t){if(this._paused||0===this._speed)return;t*=this._speed,this._firstTick?this._elapsed=this._startTime:this._elapsed+=t;let e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this.isUnknownDuration()&&!this._firstTick&&(this._elapsed-=t),this._firstTick&&(this._firstTick=!1,this._startTime>0&&(this._startTime=0))}startWithTarget(t){super.startWithTarget(t),this._elapsed=0,this._firstTick=!0}getSpeed(){return this._speed}setSpeed(t){this._speed=t}getDurationScaled(){return this._duration/this._speed}}class GIt extends HIt{static _actionOneTwo(t,e){const i=new GIt;return i.initWithTwoActions(t,e),i}constructor(t){if(super(),this._actions=[],this._split=0,this._last=0,this._reversed=!1,!t||0===t.length)return;1===t.length&&t.push(new VIt);const e=t.length-1;if(e>=0&&null==t[e]&&N(1015),e>=0){let i,s=t[0];for(let r=1;r<e;r++)t[r]&&(i=s,s=GIt._actionOneTwo(i,t[r]));this.initWithTwoActions(s,t[e])}}initWithTwoActions(t,e){if(!t||!e)return j(1025),!1;const i=t.getDurationScaled()+e.getDurationScaled();return this.initWithDuration(i),this._actions[0]=t,this._actions[1]=e,!0}clone(){const t=new GIt;return t._id=this._id,t._speed=this._speed,this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t}startWithTarget(t){super.startWithTarget(t),0!==this._actions.length&&(this._split=this._actions[0].getDurationScaled()/this._duration,this._last=-1)}stop(){0!==this._actions.length&&(-1!==this._last&&this._actions[this._last].stop(),super.stop())}update(t){const e=this._actions;if(0===e.length)return;let i=0,s=0;const r=this._split,n=this._last;if(t<r){if(i=0!==r?t/r:1,0===s&&1===n&&this._reversed){const t=e[1];if(t.update(0),t.isUnknownDuration())return;t.stop()}}else{const o=e[0];if(s=1,i=1===r?1:(t-r)/(1-r),-1===n){if(o.startWithTarget(this.target),o.update(1),o.isUnknownDuration())return;o.stop()}if(0===n){if(o.update(1),o.isUnknownDuration())return;o.stop()}}const o=e[s];n===s&&o.isDone()||(n!==s&&o.startWithTarget(this.target),o.update(i>1?i%1:i),this._last=s)}reverse(){const t=GIt._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),t._reversed=!0,t}updateOwner(t){if(this._actions.length<2)return;const e=this._actions[0],i=this._actions[1];i._owner||(i._owner=t),e instanceof GIt||e instanceof YIt?e.updateOwner(t):e._owner||(e._owner=t)}findAction(t){for(let e=0,i=this._actions.length;e<i;++e){let i=this._actions[e];if(i.getId()===t)return i;if((i instanceof GIt||i instanceof YIt)&&(i=i.findAction(t),i&&i.getId()===t))return i}return null}isUnknownDuration(){if(0===this._actions.length)return!1;const t=this._actions[0],e=this._actions[1];return this._last<1?t.isUnknownDuration():e.isUnknownDuration()}}function WIt(t){return new GIt(t)}class jIt extends HIt{constructor(t,e){super(),this._times=0,this._total=0,this._nextDt=0,this._actionInstant=!1,this._innerAction=null,this.initWithAction(t,e)}initWithAction(t,e){if(!t||void 0===e)return!1;const i=t.getDurationScaled()*e;return!!this.initWithDuration(i)&&(this._times=e,this._innerAction=t,t instanceof OIt&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}clone(){const t=new jIt;return t._id=this._id,t._speed=this._speed,this._cloneDecoration(t),this._innerAction&&t.initWithAction(this._innerAction.clone(),this._times),t}startWithTarget(t){this._total=0,this._nextDt=(this._innerAction?this._innerAction.getDurationScaled():0)/this._duration,super.startWithTarget(t),this._innerAction&&this._innerAction.startWithTarget(t)}stop(){this._innerAction&&this._innerAction.stop(),super.stop()}update(t){const e=this._innerAction,i=this._duration,s=this._times;let r=this._nextDt;if(e)if(t>=r){for(;t>r&&this._total<s;){if(e.update(1),e.isUnknownDuration())return;this._total++,e.stop(),e.startWithTarget(this.target),r+=e.getDurationScaled()/i,this._nextDt=r>1?1:r}if(t>=1&&this._total<s){if(e.update(1),e.isUnknownDuration())return;this._total++}this._actionInstant||(this._total===s?e.stop():e.update(t-(r-e.getDurationScaled()/i)))}else e.update(t*s%1)}isDone(){return this._total===this._times}reverse(){const t=this._innerAction?this._innerAction.reverse():void 0,e=new jIt(t,this._times);return this._cloneDecoration(e),e}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}isUnknownDuration(){return!!this._innerAction&&this._innerAction.isUnknownDuration()}}function $It(t,e){return new jIt(t,e)}class qIt extends HIt{constructor(t){super(),this._innerAction=null,t&&this.initWithAction(t)}initWithAction(t){return t?(this._innerAction=t,this._duration=1/0,!0):(j(1026),!1)}clone(){const t=new qIt;return t._id=this._id,t._speed=this._speed,this._cloneDecoration(t),this._innerAction&&t.initWithAction(this._innerAction.clone()),t}startWithTarget(t){super.startWithTarget(t),this._innerAction&&this._innerAction.startWithTarget(t)}stop(){this._innerAction&&this._innerAction.stop(),super.stop()}step(t){if(this._paused||0===this._speed)return;const e=this._innerAction;e&&(t*=this._speed,e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e.getDurationScaled())))}update(t){N(1007)}isDone(){return!1}reverse(){if(this._innerAction){const t=new qIt(this._innerAction.reverse());return this._cloneDecoration(t),t}return this}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}isUnknownDuration(){return!!this._innerAction&&this._innerAction.isUnknownDuration()}}function XIt(t){return new qIt(t)}class YIt extends HIt{static _actionOneTwo(t,e){const i=new YIt;return i.initWithTwoActions(t,e),i}constructor(t){if(super(),this._one=null,this._two=null,this._finished=!1,!t||0===t.length)return;1===t.length&&t.push(new VIt);const e=t.length-1;if(e>=0&&null==t[e]&&N(1015),e>=0){let i,s=t[0];for(let r=1;r<e;r++)t[r]&&(i=s,s=YIt._actionOneTwo(i,t[r]));this.initWithTwoActions(s,t[e])}}initWithTwoActions(t,e){if(!t||!e)return j(1027),!1;let i=!1;const s=t.getDurationScaled(),r=e.getDurationScaled();return this.initWithDuration(Math.max(s,r))&&(this._one=t,this._two=e,s>r?this._two=GIt._actionOneTwo(e,KIt(s-r)):s<r&&(this._one=GIt._actionOneTwo(t,KIt(r-s))),i=!0),i}clone(){const t=new YIt;return t._id=this._id,t._speed=this._speed,this._cloneDecoration(t),this._one&&this._two&&t.initWithTwoActions(this._one.clone(),this._two.clone()),t}startWithTarget(t){super.startWithTarget(t),this._one&&this._one.startWithTarget(t),this._two&&this._two.startWithTarget(t)}stop(){this._one&&this._one.stop(),this._two&&this._two.stop(),super.stop()}update(t){this._one&&(this._finished&&!this._one.isUnknownDuration()||this._one.update(t)),this._two&&(this._finished&&!this._two.isUnknownDuration()||this._two.update(t)),this._finished=1===t}reverse(){if(this._one&&this._two){const t=YIt._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),t}return this}updateOwner(t){if(!this._one||!this._two)return;this._two._owner||(this._two._owner=t);const e=this._one;e instanceof YIt||e instanceof GIt?e.updateOwner(t):e._owner||(e._owner=t)}findAction(t){const e=this._one,i=this._two;let s=null;const r=e=>{if(e.getId()===t)return e;if(e instanceof GIt||e instanceof YIt){const i=e.findAction(t);if(i)return i}return null};return e&&(s=r(e),s)||i&&(s=r(i),s)?s:null}isUnknownDuration(){const t=this._one,e=this._two;if(null==t||null==e)return!1;const i=t.isUnknownDuration(),s=e.isUnknownDuration();if(i||s){if(i&&s)return!0;if(this._finished)return!0}return!1}}class QIt extends HIt{update(t){}reverse(){const t=new QIt(this._duration);return this._cloneDecoration(t),t}clone(){const t=new QIt;return t._id=this._id,t._speed=this._speed,this._cloneDecoration(t),t.initWithDuration(this._duration),t}isUnknownDuration(){return!1}}function KIt(t){return new QIt(t)}class ZIt extends HIt{constructor(t){super(),this._other=null,t&&this.initWithAction(t)}initWithAction(t){return t?t===this._other?(j(1029),!1):!!super.initWithDuration(t.getDurationScaled())&&(this._other=t,!0):(j(1028),!1)}clone(){const t=new ZIt;return t._id=this._id,t._speed=this._speed,this._cloneDecoration(t),this._other&&t.initWithAction(this._other.clone()),t}startWithTarget(t){super.startWithTarget(t),this._other&&this._other.startWithTarget(t)}update(t){this._other&&this._other.update(1-t)}reverse(){return this._other?this._other.clone():this}stop(){this._other&&this._other.stop(),super.stop()}isUnknownDuration(){return!1}}function JIt(t){return new ZIt(t)}class tEt extends HIt{constructor(t,e,i){super(t),this._cb=e,this._args=i}clone(){return new tEt(this._duration,this._cb,this._args)}update(t){this._cb(this.target,t,...this._args)}reverse(){return this.clone()}isUnknownDuration(){return!1}}class eEt extends RIt{constructor(t,e){super(),this._finished=!1,this._cb=t,this._args=e}clone(){return new eEt(this._cb,this._args)}reverse(){return this.clone()}step(t){throw new Error("should never go here")}update(t){const e=h.game.deltaTime;this._finished=this._cb(this.target,e,...this._args)}isDone(){return this._finished}isUnknownDuration(){return!this.isDone()}}function iEt(t){const e=t.charAt(0);if(/[A-Z]/.test(e)){const i=(t=t.replace(e,e.toLowerCase())).split("-");if(2===i.length){const e=i[0];if("linear"===e)t="linear";else{const s=i[1];switch(e){case"quadratic":t=`quad${s}`;break;case"quartic":t=`quart${s}`;break;case"quintic":t=`quint${s}`;break;case"sinusoidal":t=`sine${s}`;break;case"exponential":t=`expo${s}`;break;case"circular":t=`circ${s}`;break;default:t=e+s}}}}return t}function sEt(t){const e=" [Tween:] ",i=` option is not support in v + ${c}`,s=t;s.delay&&P(`${e}delay${i}`),s.repeat&&P(`${e}repeat${i}`),s.repeatDelay&&P(`${e}repeatDelay${i}`),s.interpolation&&P(`${e}interpolation${i}`),s.onStop&&P(`${e}onStop${i}`)}class rEt extends HIt{constructor(t,e,i){if(super(),this._reversed=!1,null==i)i=Object.create(null);else if(sEt(i),i.easing&&"string"==typeof i.easing&&(i.easing=iEt(i.easing)),i.progress||(i.progress=this.progress),i.easing&&"string"==typeof i.easing){const t=i.easing;i.easing=Kh[t],i.easing||G(1031,t)}this._opts=i,this._props=Object.create(null);for(const t in e){var s;if(!e.hasOwnProperty(t))continue;let i,r,n,o=e[t];if("function"==typeof o)o=o();else if(null==o)continue;void 0!==o.value?(n=o.value,"function"==typeof n&&(n=n()),void 0!==o.easing&&("string"==typeof o.easing?(i=Kh[o.easing],i||G(1031,o.easing)):i=o.easing),void 0!==o.progress&&(r=o.progress)):n=o;const a=Object.create(null);a.start=a.current=a.end=null,a.keys=null,a.value=n,a.easing=i,a.progress=r,a.convert=o.convert,a.clone=o.clone,a.add=o.add,a.sub=o.sub,a.legacyProgress=null===(s=o.legacyProgress)||void 0===s||s,a.toFixed=o.toFixed,a.onStart=o.onStart,a.onStop=o.onStop,a.onComplete=o.onComplete,a.valid=!0,this._props[t]=a}this._originProps=e,this.initWithDuration(t)}get relative(){return!!this._opts.relative}clone(){const t=new rEt(this._duration,this._originProps,this._opts);return t._reversed=this._reversed,t._owner=this._owner,t._id=this._id,this._cloneDecoration(t),t}reverse(){if(!this._opts.relative)return G(16382),new rEt(0,{});const t=new rEt(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t._reversed=!this._reversed,t._owner=this._owner,t}startWithTarget(t){super.startWithTarget(t);const e=this._getWorkerTarget();if(!e)return;const i=!!this._opts.relative,s=this._props,r=this._reversed;for(const t in s){const n=e[t];if(void 0===n)continue;const o=s[t],a=o.value;if("number"==typeof n)o.start=n,o.current=n,o.end=i?r?n-a:n+a:a;else if("object"==typeof n)if(o.legacyProgress){if(null==o.start){const t=n.constructor;o.start=new t,o.current=new t,o.end=new t}let t;t=a.getModifiableProperties?a.getModifiableProperties():Object.keys(a),o.keys=t;for(let e=0,s=t.length;e<s;++e){const s=t[e];isNaN(n[s])||(o.start[s]=n[s],o.current[s]=n[s],o.end[s]=i?r?n[s]-a[s]:n[s]+a[s]:a[s])}}else{const e=o.clone;if(!e){G(16383,t),o.valid=!1;continue}{const s=o.add,h=o.sub;if(i&&(s||(G(16384,t),o.valid=!1),r&&!h&&(G(16385,t),o.valid=!1),!o.valid))continue;o.start=e(n),o.current=e(n),o.end=i?r?h(n,a):s(n,a):e(a)}}else if("string"==typeof n){const t=o.convert,e=e=>{if("number"==typeof e)return e;let i=e;return t&&(i=t(e)),"number"!=typeof i&&(i=Number(i),Number.isNaN(i))?(G(16386,`${e}`),null):i},s=e(a),h=e(n);if(null==s||null==h){o.valid=!1;continue}o.start=h,o.current=n,o.end=i?r?h-s:h+s:s}o.onStart&&o.onStart({relative:i,reversed:r,start:o.start,end:o.end})}this._opts.onStart&&this._opts.onStart(e)}stop(){const t=this._props;for(const e in t){const i=t[e];i.valid&&i.onStop&&i.onStop()}super.stop()}update(t){const e=this._getWorkerTarget();if(!e)return;if(!this._opts)return;const i=this._props,s=this._opts;let r=t;"function"==typeof s.easing&&(r=s.easing(t));const n=s.progress;for(const s in i){const a=i[s];if(!a.valid)continue;const h=a.easing?a.easing(t):r,l=a.progress?a.progress:n,c=a.start,u=a.end,d=a.current;if("number"==typeof d)a.current=l(c,u,a.current,h);else if("object"==typeof c)if(a.legacyProgress){const t=a.keys;for(let e=0,i=t.length;e<i;++e){const i=t[e];a.current[i]=l(c[i],u[i],a.current[i],h)}}else a.current=l(c,u,a.current,h);else if("string"==typeof d){let t=l(c,u,a.current,h);var o;if("number"==typeof t)t=t.toFixed(null!==(o=a.toFixed)&&void 0!==o?o:0);else if("string"!=typeof t){G(16387);continue}a.current=t}e[s]=a.current,1===t&&a.onComplete&&a.onComplete()}s.onUpdate&&s.onUpdate(e,t),1===t&&s.onComplete&&s.onComplete(e)}progress(t,e,i,s){return t+(e-t)*s}isUnknownDuration(){return!1}}t("TweenAction",rEt);class nEt extends OIt{constructor(t){super(),this._props=void 0,this._props={},t&&this.init(t)}init(t){for(const e in t)this._props[e]=t[e];return!0}update(){const t=this._props,e=this.target;for(const i in t)e[i]=t[i]}clone(){const t=new nEt;return t._id=this._id,t.init(this._props),t}isUnknownDuration(){return!1}}class oEt{constructor(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=-1,this._timeScale=1,this._target=void 0===t?null:t}tag(t){return this._tag=t,this}id(t){return this._actions.length>0&&this._actions[this._actions.length-1].setId(t),this}then(t){const e=t._union(!0);return e&&(e.setSpeed(t._timeScale),this._actions.push(e)),this}reverse(t,e){if(null==t&&null==e)return this.reverseTween();let i,s;if(t instanceof oEt?(i=t,void 0!==e&&(s=e)):"number"==typeof t&&(i=this,s=t),i){const t=oEt.reverseAction(i,s);t&&this._actions.push(t)}return this}reverseTween(){if(0===this._actions.length)return G(16388),this.clone(this._target);const t=this._union(!1),e=aEt(this._target);return e._timeScale=this._timeScale,t&&e.insertAction(t.reverse()),e}static reverseAction(t,e){const i=t._actions;if(0===i.length)return null;let s=null,r=null;return"number"==typeof e?s=t.findAction(e,i):t&&(s=t._union(!1)),s?(r=s.reverse(),r._owner=t):G(16391,`${e}`),r}findAction(t,e){let i=null;for(let s=0,r=e.length;s<r;++s){if(i=e[s],i.getId()===t)return i;if((i instanceof GIt||i instanceof YIt)&&(i=i.findAction(t),i))return i}return null}insertAction(t){const e=t.clone();return this.updateOwnerForAction(e),this._actions.push(e),this}updateOwnerForAction(t){t&&(t instanceof GIt||t instanceof YIt?t.updateOwner(this):t._owner||(t._owner=this))}target(t){return this._target=t,this}getTarget(){return this._target}start(t){if(void 0===t&&(t=0),!this._target)return G(16392),this;this._finalAction&&PIt.instance.ActionManager.removeAction(this._finalAction);const e=this._unionForStart();return this._finalAction=e,e?(e.setTag(this._tag),e.setSpeed(this._timeScale),e.setStartTime(t),e.setPaused(!1),PIt.instance.ActionManager.addAction(e,this._target,!1)):G(16393),this}stop(){return this._finalAction&&(this._finalAction.stop(),PIt.instance.ActionManager.removeAction(this._finalAction),this._finalAction=null),this}pause(){return this._finalAction?this._finalAction.setPaused(!0):G(16389),this}resume(){return this._finalAction?this._finalAction.setPaused(!1):G(16390),this}get running(){return!!this._finalAction&&PIt.instance.ActionManager.isActionRunning(this._finalAction)}clone(t){const e=this._union(!1),i=aEt(null!=t?t:this._target);return i._timeScale=this._timeScale,e?i.insertAction(e):i}union(t){if(void 0===t)return(()=>{const t=this._union(!1);this._actions.length=0,t&&this._actions.push(t)})(),this;const e=this._actions,i=e.findIndex((e=>e.getId()===t));if(e.length>1){const t=e.splice(i);1===t.length?e.push(t[0]):e.push(WIt(t))}return this}to(t,e,i){const s=i||Object.create(null);s.relative=!1;const r=new rEt(t,e,s);return this._actions.push(r),this}by(t,e,i){const s=i||Object.create(null);s.relative=!0;const r=new rEt(t,e,s);return this._actions.push(r),this}update(t,e){for(var i=arguments.length,s=new Array(i>2?i-2:0),r=2;r<i;r++)s[r-2]=arguments[r];const n=new tEt(t,e,s);return this._actions.push(n),this}updateUntil(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];const r=new eEt(t,i);return this._actions.push(r),this}set(t){const e=new nEt(t);return this._actions.push(e),this}delay(t){const e=KIt(t);return this._actions.push(e),this}call(t,e,i){const s=UIt(t,e,i);return this._actions.push(s),this}sequence(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=oEt._wrappedSequence(e);return s&&this._actions.push(s),this}parallel(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=oEt._wrappedParallel(e);return s&&this._actions.push(s),this}timeScale(t){return this._timeScale=t,this._finalAction&&this._finalAction.setSpeed(t),this}getTimeScale(){return this._timeScale}get duration(){return this._finalAction?this._finalAction.getDuration():0}repeat(t,e){if(t===1/0)return this.repeatForever(e);const i=this._actions;let s;return s=e instanceof oEt?e._union(!1):i.pop(),s&&i.push($It(s,t)),this}repeatForever(t){const e=this._actions;let i;return i=t instanceof oEt?t._union(!1):e.pop(),i&&0!==e.length?e.push($It(i,Number.MAX_SAFE_INTEGER)):i instanceof HIt?e.push(XIt(i)):G(16394),this}reverseTime(t){const e=this._actions;let i;return i=t instanceof oEt?t._union(!1):e.pop(),i instanceof HIt?e.push(JIt(i)):G(16395),this}hide(){if(this._target instanceof JS){const t=new FIt;this._actions.push(t)}return this}show(){if(this._target instanceof JS){const t=new LIt;this._actions.push(t)}return this}removeSelf(){if(this._target instanceof JS){const t=kIt(!1);this._actions.push(t)}return this}destroySelf(){if(this._target instanceof JS){const t=kIt(!0);this._actions.push(t)}return this}static getRunningCount(t){return PIt.instance.ActionManager.getNumberOfRunningActionsInTarget(t)}static stopAll(){PIt.instance.ActionManager.removeAllActions()}static stopAllByTag(t,e){PIt.instance.ActionManager.removeAllActionsByTag(t,e)}static stopAllByTarget(t){PIt.instance.ActionManager.removeAllActionsFromTarget(t)}static pauseAllByTarget(t){PIt.instance.ActionManager.pauseTarget(t)}static resumeAllByTarget(t){PIt.instance.ActionManager.resumeTarget(t)}_union(t){const e=this._actions;if(0===e.length)return null;const i=WIt(e);return t&&this.updateOwnerForAction(i),i}_unionForStart(){const t=this._actions;if(0===t.length)return null;let e;return e=1===t.length&&t[0]instanceof qIt?t[0]:WIt(t),e}static _tweenToActions(t){const e=oEt._tmpArgs;e.length=0;for(let i=t.length,s=0;s<i;s++){const i=t[s],r=i._union(!0);r&&(r.setSpeed(i._timeScale),e.push(r))}}static _wrappedSequence(t){oEt._tweenToActions(t);const e=WIt(oEt._tmpArgs);return this._tmpArgs.length=0,e}static _wrappedParallel(t){oEt._tweenToActions(t);const e=(i=oEt._tmpArgs,new YIt(i));var i;return this._tmpArgs.length=0,e}}function aEt(t){return new oEt(t)}function hEt(t){return G(16396),new oEt(t)}t("Tween",oEt),oEt._tmpArgs=[],l.Tween=oEt,l.tween=aEt,l.tweenUtil=hEt;const lEt=new _r,cEt={NONE:0,COLOR:1,SPRITE:2,SCALE:3};se(cEt);const uEt={CLICK:"click"};let dEt=t("Button",(eIt=oa("cc.Button"),iIt=ha(110),sIt=aa(pO),rIt=Ga(JS),nIt=Ga(cEt),oIt=Ga(yB),aIt=Ga(yB),hIt=Ga(yB),lIt=Ga(yB),cIt=Ga([yg]),eIt(uIt=iIt(uIt=sIt((EIt=class extends Ag{get target(){return this._target||this.node}set target(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}get interactable(){return this._interactable}set interactable(t){this._interactable!==t&&(this._interactable=t,this._updateState(),this._interactable||this._resetState())}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get transition(){return this._transition}set transition(t){this._transition!==t&&(1===this._transition?this._updateColorTransition(0):2===this._transition&&this._updateSpriteTransition(0),this._transition=t,this._updateState())}get normalColor(){return this._normalColor}set normalColor(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}get pressedColor(){return this._pressedColor}set pressedColor(t){this._pressedColor!==t&&this._pressedColor.set(t)}get hoverColor(){return this._hoverColor}set hoverColor(t){this._hoverColor!==t&&this._hoverColor.set(t)}get disabledColor(){return this._disabledColor}set disabledColor(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}get duration(){return this._duration}set duration(t){this._duration!==t&&(this._duration=t)}get zoomScale(){return this._zoomScale}set zoomScale(t){this._zoomScale!==t&&(this._zoomScale=t)}get normalSprite(){return this._normalSprite}set normalSprite(t){if(this._normalSprite===t)return;this._normalSprite=t;const e=this.node.getComponent(ZF);e&&(e.spriteFrame=t),this._updateState()}get pressedSprite(){return this._pressedSprite}set pressedSprite(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}get hoverSprite(){return this._hoverSprite}set hoverSprite(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}get disabledSprite(){return this._disabledSprite}set disabledSprite(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}constructor(){super(),this.clickEvents=pIt&&pIt(),this._interactable=_It&&_It(),this._transition=gIt&&gIt(),this._normalColor=fIt&&fIt(),this._hoverColor=mIt&&mIt(),this._pressedColor=yIt&&yIt(),this._disabledColor=vIt&&vIt(),this._normalSprite=bIt&&bIt(),this._hoverSprite=wIt&&wIt(),this._pressedSprite=SIt&&SIt(),this._disabledSprite=xIt&&xIt(),this._duration=TIt&&TIt(),this._zoomScale=CIt&&CIt(),this._target=IIt&&IIt(),this._pressed=!1,this._hovered=!1,this._fromColor=new _r,this._toColor=new _r,this._time=0,this._transitionFinished=!0,this._fromScale=Zi(),this._toScale=Zi(),this._originalScale=null,this._sprite=null,this._targetScale=Zi()}__preload(){this.target||(this.target=this.node),this._applyTarget(),this._resetState()}onEnable(){this._registerNodeEvent()}onDisable(){this._resetState(),this._unregisterNodeEvent()}onDestroy(){this.target.isValid&&this._unregisterTargetEvent(this.target)}update(t){const e=this.target;if(this._transitionFinished||!e)return;if(1!==this._transition&&3!==this._transition)return;this._time+=t;let i=1;if(this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1),1===this._transition){const t=e._uiProps.uiComp;_r.lerp(lEt,this._fromColor,this._toColor,i),t&&(t.color=lEt)}else 3===this.transition&&(e.getScale(this._targetScale),this._targetScale.x=yi(this._fromScale.x,this._toScale.x,i),this._targetScale.y=yi(this._fromScale.y,this._toScale.y,i),e.setScale(this._targetScale));1===i&&(this._transitionFinished=!0)}_resizeNodeToTargetNode(){this.target&&this.target._uiProps.uiTransformComp}_resetState(){this._pressed=!1,this._hovered=!1;const t=this.target;if(!t)return;const e=this._transition;if(1===e&&this._interactable){const e=t.getComponent(VO);e&&(e.color=this._normalColor)}else 3===e&&this._originalScale&&t.setScale(this._originalScale);this._transitionFinished=!0}_registerNodeEvent(){this.node.on("touch-start",this._onTouchBegan,this),this.node.on("touch-move",this._onTouchMove,this),this.node.on("touch-end",this._onTouchEnded,this),this.node.on("touch-cancel",this._onTouchCancel,this),this.node.on("mouse-enter",this._onMouseMoveIn,this),this.node.on("mouse-leave",this._onMouseMoveOut,this),this.node.on("xrui-hover-entered",this._xrHoverEnter,this),this.node.on("xrui-hover-exited",this._xrHoverExit,this),this.node.on("xrui-click",this._xrClick,this),this.node.on("xrui-unclick",this._xrUnClick,this)}_registerTargetEvent(t){t.on("transform-changed",this._onTargetTransformChanged,this)}_unregisterNodeEvent(){this.node.off("touch-start",this._onTouchBegan,this),this.node.off("touch-move",this._onTouchMove,this),this.node.off("touch-end",this._onTouchEnded,this),this.node.off("touch-cancel",this._onTouchCancel,this),this.node.off("mouse-enter",this._onMouseMoveIn,this),this.node.off("mouse-leave",this._onMouseMoveOut,this),this.node.off("xrui-hover-entered",this._xrHoverEnter,this),this.node.off("xrui-hover-exited",this._xrHoverExit,this),this.node.off("xrui-click",this._xrClick,this),this.node.off("xrui-unclick",this._xrUnClick,this)}_unregisterTargetEvent(t){t.off("transform-changed")}_getTargetSprite(t){let e=null;return t&&(e=t.getComponent(ZF)),e}_applyTarget(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new Ki),Ki.copy(this._originalScale,this.target.scale),this._registerTargetEvent(this.target))}_onTargetSpriteFrameChanged(t){2===this._transition&&this._setCurrentStateSpriteFrame(t.spriteFrame)}_setCurrentStateSpriteFrame(t){if(t)switch(this._getButtonState()){case 0:this._normalSprite=t;break;case 1:this._hoverSprite=t;break;case 2:this._pressedSprite=t;break;case 3:this._disabledSprite=t}}_onTargetColorChanged(t){1===this._transition&&this._setCurrentStateColor(t)}_setCurrentStateColor(t){switch(this._getButtonState()){case 0:this._normalColor=t;break;case 1:this._hoverColor=t;break;case 2:this._pressedColor=t;break;case 3:this._disabledColor=t}}_onTargetTransformChanged(t){4&t&&this._originalScale&&3===this._transition&&this._transitionFinished&&Ki.copy(this._originalScale,this.target.scale)}_onTouchBegan(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchMove(t){if(!this._interactable||!this.enabledInHierarchy||!this._pressed)return;if(!t)return;const e=t.touch;if(!e)return;const i=this.node._uiProps.uiTransformComp.hitTest(e.getLocation(),t.windowId);if(3===this._transition&&this.target&&this._originalScale)i?(Ki.copy(this._fromScale,this._originalScale),Ki.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale));else{let t;t=i?2:0,this._applyTransition(t)}t&&(t.propagationStopped=!0)}_onTouchEnded(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(yg.emitEvents(this.clickEvents,t),this.node.emit("click",this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchCancel(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}_onMouseMoveIn(t){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(2!==this._transition||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}_onMouseMoveOut(t){this._hovered&&(this._hovered=!1,this._updateState())}_updateState(){const t=this._getButtonState();this._applyTransition(t)}_getButtonState(){let t=0;return this._interactable?this._pressed?t=2:this._hovered&&(t=1):t=3,t}_updateColorTransition(t){var e;const i=this._getColorByState(t),s=null===(e=this.target)||void 0===e?void 0:e.getComponent(VO);s&&(3===t?(s.color=i,this._transitionFinished=!0):(this._fromColor=s.color.clone(),this._toColor=i,this._time=0,this._transitionFinished=!1))}_updateSpriteTransition(t){const e=this._getSpriteFrameByState(t);this._sprite&&e&&(this._sprite.spriteFrame=e)}_updateScaleTransition(t){this._interactable&&(2===t?this._zoomUp():this._zoomBack())}_zoomUp(){this._originalScale&&(Ki.copy(this._fromScale,this._originalScale),Ki.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}_zoomBack(){this.target&&this._originalScale&&(Ki.copy(this._fromScale,this.target.scale),Ki.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}_applyTransition(t){const e=this._transition;1===e?this._updateColorTransition(t):2===e?this._updateSpriteTransition(t):3===e&&this._updateScaleTransition(t)}_getSpriteFrameByState(t){switch(t){case 0:return this._normalSprite;case 3:return this._disabledSprite;case 1:return this.hoverSprite;case 2:return this._pressedSprite;default:return null}}_getColorByState(t){switch(t){case 0:return this._normalColor;case 3:return this._disabledColor;case 1:return this._hoverColor;case 2:return this._pressedColor;default:return new _r}}_xrHoverEnter(){this._onMouseMoveIn(),this._updateState()}_xrHoverExit(){this._onMouseMoveOut(),this._pressed&&(this._pressed=!1,this._updateState())}_xrClick(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState())}_xrUnClick(){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(yg.emitEvents(this.clickEvents,this),this.node.emit("click",this)),this._pressed=!1,this._updateState())}},EIt.Transition=cEt,EIt.EventType=uEt,s((dIt=EIt).prototype,"target",[rIt],Object.getOwnPropertyDescriptor(dIt.prototype,"target"),dIt.prototype),s(dIt.prototype,"transition",[nIt],Object.getOwnPropertyDescriptor(dIt.prototype,"transition"),dIt.prototype),s(dIt.prototype,"normalSprite",[oIt],Object.getOwnPropertyDescriptor(dIt.prototype,"normalSprite"),dIt.prototype),s(dIt.prototype,"pressedSprite",[aIt],Object.getOwnPropertyDescriptor(dIt.prototype,"pressedSprite"),dIt.prototype),s(dIt.prototype,"hoverSprite",[hIt],Object.getOwnPropertyDescriptor(dIt.prototype,"hoverSprite"),dIt.prototype),s(dIt.prototype,"disabledSprite",[lIt],Object.getOwnPropertyDescriptor(dIt.prototype,"disabledSprite"),dIt.prototype),pIt=Qo(dIt.prototype,"clickEvents",[cIt,va],(function(){return[]})),_It=Qo(dIt.prototype,"_interactable",[va],(function(){return!0})),gIt=Qo(dIt.prototype,"_transition",[va],(function(){return 0})),fIt=Qo(dIt.prototype,"_normalColor",[va],(function(){return _r.WHITE.clone()})),mIt=Qo(dIt.prototype,"_hoverColor",[va],(function(){return new _r(211,211,211,255)})),yIt=Qo(dIt.prototype,"_pressedColor",[va],(function(){return _r.WHITE.clone()})),vIt=Qo(dIt.prototype,"_disabledColor",[va],(function(){return new _r(124,124,124,255)})),bIt=Qo(dIt.prototype,"_normalSprite",[va],(function(){return null})),wIt=Qo(dIt.prototype,"_hoverSprite",[va],(function(){return null})),SIt=Qo(dIt.prototype,"_pressedSprite",[va],(function(){return null})),xIt=Qo(dIt.prototype,"_disabledSprite",[va],(function(){return null})),TIt=Qo(dIt.prototype,"_duration",[va],(function(){return.1})),CIt=Qo(dIt.prototype,"_zoomScale",[va],(function(){return 1.2})),IIt=Qo(dIt.prototype,"_target",[va],(function(){return null})),uIt=dIt))||uIt)||uIt)||uIt));l.Button=dEt;class pEt{static add(t){const e=this._tabIndexList;-1===e.indexOf(t)&&e.push(t)}static remove(t){const e=this._tabIndexList,i=e.indexOf(t);-1!==i&&e.splice(i,1)}static resort(){this._tabIndexList.sort(((t,e)=>t._delegate.tabIndex-e._delegate.tabIndex))}static next(t){const e=this._tabIndexList,i=e.indexOf(t);if(t.setFocus(!1),-1!==i){const t=e[i+1];t&&t._delegate.tabIndex>=0&&t.setFocus(!0)}}}pEt._tabIndexList=[];class _Et{constructor(){this._editing=!1,this._delegate=null}init(t){}onEnable(){}beforeDraw(){}onDisable(){this._editing&&this.endEditing()}clear(){this._delegate=null}setTabIndex(t){}setSize(t,e){}setFocus(t){t?this.beginEditing():this.endEditing()}isFocused(){return this._editing}beginEditing(){}endEditing(){}}const gEt=u.document,fEt=new Rs,mEt=new Rs,yEt=new Ki;let vEt=null,bEt=0;const wEt={DEFAULT:0,DONE:1,SEND:2,SEARCH:3,GO:4,NEXT:5};te(wEt);const SEt={ANY:0,EMAIL_ADDR:1,NUMERIC:2,PHONE_NUMBER:3,URL:4,DECIMAL:5,SINGLE_LINE:6};te(SEt);const xEt={PASSWORD:0,SENSITIVE:1,INITIAL_CAPS_WORD:2,INITIAL_CAPS_SENTENCE:3,INITIAL_CAPS_ALL_CHARACTERS:4,DEFAULT:5};var TEt,CEt,IEt,EEt,DEt,AEt,MEt,PEt,BEt,REt,OEt,LEt,FEt,zEt,kEt,NEt,UEt,VEt,HEt,GEt,WEt,jEt,$Et,qEt,XEt,YEt,QEt,KEt,ZEt;te(xEt);let JEt=t("EditBox",(TEt=oa("cc.EditBox"),CEt=ha(110),IEt=aa(pO),EEt=Ga(ML),DEt=Ga(ML),AEt=Ga(yB),MEt=Ga(xEt),PEt=Ga(SEt),BEt=Ga(wEt),REt=Ga([yg]),OEt=Ga([yg]),LEt=Ga([yg]),FEt=Ga([yg]),TEt(zEt=CEt(zEt=IEt((ZEt=class t extends Ag{get string(){return this._string}set string(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string!==t&&(this._string=t,this._updateString(t))}get placeholder(){return this._placeholderLabel?this._placeholderLabel.string:""}set placeholder(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}get textLabel(){return this._textLabel}set textLabel(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}get placeholderLabel(){return this._placeholderLabel}set placeholderLabel(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}get backgroundImage(){return this._backgroundImage}set backgroundImage(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._ensureBackgroundSprite(),this._background.spriteFrame=t)}get inputFlag(){return this._inputFlag}set inputFlag(t){this._inputFlag!==t&&(this._inputFlag=t,this._updateString(this._string))}get inputMode(){return this._inputMode}set inputMode(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}get returnType(){return this._returnType}set returnType(t){this._returnType=t}get maxLength(){return this._maxLength}set maxLength(t){this._maxLength=t}get tabIndex(){return this._tabIndex}set tabIndex(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}constructor(){super(),this.editingDidBegan=NEt&&NEt(),this.textChanged=UEt&&UEt(),this.editingDidEnded=VEt&&VEt(),this.editingReturn=HEt&&HEt(),this._impl=null,this._background=null,this._textLabel=GEt&&GEt(),this._placeholderLabel=WEt&&WEt(),this._returnType=jEt&&jEt(),this._string=$Et&&$Et(),this._tabIndex=qEt&&qEt(),this._backgroundImage=XEt&&XEt(),this._inputFlag=YEt&&YEt(),this._inputMode=QEt&&QEt(),this._maxLength=KEt&&KEt(),this._isLabelVisible=!1}__preload(){this._init()}onEnable(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()}_beforeDraw(){this._impl&&this._impl.beforeDraw()}onDisable(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()}onDestroy(){uP.off("director_before_draw",this._beforeDraw,this),this._impl&&this._impl.clear()}setFocus(){this._impl&&this._impl.setFocus(!0)}focus(){this._impl&&this._impl.setFocus(!0)}blur(){this._impl&&this._impl.setFocus(!1)}isFocused(){return!!this._impl&&this._impl.isFocused()}_editBoxEditingDidBegan(){yg.emitEvents(this.editingDidBegan,this),this.node.emit("editing-did-began",this)}_editBoxEditingDidEnded(t){yg.emitEvents(this.editingDidEnded,this),this.node.emit("editing-did-ended",this,t)}_editBoxTextChanged(t){t=this._updateLabelStringStyle(t,!0),this.string=t,yg.emitEvents(this.textChanged,t,this),this.node.emit("text-changed",this)}_editBoxEditingReturn(t){yg.emitEvents(this.editingReturn,this),this.node.emit("editing-return",this,t)}_showLabels(){this._isLabelVisible=!0,this._updateLabels()}_hideLabels(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}_onTouchBegan(t){t.propagationStopped=!0}_onTouchCancel(t){t.propagationStopped=!0}_onTouchEnded(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0}_init(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on("size-changed",this._resizeChildNodes,this),uP.on("director_before_draw",this._beforeDraw,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}_ensureBackgroundSprite(){if(!this._background){let t=this.node.getComponent(ZF);t||(t=this.node.addComponent(ZF)),t!==this._background&&(t.type=ZF.Type.SLICED,t.spriteFrame=this._backgroundImage,this._background=t,this._registerBackgroundEvent())}}_updateTextLabel(){let t=this._textLabel;if(!t){let e=this.node.getChildByName("TEXT_LABEL");e||(e=new JS("TEXT_LABEL"),e.layer=this.node.layer),t=e.getComponent(ML),t||(t=e.addComponent(ML)),e.parent=this.node,this._textLabel=t}0===this._inputMode?(t.verticalAlign=0,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)}_updatePlaceholderLabel(){let t=this._placeholderLabel;if(!t){let e=this.node.getChildByName("PLACEHOLDER_LABEL");e||(e=new JS("PLACEHOLDER_LABEL"),e.layer=this.node.layer),t=e.getComponent(ML),t||(t=e.addComponent(ML)),e.parent=this.node,this._placeholderLabel=t}0===this._inputMode?t.enableWrapText=!0:t.enableWrapText=!1,t.string=this.placeholder}_syncSize(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){const i=this._background.node._uiProps.uiTransformComp;i.anchorPoint=t.anchorPoint,i.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}_updateLabels(){if(this._isLabelVisible){const t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}}_updateString(t){const e=this._textLabel;if(!e)return;let i=t;i&&(i=this._updateLabelStringStyle(i)),e.string=i,this._updateLabels()}_updateLabelStringStyle(t,e){void 0===e&&(e=!1);const i=this._inputFlag;if(e||0!==i)4===i?t=t.toUpperCase():2===i?t=t.replace(/(?:^|\s)\S/g,(t=>t.toUpperCase())):3===i&&(t=(s=t).charAt(0).toUpperCase()+s.slice(1));else{let e="";const i=t.length;for(let t=0;t<i;++t)e+="";t=e}var s;return t}_registerEvent(){this.node.on("touch-start",this._onTouchBegan,this),this.node.on("touch-end",this._onTouchEnded,this),this.node.on("xrui-unclick",this._xrUnClick,this),this.node.on("xr-keyboard-input",this._xrKeyBoardInput,this)}_unregisterEvent(){this.node.off("touch-start",this._onTouchBegan,this),this.node.off("touch-end",this._onTouchEnded,this),this.node.off("xrui-unclick",this._xrUnClick,this),this.node.off("xr-keyboard-input",this._xrKeyBoardInput,this)}_onBackgroundSpriteFrameChanged(){this._background&&(this.backgroundImage=this._background.spriteFrame)}_registerBackgroundEvent(){const t=this._background&&this._background.node;null==t||t.on("spriteframe-changed",this._onBackgroundSpriteFrameChanged,this)}_unregisterBackgroundEvent(){const t=this._background&&this._background.node;null==t||t.off("spriteframe-changed",this._onBackgroundSpriteFrameChanged,this)}_updateLabelPosition(t){const e=this.node._uiProps.uiTransformComp,i=-e.anchorX*e.width,s=-e.anchorY*e.height,r=this._placeholderLabel,n=this._textLabel;n&&(n.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),n.node.setPosition(i+2,s+t.height,n.node.position.z),0===this._inputMode&&(n.verticalAlign=0),n.enableWrapText=0===this._inputMode),r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.node.setPosition(i+2,s+t.height,r.node.position.z),r.enableWrapText=0===this._inputMode)}_resizeChildNodes(){const t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));const i=this._placeholderLabel&&this._placeholderLabel.node;i&&(i.setPosition(-t.width/2,t.height/2,i.position.z),i._uiProps.uiTransformComp.setContentSize(t.contentSize));const s=this._background&&this._background.node;s&&s._uiProps.uiTransformComp.setContentSize(t.contentSize),this._syncSize()}_xrUnClick(){this.node.emit("xr-editing-did-began",this._maxLength,this.string)}_xrKeyBoardInput(t){this.string=t}},ZEt._EditBoxImpl=_Et,ZEt.KeyboardReturnType=wEt,ZEt.InputFlag=xEt,ZEt.InputMode=SEt,ZEt.EventType={EDITING_DID_BEGAN:"editing-did-began",EDITING_DID_ENDED:"editing-did-ended",TEXT_CHANGED:"text-changed",EDITING_RETURN:"editing-return",XR_EDITING_DID_BEGAN:"xr-editing-did-began",XR_EDITING_DID_ENDED:"xr-editing-did-ended"},s((kEt=ZEt).prototype,"textLabel",[EEt],Object.getOwnPropertyDescriptor(kEt.prototype,"textLabel"),kEt.prototype),s(kEt.prototype,"placeholderLabel",[DEt],Object.getOwnPropertyDescriptor(kEt.prototype,"placeholderLabel"),kEt.prototype),s(kEt.prototype,"backgroundImage",[AEt],Object.getOwnPropertyDescriptor(kEt.prototype,"backgroundImage"),kEt.prototype),s(kEt.prototype,"inputFlag",[MEt],Object.getOwnPropertyDescriptor(kEt.prototype,"inputFlag"),kEt.prototype),s(kEt.prototype,"inputMode",[PEt],Object.getOwnPropertyDescriptor(kEt.prototype,"inputMode"),kEt.prototype),s(kEt.prototype,"returnType",[BEt],Object.getOwnPropertyDescriptor(kEt.prototype,"returnType"),kEt.prototype),NEt=Qo(kEt.prototype,"editingDidBegan",[REt,va],(function(){return[]})),UEt=Qo(kEt.prototype,"textChanged",[OEt,va],(function(){return[]})),VEt=Qo(kEt.prototype,"editingDidEnded",[LEt,va],(function(){return[]})),HEt=Qo(kEt.prototype,"editingReturn",[FEt,va],(function(){return[]})),GEt=Qo(kEt.prototype,"_textLabel",[va],(function(){return null})),WEt=Qo(kEt.prototype,"_placeholderLabel",[va],(function(){return null})),jEt=Qo(kEt.prototype,"_returnType",[va],(function(){return 0})),$Et=Qo(kEt.prototype,"_string",[va],(function(){return""})),qEt=Qo(kEt.prototype,"_tabIndex",[va],(function(){return 0})),XEt=Qo(kEt.prototype,"_backgroundImage",[va],(function(){return null})),YEt=Qo(kEt.prototype,"_inputFlag",[va],(function(){return 5})),QEt=Qo(kEt.prototype,"_inputMode",[va],(function(){return 0})),KEt=Qo(kEt.prototype,"_maxLength",[va],(function(){return 20})),zEt=kEt))||zEt)||zEt)||zEt));var tDt,eDt,iDt,sDt,rDt,nDt,oDt,aDt,hDt,lDt,cDt,uDt,dDt,pDt,_Dt,gDt,fDt,mDt,yDt,vDt,bDt,wDt,SDt,xDt,TDt,CDt,IDt,EDt;"object"==typeof window&&"object"==typeof document&&(JEt._EditBoxImpl=class extends _Et{constructor(){super(),this._delegate=null,this._inputMode=-1,this._inputFlag=-1,this._returnType=-1,this.__eventListeners={},this.__autoResize=!1,this.__orientationChanged=void 0,this._edTxt=null,this._isTextArea=!1,this._textLabelFont=null,this._textLabelFontSize=null,this._textLabelFontColor=null,this._textLabelAlign=null,this._placeholderLabelFont=null,this._placeholderLabelFontSize=null,this._placeholderLabelFontColor=null,this._placeholderLabelAlign=null,this._placeholderLineHeight=null,this._placeholderStyleSheet=null,this._domId="EditBoxId_"+ ++bEt,this._forceUpdate=!1}init(t){t&&(this._delegate=t,0===t.inputMode?this._createTextArea():this._createInput(),pEt.add(this),this.setTabIndex(t.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer(),_P.instance.on("canvas-resize",this._resize,this),Un.on("window-resize",this._resize,this))}clear(){_P.instance.off("canvas-resize",this._resize,this),Un.off("window-resize",this._resize,this),this._removeEventListeners(),this._removeDomFromGameContainer(),pEt.remove(this),vEt===this&&(vEt=null),this._delegate=null}_resize(){this._forceUpdate=!0}beforeDraw(){(this._delegate.node.hasChangedFlags||this._forceUpdate)&&(this._forceUpdate=!1,this._updateMatrix())}setTabIndex(t){this._edTxt.tabIndex=t,pEt.resort()}setSize(t,e){const i=this._edTxt;i&&(i.style.width=`${t}px`,i.style.height=`${e}px`)}beginEditing(){vEt&&vEt!==this&&vEt.setFocus(!1),this._editing=!0,vEt=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()}endEditing(){this._edTxt.blur()}_createInput(){this._isTextArea=!1,this._edTxt=gEt.createElement("input")}_createTextArea(){this._isTextArea=!0,this._edTxt=gEt.createElement("textarea")}_addDomToGameContainer(){TP.container&&this._edTxt&&(TP.container.appendChild(this._edTxt),gEt.head.appendChild(this._placeholderStyleSheet))}_removeDomFromGameContainer(){fe(TP.container,this._edTxt)&&this._edTxt&&TP.container.removeChild(this._edTxt),fe(gEt.head,this._placeholderStyleSheet)&&gEt.head.removeChild(this._placeholderStyleSheet),this._edTxt=null,this._placeholderStyleSheet=null}_showDom(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),Hn.isMobile&&this._showDomOnMobile()}_hideDom(){const t=this._edTxt;t&&this._delegate&&(t.style.display="none",this._delegate._showLabels()),Hn.isMobile&&this._hideDomOnMobile()}_showDomOnMobile(){Hn.os!==On.ANDROID&&Hn.os!==On.OHOS||(Un.handleResizeEvent=!1,this._adjustWindowScroll())}_hideDomOnMobile(){Hn.os!==On.ANDROID&&Hn.os!==On.OHOS||(Un.handleResizeEvent=!0),this._scrollBackWindow()}_isElementInViewport(){if(this._edTxt){const t=this._edTxt.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(u.innerHeight||gEt.documentElement.clientHeight)&&t.right<=(u.innerWidth||gEt.documentElement.clientWidth)}return!1}_adjustWindowScroll(){setTimeout((()=>{u.scrollY<40&&!this._isElementInViewport()&&this._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)}_scrollBackWindow(){setTimeout((()=>{Hn.browserType!==Pn.WECHAT||Hn.os!==On.IOS?u.scrollTo(0,0):u.top&&u.top.scrollTo(0,0)}),400)}_updateMatrix(){if(!this._edTxt)return;const t=this._delegate.node;let e=yP.getScaleX(),i=yP.getScaleY();const s=yP.getViewportRect(),r=Un.devicePixelRatio;t.getWorldMatrix(fEt);const n=t._uiProps.uiTransformComp;if(n&&(Ki.set(yEt,-n.anchorX*n.width,-n.anchorY*n.height,yEt.z),Rs.transform(fEt,fEt,yEt)),!t._uiProps.uiTransformComp)return;const o=uP.root.batcher2D.getFirstRenderCamera(t);if(!o)return;o.node.getWorldRT(mEt);const a=mEt.m12,h=mEt.m13,l=Gn.center;mEt.m12=l.x-(mEt.m00*a+mEt.m04*h),mEt.m13=l.y-(mEt.m01*a+mEt.m05*h),e/=r,i/=r,Ki.set(yEt,e,i,1),Rs.scale(mEt,mEt,yEt);const c=TP.container;let u=parseInt(c&&c.style.paddingLeft||"0");u+=s.x/r;let d=parseInt(c&&c.style.paddingBottom||"0");d+=s.y/r,mEt.m12+=u,mEt.m13+=d,Rs.multiply(mEt,mEt,fEt);const p=`matrix(${mEt.m00},${-mEt.m01},${-mEt.m04},${mEt.m05},${mEt.m12},${-mEt.m13})`;this._edTxt.style.transform=p,this._edTxt.style["-webkit-transform"]=p,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}_updateInputType(){const t=this._delegate,e=t.inputMode,i=t.inputFlag,s=t.returnType;let r=this._edTxt;if(this._inputMode===e&&this._inputFlag===i&&this._returnType===s)return;if(this._inputMode=e,this._inputFlag=i,this._returnType=s,this._isTextArea){let t="none";return 4===i?t="uppercase":2===i&&(t="capitalize"),void(r.style.textTransform=t)}if(0===i)return r.type="password",void(r.style.textTransform="none");let n=r.type;1===e?n="email":2===e?n="number":5===e?n="digit":3===e?(n="tel",r.addEventListener("wheel",(()=>!1))):4===e?n="url":(n="text",3===s&&(n="search")),r.type=n;let o="none";4===i?o="uppercase":2===i&&(o="capitalize"),r.style.textTransform=o}_updateMaxLength(){let t=this._delegate.maxLength;t<0&&(t=65535),this._edTxt.maxLength=t}_initStyleSheet(){if(!this._edTxt)return;let t=this._edTxt;t.style.color="#000000",t.style.border="0px",t.style.background="transparent",t.style.width="100%",t.style.height="100%",t.style.outline="medium",t.style.padding="0",t.style.textTransform="none",t.style.display="none",t.style.position="absolute",t.style.bottom="0px",t.style.left="2px",t.className="cocosEditBox",t.style.fontFamily="Arial",t.id=this._domId,this._isTextArea?(t.style.resize="none",t.style.overflowY="scroll"):(t.type="text",t.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=gEt.createElement("style")}_updateStyleSheet(){const t=this._delegate,e=this._edTxt;e&&t&&(e.value=t.string,this._updateTextLabel(t.textLabel))}_updateTextLabel(t){if(!t)return;let e=t.font;e=!e||e instanceof CR?t.fontFamily:e._fontFamily;const i=t.fontSize*t.node.scale.y;if(this._textLabelFont===e&&this._textLabelFontSize===i&&this._textLabelFontColor===t.fontColor&&this._textLabelAlign===t.horizontalAlign)return;if(this._textLabelFont=e,this._textLabelFontSize=i,this._textLabelFontColor=t.fontColor,this._textLabelAlign=t.horizontalAlign,!this._edTxt)return;const s=this._edTxt;switch(s.style.fontSize=`${i}px`,s.style.color=t.color.toCSS(),s.style.fontFamily=e,t.horizontalAlign){case ML.HorizontalAlign.LEFT:s.style.textAlign="left";break;case ML.HorizontalAlign.CENTER:s.style.textAlign="center";break;case ML.HorizontalAlign.RIGHT:s.style.textAlign="right"}}_updatePlaceholderLabel(t){if(!t)return;let e=t.font;e=!e||e instanceof CR?t.fontFamily:t.font._fontFamily;const i=t.fontSize*t.node.scale.y;if(this._placeholderLabelFont===e&&this._placeholderLabelFontSize===i&&this._placeholderLabelFontColor===t.fontColor&&this._placeholderLabelAlign===t.horizontalAlign&&this._placeholderLineHeight===t.fontSize)return;this._placeholderLabelFont=e,this._placeholderLabelFontSize=i,this._placeholderLabelFontColor=t.fontColor,this._placeholderLabelAlign=t.horizontalAlign,this._placeholderLineHeight=t.fontSize;const s=this._placeholderStyleSheet,r=t.color.toCSS(),n=t.fontSize;let o="";switch(t.horizontalAlign){case ML.HorizontalAlign.LEFT:o="left";break;case ML.HorizontalAlign.CENTER:o="center";break;case ML.HorizontalAlign.RIGHT:o="right"}s.innerHTML=`#${this._domId}::-webkit-input-placeholder{text-transform: initial;-family: ${e};font-size: ${i}px;color: ${r};line-height: ${n}px;text-align: ${o};}#${this._domId}::-moz-placeholder{text-transform: initial;-family: ${e};font-size: ${i}px;color: ${r};line-height: ${n}px;text-align: ${o};}#${this._domId}::-ms-input-placeholder{text-transform: initial;-family: ${e};font-size: ${i}px;color: ${r};line-height: ${n}px;text-align: ${o};}`,Hn.browserType===Pn.EDGE&&(s.innerHTML+=`#${this._domId}::-ms-clear{display: none;}`)}_registerEventListeners(){if(!this._edTxt)return;const t=this._edTxt;let e=!1;const i=this.__eventListeners;i.compositionStart=()=>{e=!0},i.compositionEnd=()=>{e=!1,this._delegate._editBoxTextChanged(t.value)},i.onInput=()=>{if(e)return;const i=this._delegate,s=i.maxLength;s>=0&&(t.value=t.value.slice(0,s)),i._editBoxTextChanged(t.value)},i.onClick=()=>{this._editing&&Hn.isMobile&&this._adjustWindowScroll()},i.onKeydown=e=>{13===e.keyCode?(e.propagationStopped=!0,this._delegate._editBoxEditingReturn(),this._isTextArea||t.blur()):9===e.keyCode&&(e.propagationStopped=!0,e.preventDefault(),pEt.next(this))},i.onBlur=()=>{Hn.isMobile&&e&&i.compositionEnd(),this._editing=!1,vEt=null,this._hideDom(),this._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}_removeEventListeners(){if(!this._edTxt)return;const t=this._edTxt,e=this.__eventListeners;t.removeEventListener("compositionstart",e.compositionStart),t.removeEventListener("compositionend",e.compositionEnd),t.removeEventListener("input",e.onInput),t.removeEventListener("keydown",e.onKeydown),t.removeEventListener("blur",e.onBlur),t.removeEventListener("touchstart",e.onClick),e.compositionStart=null,e.compositionEnd=null,e.onInput=null,e.onKeydown=null,e.onBlur=null,e.onClick=null}}),l.internal.EditBox=JEt;const DDt={NONE:0,HORIZONTAL:1,VERTICAL:2,GRID:3};se(DDt);const ADt={NONE:0,CONTAINER:1,CHILDREN:2};se(ADt);const MDt={HORIZONTAL:0,VERTICAL:1};se(MDt);const PDt={BOTTOM_TO_TOP:0,TOP_TO_BOTTOM:1};se(PDt);const BDt={LEFT_TO_RIGHT:0,RIGHT_TO_LEFT:1};se(BDt);const RDt={NONE:0,FIXED_ROW:1,FIXED_COL:2};se(RDt);const ODt=new Ki;let LDt=t("Layout",(tDt=oa("cc.Layout"),eDt=ha(110),iDt=aa(pO),sDt=Ga(DDt),rDt=Ga(ADt),nDt=Ga(MDt),oDt=Ga(PDt),aDt=Ga(BDt),hDt=Ga(RDt),tDt(lDt=eDt(lDt=iDt((EDt=class extends Ag{constructor(){super(),this._resizeMode=uDt&&uDt(),this._layoutType=dDt&&dDt(),this._cellSize=pDt&&pDt(),this._startAxis=_Dt&&_Dt(),this._paddingLeft=gDt&&gDt(),this._paddingRight=fDt&&fDt(),this._paddingTop=mDt&&mDt(),this._paddingBottom=yDt&&yDt(),this._spacingX=vDt&&vDt(),this._spacingY=bDt&&bDt(),this._verticalDirection=wDt&&wDt(),this._horizontalDirection=SDt&&SDt(),this._constraint=xDt&&xDt(),this._constraintNum=TDt&&TDt(),this._affectedByScale=CDt&&CDt(),this._isAlign=IDt&&IDt(),this._layoutSize=new br(300,200),this._layoutDirty=!0,this._childrenDirty=!1,this._usefulLayoutObj=[],this._init=!1}get alignHorizontal(){return this._isAlign}set alignHorizontal(t){1===this._layoutType&&(this._isAlign=t,this._doLayoutDirty())}get alignVertical(){return this._isAlign}set alignVertical(t){2===this._layoutType&&(this._isAlign=t,this._doLayoutDirty())}get type(){return this._layoutType}set type(t){this._layoutType=t,this._doLayoutDirty()}get resizeMode(){return this._resizeMode}set resizeMode(t){0!==this._layoutType&&(this._resizeMode=t,this._doLayoutDirty())}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}get startAxis(){return this._startAxis}set startAxis(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}get paddingLeft(){return this._paddingLeft}set paddingLeft(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}get paddingRight(){return this._paddingRight}set paddingRight(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}get paddingTop(){return this._paddingTop}set paddingTop(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}get paddingBottom(){return this._paddingBottom}set paddingBottom(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}get spacingY(){return this._spacingY}set spacingY(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}get verticalDirection(){return this._verticalDirection}set verticalDirection(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}get horizontalDirection(){return this._horizontalDirection}set horizontalDirection(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}get padding(){return this._paddingLeft}set padding(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}get constraint(){return this._constraint}set constraint(t){0!==this._layoutType&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}get constraintNum(){return this._constraintNum}set constraintNum(t){0!==this._constraint&&this._constraintNum!==t&&(t<=0&&G(16400),this._constraintNum=t,this._doLayoutDirty())}get affectedByScale(){return this._affectedByScale}set affectedByScale(t){this._affectedByScale=t,this._doLayoutDirty()}updateLayout(t){void 0===t&&(t=!1),(this._layoutDirty||t)&&(this._doLayout(),this._layoutDirty=!1)}onEnable(){this._addEventListeners();const t=this.node._uiProps.uiTransformComp;t.contentSize.equals(br.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()}onDisable(){this._usefulLayoutObj.length=0,this._removeEventListeners()}_checkUsefulObj(){this._usefulLayoutObj.length=0;const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e],s=i._uiProps.uiTransformComp;i.activeInHierarchy&&s&&this._usefulLayoutObj.push(s)}}_addEventListeners(){uP.on("director_after_update",this.updateLayout,this),this.node.on("size-changed",this._resized,this),this.node.on("anchor-changed",this._doLayoutDirty,this),this.node.on("child-added",this._childAdded,this),this.node.on("child-removed",this._childRemoved,this),this.node.on("sibling-order-changed",this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()}_removeEventListeners(){uP.off("director_after_update",this.updateLayout,this),this.node.off("size-changed",this._resized,this),this.node.off("anchor-changed",this._doLayoutDirty,this),this.node.off("child-added",this._childAdded,this),this.node.off("child-removed",this._childRemoved,this),this.node.off("sibling-order-changed",this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()}_addChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e];i.on("size-changed",this._doLayoutDirty,this),i.on("transform-changed",this._transformDirty,this),i.on("anchor-changed",this._doLayoutDirty,this),i.on("active-in-hierarchy-changed",this._childrenChanged,this)}}_removeChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e];i.off("size-changed",this._doLayoutDirty,this),i.off("transform-changed",this._transformDirty,this),i.off("anchor-changed",this._doLayoutDirty,this),i.off("active-in-hierarchy-changed",this._childrenChanged,this)}}_childAdded(t){t.on("size-changed",this._doLayoutDirty,this),t.on("transform-changed",this._transformDirty,this),t.on("anchor-changed",this._doLayoutDirty,this),t.on("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_childRemoved(t){t.off("size-changed",this._doLayoutDirty,this),t.off("transform-changed",this._transformDirty,this),t.off("anchor-changed",this._doLayoutDirty,this),t.off("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_resized(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}_doLayoutHorizontally(t,e,i,s){const r=this.node._uiProps.uiTransformComp.anchorPoint,n=this._getFixedBreakingNum();let o=1,a=this._paddingLeft;1===this._horizontalDirection&&(o=-1,a=this._paddingRight);const h=(this._horizontalDirection-r.x)*t+o*a;let l=h-o*this._spacingX,c=0,u=0,d=0,p=0,_=!1;const g=this._usefulLayoutObj.length;let f=this._cellSize.width;const m=this._getPaddingH();3!==this._layoutType&&2===this._resizeMode&&(f=(t-m-(g-1)*this._spacingX)/g);const y=this._usefulLayoutObj;for(let a=0;a<y.length;++a){const g=y[a],v=g.node,b=v.scale,w=this._getUsedScaleValue(b.x),S=this._getUsedScaleValue(b.y);2===this._resizeMode&&(g.width=f/w,3===this._layoutType&&(g.height=this._cellSize.height/S));const x=Math.abs(this._horizontalDirection-g.anchorX),T=g.width*w,C=g.height*S;C>d&&(p=Math.max(d,p),u=d||C,d=C),l+=o*(x*T+this._spacingX);const I=o*(1-x)*T;if(e){if(n>0)_=a/n>0&&a%n==0,_&&(u=d>C?d:u);else if(T>t-m)l>h+o*x*T&&(_=!0);else{const e=(1-this._horizontalDirection-r.x)*t,i=l+I+o*(o>0?this._paddingRight:this._paddingLeft);_=Math.abs(i)>Math.abs(e)}_&&(l=h+o*x*T,C!==d&&(u=d),c+=u+this._spacingY,u=d=C)}const E=i(v,g,c);s&&v.setPosition(l,E),l+=I}return u=Math.max(u,d),Math.max(p,c+u)+this._getPaddingV()}_doLayoutVertically(t,e,i,s){const r=this.node._uiProps.uiTransformComp.anchorPoint,n=this._getFixedBreakingNum();let o=1,a=this._paddingBottom;1===this._verticalDirection&&(o=-1,a=this._paddingTop);const h=(this._verticalDirection-r.y)*t+o*a;let l=h-o*this._spacingY,c=0,u=0,d=0,p=0,_=!1;const g=this._usefulLayoutObj.length;let f=this._cellSize.height;const m=this._getPaddingV();3!==this._layoutType&&2===this._resizeMode&&(f=(t-m-(g-1)*this._spacingY)/g);const y=this._usefulLayoutObj;for(let a=0;a<y.length;++a){const g=y[a],v=g.node,b=v.scale,w=this._getUsedScaleValue(b.x),S=this._getUsedScaleValue(b.y);2===this._resizeMode&&(g.height=f/S,3===this._layoutType&&(g.width=this._cellSize.width/w));const x=Math.abs(this._verticalDirection-g.anchorY),T=g.width*w,C=g.height*S;T>c&&(u=Math.max(c,u),d=c||T,c=T),l+=o*(x*C+this._spacingY);const I=o*(1-x)*C;if(e){if(n>0)_=a/n>0&&a%n==0,_&&(d=c>C?c:d);else if(C>t-m)l>h+o*x*C&&(_=!0);else{const e=(1-this._verticalDirection-r.y)*t,i=l+I+o*(o>0?this._paddingTop:this._paddingBottom);_=Math.abs(i)>Math.abs(e)}_&&(l=h+o*x*C,T!==c&&(d=c),p+=d+this._spacingX,d=c=T)}const E=i(v,g,p);s&&(v.getPosition(ODt),v.setPosition(E,l,ODt.z)),l+=I}return d=Math.max(d,c),Math.max(u,p+d)+this._getPaddingH()}_doLayoutGridAxisHorizontal(t,e){const i=e.width;let s=1,r=-t.y*e.height,n=this._paddingBottom;1===this._verticalDirection&&(s=-1,r=(1-t.y)*e.height,n=this._paddingTop);const o=(t,e,i)=>r+s*(i+(1-e.anchorY)*e.height*this._getUsedScaleValue(t.scale.y)+n);let a=0;1===this._resizeMode&&(a=this._doLayoutHorizontally(i,!0,o,!1),r=-t.y*a,1===this._verticalDirection&&(s=-1,r=(1-t.y)*a)),this._doLayoutHorizontally(i,!0,o,!0),1===this._resizeMode&&this.node._uiProps.uiTransformComp.setContentSize(i,a)}_doLayoutGridAxisVertical(t,e){const i=e.height;let s=1,r=-t.x*e.width,n=this._paddingLeft;1===this._horizontalDirection&&(s=-1,r=(1-t.x)*e.width,n=this._paddingRight);const o=(t,e,i)=>r+s*(i+(1-e.anchorX)*e.width*this._getUsedScaleValue(t.scale.x)+n);let a=0;1===this._resizeMode&&(a=this._doLayoutVertically(i,!0,o,!1),r=-t.x*a,1===this._horizontalDirection&&(s=-1,r=(1-t.x)*a)),this._doLayoutVertically(i,!0,o,!0),1===this._resizeMode&&this.node._uiProps.uiTransformComp.setContentSize(a,i)}_doLayoutGrid(){const t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,i=t.contentSize;0===this.startAxis?this._doLayoutGridAxisHorizontal(e,i):1===this.startAxis&&this._doLayoutGridAxisVertical(e,i)}_getHorizontalBaseWidth(t){const e=this._usefulLayoutObj;let i=0;const s=e.length;if(1===this._resizeMode){for(let t=0;t<e.length;++t){const s=e[t],r=s.node.scale;i+=s.width*this._getUsedScaleValue(r.x)}i+=(s-1)*this._spacingX+this._getPaddingH()}else i=this.node._uiProps.uiTransformComp.width;return i}_getVerticalBaseHeight(){const t=this._usefulLayoutObj;let e=0;const i=t.length;if(1===this._resizeMode){for(let i=0;i<t.length;++i){const s=t[i],r=s.node.scale;e+=s.height*this._getUsedScaleValue(r.y)}e+=(i-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e}_doLayout(){if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),1===this._layoutType){const t=this._getHorizontalBaseWidth(),e=t=>(this._isAlign?Ki.ZERO:t.position).y;this._doLayoutHorizontally(t,!1,e,!0),this.node._uiProps.uiTransformComp.width=t}else if(2===this._layoutType){const t=this._getVerticalBaseHeight(),e=t=>(this._isAlign?Ki.ZERO:t.position).x;this._doLayoutVertically(t,!1,e,!0),this.node._uiProps.uiTransformComp.height=t}else 3===this._layoutType&&this._doLayoutGrid()}_getUsedScaleValue(t){return this._affectedByScale?Math.abs(t):1}_transformDirty(t){4&t&&1&t&&this._affectedByScale&&this._doLayoutDirty()}_doLayoutDirty(){this._layoutDirty=!0}_childrenChanged(){this._childrenDirty=!0,this._doLayoutDirty()}_getPaddingH(){return this._paddingLeft+this._paddingRight}_getPaddingV(){return this._paddingTop+this._paddingBottom}_getFixedBreakingNum(){if(3!==this._layoutType||0===this._constraint||this._constraintNum<=0)return 0;let t=1===this._constraint?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return 1===this._startAxis&&(t=2===this._constraint?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t}},EDt.Type=DDt,EDt.VerticalDirection=PDt,EDt.HorizontalDirection=BDt,EDt.ResizeMode=ADt,EDt.AxisDirection=MDt,EDt.Constraint=RDt,s((cDt=EDt).prototype,"type",[sDt],Object.getOwnPropertyDescriptor(cDt.prototype,"type"),cDt.prototype),s(cDt.prototype,"resizeMode",[rDt],Object.getOwnPropertyDescriptor(cDt.prototype,"resizeMode"),cDt.prototype),s(cDt.prototype,"startAxis",[nDt],Object.getOwnPropertyDescriptor(cDt.prototype,"startAxis"),cDt.prototype),s(cDt.prototype,"verticalDirection",[oDt],Object.getOwnPropertyDescriptor(cDt.prototype,"verticalDirection"),cDt.prototype),s(cDt.prototype,"horizontalDirection",[aDt],Object.getOwnPropertyDescriptor(cDt.prototype,"horizontalDirection"),cDt.prototype),s(cDt.prototype,"constraint",[hDt],Object.getOwnPropertyDescriptor(cDt.prototype,"constraint"),cDt.prototype),uDt=Qo(cDt.prototype,"_resizeMode",[va],(function(){return 0})),dDt=Qo(cDt.prototype,"_layoutType",[va],(function(){return 0})),pDt=Qo(cDt.prototype,"_cellSize",[va],(function(){return new br(40,40)})),_Dt=Qo(cDt.prototype,"_startAxis",[va],(function(){return 0})),gDt=Qo(cDt.prototype,"_paddingLeft",[va],(function(){return 0})),fDt=Qo(cDt.prototype,"_paddingRight",[va],(function(){return 0})),mDt=Qo(cDt.prototype,"_paddingTop",[va],(function(){return 0})),yDt=Qo(cDt.prototype,"_paddingBottom",[va],(function(){return 0})),vDt=Qo(cDt.prototype,"_spacingX",[va],(function(){return 0})),bDt=Qo(cDt.prototype,"_spacingY",[va],(function(){return 0})),wDt=Qo(cDt.prototype,"_verticalDirection",[va],(function(){return 1})),SDt=Qo(cDt.prototype,"_horizontalDirection",[va],(function(){return 0})),xDt=Qo(cDt.prototype,"_constraint",[va],(function(){return 0})),TDt=Qo(cDt.prototype,"_constraintNum",[va],(function(){return 2})),CDt=Qo(cDt.prototype,"_affectedByScale",[va],(function(){return!1})),IDt=Qo(cDt.prototype,"_isAlign",[va],(function(){return!1})),lDt=cDt))||lDt)||lDt)||lDt));var FDt,zDt,kDt,NDt,UDt,VDt,HDt,GDt,WDt,jDt,$Dt,qDt,XDt;l.Layout=LDt;const YDt={HORIZONTAL:0,VERTICAL:1,FILLED:2};te(YDt);let QDt=t("ProgressBar",(FDt=oa("cc.ProgressBar"),zDt=ha(110),kDt=aa(pO),NDt=Ga(ZF),UDt=Ga(YDt),FDt(VDt=zDt(VDt=kDt((XDt=class extends Ag{constructor(){super(),this._barSprite=GDt&&GDt(),this._mode=WDt&&WDt(),this._totalLength=jDt&&jDt(),this._progress=$Dt&&$Dt(),this._reverse=qDt&&qDt()}get barSprite(){return this._barSprite}set barSprite(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}get mode(){return this._mode}set mode(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp.contentSize;0===this._mode?this.totalLength=e.width:1===this._mode?this.totalLength=e.height:2===this._mode&&(this.totalLength=this._barSprite.fillRange)}}get totalLength(){return this._totalLength}set totalLength(t){2===this._mode&&(t=mi(t)),this._totalLength!==t&&(this._totalLength=t,this._updateBarStatus())}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}get reverse(){return this._reverse}set reverse(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}onLoad(){this._updateBarStatus()}_initBarSprite(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=this.node._uiProps.uiTransformComp,i=e.contentSize,s=e.anchorPoint,r=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===ZF.FillType.RADIAL&&(this._mode=2),0===this._mode?this.totalLength=r.width:1===this._mode?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){const e=-i.width*s.x;t.setPosition(e,0,0)}}}_updateBarStatus(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp,i=e.anchorPoint,s=e.contentSize;let r=new Qs(0,.5);const n=mi(this._progress);let o=this._totalLength*n,a=s,h=0,l=0;switch(this._mode){case 0:this._reverse&&(r=new Qs(1,.5)),a=new br(o,s.height),h=this._totalLength,l=s.height;break;case 1:r=this._reverse?new Qs(.5,1):new Qs(.5,0),a=new br(s.width,o),h=s.width,l=this._totalLength}if(2===this._mode)this._barSprite.type!==ZF.Type.FILLED?G(16397):(this._reverse&&(o*=-1),this._barSprite.fillRange=o);else if(this._barSprite.type!==ZF.Type.FILLED){const s=r.x-i.x,n=r.y-i.y,o=new Ki(t.position);o.add3f(h*s,l*n,0),t.setPosition(o),e.setAnchorPoint(r),e.setContentSize(a)}else G(16398)}}},XDt.Mode=YDt,s((HDt=XDt).prototype,"barSprite",[NDt],Object.getOwnPropertyDescriptor(HDt.prototype,"barSprite"),HDt.prototype),s(HDt.prototype,"mode",[UDt],Object.getOwnPropertyDescriptor(HDt.prototype,"mode"),HDt.prototype),GDt=Qo(HDt.prototype,"_barSprite",[va],(function(){return null})),WDt=Qo(HDt.prototype,"_mode",[va],(function(){return 0})),jDt=Qo(HDt.prototype,"_totalLength",[va],(function(){return 1})),$Dt=Qo(HDt.prototype,"_progress",[va],(function(){return.1})),qDt=Qo(HDt.prototype,"_reverse",[va],(function(){return!1})),VDt=HDt))||VDt)||VDt)||VDt));var KDt,ZDt,JDt,tAt,eAt,iAt,sAt,rAt,nAt,oAt,aAt,hAt,lAt;l.ProgressBar=QDt;const cAt=new Ki,uAt=new Ki,dAt=new Ki,pAt=new Qs,_At=new _r,gAt=new Qs,fAt={HORIZONTAL:0,VERTICAL:1};se(fAt);let mAt=t("ScrollBar",(KDt=oa("cc.ScrollBar"),ZDt=ha(110),JDt=aa(pO),tAt=Ga(ZF),eAt=Ga(fAt),KDt(iAt=ZDt(iAt=JDt((lAt=class extends Ag{constructor(){super(),this._scrollView=rAt&&rAt(),this._handle=nAt&&nAt(),this._direction=oAt&&oAt(),this._enableAutoHide=aAt&&aAt(),this._autoHideTime=hAt&&hAt(),this._touching=!1,this._opacity=255,this._autoHideRemainingTime=0}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t,this.onScroll(Qs.ZERO))}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this.onScroll(Qs.ZERO))}get enableAutoHide(){return this._enableAutoHide}set enableAutoHide(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}get autoHideTime(){return this._autoHideTime}set autoHideTime(t){this._autoHideTime!==t&&(this._autoHideTime=t)}hide(){this._autoHideRemainingTime=0,this._setOpacity(0)}show(){this._autoHideRemainingTime=this._autoHideTime,this._opacity=255,this._setOpacity(this._opacity)}onScroll(t){if(!this._scrollView)return;const e=this._scrollView.content;if(!e)return;const i=e._uiProps.uiTransformComp.contentSize,s=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(i,s))return;this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));let n=0,o=0,a=0,h=0,l=0;const c=gAt;c.set(0,0),0===this._direction?(n=i.width,o=s.width,l=r.width,a=t.x,this._convertToScrollViewSpace(c,e),h=-c.x):1===this._direction&&(n=i.height,o=s.height,l=r.height,a=t.y,this._convertToScrollViewSpace(c,e),h=-c.y);const u=this._calculateLength(n,o,l,a),d=gAt;this._calculatePosition(d,n,o,l,h,a,u),this._updateLength(u),this._updateHandlerPosition(d)}setScrollView(t){this._scrollView=t}onTouchBegan(){this._enableAutoHide&&(this._touching=!0)}onTouchEnded(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){const t=this._scrollView.content;if(t){const e=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,i))return}}this._autoHideRemainingTime=this._autoHideTime}}onEnable(){const t=this.node.getComponent(ZF);t&&(this._opacity=t.color.a)}start(){this._enableAutoHide&&this._setOpacity(0)}update(t){this._processAutoHide(t)}_convertToScrollViewSpace(t,e){const i=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,s=e._uiProps.uiTransformComp;if(i&&s){cAt.set(-s.anchorX*s.width,-s.anchorY*s.height,0),s.convertToWorldSpaceAR(cAt,uAt);const e=i.convertToNodeSpaceAR(uAt);e.x+=i.anchorX*i.width,e.y+=i.anchorY*i.height,t.set(e.x,e.y)}else t.set(Qs.ZERO)}_setOpacity(t){if(this._handle){let e=this.node.getComponent(ZF);e&&(_At.set(e.color),_At.a=t,e.color=_At),e=this._handle.getComponent(ZF),e&&(_At.set(e.color),_At.a=t,e.color=_At)}}_updateHandlerPosition(t){if(this._handle){const e=dAt;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}}_fixupHandlerPosition(t){const e=this.node._uiProps.uiTransformComp,i=e.contentSize,s=e.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,n=this.handle.node.parent;Ki.set(cAt,-i.width*s.x,-i.height*s.y,0);const o=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(cAt,uAt),a=t;a.set(0,0,0),n._uiProps.uiTransformComp.convertToNodeSpaceAR(o,a),0===this.direction?a.set(a.x,a.y+(i.height-r.height)/2,a.z):1===this.direction&&a.set(a.x+(i.width-r.width)/2,a.y,a.z),this.handle.node.setPosition(a)}_conditionalDisableScrollBar(t,e){return t.width<=e.width&&0===this._direction||t.height<=e.height&&1===this._direction}_calculateLength(t,e,i,s){let r=t;return s&&(r+=20*(s>0?s:-s)),i*(e/r)}_calculatePosition(t,e,i,s,r,n,o){let a=e-i;n&&(a+=Math.abs(n));let h=0;a&&(h=r/a,h=mi(h));const l=(s-o)*h;1===this._direction?t.set(0,l):t.set(l,0)}_updateLength(t){if(this._handle){const e=this._handle.node._uiProps.uiTransformComp,i=e.contentSize,s=e.anchorPoint;s.x===pAt.x&&s.y===pAt.y||e.setAnchorPoint(pAt),0===this._direction?e.setContentSize(t,i.height):e.setContentSize(i.width,t)}}_processAutoHide(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);const t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},lAt.Direction=fAt,s((sAt=lAt).prototype,"handle",[tAt],Object.getOwnPropertyDescriptor(sAt.prototype,"handle"),sAt.prototype),s(sAt.prototype,"direction",[eAt],Object.getOwnPropertyDescriptor(sAt.prototype,"direction"),sAt.prototype),rAt=Qo(sAt.prototype,"_scrollView",[va],(function(){return null})),nAt=Qo(sAt.prototype,"_handle",[va],(function(){return null})),oAt=Qo(sAt.prototype,"_direction",[va],(function(){return 0})),aAt=Qo(sAt.prototype,"_enableAutoHide",[va],(function(){return!1})),hAt=Qo(sAt.prototype,"_autoHideTime",[va],(function(){return 1})),iAt=sAt))||iAt)||iAt)||iAt));var yAt;l.ScrollBar=mAt;let vAt=t("ViewGroup",oa("cc.ViewGroup")(yAt=ha(110)(yAt=class extends Ag{})||yAt)||yAt);var bAt,wAt,SAt,xAt,TAt,CAt,IAt,EAt,DAt,AAt,MAt,PAt,BAt,RAt,OAt,LAt,FAt,zAt,kAt,NAt,UAt;l.ViewGroup=vAt;const VAt=1e-4,HAt=Zi(),GAt=Zi(),WAt=Ks(),jAt=Ks(),$At=()=>(new Date).getMilliseconds(),qAt={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12},XAt={anchor:Ks(),applyToHorizontal:!1,applyToVertical:!1},YAt=(t,e,i,s)=>{XAt.anchor.set(t,e),XAt.applyToHorizontal=i,XAt.applyToVertical=s},QAt={NONE:"",SCROLL_TO_TOP:"scroll-to-top",SCROLL_TO_BOTTOM:"scroll-to-bottom",SCROLL_TO_LEFT:"scroll-to-left",SCROLL_TO_RIGHT:"scroll-to-right",SCROLL_BEGAN:"scroll-began",SCROLL_ENDED:"scroll-ended",BOUNCE_TOP:"bounce-top",BOUNCE_BOTTOM:"bounce-bottom",BOUNCE_LEFT:"bounce-left",BOUNCE_RIGHT:"bounce-right",SCROLLING:"scrolling",SCROLL_ENG_WITH_THRESHOLD:"scroll-ended-with-threshold",TOUCH_UP:"touch-up"};let KAt=t("ScrollView",(bAt=oa("cc.ScrollView"),wAt=ha(110),SAt=aa(pO),xAt=Ga(JS),TAt=Ga(mAt),CAt=Ga(mAt),IAt=Ga([yg]),bAt(EAt=wAt(EAt=SAt((UAt=class extends vAt{get content(){return this._content}set content(t){if(this._content===t)return;const e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):N(4302)}get horizontalScrollBar(){const t=this._horizontalScrollBar;return t&&!t.isValid&&j(4303,"horizontal",this.node.name),t}set horizontalScrollBar(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Qs.ZERO)))}get verticalScrollBar(){const t=this._verticalScrollBar;return t&&!t.isValid&&j(4303,"vertical",this.node.name),t}set verticalScrollBar(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Qs.ZERO)))}get view(){const t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}constructor(){super(),this.bounceDuration=AAt&&AAt(),this.brake=MAt&&MAt(),this.elastic=PAt&&PAt(),this.inertia=BAt&&BAt(),this.horizontal=RAt&&RAt(),this.vertical=OAt&&OAt(),this.cancelInnerEvents=LAt&&LAt(),this.scrollEvents=FAt&&FAt(),this._autoScrolling=!1,this._scrolling=!1,this._content=zAt&&zAt(),this._horizontalScrollBar=kAt&&kAt(),this._verticalScrollBar=NAt&&NAt(),this._topBoundary=0,this._bottomBoundary=0,this._leftBoundary=0,this._rightBoundary=0,this._touchMoveDisplacements=[],this._touchMoveTimeDeltas=[],this._touchMovePreviousTimestamp=0,this._touchMoved=!1,this._autoScrollAttenuate=!1,this._autoScrollStartPosition=new Ki,this._autoScrollTargetDelta=new Ki,this._autoScrollTotalTime=0,this._autoScrollAccumulatedTime=0,this._autoScrollCurrentlyOutOfBoundary=!1,this._autoScrollBraking=!1,this._autoScrollBrakingStartPosition=new Ki,this._outOfBoundaryAmount=new Ki,this._outOfBoundaryAmountDirty=!0,this._stopMouseWheel=!1,this._mouseWheelEventElapsedTime=0,this._isScrollEndedWithThresholdEventFired=!1,this._scrollEventEmitMask=0,this._isBouncing=!1,this._contentPos=new Ki,this._deltaPos=new Ki,this._deltaAmount=new Ki,this._hoverIn=0}scrollToBottom(t,e){void 0===e&&(e=!0),this._doScroll(0,0,!1,!0,t,e)}scrollToTop(t,e){void 0===e&&(e=!0),this._doScroll(0,1,!1,!0,t,e)}scrollToLeft(t,e){void 0===e&&(e=!0),this._doScroll(0,0,!0,!1,t,e)}scrollToRight(t,e){void 0===e&&(e=!0),this._doScroll(1,0,!0,!1,t,e)}scrollToTopLeft(t,e){void 0===e&&(e=!0),this._doScroll(0,1,!0,!0,t,e)}scrollToTopRight(t,e){void 0===e&&(e=!0),this._doScroll(1,1,!0,!0,t,e)}scrollToBottomLeft(t,e){void 0===e&&(e=!0),this._doScroll(0,0,!0,!0,t,e)}scrollToBottomRight(t,e){void 0===e&&(e=!0),this._doScroll(1,0,!0,!0,t,e)}scrollToOffset(t,e,i){void 0===i&&(i=!0);const s=this.getMaxScrollOffset(),r=Ks();0===s.x?r.x=0:r.x=t.x/s.x,0===s.y?r.y=1:r.y=(s.y-t.y)/s.y,this.scrollTo(r,e,i)}getScrollOffset(){const t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new Qs(e,t)}getMaxScrollOffset(){if(!this._content||!this.view)return Qs.ZERO;const t=this._content._uiProps.uiTransformComp.contentSize;let e=t.width-this.view.width,i=t.height-this.view.height;return e=e>=0?e:0,i=i>=0?i:0,new Qs(e,i)}scrollToPercentHorizontal(t,e,i){this._doScroll(t,0,!0,!1,e,i)}scrollTo(t,e,i){this._doScroll(t.x,t.y,!0,!0,e,i)}scrollToPercentVertical(t,e,i){this._doScroll(0,t,!1,!0,e,i)}_doScroll(t,e,i,s,r,n){void 0===n&&(n=!0),YAt(t,e,i,s);const o=this._calculateMovePercentDelta(XAt);r?this._startAutoScroll(o,r,n):this._moveContent(o)}stopAutoScroll(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}setContentPosition(t){this._setContentPosition(t)}_setContentPosition(t){if(!this._content)return;const e=this._getContentPosition();Math.abs(t.x-e.x)<VAt&&Math.abs(t.y-e.y)<VAt||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}getContentPosition(){return this._getContentPosition()}_getContentPosition(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Ki.ZERO.clone()}isScrolling(){return this._scrolling}isAutoScrolling(){return this._autoScrolling}getScrollEndedEventTiming(){return VAt}start(){this._calculateBoundary(),this._content&&uP.once("director_before_draw",this._adjustContentOutOfBoundary,this)}onEnable(){const t=this;{t._registerEvent();const e=this._content;if(e){e.on("size-changed",t._calculateBoundary,t),e.on("transform-changed",t._scaleChanged,t);const i=t.view;i&&(i.node.on("transform-changed",t._scaleChanged,t),i.node.on("size-changed",t._calculateBoundary,t))}t._calculateBoundary()}t._updateScrollBarState()}update(t){const e=this._deltaAmount;this._autoScrolling?(this._processAutoScrolling(t),e.x=0,e.y=0):0===e.x&&0===e.y||(this._processDeltaMove(e),e.x=0,e.y=0)}onDisable(){const t=this;{t._unregisterEvent();const e=t.content;if(e){e.off("size-changed",t._calculateBoundary,t),e.off("transform-changed",t._scaleChanged,t);const i=t.view;i&&(i.node.off("transform-changed",t._scaleChanged,t),i.node.off("size-changed",t._calculateBoundary,t))}}t._deltaAmount.set(0,0),t._hideScrollBar(),t.stopAutoScroll()}_registerEvent(){const t=this,e=t.node;e.on("touch-start",t._onTouchBegan,t,!0),e.on("touch-move",t._onTouchMoved,t,!0),e.on("touch-end",t._onTouchEnded,t,!0),e.on("touch-cancel",t._onTouchCancelled,t,!0),e.on("mouse-wheel",t._onMouseWheel,t,!0),e.on("xrui-hover-entered",t._xrHoverEnter,t),e.on("xrui-hover-exited",t._xrHoverExit,t),ZD.on("handle-input",t._dispatchEventHandleInput,t),ZD.on("gamepad-input",t._dispatchEventHandleInput,t)}_unregisterEvent(){const t=this,e=t.node;e.off("touch-start",t._onTouchBegan,t,!0),e.off("touch-move",t._onTouchMoved,t,!0),e.off("touch-end",t._onTouchEnded,t,!0),e.off("touch-cancel",t._onTouchCancelled,t,!0),e.off("mouse-wheel",t._onMouseWheel,t,!0),e.off("xrui-hover-entered",t._xrHoverEnter,t),e.off("xrui-hover-exited",t._xrHoverExit,t),ZD.off("handle-input",t._dispatchEventHandleInput,t),ZD.off("gamepad-input",t._dispatchEventHandleInput,t)}_onMouseWheel(t,e){const i=this;if(i.enabledInHierarchy)return;if(i._hasNestedViewGroup(t,e))return;const s=t.getScrollY(),r=HAt;i.vertical?r.set(0,-.1*s,0):i.horizontal&&r.set(-.1*s,0,0),i._mouseWheelEventElapsedTime=0,i._deltaAmount.add(r),i._stopMouseWheel||(i._handlePressLogic(),i.schedule(this._checkMouseWheel,1/60),i._stopMouseWheel=!0),i._stopPropagationIfTargetIsMe(t)}_onTouchBegan(t,e){const i=this;i.enabledInHierarchy&&i._content&&(i._hasNestedViewGroup(t,e)||(i._handlePressLogic(),i._touchMoved=!1,i._stopPropagationIfTargetIsMe(t)))}_onTouchMoved(t,e){const i=this;if(!i.enabledInHierarchy||!i._content)return;if(i._hasNestedViewGroup(t,e))return;const s=t.touch;if(i._handleMoveLogic(s),!i.cancelInnerEvents)return;const r=s.getUILocation(WAt);if(r.subtract(s.getUIStartLocation(jAt)),r.length()>7&&!i._touchMoved&&t.target!==i.node){const e=new oD(t.getTouches(),t.bubbles,"touch-cancel");e.touch=t.touch,e.simulate=!0,t.target.dispatchEvent(e),i._touchMoved=!0}i._stopPropagationIfTargetIsMe(t)}_onTouchEnded(t,e){const i=this;if(!i.enabledInHierarchy||!i._content||!t)return;if(i._hasNestedViewGroup(t,e))return;i._dispatchEvent("touch-up");const s=t.touch;i._handleReleaseLogic(s),i._touchMoved?t.propagationStopped=!0:i._stopPropagationIfTargetIsMe(t)}_onTouchCancelled(t,e){const i=this;i.enabledInHierarchy&&i._content&&(i._hasNestedViewGroup(t,e)||(t&&!t.simulate&&i._handleReleaseLogic(t.touch),i._stopPropagationIfTargetIsMe(t)))}_calculateBoundary(){const t=this;if(t._content&&t.view){const e=t._content.getComponent(LDt);e&&e.enabledInHierarchy&&e.updateLayout();const i=t.view,s=i.width*i.anchorX,r=i.height*i.anchorY;t._leftBoundary=-s,t._bottomBoundary=-r,t._rightBoundary=t._leftBoundary+i.width,t._topBoundary=t._bottomBoundary+i.height,t._moveContentToTopLeft(i.contentSize)}}_hasNestedViewGroup(t,e){if(!t||t.eventPhase!==eD.CAPTURING_PHASE)return!1;if(e)for(const i of e){if(this.node===i)return!(!t.target||!t.target.getComponent(vAt));if(i.getComponent(vAt))return!0}return!1}_startInertiaScroll(t){HAt.set(t),HAt.multiplyScalar(.7),this._startAttenuatingAutoScroll(HAt,t)}_calculateAttenuatedFactor(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))}_startAttenuatingAutoScroll(t,e){const i=t.clone();if(i.normalize(),this._content&&this.view){const t=this._content._uiProps.uiTransformComp.contentSize,e=this.view.contentSize,s=t.width-e.width,r=t.height-e.height,n=this._calculateAttenuatedFactor(s),o=this._calculateAttenuatedFactor(r);i.x=i.x*s*(1-this.brake)*n,i.y=i.y*r*o*(1-this.brake),i.z=0}const s=t.length();let r=i.length()/s;this.brake>0&&r>7?(r=Math.sqrt(r),i.set(t),i.multiplyScalar(r+1)):i.add(t);let n=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&r>3&&(r=3,n*=r),0===this.brake&&r>1&&(n*=r),this._startAutoScroll(i,n,!0)}_calculateAutoScrollTimeByInitialSpeed(t){return Math.sqrt(Math.sqrt(t/5))}_startAutoScroll(t,e,i){void 0===i&&(i=!1);const s=this,r=s._flattenVectorByDirection(t);s._autoScrolling=!0,s._autoScrollTargetDelta=r,s._autoScrollAttenuate=i,Ki.copy(s._autoScrollStartPosition,s._getContentPosition()),s._autoScrollTotalTime=e,s._autoScrollAccumulatedTime=0,s._autoScrollBraking=!1,s._isScrollEndedWithThresholdEventFired=!1,s._autoScrollBrakingStartPosition.set(0,0,0),s._getHowMuchOutOfBoundary().equals(Ki.ZERO,VAt)||(this._autoScrollCurrentlyOutOfBoundary=!0)}_calculateTouchMoveVelocity(){const t=new Ki;let e=0;if(e=this._touchMoveTimeDeltas.reduce(((t,e)=>t+e),e),e<=0||e>=.5)t.set(Ki.ZERO);else{let i=HAt;i.set(0,0,0),i=this._touchMoveDisplacements.reduce(((t,e)=>(t.add(e),t)),i),t.set(i.x*(1-this.brake)/e,i.y*(1-this.brake)/e,i.z)}return t}_flattenVectorByDirection(t){return this.horizontal||(t.x=0),this.vertical||(t.y=0),t}_moveContent(t,e){const i=this._flattenVectorByDirection(t);HAt.set(this._getContentPosition()),HAt.add(i),HAt.set(Math.round(1e4*HAt.x)*VAt,Math.round(1e4*HAt.y)*VAt,HAt.z),this._setContentPosition(HAt);const s=this._getHowMuchOutOfBoundary();WAt.set(s.x,s.y),this._updateScrollBar(WAt),this.elastic&&e&&this._startBounceBackIfNeeded()}_getContentLeftBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width}_getContentRightBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width}_getContentTopBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height}_getContentBottomBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height}_getHowMuchOutOfBoundary(t){if(t||(t=Ki.ZERO),t.equals(Ki.ZERO,VAt)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;const e=new Ki,i=this._getContentLeftBoundary(),s=this._getContentRightBoundary();i+t.x>this._leftBoundary?e.x=this._leftBoundary-(i+t.x):s+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(s+t.x));const r=this._getContentTopBoundary(),n=this._getContentBottomBoundary();return r+t.y<this._topBoundary?e.y=this._topBoundary-(r+t.y):n+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(n+t.y)),t.equals(Ki.ZERO,VAt)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e}_updateScrollBar(t){this._horizontalScrollBar&&this._horizontalScrollBar.isValid&&this._horizontalScrollBar.onScroll(t),this._verticalScrollBar&&this._verticalScrollBar.isValid&&this._verticalScrollBar.onScroll(t)}_onScrollBarTouchBegan(){this._horizontalScrollBar&&this._horizontalScrollBar.isValid&&this._horizontalScrollBar.onTouchBegan(),this._verticalScrollBar&&this._verticalScrollBar.isValid&&this._verticalScrollBar.onTouchBegan()}_onScrollBarTouchEnded(){this._horizontalScrollBar&&this._horizontalScrollBar.isValid&&this._horizontalScrollBar.onTouchEnded(),this._verticalScrollBar&&this._verticalScrollBar.isValid&&this._verticalScrollBar.onTouchEnded()}_dispatchEvent(t){if("scroll-ended"===t)this._scrollEventEmitMask=0;else if("scroll-to-top"===t||"scroll-to-bottom"===t||"scroll-to-left"===t||"scroll-to-right"===t){const e=1<<qAt[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}yg.emitEvents(this.scrollEvents,this,qAt[t]),this.node.emit(t,this)}_adjustContentOutOfBoundary(){if(!this._content)return;this._outOfBoundaryAmountDirty=!0;const t=this._getHowMuchOutOfBoundary();!t.equals(Ki.ZERO,VAt)&&(HAt.set(this._getContentPosition()),HAt.add(t),this._setContentPosition(HAt),this._updateScrollBar(Qs.ZERO))}_hideScrollBar(){this._horizontalScrollBar&&this._horizontalScrollBar.isValid&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.isValid&&this._verticalScrollBar.hide()}_updateScrollBarState(){const t=this;if(!t._content||!t.view)return;const e=t.view,i=t._content._uiProps.uiTransformComp,s=t._verticalScrollBar;s&&s.isValid&&(i.height<e.height||gi(i.height,e.height)?s.hide():s.show());const r=t._horizontalScrollBar;r&&r.isValid&&(i.width<e.width||gi(i.width,e.width)?r.hide():r.show())}_stopPropagationIfTargetIsMe(t){t.eventPhase===eD.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)}_processDeltaMove(t){this._scrollChildren(t),this._gatherTouchMove(t)}_handleMoveLogic(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._deltaAmount.add(this._deltaPos)}_handleReleaseLogic(t){const e=this;e._getLocalAxisAlignDelta(e._deltaPos,t),e._gatherTouchMove(e._deltaPos),e._processInertiaScroll(),e._scrolling&&(e._scrolling=!1,e._autoScrolling||e._dispatchEvent("scroll-ended"))}_getLocalAxisAlignDelta(t,e){const i=this.node._uiProps.uiTransformComp;i&&(e.getUILocation(WAt),e.getUIPreviousLocation(jAt),HAt.set(WAt.x,WAt.y,0),GAt.set(jAt.x,jAt.y,0),i.convertToNodeSpaceAR(HAt,HAt),i.convertToNodeSpaceAR(GAt,GAt),Ki.subtract(t,HAt,GAt))}_scrollChildren(t){const e=this;e._clampDelta(t);const i=t;let s;e.elastic&&(s=e._getHowMuchOutOfBoundary(),i.x*=0===s.x?1:.5,i.y*=0===s.y?1:.5),e.elastic||(s=e._getHowMuchOutOfBoundary(i),i.add(s));let r="",n="";if(e._content){const{anchorX:t,anchorY:s,width:o,height:a}=e._content._uiProps.uiTransformComp,h=e._content.position||Ki.ZERO;e.vertical&&(i.y>0?h.y-s*a+i.y>=e._bottomBoundary&&(r="scroll-to-bottom"):i.y<0&&h.y-s*a+a+i.y<=e._topBoundary&&(r="scroll-to-top")),e.horizontal&&(i.x<0?h.x-t*o+o+i.x<=e._rightBoundary&&(n="scroll-to-right"):i.x>0&&h.x-t*o+i.x>=e._leftBoundary&&(n="scroll-to-left"))}e._moveContent(i,!1),(e.horizontal&&0!==i.x||e.vertical&&0!==i.y)&&(e._scrolling||(e._scrolling=!0,e._dispatchEvent("scroll-began")),e._dispatchEvent("scrolling")),""!==r&&e._dispatchEvent(r),""!==n&&e._dispatchEvent(n)}_handlePressLogic(){const t=this;t._autoScrolling&&t._dispatchEvent("scroll-ended"),t._autoScrolling=!1,t._isBouncing=!1,t._touchMovePreviousTimestamp=$At(),t._touchMoveDisplacements.length=0,t._touchMoveTimeDeltas.length=0,t._onScrollBarTouchBegan()}_clampDelta(t){if(this._content&&this.view){const e=this.view.contentSize,i=this._content._uiProps.uiTransformComp;i.width<e.width&&(t.x=0),i.height<e.height&&(t.y=0)}}_gatherTouchMove(t){const e=this,i=t.clone();for(e._clampDelta(i);e._touchMoveDisplacements.length>=5;)e._touchMoveDisplacements.shift(),e._touchMoveTimeDeltas.shift();e._touchMoveDisplacements.push(i);const s=$At();e._touchMoveTimeDeltas.push((s-e._touchMovePreviousTimestamp)/1e3),e._touchMovePreviousTimestamp=s}_startBounceBackIfNeeded(){const t=this;if(!t.elastic)return!1;const e=t._getHowMuchOutOfBoundary();if(t._clampDelta(e),e.equals(Ki.ZERO,VAt))return!1;const i=Math.max(t.bounceDuration,0);return t._startAutoScroll(e,i,!0),t._isBouncing||(e.y>0&&t._dispatchEvent("bounce-top"),e.y<0&&t._dispatchEvent("bounce-bottom"),e.x>0&&t._dispatchEvent("bounce-right"),e.x<0&&t._dispatchEvent("bounce-left"),t._isBouncing=!0),!0}_processInertiaScroll(){if(!this._startBounceBackIfNeeded()&&this.inertia){const t=this._calculateTouchMoveVelocity();!t.equals(Ki.ZERO,VAt)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()}_isOutOfBoundary(){return!this._getHowMuchOutOfBoundary().equals(Ki.ZERO,VAt)}_isNecessaryAutoScrollBrake(){const t=this;if(t._autoScrollBraking)return!0;if(t._isOutOfBoundary()){if(!t._autoScrollCurrentlyOutOfBoundary)return t._autoScrollCurrentlyOutOfBoundary=!0,t._autoScrollBraking=!0,Ki.copy(t._autoScrollBrakingStartPosition,t._getContentPosition()),!0}else t._autoScrollCurrentlyOutOfBoundary=!1;return!1}_processAutoScrolling(t){const e=this,i=e._isNecessaryAutoScrollBrake(),s=i?.05:1;e._autoScrollAccumulatedTime+=t*(1/s);let r=Math.min(1,e._autoScrollAccumulatedTime/e._autoScrollTotalTime);var n;e._autoScrollAttenuate&&(n=r,r=(n-=1)*n*n*n*n+1);const o=e._autoScrollTargetDelta.clone();o.multiplyScalar(r);const a=e._autoScrollStartPosition.clone();a.add(o);let h=Math.abs(r-1)<=VAt;if(Math.abs(r-1)<=e.getScrollEndedEventTiming()&&!e._isScrollEndedWithThresholdEventFired&&(e._dispatchEvent("scroll-ended-with-threshold"),e._isScrollEndedWithThresholdEventFired=!0),e.elastic){const t=a.clone();t.subtract(e._autoScrollBrakingStartPosition),i&&t.multiplyScalar(s),a.set(e._autoScrollBrakingStartPosition),a.add(t)}else{const t=a.clone();t.subtract(e.getContentPosition());const i=e._getHowMuchOutOfBoundary(t);i.equals(Ki.ZERO,VAt)||(a.add(i),h=!0)}h&&(e._autoScrolling=!1);const l=a.clone();l.subtract(e._getContentPosition()),e._clampDelta(l),e._moveContent(l,h),e._dispatchEvent("scrolling"),e._autoScrolling||(e._isBouncing=!1,e._scrolling=!1,e._dispatchEvent("scroll-ended"))}_checkMouseWheel(t){const e=this;if(!e._getHowMuchOutOfBoundary().equals(Ki.ZERO,VAt))return e._processInertiaScroll(),e._scrolling&&(e._scrolling=!1,e._autoScrolling||e._dispatchEvent("scroll-ended")),e.unschedule(e._checkMouseWheel),void(e._stopMouseWheel=!1);e._mouseWheelEventElapsedTime+=t,e._mouseWheelEventElapsedTime>.1&&(e._onScrollBarTouchEnded(),e._scrolling&&(e._scrolling=!1,e._autoScrolling||e._dispatchEvent("scroll-ended")),e.unschedule(e._checkMouseWheel),e._stopMouseWheel=!1)}_calculateMovePercentDelta(t){const e=t.anchor,i=t.applyToHorizontal,s=t.applyToVertical,r=this;r._calculateBoundary(),e.clampf(Qs.ZERO,Qs.ONE);let n=r._getContentBottomBoundary()-r._bottomBoundary;n=-n;let o=r._getContentLeftBoundary()-r._leftBoundary;o=-o;const a=new Ki;if(r._content&&r.view){let t=0;const h=r._content._uiProps.uiTransformComp.contentSize,l=r.view.contentSize;i&&(t=h.width-l.width,a.x=o-t*e.x),s&&(t=h.height-l.height,a.y=n-t*e.y)}return a}_moveContentToTopLeft(t){const e=this;let i=e._getContentBottomBoundary()-e._bottomBoundary;i=-i;const s=new Ki;let r=0,n=e._getContentLeftBoundary()-e._leftBoundary;if(n=-n,e._content){const o=e._content._uiProps.uiTransformComp.contentSize;o.height<t.height&&(r=o.height-t.height,s.y=i-r),o.width<t.width&&(r=o.width-t.width,s.x=n)}e._updateScrollBarState(),e._moveContent(s),e._adjustContentOutOfBoundary()}_scaleChanged(t){4===t&&this._calculateBoundary()}_xrHoverEnter(t){1===t.deviceType?this._hoverIn=1:2===t.deviceType&&(this._hoverIn=2)}_xrHoverExit(t){this._hoverIn=0}_dispatchEventHandleInput(t){let e,i;t instanceof aD?e=t.gamepad:t instanceof hD&&(e=t.handleInputDevice),this.enabledInHierarchy&&0!==this._hoverIn&&(1===this._hoverIn?(i=e.leftStick.getValue(),i.equals(Qs.ZERO)||this._xrThumbStickMove(i)):2===this._hoverIn&&(i=e.rightStick.getValue(),i.equals(Qs.ZERO)||this._xrThumbStickMove(i)))}_xrThumbStickMove(t){const e=this;if(!e.enabledInHierarchy)return;const i=t.y,s=HAt;e.vertical?s.set(0,-62.5*i,0):e.horizontal&&s.set(-62.5*i,0,0),e._mouseWheelEventElapsedTime=0,e._deltaAmount.add(s),e._stopMouseWheel||(e._handlePressLogic(),e.schedule(e._checkMouseWheel,1/60,NaN,0),e._stopMouseWheel=!0)}},UAt.EventType=QAt,AAt=Qo((DAt=UAt).prototype,"bounceDuration",[va],(function(){return 1})),MAt=Qo(DAt.prototype,"brake",[va],(function(){return.5})),PAt=Qo(DAt.prototype,"elastic",[va],(function(){return!0})),BAt=Qo(DAt.prototype,"inertia",[va],(function(){return!0})),s(DAt.prototype,"content",[xAt],Object.getOwnPropertyDescriptor(DAt.prototype,"content"),DAt.prototype),RAt=Qo(DAt.prototype,"horizontal",[va],(function(){return!0})),s(DAt.prototype,"horizontalScrollBar",[TAt],Object.getOwnPropertyDescriptor(DAt.prototype,"horizontalScrollBar"),DAt.prototype),OAt=Qo(DAt.prototype,"vertical",[va],(function(){return!0})),s(DAt.prototype,"verticalScrollBar",[CAt],Object.getOwnPropertyDescriptor(DAt.prototype,"verticalScrollBar"),DAt.prototype),LAt=Qo(DAt.prototype,"cancelInnerEvents",[va],(function(){return!0})),FAt=Qo(DAt.prototype,"scrollEvents",[IAt,va],(function(){return[]})),zAt=Qo(DAt.prototype,"_content",[va],(function(){return null})),kAt=Qo(DAt.prototype,"_horizontalScrollBar",[va],(function(){return null})),NAt=Qo(DAt.prototype,"_verticalScrollBar",[va],(function(){return null})),EAt=DAt))||EAt)||EAt)||EAt));var ZAt,JAt,tMt,eMt,iMt,sMt,rMt,nMt,oMt,aMt,hMt,lMt,cMt;l.ScrollView=KAt;const uMt=new Ki,dMt={Horizontal:0,Vertical:1};se(dMt);let pMt=t("Slider",(ZAt=oa("cc.Slider"),JAt=ha(110),tMt=aa(pO),eMt=Ga(ZF),iMt=Ga(dMt),sMt=Ga([yg]),ZAt(rMt=JAt(rMt=tMt((cMt=class extends Ag{get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._changeLayout())}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}constructor(){super(),this.slideEvents=oMt&&oMt(),this._handle=aMt&&aMt(),this._direction=hMt&&hMt(),this._progress=lMt&&lMt(),this._offset=new Ki,this._dragging=!1,this._touchHandle=!1,this._handleLocalPos=new Ki,this._touchPos=new Ki}__preload(){this._updateHandlePosition()}onEnable(){this._updateHandlePosition(),this.node.on("touch-start",this._onTouchBegan,this),this.node.on("touch-move",this._onTouchMoved,this),this.node.on("touch-end",this._onTouchEnded,this),this.node.on("touch-cancel",this._onTouchCancelled,this),this.node.on("xrui-hover-stay",this._xrHoverStay,this),this.node.on("xrui-click",this._xrClick,this),this.node.on("xrui-unclick",this._xrUnClick,this),this._handle&&this._handle.isValid&&(this._handle.node.on("touch-start",this._onHandleDragStart,this),this._handle.node.on("touch-move",this._onTouchMoved,this),this._handle.node.on("touch-end",this._onTouchEnded,this))}onDisable(){this.node.off("touch-start",this._onTouchBegan,this),this.node.off("touch-move",this._onTouchMoved,this),this.node.off("touch-end",this._onTouchEnded,this),this.node.off("touch-cancel",this._onTouchCancelled,this),this.node.off("xrui-hover-stay",this._xrHoverStay,this),this.node.off("xrui-click",this._xrClick,this),this.node.off("xrui-unclick",this._xrUnClick,this),this._handle&&this._handle.isValid&&(this._handle.node.off("touch-start",this._onHandleDragStart,this),this._handle.node.off("touch-move",this._onTouchMoved,this),this._handle.node.off("touch-end",this._onTouchEnded,this))}_onHandleDragStart(t){if(!t||!this._handle||!this._handle.node._uiProps.uiTransformComp)return;this._dragging=!0,this._touchHandle=!0;const e=t.touch.getUILocation();Ki.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}_onTouchBegan(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchMoved(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchEnded(t){this._dragging=!1,this._touchHandle=!1,this._offset=new Ki,t&&(t.propagationStopped=!0)}_onTouchCancelled(t){this._dragging=!1,t&&(t.propagationStopped=!0)}_handleSliderLogic(t){this._updateProgress(t),this._emitSlideEvent()}_emitSlideEvent(){yg.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}_updateProgress(t){if(!this._handle||!t)return;const e=t.getUILocation();Ki.set(this._touchPos,e.x,e.y,0);const i=this.node._uiProps.uiTransformComp,s=i.convertToNodeSpaceAR(this._touchPos,uMt);0===this.direction?this.progress=mi(.5+(s.x-this._offset.x)/i.width):this.progress=mi(.5+(s.y-this._offset.y)/i.height)}_updateHandlePosition(){if(!this._handle)return;this._handleLocalPos.set(this._handle.node.position);const t=this.node._uiProps.uiTransformComp;0===this._direction?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}_changeLayout(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){const t=this._handle.node.position;0===this._direction?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}_xrHandleProgress(t){if(!this._touchHandle){const e=this.node._uiProps.uiTransformComp;e.convertToNodeSpaceAR(t,uMt),0===this.direction?this.progress=mi(.5+(uMt.x-this.node.position.x)/e.width):this.progress=mi(.5+(uMt.y-this.node.position.y)/e.height)}}_xrClick(t){this._handle&&(this._dragging=!0,this._xrHandleProgress(t.hitPoint),this._emitSlideEvent())}_xrUnClick(){this._dragging=!1,this._touchHandle=!1}_xrHoverStay(t){this._dragging&&(this._xrHandleProgress(t.hitPoint),this._emitSlideEvent())}},cMt.Direction=dMt,s((nMt=cMt).prototype,"handle",[eMt],Object.getOwnPropertyDescriptor(nMt.prototype,"handle"),nMt.prototype),s(nMt.prototype,"direction",[iMt],Object.getOwnPropertyDescriptor(nMt.prototype,"direction"),nMt.prototype),oMt=Qo(nMt.prototype,"slideEvents",[sMt,va],(function(){return[]})),aMt=Qo(nMt.prototype,"_handle",[va],(function(){return null})),hMt=Qo(nMt.prototype,"_direction",[va],(function(){return 0})),lMt=Qo(nMt.prototype,"_progress",[va],(function(){return.1})),rMt=nMt))||rMt)||rMt)||rMt));function _Mt(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return Object.assign({},...e)}var gMt,fMt,mMt,yMt,vMt,bMt,wMt,SMt,xMt,TMt,CMt;l.Slider=pMt;let IMt=t("Toggle",(gMt=oa("cc.Toggle"),fMt=ha(110),mMt=aa(pO),yMt=Ga(ZF),vMt=Ga([yg]),gMt(bMt=fMt(bMt=mMt((CMt=class t extends dEt{get isChecked(){return this._isChecked}set isChecked(t){this._set(t)}get checkMark(){return this._checkMark}set checkMark(t){this._checkMark!==t&&(this._checkMark=t)}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get _toggleContainer(){const t=this.node.parent;return l.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}constructor(){super(),this.checkEvents=SMt&&SMt(),this._isChecked=xMt&&xMt(),this._checkMark=TMt&&TMt()}_internalToggle(){this.isChecked=!this.isChecked}_set(t,e){if(void 0===e&&(e=!0),this._isChecked==t)return;this._isChecked=t;const i=this._toggleContainer;i&&i.enabled&&this.enabled&&(t||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}playEffect(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}setIsCheckedWithoutNotify(t){this._set(t,!1)}onEnable(){super.onEnable(),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)}onDisable(){super.onDisable(),this.node.off(t.EventType.CLICK,this._internalToggle,this)}_emitToggleEvents(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&yg.emitEvents(this.checkEvents,this)}},CMt.EventType=_Mt({TOGGLE:"toggle"},uEt),s((wMt=CMt).prototype,"checkMark",[yMt],Object.getOwnPropertyDescriptor(wMt.prototype,"checkMark"),wMt.prototype),SMt=Qo(wMt.prototype,"checkEvents",[vMt,va],(function(){return[]})),xMt=Qo(wMt.prototype,"_isChecked",[va],(function(){return!0})),TMt=Qo(wMt.prototype,"_checkMark",[va],(function(){return null})),bMt=wMt))||bMt)||bMt)||bMt));var EMt,DMt,AMt,MMt,PMt,BMt,RMt;l.Toggle=IMt;let OMt=t("ToggleContainer",(EMt=oa("cc.ToggleContainer"),DMt=ha(110),AMt=Ga([yg]),EMt(MMt=DMt((PMt=class extends Ag{get allowSwitchOff(){return this._allowSwitchOff}set allowSwitchOff(t){this._allowSwitchOff=t}constructor(){super(),this._allowSwitchOff=BMt&&BMt(),this.checkEvents=RMt&&RMt()}get toggleItems(){return this.node.children.map((t=>{const e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}onEnable(){this.ensureValidState(),this.node.on("child-added",this.ensureValidState,this),this.node.on("child-removed",this.ensureValidState,this)}onDisable(){this.node.off("child-added",this.ensureValidState,this),this.node.off("child-removed",this.ensureValidState,this)}activeToggles(){return this.toggleItems.filter((t=>t.isChecked))}anyTogglesChecked(){return!!this.toggleItems.find((t=>t.isChecked))}notifyToggleCheck(t,e){if(void 0===e&&(e=!0),this.enabledInHierarchy){for(let i=0;i<this.toggleItems.length;i++){const s=this.toggleItems[i];s!==t&&(e?s.isChecked=!1:s.setIsCheckedWithoutNotify(!1))}this.checkEvents&&l.Component.EventHandler.emitEvents(this.checkEvents,t)}}ensureValidState(){const t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){const e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}const e=this.activeToggles();if(e.length>1){const t=e[0];for(let i=0;i<e.length;++i){const s=e[i];s!==t&&(s.isChecked=!1)}}}},BMt=Qo(PMt.prototype,"_allowSwitchOff",[va],(function(){return!1})),RMt=Qo(PMt.prototype,"checkEvents",[AMt,va],(function(){return[]})),MMt=PMt))||MMt)||MMt));var LMt,FMt,zMt,kMt,NMt,UMt,VMt,HMt,GMt,WMt,jMt,$Mt,qMt,XMt,YMt,QMt,KMt,ZMt,JMt,tPt,ePt,iPt,sPt,rPt,nPt,oPt;l.ToggleContainer=OMt;const aPt=new Qs;function hPt(t){return t instanceof IE?Gn:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:br.ZERO}function lPt(t,e,i,s){t.parent?aPt.set(t.parent.scale.x,t.parent.scale.y):aPt.set(0,0);let r=aPt.x,n=aPt.y,o=0,a=0;for(let h=t.parent;;){if(!h)return i.x=i.y=0,void(s.x=s.y=1);const t=h.position;if(o+=t.x,a+=t.y,h=h.parent,h===e)break;{h?aPt.set(h.scale.x,h.scale.y):aPt.set(0,0);const t=aPt.x,e=aPt.y;o*=t,a*=e,r*=t,n*=e}}s.x=0!==r?1/r:1,s.y=0!==n?1/n:1,i.x=-o,i.y=-a}const cPt={ONCE:0,ALWAYS:1,ON_WINDOW_RESIZE:2};se(cPt);const uPt={TOP:1,MID:2,BOT:4,LEFT:8,CENTER:16,RIGHT:32,HORIZONTAL:56,VERTICAL:7};let dPt=t("Widget",(LMt=oa("cc.Widget"),FMt=ha(110),zMt=aa(pO),kMt=Ga(JS),NMt=Ga(cPt),LMt(UMt=FMt(UMt=zMt((oPt=class extends Ag{constructor(){super(),this._lastPos=new Ki,this._lastSize=new br,this._dirty=!0,this._hadAlignOnce=!1,this._alignFlags=HMt&&HMt(),this._target=GMt&&GMt(),this._left=WMt&&WMt(),this._right=jMt&&jMt(),this._top=$Mt&&$Mt(),this._bottom=qMt&&qMt(),this._horizontalCenter=XMt&&XMt(),this._verticalCenter=YMt&&YMt(),this._isAbsLeft=QMt&&QMt(),this._isAbsRight=KMt&&KMt(),this._isAbsTop=ZMt&&ZMt(),this._isAbsBottom=JMt&&JMt(),this._isAbsHorizontalCenter=tPt&&tPt(),this._isAbsVerticalCenter=ePt&&ePt(),this._originalWidth=iPt&&iPt(),this._originalHeight=sPt&&sPt(),this._alignMode=rPt&&rPt(),this._lockFlags=nPt&&nPt()}get target(){return this._target}set target(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}get isAlignTop(){return(1&this._alignFlags)>0}set isAlignTop(t){this._setAlign(1,t),this._recursiveDirty()}get isAlignBottom(){return(4&this._alignFlags)>0}set isAlignBottom(t){this._setAlign(4,t),this._recursiveDirty()}get isAlignLeft(){return(8&this._alignFlags)>0}set isAlignLeft(t){this._setAlign(8,t),this._recursiveDirty()}get isAlignRight(){return(32&this._alignFlags)>0}set isAlignRight(t){this._setAlign(32,t),this._recursiveDirty()}get isAlignVerticalCenter(){return(2&this._alignFlags)>0}set isAlignVerticalCenter(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=2):this._alignFlags&=-3,this._recursiveDirty()}get isAlignHorizontalCenter(){return(16&this._alignFlags)>0}set isAlignHorizontalCenter(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=16):this._alignFlags&=-17,this._recursiveDirty()}get isStretchWidth(){return!(40&~this._alignFlags)}get isStretchHeight(){return!(5&~this._alignFlags)}get top(){return this._top}set top(t){this._top=t,this._recursiveDirty()}get editorTop(){return this._isAbsTop?this._top:100*this._top}set editorTop(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}get bottom(){return this._bottom}set bottom(t){this._bottom=t,this._recursiveDirty()}get editorBottom(){return this._isAbsBottom?this._bottom:100*this._bottom}set editorBottom(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}get left(){return this._left}set left(t){this._left=t,this._recursiveDirty()}get editorLeft(){return this._isAbsLeft?this._left:100*this._left}set editorLeft(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}get right(){return this._right}set right(t){this._right=t,this._recursiveDirty()}get editorRight(){return this._isAbsRight?this._right:100*this._right}set editorRight(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}get horizontalCenter(){return this._horizontalCenter}set horizontalCenter(t){this._horizontalCenter=t,this._recursiveDirty()}get editorHorizontalCenter(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter}set editorHorizontalCenter(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}get verticalCenter(){return this._verticalCenter}set verticalCenter(t){this._verticalCenter=t,this._recursiveDirty()}get editorVerticalCenter(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter}set editorVerticalCenter(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}get isAbsoluteTop(){return this._isAbsTop}set isAbsoluteTop(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(1,this._isAbsTop))}get isAbsoluteBottom(){return this._isAbsBottom}set isAbsoluteBottom(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(4,this._isAbsBottom))}get isAbsoluteLeft(){return this._isAbsLeft}set isAbsoluteLeft(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(8,this._isAbsLeft))}get isAbsoluteRight(){return this._isAbsRight}set isAbsoluteRight(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(32,this._isAbsRight))}get isAbsoluteHorizontalCenter(){return this._isAbsHorizontalCenter}set isAbsoluteHorizontalCenter(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(16,this._isAbsHorizontalCenter))}get isAbsoluteVerticalCenter(){return this._isAbsVerticalCenter}set isAbsoluteVerticalCenter(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(2,this._isAbsVerticalCenter))}get alignMode(){return this._alignMode}set alignMode(t){this._alignMode=t,this._recursiveDirty()}get alignFlags(){return this._alignFlags}set alignFlags(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}updateAlignment(){h._widgetManager.updateAlignment(this.node)}_validateTargetInDEV(){}setDirty(){this._recursiveDirty()}onEnable(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),h._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()}onDisable(){h._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}onDestroy(){this._removeParentEvent()}_adjustWidgetToAllowMovingInEditor(t){}_adjustWidgetToAllowResizingInEditor(){}_adjustWidgetToAnchorChanged(){this.setDirty()}_adjustTargetToParentChanged(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()}_registerEvent(){this.node.on("transform-changed",this._setDirtyByMode,this),this.node.on("size-changed",this._setDirtyByMode,this),this.node.on("anchor-changed",this._adjustWidgetToAnchorChanged,this),this.node.on("parent-changed",this._adjustTargetToParentChanged,this)}_unregisterEvent(){this.node.off("transform-changed",this._setDirtyByMode,this),this.node.off("size-changed",this._setDirtyByMode,this),this.node.off("anchor-changed",this._adjustWidgetToAnchorChanged,this)}_removeParentEvent(){this.node.off("parent-changed",this._adjustTargetToParentChanged,this)}_autoChangedValue(t,e){if(!((this._alignFlags&t)>0))return;const i=this.node.parent&&this.node.parent._uiProps,s=i&&i.uiTransformComp,r=s?s.contentSize:Gn;this.isAlignLeft&&8===t?this._left=e?this._left*r.width:this._left/r.width:this.isAlignRight&&32===t?this._right=e?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&16===t?this._horizontalCenter=e?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&1===t?this._top=e?this._top*r.height:this._top/r.height:this.isAlignBottom&&4===t?this._bottom=e?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&2===t&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}_registerTargetEvents(){const t=this._target||this.node.parent;t&&t.getComponent(pO)&&(t.on("transform-changed",this._setDirtyByMode,this),t.on("size-changed",this._setDirtyByMode,this),t.on("anchor-changed",this._setDirtyByMode,this))}_unregisterTargetEvents(){const t=this._target||this.node.parent;t&&(t.off("transform-changed",this._setDirtyByMode,this),t.off("size-changed",this._setDirtyByMode,this),t.off("anchor-changed",this._setDirtyByMode,this))}_unregisterOldParentEvents(t){const e=this._target||t;e&&(e.off("transform-changed",this._setDirtyByMode,this),e.off("size-changed",this._setDirtyByMode,this))}_setDirtyByMode(){1===this.alignMode&&this._recursiveDirty()}_setAlign(t,e){if(e===(this._alignFlags&t)>0)return;const i=(40&t)>0,s=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=s.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=s.height))):(i?this.isStretchWidth&&(s.width=this._originalWidth):this.isStretchHeight&&(s.height=this._originalHeight),this._alignFlags&=~t)}_recursiveDirty(){this._dirty||(this._dirty=!0)}},oPt.AlignMode=cPt,s((VMt=oPt).prototype,"target",[kMt],Object.getOwnPropertyDescriptor(VMt.prototype,"target"),VMt.prototype),s(VMt.prototype,"alignMode",[NMt],Object.getOwnPropertyDescriptor(VMt.prototype,"alignMode"),VMt.prototype),HMt=Qo(VMt.prototype,"_alignFlags",[va],(function(){return 0})),GMt=Qo(VMt.prototype,"_target",[va],(function(){return null})),WMt=Qo(VMt.prototype,"_left",[va],(function(){return 0})),jMt=Qo(VMt.prototype,"_right",[va],(function(){return 0})),$Mt=Qo(VMt.prototype,"_top",[va],(function(){return 0})),qMt=Qo(VMt.prototype,"_bottom",[va],(function(){return 0})),XMt=Qo(VMt.prototype,"_horizontalCenter",[va],(function(){return 0})),YMt=Qo(VMt.prototype,"_verticalCenter",[va],(function(){return 0})),QMt=Qo(VMt.prototype,"_isAbsLeft",[va],(function(){return!0})),KMt=Qo(VMt.prototype,"_isAbsRight",[va],(function(){return!0})),ZMt=Qo(VMt.prototype,"_isAbsTop",[va],(function(){return!0})),JMt=Qo(VMt.prototype,"_isAbsBottom",[va],(function(){return!0})),tPt=Qo(VMt.prototype,"_isAbsHorizontalCenter",[va],(function(){return!0})),ePt=Qo(VMt.prototype,"_isAbsVerticalCenter",[va],(function(){return!0})),iPt=Qo(VMt.prototype,"_originalWidth",[va],(function(){return 0})),sPt=Qo(VMt.prototype,"_originalHeight",[va],(function(){return 0})),rPt=Qo(VMt.prototype,"_alignMode",[va],(function(){return 2})),nPt=Qo(VMt.prototype,"_lockFlags",[va,wa],(function(){return 0})),UMt=VMt))||UMt)||UMt)||UMt));var pPt,_Pt,gPt,fPt,mPt,yPt,vPt,bPt,wPt,SPt,xPt,TPt;h.internal.computeInverseTransForTarget=lPt,h.internal.getReadonlyNodeSize=hPt,h.Widget=dPt;const CPt=new _r,IPt={HORIZONTAL:0,VERTICAL:1};se(IPt);let EPt=t("PageViewIndicator",(pPt=oa("cc.PageViewIndicator"),_Pt=ha(110),gPt=Ga(yB),fPt=Ga(IPt),mPt=Ga(br),pPt(yPt=_Pt((TPt=class extends Ag{get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._spriteFrame!==t&&(this._spriteFrame=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t)}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize=t)}constructor(){super(),this.spacing=bPt&&bPt(),this._spriteFrame=wPt&&wPt(),this._direction=SPt&&SPt(),this._cellSize=xPt&&xPt(),this._layout=null,this._pageView=null,this._indicators=[]}onLoad(){this._updateLayout()}setPageView(t){this._pageView=t,this._refresh()}_updateLayout(){this._layout=this.getComponent(LDt),this._layout||(this._layout=this.addComponent(LDt));const t=this._layout;0===this.direction?(t.type=1,t.spacingX=this.spacing):1===this.direction&&(t.type=2,t.spacingY=this.spacing),t.resizeMode=1}_createIndicator(){const t=new JS;t.layer=this.node.layer;const e=t.addComponent(ZF);return e.spriteFrame=this.spriteFrame,e.sizeMode=ZF.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t}_changedState(){const t=this._indicators;if(0===t.length||!this._pageView)return;const e=this._pageView.curPageIdx;if(!(e>=t.length)){for(let e=0;e<t.length;++e){const i=t[e];if(!i._uiProps.uiComp)continue;const s=i._uiProps.uiComp;CPt.set(s.color),CPt.a=127.5,s.color=CPt}if(t[e]._uiProps.uiComp){const i=t[e]._uiProps.uiComp;CPt.set(i.color),CPt.a=255,i.color=CPt}}}_refresh(){if(!this._pageView)return;const t=this._indicators,e=this._pageView.getPages();if(e.length===t.length)return;let i=0;if(e.length>t.length)for(i=0;i<e.length;++i)t[i]||(t[i]=this._createIndicator());else for(i=t.length-e.length;i>0;--i){const e=t[i-1];this.node.removeChild(e),t.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}},TPt.Direction=IPt,s((vPt=TPt).prototype,"spriteFrame",[gPt],Object.getOwnPropertyDescriptor(vPt.prototype,"spriteFrame"),vPt.prototype),s(vPt.prototype,"direction",[fPt],Object.getOwnPropertyDescriptor(vPt.prototype,"direction"),vPt.prototype),s(vPt.prototype,"cellSize",[mPt],Object.getOwnPropertyDescriptor(vPt.prototype,"cellSize"),vPt.prototype),bPt=Qo(vPt.prototype,"spacing",[va],(function(){return 0})),wPt=Qo(vPt.prototype,"_spriteFrame",[va],(function(){return null})),SPt=Qo(vPt.prototype,"_direction",[va],(function(){return 0})),xPt=Qo(vPt.prototype,"_cellSize",[va],(function(){return new br(20,20)})),yPt=vPt))||yPt)||yPt));var DPt,APt,MPt,PPt,BPt,RPt,OPt,LPt,FPt,zPt,kPt,NPt,UPt,VPt,HPt,GPt,WPt,jPt,$Pt,qPt,XPt,YPt,QPt,KPt;l.PageViewIndicator=EPt;const ZPt=new Qs,JPt={Unified:0,Free:1};se(JPt);const tBt={HORIZONTAL:0,VERTICAL:1};se(tBt);let eBt=t("PageView",(DPt=oa("cc.PageView"),APt=ha(110),MPt=Ga(JPt),PPt=Ga(tBt),BPt=Ga(EPt),RPt=Ga(mAt),OPt=Ga(mAt),LPt=Ga([yg]),FPt=Ga([yg]),DPt(zPt=APt((KPt=class t extends KAt{get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}get scrollThreshold(){return this._scrollThreshold}set scrollThreshold(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}get pageTurningEventTiming(){return this._pageTurningEventTiming}set pageTurningEventTiming(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}get indicator(){return this._indicator}set indicator(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}get curPageIdx(){return this._curPageIdx}get verticalScrollBar(){return super.verticalScrollBar}set verticalScrollBar(t){super.verticalScrollBar=t}get horizontalScrollBar(){return super.horizontalScrollBar}set horizontalScrollBar(t){super.horizontalScrollBar=t}constructor(){super(),this.autoPageTurningThreshold=NPt&&NPt(),this.horizontal=UPt&&UPt(),this.vertical=VPt&&VPt(),this.cancelInnerEvents=HPt&&HPt(),this.scrollEvents=GPt&&GPt(),this.pageTurningSpeed=WPt&&WPt(),this.pageEvents=jPt&&jPt(),this._sizeMode=$Pt&&$Pt(),this._direction=qPt&&qPt(),this._scrollThreshold=XPt&&XPt(),this._pageTurningEventTiming=YPt&&YPt(),this._indicator=QPt&&QPt(),this._curPageIdx=0,this._lastPageIdx=0,this._pages=[],this._initContentPos=Zi(),this._scrollCenterOffsetX=[],this._scrollCenterOffsetY=[],this._touchBeganPosition=Ks(),this._touchEndPosition=Ks()}onEnable(){super.onEnable(),this.node.on("size-changed",this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onDisable(){super.onDisable(),this.node.off("size-changed",this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onLoad(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}getCurrentPageIndex(){return this._curPageIdx}setCurrentPageIndex(t){this.scrollToPage(t,1)}getPages(){return this._pages}addPage(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):N(4301))}insertPage(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void N(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}}removePage(t){if(!t||!this.content)return;const e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):G(4300,t.name)}removePageAtIndex(t){const e=this._pages;if(t<0||t>=e.length)return;const i=e[t];i&&this.content&&(this.content.removeChild(i),e.splice(t,1),this._updatePageView())}removeAllPages(){if(!this.content)return;const t=this._pages;for(let e=0,i=t.length;e<i;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}scrollToPage(t,e){void 0===e&&(e=.3),t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())}getScrollEndedEventTiming(){return this.pageTurningEventTiming}_updatePageView(){if(!this.content)return;const t=this.content.getComponent(LDt);t&&t.enabled&&t.updateLayout();const e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);const i=this._initContentPos;for(let t=0;t<e;++t){const e=this._pages[t].position;0===this.direction?this._scrollCenterOffsetX[t]=Math.abs(i.x+e.x):this._scrollCenterOffsetY[t]=Math.abs(i.y+e.y)}this.indicator&&this.indicator._refresh()}_updateAllPagesSize(){const t=this.view;if(!this.content||!t)return;if(0!==this._sizeMode)return;const e=this._pages,i=t.contentSize;for(let t=0,s=e.length;t<s;t++)e[t]._uiProps.uiTransformComp.setContentSize(i)}_handleReleaseLogic(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))}_onTouchBegan(t,e){t.touch.getUILocation(ZPt),Qs.set(this._touchBeganPosition,ZPt.x,ZPt.y),super._onTouchBegan(t,e)}_onTouchMoved(t,e){super._onTouchMoved(t,e)}_onTouchEnded(t,e){t.touch.getUILocation(ZPt),Qs.set(this._touchEndPosition,ZPt.x,ZPt.y),super._onTouchEnded(t,e)}_onTouchCancelled(t,e){t.touch.getUILocation(ZPt),Qs.set(this._touchEndPosition,ZPt.x,ZPt.y),super._onTouchCancelled(t,e)}_onMouseWheel(){}_syncScrollDirection(){this.horizontal=0===this.direction,this.vertical=1===this.direction}_syncSizeMode(){const t=this.view;if(!this.content||!t)return;const e=this.content.getComponent(LDt);if(e){if(1===this._sizeMode&&this._pages.length>0){const i=this._pages[0]._uiProps.uiTransformComp,s=this._pages[this._pages.length-1]._uiProps.uiTransformComp;0===this.direction?(e.paddingLeft=(t.width-i.width)/2,e.paddingRight=(t.width-s.width)/2):1===this.direction&&(e.paddingTop=(t.height-i.height)/2,e.paddingBottom=(t.height-s.height)/2)}e.updateLayout()}}_initPages(){if(!this.content)return;this._initContentPos=this.content.position;const t=this.content.children;for(let e=0;e<t.length;++e){const i=t[e];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}_dispatchPageTurningEvent(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,yg.emitEvents(this.pageEvents,this,"page-turning"),this.node.emit("page-turning",this))}_isQuicklyScrollable(t){if(0===this.direction){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(1===this.direction&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1}_moveOffsetValue(t){const e=new Qs;if(1===this._sizeMode)0===this.direction?e.x=this._scrollCenterOffsetX[t]:1===this.direction&&(e.y=this._scrollCenterOffsetY[t]);else{const i=this.view;if(!i)return e;0===this.direction?e.x=t*i.width:1===this.direction&&(e.y=t*i.height)}return e}_getDragDirection(t){return 0===this._direction?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1}_isScrollable(t,e,i){if(1===this._sizeMode){let s=0,r=0;if(0===this.direction)return s=this._scrollCenterOffsetX[e],r=this._scrollCenterOffsetX[i],Math.abs(t.x)>=Math.abs(s-r)*this.scrollThreshold;if(1===this.direction)return s=this._scrollCenterOffsetY[e],r=this._scrollCenterOffsetY[i],Math.abs(t.y)>=Math.abs(s-r)*this.scrollThreshold}else{const e=this.view;if(!e)return!1;if(0===this.direction)return Math.abs(t.x)>=e.width*this.scrollThreshold;if(1===this.direction)return Math.abs(t.y)>=e.height*this.scrollThreshold}return!1}_autoScrollToPage(){if(this._startBounceBackIfNeeded()){const t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{const t=new Qs;Qs.subtract(t,this._touchBeganPosition,this._touchEndPosition);const e=this._curPageIdx,i=e+this._getDragDirection(t),s=this.pageTurningSpeed*Math.abs(e-i);if(i<this._pages.length){if(this._isScrollable(t,e,i))return void this.scrollToPage(i,s);{const t=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(t))return void this.scrollToPage(i,s)}}this.scrollToPage(e,s)}}},KPt.SizeMode=JPt,KPt.Direction=tBt,KPt.EventType=_Mt({PAGE_TURNING:"page-turning"},QAt),s((kPt=KPt).prototype,"sizeMode",[MPt],Object.getOwnPropertyDescriptor(kPt.prototype,"sizeMode"),kPt.prototype),s(kPt.prototype,"direction",[PPt],Object.getOwnPropertyDescriptor(kPt.prototype,"direction"),kPt.prototype),s(kPt.prototype,"indicator",[BPt],Object.getOwnPropertyDescriptor(kPt.prototype,"indicator"),kPt.prototype),NPt=Qo(kPt.prototype,"autoPageTurningThreshold",[va],(function(){return 100})),s(kPt.prototype,"verticalScrollBar",[RPt,Wa],Object.getOwnPropertyDescriptor(kPt.prototype,"verticalScrollBar"),kPt.prototype),s(kPt.prototype,"horizontalScrollBar",[OPt,Wa],Object.getOwnPropertyDescriptor(kPt.prototype,"horizontalScrollBar"),kPt.prototype),UPt=Qo(kPt.prototype,"horizontal",[Wa,va],(function(){return!0})),VPt=Qo(kPt.prototype,"vertical",[Wa,va],(function(){return!0})),HPt=Qo(kPt.prototype,"cancelInnerEvents",[Wa,va],(function(){return!0})),GPt=Qo(kPt.prototype,"scrollEvents",[LPt,va,Wa],(function(){return[]})),WPt=Qo(kPt.prototype,"pageTurningSpeed",[va],(function(){return.3})),jPt=Qo(kPt.prototype,"pageEvents",[FPt,va],(function(){return[]})),$Pt=Qo(kPt.prototype,"_sizeMode",[va],(function(){return 0})),qPt=Qo(kPt.prototype,"_direction",[va],(function(){return 0})),XPt=Qo(kPt.prototype,"_scrollThreshold",[va],(function(){return.5})),YPt=Qo(kPt.prototype,"_pageTurningEventTiming",[va],(function(){return.1})),QPt=Qo(kPt.prototype,"_indicator",[va],(function(){return null})),zPt=kPt))||zPt)||zPt));l.PageView=eBt;const iBt=new Ki,sBt=new Qs,rBt=new Qs,nBt=new Qs(1,1),oBt=new Qs,aBt=new Qs;function hBt(t,e){if(e._hadAlignOnce)return;0===e.alignMode&&(e._hadAlignOnce=!0);const i=e.target;let s;const r=rBt,n=nBt;i?(s=i,lPt(t,s,r,n)):s=t.parent;const o=hPt(s),a=s instanceof IE||!s.getComponent(pO),h=a?sBt:s.getComponent(pO).anchorPoint,l=a;t.getPosition(iBt);const c=t._uiProps.uiTransformComp;let u=iBt.x,d=iBt.y;const p=c.anchorPoint,_=t.scale;if(56&e.alignFlags){let t=0,s=0;const a=o.width;l?(t=Gn.left.x,s=Gn.right.x):(t=-h.x*a,s=t+a),t+=e.isAbsoluteLeft?e.left:e.left*a,s-=e.isAbsoluteRight?e.right:e.right*a,i&&(t+=r.x,t*=n.x,s+=r.x,s*=n.x);let d=0,g=p.x,f=_.x;if(f<0&&(g=1-g,f=-f),e.isStretchWidth)d=s-t,0!==f&&(c.width=d/f),u=t+g*d;else{if(d=c.width*f,e.isAlignHorizontalCenter){let t=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*a,s=(.5-h.x)*o.width;i&&(t*=n.x,s+=r.x,s*=n.x),u=s+(g-.5)*d+t}else u=e.isAlignLeft?t+g*d:s+(g-1)*d;gi(f,0,pi)?d=c.width:d/=f}e._lastSize.width=d}if(7&e.alignFlags){let t=0,s=0;const a=o.height;l?(s=Gn.bottom.y,t=Gn.top.y):(s=-h.y*a,t=s+a),s+=e.isAbsoluteBottom?e.bottom:e.bottom*a,t-=e.isAbsoluteTop?e.top:e.top*a,i&&(s+=r.y,s*=n.y,t+=r.y,t*=n.y);let u=0,g=p.y,f=_.y;if(f<0&&(g=1-g,f=-f),e.isStretchHeight)u=t-s,0!==f&&(c.height=u/f),d=s+g*u;else{if(u=c.height*f,e.isAlignVerticalCenter){let t=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*a,s=(.5-h.y)*o.height;i&&(t*=n.y,s+=r.y,s*=n.y),d=s+(g-.5)*u+t}else d=e.isAlignBottom?s+g*u:t+(g-1)*u;gi(f,0,pi)?u=c.height:u/=f}e._lastSize.height=u}t.setPosition(u,d,iBt.z),Ki.set(e._lastPos,u,d,iBt.z)}function lBt(t){const e=t.getComponent(dPt);if(e&&e.enabled){if(!h.isValid(t,!0))return;uBt.push(e)}const i=t.children;for(const t of i)t.active&&lBt(t)}function cBt(){const t=uP.getScene();if(t){dBt.isAligning=!0,dBt._nodesOrderDirty&&(uBt.length=0,lBt(t),dBt._nodesOrderDirty=!1);let e=null;const i=dBt._activeWidgetsIterator;for(i.i=0;i.i<uBt.length;++i.i)e=uBt[i.i],e._dirty&&(hBt(e.node,e),e._dirty=!1);dBt.isAligning=!1}}const uBt=[],dBt=t("widgetManager",h._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Ht(uBt),animationState:null,init(){uP.on("director_after_scene_launch",cBt),uP.on("director_after_update",cBt),_P.instance.on("design-resolution-changed",this.onResized,this);{const t=this.onResized.bind(this);_P.instance.on("canvas-resize",t),Un.on("window-resize",t)}},add(t){this._nodesOrderDirty=!0},remove(t){this._activeWidgetsIterator.remove(t)},onResized(){const t=uP.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized(t){const e=JS.isNode(t)&&t.getComponent(dPt);e&&e.enabled&&(2===e.alignMode||1===e.alignMode)&&e.setDirty();const i=t.children;for(const t of i)this.refreshWidgetOnResized(t)},updateOffsetsToStayPut(t,e){function i(t,e){return Math.abs(t-e)>1e-10?e:t}const s=t.node;let r=s.parent;if(r){const n=oBt;n.set(0,0);const o=aBt;if(o.set(1,1),t.target&&(r=t.target,lPt(s,r,n,o)),!e)return;const a=r._uiProps&&r._uiProps.uiTransformComp,h=a?a.anchorPoint:sBt,l=s._uiProps.uiTransformComp,c=hPt(r),u=l.anchorPoint,d=s.position,p=uPt,_=s.scale;let g=0;if(e&p.LEFT){let e=-h.x*c.width;e+=n.x,e*=o.x,g=d.x-u.x*l.width*Math.abs(_.x)-e,t.isAbsoluteLeft||(g/=c.width),g/=o.x,t.left=i(t.left,g)}if(e&p.RIGHT){let e=(1-h.x)*c.width;e+=n.x,g=(e*=o.x)-(d.x+(1-u.x)*l.width*Math.abs(_.x)),t.isAbsoluteRight||(g/=c.width),g/=o.x,t.right=i(t.right,g)}if(e&p.TOP){let e=(1-h.y)*c.height;e+=n.y,g=(e*=o.y)-(d.y+(1-u.y)*l.height*Math.abs(_.y)),t.isAbsoluteTop||(g/=c.height),g/=o.y,t.top=i(t.top,g)}if(e&p.BOT){let e=-h.y*c.height;e+=n.y,e*=o.y,g=d.y-u.y*l.height*Math.abs(_.y)-e,t.isAbsoluteBottom||(g/=c.height),g/=o.y,t.bottom=i(t.bottom,g)}}},updateAlignment:function t(e){const i=e.parent;i&&JS.isNode(i)&&t(i);const s=e.getComponent(dPt);s&&i&&hBt(e,s)},AlignMode:cPt,AlignFlags:uPt});var pBt,_Bt,gBt;uP.on("director_init",(()=>{dBt.init()}));let fBt=t("SafeArea",oa("cc.SafeArea")(pBt=ha(110)(pBt=aa(dPt)((_Bt=class extends Ag{get symmetric(){return this._symmetric}set symmetric(t){this._symmetric=t}constructor(){super(),this._symmetric=gBt&&gBt()}onEnable(){this.updateArea(),Un.on("window-resize",this.updateArea,this),Un.on("orientation-change",this.updateArea,this)}onDisable(){Un.off("window-resize",this.updateArea,this),Un.off("orientation-change",this.updateArea,this)}updateArea(){const t=this.node.getComponent(dPt),e=this.node.getComponent(pO);if(!t||!e)return;t.updateAlignment();const i=this.node.position.clone(),s=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;const r=yP.getVisibleSize(),n=r.width,o=r.height,a=Hn.getSafeAreaRect(this._symmetric);t.top=o-a.y-a.height,t.bottom=a.y,t.left=a.x,t.right=n-a.x-a.width,t.updateAlignment();const h=this.node.position.clone(),l=s.x-(h.x-i.x)/e.width,c=s.y-(h.y-i.y)/e.height;e.setAnchorPoint(l,c),dBt.add(t)}},gBt=Qo(_Bt.prototype,"_symmetric",[va],(function(){return!0})),pBt=_Bt))||pBt)||pBt)||pBt);var mBt,yBt,vBt,bBt,wBt,SBt,xBt,TBt,CBt,IBt,EBt,DBt,ABt;l.SafeArea=fBt,t("UICoordinateTracker",(mBt=oa("cc.UICoordinateTracker"),yBt=ha(110),vBt=Ga(JS),bBt=Ga(uk),wBt=Ga([yg]),mBt(SBt=yBt((xBt=class extends Ag{get target(){return this._target}set target(t){this._target!==t&&(this._target=t,this._checkCanMove())}get camera(){return this._camera}set camera(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}get useScale(){return this._useScale}set useScale(t){this._useScale!==t&&(this._useScale=t)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t)}constructor(){super(),this.syncEvents=TBt&&TBt(),this._target=CBt&&CBt(),this._camera=IBt&&IBt(),this._useScale=EBt&&EBt(),this._distance=DBt&&DBt(),this._transformPos=Zi(),this._viewPos=Zi(),this._canMove=!0,this._lastWPos=Zi(),this._lastCameraPos=Zi()}onEnable(){this._checkCanMove()}update(){const t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&Ki.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){const t=this._distance/Math.abs(this._viewPos.z);yg.emitEvents(this.syncEvents,this._transformPos,t)}}_checkCanMove(){this._canMove=!(!this._camera||!this._target)}},s(xBt.prototype,"target",[vBt],Object.getOwnPropertyDescriptor(xBt.prototype,"target"),xBt.prototype),s(xBt.prototype,"camera",[bBt],Object.getOwnPropertyDescriptor(xBt.prototype,"camera"),xBt.prototype),TBt=Qo(xBt.prototype,"syncEvents",[wBt,va],(function(){return[]})),CBt=Qo(xBt.prototype,"_target",[va],(function(){return null})),IBt=Qo(xBt.prototype,"_camera",[va],(function(){return null})),EBt=Qo(xBt.prototype,"_useScale",[va],(function(){return!0})),DBt=Qo(xBt.prototype,"_distance",[va],(function(){return 1})),SBt=xBt))||SBt)||SBt));const MBt=["touch-start","touch-end","touch-move","mouse-down","mouse-move","mouse-up","mouse-enter","mouse-leave","mouse-wheel"];function PBt(t){t.propagationStopped=!0}var BBt,RBt,OBt,LBt;t("BlockInputEvents",oa("cc.BlockInputEvents")(ABt=class extends Ag{onEnable(){for(let t=0;t<MBt.length;t++)this.node.on(MBt[t],PBt,this)}onDisable(){for(let t=0;t<MBt.length;t++)this.node.off(MBt[t],PBt,this)}})||ABt);let FBt=t("SubContextView",oa("cc.SubContextView")(BBt=ha(110)(BBt=aa(pO)((RBt=class extends Ag{get designResolutionSize(){return this._designResolutionSize}set designResolutionSize(t){}get fps(){return this._fps}set fps(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}constructor(){super(),this._fps=OBt&&OBt(),this._sprite=null,this._imageAsset=new j_,this._texture=new qf,this._updatedTime=0,this._updateInterval=0,this._openDataContext=null,this._content=new JS("content"),this._designResolutionSize=LBt&&LBt(),this._content.hideFlags|=yn.Flags.DontSave|yn.Flags.HideInHierarchy,this._updatedTime=performance.now()}onLoad(){o_.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=o_.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1}onEnable(){this._registerNodeEvent()}onDisable(){this._unregisterNodeEvent()}_initSharedCanvas(){if(this._openDataContext){const t=this._openDataContext.canvas;let e=this._designResolutionSize.width,i=this._designResolutionSize.height;t.width=e,t.height=i}}_initContentNode(){if(this._openDataContext){const t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),this._texture.image=e,this._texture.create(t.width,t.height),this._sprite=this._content.getComponent(ZF),this._sprite||(this._sprite=this._content.addComponent(ZF)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{const t=new yB;t.texture=this._texture,this._sprite.spriteFrame=t}this._content.parent=this.node}}_updateSubContextView(){if(!this._openDataContext)return;const t=this.node.getComponent(pO),e=this._content.getComponent(pO),i=t.width/e.width,s=t.height/e.height,r=i>s?s:i;e.width*=r,e.height*=r;const n=yP.getViewportRect(),o=e.getBoundingBoxToWorld(),a=yP.getVisibleSize(),h=Un.devicePixelRatio,l=(n.width*(o.x/a.width)+n.x)/h,c=(n.height*(o.y/a.height)+n.y)/h,u=n.width*(o.width/a.width)/h,d=n.height*(o.height/a.height)/h;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:c,width:u,height:d})}_updateSubContextTexture(){const t=this._imageAsset;if(!t||!this._openDataContext)return;if(t.width<=0||t.height<=0)return;const e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e)}_registerNodeEvent(){this.node.on("transform-changed",this._updateSubContextView,this),this.node.on("size-changed",this._updateSubContextView,this),this.node.on("layer-changed",this._updateContentLayer,this)}_unregisterNodeEvent(){this.node.off("transform-changed",this._updateSubContextView,this),this.node.off("size-changed",this._updateSubContextView,this),this.node.off("layer-changed",this._updateContentLayer,this)}_updateContentLayer(){this._content.layer=this.node.layer}update(t){void 0!==t?performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture()):this._updateSubContextTexture()}onDestroy(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null}},OBt=Qo(RBt.prototype,"_fps",[va],(function(){return 60})),LBt=Qo(RBt.prototype,"_designResolutionSize",[va],(function(){return new br(640,960)})),BBt=RBt))||BBt)||BBt)||BBt);l.SubContextView=FBt}}}));
